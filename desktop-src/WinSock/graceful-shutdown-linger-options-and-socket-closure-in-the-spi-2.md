---
description: Важно отличать подключение к сокету и закрытие сокета.
ms.assetid: f076b1ec-6b96-4386-8519-4728e0a2b1ff
title: Корректное завершение работы, устаревшие параметры и замыкание сокета в SPI
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 743cae48977421c08611c79053520799420e9e72
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104541578"
---
# <a name="graceful-shutdown-linger-options-and-socket-closure-in-the-spi"></a><span data-ttu-id="81b18-103">Корректное завершение работы, устаревшие параметры и замыкание сокета в SPI</span><span class="sxs-lookup"><span data-stu-id="81b18-103">Graceful Shutdown, Linger Options, and Socket Closure in the SPI</span></span>

<span data-ttu-id="81b18-104">Важно отличать подключение к сокету и закрытие сокета.</span><span class="sxs-lookup"><span data-stu-id="81b18-104">It is important to distinguish between shutting down a socket connection and closing a socket.</span></span> <span data-ttu-id="81b18-105">Завершение работы подключения через сокет включает обмен сообщениями протокола между двумя конечными точками, которые в дальнейшем называются последовательностями завершения работы.</span><span class="sxs-lookup"><span data-stu-id="81b18-105">Shutting down a socket connection involves an exchange of protocol messages between the two endpoints, which is hereafter referred to as a shutdown sequence.</span></span> <span data-ttu-id="81b18-106">Два общих класса последовательностей завершения работы определяются: корректное и аварийное.</span><span class="sxs-lookup"><span data-stu-id="81b18-106">Two general classes of shutdown sequences are defined: graceful and abortive.</span></span> <span data-ttu-id="81b18-107">При корректном завершении работы все данные, которые были поставлены в очередь, но еще не переданы, могут быть отправлены до закрытия соединения.</span><span class="sxs-lookup"><span data-stu-id="81b18-107">In a graceful shutdown sequence, any data that has been queued but not yet transmitted can be sent prior to the connection being closed.</span></span> <span data-ttu-id="81b18-108">При аварийном завершении работы все неотправленные данные теряются.</span><span class="sxs-lookup"><span data-stu-id="81b18-108">In an abortive shutdown, any unsent data is lost.</span></span> <span data-ttu-id="81b18-109">Вхождение последовательности завершения работы (мягкое или аварийное) можно также использовать для предоставления \_ индикации закрытия для связанных приложений, указывающих на то, что выполняется завершение работы.</span><span class="sxs-lookup"><span data-stu-id="81b18-109">The occurrence of a shutdown sequence (graceful or abortive) can also be used to provide an FD\_CLOSE indication to the associated applications signifying that a shutdown is in progress.</span></span> <span data-ttu-id="81b18-110">При закрытии сокета, с другой стороны, прекращается выделение маркера сокета, чтобы приложение больше не ссылалось на сокет или не использовало его каким-либо образом.</span><span class="sxs-lookup"><span data-stu-id="81b18-110">Closing a socket, on the other hand, causes the socket handle to become deallocated so that the application can no longer reference or use the socket in any manner.</span></span>

<span data-ttu-id="81b18-111">В сокетах Windows для запуска последовательности завершения работы можно использовать как функцию [**вспшутдовн**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) , так и функцию [**вспсенддисконнект**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) , а функция [**вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) используется для освобождения дескрипторов сокетов и высвобождения связанных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="81b18-111">In Windows Sockets, both the [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) function and the [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) function can be used to initiate a shutdown sequence, while the [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) function is used to deallocate socket handles and free up any associated resources.</span></span> <span data-ttu-id="81b18-112">Однако иногда возникает путаница, связанная с тем, что функция **вспклосесоккет** будет неявно вызывать последовательность завершения работы, если она еще не была выполнена.</span><span class="sxs-lookup"><span data-stu-id="81b18-112">Some amount of confusion arises, however, from the fact that the **WSPCloseSocket** function will implicitly cause a shutdown sequence to occur if it has not already happened.</span></span> <span data-ttu-id="81b18-113">На самом деле, это довольно распространенный подход к программированию, основанный на этой функции, и использовать **вспклосесоккет** для инициации последовательности завершения работы и освобождения маркера сокета.</span><span class="sxs-lookup"><span data-stu-id="81b18-113">In fact, it has become a rather common programming practice to rely on this feature and use **WSPCloseSocket** to both initiate the shutdown sequence and deallocate the socket handle.</span></span>

<span data-ttu-id="81b18-114">Для упрощения этого использования интерфейс сокетов предоставляет элементы управления через механизм параметров сокета, позволяющий программисту указать, должна ли неявная или аварийная последовательность завершения работы быть ненужной, а также должна ли функция завершаться немедленно, а не завершаться немедленно), чтобы обеспечить время для корректного завершения работы.</span><span class="sxs-lookup"><span data-stu-id="81b18-114">To facilitate this usage, the sockets interface provides for controls through the socket option mechanism that allows the programmer to indicate whether the implicit shutdown sequence should be graceful or abortive, and also whether the function should linger that is, not complete immediately) to allow time for a graceful shutdown sequence to complete.</span></span>

<span data-ttu-id="81b18-115">Устанавливая соответствующие значения для параметров сокета \_ до конца и поэтому \_ донтлинжер, можно получить следующие типы поведения с помощью функции [**вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) .</span><span class="sxs-lookup"><span data-stu-id="81b18-115">By establishing appropriate values for the socket options SO\_LINGER and SO\_DONTLINGER, the following types of behavior can be obtained with the [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) function.</span></span>

-   <span data-ttu-id="81b18-116">Прерванная последовательность завершения работы, немедленное возвращение из [**вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="81b18-116">Abortive shutdown sequence, immediate return from [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)).</span></span>
-   <span data-ttu-id="81b18-117">Корректное завершение работы, задержка возврата до завершения любой последовательности завершения или истечения указанного интервала времени.</span><span class="sxs-lookup"><span data-stu-id="81b18-117">Graceful shutdown, delay return until either shutdown sequence completes or a specified time interval elapses.</span></span> <span data-ttu-id="81b18-118">Если интервал времени истекает до завершения корректной последовательности завершения работы, происходит аварийная последовательность завершения работы и [**вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) возвращает.</span><span class="sxs-lookup"><span data-stu-id="81b18-118">If the time interval expires before the graceful shutdown sequence completes, an abortive shutdown sequence occurs and [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) returns.</span></span>
-   <span data-ttu-id="81b18-119">Корректное завершение работы, возвращение немедленно и разрешение завершения последовательности завершения в фоновом режиме.</span><span class="sxs-lookup"><span data-stu-id="81b18-119">Graceful shutdown, return immediately, and allow the shutdown sequence to complete in the background.</span></span> <span data-ttu-id="81b18-120">Это поведение установлено по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="81b18-120">This is the default behavior.</span></span> <span data-ttu-id="81b18-121">Однако обратите внимание, что приложение не имеет способа узнать, когда завершается последовательность корректного завершения работы.</span><span class="sxs-lookup"><span data-stu-id="81b18-121">Note, however, that the application has no way of knowing when (or whether) the graceful shutdown sequence completes.</span></span>

<span data-ttu-id="81b18-122">Один из способов, который можно использовать для снижения вероятности возникновения проблем во время отключения соединения, не полагается на неявное завершение работы, инициированное [**вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="81b18-122">One technique that can be used to minimize the chance of problems occurring during connection teardown is not to rely on an implicit shutdown being initiated by [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)).</span></span> <span data-ttu-id="81b18-123">Вместо этого используется одна из двух явных функций завершения работы ([**вспшутдовн**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) или [**вспсенддисконнект**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85))).</span><span class="sxs-lookup"><span data-stu-id="81b18-123">Instead, one of the two explicit shutdown functions ([**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) or [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85))) are used.</span></span> <span data-ttu-id="81b18-124">Это, в свою очередь, приведет к тому, \_ что в одноранговом приложении будет получено уведомление о закрытии, указывающее, что все ожидающие данные получены.</span><span class="sxs-lookup"><span data-stu-id="81b18-124">This in turn will cause an FD\_CLOSE indication to be received by the peer application indicating that all pending data has been received.</span></span> <span data-ttu-id="81b18-125">Чтобы проиллюстрировать это, в следующей таблице показаны функции, которые будут вызываться клиентскими и серверными компонентами приложения, где клиент отвечает за инициирование корректного завершения работы.</span><span class="sxs-lookup"><span data-stu-id="81b18-125">To illustrate this, the following table shows the functions that would be invoked by the client and server components of an application, where the client is responsible for initiating a graceful shutdown.</span></span>

| <span data-ttu-id="81b18-126">На стороне клиента</span><span class="sxs-lookup"><span data-stu-id="81b18-126">Client side</span></span>                                                                                                                         | <span data-ttu-id="81b18-127">На сервере</span><span class="sxs-lookup"><span data-stu-id="81b18-127">Server side</span></span>                                                                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="81b18-128">(1) вызывает [**вспшутдовн**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) (*s*, SD \_ Send), чтобы сообщить о завершении сеанса и что у клиента больше нет данных для отправки.</span><span class="sxs-lookup"><span data-stu-id="81b18-128">(1) Invokes [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) (*s*, SD\_SEND) to signal end of session and that client has no more data to send.</span></span> |                                                                                                              |
|                                                                                                                                     | <span data-ttu-id="81b18-129">(2) получает демон демо- \_ Close, что указывает на выполнение корректного завершения работы и получение всех данных.</span><span class="sxs-lookup"><span data-stu-id="81b18-129">(2) Receives FD\_CLOSE, indicating graceful shutdown in progress and that all data has been received.</span></span>        |
|                                                                                                                                     | <span data-ttu-id="81b18-130">(3) отправка оставшихся данных ответа.</span><span class="sxs-lookup"><span data-stu-id="81b18-130">(3) Sends any remaining response data.</span></span>                                                                       |
| <span data-ttu-id="81b18-131">(5) получает данные о \_ чтении и вызове onrecv для получения данных ответа, отправленных сервером.</span><span class="sxs-lookup"><span data-stu-id="81b18-131">(5') Gets FD\_READ and invoke recv to get any response data sent by server.</span></span>                                                         | <span data-ttu-id="81b18-132">(4) вызывает [**вспшутдовн**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85))(*s*, SD \_ Send), чтобы указать серверу, что больше нет данных для отправки.</span><span class="sxs-lookup"><span data-stu-id="81b18-132">(4) Invokes [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85))(*s*, SD\_SEND) to indicate server has no more data to send.</span></span> |
| <span data-ttu-id="81b18-133">(5) получает \_ уведомление о закрытии демона.</span><span class="sxs-lookup"><span data-stu-id="81b18-133">(5) Receives FD\_CLOSE indication.</span></span>                                                                                                  | <span data-ttu-id="81b18-134">(4) вызывает [ **вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="81b18-134">(4') Invokes [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span></span>                                                      |
| <span data-ttu-id="81b18-135">(6) вызывает [ **вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="81b18-135">(6) Invokes [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span></span>                                                                              |                                                                                                              |



 

<span data-ttu-id="81b18-136">Последовательность времени сохраняется на шаге (1) к шагу (6) между клиентом и сервером. за исключением шагов (4) и (5), которые имеют только местное значение времени в том смысле, что шаг (5) соответствует шагу (5) на стороне клиента, а шаг (4) соответствует шагу (4) на стороне сервера без отношения времени с удаленной стороной.</span><span class="sxs-lookup"><span data-stu-id="81b18-136">The timing sequence is maintained from step (1) to step (6) between the client and the server, except for steps (4') and (5') which only have local timing significance in the sense that step (5) follows step (5') on the client side while step (4') follows step (4) on the server side, with no timing relationship with the remote party.</span></span>

 

 
