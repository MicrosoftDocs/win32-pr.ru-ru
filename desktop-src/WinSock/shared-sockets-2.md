---
description: Функция Всадупликатесоккет используется для включения совместного использования сокетов в процессах.
ms.assetid: f7cf40e9-f3a6-4b62-8a78-df25464e2365
title: Общие сокеты
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fb6753b01f6389254756254d2ebe196af8e2a8a3
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103991520"
---
# <a name="shared-sockets"></a><span data-ttu-id="9f9b5-103">Общие сокеты</span><span class="sxs-lookup"><span data-stu-id="9f9b5-103">Shared Sockets</span></span>

<span data-ttu-id="9f9b5-104">Функция [**всадупликатесоккет**](/windows/desktop/api/Winsock2/nf-winsock2-wsaduplicatesocketa) используется для включения совместного использования сокетов в процессах.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-104">The [**WSADuplicateSocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsaduplicatesocketa) function is introduced to enable socket sharing across processes.</span></span> <span data-ttu-id="9f9b5-105">Исходный процесс вызывает **всадупликатесоккет** , чтобы получить специальную [**структуру \_ сведений о всапротокол**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) для идентификатора целевого процесса.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-105">A source process calls **WSADuplicateSocket** to obtain a special [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure for a target process identifier.</span></span> <span data-ttu-id="9f9b5-106">Он использует некоторый механизм межпроцессного взаимодействия (IPC) для передачи содержимого этой структуры в целевой процесс.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-106">It uses some interprocess communications (IPC) mechanism to pass the contents of this structure to a target process.</span></span> <span data-ttu-id="9f9b5-107">Затем целевой процесс использует структуру **\_ сведений всапротокол** в вызове [**вспсоккет**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket).</span><span class="sxs-lookup"><span data-stu-id="9f9b5-107">The target process then uses the **WSAPROTOCOL\_INFO** structure in a call to [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket).</span></span> <span data-ttu-id="9f9b5-108">Дескриптор сокета, возвращаемый этой функцией, будет дополнительным дескриптором сокета для базового сокета, который, таким же, становится общим.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-108">The socket descriptor returned by this function will be an additional socket descriptor to an underlying socket which thus becomes shared.</span></span> <span data-ttu-id="9f9b5-109">Сокеты могут совместно использоваться потоками в данном процессе без использования функции **всадупликатесоккет** , поскольку дескриптор сокета допустим во всех потоках процесса.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-109">Sockets can be shared among threads in a given process without using the **WSADuplicateSocket** function because a socket descriptor is valid in all threads of a process.</span></span>

<span data-ttu-id="9f9b5-110">Два (или более) дескрипторов, которые ссылаются на общий сокет, можно использовать независимо, когда речь идет о вводе-выводе.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-110">The two (or more) descriptors that reference a shared socket can be used independently as far as I/O is concerned.</span></span> <span data-ttu-id="9f9b5-111">Однако интерфейс Winsock не реализует какой-либо тип управления доступом, поэтому процессы должны координировать любые операции на общем сокете.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-111">However, the Winsock interface does not implement any type of access control, so the processes must coordinate any operations on a shared socket.</span></span> <span data-ttu-id="9f9b5-112">Типичный пример совместного использования сокетов — использование одного процесса для создания сокетов и установления соединений.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-112">A typical example of sharing sockets is to use one process for creating sockets and establishing connections.</span></span> <span data-ttu-id="9f9b5-113">Затем этот процесс передает сокеты другим процессам, ответственным за обмен информацией.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-113">This process then hands off sockets to other processes that are responsible for information exchange.</span></span>

<span data-ttu-id="9f9b5-114">Функция [**всадупликатесоккет**](/windows/desktop/api/Winsock2/nf-winsock2-wsaduplicatesocketa) создает дескрипторы сокетов, а не базовый сокет.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-114">The [**WSADuplicateSocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsaduplicatesocketa) function creates socket descriptors and not the underlying socket.</span></span> <span data-ttu-id="9f9b5-115">В результате все состояния, связанные с сокетом, хранятся как общие для всех дескрипторов.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-115">As a result, all the states associated with a socket are held in common across all the descriptors.</span></span> <span data-ttu-id="9f9b5-116">Например, операция [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) , выполняемая с помощью одного дескриптора, впоследствии отображается с помощью [**жетсоккопт**](/windows/desktop/api/winsock/nf-winsock-getsockopt) из дескрипторов любого или всех.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-116">For example, a [**setsockopt**](/windows/desktop/api/winsock/nf-winsock-setsockopt) operation performed using one descriptor is subsequently visible using a [**getsockopt**](/windows/desktop/api/winsock/nf-winsock-getsockopt) from any or all descriptors.</span></span> <span data-ttu-id="9f9b5-117">Процесс может вызвать [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) для повторяющегося сокета, и дескриптор будет освобожден.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-117">A process can call [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) on a duplicated socket and the descriptor will become deallocated.</span></span> <span data-ttu-id="9f9b5-118">Однако базовый сокет остается открытым до тех пор, пока не будет вызван **функции closesocket** с последним оставшимся дескриптором.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-118">The underlying socket, however, remains open until **closesocket** is called with the last remaining descriptor.</span></span>

<span data-ttu-id="9f9b5-119">Уведомления на общих сокетах подчиняются обычным ограничениям функций [**всаасинкселект**](/windows/desktop/api/winsock/nf-winsock-wsaasyncselect) и [**всаевентселект**](/windows/desktop/api/Winsock2/nf-winsock2-wsaeventselect) .</span><span class="sxs-lookup"><span data-stu-id="9f9b5-119">Notification on shared sockets is subject to the usual constraints of the [**WSAAsyncSelect**](/windows/desktop/api/winsock/nf-winsock-wsaasyncselect) and [**WSAEventSelect**](/windows/desktop/api/Winsock2/nf-winsock2-wsaeventselect) functions.</span></span> <span data-ttu-id="9f9b5-120">При выдаче любого из этих вызовов с помощью любого из общих дескрипторов отменяется любая предыдущая регистрация событий для сокета, независимо от того, какой дескриптор использовался для выполнения этой регистрации.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-120">Issuing either of these calls using any of the shared descriptors cancels any previous event registration for the socket, regardless of which descriptor was used to make that registration.</span></span> <span data-ttu-id="9f9b5-121">Таким образом, нельзя было бы иметь возможность обрабатывать события «получить ДЕМОна \ \ \_ чтение» и «обработка б» на получение \_ событий записи.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-121">Thus, for example, it would not be possible to have process A receive FD\_READ events and process B receive FD\_WRITE events.</span></span> <span data-ttu-id="9f9b5-122">В ситуациях, когда требуется такая тесная координация, рекомендуется, чтобы разработчики использовали потоки вместо отдельных процессов.</span><span class="sxs-lookup"><span data-stu-id="9f9b5-122">For situations when such tight coordination is required, it is suggested that developers use threads instead of separate processes.</span></span>

 

 
