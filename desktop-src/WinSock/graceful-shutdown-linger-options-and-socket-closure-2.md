---
description: Приведенный ниже материал предоставляется в качестве пояснения для субъекта о выключении соединений сокетов, закрывающих сокеты. Важно различать различия между завершением подключения сокета и закрытием сокета.
ms.assetid: 383747c3-dd3d-4a18-b4e8-2815d5e5c0c7
title: Корректное завершение работы, устаревшие параметры и замыкание сокета
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 59f6791eaa803da561fc9f3c175b5270950cbec3
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104263075"
---
# <a name="graceful-shutdown-linger-options-and-socket-closure"></a><span data-ttu-id="a90a5-104">Корректное завершение работы, устаревшие параметры и замыкание сокета</span><span class="sxs-lookup"><span data-stu-id="a90a5-104">Graceful Shutdown, Linger Options, and Socket Closure</span></span>

<span data-ttu-id="a90a5-105">Приведенный ниже материал предоставляется в качестве пояснения для субъекта о выключении соединений сокетов, закрывающих сокеты.</span><span class="sxs-lookup"><span data-stu-id="a90a5-105">The following material is provided as clarification for the subject of shutting down socket connections closing the sockets.</span></span> <span data-ttu-id="a90a5-106">Важно различать различия между завершением подключения сокета и закрытием сокета.</span><span class="sxs-lookup"><span data-stu-id="a90a5-106">It is important to distinguish the difference between shutting down a socket connection and closing a socket.</span></span>

<span data-ttu-id="a90a5-107">Завершение работы подключения через сокет включает в себя обмен сообщениями протокола между двумя конечными точками, а затем этот процесс называется последовательностью завершения работы.</span><span class="sxs-lookup"><span data-stu-id="a90a5-107">Shutting down a socket connection involves an exchange of protocol messages between the two endpoints, hereafter referred to as a shutdown sequence.</span></span> <span data-ttu-id="a90a5-108">Два общих класса последовательностей завершения работы определяются: корректное и аварийное (также называется жестким).</span><span class="sxs-lookup"><span data-stu-id="a90a5-108">Two general classes of shutdown sequences are defined: graceful and abortive (also called hard).</span></span> <span data-ttu-id="a90a5-109">При корректном завершении работы все данные, которые были поставлены в очередь, но еще не переданы, могут быть отправлены до закрытия соединения.</span><span class="sxs-lookup"><span data-stu-id="a90a5-109">In a graceful shutdown sequence, any data that has been queued, but not yet transmitted can be sent prior to the connection being closed.</span></span> <span data-ttu-id="a90a5-110">При аварийном завершении работы все неотправленные данные теряются.</span><span class="sxs-lookup"><span data-stu-id="a90a5-110">In an abortive shutdown, any unsent data is lost.</span></span> <span data-ttu-id="a90a5-111">Вхождение последовательности завершения работы (мягкое или аварийное) можно также использовать для предоставления \_ индикации закрытия для связанных приложений, указывающих на то, что выполняется завершение работы.</span><span class="sxs-lookup"><span data-stu-id="a90a5-111">The occurrence of a shutdown sequence (graceful or abortive) can also be used to provide an FD\_CLOSE indication to the associated applications signifying that a shutdown is in progress.</span></span>

<span data-ttu-id="a90a5-112">При закрытии сокета, с другой стороны, прекращается выделение маркера сокета, чтобы приложение больше не ссылалось на сокет или не использовало его каким-либо образом.</span><span class="sxs-lookup"><span data-stu-id="a90a5-112">Closing a socket, on the other hand, causes the socket handle to become deallocated so that the application can no longer reference or use the socket in any manner.</span></span>

<span data-ttu-id="a90a5-113">В сокетах Windows для запуска последовательности завершения работы можно использовать как функцию [**завершения работы**](/windows/desktop/api/winsock/nf-winsock-shutdown) , так и функцию [**всасенддисконнект**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect) , тогда как функция [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) используется для освобождения дескрипторов сокетов и высвобождения связанных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a90a5-113">In Windows Sockets, both the [**shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown) function, and the [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect) function can be used to initiate a shutdown sequence, while the [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) function is used to deallocate socket handles and free up any associated resources.</span></span> <span data-ttu-id="a90a5-114">Однако в некоторых случаях возникает путаница из-за того, что функция **функции closesocket** неявно вызывает последовательность завершения работы, если она еще не была выполнена.</span><span class="sxs-lookup"><span data-stu-id="a90a5-114">Some amount of confusion arises, however, from the fact that the **closesocket** function implicitly causes a shutdown sequence to occur if it has not already happened.</span></span> <span data-ttu-id="a90a5-115">На самом деле, это довольно распространенный подход к программированию, основанный на этой функции, и использовать **функции closesocket** для инициации последовательности завершения работы и освобождения маркера сокета.</span><span class="sxs-lookup"><span data-stu-id="a90a5-115">In fact, it has become a rather common programming practice to rely on this feature and to use **closesocket** to both initiate the shutdown sequence and deallocate the socket handle.</span></span>

<span data-ttu-id="a90a5-116">Для упрощения этого использования интерфейс сокетов предоставляет элементам управления механизм, позволяющий программисту указать, должна ли неявная последовательность завершения работы быть корректной или аварийной, а также должна ли функция [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) завершаться (что не происходит немедленно), чтобы обеспечить время для корректного завершения работы.</span><span class="sxs-lookup"><span data-stu-id="a90a5-116">To facilitate this usage, the sockets interface provides for controls by way of the socket option mechanism that allow the programmer to indicate whether the implicit shutdown sequence should be graceful or abortive, and also whether the [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) function should linger (that is not complete immediately) to allow time for a graceful shutdown sequence to complete.</span></span> <span data-ttu-id="a90a5-117">Эти важные различия и последствия использования **функции closesocket** таким способом по-прежнему не являются понятными.</span><span class="sxs-lookup"><span data-stu-id="a90a5-117">These important distinctions and the ramifications of using **closesocket** in this manner are still not widely understood.</span></span>

<span data-ttu-id="a90a5-118">Установив соответствующие значения для параметров сокета так, чтобы \_ \_ они были донтлинжер, можно получить следующие типы поведения с помощью функции [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) :</span><span class="sxs-lookup"><span data-stu-id="a90a5-118">By establishing appropriate values for the socket options SO\_LINGER and SO\_DONTLINGER, the following types of behavior can be obtained with the [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) function:</span></span>

-   <span data-ttu-id="a90a5-119">Прерванная последовательность завершения работы, немедленное возвращение из [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span><span class="sxs-lookup"><span data-stu-id="a90a5-119">Abortive shutdown sequence, immediate return from [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span></span>
-   <span data-ttu-id="a90a5-120">Корректное завершение работы, задержка возврата до тех пор, пока не завершится последовательность завершения работы или не истечет указанный интервал времени.</span><span class="sxs-lookup"><span data-stu-id="a90a5-120">Graceful shutdown, delaying return until either shutdown sequence completes or a specified time interval elapses.</span></span> <span data-ttu-id="a90a5-121">Если интервал времени истекает до завершения корректного завершения работы, происходит аварийная последовательность завершения работы и [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) возвращает.</span><span class="sxs-lookup"><span data-stu-id="a90a5-121">If the time interval expires before the graceful shutdown sequence completes, an abortive shutdown sequence occurs, and [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) returns.</span></span>
-   <span data-ttu-id="a90a5-122">Корректное завершение работы, немедленное возвращение — разрешение завершения последовательности завершения в фоновом режиме.</span><span class="sxs-lookup"><span data-stu-id="a90a5-122">Graceful shutdown, immediate return—allowing the shutdown sequence to complete in the background.</span></span> <span data-ttu-id="a90a5-123">Несмотря на то, что это поведение по умолчанию, приложение не может знать, когда и как фактически завершается последовательность корректного завершения работы.</span><span class="sxs-lookup"><span data-stu-id="a90a5-123">Although this is the default behavior, the application has no way of knowing when (or whether) the graceful shutdown sequence actually completes.</span></span>

<span data-ttu-id="a90a5-124">Использование \_ \_ параметров сокета SO и so донтлинжер и связанной с ними [**задержки**](/windows/desktop/api/winsock/ns-winsock-linger) рассматривается более подробно в справочных разделах по [**\_ параметрам сокета сокета Sol**](sol-socket-socket-options.md) и в структуре " **устаревших** ".</span><span class="sxs-lookup"><span data-stu-id="a90a5-124">The use of the SO\_LINGER and SO\_DONTLINGER socket options and the associated [**linger**](/windows/desktop/api/winsock/ns-winsock-linger) structure is discussed in more detail in the reference sections on [**SOL\_SOCKET Socket Options**](sol-socket-socket-options.md) and the **linger** structure.</span></span>

<span data-ttu-id="a90a5-125">Один из способов, который можно использовать для снижения вероятности возникновения проблем во время отключения соединения, заключается в том, чтобы не полагаться на неявное завершение работы, инициированное [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span><span class="sxs-lookup"><span data-stu-id="a90a5-125">One technique that can be used to minimize the chance of problems occurring during connection teardown is to avoid relying on an implicit shutdown being initiated by [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span></span> <span data-ttu-id="a90a5-126">Вместо этого следует использовать одну из двух явных функций завершения работы: [**Shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown) или [**всасенддисконнект**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect).</span><span class="sxs-lookup"><span data-stu-id="a90a5-126">Instead, use one of the two explicit shutdown functions, [**shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown) or [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect).</span></span> <span data-ttu-id="a90a5-127">Это, в свою очередь, приводит к тому, \_ что одноранговое приложение получает уведомление о закрытии, указывающее, что все ожидающие данные получены.</span><span class="sxs-lookup"><span data-stu-id="a90a5-127">This in turn causes an FD\_CLOSE indication to be received by the peer application indicating that all pending data has been received.</span></span> <span data-ttu-id="a90a5-128">Чтобы проиллюстрировать это, в следующей таблице показаны функции, которые будут вызываться клиентскими и серверными компонентами приложения, где клиент отвечает за инициирование корректного завершения работы.</span><span class="sxs-lookup"><span data-stu-id="a90a5-128">To illustrate this, the following table shows the functions that would be invoked by the client and server components of an application, where the client is responsible for initiating a graceful shutdown.</span></span>

| <span data-ttu-id="a90a5-129">На стороне клиента</span><span class="sxs-lookup"><span data-stu-id="a90a5-129">Client side</span></span>                                                                                                                | <span data-ttu-id="a90a5-130">На сервере</span><span class="sxs-lookup"><span data-stu-id="a90a5-130">Server side</span></span>                                                                                           |
|----------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="a90a5-131">(1) вызывает [**Завершение работы**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD \_ Send), чтобы сообщить о завершении сеанса и что у клиента больше нет данных для отправки.</span><span class="sxs-lookup"><span data-stu-id="a90a5-131">(1) Invokes [**shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD\_SEND) to signal end of session and that client has no more data to send.</span></span> |                                                                                                       |
|                                                                                                                            | <span data-ttu-id="a90a5-132">(2) получает демон демо- \_ Close, что указывает на выполнение корректного завершения работы и получение всех данных.</span><span class="sxs-lookup"><span data-stu-id="a90a5-132">(2) Receives FD\_CLOSE, indicating graceful shutdown in progress and that all data has been received.</span></span> |
|                                                                                                                            | <span data-ttu-id="a90a5-133">(3) отправка оставшихся данных ответа.</span><span class="sxs-lookup"><span data-stu-id="a90a5-133">(3) Sends any remaining response data.</span></span>                                                                |
| <span data-ttu-id="a90a5-134">(только локальное значимое значение времени) Возвращает \_ чтение и вызов метода [**recv**](/windows/desktop/api/winsock/nf-winsock-recv) для получения данных ответа, отправленных сервером.</span><span class="sxs-lookup"><span data-stu-id="a90a5-134">(local timing significance only) Gets FD\_READ and calls [**recv**](/windows/desktop/api/winsock/nf-winsock-recv) to get any response data sent by server .</span></span>  | <span data-ttu-id="a90a5-135">(4) вызывает [**Завершение работы**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD \_ Send), чтобы указать серверу, что больше нет данных для отправки.</span><span class="sxs-lookup"><span data-stu-id="a90a5-135">(4) Invokes [**shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD\_SEND) to indicate server has no more data to send.</span></span>  |
| <span data-ttu-id="a90a5-136">(5) получает \_ уведомление о закрытии демона.</span><span class="sxs-lookup"><span data-stu-id="a90a5-136">(5) Receives FD\_CLOSE indication.</span></span>                                                                                         | <span data-ttu-id="a90a5-137">(только локальное значимое значение времени) Вызывает [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) .</span><span class="sxs-lookup"><span data-stu-id="a90a5-137">(local timing significance only) Invokes [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) .</span></span>                       |
| <span data-ttu-id="a90a5-138">(6) вызывает [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span><span class="sxs-lookup"><span data-stu-id="a90a5-138">(6) Invokes [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span></span>                                                                          |                                                                                                       |



 

 

 



