---
description: Приведенный ниже материал предоставляется в качестве пояснения для субъекта о выключении соединений сокетов, закрывающих сокеты. Важно различать различия между завершением подключения сокета и закрытием сокета.
ms.assetid: 383747c3-dd3d-4a18-b4e8-2815d5e5c0c7
title: Корректное завершение работы, устаревшие параметры и замыкание сокета
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 59f6791eaa803da561fc9f3c175b5270950cbec3
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104263075"
---
# <a name="graceful-shutdown-linger-options-and-socket-closure"></a>Корректное завершение работы, устаревшие параметры и замыкание сокета

Приведенный ниже материал предоставляется в качестве пояснения для субъекта о выключении соединений сокетов, закрывающих сокеты. Важно различать различия между завершением подключения сокета и закрытием сокета.

Завершение работы подключения через сокет включает в себя обмен сообщениями протокола между двумя конечными точками, а затем этот процесс называется последовательностью завершения работы. Два общих класса последовательностей завершения работы определяются: корректное и аварийное (также называется жестким). При корректном завершении работы все данные, которые были поставлены в очередь, но еще не переданы, могут быть отправлены до закрытия соединения. При аварийном завершении работы все неотправленные данные теряются. Вхождение последовательности завершения работы (мягкое или аварийное) можно также использовать для предоставления \_ индикации закрытия для связанных приложений, указывающих на то, что выполняется завершение работы.

При закрытии сокета, с другой стороны, прекращается выделение маркера сокета, чтобы приложение больше не ссылалось на сокет или не использовало его каким-либо образом.

В сокетах Windows для запуска последовательности завершения работы можно использовать как функцию [**завершения работы**](/windows/desktop/api/winsock/nf-winsock-shutdown) , так и функцию [**всасенддисконнект**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect) , тогда как функция [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) используется для освобождения дескрипторов сокетов и высвобождения связанных ресурсов. Однако в некоторых случаях возникает путаница из-за того, что функция **функции closesocket** неявно вызывает последовательность завершения работы, если она еще не была выполнена. На самом деле, это довольно распространенный подход к программированию, основанный на этой функции, и использовать **функции closesocket** для инициации последовательности завершения работы и освобождения маркера сокета.

Для упрощения этого использования интерфейс сокетов предоставляет элементам управления механизм, позволяющий программисту указать, должна ли неявная последовательность завершения работы быть корректной или аварийной, а также должна ли функция [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) завершаться (что не происходит немедленно), чтобы обеспечить время для корректного завершения работы. Эти важные различия и последствия использования **функции closesocket** таким способом по-прежнему не являются понятными.

Установив соответствующие значения для параметров сокета так, чтобы \_ \_ они были донтлинжер, можно получить следующие типы поведения с помощью функции [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) :

-   Прерванная последовательность завершения работы, немедленное возвращение из [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).
-   Корректное завершение работы, задержка возврата до тех пор, пока не завершится последовательность завершения работы или не истечет указанный интервал времени. Если интервал времени истекает до завершения корректного завершения работы, происходит аварийная последовательность завершения работы и [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) возвращает.
-   Корректное завершение работы, немедленное возвращение — разрешение завершения последовательности завершения в фоновом режиме. Несмотря на то, что это поведение по умолчанию, приложение не может знать, когда и как фактически завершается последовательность корректного завершения работы.

Использование \_ \_ параметров сокета SO и so донтлинжер и связанной с ними [**задержки**](/windows/desktop/api/winsock/ns-winsock-linger) рассматривается более подробно в справочных разделах по [**\_ параметрам сокета сокета Sol**](sol-socket-socket-options.md) и в структуре " **устаревших** ".

Один из способов, который можно использовать для снижения вероятности возникновения проблем во время отключения соединения, заключается в том, чтобы не полагаться на неявное завершение работы, инициированное [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket). Вместо этого следует использовать одну из двух явных функций завершения работы: [**Shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown) или [**всасенддисконнект**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect). Это, в свою очередь, приводит к тому, \_ что одноранговое приложение получает уведомление о закрытии, указывающее, что все ожидающие данные получены. Чтобы проиллюстрировать это, в следующей таблице показаны функции, которые будут вызываться клиентскими и серверными компонентами приложения, где клиент отвечает за инициирование корректного завершения работы.

| На стороне клиента                                                                                                                | На сервере                                                                                           |
|----------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|
| (1) вызывает [**Завершение работы**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD \_ Send), чтобы сообщить о завершении сеанса и что у клиента больше нет данных для отправки. |                                                                                                       |
|                                                                                                                            | (2) получает демон демо- \_ Close, что указывает на выполнение корректного завершения работы и получение всех данных. |
|                                                                                                                            | (3) отправка оставшихся данных ответа.                                                                |
| (только локальное значимое значение времени) Возвращает \_ чтение и вызов метода [**recv**](/windows/desktop/api/winsock/nf-winsock-recv) для получения данных ответа, отправленных сервером.  | (4) вызывает [**Завершение работы**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD \_ Send), чтобы указать серверу, что больше нет данных для отправки.  |
| (5) получает \_ уведомление о закрытии демона.                                                                                         | (только локальное значимое значение времени) Вызывает [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) .                       |
| (6) вызывает [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).                                                                          |                                                                                                       |



 

 

 



