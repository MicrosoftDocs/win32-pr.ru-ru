---
description: Сокеты Windows 2 поддерживают перекрывающиеся операции ввода-вывода, а все поставщики транспорта поддерживают эту возможность.
ms.assetid: b36ab606-df1a-4254-b048-6d47eb366275
title: Перекрывающиеся операции ввода-вывода и объекты событий
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ed034f06243959d94a1ada7eaa71e33c84cd35ee
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105701507"
---
# <a name="overlapped-io-and-event-objects"></a><span data-ttu-id="563a9-103">Перекрывающиеся операции ввода-вывода и объекты событий</span><span class="sxs-lookup"><span data-stu-id="563a9-103">Overlapped I/O and Event Objects</span></span>

<span data-ttu-id="563a9-104">Сокеты Windows 2 поддерживают перекрывающиеся операции ввода-вывода, а все поставщики транспорта поддерживают эту возможность.</span><span class="sxs-lookup"><span data-stu-id="563a9-104">Windows Sockets 2 supports overlapped I/O and all transport providers support this capability.</span></span> <span data-ttu-id="563a9-105">Перекрывающиеся операции ввода-вывода следуют модели, установленной в Windows, и могут выполняться на сокетах, созданных с помощью функции [**сокета**](/windows/desktop/api/Winsock2/nf-winsock2-socket) или сокетов, созданных с помощью функции [**всасоккет**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) с ФЛАГом **WSA \_ Flag \_ OVERLAPPED** , установленным в параметре *dwFlags* .</span><span class="sxs-lookup"><span data-stu-id="563a9-105">Overlapped I/O follows the model established in Windows and can be performed on sockets created with the [**socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket) function or sockets created with the [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) function with the **WSA\_FLAG\_OVERLAPPED** flag set in the *dwFlags* parameter.</span></span>

> [!Note]  
> <span data-ttu-id="563a9-106">Создание сокета с атрибутом OVERLAPPED не влияет на то, находится ли сокет в данный момент в блокирующем или неблокирующем режиме.</span><span class="sxs-lookup"><span data-stu-id="563a9-106">Creating a socket with the overlapped attribute has no impact on whether a socket is currently in blocking or nonblocking mode.</span></span> <span data-ttu-id="563a9-107">Сокеты, созданные с помощью атрибута OVERLAPPED, можно использовать для выполнения перекрывающихся операций ввода-вывода — это не изменяет режим блокировки сокета.</span><span class="sxs-lookup"><span data-stu-id="563a9-107">Sockets created with the overlapped attribute can be used to perform overlapped I/O—doing so does not change the blocking mode of a socket.</span></span> <span data-ttu-id="563a9-108">Так как перекрывающиеся операции ввода-вывода не блокируются, режим блокировки сокета не имеет значения для этих операций.</span><span class="sxs-lookup"><span data-stu-id="563a9-108">Since overlapped I/O operations do not block, the blocking mode of a socket is irrelevant for these operations.</span></span>

 

<span data-ttu-id="563a9-109">Для получения приложения используют функции [**всарекв**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecv) или [**всареквфром**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecvfrom) для предоставления буферов, в которые должны быть получены данные.</span><span class="sxs-lookup"><span data-stu-id="563a9-109">For receiving, applications use the [**WSARecv**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecv) or [**WSARecvFrom**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecvfrom) functions to supply buffers into which data is to be received.</span></span> <span data-ttu-id="563a9-110">Если один или несколько буферов были отправлены до момента получения данных сетью, эти данные могут быть помещены в буфер пользователя сразу по мере их поступления.</span><span class="sxs-lookup"><span data-stu-id="563a9-110">If one or more buffers are posted prior to the time when data has been received by the network, that data could be placed in the user's buffers immediately as it arrives.</span></span> <span data-ttu-id="563a9-111">Таким образом, он может избежать операции копирования, которая в противном случае возникала бы во время вызова функции [**recv**](/windows/desktop/api/winsock/nf-winsock-recv) или [**реквфром**](/windows/desktop/api/winsock/nf-winsock-recvfrom) .</span><span class="sxs-lookup"><span data-stu-id="563a9-111">Thus, it can avoid the copy operation that would otherwise occur at the time the [**recv**](/windows/desktop/api/winsock/nf-winsock-recv) or [**recvfrom**](/windows/desktop/api/winsock/nf-winsock-recvfrom) function is invoked.</span></span> <span data-ttu-id="563a9-112">Если данные уже существуют при публикации буферов приема, они немедленно копируются в буферы пользователя.</span><span class="sxs-lookup"><span data-stu-id="563a9-112">If data is already present when receive buffers are posted, it is copied immediately into the user's buffers.</span></span>

<span data-ttu-id="563a9-113">Если данные поступают, когда приложение не посылает буферы приема, то сеть переносится к привычному синхронному стилю операции.</span><span class="sxs-lookup"><span data-stu-id="563a9-113">If data arrives when no receive buffers have been posted by the application, the network resorts to the familiar synchronous style of operation.</span></span> <span data-ttu-id="563a9-114">То есть входные данные помещаются в буфер внутренне до тех пор, пока приложение не выдаст вызов Receive и, таким образом, предоставляет буфер, в который можно копировать данные.</span><span class="sxs-lookup"><span data-stu-id="563a9-114">That is, the incoming data is buffered internally until the application issues a receive call and thereby supplies a buffer into which the data can be copied.</span></span> <span data-ttu-id="563a9-115">Исключением является то, что приложение использует [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) для установки размера принимающего буфера равным нулю.</span><span class="sxs-lookup"><span data-stu-id="563a9-115">An exception to this is when the application uses [**setsockopt**](/windows/desktop/api/winsock/nf-winsock-setsockopt) to set the size of the receive buffer to zero.</span></span> <span data-ttu-id="563a9-116">В этом случае надежные протоколы разрешают получение данных только при публикации буферов приложений и потере данных на ненадежные протоколы.</span><span class="sxs-lookup"><span data-stu-id="563a9-116">In this instance, reliable protocols would only allow data to be received when application buffers had been posted and data on unreliable protocols would be lost.</span></span>

<span data-ttu-id="563a9-117">На отправляющей стороне приложения используют [**всасенд**](/windows/desktop/api/Winsock2/nf-winsock2-wsasend) или [**всасендто**](/windows/desktop/api/Winsock2/nf-winsock2-wsasendto) для предоставления указателей на заполненные буферы, а затем не направляют буферы каким бы то ни было, пока сеть не запотребляет содержимое буфера.</span><span class="sxs-lookup"><span data-stu-id="563a9-117">On the sending side, applications use [**WSASend**](/windows/desktop/api/Winsock2/nf-winsock2-wsasend) or [**WSASendTo**](/windows/desktop/api/Winsock2/nf-winsock2-wsasendto) to supply pointers to filled buffers and then agree not to disturb the buffers in any way until the network has consumed the buffer's contents.</span></span>

<span data-ttu-id="563a9-118">Перекрывающиеся вызовы Send и Receive немедленно возвращают.</span><span class="sxs-lookup"><span data-stu-id="563a9-118">Overlapped send and receive calls return immediately.</span></span> <span data-ttu-id="563a9-119">Возвращаемое значение, равное нулю, указывает, что операция ввода-вывода была завершена немедленно и соответствующее указание завершения уже произошло.</span><span class="sxs-lookup"><span data-stu-id="563a9-119">A return value of zero indicates that the I/O operation was completed immediately and that the corresponding completion indication already occurred.</span></span> <span data-ttu-id="563a9-120">Это значит, что связанный объект события был сигнальным, или подпрограмма завершения была поставлена в очередь и будет выполняться, когда вызывающий поток получит состояние ожидания с оповещением.</span><span class="sxs-lookup"><span data-stu-id="563a9-120">That is, the associated event object has been signaled, or a completion routine has been queued and will be executed when the calling thread gets into the alertable wait state.</span></span>

<span data-ttu-id="563a9-121">Возвращаемое значение ошибки СОКЕТа \_ , связанное с кодом ошибки, [ \_ \_ ожидающим ввода-вывода WSA](windows-sockets-error-codes-2.md) , указывает на то, что операция перекрытия была успешно инициирована, и что последующее указание будет предоставлено при использовании буферов отправки или при завершении операции получения.</span><span class="sxs-lookup"><span data-stu-id="563a9-121">A return value of SOCKET\_ERROR coupled with an error code of [WSA\_IO\_PENDING](windows-sockets-error-codes-2.md) indicates that the overlapped operation has been successfully initiated and that a subsequent indication will be provided when send buffers have been consumed or when a receive operation has been completed.</span></span> <span data-ttu-id="563a9-122">Однако для сокетов, являющихся стилями байтового потока, индикатор завершения возникает при исчерпании входящих данных независимо от того, заполнены ли буферы.</span><span class="sxs-lookup"><span data-stu-id="563a9-122">However, for sockets that are byte-stream style, the completion indication occurs whenever the incoming data is exhausted, regardless of whether the buffers are full.</span></span> <span data-ttu-id="563a9-123">Любой другой код ошибки указывает на то, что операция перекрытия не была успешно инициирована и не будет предпринята ни одна индикация завершения.</span><span class="sxs-lookup"><span data-stu-id="563a9-123">Any other error code indicates that the overlapped operation was not successfully initiated and that no completion indication will be forthcoming.</span></span>

<span data-ttu-id="563a9-124">Операции отправки и получения могут быть перекрывающиеся.</span><span class="sxs-lookup"><span data-stu-id="563a9-124">Both send and receive operations can be overlapped.</span></span> <span data-ttu-id="563a9-125">Функции Receive можно вызывать несколько раз для отправки буферов приема при подготовке входящих данных, а функции отправки могут вызываться несколько раз, чтобы поставить в очередь несколько буферов для отправки.</span><span class="sxs-lookup"><span data-stu-id="563a9-125">The receive functions can be invoked several times to post receive buffers in preparation for incoming data, and the send functions can be invoked several times to queue multiple buffers to send.</span></span> <span data-ttu-id="563a9-126">Хотя приложение может полагаться на ряд перекрывающихся буферов отправки, отправляемых в указанном порядке, соответствующие события завершения могут происходить в другом порядке.</span><span class="sxs-lookup"><span data-stu-id="563a9-126">While the application can rely upon a series of overlapped send buffers being sent in the order supplied, the corresponding completion indications might occur in a different order.</span></span> <span data-ttu-id="563a9-127">Аналогично, на принимающей стороне буферы могут быть заполнены в том порядке, в котором они указаны, но события завершения могут происходить в другом порядке.</span><span class="sxs-lookup"><span data-stu-id="563a9-127">Likewise, on the receiving side, buffers can be filled in the order they are supplied, but the completion indications might occur in a different order.</span></span>

<span data-ttu-id="563a9-128">Во многих случаях перекрывающиеся операции Winsock с использованием [**акцептекс**](/windows/win32/api/mswsock/nf-mswsock-acceptex), [**коннектекс**](/windows/desktop/api/Mswsock/nc-mswsock-lpfn_connectex), [**всасенд**](/windows/desktop/api/Winsock2/nf-winsock2-wsasend), [**всарекв**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecv), [**TransmitFile**](/windows/win32/api/mswsock/nf-mswsock-transmitfile)и аналогичных функций являются отменяемыми.</span><span class="sxs-lookup"><span data-stu-id="563a9-128">In many cases, Winsock overlapped operations using [**AcceptEx**](/windows/win32/api/mswsock/nf-mswsock-acceptex), [**ConnectEx**](/windows/desktop/api/Mswsock/nc-mswsock-lpfn_connectex), [**WSASend**](/windows/desktop/api/Winsock2/nf-winsock2-wsasend), [**WSARecv**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecv), [**TransmitFile**](/windows/win32/api/mswsock/nf-mswsock-transmitfile), and similar functions are cancelable.</span></span> <span data-ttu-id="563a9-129">Однако поведение не определено для постоянного использования сокета, для которого отменены невыполненные операции.</span><span class="sxs-lookup"><span data-stu-id="563a9-129">However, behavior is undefined for the continued use of a socket that has canceled outstanding operations.</span></span> <span data-ttu-id="563a9-130">Функция [**функции closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) должна вызываться после отмены перекрывающейся операции.</span><span class="sxs-lookup"><span data-stu-id="563a9-130">The [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) function should be called after canceling an overlapped operation.</span></span> <span data-ttu-id="563a9-131">Таким образом, для получения наилучших результатов вместо того, чтобы отменять операции ввода-вывода напрямую, необходимо вызвать функцию **функции closesocket** , чтобы закрыть сокет, который в конечном итоге прекратит все ожидающие операции.</span><span class="sxs-lookup"><span data-stu-id="563a9-131">Therefore, for best results, instead of canceling the I/O directly, the **closesocket** function should be called to close the socket which will eventually discontinue all pending operations.</span></span>

<span data-ttu-id="563a9-132">Функция отложенного завершения перекрывающихся операций ввода-вывода также доступна для [**всаиоктл**](/windows/desktop/api/Winsock2/nf-winsock2-wsaioctl), которая является улучшенной версией [**иоктлсоккет**](/windows/desktop/api/winsock/nf-winsock-ioctlsocket).</span><span class="sxs-lookup"><span data-stu-id="563a9-132">The deferred completion feature of overlapped I/O is also available for [**WSAIoctl**](/windows/desktop/api/Winsock2/nf-winsock2-wsaioctl), which is an enhanced version of [**ioctlsocket**](/windows/desktop/api/winsock/nf-winsock-ioctlsocket).</span></span>

 

 
