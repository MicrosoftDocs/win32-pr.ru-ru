---
title: Категоризация многоуровневых поставщиков услуг и приложений
description: Winsock 2 поддерживает многоуровневые протоколы.
ms.assetid: 1c5efd2e-1b42-4c20-a4da-b81a5fc4243c
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a966d54da0be26f75a074de18abe1b9e080c0c9f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105701554"
---
# <a name="categorizing-layered-service-providers-and-apps"></a>Категоризация многоуровневых поставщиков услуг и приложений

> [!Note]  
> Многоуровневые поставщики служб являются устаревшими. Начиная с Windows 8 и Windows Server 2012, используйте [платформу фильтрации Windows](../fwp/windows-filtering-platform-start-page.md).

 

Winsock 2 поддерживает многоуровневые протоколы. Многоуровневый протокол реализует только функции обмена данными более высокого уровня, в то же время полагается на базовый стек транспорта для фактического обмена данными с удаленной конечной точкой. Примером многоуровневого протокола или поставщика многоуровневой службы будет уровень безопасности, который добавляет протокол к процессу установки соединения для выполнения проверки подлинности и установки взаимно согласованной схемы шифрования. Такой протокол безопасности, как правило, требует наличия служб базового надежного транспортного протокола, такого как TCP или SPX. Термин базовый протокол, реализуемый базовым поставщиком, относится к поставщику Winsock, который реализует протокол, например TCP или SPX, который способен выполнять обмен данными с удаленной конечной точкой. Термин многоуровневый протокол используется для описания протокола, который не может быть изолирован. Эти многоуровневые протоколы устанавливаются как поставщики многоуровневых служб Winsock (LSP).

Примером LSP является поставщик клиентских служб межсетевого экрана Майкрософт, установленный как часть Internet Секутити and Authentication Server (ISA) на клиентах. Поставщик клиентских служб межсетевого экрана (Майкрософт) устанавливается через базовые поставщики Winsock для TCP и UDP. Библиотека динамической компоновки (DLL) в клиентском программном обеспечении брандмауэра ISA превращается в многоуровневый поставщик услуг Winsock, который все приложения Winsock используют прозрачно. Таким образом, клиентский пакет брандмауэра ISA может перехватывать вызовы функций Winsock из клиентских приложений, а затем перенаправлять запрос к исходному базовому поставщику службы, если место назначения является локальным, или со службой брандмауэра на компьютере ISA Server, если назначением является Remote. Аналогичный LSP устанавливается как часть службы брандмауэра Microsoft Forefront и клиента шлюза управления угрозами (TMG) на клиентах.

Во время инициализации LSP LSP должен предоставлять указатели на несколько функций интерфейса поставщика услуг Winsock (SPI). Эти функции будут вызываться во время нормальной обработки слоя непосредственно над LSP (другой LSP или Ws2 \_32.DLL).

Можно определить категории LSP на основе подмножества функций SPI, реализуемых LSP, и природы дополнительной обработки, выполняемой для каждой из этих функций. Классификация LSP, а также классификация приложений, использующих сокеты Winsock, позволяет выборочно определить, следует ли использовать LSP в процессе во время выполнения.

В Windows Vista и более поздних версиях предлагается новый метод для категоризации поставщиков многоуровневых служб и приложений Winsock, чтобы загружались только определенные LSP. Существует несколько причин для добавления этих функций.

Одна из основных причин состоит в том, что некоторые критические системные процессы, такие как Winlogon и LSASS, создают сокеты, но эти процессы не используют эти сокеты для отправки трафика в сети. Поэтому большинство LSP не должны загружаться в эти процессы. Также были описаны некоторые случаи, в которых ошибками LSP может привести к сбою *lsass.exe* . В случае сбоя LSASS система принудительно завершает работу. Побочная часть влияния этих системных процессов на загрузку LSP заключается в том, что эти процессы никогда не завершаются, поэтому при установке или удалении LSP-файла требуется перезагрузка.

Дополнительная причина заключается в том, что в некоторых случаях приложения могут не загружать определенные LSP. Например, некоторым приложениям не требуется загружать криптографические LSP, которые могут препятствовать взаимодействию приложения с другими системами, на которых не установлен LSP циптографик.

Наконец, категории LSP могут использоваться другими LSP, чтобы определить, где в цепочке протокола Winsock они должны устанавливаться самостоятельно. В течение многих лет у различных разработчиков-LSP было желание узнать, как будет вести себя LSP. Например, LSP, проверяющий поток данных, должен быть выше LSP, который шифрует данные. Разумеется, этот способ классификации «LSP» не является доказательством, так как он полагается на сторонние LSP, чтобы классифицировать себя соответствующим образом.

Функции классификации и других улучшений безопасности в Windows Vista и более поздних версий предназначены для предотвращения непреднамеренной установки вредоносных LSP.

## <a name="lsp-categories"></a>Категории LSP

В Windows Vista и более поздних версиях LSP может классифицироваться в зависимости от того, как он взаимодействует с вызовами и данными сокетов Windows. Категория LSP — это идентифицируемая группа поведений для подмножества функций Winsock SPI. Например, фильтр содержимого HTTP будет классифицироваться как инспектор данных ( \_ Категория инспектора LSP). \_Категория инспектора LSP будет проверять параметры (но не изменять) для функций SPI для обмена данными. Приложение может запрашивать категорию LSP и выбирать, следует ли не загружать LSP на основе категории LSP и набора разрешенных категорий LSP приложения.

В следующей таблице перечислены категории, в которые можно классифицировать LSP.

| Категория LSP              | Описание                                                     |
|---------------------------|-----------------------------------------------------------------|
| **Подпрограмма \_ \_ сжатия LSP** | LSP является поставщиком шифрования или сжатия данных.         |
| **LSP — \_ брандмауэр**         | LSP является поставщиком брандмауэра.                                 |
| **BSP — \_ локальный \_ кэш**     | LSP является поставщиком локального кэша.                              |
| **\_исходящее \_ изменение LSP**  | BSP изменяет входящие данные.                                  |
| **\_инспектор LSP**        | LSP проверяет или фильтрует данные.                               |
| **\_исходящее \_ изменение LSP** | LSP изменяет исходящие данные.                                 |
| **\_прокси-сервер LSP**            | LSP выступает в качестве прокси и перенаправляет пакеты.                  |
| **Перенаправление LSP \_**       | LSP — это перенаправитель сети.                                |
| **LSPная \_ система**           | LSP является приемлемым для использования в службах и системных процессах. |



 

LSP может принадлежать к более чем одной категории. Например, LSP "брандмауэр/безопасность" может принадлежать к категориям инспектора (**\_ инспектора LSP**) и брандмауэра (**LSP \_**) брандмауэра.

Если для LSP не задана Категория, он считается включенным в категорию все остальные. Эта категория LSP не будет загружена в службы или системные процессы (например, LSASS, Winlogon и многие процессы svchost).

## <a name="categorizing-lsps"></a>Категоризация LSP

В Windows Vista и более поздних версиях доступны несколько новых функций для категоризации LSP:

-   [**вскжетпровидеринфо**](/windows/desktop/api/Ws2spi/nf-ws2spi-wscgetproviderinfo)
-   [**WSCGetProviderInfo32**](/windows/desktop/api/Ws2spi/nf-ws2spi-wscgetproviderinfo32)
-   [**всксетпровидеринфо**](/windows/desktop/api/Ws2spi/nf-ws2spi-wscsetproviderinfo)
-   [**WSCSetProviderInfo32**](/windows/desktop/api/Ws2spi/nf-ws2spi-wscsetproviderinfo32)

Для категоризации LSP-функции вызывается функция [**всксетпровидеринфо**](/windows/desktop/api/Ws2spi/nf-ws2spi-wscsetproviderinfo) или [**WSCSetProviderInfo32**](/windows/desktop/api/Ws2spi/nf-ws2spi-wscsetproviderinfo32) с идентификатором GUID для обозначения скрытой записи LSP, класс сведений, заданный для этой записи протокола LSP, и набор флагов, используемых для изменения поведения функции.

Функция [**вскжетпровидеринфо**](/windows/desktop/api/Ws2spi/nf-ws2spi-wscgetproviderinfo) или [**WSCGetProviderInfo32**](/windows/desktop/api/Ws2spi/nf-ws2spi-wscgetproviderinfo32) используется аналогичным образом для получения данных, связанных с классом сведений для LSP.

## <a name="categorizing-applications"></a>Классификация приложений

В Windows Vista и более поздних версиях для категоризации приложения доступны несколько новых функций:

-   [**вскжетаппликатионкатегори**](/windows/desktop/api/Ws2spi/nf-ws2spi-wscgetapplicationcategory)
-   [**всксетаппликатионкатегори**](/windows/desktop/api/Ws2spi/nf-ws2spi-wscsetapplicationcategory)

Чтобы классифицировать приложение, функция [**всксетаппликатионкатегори**](/windows/desktop/api/Ws2spi/nf-ws2spi-wscsetapplicationcategory) вызывается с путем загрузки к исполняемому образу для указания приложения, аргументов командной строки, используемых при запуске приложения, и категорий LSP, которые разрешены для всех экземпляров этого приложения.

Функция [**вскжетаппликатионкатегори**](/windows/desktop/api/Ws2spi/nf-ws2spi-wscgetapplicationcategory) также используется для получения категорий многоуровневых поставщиков служб (LSP), связанных с приложением.

## <a name="determining-which-lsps-get-loaded"></a>Определение загружаемого LSP

Последняя часть «LSP» классификации определяет, какие LSP будут загружены в процессы. Когда процесс загружает Winsock, выполняются следующие сравнения категорий приложений и категории LSP для всех установленных LSP:

-   Если приложение не разбито на категории, разрешите загрузку всех LSP в процесс.
-   Если для приложения и LSP назначены категории, должны выполняться все следующие условия. <dl> По крайней мере одна из категорий LSP имеется в указанных категориях приложения.  
    В категориях LSP указаны только категории, указанные в указанных категориях приложения. Например, если приложение указывает категорию, она должна находиться в категории LSP.  
    Если \_ в категории приложения содержится системная Категория LSP, она должна присутствовать в категориях LSP.  
    </dl>

> [!Note]  
> Если значение LSP не относится к категории, его категория фактически не равна нулю. Для совпадения все указанные категории LSP должны присутствовать в категориях приложения (категории приложения должны быть надмножеством категорий LSP) с учетом представим, что при \_ наличии в категории приложения LSP-системы она также должна присутствовать в категории LSP.

 

Рассмотрим следующий пример.

*Foo.exeное* приложение классифицируется как LSP- \_ система + LSP \_ Firewall + LSP \_ \_ . *Bar.exe* приложения разделены на категории LSP \_ Firewall + LSP \_ Crypto \_ . В системе установлено четыре LSP:

-   LSP1 установил категорию LSP- \_ системы.
-   Для LSP2 не заданы категории, поэтому ее категория равна нулю.
-   LSP3 установил категорию LSP- \_ брандмауэра.
-   LSP4 установил категории "LSP" системы и "LSP", \_ \_ брандмауэр и \_ LSP \_ \_

В этом примере *Foo.exe* приложение будет загружать только LSP1, а *Bar.exe* приложение загрузит LSP3.

## <a name="determining-winsock-providers-installed"></a>Определение установленных поставщиков Winsock

Пакет средств разработки программного обеспечения Microsoft Windows (SDK) включает пример программы Winsock, который можно использовать для определения поставщиков транспорта Winsock, установленных на локальном компьютере. По умолчанию исходный код для этого примера Winsock устанавливается в следующий каталог Windows SDK для Windows 7:

*C: \\ Program Files \\ Microsoft SDK \\ Windows \\ v 7.0 \\ Samples \\ нетдс \\ Winsock \\ LSP*

Этот пример представляет собой служебную программу для установки и тестирования многоуровневых поставщиков служб. Но он также может использоваться для программного получения подробных сведений из каталога Winsock на локальном компьютере. Чтобы получить список всех текущих поставщиков Winsock, включая базовые поставщики и поставщиков служб слоя, создайте этот пример библиотеки Winsock и выполните следующую команду консоли:

**инстлсп-p**

Выходные данные будут представлять собой список поставщиков Winsock, установленных на локальном компьютере, включая поставщиков многоуровневых служб. Выходные данные содержат идентификатор каталога и имя строки для поставщика Winsock.

Чтобы получить более подробные сведения обо всех поставщиках Winsock, выполните следующую команду консоли:

**инстлсп-p-v**

Выходные данные будут представлять собой список структур [**всапротокол \_ info**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) , поддерживаемых на локальном компьютере.

Чтобы получить список только многоуровневых поставщиков служб, установленных на локальном компьютере, выполните следующую команду консоли:

**инстлсп-l**

Чтобы отобразить структуру LSP, выполните следующую команду консоли:

**инстлсп-m**

> [!Note]  
> Функция TDI является устаревшей и будет удалена в будущих версиях Microsoft Windows. В зависимости от того, как используется TDI, используйте либо ядро Winsock (WSK), либо платформу фильтрации Windows (WFP). Дополнительные сведения о WFP и WSK см. в разделе [платформа фильтрации Windows](../fwp/windows-filtering-platform-start-page.md) и [ядро Winsock](/windows-hardware/drivers/ddi/_netvista/). Запись блога о сети Windows Core о WSK и TDI см. [в статье Введение в Winsock Kernel (WSK)](/archive/blogs/wndp/).

 

 

 
