---
description: Ниже описана операция, которая позволяет завершить работу установленного подключения к сокету.
ms.assetid: 052e04a4-5290-4dca-af7a-cd590ebfbe15
title: Завершение подключения
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: bbde0cfe4c3a97435c2412d28970107f830308fd
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103897349"
---
# <a name="connection-shutdown"></a><span data-ttu-id="feec0-103">Завершение подключения</span><span class="sxs-lookup"><span data-stu-id="feec0-103">Connection Shutdown</span></span>

<span data-ttu-id="feec0-104">Ниже описана операция, которая позволяет завершить работу установленного подключения к сокету.</span><span class="sxs-lookup"><span data-stu-id="feec0-104">The following describes operations incident to shutting down an established socket connection.</span></span>

## <a name="initiating-shutdown-sequence"></a><span data-ttu-id="feec0-105">Инициализация последовательности завершения работы</span><span class="sxs-lookup"><span data-stu-id="feec0-105">Initiating Shutdown Sequence</span></span>

<span data-ttu-id="feec0-106">Подключение через сокет может быть выполнено одним из нескольких способов.</span><span class="sxs-lookup"><span data-stu-id="feec0-106">A socket connection can be taken down in one of several ways.</span></span> <span data-ttu-id="feec0-107">[**Вспшутдовн**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) (с *частотой* отправки SD \_ -сообщений или SD \_ ) и [**вспсенддисконнект**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) может использоваться для инициирования корректного завершения подключения.</span><span class="sxs-lookup"><span data-stu-id="feec0-107">[**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) (with *how* equal to SD\_SEND or SD\_BOTH), and [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) may be used to initiate a graceful connection shutdown.</span></span> <span data-ttu-id="feec0-108">[**Вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) можно использовать для инициации корректного или аварийного завершения работы в зависимости от параметров ожидания, вызываемых закрытием сокета.</span><span class="sxs-lookup"><span data-stu-id="feec0-108">[**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) can be used to initiate either a graceful or abortive shutdown, depending on the linger options invoked by the closing a socket.</span></span> <span data-ttu-id="feec0-109">Дополнительные сведения о корректном и аварийном завершении работы и параметрах ожидания см. ниже.</span><span class="sxs-lookup"><span data-stu-id="feec0-109">See below for more information about graceful and abortive shutdowns, and linger options.</span></span>

## <a name="indicating-remote-shutdown"></a><span data-ttu-id="feec0-110">, Указывающее на удаленное завершение работы</span><span class="sxs-lookup"><span data-stu-id="feec0-110">Indicating Remote Shutdown</span></span>

<span data-ttu-id="feec0-111">Поставщики услуг указывают на разрыв подключения, инициированный удаленной стороной с помощью события ДЕМОна по \_ закрытию сети.</span><span class="sxs-lookup"><span data-stu-id="feec0-111">Service providers indicate connection teardown that is initiated by the remote party through the FD\_CLOSE network event.</span></span> <span data-ttu-id="feec0-112">Корректное завершение работы также указывается с помощью [**вспрекв**](/previous-versions/windows/hardware/network/ff566309(v=vs.85)) , когда число считанных байтов равно 0 для протоколов потока байтов или с помощью кода возврата ошибки всаедискон для протоколов, ориентированных на сообщения.</span><span class="sxs-lookup"><span data-stu-id="feec0-112">Graceful shutdown is also be indicated through [**WSPRecv**](/previous-versions/windows/hardware/network/ff566309(v=vs.85)) when the number of bytes read is 0 for byte-stream protocols, or through a return error code of WSAEDISCON for message-oriented protocols.</span></span> <span data-ttu-id="feec0-113">В любом случае **вспрекв** возвращает код ошибки всаеконнресет, что означает аварийное завершение работы.</span><span class="sxs-lookup"><span data-stu-id="feec0-113">In any case, a **WSPRecv** return error code of WSAECONNRESET indicates an abortive shutdown.</span></span>

## <a name="exchanging-user-data-at-shutdown-time"></a><span data-ttu-id="feec0-114">Обмен данными пользователя в момент завершения работы</span><span class="sxs-lookup"><span data-stu-id="feec0-114">Exchanging User Data at Shutdown Time</span></span>

<span data-ttu-id="feec0-115">Во время разрыва соединения можно также (для протоколов, поддерживающих эту возможность) обмениваться данными пользователей между конечными точками.</span><span class="sxs-lookup"><span data-stu-id="feec0-115">At connection teardown time, it is also possible (for protocols that support this) to exchange user data between the endpoints.</span></span> <span data-ttu-id="feec0-116">Конец, инициирующий уничтожение, может вызвать [**вспсенддисконнект**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) , чтобы указать, что больше нет данных для отправки, и инициировать последовательность разрыва соединения.</span><span class="sxs-lookup"><span data-stu-id="feec0-116">The end that initiates the teardown can call [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) to indicate that no more data is to be sent and cause the connection teardown sequence to be initiated.</span></span> <span data-ttu-id="feec0-117">Для некоторых протоколов часть этой последовательности демонтажа — это доставка данных об отключении от инициатора уничтожения.</span><span class="sxs-lookup"><span data-stu-id="feec0-117">For certain protocols, part of this teardown sequence is the delivery of disconnect data from the teardown initiator.</span></span> <span data-ttu-id="feec0-118">После получения уведомления о том, что удаленная конечная точка вызвала последовательность разрыва (как правило, через \_ Указание закрытия демона), можно вызвать функцию [**вспреквдисконнект**](/previous-versions/windows/desktop/legacy/ms742285(v=vs.85)) для получения данных отключения (если они есть).</span><span class="sxs-lookup"><span data-stu-id="feec0-118">After receiving notice that the remote end has initiated the teardown sequence (typically through the FD\_CLOSE indication), the [**WSPRecvDisconnect**](/previous-versions/windows/desktop/legacy/ms742285(v=vs.85)) function may be called to receive the disconnect data (if any).</span></span>

<span data-ttu-id="feec0-119">Чтобы продемонстрировать, как можно использовать данные для отключения, рассмотрим следующий сценарий.</span><span class="sxs-lookup"><span data-stu-id="feec0-119">To illustrate how disconnect data might be used, consider the following scenario.</span></span> <span data-ttu-id="feec0-120">Клиентская часть приложения клиента/сервера отвечает за завершение подключения к сокету.</span><span class="sxs-lookup"><span data-stu-id="feec0-120">The client half of a client/server application is responsible for terminating a socket connection.</span></span> <span data-ttu-id="feec0-121">КоинЦидент с завершением он предоставляет (с помощью отключения данных) общее число транзакций, обработанных сервером.</span><span class="sxs-lookup"><span data-stu-id="feec0-121">Coincident with the termination it provides (through disconnect data) the total number of transactions it processed with the server.</span></span> <span data-ttu-id="feec0-122">Сервер, в свою очередь, реагирует на совокупный общий итог транзакций, обработанных всеми клиентами.</span><span class="sxs-lookup"><span data-stu-id="feec0-122">The server in turn responds with the cumulative grand total of transactions that it has processed with all clients.</span></span> <span data-ttu-id="feec0-123">Последовательность вызовов и указаний может быть вызвана, как показано в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="feec0-123">The sequence of calls and indications might occur as shown in the following table.</span></span>

| <span data-ttu-id="feec0-124">На стороне клиента</span><span class="sxs-lookup"><span data-stu-id="feec0-124">Client side</span></span>                                                                                                               | <span data-ttu-id="feec0-125">На сервере</span><span class="sxs-lookup"><span data-stu-id="feec0-125">Server side</span></span>                                                                                                                             |
|---------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="feec0-126">(1) вызывает [**вспсенддисконнект**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) , чтобы завершить сеанс и указать общую сумму транзакции.</span><span class="sxs-lookup"><span data-stu-id="feec0-126">(1) Invokes [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) to conclude session and supply transaction total.</span></span>            |                                                                                                                                         |
|                                                                                                                           | <span data-ttu-id="feec0-127">(2) возвращает значение ДЕМОна \_ Close или [**вспрекв**](/previous-versions/windows/hardware/network/ff566309(v=vs.85)) с возвращаемым ЗНАЧЕНИЕМ 0 или всаедискон, что означает выполнение корректного завершения работы.</span><span class="sxs-lookup"><span data-stu-id="feec0-127">(2) Gets FD\_CLOSE, or [**WSPRecv**](/previous-versions/windows/hardware/network/ff566309(v=vs.85)) with a return value of zero or WSAEDISCON indicating graceful shutdown in progress.</span></span> |
|                                                                                                                           | <span data-ttu-id="feec0-128">(3) вызывает [**вспреквдисконнект**](/previous-versions/windows/desktop/legacy/ms742285(v=vs.85)) для получения общего числа транзакций клиента.</span><span class="sxs-lookup"><span data-stu-id="feec0-128">(3) Invokes [**WSPRecvDisconnect**](/previous-versions/windows/desktop/legacy/ms742285(v=vs.85)) to get client's transaction total.</span></span>                                         |
|                                                                                                                           | <span data-ttu-id="feec0-129">(4) вычисление совокупного общего итога по всем транзакциям.</span><span class="sxs-lookup"><span data-stu-id="feec0-129">(4) Computes cumulative grand total of all transactions.</span></span>                                                                                |
|                                                                                                                           | <span data-ttu-id="feec0-130">(5) вызывает [**вспсенддисконнект**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) для передачи общего итога.</span><span class="sxs-lookup"><span data-stu-id="feec0-130">(5) Invokes [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) to transmit grand total.</span></span>                                                   |
| <span data-ttu-id="feec0-131">(6) получает \_ уведомление о закрытии демона.</span><span class="sxs-lookup"><span data-stu-id="feec0-131">(6) Receives FD\_CLOSE indication.</span></span>                                                                                        | <span data-ttu-id="feec0-132">(5) вызывает [ **вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="feec0-132">(5') Invokes [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span></span>                                                                                 |
| <span data-ttu-id="feec0-133">(7) вызывает [**вспреквдисконнект**](/previous-versions/windows/desktop/legacy/ms742285(v=vs.85)) для получения и хранения совокупного общего итога транзакций.</span><span class="sxs-lookup"><span data-stu-id="feec0-133">(7) Invokes [**WSPRecvDisconnect**](/previous-versions/windows/desktop/legacy/ms742285(v=vs.85)) to receive and store cumulative grand total of transactions.</span></span> |                                                                                                                                         |
|                                                                                                                           | <span data-ttu-id="feec0-134">(8) вызывает [ **вспклосесоккет**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="feec0-134">(8) Invokes [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span></span>                                                                                  |



 

<span data-ttu-id="feec0-135">Шаг (5) должен следовать за шагом (5), но не имеет отношения времени с шагами (6), (7) или (8).</span><span class="sxs-lookup"><span data-stu-id="feec0-135">Step (5') must follow step (5), but has no timing relationship with steps (6), (7), or (8).</span></span>

 

 
