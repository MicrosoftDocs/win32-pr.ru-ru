---
description: Ws2 \_32.dll загружает БИБЛИОТЕКУ DLL интерфейса поставщика услуг в систему с помощью стандартных механизмов загрузки динамических библиотек Microsoft Windows и инициализирует ее путем вызова вспстартуп.
ms.assetid: 6df28d93-8757-45b3-8f05-86381c3be64e
title: Инициализация
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 84d6ef10db421ef15f2bb94eb67e96fc2cfc5924
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105701514"
---
# <a name="initialization"></a><span data-ttu-id="88217-103">Инициализация</span><span class="sxs-lookup"><span data-stu-id="88217-103">Initialization</span></span>

<span data-ttu-id="88217-104">*Ws2 \_32.dll* загружает библиотеку DLL интерфейса поставщика услуг в систему с помощью стандартных механизмов загрузки динамических библиотек Microsoft Windows и инициализирует ее путем вызова [**вспстартуп**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span><span class="sxs-lookup"><span data-stu-id="88217-104">The *Ws2\_32.dll* loads the service provider's interface DLL into the system by using the standard Microsoft Windows dynamic library loading mechanisms, and initializes it by calling [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span></span> <span data-ttu-id="88217-105">Обычно это активируется приложением, вызывающим [**сокет**](/windows/desktop/api/Winsock2/nf-winsock2-socket) или [**всасоккет**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) , для создания нового сокета, который будет связан с поставщиком услуг, DLL интерфейса которого в данный момент не загружен в память.</span><span class="sxs-lookup"><span data-stu-id="88217-105">This is typically triggered by an application calling either [**socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket) or [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) to create a new socket to be associated with a service provider whose interface DLL is not currently loaded into memory.</span></span> <span data-ttu-id="88217-106">Путь к библиотеке DLL интерфейса каждого поставщика услуг хранится в *Ws2 \_32.dll* на момент установки поставщика служб.</span><span class="sxs-lookup"><span data-stu-id="88217-106">The path to each service provider's interface DLL is stored by the *Ws2\_32.dll* at the time the service provider is being installed.</span></span> <span data-ttu-id="88217-107">Дополнительные сведения см. в разделе [функции установки и настройки](installation-and-configuration-functions-2.md) .</span><span class="sxs-lookup"><span data-stu-id="88217-107">See [Installation and Configuration Functions](installation-and-configuration-functions-2.md) for more information.</span></span>

<span data-ttu-id="88217-108">Со временем для библиотек DLL, приложений и поставщиков служб Winsock могут существовать разные версии.</span><span class="sxs-lookup"><span data-stu-id="88217-108">Over time, different versions may exist for the Winsock DLLs, applications, and service providers.</span></span> <span data-ttu-id="88217-109">Новые версии могут определять новые функции и новые параметры для структур данных, а также битовые параметры и т. д. Поэтому номера версий указывают, как интерпретировать различные структуры данных.</span><span class="sxs-lookup"><span data-stu-id="88217-109">New versions may define new features and new parameters to data structures and bit parameters, etc. Version numbers therefore indicate how to interpret various data structures.</span></span>

<span data-ttu-id="88217-110">Чтобы обеспечить оптимальное смешивание и сопоставление различных версий приложений, версий Ws2 \_32.dll и версий поставщиков услуг разных поставщиков, SPI предоставляет механизм согласования версий для использования между *Ws2 \_32.dll* и поставщиками служб.</span><span class="sxs-lookup"><span data-stu-id="88217-110">To allow optimal mixing and matching of different versions of applications, versions of the Ws2\_32.dll itself, and versions of service providers by different vendors, the SPI provides a version negotiation mechanism for use between the *Ws2\_32.dll* and the service providers.</span></span> <span data-ttu-id="88217-111">Это согласование версий обрабатывается с помощью [**вспстартуп**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span><span class="sxs-lookup"><span data-stu-id="88217-111">This version negotiation is handled by [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span></span> <span data-ttu-id="88217-112">По сути, *Ws2 \_32.dll* передает поставщику услуг наиболее высокие номера версий, с которыми она совместима.</span><span class="sxs-lookup"><span data-stu-id="88217-112">Basically, the *Ws2\_32.dll* passes to the service provider the highest version numbers with which it is compatible.</span></span> <span data-ttu-id="88217-113">Поставщик услуг сравнивает это с собственным поддерживаемым диапазоном номеров версий.</span><span class="sxs-lookup"><span data-stu-id="88217-113">The service provider compares this with its own supported range of version numbers.</span></span> <span data-ttu-id="88217-114">Если эти диапазоны перекрываются, поставщик услуг возвращает значение в перекрывающейся части диапазона в результате согласования.</span><span class="sxs-lookup"><span data-stu-id="88217-114">If these ranges overlap, the service provider returns a value within the overlapping portion of the range as the result of the negotiation.</span></span> <span data-ttu-id="88217-115">Обычно это должно быть наибольшее возможное значение.</span><span class="sxs-lookup"><span data-stu-id="88217-115">Usually, this should be the highest possible value.</span></span> <span data-ttu-id="88217-116">Если диапазоны не пересекаются, эти две стороны несовместимы и функция возвращает ошибку.</span><span class="sxs-lookup"><span data-stu-id="88217-116">If the ranges do not overlap, the two parties are incompatible and the function returns an error.</span></span>

<span data-ttu-id="88217-117">[**Вспстартуп**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) должен вызываться по крайней мере один раз каждым клиентским процессом и может вызываться несколько раз с помощью Ws2 \_32.dll или других сущностей.</span><span class="sxs-lookup"><span data-stu-id="88217-117">[**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) must be called at least once by each client process, and may be called multiple times by Ws2\_32.dll or other entities.</span></span> <span data-ttu-id="88217-118">Для каждого успешного вызова **вспстартуп** должен быть вызван соответствующий [**вспклеануп**](/previous-versions/windows/hardware/network/ff566270(v=vs.85)) .</span><span class="sxs-lookup"><span data-stu-id="88217-118">A matching [**WSPCleanup**](/previous-versions/windows/hardware/network/ff566270(v=vs.85)) must be called for each successful **WSPStartup** call.</span></span> <span data-ttu-id="88217-119">Поставщик услуг должен поддерживать счетчик ссылок для каждого процесса.</span><span class="sxs-lookup"><span data-stu-id="88217-119">The service provider should maintain a reference count on a per-process basis.</span></span> <span data-ttu-id="88217-120">При каждом вызове **вспстартуп** вызывающая сторона может указать любой номер версии, поддерживаемый DLL-библиотекой SP.</span><span class="sxs-lookup"><span data-stu-id="88217-120">On each **WSPStartup** call, the caller may specify any version number supported by the SP DLL.</span></span>

<span data-ttu-id="88217-121">Поставщик услуг должен хранить указатель на таблицу диспетчеризации отправки клиента, которая получается как параметр [**вспстартуп**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) для каждого процесса.</span><span class="sxs-lookup"><span data-stu-id="88217-121">A service provider must store the pointer to the client's upcall dispatch table that is received as a [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) parameter on a per-process basis.</span></span> <span data-ttu-id="88217-122">Если заданный процесс вызывает **вспстартуп** несколько раз, поставщик услуг должен использовать только самый последний переданный указатель на таблицу диспетчеризации.</span><span class="sxs-lookup"><span data-stu-id="88217-122">If a given process calls **WSPStartup** multiple times, the service provider must use only the most recently supplied dispatch table pointer.</span></span>

<span data-ttu-id="88217-123">В рамках процесса инициализации поставщика услуг Ws2 \_32.dll извлекает таблицу диспетчеризации поставщика услуг через параметр *лппроктабле* , чтобы получить точки входа для остальных функций SPI, указанных в этом документе.</span><span class="sxs-lookup"><span data-stu-id="88217-123">As part of the service provider initialization process The Ws2\_32.dll retrieves the service provider's dispatch table through the *lpProcTable* parameter in order to obtain entry points to the rest of the SPI functions specified in this document.</span></span>

<span data-ttu-id="88217-124">Использование таблицы диспетчеризации (в отличие от обычных механизмов DLL для доступа к точкам входа) служит двум целям:</span><span class="sxs-lookup"><span data-stu-id="88217-124">Using a dispatch table (as opposed to the usual DLL mechanisms for accessing entry points) serves two purposes:</span></span>

-   <span data-ttu-id="88217-125">Более удобно использовать32.dll Ws2, \_ так как для обнаружения всего набора точек входа можно выполнить один вызов.</span><span class="sxs-lookup"><span data-stu-id="88217-125">It is more convenient for the Ws2\_32.dll since a single call can be made to discover the entire set of entry points.</span></span>
-   <span data-ttu-id="88217-126">Он позволяет использовать многоуровневые поставщики услуг, сформированные в цепочках протоколов, для повышения эффективности работы.</span><span class="sxs-lookup"><span data-stu-id="88217-126">It enables layered service providers formed into protocol chains to operate more efficiently.</span></span>

## <a name="initializing-protocol-chains"></a><span data-ttu-id="88217-127">Инициализация цепочек протоколов</span><span class="sxs-lookup"><span data-stu-id="88217-127">Initializing Protocol Chains</span></span>

<span data-ttu-id="88217-128">Во время установки структуры [**протокола \_ всапротокол**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) для цепочки протоколов также указывается путь к первому многоуровневый поставщику в цепочке.</span><span class="sxs-lookup"><span data-stu-id="88217-128">At the time the [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure for a protocol chain is installed, the path to the first layered provider in the chain is also specified.</span></span> <span data-ttu-id="88217-129">При инициализации цепочки протоколов \_32.dll Ws2 использует этот путь для загрузки библиотеки DLL поставщика, а затем вызывает [**вспстартуп**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span><span class="sxs-lookup"><span data-stu-id="88217-129">When a protocol chain is initialized, the Ws2\_32.dll uses this path to load the provider DLL and then invokes [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span></span> <span data-ttu-id="88217-130">Так как **вспстартуп** содержит указатель на структуру **\_ сведений о всапротокол** цепочки как один из параметров, многоуровневые поставщики могут определить тип цепочки, в которую они инициализируются, а также идентификатор следующего более низкого слоя в цепочке.</span><span class="sxs-lookup"><span data-stu-id="88217-130">Since **WSPStartup** includes a pointer to the chain's **WSAPROTOCOL\_INFO** structure as one of its parameters, layered providers can determine what type of chain they are being initialized into, and the identity of the next lower layer in the chain.</span></span> <span data-ttu-id="88217-131">Многоуровневый поставщик затем, в свою очередь, загрузит следующий поставщик протокола в цепочку и инициализирует его с помощью вызова **вспстартуп** и т. д.</span><span class="sxs-lookup"><span data-stu-id="88217-131">A layered provider would then in turn load the next protocol provider in the chain and initialize it with a call to **WSPStartup**, and so forth.</span></span> <span data-ttu-id="88217-132">Каждый раз, когда следующий более низкий уровень является другим многоуровневый поставщиком, в вызове **вспстартуп** должна быть ссылка на структуру **\_ сведений о всапротокол** цепочки.</span><span class="sxs-lookup"><span data-stu-id="88217-132">Whenever the next lower layer is another layered provider, the chain's **WSAPROTOCOL\_INFO** structure must be referenced in the **WSPStartup** call.</span></span> <span data-ttu-id="88217-133">Если следующий более низкий уровень является базовым протоколом (обозначает конец цепочки), структура **\_ сведений всапротокол** цепочки больше не распространяется вниз.</span><span class="sxs-lookup"><span data-stu-id="88217-133">When the next lower layer is a base protocol (signifying the end of the chain), the chain's **WSAPROTOCOL\_INFO** structure is no longer propagated downward.</span></span> <span data-ttu-id="88217-134">Вместо этого текущий слой должен ссылаться на структуру **всапротокол \_ info** , соответствующую протоколу, который должен использовать базовый поставщик.</span><span class="sxs-lookup"><span data-stu-id="88217-134">Instead, the current layer must reference a **WSAPROTOCOL\_INFO** structure that corresponds to the protocol that the base provider should use.</span></span> <span data-ttu-id="88217-135">Поэтому базовый поставщик не имеет представления о вовлечении в цепочку протоколов.</span><span class="sxs-lookup"><span data-stu-id="88217-135">Thus, the base provider has no notion of being involved in a protocol chain.</span></span>

<span data-ttu-id="88217-136">Таблица диспетчеризации, предоставленная любым указанным многоуровневый поставщиком, во многих случаях дублирует точки входа базового поставщика.</span><span class="sxs-lookup"><span data-stu-id="88217-136">The dispatch table provided by any given layered provider will, in many instances, duplicate the entry points of an underlying provider.</span></span> <span data-ttu-id="88217-137">Многоуровневый поставщик будет вставлять свои точки входа только для тех функций, в которые ей нужно напрямую участвовать.</span><span class="sxs-lookup"><span data-stu-id="88217-137">The layered provider would only insert its own entry points for functions that it needed to be directly involved in.</span></span> <span data-ttu-id="88217-138">Однако следует отметить, что при вызове [**вспстартуп**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) на следующем более низком уровне цепочки протоколов необходимо, чтобы многоуровневый поставщик не изменил содержимое таблицы исзываемого вызова.</span><span class="sxs-lookup"><span data-stu-id="88217-138">Note, however, that it is imperative that a layered provider not modify the contents of the upcall table that it received when calling [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) on the next lower layer in a protocol chain.</span></span> <span data-ttu-id="88217-139">Эти вызовы должны быть сделаны непосредственно в библиотеке DLL Windows Sockets 2.</span><span class="sxs-lookup"><span data-stu-id="88217-139">These upcalls must be made directly to the Windows Sockets 2 DLL.</span></span>

 

 
