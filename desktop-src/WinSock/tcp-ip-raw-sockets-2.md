---
description: Необработанный сокет — это тип сокета, который обеспечивает доступ к базовому поставщику транспорта.
ms.assetid: 4cbe5505-75e7-454f-9e6b-f38bdc60bf6d
title: Необработанные сокеты TCP/IP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 25cc08d59d80089a4e655f363e4a899edac8d2b8
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105711759"
---
# <a name="tcpip-raw-sockets"></a><span data-ttu-id="37f32-103">Необработанные сокеты TCP/IP</span><span class="sxs-lookup"><span data-stu-id="37f32-103">TCP/IP Raw Sockets</span></span>

<span data-ttu-id="37f32-104">Необработанный сокет — это тип сокета, который обеспечивает доступ к базовому поставщику транспорта.</span><span class="sxs-lookup"><span data-stu-id="37f32-104">A raw socket is a type of socket that allows access to the underlying transport provider.</span></span> <span data-ttu-id="37f32-105">В этом разделе рассматриваются только необработанные сокеты и протоколы IPv4 и IPv6.</span><span class="sxs-lookup"><span data-stu-id="37f32-105">This topic focuses only on raw sockets and the IPv4 and IPv6 protocols.</span></span> <span data-ttu-id="37f32-106">Это связано с тем, что большинство других протоколов с исключением ATM не поддерживает необработанные сокеты.</span><span class="sxs-lookup"><span data-stu-id="37f32-106">This is because most other protocols with the exception of ATM do not support raw sockets.</span></span> <span data-ttu-id="37f32-107">Чтобы использовать необработанные сокеты, приложение должно иметь подробную информацию об используемом базовом протоколе.</span><span class="sxs-lookup"><span data-stu-id="37f32-107">To use raw sockets, an application needs to have detailed information on the underlying protocol being used.</span></span>

<span data-ttu-id="37f32-108">Поставщики служб Winsock для IP-протокола могут поддерживать *тип* сокета **Сокк \_ RAW**.</span><span class="sxs-lookup"><span data-stu-id="37f32-108">Winsock service providers for the IP protocol may support a socket *type* of **SOCK\_RAW**.</span></span> <span data-ttu-id="37f32-109">Поставщик Windows Sockets 2 для TCP/IP, включенный в Windows, поддерживает этот тип **Сокк \_ необработанного** сокета.</span><span class="sxs-lookup"><span data-stu-id="37f32-109">The Windows Sockets 2 provider for TCP/IP included on Windows supports this **SOCK\_RAW** socket type.</span></span>

<span data-ttu-id="37f32-110">Существует два основных типа таких необработанных сокетов:</span><span class="sxs-lookup"><span data-stu-id="37f32-110">There are two basic types of such raw sockets:</span></span>

-   <span data-ttu-id="37f32-111">Первый тип использует известный тип протокола, записанный в IP-заголовке, который распознается поставщиком службы Winsock.</span><span class="sxs-lookup"><span data-stu-id="37f32-111">The first type uses a known protocol type written in the IP header that is recognized by a Winsock service provider.</span></span> <span data-ttu-id="37f32-112">Примером первого типа сокета является сокет для протокола ICMP (тип протокола IP = 1) или протокол ICMPv6 (IP протокола Type = 58).</span><span class="sxs-lookup"><span data-stu-id="37f32-112">An example of the first type of socket is a socket for the ICMP protocol (IP protocol type = 1) or the ICMPv6 protocol (IP procotol type = 58).</span></span>
-   <span data-ttu-id="37f32-113">Второй тип позволяет указать любой тип протокола.</span><span class="sxs-lookup"><span data-stu-id="37f32-113">The second type allows any protocol type to be specified.</span></span> <span data-ttu-id="37f32-114">Примером второго типа будет экспериментальный протокол, который не поддерживается напрямую поставщиком службы Winsock, например протоколом передачи управления потоком (SCTP).</span><span class="sxs-lookup"><span data-stu-id="37f32-114">An example of the second type would be an experimental protocol that is not directly supported by the Winsock service provider such as the Stream Control Transmission Protocol (SCTP).</span></span>

## <a name="determining-if-raw-sockets-are-supported"></a><span data-ttu-id="37f32-115">Определение поддержки необработанных сокетов</span><span class="sxs-lookup"><span data-stu-id="37f32-115">Determining if Raw Sockets are Supported</span></span>

<span data-ttu-id="37f32-116">Если поставщик услуг Winsock поддерживает **Сокк \_ необработанные** сокеты для \_ семейств адресов AF inet или AF \_ INET6, тип сокета **Сокк \_ RAW** должен включаться в структуру [**всапротокол \_ info**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) , возвращаемую функцией [**всаенумпротоколс**](/windows/desktop/api/Winsock2/nf-winsock2-wsaenumprotocolsa) для одного или нескольких доступных поставщиков транспорта.</span><span class="sxs-lookup"><span data-stu-id="37f32-116">If a Winsock service provider supports **SOCK\_RAW** sockets for the AF\_INET or AF\_INET6 address families, the socket type of **SOCK\_RAW** should be included in the [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure returned by [**WSAEnumProtocols**](/windows/desktop/api/Winsock2/nf-winsock2-wsaenumprotocolsa) function for one or more of the available transport providers.</span></span>

<span data-ttu-id="37f32-117">Элемент **иаддрессфамили** в структуре [**\_ сведений о всапротокол**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) должен указывать AF \_ inet или AF \_ INET6, а элемент **исоккеттипе** структуры всапротокол должен **указать \_** **Сокк \_ RAW** для одного из поставщиков транспорта.</span><span class="sxs-lookup"><span data-stu-id="37f32-117">The **iAddressFamily** member in the [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure should specify AF\_INET or AF\_INET6 and the **iSocketType** member of the **WSAPROTOCOL\_INFO** structure should specify **SOCK\_RAW** for one of the transport providers.</span></span>

<span data-ttu-id="37f32-118">Элемент **ипротокол** структуры [**\_ info Всапротокол**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) может иметь значение **ипрото \_ IP**.</span><span class="sxs-lookup"><span data-stu-id="37f32-118">The **iProtocol** member of the [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure may be set to **IPROTO\_IP**.</span></span> <span data-ttu-id="37f32-119">Элемент **ипротокол** структуры **\_ info всапротокол** также может иметь нулевое значение, если поставщик услуг позволяет приложению использовать тип **\_ необработанного** сокета Сокк для других сетевых протоколов, отличных от протокола Интернета для семейства адресов.</span><span class="sxs-lookup"><span data-stu-id="37f32-119">The **iProtocol** member of the **WSAPROTOCOL\_INFO** structure may also be set to zero if the service provider allows an application to use a **SOCK\_RAW** socket type for other network protocols other than the Internet Protocol for the address family.</span></span>

<span data-ttu-id="37f32-120">Другие члены в структуре [**\_ сведений всапротокол**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) указывают другие свойства поддержки протокола для **Сокк \_ RAW** и указывают, как должен обрабатываться сокет **Сокк \_ RAW** .</span><span class="sxs-lookup"><span data-stu-id="37f32-120">The other members in the [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure indicate other properties of the protocol support for **SOCK\_RAW** and indicate how a socket of **SOCK\_RAW** should be treated.</span></span> <span data-ttu-id="37f32-121">Эти другие члены **всапротокол \_ сведений** для **Сокк \_ RAW** обычно указывают, что протокол является бесустановленным, ориентированным на сообщения, поддерживает широковещательную или многоадресную рассылку (XP1 \_ без подключения, XP1 \_ \_ , ориентированную на сообщения, \_ поддержку поддержки XP1 \_ , а XP1 \_ поддерживает \_ бит MULTIPOINT) и может иметь максимальный размер сообщения 65 467 байт.</span><span class="sxs-lookup"><span data-stu-id="37f32-121">These other members of the **WSAPROTOCOL\_INFO** for **SOCK\_RAW** normally specify that the protocol is connectionless, message-oriented, supports broadcast/multicast (the XP1\_CONNECTIONLESS, XP1\_MESSAGE\_ORIENTED, XP1\_SUPPORT\_BROADCAST, and XP1\_SUPPORT\_MULTIPOINT bits are set in the dwServiceFlags1 member), and can have a maximum message size of 65,467 bytes.</span></span>

<span data-ttu-id="37f32-122">В Windows XP и более поздних версиях можно использовать команду *NetSh.exe* , чтобы определить, поддерживаются ли необработанные сокеты.</span><span class="sxs-lookup"><span data-stu-id="37f32-122">On Windows XP and later, the *NetSh.exe* command can be used to determine if raw sockets are supported.</span></span> <span data-ttu-id="37f32-123">Следующая команда из окна CMD выводит данные из каталога Winsock в консоли:</span><span class="sxs-lookup"><span data-stu-id="37f32-123">The following command run from a CMD window will display data from the Winsock catalog on the console:</span></span>

<span data-ttu-id="37f32-124">**Netsh Winsock показывать каталог**</span><span class="sxs-lookup"><span data-stu-id="37f32-124">**netsh winsock show catalog**</span></span>

<span data-ttu-id="37f32-125">Выходные данные будут содержать список, содержащий некоторые данные из структур [**всапротокол \_ info**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) , поддерживаемых на локальном компьютере.</span><span class="sxs-lookup"><span data-stu-id="37f32-125">The output will include a list that contains some of the data from the [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structures supported on the local computer.</span></span> <span data-ttu-id="37f32-126">Найдите термин RAW/IP или RAW/IPv6 в поле Описание, чтобы найти протоколы, поддерживающие необработанные сокеты.</span><span class="sxs-lookup"><span data-stu-id="37f32-126">Search for the term RAW/IP or RAW/IPv6 in the Description field to find those protocols that support raw sockets.</span></span>

## <a name="creating-a-raw-socket"></a><span data-ttu-id="37f32-127">Создание необработанного сокета</span><span class="sxs-lookup"><span data-stu-id="37f32-127">Creating a Raw Socket</span></span>

<span data-ttu-id="37f32-128">Чтобы создать сокет типа **Сокк \_ RAW**, вызовите функцию [**Socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket) или [**всасоккет**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) с параметром *AF* (семейство адресов), для которого задано значение AF \_ inet или AF \_ INET6, параметру *Type* задано значение **Сокк \_ RAW**, а параметру *протокола* задано значение требуемого номера протокола.</span><span class="sxs-lookup"><span data-stu-id="37f32-128">To create a socket of type **SOCK\_RAW**, call the [**socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket) or [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) function with the *af* parameter (address family) set to AF\_INET or AF\_INET6, the *type* parameter set to **SOCK\_RAW**, and the *protocol* parameter set to the protocol number required.</span></span> <span data-ttu-id="37f32-129">Параметр *протокола* становится значением протокола в IP-заголовке (например, SCTP — 132).</span><span class="sxs-lookup"><span data-stu-id="37f32-129">The *protocol* parameter becomes the protocol value in the IP header (SCTP is 132, for example).</span></span>

> [!Note]  
> <span data-ttu-id="37f32-130">Приложение не может указывать нуль (0) в качестве параметра *протокола* для функций [**Socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket), [**всасоккет**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa)и [**вспсоккет**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) , если для параметра *Type* задано значение **Сокк \_ RAW**.</span><span class="sxs-lookup"><span data-stu-id="37f32-130">An application may not specify zero (0) as the *protocol* parameter for the [**socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket), [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa), and [**WSPSocket**](/windows/desktop/api/Ws2spi/nc-ws2spi-lpwspsocket) functions if the *type* parameter is set to **SOCK\_RAW**.</span></span>

 

<span data-ttu-id="37f32-131">Необработанные сокеты предоставляют возможность управлять базовым транспортом, поэтому их можно использовать для вредоносных целей, представляющих угрозу безопасности.</span><span class="sxs-lookup"><span data-stu-id="37f32-131">Raw sockets offer the capability to manipulate the underlying transport, so they can be used for malicious purposes that pose a security threat.</span></span> <span data-ttu-id="37f32-132">Таким образом, только члены группы "Администраторы" могут создавать сокеты типа Сокк \_ RAW в Windows 2000 и более поздних версиях.</span><span class="sxs-lookup"><span data-stu-id="37f32-132">Therefore, only members of the Administrators group can create sockets of type SOCK\_RAW on Windows 2000 and later.</span></span>

## <a name="send-and-receive-operations"></a><span data-ttu-id="37f32-133">Операции отправки и получения</span><span class="sxs-lookup"><span data-stu-id="37f32-133">Send and Receive Operations</span></span>

<span data-ttu-id="37f32-134">Когда приложение создает сокет типа **Сокк \_ RAW**, этот сокет можно использовать для отправки и получения данных.</span><span class="sxs-lookup"><span data-stu-id="37f32-134">Once an application creates a socket of type **SOCK\_RAW**, this socket may be used to send and receive data.</span></span> <span data-ttu-id="37f32-135">Все пакеты, отправленные или полученные на сокете типа **Сокк \_ RAW** , обрабатываются как датаграммы на неподключенном сокете.</span><span class="sxs-lookup"><span data-stu-id="37f32-135">All packets sent or received on a socket of type **SOCK\_RAW** are treated as datagrams on an unconnected socket.</span></span>

<span data-ttu-id="37f32-136">К операциям по **Сокк \_ необработанным** сокетам применяются следующие правила.</span><span class="sxs-lookup"><span data-stu-id="37f32-136">The following rules apply to the operations over **SOCK\_RAW** sockets:</span></span>

-   <span data-ttu-id="37f32-137">Функция [**SendTo**](/windows/desktop/api/winsock/nf-winsock-sendto) или [**всасендто**](/windows/desktop/api/Winsock2/nf-winsock2-wsasendto) обычно используется для отправки данных на сокет типа **Сокк \_ RAW**.</span><span class="sxs-lookup"><span data-stu-id="37f32-137">The [**sendto**](/windows/desktop/api/winsock/nf-winsock-sendto) or [**WSASendTo**](/windows/desktop/api/Winsock2/nf-winsock2-wsasendto) function is normally used to send data on a socket of type **SOCK\_RAW**.</span></span> <span data-ttu-id="37f32-138">Адресом назначения может быть любой допустимый адрес в семействе адресов сокета, включая широковещательный или многоадресный адрес.</span><span class="sxs-lookup"><span data-stu-id="37f32-138">The destination address can be any valid address in the socket's address family, including a broadcast or multicast address.</span></span> <span data-ttu-id="37f32-139">Чтобы отправить широковещательный адрес, приложение должно использовать [**сетсоккопт**](/windows/desktop/api/winsock/nf-winsock-setsockopt) с таким образом, чтобы \_ вещание было включено.</span><span class="sxs-lookup"><span data-stu-id="37f32-139">To send to a broadcast address, an application must have used [**setsockopt**](/windows/desktop/api/winsock/nf-winsock-setsockopt) with SO\_BROADCAST enabled.</span></span> <span data-ttu-id="37f32-140">В противном случае **SendTo** или **всасендто** завершится ошибкой с кодом ошибки [всаеакцес](windows-sockets-error-codes-2.md).</span><span class="sxs-lookup"><span data-stu-id="37f32-140">Otherwise, **sendto** or **WSASendTo** will fail with the error code [WSAEACCES](windows-sockets-error-codes-2.md).</span></span> <span data-ttu-id="37f32-141">Для IP-адреса приложение может отправить на любой адрес многоадресной рассылки (без участия в группе).</span><span class="sxs-lookup"><span data-stu-id="37f32-141">For IP, an application can send to any multicast address (without becoming a group member).</span></span>
-   <span data-ttu-id="37f32-142">При отправке данных IPv4 приложение имеет возможность указать, следует ли указывать заголовок IPv4 в начале исходящей датаграммы для пакета.</span><span class="sxs-lookup"><span data-stu-id="37f32-142">When sending IPv4 data, an application has a choice on whether to specify the IPv4 header at the front of the outgoing datagram for the packet.</span></span> <span data-ttu-id="37f32-143">Если для параметра **IP- \_ хдринкл** Socket задано значение true для сокета IPv4 (семейство адресов AF \_ iNet), приложение должно предоставить заголовок IPv4 в исходящих данных для операций отправки.</span><span class="sxs-lookup"><span data-stu-id="37f32-143">If the **IP\_HDRINCL** socket option is set to true for an IPv4 socket (address family of AF\_INET), the application must supply the IPv4 header in the outgoing data for send operations.</span></span> <span data-ttu-id="37f32-144">Если этот параметр сокета имеет значение false (значение по умолчанию), то заголовок IPv4 не должен включаться в исходящие данные для операций отправки.</span><span class="sxs-lookup"><span data-stu-id="37f32-144">If this socket option is false (the default setting), then the IPv4 header should not be in included the outgoing data for send operations.</span></span>
-   <span data-ttu-id="37f32-145">При отправке данных IPv6 приложение имеет возможность указать, следует ли указывать заголовок IPv6 в начале исходящей датаграммы для пакета.</span><span class="sxs-lookup"><span data-stu-id="37f32-145">When sending IPv6 data, an application has a choice on whether to specify the IPv6 header at the front of the outgoing datagram for the packet.</span></span> <span data-ttu-id="37f32-146">Если параметр сокета **\_ хдринкл IPv6** имеет значение true для сокета IPv6 (семейство адресов AF \_ INET6), приложение должно предоставить заголовок IPv6 в исходящих данных для операций отправки.</span><span class="sxs-lookup"><span data-stu-id="37f32-146">If the **IPV6\_HDRINCL** socket option is set to true for an IPv6 socket (address family of AF\_INET6), the application must supply the IPv6 header in the outgoing data for send operations.</span></span> <span data-ttu-id="37f32-147">Значение по умолчанию для этого параметра — false.</span><span class="sxs-lookup"><span data-stu-id="37f32-147">The default setting for this option is false.</span></span> <span data-ttu-id="37f32-148">Если этот параметр сокета имеет значение false (значение по умолчанию), то заголовок IPv6 не должен включаться в исходящие данные для операций отправки.</span><span class="sxs-lookup"><span data-stu-id="37f32-148">If this socket option is false (the default setting), then the IPv6 header should not be included in the outgoing data for send operations.</span></span> <span data-ttu-id="37f32-149">Для IPv6 не нужно включать заголовок IPv6.</span><span class="sxs-lookup"><span data-stu-id="37f32-149">For IPv6, there should be no need to include the IPv6 header.</span></span> <span data-ttu-id="37f32-150">Если сведения доступны с помощью функций сокета, то заголовок IPv6 не следует включать, чтобы избежать проблем совместимости в будущем.</span><span class="sxs-lookup"><span data-stu-id="37f32-150">If information is available using socket functions, then the IPv6 header should not be included to avoid compatibility problems in the future.</span></span> <span data-ttu-id="37f32-151">Эти проблемы обсуждаются в RFC 3542, опубликованных IETF.</span><span class="sxs-lookup"><span data-stu-id="37f32-151">These issues are discussed in RFC 3542 published by the IETF.</span></span> <span data-ttu-id="37f32-152">Использование параметра сокета **\_ хдринкл IPv6** не рекомендуется и может быть устаревшим в будущем.</span><span class="sxs-lookup"><span data-stu-id="37f32-152">Using the **IPV6\_HDRINCL** socket option is not recommended and may be deprecated in future.</span></span>
-   <span data-ttu-id="37f32-153">Функция [**реквфром**](/windows/desktop/api/winsock/nf-winsock-recvfrom) или [**всареквфром**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecvfrom) обычно используется для получения данных на сокете типа **Сокк \_ RAW**.</span><span class="sxs-lookup"><span data-stu-id="37f32-153">The [**recvfrom**](/windows/desktop/api/winsock/nf-winsock-recvfrom) or [**WSARecvFrom**](/windows/desktop/api/Winsock2/nf-winsock2-wsarecvfrom) function is normally used to receive data on a socket of type **SOCK\_RAW**.</span></span> <span data-ttu-id="37f32-154">Обе эти функции имеют возможность вернуть исходный IP-адрес, с которого был отправлен пакет.</span><span class="sxs-lookup"><span data-stu-id="37f32-154">Both of these functions have an option to return the source IP address where the packet was sent from.</span></span> <span data-ttu-id="37f32-155">Полученные данные — это датаграмма неподключенного сокета.</span><span class="sxs-lookup"><span data-stu-id="37f32-155">The received data is a datagram from an unconnected socket.</span></span>
-   <span data-ttu-id="37f32-156">Для IPv4 (семейство адресов AF \_ iNet) приложение получает заголовок IP-адреса в начале каждой полученной датаграммы независимо от параметра **IP- \_ хдринкл** Socket.</span><span class="sxs-lookup"><span data-stu-id="37f32-156">For IPv4 (address family of AF\_INET), an application receives the IP header at the front of each received datagram regardless of the **IP\_HDRINCL** socket option.</span></span>
-   <span data-ttu-id="37f32-157">Для IPv6 (семейство адресов AF \_ INET6) приложение получает все после последнего заголовка IPv6 в каждой полученной датаграмме независимо от параметра сокета **IPv6 \_ хдринкл** .</span><span class="sxs-lookup"><span data-stu-id="37f32-157">For IPv6 (address family of AF\_INET6), an application receives everything after the last IPv6 header in each received datagram regardless of the **IPV6\_HDRINCL** socket option.</span></span> <span data-ttu-id="37f32-158">Приложение не получает заголовки IPv6, используя необработанный сокет.</span><span class="sxs-lookup"><span data-stu-id="37f32-158">The application does not receive any IPv6 headers using a raw socket.</span></span>
-   <span data-ttu-id="37f32-159">Полученные датаграммы копируются во все **\_ необработанные** сокеты Сокк, которые отвечают следующим условиям:</span><span class="sxs-lookup"><span data-stu-id="37f32-159">Received datagrams are copied into all **SOCK\_RAW** sockets that satisfy the following conditions:</span></span>

    -   <span data-ttu-id="37f32-160">Номер протокола, указанный в параметре *протокола* при создании сокета, должен соответствовать номеру протокола в IP-заголовке полученной датаграммы.</span><span class="sxs-lookup"><span data-stu-id="37f32-160">The protocol number specified in the *protocol* parameter when the socket was created should match the protocol number in the IP header of the received datagram.</span></span>
    -   <span data-ttu-id="37f32-161">Если для сокета определен локальный IP-адрес, он должен соответствовать адресу назначения, указанному в заголовке IP полученной датаграммы.</span><span class="sxs-lookup"><span data-stu-id="37f32-161">If a local IP address is defined for the socket, it should correspond to the destination address as specified in the IP header of the received datagram.</span></span> <span data-ttu-id="37f32-162">Приложение может указать локальный IP-адрес, вызвав функцию [**BIND**](/windows/desktop/api/winsock/nf-winsock-bind) .</span><span class="sxs-lookup"><span data-stu-id="37f32-162">An application may specify the local IP address by calling the [**bind**](/windows/desktop/api/winsock/nf-winsock-bind) function.</span></span> <span data-ttu-id="37f32-163">Если для сокета не указан локальный IP-адрес, датаграммы копируются в сокет независимо от IP-адреса назначения в IP-заголовке полученной датаграммы.</span><span class="sxs-lookup"><span data-stu-id="37f32-163">If no local IP address is specified for the socket, the datagrams are copied into the socket regardless of the destination IP address in the IP header of the received datagram.</span></span>
    -   <span data-ttu-id="37f32-164">Если для сокета определен внешний адрес, он должен соответствовать адресу источника, указанному в заголовке IP полученной датаграммы.</span><span class="sxs-lookup"><span data-stu-id="37f32-164">If a foreign address is defined for the socket, it should correspond to the source address as specified in the IP header of the received datagram.</span></span> <span data-ttu-id="37f32-165">Приложение может указать внешний IP-адрес, вызвав функцию [**Connect**](/windows/desktop/api/Winsock2/nf-winsock2-connect) или [**всаконнект**](/windows/desktop/api/Winsock2/nf-winsock2-wsaconnect) .</span><span class="sxs-lookup"><span data-stu-id="37f32-165">An application may specify the foreign IP address by calling the [**connect**](/windows/desktop/api/Winsock2/nf-winsock2-connect) or [**WSAConnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsaconnect) function.</span></span> <span data-ttu-id="37f32-166">Если для сокета не указан внешний IP-адрес, датаграммы копируются в сокет независимо от IP-адреса источника в IP-заголовке полученной датаграммы.</span><span class="sxs-lookup"><span data-stu-id="37f32-166">If no foreign IP address is specified for the socket, the datagrams are copied into the socket regardless of the source IP address in the IP header of the received datagram.</span></span>

<span data-ttu-id="37f32-167">Важно понимать, что некоторые сокеты типа **Сокк \_ RAW** могут принимать много непредусмотренных датаграмм.</span><span class="sxs-lookup"><span data-stu-id="37f32-167">It is important to understand that some sockets of type **SOCK\_RAW** may receive many unexpected datagrams.</span></span> <span data-ttu-id="37f32-168">Например, программа PING может создать сокет типа **Сокк \_ RAW** для отправки эхо-запросов ICMP и получения ответов.</span><span class="sxs-lookup"><span data-stu-id="37f32-168">For example, a PING program may create a socket of type **SOCK\_RAW** to send ICMP echo requests and receive responses.</span></span> <span data-ttu-id="37f32-169">Хотя приложение ожидает ответа ICMP, все остальные ICMP-сообщения (такие как узел ICMP, \_ НЕдоступные) также могут доставляться в это приложение.</span><span class="sxs-lookup"><span data-stu-id="37f32-169">While the application is expecting ICMP echo responses, all other ICMP messages (such as ICMP HOST\_UNREACHABLE) may also be delivered to this application.</span></span> <span data-ttu-id="37f32-170">Кроме того, если **несколько \_ необработанных** сокетов Сокк открыты на компьютере одновременно, одни и те же датаграммы могут быть доставлены всем открытым сокетам.</span><span class="sxs-lookup"><span data-stu-id="37f32-170">Moreover, if several **SOCK\_RAW** sockets are open on a computer at the same time, the same datagrams may be delivered to all the open sockets.</span></span> <span data-ttu-id="37f32-171">Приложение должно иметь механизм для распознавания интересующих датаграмм и пропускать все остальные.</span><span class="sxs-lookup"><span data-stu-id="37f32-171">An application must have a mechanism to recognize the datagrams of interest and to ignore all others.</span></span> <span data-ttu-id="37f32-172">Для программы PING такой механизм может включать проверку IP-заголовка Received для уникальных идентификаторов в заголовке ICMP (например, идентификатор процесса приложения).</span><span class="sxs-lookup"><span data-stu-id="37f32-172">For a PING program, such a mechanism might include inspecting the received IP header for unique identifiers in the ICMP header (the application's process ID, for example).</span></span>

> [!Note]  
> <span data-ttu-id="37f32-173">Для использования сокета типа **Сокк \_ RAW** требуются права администратора.</span><span class="sxs-lookup"><span data-stu-id="37f32-173">To use a socket of type **SOCK\_RAW** requires administrative privileges.</span></span> <span data-ttu-id="37f32-174">Пользователи, запускающие приложения Winsock, использующие необработанные сокеты, должны быть членами группы "Администраторы" на локальном компьютере, в противном случае вызовы необработанных сокетов завершатся ошибкой с кодом [всаеакцес](windows-sockets-error-codes-2.md).</span><span class="sxs-lookup"><span data-stu-id="37f32-174">Users running Winsock applications that use raw sockets must be a member of the Administrators group on the local computer, otherwise raw socket calls will fail with an error code of [WSAEACCES](windows-sockets-error-codes-2.md).</span></span> <span data-ttu-id="37f32-175">В Windows Vista и более поздних версиях доступ к необработанным сокетам применяется при создании сокета.</span><span class="sxs-lookup"><span data-stu-id="37f32-175">On Windows Vista and later, access for raw sockets is enforced at socket creation.</span></span> <span data-ttu-id="37f32-176">В более ранних версиях Windows доступ к необработанным сокетам применяется во время других операций сокета.</span><span class="sxs-lookup"><span data-stu-id="37f32-176">In earlier versions of Windows, access for raw sockets is enforced during other socket operations.</span></span>

 

## <a name="common-uses-of-raw-sockets"></a><span data-ttu-id="37f32-177">Распространенные способы использования необработанных сокетов</span><span class="sxs-lookup"><span data-stu-id="37f32-177">Common Uses of Raw Sockets</span></span>

<span data-ttu-id="37f32-178">Одним из распространенных способов использования необработанных сокетов являются приложения для устранения неполадок, требующие подробного анализа пакетов и заголовков IP.</span><span class="sxs-lookup"><span data-stu-id="37f32-178">One common use of raw sockets are troubleshooting applications that need to examine IP packets and headers in detail.</span></span> <span data-ttu-id="37f32-179">Например, необработанный сокет можно использовать с SIO \_ РКВАЛЛ ioctl, чтобы обеспечить получение сокетом всех пакетов IPv4 или IPv6, передаваемых через сетевой интерфейс.</span><span class="sxs-lookup"><span data-stu-id="37f32-179">For example, a raw socket can be used with the SIO\_RCVALL IOCTL to enable a socket to receive all IPv4 or IPv6 packets passing through a network interface.</span></span> <span data-ttu-id="37f32-180">Дополнительные сведения см. в справочнике по [**SIO \_ рквалл**](/previous-versions/windows/desktop/legacy/ee309610(v=vs.85)) .</span><span class="sxs-lookup"><span data-stu-id="37f32-180">For more information, see the [**SIO\_RCVALL**](/previous-versions/windows/desktop/legacy/ee309610(v=vs.85)) reference.</span></span>

## <a name="limitations-on-raw-sockets"></a><span data-ttu-id="37f32-181">Ограничения для необработанных сокетов</span><span class="sxs-lookup"><span data-stu-id="37f32-181">Limitations on Raw Sockets</span></span>

<span data-ttu-id="37f32-182">В Windows 7, Windows Vista, Windows XP с пакетом обновления 2 (SP2) и Windows XP с пакетом обновления 3 (SP3) возможность отправки трафика через необработанные сокеты ограничена несколькими способами:</span><span class="sxs-lookup"><span data-stu-id="37f32-182">On Windows 7, Windows Vista, Windows XP with Service Pack 2 (SP2), and Windows XP with Service Pack 3 (SP3), the ability to send traffic over raw sockets has been restricted in several ways:</span></span>

-   <span data-ttu-id="37f32-183">Данные TCP не могут быть отправлены через необработанные сокеты.</span><span class="sxs-lookup"><span data-stu-id="37f32-183">TCP data cannot be sent over raw sockets.</span></span>
-   <span data-ttu-id="37f32-184">UDP-датаграммы с недопустимым исходным адресом не могут быть отправлены через необработанные сокеты.</span><span class="sxs-lookup"><span data-stu-id="37f32-184">UDP datagrams with an invalid source address cannot be sent over raw sockets.</span></span> <span data-ttu-id="37f32-185">IP-адрес источника для любой исходящей датаграммы UDP должен существовать в сетевом интерфейсе, или датаграмма удалена.</span><span class="sxs-lookup"><span data-stu-id="37f32-185">The IP source address for any outgoing UDP datagram must exist on a network interface or the datagram is dropped.</span></span> <span data-ttu-id="37f32-186">Это изменение было сделано, чтобы ограничить способность вредоносного кода создавать распределенные атаки типа "отказ в обслуживании" и ограничивает возможность отправки ложных пакетов (пакетов TCP/IP с подложным исходным IP-адресом).</span><span class="sxs-lookup"><span data-stu-id="37f32-186">This change was made to limit the ability of malicious code to create distributed denial-of-service attacks and limits the ability to send spoofed packets (TCP/IP packets with a forged source IP address).</span></span>
-   <span data-ttu-id="37f32-187">Вызов функции [**BIND**](/windows/desktop/api/winsock/nf-winsock-bind) с необработанным сокетом для \_ протокола TCP иппрото не разрешен.</span><span class="sxs-lookup"><span data-stu-id="37f32-187">A call to the [**bind**](/windows/desktop/api/winsock/nf-winsock-bind) function with a raw socket for the IPPROTO\_TCP protocol is not allowed.</span></span>
    > [!Note]  
    > <span data-ttu-id="37f32-188">Функция [**BIND**](/windows/desktop/api/winsock/nf-winsock-bind) с необработанным сокетом разрешена для других протоколов ( \_ например, ИППРОТО IP, ИППРОТО \_ UDP или иппрото \_ SCTP).</span><span class="sxs-lookup"><span data-stu-id="37f32-188">The [**bind**](/windows/desktop/api/winsock/nf-winsock-bind) function with a raw socket is allowed for other protocols (IPPROTO\_IP, IPPROTO\_UDP, or IPPROTO\_SCTP, for example).</span></span>

     

<span data-ttu-id="37f32-189">Указанные выше ограничения не относятся к Windows Server 2008 R2, Windows Server 2008, Windows Server 2003 или к версиям операционной системы, предшествующим Windows XP с пакетом обновления 2 (SP2).</span><span class="sxs-lookup"><span data-stu-id="37f32-189">These above restrictions do not apply to Windows Server 2008 R2, Windows Server 2008 , Windows Server 2003, or to versions of the operating system earlier than Windows XP with SP2.</span></span>

> [!Note]  
> <span data-ttu-id="37f32-190">Реализация TCP/IP в корпорации Майкрософт в Windows может открыть необработанный сокет UDP или TCP на основе указанных выше ограничений.</span><span class="sxs-lookup"><span data-stu-id="37f32-190">The Microsoft implementation of TCP/IP on Windows is capable of opening a raw UDP or TCP socket based on the above restrictions.</span></span> <span data-ttu-id="37f32-191">Другие поставщики Winsock могут не поддерживать использование необработанных сокетов.</span><span class="sxs-lookup"><span data-stu-id="37f32-191">Other Winsock providers may not support the use of raw sockets.</span></span>

 

<span data-ttu-id="37f32-192">Существуют дополнительные ограничения для приложений, использующих сокет типа **Сокк \_ RAW**.</span><span class="sxs-lookup"><span data-stu-id="37f32-192">There are further limitations for applications that use a socket of type **SOCK\_RAW**.</span></span> <span data-ttu-id="37f32-193">Например, все приложения, прослушивающие конкретный протокол, получат все пакеты, полученные для этого протокола.</span><span class="sxs-lookup"><span data-stu-id="37f32-193">For example, all applications listening for a specific protocol will receive all packets received for this protocol.</span></span> <span data-ttu-id="37f32-194">Это может быть нежелательным для нескольких приложений, использующих протокол.</span><span class="sxs-lookup"><span data-stu-id="37f32-194">This may not be what is desired for multiple applications using a protocol.</span></span> <span data-ttu-id="37f32-195">Это также не подходит для высокопроизводительных приложений.</span><span class="sxs-lookup"><span data-stu-id="37f32-195">This is also not suitable for high-performance applications.</span></span> <span data-ttu-id="37f32-196">Чтобы избежать этих проблем, может потребоваться создать драйвер сетевого протокола Windows (драйвер устройства) для конкретного сетевого протокола.</span><span class="sxs-lookup"><span data-stu-id="37f32-196">To get around these issues, it may be required to write a Windows network protocol driver (device driver) for the specific network protocol.</span></span> <span data-ttu-id="37f32-197">В Windows Vista и более поздних версиях для записи драйвера сетевого протокола можно использовать новый интерфейс сетевого программирования, не зависящий от транспорта (WSK).</span><span class="sxs-lookup"><span data-stu-id="37f32-197">On Windows Vista and later, Winsock Kernel (WSK), a new transport-independent kernel mode Network Programming Interface can be used to write a network protocol driver.</span></span> <span data-ttu-id="37f32-198">В Windows Server 2003 и более ранних версиях для поддержки сетевого протокола можно написать поставщик TDI (TDI) и библиотеку DLL модуля поддержки Winsock.</span><span class="sxs-lookup"><span data-stu-id="37f32-198">On Windows Server 2003 and earlier, a Transport Driver Interface (TDI) provider and a Winsock helper DLL can be written to support the network protocol.</span></span> <span data-ttu-id="37f32-199">Затем сетевой протокол будет добавлен в каталог Winsock как поддерживаемый протокол.</span><span class="sxs-lookup"><span data-stu-id="37f32-199">The network protocol would then be added to the Winsock catalog as a supported protocol.</span></span> <span data-ttu-id="37f32-200">Это позволяет нескольким приложениям открывать сокеты для этого конкретного протокола, и драйвер устройства может контролировать, какой сокет получает определенные пакеты и ошибки.</span><span class="sxs-lookup"><span data-stu-id="37f32-200">This allows multiple applications to open sockets for this specific protocol and the device driver can keep track of which socket receives specific packets and errors.</span></span> <span data-ttu-id="37f32-201">Сведения о создании поставщика сетевых протоколов см. в разделах WSK и TDI в комплекте драйверов Windows (WDK).</span><span class="sxs-lookup"><span data-stu-id="37f32-201">For information on writing a network protocol provider, see the sections on WSK and TDI in the Windows Driver Kit (WDK).</span></span>

<span data-ttu-id="37f32-202">Приложениям также необходимо учитывать влияние параметров брандмауэра на отправку и получение пакетов с помощью необработанных сокетов.</span><span class="sxs-lookup"><span data-stu-id="37f32-202">Applications also need to be aware of the impact that firewall settings may have on sending and receiving packets using raw sockets.</span></span>

 

 
