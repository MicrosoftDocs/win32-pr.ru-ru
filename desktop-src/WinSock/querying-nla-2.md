---
description: Чтобы получать уведомления о недействительных логических сетях, используйте функцию Всанспиоктл для регистрации событий изменения сетевого расположения.
ms.assetid: 531b6269-5f35-44c1-ad0f-c5f103029893
title: Запрос NLA
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0ac7a4f57e14bb967b04d3a9fd6fe66717da3878
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105702103"
---
# <a name="querying-nla"></a>Запрос NLA

Чтобы получать уведомления о недействительных логических сетях, используйте функцию [**всанспиоктл**](/windows/desktop/api/Winsock2/nf-winsock2-wsanspioctl) для регистрации событий изменения сетевого расположения. Можно использовать два метода, чтобы определить, стало ли ранее допустимое сетевое расположение недопустимым: методы опроса или уведомление с помощью перекрывающихся операций ввода-вывода или обмена сообщениями Windows.

Запросы формируются с помощью функций [**всалукупсервицебегин**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicebegina), [**всалукупсервиценекст**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicenexta) и [**всалукупсервицеенд**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupserviceend) для перечисления всех доступных логических сетей. Использование каждой из этих функций объясняется по отдельности в оставшейся части этого раздела, начиная с функции **всалукупсервицебегин** .

> [!Note]  
> NLA требует файл заголовка Мсвсокк. h, который по умолчанию не включен в файл Winsock2. h.

 

## <a name="step-1-initiate-the-query"></a>Шаг 1. Инициация запроса

Для краткого справочника функция [**всалукупсервицебегин**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicebegina) имеет следующий синтаксис:

``` syntax
INT WSALookupServiceBegin(
  LPWSAQUERYSET lpqsRestrictions,
  DWORD dwControlFlags,
  LPHANDLE lphLookup
);
```

NLA поддерживает следующие флаги поиска *двконтролфлагс* :

<dl> \_имя возврата \_ Луп  
\_Комментарий возврата \_ Луп  
\_возвращаемый \_ BLOB-объект Луп  
ЛУП \_ возвратить \_ все  
ЛУП \_  
</dl>

Эти флаги ограничивают результирующие наборы, возвращаемые при последующих вызовах функции [**всалукупсервиценекст**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicenexta), к сетям, содержащим поля указанного типа. Например, указание ЛУП \_ возвращаемого \_ большого двоичного объекта в параметре *Двконтролфлагс* вызова функции [**всалукупсервицебегин**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicebegina) позволяет ограничивать результирующие наборы от последующих вызовов **всалукупсервиценекст** до сетей, содержащих данные большого двоичного объекта. Использование \_ \_ флага возврата ALL Луп эквивалентно указанию \_ возвращаемого \_ имени Луп, ЛУП \_ return \_ комментария и Луп \_ возвращают \_ большой двоичный объект, но не Луп \_ .

Описание этих флагов поиска см. на странице справки по функциям [**всалукупсервицебегин**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicebegina) .

Маркер поиска, возвращенный NLA в параметре *лфлукуп* , является частным для NLA и не должен изменяться. Так как возвращенный маркер является частным для NLA, такие функции, как [**всажетоверлаппедресулт**](/windows/desktop/api/Winsock2/nf-winsock2-wsagetoverlappedresult) , недоступны.

NLA возвращает ноль после успешного завершения, как определено на странице справочника по функциям [**всалукупсервицебегин**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicebegina) . В противном случае NLA поддерживает следующие коды ошибок.

| Ошибка                    | Значение                                                                                                                                                     |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| WSANOTINITIALISED        | Успешный вызов функции [**сбой WSAStartup**](/windows/desktop/api/winsock/nf-winsock-wsastartup) для инициализации NLA не выполнялся.                                                   |
| всаеинвал                | Один или несколько параметров являются недопустимыми, или параметры, указанные в вызове функции, применяются к протоколам, отличным от IP.                                         |
| ВСАСЕРВИЦЕ \_ не \_ найден   | Параметр *лпсервицеклассид* структуры [**всакуерисет**](/windows/desktop/api/Winsock2/ns-winsock2-wsaquerysetw) , переданный в параметре *лпксрестриктионс* , содержит недопустимый GUID. |
| \_данные всано              | \_Флаг контейнеров Луп был указан в параметре *двконтролфлагс* .                                                                                       |
| WSAEFAULT                | Нарушение прав доступа при попытке доступа к параметрам, предоставляемым пользователем.                                                                            |
| всасиснотреади           | Служба NLA недоступна для обработки запроса.                                                                                                      |
| WSA \_ не \_ хватает \_ памяти | NLA или службе NLA не удалось выделить достаточно памяти для обработки этого запроса.                                                                        |



 

## <a name="step-2-perform-the-query"></a>Шаг 2. выполнение запроса

Для следующего шага при запросе NLA необходимо использовать функцию [**всалукупсервиценекст**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicenexta) . Для краткого справочника функция **всалукупсервиценекст** имеет следующий синтаксис:

``` syntax
INT WSALookupServiceNext(
  HANDLE hLookup,
  DWORD dwControlFlags,
  LPDWORD lpdwBufferLength,
  LPWSAQUERYSET lpqsResults
);
```

Параметр *ллукуп* — это маркер уточняющего запроса, возвращенный из предыдущего вызова функции [**всалукупсервицебегин**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicebegina) .

Параметр *двконтролфлагс* поддерживает следующие флаги:

<dl> \_имя возврата \_ Луп  
\_Комментарий возврата \_ Луп  
\_возвращаемый \_ BLOB-объект Луп  
ЛУП \_ возвратить \_ все  
ЛУП \_ флушпревиаус  
</dl>

Эти флаги не зависят от флагов, поддерживаемых в вызове функции [**всалукупсервицебегин**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicebegina) . Обратите внимание, что все ограничения, указанные в предыдущем вызове функции **всалукупсервицебегин** , ограничивают Уточняющий запрос. Добавление флагов с помощью функции [**всалукупсервиценекст**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicenexta) в попытке расширить запрос за пределами ограничений, заданных в вызове **всалукупсервицебегин** , не пропускается автоматически. Однако при указании более неопределенного набора флагов, указанного в вызове **всалукупсервицебегин** , допускается.

Если сеть, описанная в *лпксресултс* , является активной сетью, к ней добавляется ряд структур **\_ больших двоичных объектов NLA** , как указано в **лпблоб** элемента структуры [**всакуерисет**](/windows/desktop/api/Winsock2/ns-winsock2-wsaquerysetw) , возвращенной в *лпксресултс*. Эти **структуры \_ больших двоичных объектов NLA** могут быть объединены в цепочку, и их можно перечислить путем прохода по списку, в то время как NLA \_ BLOB. Header. некстоффсет не равно нулю. Чтобы получить результаты для всех сведений о сетевом расположении, продолжайте вызывать [**всалукупсервиценекст**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicenexta)до тех пор, пока \_ \_ не \_ будет возвращена ошибка WSA E, как описано на справочной странице **всалукупсервиценекст**.

Функция [**всалукупсервиценекст**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicenexta) также используется вместе с функцией [**всанспиоктл**](/windows/desktop/api/Winsock2/nf-winsock2-wsanspioctl) для получения уведомлений об изменениях в сети. Дополнительные сведения см. [в разделе уведомление от NLA](notification-from-nla-2.md) .

NLA возвращает ноль после успешного завершения. Клиенты NLA должны продолжать вызывать [**всалукупсервиценекст**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicenexta), вызывая функцию до тех пор, пока \_ \_ не \_ вернется WSA E, что означает, что возвращаются все сведения о доступных сетях.

В противном случае вызов функции [**всалукупсервиценекст**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicenexta), функция для NLA, поддерживает следующие коды ошибок.

| Ошибка                    | Значение                                                                                                                                                                                                                                                                                                                                                                                                     |
|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| WSANOTINITIALISED        | Успешный вызов функции [**сбой WSAStartup**](/windows/desktop/api/winsock/nf-winsock-wsastartup) , инициализированной NLA, не выполнялся.                                                                                                                                                                                                                                                                                                |
| \_Недопустимый \_ маркер WSA     | Маркер поиска, указанный в параметре *ГПР* , не является допустимым обработчиком SP NLA. Чтобы получить результаты запроса, клиенты должны сначала вызвать функцию [**всалукупсервицебегин**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicebegina) и получить допустимый обработчик SP NLA.                                                                                                                                                               |
| всаесиснотреади          | Служба NLA недоступна для обработки этого запроса.                                                                                                                                                                                                                                                                                                                                                     |
| WSAEFAULT                | Размер буфера, указанный в параметре *лпдвбуфферленгс* , недостаточно для хранения результатов, на которые указывает *лпксресултс*. Требуемый буфер указан в *лпдвбуфферленгс*; Если клиент не может предоставить достаточно большой буфер, клиент может вызвать функцию [**всалукупсервиценекст**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupservicenexta) с параметром *двконтролфлагс* , для которого задано значение Луп \_ флушпревиаус, чтобы пропустить запись. |
| WSA \_ не \_ хватает \_ памяти | NLA не удалось получить сетевую информацию от системной службы NLA из-за нехватки памяти в вызывающем процессе.                                                                                                                                                                                                                                                                                  |
| WSA \_ E \_ больше \_         | Нет дополнительных сетей для перечисления для запроса.                                                                                                                                                                                                                                                                                                                                                |



 

## <a name="step-3-terminate-the-query"></a>Шаг 3. завершение запроса

Когда все запросы к NLA завершены и приложению больше не требуется использовать NLA, следует выполнить вызов функции [**всалукупсервицеенд**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupserviceend) . Не вызывайте **всалукупсервицеенд** , если приложение получит уведомление об изменении на основе отправленного запроса. Дополнительные сведения о получении уведомления см. в разделе [уведомление от NLA](notification-from-nla-2.md) . Как и большинство поставщиков услуг сокетов Windows, NLA поддерживает подсчет ссылок для своих клиентов. Вызов функции **всалукупсервицеенд** при завершении запросов NLA позволяет освободить системные ресурсы, которые больше не требуются для освобождения NLA.

NLA поддерживает следующие коды ошибок для вызовов функций [**всалукупсервицеенд**](/windows/desktop/api/Winsock2/nf-winsock2-wsalookupserviceend) .

| Ошибка                | Значение                                                                                                   |
|----------------------|-----------------------------------------------------------------------------------------------------------|
| WSANOTINITIALISED    | Успешный вызов функции [**сбой WSAStartup**](/windows/desktop/api/winsock/nf-winsock-wsastartup) для инициализации NLA не выполнялся. |
| \_Недопустимый \_ маркер WSA | Маркер, указанный в параметре *ГПР* , не является допустимым обработчиком SP NLA.                             |



 

 

 



