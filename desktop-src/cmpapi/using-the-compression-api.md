---
description: Многие приложения должны использовать сжатие и распаковку данных без потерь. API сжатия упрощает это, предоставляя алгоритмы сжатия Windows через общедоступный API.
ms.assetid: D603A7DE-D4A1-4515-9702-B03C81504661
title: Использование API сжатия
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 01eff163f4ea1ccf03e1cd4ac9cb16a26afeb265
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104142397"
---
# <a name="using-the-compression-api"></a><span data-ttu-id="e5f0a-104">Использование API сжатия</span><span class="sxs-lookup"><span data-stu-id="e5f0a-104">Using the Compression API</span></span>

<span data-ttu-id="e5f0a-105">Многие приложения должны использовать сжатие и распаковку данных без потерь.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-105">Many applications need to use lossless data compression and decompression.</span></span> <span data-ttu-id="e5f0a-106">API сжатия упрощает это, предоставляя алгоритмы сжатия Windows через общедоступный API.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-106">The Compression API simplifies this by exposing Windows compression algorithms through a public API.</span></span> <span data-ttu-id="e5f0a-107">Каждый алгоритм сжатия имеет набор свойств, управляющих его поведением.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-107">Each compression algorithm has a set of properties that controls its behavior.</span></span> <span data-ttu-id="e5f0a-108">API сжатия предоставляет интерфейс, который позволяет разработчику задавать значения этих свойств или запрашивать их.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-108">The Compression API exposes an interface that enables the developer to set or query the values of these properties.</span></span> <span data-ttu-id="e5f0a-109">Все свойства поддерживаемых алгоритмов сжатия имеют значения по умолчанию, представляющие часто используемые значения этих свойств.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-109">All properties for the supported compression algorithms have default values representing commonly used values of these properties.</span></span> <span data-ttu-id="e5f0a-110">Если для сжатия и распаковки требуется свойство, значения по умолчанию будут идентичны, что гарантирует использование одинаковых значений для сжатия и распаковки.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-110">If a property is required for both compression and decompression, the default values will be identical, ensuring identical values are used for compression and decompression.</span></span>

## <a name="selecting-the-compression-algorithm"></a><span data-ttu-id="e5f0a-111">Выбор алгоритма сжатия</span><span class="sxs-lookup"><span data-stu-id="e5f0a-111">Selecting the compression algorithm</span></span>

<span data-ttu-id="e5f0a-112">После того как разработчик решит, что приложению необходимо сжать или распаковать данные, следует выбрать алгоритм сжатия.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-112">After a developer decides that an application needs to compress or decompress data, the next step is to choose a compression algorithm.</span></span> <span data-ttu-id="e5f0a-113">Это может зависеть от тестов, чтобы найти оптимальное сочетание скорости, коэффициента сжатия и требований к памяти для конкретного приложения.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-113">This may depend upon tests to find the best performing combination of speed, compression ratio, and memory requirement for a particular application.</span></span> <span data-ttu-id="e5f0a-114">В следующем списке приводятся относительные сравнения алгоритмов сжатия, которые в настоящее время поддерживаются API сжатия.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-114">The following list gives a relative comparison of the compression algorithms currently supported by the Compression API.</span></span> <span data-ttu-id="e5f0a-115">Не все параметры доступны для каждого алгоритма сжатия, и сравнение является приблизительным, поскольку производительность может зависеть от входных данных.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-115">Not every option is available for every compression algorithm, and the comparison is approximate because performance can depend on the input data.</span></span>

<span data-ttu-id="e5f0a-116">XPRESS (**Сжатие \_ алгоритма \_ Xpress**)</span><span class="sxs-lookup"><span data-stu-id="e5f0a-116">XPRESS (**COMPRESS\_ALGORITHM\_XPRESS**)</span></span>

-   <span data-ttu-id="e5f0a-117">Очень быстро с низкими требованиями к ресурсам</span><span class="sxs-lookup"><span data-stu-id="e5f0a-117">Very fast with low resource requirements</span></span>
-   <span data-ttu-id="e5f0a-118">Отношение среднего сжатия</span><span class="sxs-lookup"><span data-stu-id="e5f0a-118">Medium compression ratio</span></span>
-   <span data-ttu-id="e5f0a-119">Высокая скорость сжатия и распаковки</span><span class="sxs-lookup"><span data-stu-id="e5f0a-119">High compression and decompression speeds</span></span>
-   <span data-ttu-id="e5f0a-120">Требования к нехватке памяти</span><span class="sxs-lookup"><span data-stu-id="e5f0a-120">Low memory requirement</span></span>
-   <span data-ttu-id="e5f0a-121">Поддерживает параметр **\_ \_ \_ уровня класса "сжимать сведения** ", доступный в перечислении [**\_ \_ класса сведений о сжатии**](/windows/desktop/api/compressapi/ne-compressapi-compress_information_class) .</span><span class="sxs-lookup"><span data-stu-id="e5f0a-121">Supports the **COMPRESS\_INFORMATION\_CLASS\_LEVEL** option available in the [**COMPRESS\_INFORMATION\_CLASS**](/windows/desktop/api/compressapi/ne-compressapi-compress_information_class) enumeration.</span></span> <span data-ttu-id="e5f0a-122">Значение по умолчанию — **(DWORD) 0**.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-122">The default value is **(DWORD)0**.</span></span> <span data-ttu-id="e5f0a-123">Для некоторых данных значение **(DWORD) 1** может улучшить коэффициент сжатия с немного низкой скоростью сжатия.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-123">For some data, the value **(DWORD)1** can improve the compression ratio with a slightly slower compression speed.</span></span>

<span data-ttu-id="e5f0a-124">XPRESS с кодировкой Хаффмана (**Сжатие \_ алгоритма \_ Xpress \_ Хаффа**)</span><span class="sxs-lookup"><span data-stu-id="e5f0a-124">XPRESS with Huffman encoding (**COMPRESS\_ALGORITHM\_XPRESS\_HUFF**)</span></span>

-   <span data-ttu-id="e5f0a-125">Коэффициент сжатия выше, чем **Сжатие \_ алгоритма \_ Xpress**</span><span class="sxs-lookup"><span data-stu-id="e5f0a-125">Compression ratio is higher than **COMPRESS\_ALGORITHM\_XPRESS**</span></span>
-   <span data-ttu-id="e5f0a-126">Отношение среднего сжатия</span><span class="sxs-lookup"><span data-stu-id="e5f0a-126">Medium compression ratio</span></span>
-   <span data-ttu-id="e5f0a-127">Средние и высокие скорости сжатия и распаковки</span><span class="sxs-lookup"><span data-stu-id="e5f0a-127">Medium to high compression and decompression speeds</span></span>
-   <span data-ttu-id="e5f0a-128">Требования к нехватке памяти</span><span class="sxs-lookup"><span data-stu-id="e5f0a-128">Low memory requirement</span></span>
-   <span data-ttu-id="e5f0a-129">Поддерживает параметр **\_ \_ \_ уровня класса сжимать сведения** в перечислении [**\_ \_ класса сведений о сжатии**](/windows/desktop/api/compressapi/ne-compressapi-compress_information_class) .</span><span class="sxs-lookup"><span data-stu-id="e5f0a-129">Supports the **COMPRESS\_INFORMATION\_CLASS\_LEVEL** option in the [**COMPRESS\_INFORMATION\_CLASS**](/windows/desktop/api/compressapi/ne-compressapi-compress_information_class) enumeration.</span></span> <span data-ttu-id="e5f0a-130">Значение по умолчанию — **(DWORD) 0**.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-130">The default value is **(DWORD)0**.</span></span> <span data-ttu-id="e5f0a-131">Для некоторых данных значение **(DWORD) 1** может улучшить коэффициент сжатия с немного низкой скоростью сжатия.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-131">For some data, the value **(DWORD)1** can improve the compression ratio with a slightly slower compression speed.</span></span>

<span data-ttu-id="e5f0a-132">MSZIP (**Сжатие \_ алгоритма \_ MSZIP**)</span><span class="sxs-lookup"><span data-stu-id="e5f0a-132">MSZIP (**COMPRESS\_ALGORITHM\_MSZIP**)</span></span>

-   <span data-ttu-id="e5f0a-133">Использует больше ресурсов, чем **Сжатие \_ алгоритма \_ Xpress \_ Хаффа**</span><span class="sxs-lookup"><span data-stu-id="e5f0a-133">Uses more resources than **COMPRESS\_ALGORITHM\_XPRESS\_HUFF**</span></span>
-   <span data-ttu-id="e5f0a-134">Создает сжатый блок, аналогичный стандарту RFC 1951.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-134">Generates a compressed block similar to RFC 1951.</span></span>
-   <span data-ttu-id="e5f0a-135">Отношение среднего и высокого сжатия</span><span class="sxs-lookup"><span data-stu-id="e5f0a-135">Medium to high compression ratio</span></span>
-   <span data-ttu-id="e5f0a-136">Средняя скорость сжатия и высокая скорость распаковки</span><span class="sxs-lookup"><span data-stu-id="e5f0a-136">Medium compression speed and high decompression speed</span></span>
-   <span data-ttu-id="e5f0a-137">Требования к среднему объему памяти</span><span class="sxs-lookup"><span data-stu-id="e5f0a-137">Medium memory requirement</span></span>

<span data-ttu-id="e5f0a-138">ЛЗМС (**Сжатие \_ алгоритма \_ лзмс**)</span><span class="sxs-lookup"><span data-stu-id="e5f0a-138">LZMS (**COMPRESS\_ALGORITHM\_LZMS**)</span></span>

-   <span data-ttu-id="e5f0a-139">Хороший алгоритм, если размер данных для сжатия превышает 2 МБ.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-139">Good algorithm if the size of the data to be compressed is over 2MB.</span></span>
-   <span data-ttu-id="e5f0a-140">Коэффициент высокой степени сжатия</span><span class="sxs-lookup"><span data-stu-id="e5f0a-140">High compression ratio</span></span>
-   <span data-ttu-id="e5f0a-141">Низкая скорость сжатия и высокая скорость распаковки</span><span class="sxs-lookup"><span data-stu-id="e5f0a-141">Low compression speed and high decompression speed</span></span>
-   <span data-ttu-id="e5f0a-142">От среднего до высокого требования к памяти</span><span class="sxs-lookup"><span data-stu-id="e5f0a-142">Medium to high memory requirement</span></span>
-   <span data-ttu-id="e5f0a-143">Поддерживает параметр **сжатия \_ \_ блока данных \_ класса \_ Information** в перечислении [**\_ \_ класса сведений о сжатии**](/windows/desktop/api/compressapi/ne-compressapi-compress_information_class) .</span><span class="sxs-lookup"><span data-stu-id="e5f0a-143">Supports the **COMPRESS\_INFORMATION\_CLASS\_BLOCK\_SIZE** option in the [**COMPRESS\_INFORMATION\_CLASS**](/windows/desktop/api/compressapi/ne-compressapi-compress_information_class) enumeration.</span></span> <span data-ttu-id="e5f0a-144">Для повышения степени сжатия предлагается минимальный размер в 1 МБ.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-144">A minimum size of 1 MB is suggested to get a better compression ratio.</span></span>

## <a name="deciding-which-compression-api-mode-to-use"></a><span data-ttu-id="e5f0a-145">Выбор режима использования API сжатия</span><span class="sxs-lookup"><span data-stu-id="e5f0a-145">Deciding which Compression API mode to use</span></span>

<span data-ttu-id="e5f0a-146">Когда разработчик выбирает алгоритм сжатия, следующим решением будет выбор из двух режимов использования API сжатия: режим буфера или блочный режим.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-146">After a developer selects the compression algorithm, the next decision is which of the two modes of the Compression API to use: buffer mode or block mode.</span></span> <span data-ttu-id="e5f0a-147">Режим буфера был разработан для простоты использования и рекомендуется в большинстве случаев.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-147">Buffer mode was developed for ease of use and is recommended for most cases.</span></span>

<span data-ttu-id="e5f0a-148">Режим буфера автоматически разделяет входной буфер на блоки размера, который подходит для выбранного алгоритма сжатия.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-148">Buffer mode automatically splits up the input buffer into blocks of a size that is appropriate for the selected compression algorithm.</span></span> <span data-ttu-id="e5f0a-149">Режим буфера автоматически форматирует и сохраняет несжатый размер буфера в сжатом буфере.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-149">The buffer mode automatically formats and stores the uncompressed buffer size in the compressed buffer.</span></span> <span data-ttu-id="e5f0a-150">Размер сжатого буфера не сохраняется автоматически, и приложению необходимо сохранить его для распаковки.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-150">The size of the compressed buffer is not automatically saved, and the application needs to save this for decompression.</span></span> <span data-ttu-id="e5f0a-151">Не включайте флаг **сжатия \_ RAW** в параметр *Algorithm* при вызове [**креатекомпрессор**](/windows/desktop/api/compressapi/nf-compressapi-createcompressor) и [**креатедекомпрессор**](/windows/desktop/api/compressapi/nf-compressapi-createdecompressor) для использования режима буфера.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-151">Do not include the **COMPRESS\_RAW** flag in the *Algorithm* parameter when you call [**CreateCompressor**](/windows/desktop/api/compressapi/nf-compressapi-createcompressor) and [**CreateDecompressor**](/windows/desktop/api/compressapi/nf-compressapi-createdecompressor) to use buffer mode.</span></span> <span data-ttu-id="e5f0a-152">Пример кода для приложения в режиме буфера см. в разделе [Использование API сжатия в режиме буфера](using-the-compression-api-in-buffer-mode.md) .</span><span class="sxs-lookup"><span data-stu-id="e5f0a-152">For a code example of a buffer mode application, see the [Using the Compression API in buffer mode](using-the-compression-api-in-buffer-mode.md) section.</span></span>

<span data-ttu-id="e5f0a-153">Режим блокировки позволяет разработчику управлять размером блока, но требует больше работы, чем приложение.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-153">Block mode enables the developer to control the block size, but requires more work be done by the application.</span></span> <span data-ttu-id="e5f0a-154">При использовании блочного режима приложение должно прерывать входные данные в соответствующих единицах при сжатии, а затем при распаковке вернуть их.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-154">When using block mode, the application has to break the input data into appropriately sized pieces when compressing and then put the pieces back together when decompressing.</span></span> <span data-ttu-id="e5f0a-155">Режим блокировки завершается сбоем, если размер входного буфера превышает размер внутреннего блока алгоритма сжатия.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-155">The block mode fails if the size of the input buffer is greater than the internal block size of the compression algorithm.</span></span> <span data-ttu-id="e5f0a-156">Внутренний размер блока — 32 КБ для MSZIP и 1 ГБ для алгоритмов сжатия XPRESS.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-156">The internal block size is 32KB for the MSZIP and 1GB for the XPRESS compression algorithms.</span></span> <span data-ttu-id="e5f0a-157">Внутренний размер блока для ЛЗМС можно настроить до 64 ГБ с соответствующим увеличением использования памяти.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-157">The internal block size for LZMS is configurable up to 64GB with a corresponding increase in memory use.</span></span> <span data-ttu-id="e5f0a-158">Размер сжатого буфера не сохраняется автоматически, и приложение также должно сохранить его для распаковки.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-158">The size of the compressed buffer is not automatically saved, and the application also needs to save this for decompression.</span></span> <span data-ttu-id="e5f0a-159">Значение параметра *ункомпресседбуфферсизе* для [**распаковки**](/windows/desktop/api/compressapi/nf-compressapi-decompress) должно быть в точности равно исходному размеру несжатых данных, а не только размеру выходного буфера.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-159">The value of *UncompressedBufferSize* parameter of [**Decompress**](/windows/desktop/api/compressapi/nf-compressapi-decompress) must be exactly equal to the original size of the uncompressed data and not just the size of the output buffer.</span></span> <span data-ttu-id="e5f0a-160">Это означает, что приложение должно сохранить точный исходный размер несжатых данных, а также сжатые данные и сжатый размер при использовании блочного режима.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-160">This means your application should save the exact original size of the uncompressed data, as well as the compressed data and compressed size, when using block mode.</span></span> <span data-ttu-id="e5f0a-161">Включите флаг **сжатия \_ RAW** в параметр *Algorithm* при вызове [**креатекомпрессор**](/windows/desktop/api/compressapi/nf-compressapi-createcompressor) и [**креатедекомпрессор**](/windows/desktop/api/compressapi/nf-compressapi-createdecompressor) для использования блочного режима.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-161">Include the **COMPRESS\_RAW** flag in the *Algorithm* parameter when you call both [**CreateCompressor**](/windows/desktop/api/compressapi/nf-compressapi-createcompressor) and [**CreateDecompressor**](/windows/desktop/api/compressapi/nf-compressapi-createdecompressor) to use block mode.</span></span> <span data-ttu-id="e5f0a-162">Пример кода для приложения в режиме блокировки см. в разделе [Использование API сжатия в режиме блокировки](using-the-compression-api-in-block-mode.md) .</span><span class="sxs-lookup"><span data-stu-id="e5f0a-162">For a code example of a block mode application, see the [Using the Compression API in block mode](using-the-compression-api-in-block-mode.md) section.</span></span>

## <a name="custom-memory-allocation"></a><span data-ttu-id="e5f0a-163">Пользовательское выделение памяти</span><span class="sxs-lookup"><span data-stu-id="e5f0a-163">Custom memory allocation</span></span>

<span data-ttu-id="e5f0a-164">Приложения буферов и блочного режима позволяют указать настраиваемую подпрограмму выделения памяти при вызове [**креатекомпрессор**](/windows/desktop/api/compressapi/nf-compressapi-createcompressor) и [**креатедекомпрессор**](/windows/desktop/api/compressapi/nf-compressapi-createdecompressor).</span><span class="sxs-lookup"><span data-stu-id="e5f0a-164">Buffer and block mode applications have the option to specify a custom memory allocation routine when they call [**CreateCompressor**](/windows/desktop/api/compressapi/nf-compressapi-createcompressor) and [**CreateDecompressor**](/windows/desktop/api/compressapi/nf-compressapi-createdecompressor).</span></span> <span data-ttu-id="e5f0a-165">Параметр *аллокатионраутинес* указывает структуру [**\_ \_ процедуры распределения сжатия**](/windows/desktop/api/compressapi/ns-compressapi-compress_allocation_routines) , которая содержит подпрограммы выделения памяти.</span><span class="sxs-lookup"><span data-stu-id="e5f0a-165">The *AllocationRoutines* parameter specifies the [**COMPRESS\_ALLOCATION\_ROUTINES**](/windows/desktop/api/compressapi/ns-compressapi-compress_allocation_routines) structure that contains the memory allocation routine.</span></span> <span data-ttu-id="e5f0a-166">Затем приложение может задать размер блока для сжатия с помощью [**сеткомпрессоринформатион**](/windows/desktop/api/compressapi/nf-compressapi-setcompressorinformation).</span><span class="sxs-lookup"><span data-stu-id="e5f0a-166">The application can then set the block size for the compressor using [**SetCompressorInformation**](/windows/desktop/api/compressapi/nf-compressapi-setcompressorinformation).</span></span> <span data-ttu-id="e5f0a-167">Пример простой настраиваемой подпрограммы выделения см. в разделе [Использование API сжатия в режиме блокировки](using-the-compression-api-in-block-mode.md) .</span><span class="sxs-lookup"><span data-stu-id="e5f0a-167">See the [Using the Compression API in block mode](using-the-compression-api-in-block-mode.md) section for an example of a simple customized allocation routine.</span></span>

 

 



