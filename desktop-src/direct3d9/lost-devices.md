---
description: Устройство Direct3D может быть в рабочем состоянии или потерянном состоянии.
ms.assetid: dc4326ba-2ebc-4bca-8fba-02d8db739b8f
title: Потерянные устройства (Direct3D 9)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a808cb113f5c2fd35a741e0efc7c6b8af9e127df
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "104341832"
---
# <a name="lost-devices-direct3d-9"></a><span data-ttu-id="354a9-103">Потерянные устройства (Direct3D 9)</span><span class="sxs-lookup"><span data-stu-id="354a9-103">Lost Devices (Direct3D 9)</span></span>

<span data-ttu-id="354a9-104">Устройство Direct3D может быть в рабочем состоянии или потерянном состоянии.</span><span class="sxs-lookup"><span data-stu-id="354a9-104">A Direct3D device can be in either an operational state or a lost state.</span></span> <span data-ttu-id="354a9-105">Рабочее — это обычное состояние устройства, в котором устройство запускается и отображает все отрисованные элементы, как ожидается.</span><span class="sxs-lookup"><span data-stu-id="354a9-105">The operational state is the normal state of the device in which the device runs and presents all rendering as expected.</span></span> <span data-ttu-id="354a9-106">Устройство выполняет переход в состояние потеряно, когда некоторое событие, например потеря фокуса клавиатуры в приложении в полноэкранном режиме, приводит к невозможности отрисовки.</span><span class="sxs-lookup"><span data-stu-id="354a9-106">The device makes a transition to the lost state when an event, such as the loss of keyboard focus in a full-screen application, causes rendering to become impossible.</span></span> <span data-ttu-id="354a9-107">Потерянное состояние характеризуется незаметным сбоем всех операций отрисовки; это означает, что методы отрисовки могут возвращать коды успешного завершения, даже если операции отрисовки завершились сбоем.</span><span class="sxs-lookup"><span data-stu-id="354a9-107">The lost state is characterized by the silent failure of all rendering operations, which means that the rendering methods can return success codes even though the rendering operations fail.</span></span> <span data-ttu-id="354a9-108">В этом случае код ошибки D3DERR \_ девицелост возвращается [**IDirect3DDevice9::P**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present)повторной отправки.</span><span class="sxs-lookup"><span data-stu-id="354a9-108">In this situation, the error code D3DERR\_DEVICELOST is returned by [**IDirect3DDevice9::Present**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present).</span></span>

<span data-ttu-id="354a9-109">Согласно изначальному замыслу исчерпывающий набор сценариев, в которых устройство может перейти в потерянное состояние, не определен.</span><span class="sxs-lookup"><span data-stu-id="354a9-109">By design, the full set of scenarios that can cause a device to become lost is not specified.</span></span> <span data-ttu-id="354a9-110">В число самых распространенных примеров входит потеря фокуса, например при нажатии пользователем клавиш ALT+TAB или при инициализации диалогового окна системы.</span><span class="sxs-lookup"><span data-stu-id="354a9-110">Some typical examples include loss of focus, such as when the user presses ALT+TAB or when a system dialog is initialized.</span></span> <span data-ttu-id="354a9-111">Устройства также могут быть потеряны из-за события управления питанием, или когда другое приложение пытается выполнить операцию в полноэкранном режиме.</span><span class="sxs-lookup"><span data-stu-id="354a9-111">Devices can also be lost due to a power management event, or when another application assumes full-screen operation.</span></span> <span data-ttu-id="354a9-112">Кроме того, любая ошибка из [**IDirect3DDevice9:: Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) переводит устройство в состояние «утеряно».</span><span class="sxs-lookup"><span data-stu-id="354a9-112">In addition, any failure from [**IDirect3DDevice9::Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) puts the device into a lost state.</span></span>

<span data-ttu-id="354a9-113">Все методы, которые являются производными от [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), гарантированно будут работать после потери устройства.</span><span class="sxs-lookup"><span data-stu-id="354a9-113">All methods that derive from [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) are guaranteed to work after a device is lost.</span></span> <span data-ttu-id="354a9-114">После потери устройства каждая функция обычно имеет следующие три варианта действий.</span><span class="sxs-lookup"><span data-stu-id="354a9-114">After device loss, each function generally has the following three options:</span></span>

-   <span data-ttu-id="354a9-115">Сбой с D3DERR \_ девицелост. Это означает, что приложению нужно определить, что устройство было потеряно, чтобы приложение знало, что что-то не происходит должным образом.</span><span class="sxs-lookup"><span data-stu-id="354a9-115">Fail with D3DERR\_DEVICELOST - This means that the application needs to recognize that the device was lost, so that the application identifies that something isn't happening as expected.</span></span>
-   <span data-ttu-id="354a9-116">При автоматическом сбое, возврате S \_ OK или любых других кодов возврата. Если функция не выполняется автоматически, приложение не может различить результат "успешно" и "неудачный".</span><span class="sxs-lookup"><span data-stu-id="354a9-116">Silently fail, returning S\_OK or any other return codes - If a function silently fails, the application generally can't distinguish between the result of "success" and a "silent failure."</span></span>
-   <span data-ttu-id="354a9-117">Функция возвращает код возврата.</span><span class="sxs-lookup"><span data-stu-id="354a9-117">The function returns a return code.</span></span>



|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="354a9-118">Различия между Direct3D 9 и Direct3D 9Ex:</span><span class="sxs-lookup"><span data-stu-id="354a9-118">Differences between Direct3D 9 and Direct3D 9Ex:</span></span><br/> <span data-ttu-id="354a9-119">Устройство Direct3D 9 возвращает D3DERR \_ девицелост.</span><span class="sxs-lookup"><span data-stu-id="354a9-119">A Direct3D 9 device returns D3DERR\_DEVICELOST.</span></span> <span data-ttu-id="354a9-120">После возврата из [**IDirect3DDevice9::P**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present)повторной отправки, поведение эмуляции больше не будет работать, и все последующие вызовы будут завершаться сбоем, пока устройство не будет успешно сброшено.</span><span class="sxs-lookup"><span data-stu-id="354a9-120">Once it has been returned from [**IDirect3DDevice9::Present**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present), the emulation behavior no longer operates and all future calls will fail until the device is successfully reset.</span></span><br/> <span data-ttu-id="354a9-121">Устройство Direct3D 9Ex никогда не возвращает D3DERR \_ девицелост, но может возвращать новые сообщения о состоянии (см. раздел [изменения поведения устройства](dx9lh.md)).</span><span class="sxs-lookup"><span data-stu-id="354a9-121">A Direct3D 9Ex device never returns D3DERR\_DEVICELOST, but can return new status messages (see [device behavior changes](dx9lh.md)).</span></span><br/> |



 

## <a name="responding-to-a-lost-device"></a><span data-ttu-id="354a9-122">Реакция на потерю устройства</span><span class="sxs-lookup"><span data-stu-id="354a9-122">Responding to a Lost Device</span></span>

<span data-ttu-id="354a9-123">Потеря устройства должна привести к повторному созданию ресурсов (включая ресурсы видеопамяти) после его сброса.</span><span class="sxs-lookup"><span data-stu-id="354a9-123">A lost device must re-create resources (including video memory resources) after it has been reset.</span></span> <span data-ttu-id="354a9-124">Если устройство потеряно, приложение отправляет запрос устройству, чтобы определить, можно ли восстановить его рабочее состояние.</span><span class="sxs-lookup"><span data-stu-id="354a9-124">If a device is lost, the application queries the device to see if it can be restored to the operational state.</span></span> <span data-ttu-id="354a9-125">Если это невозможно, приложение ожидает, пока устройство не сможет быть восстановлено.</span><span class="sxs-lookup"><span data-stu-id="354a9-125">If not, the application waits until the device can be restored.</span></span>

<span data-ttu-id="354a9-126">Если устройство можно восстановить, приложение подготавливает устройство путем уничтожения всех ресурсов видеопамяти и цепочек буферов.</span><span class="sxs-lookup"><span data-stu-id="354a9-126">If the device can be restored, the application prepares the device by destroying all video-memory resources and any swap chains.</span></span> <span data-ttu-id="354a9-127">Затем приложение вызывает метод [**IDirect3DDevice9:: Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) .</span><span class="sxs-lookup"><span data-stu-id="354a9-127">Then, the application calls the [**IDirect3DDevice9::Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) method.</span></span> <span data-ttu-id="354a9-128">Reset — единственный метод, который действует при потере устройства, и является единственным методом, с помощью которого приложение может изменить устройство с состояния потери на рабочее.</span><span class="sxs-lookup"><span data-stu-id="354a9-128">Reset is the only method that has an effect when a device is lost, and is the only method by which an application can change the device from a lost to an operational state.</span></span> <span data-ttu-id="354a9-129">Сброс завершится ошибкой, если приложение не освободит все ресурсы, выделенные в D3DPOOL \_ по умолчанию, включая те, которые были созданы методами [**IDirect3DDevice9:: Креатерендертаржет**](/windows/desktop/api) и [**IDirect3DDevice9:: креатедепсстенЦилсурфаце**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createdepthstencilsurface) .</span><span class="sxs-lookup"><span data-stu-id="354a9-129">Reset will fail unless the application releases all resources that are allocated in D3DPOOL\_DEFAULT, including those created by the [**IDirect3DDevice9::CreateRenderTarget**](/windows/desktop/api) and [**IDirect3DDevice9::CreateDepthStencilSurface**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createdepthstencilsurface) methods.</span></span>

<span data-ttu-id="354a9-130">В большинстве случаев при высокой частоте вызовов Direct3D не возвращается никакой информации о том, было ли устройство потеряно.</span><span class="sxs-lookup"><span data-stu-id="354a9-130">For the most part, the high-frequency calls of Direct3D do not return any information about whether the device has been lost.</span></span> <span data-ttu-id="354a9-131">Приложение может продолжать вызывать методы отрисовки, такие как [**IDirect3DDevice9::D равпримитиве**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive), без получения уведомления о потерянном устройстве.</span><span class="sxs-lookup"><span data-stu-id="354a9-131">The application can continue to call rendering methods, such as [**IDirect3DDevice9::DrawPrimitive**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-drawprimitive), without receiving notification of a lost device.</span></span> <span data-ttu-id="354a9-132">Внутри системы эти операции отменяются, пока устройство не вернется в рабочее состояние.</span><span class="sxs-lookup"><span data-stu-id="354a9-132">Internally, these operations are discarded until the device is reset to the operational state.</span></span>

<span data-ttu-id="354a9-133">Приложение может определить, что делать при обнаружении потерянного устройства, запросив возвращаемое значение метода [**IDirect3DDevice9:: тесткуперативелевел**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-testcooperativelevel) .</span><span class="sxs-lookup"><span data-stu-id="354a9-133">The application can determine what to do on encountering a lost device by querying the return value of the [**IDirect3DDevice9::TestCooperativeLevel**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-testcooperativelevel) method.</span></span>

## <a name="locking-operations"></a><span data-ttu-id="354a9-134">Операции блокировки</span><span class="sxs-lookup"><span data-stu-id="354a9-134">Locking Operations</span></span>

<span data-ttu-id="354a9-135">Внутри системы Direct3D выполняет достаточный объем работы, чтобы гарантировать успешное завершение операции блокировки после потери устройства.</span><span class="sxs-lookup"><span data-stu-id="354a9-135">Internally, Direct3D does enough work to ensure that a lock operation will succeed after a device is lost.</span></span> <span data-ttu-id="354a9-136">Однако не гарантируется, что данные ресурсов видеопамяти будут точными во время операции блокировки.</span><span class="sxs-lookup"><span data-stu-id="354a9-136">However, it is not guaranteed that the video-memory resource's data will be accurate during the lock operation.</span></span> <span data-ttu-id="354a9-137">Гарантируется, что не произойдет возврата никакого кода ошибки.</span><span class="sxs-lookup"><span data-stu-id="354a9-137">It is guaranteed that no error code will be returned.</span></span> <span data-ttu-id="354a9-138">Это позволяет писать приложения, не беспокоясь о потере устройства во время операции блокировки.</span><span class="sxs-lookup"><span data-stu-id="354a9-138">This allows applications to be written without concern for device loss during a lock operation.</span></span>

## <a name="resources"></a><span data-ttu-id="354a9-139">Ресурсы</span><span class="sxs-lookup"><span data-stu-id="354a9-139">Resources</span></span>

<span data-ttu-id="354a9-140">Ресурсы могут потреблять видеопамять.</span><span class="sxs-lookup"><span data-stu-id="354a9-140">Resources can consume video memory.</span></span> <span data-ttu-id="354a9-141">Поскольку потерянное устройство отключается от видеопамяти, принадлежащей адаптеру, невозможно гарантировать выделение видеопамяти при потере устройства.</span><span class="sxs-lookup"><span data-stu-id="354a9-141">Because a lost device is disconnected from the video memory owned by the adapter, it is not possible to guarantee allocation of video memory when the device is lost.</span></span> <span data-ttu-id="354a9-142">В результате все методы создания ресурсов реализуются успешно, возвращая D3D \_ ОК, но на самом деле они выделяют только фиктивную системную память.</span><span class="sxs-lookup"><span data-stu-id="354a9-142">As a result, all resource creation methods are implemented to succeed by returning D3D\_OK, but do in fact allocate only dummy system memory.</span></span> <span data-ttu-id="354a9-143">Поскольку ресурсы видеопамяти должны быть уничтожены перед изменением размера устройства, проблема избыточного выделения видеопамяти не возникает.</span><span class="sxs-lookup"><span data-stu-id="354a9-143">Because any video-memory resource must be destroyed before the device is resized, there is no issue of over-allocating video memory.</span></span> <span data-ttu-id="354a9-144">Эти фиктивные поверхности позволяют операциям блокировки и копирования работать нормально, пока приложение не вызовет [**IDirect3DDevice9::P**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present) повторно и обнаруживает, что устройство потеряно.</span><span class="sxs-lookup"><span data-stu-id="354a9-144">These dummy surfaces allow lock and copy operations to appear to function normally until the application calls [**IDirect3DDevice9::Present**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present) and discovers that the device has been lost.</span></span>

<span data-ttu-id="354a9-145">Перед переводом устройства из потерянного состояния в рабочее вся видеопамять должна быть освобождена.</span><span class="sxs-lookup"><span data-stu-id="354a9-145">All video memory must be released before a device can be reset from a lost state to an operational state.</span></span> <span data-ttu-id="354a9-146">Это означает, что приложение должно освобождать любые цепочки подкачки, созданные с помощью [**IDirect3DDevice9:: креатеаддитионалсвапчаин**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createadditionalswapchain) , и любых ресурсов, помещенных в \_ класс памяти D3DPOOL по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="354a9-146">This means that the application should release any swap chains created with [**IDirect3DDevice9::CreateAdditionalSwapChain**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createadditionalswapchain) and any resources placed in the D3DPOOL\_DEFAULT memory class.</span></span> <span data-ttu-id="354a9-147">Приложению не требуется освобождать ресурсы в \_ классах памяти D3DPOOL Managed или D3DPOOL \_ системмем.</span><span class="sxs-lookup"><span data-stu-id="354a9-147">The application need not release resources in the D3DPOOL\_MANAGED or D3DPOOL\_SYSTEMMEM memory classes.</span></span> <span data-ttu-id="354a9-148">Другие данные о состоянии автоматически удаляются при переходе в рабочее состояние.</span><span class="sxs-lookup"><span data-stu-id="354a9-148">Other state data is automatically destroyed by the transition to an operational state.</span></span>

<span data-ttu-id="354a9-149">Рекомендуется разрабатывать приложения с одним программным путем для реагирования на потерю устройства.</span><span class="sxs-lookup"><span data-stu-id="354a9-149">You are encouraged to develop applications with a single code path to respond to device loss.</span></span> <span data-ttu-id="354a9-150">Этот программный путь может быть аналогичен, если не идентичен, программному пути, который используется для инициализации устройства при запуске.</span><span class="sxs-lookup"><span data-stu-id="354a9-150">This code path is likely to be similar, if not identical, to the code path taken to initialize the device at startup.</span></span>

## <a name="retrieved-data"></a><span data-ttu-id="354a9-151">Извлеченные данные</span><span class="sxs-lookup"><span data-stu-id="354a9-151">Retrieved Data</span></span>

<span data-ttu-id="354a9-152">Direct3D позволяет приложениям проверять текстуры и передавать состояния по одному этапу отрисовки с помощью [**IDirect3DDevice9:: валидатедевице**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-validatedevice).</span><span class="sxs-lookup"><span data-stu-id="354a9-152">Direct3D allows applications to validate texture and render states against single pass rendering by the hardware using [**IDirect3DDevice9::ValidateDevice**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-validatedevice).</span></span> <span data-ttu-id="354a9-153">Этот метод, который обычно вызывается во время инициализации приложения, возвращает D3DERR \_ девицелост, если устройство было потеряно.</span><span class="sxs-lookup"><span data-stu-id="354a9-153">This method, which is typically invoked during initialization of the application, will return D3DERR\_DEVICELOST if the device has been lost.</span></span>

<span data-ttu-id="354a9-154">Direct3D также позволяет приложениям копировать сгенерированные или ранее записанные изображения из ресурсов видеопамяти в ресурсы энергонезависимой памяти системы.</span><span class="sxs-lookup"><span data-stu-id="354a9-154">Direct3D also allows applications to copy generated or previously written images from video-memory resources to nonvolatile system-memory resources.</span></span> <span data-ttu-id="354a9-155">Так как исходные изображения в таких операциях передачи могут быть потеряны в любое время, Direct3D позволяет таким операциям копирования завершаться сбоем, если устройство потеряно.</span><span class="sxs-lookup"><span data-stu-id="354a9-155">Because the source images of such transfers might be lost at any time, Direct3D allows such copy operations to fail when the device is lost.</span></span>

<span data-ttu-id="354a9-156">В отношении асинхронных запросов [**IDirect3DQuery9:: GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) возвращает D3DERR \_ девицелост, если указан флаг Flush, чтобы указать приложению, что **IDirect3DQuery9:: GetData** никогда не возвратит значение S \_ ОК.</span><span class="sxs-lookup"><span data-stu-id="354a9-156">Regarding asynchronous queries, [**IDirect3DQuery9::GetData**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3dquery9-getdata) returns D3DERR\_DEVICELOST if the FLUSH flag is specified, in order to indicate to the application that **IDirect3DQuery9::GetData** will never return S\_OK.</span></span>

<span data-ttu-id="354a9-157">Операция копирования, [**IDirect3DDevice9:: жетфронтбуффердата**](/windows/desktop/api), может завершиться с ошибкой D3DERR \_ девицелост, так как при потере устройства основная поверхность отсутствует.</span><span class="sxs-lookup"><span data-stu-id="354a9-157">The copy operation, [**IDirect3DDevice9::GetFrontBufferData**](/windows/desktop/api), can fail with D3DERR\_DEVICELOST since there is no primary surface when the device is lost.</span></span> <span data-ttu-id="354a9-158">[**IDirect3DDevice9:: креатеаддитионалсвапчаин**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createadditionalswapchain) может также завершиться с помощью D3DERR \_ девицелост, так как невозможно создать задний буфер при потере устройства.</span><span class="sxs-lookup"><span data-stu-id="354a9-158">[**IDirect3DDevice9::CreateAdditionalSwapChain**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createadditionalswapchain) can also fail with D3DERR\_DEVICELOST because a back buffer can't be created when the device is lost.</span></span> <span data-ttu-id="354a9-159">Обратите внимание, что эти случаи являются единственным экземпляром D3DERR \_ девицелост за пределами методов [**IDirect3DDevice9::P**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present), [**IDirect3DDevice9:: тесткуперативелевел**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-testcooperativelevel)и [**IDirect3DDevice9:: Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) .</span><span class="sxs-lookup"><span data-stu-id="354a9-159">Note that these cases are the only instance of D3DERR\_DEVICELOST outside of the [**IDirect3DDevice9::Present**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-present), [**IDirect3DDevice9::TestCooperativeLevel**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-testcooperativelevel), and [**IDirect3DDevice9::Reset**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-reset) methods.</span></span>

## <a name="programmable-shaders"></a><span data-ttu-id="354a9-160">Программируемые шейдеры</span><span class="sxs-lookup"><span data-stu-id="354a9-160">Programmable Shaders</span></span>

<span data-ttu-id="354a9-161">В Direct3D 9 шейдер вершин и шейдеры пикселей не нужно создавать повторно после сброса.</span><span class="sxs-lookup"><span data-stu-id="354a9-161">In Direct3D 9, vertex shaders and pixel shaders don't need to be re-created after reset.</span></span> <span data-ttu-id="354a9-162">Они будут сохранены.</span><span class="sxs-lookup"><span data-stu-id="354a9-162">They will be remembered.</span></span> <span data-ttu-id="354a9-163">В предыдущих версиях DirectX были созданы повторно созданные шейдеры, необходимые для устройства.</span><span class="sxs-lookup"><span data-stu-id="354a9-163">In previous versions of DirectX, a lost device required shaders to be re-created.</span></span>

## <a name="related-topics"></a><span data-ttu-id="354a9-164">См. также</span><span class="sxs-lookup"><span data-stu-id="354a9-164">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="354a9-165">Устройства Direct3D</span><span class="sxs-lookup"><span data-stu-id="354a9-165">Direct3D Devices</span></span>](direct3d-devices.md)
</dt> </dl>

 

 
