---
description: Пиксельный туман получает свое имя из того факта, что оно вычисляется на основе каждого пикселя в драйвере устройства.
ms.assetid: 6fcfb9fa-cacc-4dbc-bfc6-85d533dbfbf8
title: Пиксельный туман (Direct3D 9)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4f62a597820fa009207d8dda7836d161cdf34c88
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "103894086"
---
# <a name="pixel-fog-direct3d-9"></a>Пиксельный туман (Direct3D 9)

Пиксельный туман получает свое имя из того факта, что оно вычисляется на основе каждого пикселя в драйвере устройства. Это отличается от вершинного тумана, вычисляемого конвейером во время вычислений преобразования и освещения. Пиксельные туманы иногда называются таблицами тумана, так как некоторые драйверы используют предварительно вычисленную таблицу подстановки для определения коэффициента тумана с использованием глубины каждого пикселя для применения в вычислениях смешения. Его можно применить с помощью любой формулы тумана, определенной элементами перечисляемого типа [**D3DFOGMODE**](./d3dfogmode.md) . Реализации этих формул зависят от драйвера. Если драйвер не поддерживает сложную формулу тумана, он должен быть снижен до менее сложной формулы.

## <a name="eye-relative-vs-z-based-depth"></a>Eye-Relativeная и Z-глубина

Для смягчения связанных с туманом графических артефактов, вызванных неравномерной распределенностью z-значений в буфере глубины, большинство устройств используют глубину относительных глаз вместо z-значений глубины для пиксельного тумана. Относительное количество глаз по сути является элементом w из однородного набора координат. Microsoft Direct3D берет обратную часть элемента РХВ из набора координат пространства устройства, чтобы воспроизвести значение true w. Если устройство поддерживает туман, относительный от глаз, при вызове метода [**IDirect3DDevice9:: жетдевицекапс**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-getdevicecaps) устанавливается флаг **D3DPRASTERCAPS \_ вфог** в элементе растеркапс структуры [**D3DCAPS9**](/windows/desktop/api/D3D9Caps/ns-d3d9caps-d3dcaps9) . За исключением ссылки на средство программной прорисовки, устройства всегда используют z для вычисления эффектов Pixel тумана.

Когда поддерживается относительный туман, система автоматически использует глубину, отличную от глаза, а не z-глубину, если указанная матрица проекции создает в мировом пространстве z-значения, эквивалентные значениям w в пространстве устройства. Чтобы задать матрицу проекции, вызовите метод [**IDirect3DDevice9:: сеттрансформ**](/windows/desktop/api) , используя \_ значение проекции D3DTS и передав структуру [**D3DMATRIX**](d3dmatrix.md) , представляющую нужную матрицу. Если матрица проекции не соответствует этому требованию, эффекты тумана не применяются должным образом. Дополнительные сведения о создании совместимой матрицы см. в разделе [преобразование проекции (Direct3D 9)](projection-transform.md).

Direct3D использует текущую матрицу проекции при расчетах глубины вершин на основе переменной w. В результате приложение должно установить соответствующую матрицу проекции для получения требуемых функций на основе w, даже если она не использует конвейер преобразования Direct3D.

Direct3D проверяет четвертый столбец матрицы проекции. Если коэффициенты равны \[ 0, 0, 0, 1 \] (для аффинных проекции), система будет использовать z-значения глубины для тумана. В этом случае необходимо также указать начальное и конечное расстояние для линейных эффектов тумана в пространстве устройства, которое находится в диапазоне от 0,0 в ближайшей точке к пользователю, а 1,0 — в самой последней точке.

## <a name="using-pixel-fog"></a>Использование пиксельного тумана

Чтобы включить пиксельный туман в приложении, выполните следующие действия.

1.  Включите смешение тумана, установив \_ для состояния отрисовки D3DRS Фоженабле **значение true**.
2.  Задайте нужный цвет тумана в \_ состоянии рендеринга D3DRS фогколор.
3.  Выберите формулу тумана, чтобы использовать ее, установив \_ для состояния отрисовки D3DRS фогтаблемоде соответствующий элемент перечисляемого типа [**D3DFOGMODE**](./d3dfogmode.md) .
4.  Задайте необходимые параметры тумана для выбранного режима тумана в связанных состояниях рендеринга. Сюда входят начальное и конечное расстояния для линейной тумана, а также плотность тумана для режима экспоненциального тумана.

В следующем примере показано, как эти шаги могут выглядеть в коде.


```
// For brevity, error values in this example are not checked 
//   after each call. A real-world application should check 
//   these values appropriately.
//
// For the purposes of this example, g_pDevice is a valid
//   pointer to an IDirect3DDevice9 interface.
void SetupPixelFog(DWORD Color, DWORD Mode)
{
    float Start   = 0.5f;    // For linear mode
    float End     = 0.8f;
    float Density = 0.66f;   // For exponential modes
 
    // Enable fog blending.
    g_pDevice->SetRenderState(D3DRS_FOGENABLE, TRUE);
 
    // Set the fog color.
    g_pDevice->SetRenderState(D3DRS_FOGCOLOR, Color);
    
    // Set fog parameters.
    if( Mode == D3DFOG_LINEAR )
    {
        g_pDevice->SetRenderState(D3DRS_FOGTABLEMODE, Mode);
        g_pDevice->SetRenderState(D3DRS_FOGSTART, *(DWORD *)(&Start));
        g_pDevice->SetRenderState(D3DRS_FOGEND,   *(DWORD *)(&End));
    }
    else
    {
        g_pDevice->SetRenderState(D3DRS_FOGTABLEMODE, Mode);
        g_pDevice->SetRenderState(D3DRS_FOGDENSITY, *(DWORD *)(&Density));
    }
```



Некоторые параметры тумана требуются в качестве значений с плавающей запятой, хотя метод [**IDirect3DDevice9:: сетрендерстате**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-setrenderstate) принимает только значения типа DWORD во втором параметре. В предыдущем примере значения с плавающей запятой переводятся в **IDirect3DDevice9:: сетрендерстате** без преобразования данных путем приведения адресов переменных с плавающей запятой в виде УКАЗАТЕЛЕЙ типа DWORD и последующей разыменования их.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Типы туманов](fog-types.md)
</dt> </dl>

 

 
