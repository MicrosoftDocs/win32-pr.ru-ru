---
description: Карты смещения похожи на карты текстур, но к ним обращаются ядро вершин.
ms.assetid: d6f16ff2-5a66-48a3-82c4-523faaafa6ae
title: Сопоставление замещения (Direct3D 9)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b687583b0109223d8c2dac807425e235ddf280e4
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "104495312"
---
# <a name="displacement-mapping-direct3d-9"></a><span data-ttu-id="dd914-103">Сопоставление замещения (Direct3D 9)</span><span class="sxs-lookup"><span data-stu-id="dd914-103">Displacement Mapping (Direct3D 9)</span></span>

<span data-ttu-id="dd914-104">Карты смещения похожи на карты текстур, но к ним обращаются ядро вершин.</span><span class="sxs-lookup"><span data-stu-id="dd914-104">Displacement maps are similar to texture maps but are accessed by the vertex engine.</span></span>

## <a name="block-diagram"></a><span data-ttu-id="dd914-105">Блоковая схема</span><span class="sxs-lookup"><span data-stu-id="dd914-105">Block Diagram</span></span>

<span data-ttu-id="dd914-106">На ранней части канала вершин имеется дополнительный этап выборки, как показано на следующей схеме, где можно вычислить карту смещения для получения данных о смещении вершин.</span><span class="sxs-lookup"><span data-stu-id="dd914-106">An additional sampler stage is present in the early part of the vertex pipe, as shown in the following diagram, which can sample a displacement map to provide vertex displacement data.</span></span>

![Схема этапа образца в канале вершин](images/tessellatordx9.png)

<span data-ttu-id="dd914-108">Состояние выборки карт смещения может быть задано [**сетсамплерстате**](/windows/desktop/api) с использованием этапа номер 256, который представляет собой новый номер этапа.</span><span class="sxs-lookup"><span data-stu-id="dd914-108">The displacement map sampler state can be set by the [**SetSamplerState**](/windows/desktop/api) using stage number 256, which is a new stage number.</span></span> <span data-ttu-id="dd914-109">Текстура с картой смещения задается параметром [**сеттекстуре**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture).</span><span class="sxs-lookup"><span data-stu-id="dd914-109">The displacement map texture is set by [**SetTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-settexture).</span></span>

<span data-ttu-id="dd914-110">Карту можно использовать в качестве предварительной выборки, а это означает, что она может быть упорядочена таким образом, что позволяет выполнять поиск значений смещения без фильтрации.</span><span class="sxs-lookup"><span data-stu-id="dd914-110">The map can be presampled or not, which means that it can be ordered in a way that enables the lookup of the displacement values without filtering.</span></span>

-   <span data-ttu-id="dd914-111">Карты смещения аналогичны картам текстур, но доступны механизму вершин.</span><span class="sxs-lookup"><span data-stu-id="dd914-111">Displacement maps are analogous to texture maps but are accessed by the vertex engine.</span></span>
-   <span data-ttu-id="dd914-112">На ранней части канала вершин имеется дополнительный этап выборки, который может быть примером схемы смещения.</span><span class="sxs-lookup"><span data-stu-id="dd914-112">An additional sampler stage is present in the early part of the vertex pipe that can sample a displacement map.</span></span> <span data-ttu-id="dd914-113">Доступ к этому этапу осуществляется обычным API Сетсамплерстате, но номер этапа — D3DDMAPSAMPLER = 256.</span><span class="sxs-lookup"><span data-stu-id="dd914-113">This stage is accessed by the usual SetSamplerState API but the stage number is D3DDMAPSAMPLER = 256.</span></span>
-   <span data-ttu-id="dd914-114">Состояние выборки для карт смещения можно задать с помощью Сетсамплерстате (D3DDMAPSAMPLER,...). API.</span><span class="sxs-lookup"><span data-stu-id="dd914-114">The displacement map sampler state can be set by the SetSamplerState(D3DDMAPSAMPLER, ...) API.</span></span>
-   <span data-ttu-id="dd914-115">Текстура карт смещения задается API Сеттекстуре (D3DDMAPSAMPLER, текстура).</span><span class="sxs-lookup"><span data-stu-id="dd914-115">The displacement map texture is set by the SetTexture(D3DDMAPSAMPLER, texture) API.</span></span>
-   <span data-ttu-id="dd914-116">Карту можно предварительно выборке или нет.</span><span class="sxs-lookup"><span data-stu-id="dd914-116">The map can be pre-sampled or not.</span></span> <span data-ttu-id="dd914-117">Это означает, что он может быть упорядочен определенным образом, который позволяет выполнять поиск значений смещения без фильтрации.</span><span class="sxs-lookup"><span data-stu-id="dd914-117">This means that it can be ordered in a particular way that enables the lookup of the displacement values without filtering.</span></span>
-   <span data-ttu-id="dd914-118">Изменения в структуре объявления позволяют спецификации координаты текстуры, используемой для поиска текстурной гиперкарты.</span><span class="sxs-lookup"><span data-stu-id="dd914-118">The changes in the declaration structure allow the specification of the texture coordinate used to look up the texture map.</span></span> <span data-ttu-id="dd914-119">Например, Stream0, offset, FLOAT2, УТОЧНЯющий запрос, \_ значение смещения.</span><span class="sxs-lookup"><span data-stu-id="dd914-119">For example, Stream0, Offset, FLOAT2, LOOKUP, Displacement\_value.</span></span> <span data-ttu-id="dd914-120">Это указывает тесселяции использовать 2D-вектор float в stream0 с определенным смещением в качестве координаты текстуры для поиска карт смещения и связывания \_ с ним семантики использования значения смещения.</span><span class="sxs-lookup"><span data-stu-id="dd914-120">This tells the tessellator to use the 2D float vector in stream0 at a certain offset as a texture coordinate to look up the displacement map and associate the Displacement\_value usage semantic to it.</span></span> <span data-ttu-id="dd914-121">Объявление вершинного шейдера будет содержать строку, похожую на {дкл \_ Texture0, v0}, указывающую, что семантика Texture0 должна быть связана с входным регистром v0.</span><span class="sxs-lookup"><span data-stu-id="dd914-121">The vertex shader declaration would contain a line similar to {dcl\_texture0, v0} indicating that the texture0 semantic is to be associated with the v0 input register.</span></span> <span data-ttu-id="dd914-122">Искомое значение смещения копируется во входной регистр v0.</span><span class="sxs-lookup"><span data-stu-id="dd914-122">The displacement value looked up is copied into input register v0.</span></span>
-   <span data-ttu-id="dd914-123">Существует специальный тип сопоставления смещения, когда Текстурная схема предварительно выдается.</span><span class="sxs-lookup"><span data-stu-id="dd914-123">There is a special type of displacement mapping, when the texture map is pre-sampled.</span></span> <span data-ttu-id="dd914-124">Последовательный индекс созданных вершин используется в качестве координаты текстуры для текстурной гиперкарты.</span><span class="sxs-lookup"><span data-stu-id="dd914-124">Sequential index of generated vertices is used as a texture coordinate to a texture map.</span></span> <span data-ttu-id="dd914-125">Например, 0, 0, (D3DDECLTYPE) 0, D3DDECLMETHOD \_ лукуппресамплед, Usage, усажеиндекс.</span><span class="sxs-lookup"><span data-stu-id="dd914-125">For example, 0,0,(D3DDECLTYPE)0,D3DDECLMETHOD\_LOOKUPPRESAMPLED, Usage, UsageIndex.</span></span>
-   <span data-ttu-id="dd914-126">Выходные данные уточняющего запроса — 4 с плавающей запятой.</span><span class="sxs-lookup"><span data-stu-id="dd914-126">The output of the lookup is 4 floats.</span></span>
-   <span data-ttu-id="dd914-127">Сопоставление замещения поддерживается только с N-исправлениями.</span><span class="sxs-lookup"><span data-stu-id="dd914-127">Displacement mapping is supported only with N-patches.</span></span>
-   <span data-ttu-id="dd914-128">Драйверы должны игнорировать D3DDMAPSAMPLER в Сеттекстурестажестате, если они не обрабатывают карты смещения.</span><span class="sxs-lookup"><span data-stu-id="dd914-128">Drivers need to ignore D3DDMAPSAMPLER in SetTextureStageState if they do not handle displacement maps.</span></span>
-   <span data-ttu-id="dd914-129">\_Режим D3DTEXF анизотропного фильтра не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="dd914-129">D3DTEXF\_ANISOTROPIC filter mode is not supported.</span></span>
-   <span data-ttu-id="dd914-130">Если D3DSAMP \_ мипфилтер в образце карт смещения не D3DTEXF \_ None, уровень детализации вычисляются следующим образом (Обратите внимание, что Адаптивное состояние тесселяции используется, даже если D3DRS \_ Енаблеадаптиветесселлатион имеет **значение false**): тмакс = Render State D3DRS \_ макстесселлатионлевел</span><span class="sxs-lookup"><span data-stu-id="dd914-130">When D3DSAMP\_MIPFILTER in the displacement map sampler is not D3DTEXF\_NONE, the level of detail is computed as follows (Note that the adaptive tessellation state is used even if the D3DRS\_ENABLEADAPTIVETESSELLATION is **FALSE**): Tmax = render state D3DRS\_MAXTESSELLATIONLEVEL</span></span>
-   <span data-ttu-id="dd914-131">Вычисление уровня тесселяции на уровне мозаики для вершины VI: (XI, Yi, Zi) так же, как описано в разделе "Адаптивная тесселяция".</span><span class="sxs-lookup"><span data-stu-id="dd914-131">Compute tessellation level Te for a vertex Vi: (Xi, Yi, Zi) the same way as described in the "Adaptive tessellation" section.</span></span> <span data-ttu-id="dd914-132">Уровень детализации L = log2 (Тмакс) — log2 (TE).</span><span class="sxs-lookup"><span data-stu-id="dd914-132">Level of detail L = log2(Tmax) - log2 (Te).</span></span>
-   <span data-ttu-id="dd914-133">Операции фильтрации и выборки текстур следуют тем же правилам, что и для конвейера пикселей (применяется уровень детализации (Лод) и т. д.).</span><span class="sxs-lookup"><span data-stu-id="dd914-133">Texture filtering and sampling operations follow the same rules as the pixel pipeline (level of detail (LOD) bias is applied, etc.).</span></span>
-   <span data-ttu-id="dd914-134">Не все форматы можно использовать в качестве карт смещения, но только для тех, которые поддерживают D3DUSAGE \_ ДМАП.</span><span class="sxs-lookup"><span data-stu-id="dd914-134">Not all formats can be used as displacement maps but only those that support the D3DUSAGE\_DMAP.</span></span> <span data-ttu-id="dd914-135">Приложение может запрашивать это с помощью Чеккдевицеформат [**чеккдевицеформат**](/windows/win32/api/d3d9/nf-d3d9-idirect3d9-checkdeviceformat).</span><span class="sxs-lookup"><span data-stu-id="dd914-135">The application can query that with the CheckDeviceFormat [**CheckDeviceFormat**](/windows/win32/api/d3d9/nf-d3d9-idirect3d9-checkdeviceformat).</span></span>
-   <span data-ttu-id="dd914-136">D3DUSAGE \_ ДМАП должен быть указан в [**креатетекстуре**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createtexture) , чтобы уведомить драйвер о том, что эта текстура будет использоваться в качестве искривленной схемы.</span><span class="sxs-lookup"><span data-stu-id="dd914-136">D3DUSAGE\_DMAP must be specified in [**CreateTexture**](/windows/win32/api/d3d9helper/nf-d3d9helper-idirect3ddevice9-createtexture) to notify the driver that this texture is to be used as a displacement map.</span></span>
-   <span data-ttu-id="dd914-137">D3DUSAGE \_ ДМАП можно использовать только с текстурами.</span><span class="sxs-lookup"><span data-stu-id="dd914-137">D3DUSAGE\_DMAP can only be used with textures.</span></span> <span data-ttu-id="dd914-138">Его нельзя использовать с картами или томами Куба.</span><span class="sxs-lookup"><span data-stu-id="dd914-138">It cannot be used with cube maps or volumes.</span></span>
-   <span data-ttu-id="dd914-139">Текстуры и целевые объекты отрисовки, созданные с помощью D3DUSAGE \_ ДМАП, можно задать на обычных стадиях и в качестве целевых объектов рендеринга.</span><span class="sxs-lookup"><span data-stu-id="dd914-139">Textures and render targets created with D3DUSAGE\_DMAP can be set at regular sampler stages and as render targets.</span></span>
-   <span data-ttu-id="dd914-140">Состояния отрисовки для установки режима переноса для координат текстуры не учитываются при сопоставлении замещения.</span><span class="sxs-lookup"><span data-stu-id="dd914-140">The render states to set the wrap mode for the texture coordinates are ignored in displacement mapping.</span></span> <span data-ttu-id="dd914-141">Как правило, для подсистемы тесселяции нет режимов переноса.</span><span class="sxs-lookup"><span data-stu-id="dd914-141">In general, there are no wrap modes for the tessellator engine.</span></span>
-   <span data-ttu-id="dd914-142">В образце карт смещения есть поведение, идентичное поведению образцов текстур пикселей.</span><span class="sxs-lookup"><span data-stu-id="dd914-142">A displacement map sampler has behavior identical to that of the pixel texture samplers.</span></span> <span data-ttu-id="dd914-143">Если выполняется поиск текстуры с менее чем четырьмя каналами (например, R32f), то искомые значения переходят к соответствующим каналам регистра назначения (входная регистрация вершинного шейдера, помеченная как \_ образец семантики), а другие каналы по умолчанию имеют значение (1, 1, 1).</span><span class="sxs-lookup"><span data-stu-id="dd914-143">If a texture with less than four channels (like R32f) is looked up, the looked-up values go to the appropriate channels of the destination register (the vertex shader input register tagged with the \_sample semantic), while the other channels default to (1, 1, 1).</span></span> <span data-ttu-id="dd914-144">При поиске D3DFMT на \_ уровне 8 на каналах R, G, B и по умолчанию устанавливается значение 1.</span><span class="sxs-lookup"><span data-stu-id="dd914-144">When looked up, D3DFMT\_L8 gets broadcast into the R, G, B channels and A defaults to 1.</span></span> <span data-ttu-id="dd914-145">Средство программной прорисовки содержит полную информацию о реализации.</span><span class="sxs-lookup"><span data-stu-id="dd914-145">The reference rasterizer has the full implementation details.</span></span>

## <a name="pre-sampled-displacement-mapping"></a><span data-ttu-id="dd914-146">Предварительная выборка сопоставления смещения</span><span class="sxs-lookup"><span data-stu-id="dd914-146">Pre-Sampled Displacement Mapping</span></span>

-   <span data-ttu-id="dd914-147">Новое состояние выборки: D3DSAMP \_ дмапоффсет (DWORD) — offset (в вершинах) в предварительно выборке карт смещения.</span><span class="sxs-lookup"><span data-stu-id="dd914-147">New sampler state is introduced: D3DSAMP\_DMAPOFFSET (DWORD) - offset (in vertices) in a pre-sampled displacement map.</span></span>
-   <span data-ttu-id="dd914-148">Появился новый метод объявления: D3DDECLMETHOD \_ лукуппресамплед.</span><span class="sxs-lookup"><span data-stu-id="dd914-148">New declaration method is introduced: D3DDECLMETHOD\_LOOKUPPRESAMPLED.</span></span>
-   <span data-ttu-id="dd914-149">Адаптивную тесселяцию следует отключить.</span><span class="sxs-lookup"><span data-stu-id="dd914-149">Adaptive tessellation should be disabled.</span></span>
-   <span data-ttu-id="dd914-150">Параметры фильтра текстур игнорируются.</span><span class="sxs-lookup"><span data-stu-id="dd914-150">Texture filter settings are ignored.</span></span> <span data-ttu-id="dd914-151">Выборка точек выполнена.</span><span class="sxs-lookup"><span data-stu-id="dd914-151">Point sampling is done.</span></span> <span data-ttu-id="dd914-152">Предполагается, что фильтр текстуры MIP D3DTEXF \_ None.</span><span class="sxs-lookup"><span data-stu-id="dd914-152">The mip texture filter is assumed to be D3DTEXF\_NONE.</span></span> <span data-ttu-id="dd914-153">Все остальные режимы фильтра текстуры считаются D3DTEXF \_ Point.</span><span class="sxs-lookup"><span data-stu-id="dd914-153">All other texture filter modes are assumed to be D3DTEXF\_POINT.</span></span>
-   <span data-ttu-id="dd914-154">Координаты текстуры вычисляются следующим образом: U = (индекс% Текстуревидсинпикселес)/(float) (Текстуревидсинпикселес) V = (index/Текстуревидсинпикселес)/(float) (Текстурехеигхтинпикселес), где index — последовательный индекс созданных вершин плюс TSS \[ D3DSAMP \_ DMAPOFFSET \] .</span><span class="sxs-lookup"><span data-stu-id="dd914-154">Texture coordinates are computed as: U = (Index % TextureWidthInPixeles) / (float)(TextureWidthInPixeles) V = (Index / TextureWidthInPixeles) / (float)(TextureHeightInPixeles) where Index is a sequential index of generated vertices plus TSS\[D3DSAMP\_DMAPOFFSET\].</span></span> <span data-ttu-id="dd914-155">Последовательный Индекс задается равным нулю в начале каждого примитива и увеличивается после создания вершины.</span><span class="sxs-lookup"><span data-stu-id="dd914-155">The sequential index is set to zero at the start of each primitive and is increased after a vertex is generated.</span></span>

<span data-ttu-id="dd914-156">Это изменения API, поддерживающие сопоставление смещений.</span><span class="sxs-lookup"><span data-stu-id="dd914-156">These are the API changes that support displacement mapping.</span></span>

-   <span data-ttu-id="dd914-157">Добавлен один формат канала, D3DFMT \_ L16.</span><span class="sxs-lookup"><span data-stu-id="dd914-157">A single channel format added, D3DFMT\_L16.</span></span>
-   <span data-ttu-id="dd914-158">Новый флаг использования, D3DUSAGE \_ ДМАП.</span><span class="sxs-lookup"><span data-stu-id="dd914-158">A new usage flag, D3DUSAGE\_DMAP.</span></span>
-   <span data-ttu-id="dd914-159">Специальный этап текстуры, используемый для установки текстуры карт смещения, D3DDMAPSAMPLER.</span><span class="sxs-lookup"><span data-stu-id="dd914-159">A special texture stage, used to set a displacement map texture, D3DDMAPSAMPLER.</span></span>
-   <span data-ttu-id="dd914-160">Добавлены новые ограничения на оборудование, D3DDEVCAPS2 \_ дмапнпатч и D3DDEVCAPS2 \_ пресампледдмапнпатч.</span><span class="sxs-lookup"><span data-stu-id="dd914-160">New hardware caps have been added, D3DDEVCAPS2\_DMAPNPATCH and D3DDEVCAPS2\_PRESAMPLEDDMAPNPATCH.</span></span> <span data-ttu-id="dd914-161">См. [D3DDEVCAPS2](d3ddevcaps2.md).</span><span class="sxs-lookup"><span data-stu-id="dd914-161">See [D3DDEVCAPS2](d3ddevcaps2.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="dd914-162">См. также</span><span class="sxs-lookup"><span data-stu-id="dd914-162">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="dd914-163">Конвейер вершин</span><span class="sxs-lookup"><span data-stu-id="dd914-163">Vertex Pipeline</span></span>](vertex-pipeline.md)
</dt> </dl>

 

 
