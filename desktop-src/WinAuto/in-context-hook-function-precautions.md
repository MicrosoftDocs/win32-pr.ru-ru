---
title: In-Context меры предосторожности для функций-ловушек
description: По соображениям производительности разработчики клиента регистрируют функции-обработчики в контексте.
ms.assetid: 14b48920-a291-4519-b005-e559263a0e83
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8c0e319037cb1295725548b3361bf076b4b1f760
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "105710321"
---
# <a name="in-context-hook-function-precautions"></a><span data-ttu-id="81205-103">In-Context меры предосторожности для функций-ловушек</span><span class="sxs-lookup"><span data-stu-id="81205-103">In-Context Hook Function Precautions</span></span>

<span data-ttu-id="81205-104">По соображениям производительности разработчики клиента регистрируют функции-обработчики в контексте.</span><span class="sxs-lookup"><span data-stu-id="81205-104">For performance reasons, client developers register in-context hook functions.</span></span> <span data-ttu-id="81205-105">Однако поскольку эти функции-ловушки сопоставляются с адресным пространством сервера, разработчики клиентов и серверов должны предпринять меры предосторожности, чтобы обеспечить плавность обработки событий.</span><span class="sxs-lookup"><span data-stu-id="81205-105">However, because these hook functions are mapped into the server's address space, client and server developers must take precautions to ensure that the event processing goes smoothly.</span></span>

## <a name="precautions-for-client-developers"></a><span data-ttu-id="81205-106">Меры предосторожности для разработчиков клиентов</span><span class="sxs-lookup"><span data-stu-id="81205-106">Precautions for Client Developers</span></span>

<span data-ttu-id="81205-107">Разработчикам клиентов следует помнить о следующих проблемах:</span><span class="sxs-lookup"><span data-stu-id="81205-107">Client developers should be aware of the following issues:</span></span>

-   <span data-ttu-id="81205-108">Функции-обработчики в контексте не должны использовать много процессорного времени, так как функция-обработчик должна возвращаться до того, как серверное приложение будет продолжать работу.</span><span class="sxs-lookup"><span data-stu-id="81205-108">In-context hook functions should not use a lot of processor time, because the hook function must return before the server application continues.</span></span>
-   <span data-ttu-id="81205-109">После активации события возможно, что окно, связанное с событием, больше не существует на момент вызова функции-обработчика.</span><span class="sxs-lookup"><span data-stu-id="81205-109">After an event is triggered, it is possible that the window associated with an event no longer exists by the time the hook function is called.</span></span> <span data-ttu-id="81205-110">Клиенты должны убедиться, что окно, связанное с событием, существует, прежде чем предпринимать любые другие действия, связанные с событием.</span><span class="sxs-lookup"><span data-stu-id="81205-110">Clients must verify that the window associated with an event still exists before taking any other action related to the event.</span></span> <span data-ttu-id="81205-111">Чтобы убедиться, что окно по-прежнему существует, клиенты [**используют функцию Microsoft**](/windows/desktop/api/winuser/nf-winuser-iswindow) Win32.</span><span class="sxs-lookup"><span data-stu-id="81205-111">To ensure that a window still exists, clients use the Microsoft Win32 [**IsWindow**](/windows/desktop/api/winuser/nf-winuser-iswindow) function.</span></span>
-   <span data-ttu-id="81205-112">Если библиотека DLL, в которой определена функция-обработчик, ссылается на другую библиотеку DLL, разработчики должны убедиться, что система загружает другую библиотеку DLL.</span><span class="sxs-lookup"><span data-stu-id="81205-112">If the DLL in which the hook function is defined links to another DLL, client developers must ensure that the system loads the other DLL.</span></span> <span data-ttu-id="81205-113">При неявной компоновке (с помощью DEF-файлов и импортов) Дополнительная библиотека DLL должна находиться либо в каталоге Windows, либо в одном из системных каталогов, таких как Windows \\ System, Windows \\ System32 или Windows \\ SysWOW64.</span><span class="sxs-lookup"><span data-stu-id="81205-113">If linking implicitly (using .def files and imports), the additional DLL must be in either the Windows directory or one of the system directories such as Windows\\System, Windows\\System32, or Windows\\SysWOW64.</span></span> <span data-ttu-id="81205-114">При явной компоновке (с помощью [**LoadLibrary**](/windows/desktop/api/libloaderapi/nf-libloaderapi-loadlibrarya)) полный путь к каталогу, в котором находится дополнительная библиотека DLL, должен быть указан в вызове **LoadLibrary**.</span><span class="sxs-lookup"><span data-stu-id="81205-114">If linking explicitly (using [**LoadLibrary**](/windows/desktop/api/libloaderapi/nf-libloaderapi-loadlibrarya)), the full path to the directory in which the additional DLL resides must be specified in the call to **LoadLibrary**.</span></span>
-   <span data-ttu-id="81205-115">Функции-обработчики в контексте могут вызвать переполнение стека при загрузке библиотеки DLL, содержащей функцию-ловушку, в 16-разрядное приложение.</span><span class="sxs-lookup"><span data-stu-id="81205-115">In-context hook functions may cause a stack overflow when the DLL that contains the hook function is loaded into a 16-bit application.</span></span> <span data-ttu-id="81205-116">Эта проблема возникает потому, что 16-разрядные приложения используют фиксированный размер стека, который недостаточно велик для размещения цепочки вызовов системных функций, вызывающих вызов функции-обработчика.</span><span class="sxs-lookup"><span data-stu-id="81205-116">This problem occurs because 16-bit applications use a fixed stack size that is not large enough to accommodate the chain of system function calls that result in a call to the hook function.</span></span>

## <a name="precautions-for-server-developers"></a><span data-ttu-id="81205-117">Меры предосторожности для разработчиков серверов</span><span class="sxs-lookup"><span data-stu-id="81205-117">Precautions for Server Developers</span></span>

<span data-ttu-id="81205-118">Разработчикам сервера необходимо знать, что клиентские приложения могут регистрировать функции-обработчики в контексте.</span><span class="sxs-lookup"><span data-stu-id="81205-118">Server developers need to be aware that client applications might register in-context hook functions.</span></span> <span data-ttu-id="81205-119">Когда сервер вызывает [**нотифивиневент**](/windows/desktop/api/Winuser/nf-winuser-notifywinevent), он должен быть готов к обработке функций [**WM \_ GetObject**](wm-getobject.md) и других методов [**IAccessible**](/windows/desktop/api/oleacc/nn-oleacc-iaccessible) .</span><span class="sxs-lookup"><span data-stu-id="81205-119">When a server calls [**NotifyWinEvent**](/windows/desktop/api/Winuser/nf-winuser-notifywinevent), it must be prepared to handle [**WM\_GETOBJECT**](wm-getobject.md) and other [**IAccessible**](/windows/desktop/api/oleacc/nn-oleacc-iaccessible) methods.</span></span>

## <a name="invalid-interface-pointers"></a><span data-ttu-id="81205-120">Недопустимые указатели интерфейса</span><span class="sxs-lookup"><span data-stu-id="81205-120">Invalid Interface Pointers</span></span>

<span data-ttu-id="81205-121">Когда клиент вызывает [**акцессиблеобжектфромевент**](/windows/desktop/api/Oleacc/nf-oleacc-accessibleobjectfromevent) в функции-обработчике в контексте, возвращаемый указатель интерфейса [**IAccessible**](/windows/desktop/api/oleacc/nn-oleacc-iaccessible) указывает непосредственно на код в адресном пространстве сервера.</span><span class="sxs-lookup"><span data-stu-id="81205-121">When a client calls [**AccessibleObjectFromEvent**](/windows/desktop/api/Oleacc/nf-oleacc-accessibleobjectfromevent) within an in-context hook function, the [**IAccessible**](/windows/desktop/api/oleacc/nn-oleacc-iaccessible) interface pointer that is returned points directly to code in the server's address space.</span></span> <span data-ttu-id="81205-122">Если клиент вызывает свойство интерфейса с помощью этого указателя, то библиотека COM не участвует в упаковке (упаковка и отправка параметров интерфейса через границы процесса) или при распаковке (распаковке параметров, которые были отправлены через границы процесса) и не обнаруживают, уничтожается ли объект.</span><span class="sxs-lookup"><span data-stu-id="81205-122">If the client calls an interface property using this pointer, the Component Object Model (COM) library is not involved with marshaling (packaging and sending interface parameters across process boundaries) or unmarshaling (unpackaging parameters that have been sent across process boundaries) and does not detect if an object is destroyed.</span></span>

<span data-ttu-id="81205-123">Если клиент вызывает свойство интерфейса для объекта, который уничтожается, недопустимый указатель интерфейса вызывает общую ошибку защиты в адресном пространстве сервера, пока сервер не обнаружит такую ситуацию.</span><span class="sxs-lookup"><span data-stu-id="81205-123">If the client calls an interface property to an object that is destroyed, the invalid interface pointer causes a General Protection fault in the server's address space unless the server detects this situation.</span></span>

<span data-ttu-id="81205-124">Для защиты от недопустимых указателей интерфейса серверы [создают прокси-объекты](creating-proxy-objects.md) , которые заносят доступные объекты и отслеживают жизненный цикл доступных объектов.</span><span class="sxs-lookup"><span data-stu-id="81205-124">To protect against invalid interface pointers, servers [create proxy objects](creating-proxy-objects.md) that wrap accessible objects and monitor the life span of accessible objects.</span></span> <span data-ttu-id="81205-125">Например, когда клиент вызывает свойство [**IAccessible**](/windows/desktop/api/oleacc/nn-oleacc-iaccessible) для получения сведений об объекте, прокси-сервер проверяет, доступен ли доступный объект, и, если да, перенаправляет клиентский запрос в доступный объект.</span><span class="sxs-lookup"><span data-stu-id="81205-125">For instance, when a client calls an [**IAccessible**](/windows/desktop/api/oleacc/nn-oleacc-iaccessible) property to get information about an object, the proxy checks whether the accessible object is still available, and if so, forwards the client's request to the accessible object.</span></span> <span data-ttu-id="81205-126">При удалении доступного объекта прокси-сервер возвращает клиенту ошибку.</span><span class="sxs-lookup"><span data-stu-id="81205-126">If the accessible object is destroyed, the proxy returns an error to the client.</span></span>

 

 