---
title: Моментальные снимки системы
description: Моментальные снимки являются основой функций справки средства. Моментальный снимок — это доступная только для чтения копия текущего состояния одного или нескольких следующих списков, расположенных в процессах, потоках, модулях и кучах системной памяти.
ms.assetid: a8122960-f078-4efb-8e01-bf6fb69ee0dd
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6ab6f9a45ad2e12eda53d3143e43c9234c20aae3
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "103890836"
---
# <a name="snapshots-of-the-system"></a><span data-ttu-id="5a282-104">Моментальные снимки системы</span><span class="sxs-lookup"><span data-stu-id="5a282-104">Snapshots of the System</span></span>

<span data-ttu-id="5a282-105">Моментальные снимки являются основой функций справки средства.</span><span class="sxs-lookup"><span data-stu-id="5a282-105">Snapshots are at the core of the tool help functions.</span></span> <span data-ttu-id="5a282-106">Моментальный снимок — это доступная только для чтения копия текущего состояния одного или нескольких следующих списков, расположенных в системной памяти: процессов, потоков, модулей и куч.</span><span class="sxs-lookup"><span data-stu-id="5a282-106">A snapshot is a read-only copy of the current state of one or more of the following lists that reside in system memory: processes, threads, modules, and heaps.</span></span>

<span data-ttu-id="5a282-107">Процессы, использующие функции справки средства, обращаются к этим спискам из моментальных снимков, а не непосредственно из операционной системы.</span><span class="sxs-lookup"><span data-stu-id="5a282-107">Processes that use tool help functions access these lists from snapshots instead of directly from the operating system.</span></span> <span data-ttu-id="5a282-108">Списки в системной памяти изменяются при запуске и завершении процессов, создании и уничтожении потоков, при загрузке и выгрузке исполняемых модулей из системной памяти, а также при создании и уничтожении куч.</span><span class="sxs-lookup"><span data-stu-id="5a282-108">The lists in system memory change when processes are started and ended, threads are created and destroyed, executable modules are loaded and unloaded from system memory, and heaps are created and destroyed.</span></span> <span data-ttu-id="5a282-109">Использование сведений из моментального снимка предотвращает несоответствия.</span><span class="sxs-lookup"><span data-stu-id="5a282-109">The use of information from a snapshot prevents inconsistencies.</span></span> <span data-ttu-id="5a282-110">В противном случае изменения в списке могут привести к неправильному просмотру списка или вызвать нарушение прав доступа (ошибка GP).</span><span class="sxs-lookup"><span data-stu-id="5a282-110">Otherwise, changes to a list could possibly cause a thread to incorrectly traverse the list or cause an access violation (a GP fault).</span></span> <span data-ttu-id="5a282-111">Например, если приложение проходит по списку потоков во время создания или завершения других потоков, то сведения, используемые приложением для обхода списка потоков, могут стать устаревшими и могут вызвать ошибку при прохождении приложения в списке.</span><span class="sxs-lookup"><span data-stu-id="5a282-111">For example, if an application traverses the thread list while other threads are created or terminated, information that the application is using to traverse the thread list might become outdated and could cause an error for the application traversing the list.</span></span>

<span data-ttu-id="5a282-112">Чтобы создать снимок системной памяти, используйте функцию [**CreateToolhelp32Snapshot**](/windows/desktop/api/TlHelp32/nf-tlhelp32-createtoolhelp32snapshot) .</span><span class="sxs-lookup"><span data-stu-id="5a282-112">To take a snapshot of the system memory, use the [**CreateToolhelp32Snapshot**](/windows/desktop/api/TlHelp32/nf-tlhelp32-createtoolhelp32snapshot) function.</span></span> <span data-ttu-id="5a282-113">Вы можете управлять содержимым моментального снимка, указав одно или несколько следующих значений при вызове этой функции:</span><span class="sxs-lookup"><span data-stu-id="5a282-113">You can control the content of a snapshot by specifying one or more of the following values when calling this function:</span></span>

-   <span data-ttu-id="5a282-114">**TH32CS \_ снафеаплист**</span><span class="sxs-lookup"><span data-stu-id="5a282-114">**TH32CS\_SNAPHEAPLIST**</span></span>
-   <span data-ttu-id="5a282-115">**TH32CS \_ снапмодуле**</span><span class="sxs-lookup"><span data-stu-id="5a282-115">**TH32CS\_SNAPMODULE**</span></span>
-   <span data-ttu-id="5a282-116">**TH32CS \_ снаппроцесс**</span><span class="sxs-lookup"><span data-stu-id="5a282-116">**TH32CS\_SNAPPROCESS**</span></span>
-   <span data-ttu-id="5a282-117">**TH32CS \_ снапсреад**</span><span class="sxs-lookup"><span data-stu-id="5a282-117">**TH32CS\_SNAPTHREAD**</span></span>

<span data-ttu-id="5a282-118">Значения **TH32CS \_ Снафеаплист** и **TH32CS \_ снапмодуле** обрабатываются отдельно.</span><span class="sxs-lookup"><span data-stu-id="5a282-118">The **TH32CS\_SNAPHEAPLIST** and **TH32CS\_SNAPMODULE** values are process specific.</span></span> <span data-ttu-id="5a282-119">Если эти значения заданы, то списки кучи и модулей указанного процесса включаются в моментальный снимок.</span><span class="sxs-lookup"><span data-stu-id="5a282-119">When these values are specified, the heap and module lists of the specified process are included in the snapshot.</span></span> <span data-ttu-id="5a282-120">Если в качестве идентификатора процесса указать нуль, используется текущий процесс.</span><span class="sxs-lookup"><span data-stu-id="5a282-120">If you specify zero as the process identifier, the current process is used.</span></span> <span data-ttu-id="5a282-121">Значение **TH32CS \_ снапсреад** всегда создает моментальный снимок на уровне системы, даже если идентификатор процесса передается в [**CreateToolhelp32Snapshot**](/windows/desktop/api/TlHelp32/nf-tlhelp32-createtoolhelp32snapshot).</span><span class="sxs-lookup"><span data-stu-id="5a282-121">The **TH32CS\_SNAPTHREAD** value always creates a system-wide snapshot even if a process identifier is passed to [**CreateToolhelp32Snapshot**](/windows/desktop/api/TlHelp32/nf-tlhelp32-createtoolhelp32snapshot).</span></span>

<span data-ttu-id="5a282-122">Чтобы перечислить кучу или состояние модуля для всех процессов, укажите значение **TH32CS \_ снапалл** и идентификатор процесса текущего процесса.</span><span class="sxs-lookup"><span data-stu-id="5a282-122">To enumerate the heap or module state for all processes, specify the **TH32CS\_SNAPALL** value and the process identifier of the current process.</span></span> <span data-ttu-id="5a282-123">Затем для каждого дополнительного процесса в моментальном снимке вызовите [**CreateToolhelp32Snapshot**](/windows/desktop/api/TlHelp32/nf-tlhelp32-createtoolhelp32snapshot) еще раз, указав идентификатор процесса и значение **TH32CS \_ снафеаплист** или **TH32CS \_ снапмодуле** .</span><span class="sxs-lookup"><span data-stu-id="5a282-123">Then, for each additional process in the snapshot, call [**CreateToolhelp32Snapshot**](/windows/desktop/api/TlHelp32/nf-tlhelp32-createtoolhelp32snapshot) again, specifying its process identifier and the **TH32CS\_SNAPHEAPLIST** or **TH32CS\_SNAPMODULE** value.</span></span>

<span data-ttu-id="5a282-124">Код расширенного состояния ошибки для [**CreateToolhelp32Snapshot**](/windows/desktop/api/TlHelp32/nf-tlhelp32-createtoolhelp32snapshot) можно получить с помощью функции [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) .</span><span class="sxs-lookup"><span data-stu-id="5a282-124">You can retrieve an extended error status code for [**CreateToolhelp32Snapshot**](/windows/desktop/api/TlHelp32/nf-tlhelp32-createtoolhelp32snapshot) by using the [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) function.</span></span>

<span data-ttu-id="5a282-125">Когда процесс завершит использование моментального снимка, удалите его с помощью функции [**CloseHandle**](/windows/desktop/api/handleapi/nf-handleapi-closehandle) .</span><span class="sxs-lookup"><span data-stu-id="5a282-125">When your process finishes using a snapshot, destroy it using the [**CloseHandle**](/windows/desktop/api/handleapi/nf-handleapi-closehandle) function.</span></span> <span data-ttu-id="5a282-126">Если не уничтожить моментальный снимок, то процесс будет утечкой памяти до тех пор, пока он не завершит работу, после чего система освободит память.</span><span class="sxs-lookup"><span data-stu-id="5a282-126">If you do not destroy a snapshot, the process will leak memory until the it exits, at which time the system reclaims the memory.</span></span>

> [!Note]  
> <span data-ttu-id="5a282-127">Обработчик моментальных снимков выступает в качестве маркера файла и подчиняется тем же правилам, что и для процессов и потоков, в которых он может использоваться.</span><span class="sxs-lookup"><span data-stu-id="5a282-127">The snapshot handle acts like a file handle and is subject to the same rules regarding the processes and threads in which it can be used.</span></span> <span data-ttu-id="5a282-128">Чтобы указать, что маркер наследуется, Создайте моментальный снимок, используя значение **\_ inherit TH32CS** .</span><span class="sxs-lookup"><span data-stu-id="5a282-128">To specify that the handle is inheritable, create the snapshot using the **TH32CS\_INHERIT** value.</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="5a282-129">См. также</span><span class="sxs-lookup"><span data-stu-id="5a282-129">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5a282-130">Создание моментального снимка и Просмотр процессов</span><span class="sxs-lookup"><span data-stu-id="5a282-130">Taking a Snapshot and Viewing Processes</span></span>](taking-a-snapshot-and-viewing-processes.md)
</dt> </dl>

 

 