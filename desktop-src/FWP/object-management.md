---
title: Управление объектами
description: В этом разделе рассматривается правильное использование типов объектов API платформы фильтрации Windows (WFP).
ms.assetid: 2625ef9a-0e62-4e21-ba93-047965d0d782
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: dc41560bb85a7e79c0262d77c0b34fe6c1d9bfd6
ms.sourcegitcommit: ebd3ce6908ff865f1ef66f2fc96769be0aad82e1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2020
ms.locfileid: "104487616"
---
# <a name="object-management"></a><span data-ttu-id="07460-103">Управление объектами</span><span class="sxs-lookup"><span data-stu-id="07460-103">Object Management</span></span>

<span data-ttu-id="07460-104">В этом разделе рассматривается правильное использование типов объектов API платформы фильтрации Windows (WFP).</span><span class="sxs-lookup"><span data-stu-id="07460-104">This section covers the correct use of Windows Filtering Platform (WFP) API object types.</span></span>

## <a name="sessions"></a><span data-ttu-id="07460-105">Сеансы</span><span class="sxs-lookup"><span data-stu-id="07460-105">Sessions</span></span>

<span data-ttu-id="07460-106">API WFP ориентирован на сеанс, и большинство вызовов функций выполняются в контексте сеанса.</span><span class="sxs-lookup"><span data-stu-id="07460-106">The WFP API is session-oriented, and most function calls are made within the context of a session.</span></span> <span data-ttu-id="07460-107">Новый сеанс клиента создается путем вызова [**FwpmEngineOpen0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmengineopen0).</span><span class="sxs-lookup"><span data-stu-id="07460-107">A new client session is created by calling [**FwpmEngineOpen0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmengineopen0).</span></span> <span data-ttu-id="07460-108">Сеанс завершается либо при вызове клиентом [**FwpmEngineClose0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmengineclose0) , либо при завершении клиентского процесса.</span><span class="sxs-lookup"><span data-stu-id="07460-108">The session ends either when the client calls [**FwpmEngineClose0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmengineclose0) or the client process terminates.</span></span> <span data-ttu-id="07460-109">Когда сеанс уничтожается либо по назначению, либо с помощью очистки RPC, базовый модуль фильтрации (BFE) сначала прерывает существующую транзакцию.</span><span class="sxs-lookup"><span data-stu-id="07460-109">When a session is destroyed, either on purpose or by the RPC rundown, the Base Filtering Engine (BFE) first aborts any existing transaction.</span></span>

<span data-ttu-id="07460-110">При создании нового сеанса вызывающий объект может создать динамический сеанс путем передачи динамического флага [**\_ \_ флага сеанса \_ фвпм**](/windows/desktop/api/Fwpmtypes/ns-fwpmtypes-fwpm_session0) в [**FwpmEngineOpen0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmengineopen0).</span><span class="sxs-lookup"><span data-stu-id="07460-110">When creating a new session, the caller can create a dynamic session by passing the [**FWPM\_SESSION\_FLAG\_DYNAMIC**](/windows/desktop/api/Fwpmtypes/ns-fwpmtypes-fwpm_session0) flag to [**FwpmEngineOpen0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmengineopen0).</span></span> <span data-ttu-id="07460-111">Все объекты, добавленные во время динамического сеанса, автоматически удаляются по окончании сеанса.</span><span class="sxs-lookup"><span data-stu-id="07460-111">Any objects added during a dynamic session are automatically deleted when the session ends.</span></span>

## <a name="transactions"></a><span data-ttu-id="07460-112">Transactions</span><span class="sxs-lookup"><span data-stu-id="07460-112">Transactions</span></span>

<span data-ttu-id="07460-113">API WFP является транзакционным, и большинство вызовов функций выполняется в контексте транзакции.</span><span class="sxs-lookup"><span data-stu-id="07460-113">The WFP API is transactional, and most function calls are made within the context of a transaction.</span></span> <span data-ttu-id="07460-114">Вызывающие объекты могут использовать [**FwpmTransactionBegin0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmtransactionbegin0), [**FwpmTransactionCommit0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmtransactioncommit0)и [**FwpmTransactionAbort0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmtransactionabort0) для явного управления транзакциями.</span><span class="sxs-lookup"><span data-stu-id="07460-114">Callers can use [**FwpmTransactionBegin0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmtransactionbegin0), [**FwpmTransactionCommit0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmtransactioncommit0), and [**FwpmTransactionAbort0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmtransactionabort0) to explicitly control transactions.</span></span> <span data-ttu-id="07460-115">Однако если вызов функции выполняется за пределами явной транзакции, он будет выполнен в неявной транзакции.</span><span class="sxs-lookup"><span data-stu-id="07460-115">However, if a function call is made outside of an explicit transaction, it will be executed within an implicit transaction.</span></span> <span data-ttu-id="07460-116">Если транзакция выполняется, то при завершении сеанса она автоматически прерывается.</span><span class="sxs-lookup"><span data-stu-id="07460-116">If a transaction is in progress, when a session terminates, it is automatically aborted.</span></span> <span data-ttu-id="07460-117">Неявные транзакции никогда не прерываются.</span><span class="sxs-lookup"><span data-stu-id="07460-117">Implicit transactions are never forcibly aborted.</span></span>

<span data-ttu-id="07460-118">Транзакции доступны только для чтения или для чтения и записи и обеспечивают строгую целостность изолированной устойчивой ([ACID](../cossdk/acid-properties.md)) семантики.</span><span class="sxs-lookup"><span data-stu-id="07460-118">Transactions are either read-only or read/write and enforce rigorous Atomic Consistent Isolated Durable ([ACID](../cossdk/acid-properties.md)) semantics.</span></span>

<span data-ttu-id="07460-119">Каждый сеанс клиента одновременно может иметь только одну транзакцию.</span><span class="sxs-lookup"><span data-stu-id="07460-119">Each client session can have only one transaction in progress at a time.</span></span> <span data-ttu-id="07460-120">Если вызывающий объект пытается начать вторую транзакцию перед фиксацией или прерыванием первой транзакции, процедура BFE возвращает ошибку.</span><span class="sxs-lookup"><span data-stu-id="07460-120">If the caller attempts to begin a second transaction before committing or aborting the first, BFE returns an error.</span></span>

<span data-ttu-id="07460-121">Если операция завершается ошибкой в ходе транзакции, она не влияет на общее состояние транзакции.</span><span class="sxs-lookup"><span data-stu-id="07460-121">If an operation fails during the course of a transaction, it does not affect the overall state of the transaction.</span></span> <span data-ttu-id="07460-122">Например, предположим, что клиент начинает транзакцию и успешно вызывает [**FwpmFilterAdd0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmfilteradd0) три раза перед тем, как четвертый вызов завершается неудачей.</span><span class="sxs-lookup"><span data-stu-id="07460-122">For example, suppose the client begins a transaction and successfully calls [**FwpmFilterAdd0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmfilteradd0) three times before a fourth call fails.</span></span> <span data-ttu-id="07460-123">Теперь у клиента есть возможность:</span><span class="sxs-lookup"><span data-stu-id="07460-123">The client now has the option of:</span></span>

-   <span data-ttu-id="07460-124">Прерывание транзакции. в этом случае ни один из фильтров не будет добавлен.</span><span class="sxs-lookup"><span data-stu-id="07460-124">Aborting the transaction, in which case none of the filters will be added.</span></span>
-   <span data-ttu-id="07460-125">Фиксация транзакции. в этом случае будут добавлены первые три фильтра.</span><span class="sxs-lookup"><span data-stu-id="07460-125">Committing the transaction, in which case the first three filters will be added.</span></span>
-   <span data-ttu-id="07460-126">Продолжение работы с дополнительными операциями, включая потенциально повторное выполнение неудачных [**FwpmFilterAdd0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmfilteradd0).</span><span class="sxs-lookup"><span data-stu-id="07460-126">Continuing with more operations including potentially retrying the failed [**FwpmFilterAdd0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmfilteradd0).</span></span>

<span data-ttu-id="07460-127">При начале транзакции BFE будет ожидать истечения срока действия [**ткснваиттимеаутинмсек**](/windows/desktop/api/Fwpmtypes/ns-fwpmtypes-fwpm_session0) сеанса, чтобы получить блокировку.</span><span class="sxs-lookup"><span data-stu-id="07460-127">When beginning a transaction, BFE will wait until the session's [**txnWaitTimeoutInMSec**](/windows/desktop/api/Fwpmtypes/ns-fwpmtypes-fwpm_session0) expires to acquire the lock.</span></span> <span data-ttu-id="07460-128">Если блокировка не получена в течение этого времени, то получение блокировки (и вызов [**FwpmTransactionBegin0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmtransactionbegin0) ) завершится ошибкой.</span><span class="sxs-lookup"><span data-stu-id="07460-128">If the lock is not acquired within this time, the lock acquisition (and the [**FwpmTransactionBegin0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmtransactionbegin0) call) will fail.</span></span> <span data-ttu-id="07460-129">Это предотвращает неопределенное завершение ответа клиентов.</span><span class="sxs-lookup"><span data-stu-id="07460-129">This prevents clients from indefinitely failing to respond.</span></span> <span data-ttu-id="07460-130">Если клиент не указал время ожидания блокировки, по умолчанию он равен 15 секундам.</span><span class="sxs-lookup"><span data-stu-id="07460-130">If the client did not specify a lock timeout, it defaults to 15 seconds.</span></span>

<span data-ttu-id="07460-131">Каждая транзакция также имеет время ожидания блокировки.</span><span class="sxs-lookup"><span data-stu-id="07460-131">Each transaction also has a lock timeout.</span></span> <span data-ttu-id="07460-132">Это максимальное время, в течение которого может владеть блокировка.</span><span class="sxs-lookup"><span data-stu-id="07460-132">This is the maximum amount of time that it can own the lock.</span></span> <span data-ttu-id="07460-133">Если владелец не снимает блокировку в течение этого времени, транзакция принудительно прерывается, что приводит к освобождению блокировки.</span><span class="sxs-lookup"><span data-stu-id="07460-133">If the owner does not release the lock within this time, the transaction is forcibly aborted, causing the lock to be released.</span></span> <span data-ttu-id="07460-134">Время ожидания блокировки не настраивается.</span><span class="sxs-lookup"><span data-stu-id="07460-134">The lock timeout is not configurable.</span></span> <span data-ttu-id="07460-135">Он бесконечен для вызывающих объектов в режиме ядра и один час для вызывающих методов пользовательского режима.</span><span class="sxs-lookup"><span data-stu-id="07460-135">It is infinite for kernel-mode callers and one hour for user-mode callers.</span></span> <span data-ttu-id="07460-136">Если транзакция принудительно прерывается, следующий вызов, выполненный в этой транзакции, завершится с ошибкой **FWP \_ E \_ транзакция \_**.</span><span class="sxs-lookup"><span data-stu-id="07460-136">If a transaction is forcibly aborted, the next call made within that transaction will fail with **FWP\_E\_TXN\_ABORTED**.</span></span>

## <a name="object-lifetimes"></a><span data-ttu-id="07460-137">Время существования объекта</span><span class="sxs-lookup"><span data-stu-id="07460-137">Object Lifetimes</span></span>

<span data-ttu-id="07460-138">Объекты могут иметь одно из четырех возможных значений времени существования:</span><span class="sxs-lookup"><span data-stu-id="07460-138">Objects can have one of four possible lifetimes:</span></span>

-   <span data-ttu-id="07460-139">Dynamic — объект является динамическим, только если он добавлен с помощью динамического обработчика сеанса.</span><span class="sxs-lookup"><span data-stu-id="07460-139">Dynamic — An object is dynamic only if it is added using a dynamic session handle.</span></span> <span data-ttu-id="07460-140">Динамические объекты становятся активными до тех пор, пока они не будут удалены или не завершится сеансом-владельцем.</span><span class="sxs-lookup"><span data-stu-id="07460-140">Dynamic objects live until they are deleted or the owning session terminates.</span></span>
-   <span data-ttu-id="07460-141">Static — объекты по умолчанию статичны.</span><span class="sxs-lookup"><span data-stu-id="07460-141">Static — Objects are static by default.</span></span> <span data-ttu-id="07460-142">Статические объекты находятся в рабочем режиме до тех пор, пока они не будут удалены, BFE прекращается или система завершает работу.</span><span class="sxs-lookup"><span data-stu-id="07460-142">Static objects live until they are deleted, BFE stops, or the system is shutdown.</span></span>
-   <span data-ttu-id="07460-143">Persistent — постоянные объекты создаются путем передачи соответствующего **\_ \* \_ \_ постоянного** флага фвпм в функцию **\* Add0 фвпм** .</span><span class="sxs-lookup"><span data-stu-id="07460-143">Persistent — Persistent objects are created by passing the appropriate **FWPM\_\*\_FLAG\_PERSISTENT** flag to an **Fwpm\*Add0** function.</span></span> <span data-ttu-id="07460-144">Постоянные объекты, пока они не будут удалены.</span><span class="sxs-lookup"><span data-stu-id="07460-144">Persistent objects live until they are deleted.</span></span>
-   <span data-ttu-id="07460-145">Встроенные, встроенные объекты предопределены с помощью BFE и не могут быть добавлены или удалены.</span><span class="sxs-lookup"><span data-stu-id="07460-145">Built-in — Built-in objects are predefined by BFE and cannot be added or deleted.</span></span> <span data-ttu-id="07460-146">Они бесконечно прожить.</span><span class="sxs-lookup"><span data-stu-id="07460-146">They live forever.</span></span>

<span data-ttu-id="07460-147">Фильтры в режиме ядра можно пометить как фильтры времени загрузки, передав соответствующий флаг в [**FwpmFilterAdd0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmfilteradd0).</span><span class="sxs-lookup"><span data-stu-id="07460-147">Filters in kernel-mode layers can be marked as boot-time filters by passing the appropriate flag to [**FwpmFilterAdd0**](/windows/desktop/api/Fwpmu/nf-fwpmu-fwpmfilteradd0).</span></span> <span data-ttu-id="07460-148">Фильтры времени загрузки добавляются в систему при запуске драйвера TCP/IP и удаляются после завершения инициализации BFE.</span><span class="sxs-lookup"><span data-stu-id="07460-148">Boot-time filters are added to the system when the TCP/IP driver starts, and removed when BFE finishes initialization.</span></span> <span data-ttu-id="07460-149">Постоянные объекты добавляются при запуске BFE.</span><span class="sxs-lookup"><span data-stu-id="07460-149">Persistent objects are added when BFE starts.</span></span>

<span data-ttu-id="07460-150">Во многих случаях поставщик политики может не требовать принудительного применения его постоянной политики, если поставщик был отключен.</span><span class="sxs-lookup"><span data-stu-id="07460-150">In many cases, a policy provider may not want its persistent policy enforced if the provider has been disabled.</span></span> <span data-ttu-id="07460-151">При добавлении поставщика вызывающий объект может указать необязательное имя службы Windows.</span><span class="sxs-lookup"><span data-stu-id="07460-151">When adding a provider, the caller can specify an optional Windows service name.</span></span> <span data-ttu-id="07460-152">При добавлении постоянных объектов вызывающий может дополнительно указать поставщика, который "владеет" этим объектом.</span><span class="sxs-lookup"><span data-stu-id="07460-152">When adding persistent objects, the caller can optionally specify the provider that "owns" that object.</span></span> <span data-ttu-id="07460-153">При запуске службы BFE добавляет в систему только постоянные объекты, если они не связаны с поставщиком, или у связанного поставщика нет имени службы Windows или если для связанной службы Windows задан автоматический запуск.</span><span class="sxs-lookup"><span data-stu-id="07460-153">At service start, BFE only adds persistent objects to the system if they are not associated with a provider, or the associated provider has no Windows service name, or the associated Windows service is set to auto-start.</span></span>

## <a name="object-associations"></a><span data-ttu-id="07460-154">Ассоциации объектов</span><span class="sxs-lookup"><span data-stu-id="07460-154">Object Associations</span></span>

<span data-ttu-id="07460-155">Некоторые объекты имеют ссылки на другие объекты.</span><span class="sxs-lookup"><span data-stu-id="07460-155">Some objects have references to other objects.</span></span> <span data-ttu-id="07460-156">Например, фильтр всегда ссылается на слой и может ссылаться на выноску и контекст поставщика.</span><span class="sxs-lookup"><span data-stu-id="07460-156">For example, a filter always references a layer and may reference a callout and a provider context.</span></span> <span data-ttu-id="07460-157">Объекты не могут ссылаться на объекты, которые могут иметь более короткое время существования.</span><span class="sxs-lookup"><span data-stu-id="07460-157">Objects cannot refer to objects that may have a shorter lifetime.</span></span> <span data-ttu-id="07460-158">Таким же, динамический объект не может ссылаться на динамический объект из другого сеанса.</span><span class="sxs-lookup"><span data-stu-id="07460-158">Thus, a dynamic object cannot refer to a dynamic object from a different session.</span></span> <span data-ttu-id="07460-159">Статический объект не может ссылаться на динамический объект.</span><span class="sxs-lookup"><span data-stu-id="07460-159">A static object cannot refer to a dynamic object.</span></span> <span data-ttu-id="07460-160">Постоянный объект не может ссылаться на динамический объект, статический объект или постоянный объект, принадлежащий другому поставщику.</span><span class="sxs-lookup"><span data-stu-id="07460-160">A persistent object cannot refer to a dynamic object, a static object, or a persistent object owned by a different provider.</span></span>

<span data-ttu-id="07460-161">Объект нельзя удалить, пока не будут удалены все объекты, ссылающиеся на него.</span><span class="sxs-lookup"><span data-stu-id="07460-161">An object cannot be deleted until all objects that reference it have first been deleted.</span></span>

## <a name="luids-and-guids"></a><span data-ttu-id="07460-162">LUID и идентификаторы GUID</span><span class="sxs-lookup"><span data-stu-id="07460-162">LUIDs and GUIDs</span></span>

<span data-ttu-id="07460-163">Все объекты API WFP в пользовательском режиме (ФВПМ) идентифицируются глобальным уникальным идентификатором (**GUID**) и ссылаются на другие объекты по их **идентификаторам GUID**.</span><span class="sxs-lookup"><span data-stu-id="07460-163">All user mode WFP API objects (FWPM) are identified by a globally unique identifier (**GUID**) and reference other objects by their **GUID** s.</span></span> <span data-ttu-id="07460-164">**Идентификатор GUID** должен быть уникальным только в пределах типа объекта.</span><span class="sxs-lookup"><span data-stu-id="07460-164">The **GUID** need only be unique within the object type.</span></span> <span data-ttu-id="07460-165">Например, фильтр и контекст поставщика могут иметь один и тот же **GUID**, но два фильтра не могут.</span><span class="sxs-lookup"><span data-stu-id="07460-165">For example, a filter and a provider context can have the same **GUID**, but two filters cannot.</span></span> <span data-ttu-id="07460-166">При добавлении нового объекта вызывающие объекты могут назначить **идентификатор GUID** объекта или оставить его инициализированным нулем и позволить BFE назначить **идентификатор GUID**.</span><span class="sxs-lookup"><span data-stu-id="07460-166">When adding a new object, callers can assign the object's **GUID** or leave it zero-initialized and let BFE assign the **GUID**.</span></span>

<span data-ttu-id="07460-167">Все объекты API WFP в режиме ядра (ФВПС) идентифицируются локально уникальным идентификатором (**LUID**) и ссылаются на другие объекты по их LUID.</span><span class="sxs-lookup"><span data-stu-id="07460-167">All kernel mode WFP API objects (FWPS) are identified by a locally unique identifier (**LUID**) and reference other objects by their LUID.</span></span> <span data-ttu-id="07460-168">Переключение с **GUID** на **LUID** позволяет WFP сохранять нестраничный пул и оптимизировать обработку во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="07460-168">The switch from **GUID** to **LUID** enables WFP to conserve non-paged pool and optimize run-time processing.</span></span> <span data-ttu-id="07460-169">Ширина **LUID** зависит от типа объекта и диапазонов от **UINT16** до **UINT64**.</span><span class="sxs-lookup"><span data-stu-id="07460-169">The width of the **LUID** depends on the object type and ranges from a **UINT16** to a **UINT64**.</span></span> <span data-ttu-id="07460-170">**LUID** всегда назначается BFE.</span><span class="sxs-lookup"><span data-stu-id="07460-170">**LUID** s are always assigned by BFE.</span></span>

 

 