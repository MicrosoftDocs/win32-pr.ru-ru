---
title: Использование сведений о версии
description: В этом разделе рассматривается использование функций сведений о версии.
ms.assetid: 447b57c9-9e94-4a28-897e-f7b87d9cb25a
keywords:
- ресурсы, сведения о версии
- сведения о версии
- сведения о файле установки
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1a8785275f5aac69218989250d1c0f83e0a1ff9f
ms.sourcegitcommit: ebd3ce6908ff865f1ef66f2fc96769be0aad82e1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2020
ms.locfileid: "103790242"
---
# <a name="using-version-information"></a><span data-ttu-id="a27c0-106">Использование сведений о версии</span><span class="sxs-lookup"><span data-stu-id="a27c0-106">Using Version Information</span></span>

<span data-ttu-id="a27c0-107">Программа установки обычно имеет следующие цели:</span><span class="sxs-lookup"><span data-stu-id="a27c0-107">An installation program typically has the following goals:</span></span>

-   <span data-ttu-id="a27c0-108">Размещение файлов в правильном расположении.</span><span class="sxs-lookup"><span data-stu-id="a27c0-108">To place files in the correct location.</span></span>
-   <span data-ttu-id="a27c0-109">Для уведомления пользователя, если программа установки заменяет существующий файл значительно отличающейся версией (например, замените файл на немецком языке файлом на английском языке) или замените более новый файл более старым.</span><span class="sxs-lookup"><span data-stu-id="a27c0-109">To notify the user if the installation program is replacing an existing file with a version that is significantly different—for example, replacing a German-language file with an English-language file, or replacing a newer file with an older file.</span></span>

<span data-ttu-id="a27c0-110">При написании программы установки необходимо иметь следующие сведения для каждого файла:</span><span class="sxs-lookup"><span data-stu-id="a27c0-110">When writing the installation program, you must have the following information for each file:</span></span>

-   <span data-ttu-id="a27c0-111">Имя и расположение файла (называемого исходным файлом).</span><span class="sxs-lookup"><span data-stu-id="a27c0-111">The name and location of the file (referred to as the source file).</span></span>
-   <span data-ttu-id="a27c0-112">Имя эквивалентного файла на жестком диске пользователя (который называется файлом назначения).</span><span class="sxs-lookup"><span data-stu-id="a27c0-112">The name of the equivalent file on the user's hard disk (referred to as the destination file).</span></span> <span data-ttu-id="a27c0-113">Обычно это имя совпадает с именем файла на установочном диске.</span><span class="sxs-lookup"><span data-stu-id="a27c0-113">This name is usually the same as the filename on the installation disk.</span></span>
-   <span data-ttu-id="a27c0-114">Состояние общего доступа к файлу — то есть, является ли файл частным для устанавливаемого приложения или может совместно использоваться несколькими приложениями.</span><span class="sxs-lookup"><span data-stu-id="a27c0-114">The sharing status of the file—that is, whether the file is private to the application being installed or could be shared by multiple applications.</span></span>

<span data-ttu-id="a27c0-115">Программа установки может использовать функцию [**верфиндфиле**](/windows/desktop/api/Winver/nf-winver-verfindfilea) для определения места копирования файла на диск.</span><span class="sxs-lookup"><span data-stu-id="a27c0-115">The installation program can use the [**VerFindFile**](/windows/desktop/api/Winver/nf-winver-verfindfilea) function to determine where the file should be copied on the disk.</span></span> <span data-ttu-id="a27c0-116">Эта функция также может использоваться для указания того, является ли файл частным для приложения или может быть общим.</span><span class="sxs-lookup"><span data-stu-id="a27c0-116">This function can also be used to specify whether the file is private to the application or can be shared.</span></span> <span data-ttu-id="a27c0-117">Если при поиске файла возникает проблема, **верфиндфиле** возвращает значение ошибки.</span><span class="sxs-lookup"><span data-stu-id="a27c0-117">If a problem occurs in finding the file, **VerFindFile** returns an error value.</span></span> <span data-ttu-id="a27c0-118">Например, если система использует файл назначения, **верфиндфиле** возвращает **ВФФ \_ филеинусе**.</span><span class="sxs-lookup"><span data-stu-id="a27c0-118">For example, if the system is using the destination file, **VerFindFile** returns **VFF\_FILEINUSE**.</span></span> <span data-ttu-id="a27c0-119">Программа установки должна уведомить пользователя о проблеме и ответить на решение пользователя продолжить или завершить установку.</span><span class="sxs-lookup"><span data-stu-id="a27c0-119">The installation program must notify the user of the problem and respond to the user's decision to continue or to end the installation.</span></span>

<span data-ttu-id="a27c0-120">Функция [**веринсталлфиле**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) копирует исходный файл во временный файл в каталоге, указанном параметром [**верфиндфиле**](/windows/desktop/api/Winver/nf-winver-verfindfilea).</span><span class="sxs-lookup"><span data-stu-id="a27c0-120">The [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) function copies the source file to a temporary file in the directory specified by [**VerFindFile**](/windows/desktop/api/Winver/nf-winver-verfindfilea).</span></span> <span data-ttu-id="a27c0-121">При необходимости **веринсталлфиле** расширяет файл с помощью функций в библиотеке распаковки данных.</span><span class="sxs-lookup"><span data-stu-id="a27c0-121">If necessary, **VerInstallFile** expands the file by using the functions in the data decompression library.</span></span>

<span data-ttu-id="a27c0-122">[**Веринсталлфиле**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) сравнивает сведения о версии временного файла с целевым файлом.</span><span class="sxs-lookup"><span data-stu-id="a27c0-122">[**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) compares the version information of the temporary file to that of the destination file.</span></span> <span data-ttu-id="a27c0-123">Если эти две различаются, **веринсталлфиле** возвращает одно или несколько значений ошибок.</span><span class="sxs-lookup"><span data-stu-id="a27c0-123">If the two differ, **VerInstallFile** returns one or more error values.</span></span> <span data-ttu-id="a27c0-124">Например, он возвращает **ВИФ \_ срколд** , если временный файл старше целевого файла, и **ВИФ \_ диффланг** , если файлы имеют разные идентификаторы языка или значения кодовой страницы.</span><span class="sxs-lookup"><span data-stu-id="a27c0-124">For example, it returns **VIF\_SRCOLD** if the temporary file is older than the destination file and **VIF\_DIFFLANG** if the files have different language identifiers or code-page values.</span></span> <span data-ttu-id="a27c0-125">Программа установки должна уведомить пользователя о проблеме и ответить на решение пользователя продолжить или завершить установку.</span><span class="sxs-lookup"><span data-stu-id="a27c0-125">The installation program must notify the user of the problem and respond to the user's decision to continue or to end the installation.</span></span>

<span data-ttu-id="a27c0-126">Некоторые ошибки [**веринсталлфиле**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) могут быть восстановлены.</span><span class="sxs-lookup"><span data-stu-id="a27c0-126">Some [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) errors are recoverable.</span></span> <span data-ttu-id="a27c0-127">Это значит, что программа установки может снова вызвать **веринсталлфиле** , указав параметр **ВИФФ \_ форцеинсталл** , чтобы установить файл независимо от конфликта версий.</span><span class="sxs-lookup"><span data-stu-id="a27c0-127">That is, the installation program can call **VerInstallFile** again, specifying the **VIFF\_FORCEINSTALL** option, to install the file regardless of the version conflict.</span></span> <span data-ttu-id="a27c0-128">Если **веринсталлфиле** возвращает **ВИФ \_ темпфиле** и пользователь решил не устанавливать принудительную установку, программа установки должна удалить временный файл.</span><span class="sxs-lookup"><span data-stu-id="a27c0-128">If **VerInstallFile** returns **VIF\_TEMPFILE** and the user chooses not to force the installation, the installation program should delete the temporary file.</span></span>

<span data-ttu-id="a27c0-129">[**Веринсталлфиле**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) может столкнуться с неустранимой ошибкой при попытке принудительной установки, даже если эта ошибка не существовала ранее.</span><span class="sxs-lookup"><span data-stu-id="a27c0-129">[**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) could encounter a nonrecoverable error when attempting to force installation, even though the error did not exist previously.</span></span> <span data-ttu-id="a27c0-130">Например, файл может быть заблокирован другим пользователем до того, как программа установки попытается принудительно выполнить установку.</span><span class="sxs-lookup"><span data-stu-id="a27c0-130">For example, the file could be locked by another user before the installation program attempted to force installation.</span></span> <span data-ttu-id="a27c0-131">Если программа установки пытается принудительно выполнить установку после неустранимой ошибки, **веринсталлфиле** завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="a27c0-131">If an installation program attempts to force installation after a non-recoverable error, **VerInstallFile** fails.</span></span> <span data-ttu-id="a27c0-132">Программа установки должна содержать подпрограммы для восстановления после ошибки такого типа.</span><span class="sxs-lookup"><span data-stu-id="a27c0-132">The installation program must contain routines to recover from this type of error.</span></span>

<span data-ttu-id="a27c0-133">Рекомендуемым решением является отображение диалогового окна с кнопками **установить**, **пропустить** и **установить все**.</span><span class="sxs-lookup"><span data-stu-id="a27c0-133">The recommended solution is to display a dialog box with the buttons **Install**, **Skip**, and **Install All**.</span></span> <span data-ttu-id="a27c0-134">(Другое решение — это диалоговое окно с кнопками **Да**, **Да для всех**, **пропустить** и **Отмена**.) Кнопка **установить все** не позволит программе установки выдать запрос на ввод похожих ошибок, включив параметр **ВИФФ \_ форцеинсталл** во всех последующих применениях [**веринсталлфиле**](/windows/desktop/api/Winver/nf-winver-verinstallfilea).</span><span class="sxs-lookup"><span data-stu-id="a27c0-134">(Another solution is a dialog box with the buttons **Yes**, **Yes to All**, **Skip**, and **Cancel**.) The **Install All** button should prevent the installation program from prompting the user about similar errors by including the **VIFF\_FORCEINSTALL** option in all subsequent uses of [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea).</span></span> <span data-ttu-id="a27c0-135">Для неустранимых ошибок кнопки **установить** и **установить все** должны быть отключены.</span><span class="sxs-lookup"><span data-stu-id="a27c0-135">For nonrecoverable errors, the **Install** and **Install All** buttons should be disabled.</span></span>

<span data-ttu-id="a27c0-136">Чтобы отобразить полезное сообщение об ошибке для пользователя, программа установки обычно должна получить сведения из ресурсов версий конфликтующих файлов.</span><span class="sxs-lookup"><span data-stu-id="a27c0-136">To display a useful error message to the user, the installation program usually must retrieve information from the version resources of the conflicting files.</span></span> <span data-ttu-id="a27c0-137">Для этой цели программа установки может использовать четыре функции:</span><span class="sxs-lookup"><span data-stu-id="a27c0-137">There are four functions the installation program can use for this purpose:</span></span>

-   [<span data-ttu-id="a27c0-138">**Ошибка getfileversioninfosize**</span><span class="sxs-lookup"><span data-stu-id="a27c0-138">**GetFileVersionInfoSize**</span></span>](/windows/desktop/api/Winver/nf-winver-getfileversioninfosizea)
-   [<span data-ttu-id="a27c0-139">**GetFileVersionInfo**</span><span class="sxs-lookup"><span data-stu-id="a27c0-139">**GetFileVersionInfo**</span></span>](/windows/desktop/api/Winver/nf-winver-getfileversioninfoa)
-   [<span data-ttu-id="a27c0-140">**VerQueryValue**</span><span class="sxs-lookup"><span data-stu-id="a27c0-140">**VerQueryValue**</span></span>](/windows/desktop/api/Winver/nf-winver-verqueryvaluea)
-   [<span data-ttu-id="a27c0-141">**верлангуаженаме**</span><span class="sxs-lookup"><span data-stu-id="a27c0-141">**VerLanguageName**</span></span>](/windows/desktop/api/Winver/nf-winver-verlanguagenamea)

<span data-ttu-id="a27c0-142">[**Ошибка getfileversioninfosize**](/windows/desktop/api/Winver/nf-winver-getfileversioninfosizea) возвращает размер сведений о версии.</span><span class="sxs-lookup"><span data-stu-id="a27c0-142">[**GetFileVersionInfoSize**](/windows/desktop/api/Winver/nf-winver-getfileversioninfosizea) returns the size of the version information.</span></span> <span data-ttu-id="a27c0-143">[**GetFileVersionInfo**](/windows/desktop/api/Winver/nf-winver-getfileversioninfoa) использует сведения, полученные с помощью **Ошибка getfileversioninfosize** , для получения структуры, содержащей сведения о версии.</span><span class="sxs-lookup"><span data-stu-id="a27c0-143">[**GetFileVersionInfo**](/windows/desktop/api/Winver/nf-winver-getfileversioninfoa) uses information retrieved by **GetFileVersionInfoSize** to retrieve a structure that contains the version information.</span></span> <span data-ttu-id="a27c0-144">[**Веркуеривалуе**](/windows/desktop/api/Winver/nf-winver-verqueryvaluea) извлекает из этой структуры конкретный элемент.</span><span class="sxs-lookup"><span data-stu-id="a27c0-144">[**VerQueryValue**](/windows/desktop/api/Winver/nf-winver-verqueryvaluea) retrieves a specific member from that structure.</span></span>

<span data-ttu-id="a27c0-145">Например, если [**веринсталлфиле**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) возвращает ошибку **\_ диффтипе ВИФ** , программа установки должна использовать функции [**Ошибка getfileversioninfosize**](/windows/desktop/api/Winver/nf-winver-getfileversioninfosizea), [**GetFileVersionInfo**](/windows/desktop/api/Winver/nf-winver-getfileversioninfoa)и [**веркуеривалуе**](/windows/desktop/api/Winver/nf-winver-verqueryvaluea) для временных и целевых файлов, чтобы получить общий тип каждого файла.</span><span class="sxs-lookup"><span data-stu-id="a27c0-145">For example, if [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) returns the **VIF\_DIFFTYPE** error, the installation program should use the [**GetFileVersionInfoSize**](/windows/desktop/api/Winver/nf-winver-getfileversioninfosizea), [**GetFileVersionInfo**](/windows/desktop/api/Winver/nf-winver-getfileversioninfoa), and [**VerQueryValue**](/windows/desktop/api/Winver/nf-winver-verqueryvaluea) functions on the temporary and destination files to obtain the general type of each file.</span></span> <span data-ttu-id="a27c0-146">Если языки файлов конфликтуют, программа установки также должна использовать [**верлангуаженаме**](/windows/desktop/api/Winver/nf-winver-verlanguagenamea) для перевода двоичного идентификатора языка в текстовое представление языка.</span><span class="sxs-lookup"><span data-stu-id="a27c0-146">If the languages of the files conflict, the installation program should also use [**VerLanguageName**](/windows/desktop/api/Winver/nf-winver-verlanguagenamea) to translate the binary language identifier into a text representation of the language.</span></span> <span data-ttu-id="a27c0-147">(Например, 0x040C преобразуется в строку «французский».)</span><span class="sxs-lookup"><span data-stu-id="a27c0-147">(For example, 0x040C translates to the string "French.")</span></span>

<span data-ttu-id="a27c0-148">Если [**веринсталлфиле**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) возвращает ошибку файла, например **ВИФ \_ AccessViolationException**, программа установки должна использовать функцию [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) для получения последнего значения ошибки.</span><span class="sxs-lookup"><span data-stu-id="a27c0-148">If [**VerInstallFile**](/windows/desktop/api/Winver/nf-winver-verinstallfilea) returns a file error, such as **VIF\_ACCESSVIOLATION**, the installation program should use the [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror) function to retrieve the most recent error value.</span></span> <span data-ttu-id="a27c0-149">Программа должна преобразовать это значение в информативное сообщение, отображаемое пользователю.</span><span class="sxs-lookup"><span data-stu-id="a27c0-149">The program should translate this value into an informative message to display to the user.</span></span> <span data-ttu-id="a27c0-150">Программа не должна возвращать управление между вызовами **веринсталлфиле** и **GetLastError**.</span><span class="sxs-lookup"><span data-stu-id="a27c0-150">The program must not yield control between the calls to **VerInstallFile** and **GetLastError**.</span></span>

 

 