---
title: Как AMSI помогает защититься от вредоносных программ
description: Разработчик приложения может активно участвовать в защите от вредоносных программ. В частности, вы можете защитить своих клиентов от вредоносных программ на основе динамических сценариев, а также от нетрадиционных поправок кибератаках.
ms.topic: article
ms.date: 02/27/2019
ms.openlocfilehash: 0d6aee30034312073123f5ab14b1924fd01e6eac
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "103773685"
---
# <a name="how-the-antimalware-scan-interface-amsi-helps-you-defend-against-malware"></a>Как интерфейс проверки на наличие вредоносных программ (AMSI) помогает защититься от вредоносных программ

Общие сведения о интерфейсе проверки на наличие вредоносных программ Windows (AMSI) см. в разделе [интерфейс проверки наличия вредоносных программ (AMSI)](antimalware-scan-interface-portal.md).

Разработчик приложения может активно участвовать в защите от вредоносных программ. В частности, вы можете защитить своих клиентов от вредоносных программ на основе динамических сценариев, а также от нетрадиционных поправок кибератаках.

В качестве примера предположим, что ваше приложение является сценарным: оно принимает произвольный скрипт и выполняет его через обработчик сценариев. В момент, когда сценарий готов к работе с обработчиком скриптов, приложение может вызвать API AMSI Windows, чтобы запросить проверку содержимого. Таким образом, можно безопасно определить, является ли сценарий вредоносным, прежде чем продолжить его выполнение.

Это справедливо, даже если скрипт был создан во время выполнения. Скрипт (вредоносный или другой) может пройти несколько этапов отмены запутывания. Но в конечном итоге необходимо предоставить обработчик скриптов с обычным немаскированным кодом. И это точка, в которой вызываются API-интерфейсы AMSI.

Ниже приведена иллюстрация архитектуры AMSI, в которой собственное приложение представлено одним из полей "другое приложение".

![Архитектура AMSI](images/AMSI7Archi.jpg)

Интерфейс Windows AMSI открыт. Это означает, что любое приложение может вызвать его; и любой зарегистрированный модуль защиты от вредоносных программ может обработать переданное содержимое.

Мы не, что обсуждение будет ограничено обработчиками сценариев. Возможно, приложение является приложением для обмена данными и просматривает мгновенные сообщения об обнаруженных вирусах, прежде чем оно покажет их клиентам. Или, возможно, ваше программное обеспечение — это игра, которая проверяет подключаемые модули перед установкой. Существует множество возможностей и сценариев использования AMSI.

## <a name="amsi-in-action"></a>AMSI в действии

Давайте взглянем на AMSI в действии. В этом примере защитник Windows — это приложение, вызывающее интерфейсы API AMSI. Но вы можете вызывать те же интерфейсы API из своего приложения.

Ниже приведен пример сценария, который использует методику XOR-кодирования, чтобы скрыть его намерение (независимо от того, является ли это условие мягким или нет). На этом рисунке мы можем представить, что этот сценарий был загружен из Интернета.

![Пример скрипта, закодированный в Base64](images/AMSI8.png)

Чтобы сделать кое-что более интересным, мы можем ввести этот сценарий вручную в командной строке, чтобы нет фактического файла для отслеживания. Это отражает то, что известно как «безфайловая угроза». Это не так просто, как сканирование файлов на диске. Угроза может быть программы трояныой, которая находится только в памяти компьютера.

Ниже показан результат выполнения скрипта в Windows PowerShell. Вы увидите, что защитник Windows может обнаружить пример теста AMSI в этом сложном сценарии, просто используя стандартную сигнатуру примера теста AMSI.

![Пример теста AMSI в Защитнике Windows](images/AMSI9proper.png)

## <a name="amsi-integration-with-javascriptvba"></a>Интеграция AMSI с JavaScript/VBA

Показанный ниже рабочий процесс описывает сквозной поток другого примера, в котором мы демонстрируем интеграцию AMSI с выполнением макросов в Microsoft Office.

![Интеграция AMSI с JavaScript/VBA](images/integ-js-vba.png)

- Пользователь получает документ, содержащий (вредоносный) макрос, который евадес статическое сканирование антивирусного по, применяя такие методы, как запутывания, защищенные паролем файлы и т. д.
- Затем пользователь открывает документ, содержащий макрос (вредоносный). Если документ открывается в режиме защищенного просмотра, пользователь нажимает кнопку **включить редактирование** для выхода из защищенного представления.
- Пользователь нажимает кнопку **Enable Macros (включить макросы** ), чтобы разрешить выполнение макросов.
- При выполнении макроса среда выполнения VBA использует круглый буфер для регистрации \[ 1 \] данных и параметров, связанных с вызовами интерфейсов Win32, com и VBA.
- При обнаружении конкретных API Win32 или COM, которые считаются высоким уровнем риска ( *триггеры*) \[ 2 \] , выполнение макроса прерывается, а содержимое круглого буфера передается в AMSI.
- Зарегистрированный поставщик услуг защиты от вредоносных программ AMSI реагирует на вердикт, чтобы указать, является ли поведение макроса вредоносным.
- Если поведение не является вредоносным, выполнение макроса продолжается.
- В противном случае, если поведение является вредоносным, Microsoft Office закрывает сеанс в ответ на предупреждение \[ 3 \] , а AV может помещать файл в карантин.

## <a name="what-does-this-mean-for-you"></a>Что это означает?

Для пользователей Windows Любая вредоносная программа, использующая методы запутывания и обход на встроенных в Windows 10 узлах со сценариями, автоматически проверяется на более глубоком уровне, чем когда-либо ранее, предоставляя дополнительные уровни защиты.

Разработчикам приложений следует подумать о том, что приложение должно вызывать интерфейс AMSI Windows, если вы хотите воспользоваться преимуществами (и защитить клиентов с помощью) дополнительного сканирования и анализа потенциально вредоносного содержимого.

Как поставщик антивирусного по вы можете реализовать поддержку интерфейса AMSI. Когда вы сделаете это, ваш модуль будет иметь намного более глубокое понимание данных, которые приложения (включая встроенные узлы сценариев Windows 10) могут быть потенциально вредоносными.

## <a name="more-background-info-about-fileless-threats"></a>Дополнительные сведения о безфайловых угрозах

Вы можете получить дополнительные сведения о типах безфайловых угроз, разработанных Windows AMSI для защиты от. В этом разделе мы рассмотрим традиционную игру Cat-and-Mouse, которая воспринимается в экосистеме вредоносных программ.

В качестве примера мы будем использовать PowerShell. Но вы можете использовать те же методы и процессы, которые мы продемонстрируем в любом динамическом языке &mdash; VBScript, Perl, Python, Ruby и т. д.

Ниже приведен пример вредоносного сценария PowerShell.

![Пример вредоносного сценария PowerShell](images/AMSI1.png)

Хотя этот сценарий просто записывает сообщение на экран, вредоносные программы обычно более злостный. Но вы можете легко написать подпись, чтобы обнаружить ее. Например, подпись может искать строку "Write-Host" приводится! " в любом файле, открываемом пользователем. Отлично: Мы обнаружили первую вредоносную программу!

Однако после обнаружения нашей первой сигнатурой авторы вредоносных программ будут отвечать. Они реагируют на создание динамических скриптов, таких как этот пример.

![Пример динамического скрипта](images/AMSI2.png)

В этом сценарии авторы вредоносных программ создают строку, представляющую сценарий PowerShell для выполнения. Но они используют простую методику сцепления строк для разбиения предыдущей сигнатуры. Если вы когда-либо видите источник веб-страницы Ладен, вы увидите много экземпляров этого метода, которые используются для предотвращения блокирования AD.

Наконец, автор вредоносной программы передает эту объединенную строку `Invoke-Expression` &mdash; механизму PowerShell командлета для вычисления скриптов, которые состоят или создаются во время выполнения.

В ответ программа защиты от вредоносных программ начинает выполнять базовую эмуляцию языка. Например, если мы видим две объединяемые строки, мы будем эмулировать объединение этих двух строк, а затем запустили сигнатуры в результате. К сожалению, это довольно непрочный подход, поскольку языки, как правило, предоставляют множество способов представления и сцепления строк.

Итак, после того, как эта подпись будет перехвачена, авторы вредоносных программ переходят на нечто более сложное &mdash; , например кодирование содержимого скриптов в Base64, как показано в следующем примере.

![Пример содержимого скрипта в Base64](images/AMSI3.png)

При переисточнике большинство механизмов защиты от вредоносных программ также реализуют эмуляцию декодирования Base64. Так как мы также реализуем эмуляцию декодирования Base64, мы готовы к моменту времени.

В ответ авторы вредоносных программ переходят к алгоритму запутывания, &mdash; такому как простой механизм кодирования XOR в сценариях, которые они выполняют.

![Пример скрипта алгоритма запутывания](images/AMSI4.png)

На этом этапе мы обычно работаем с тем, какие антивирусные ядра будут эмулироваться или выявляться, поэтому мы не обязательно определим, что делает этот сценарий. Однако можно начать писать подписи для методов запутывания и кодирования. На самом деле, это учетные записи для большинства подписей вредоносных программ на основе сценариев.

Но что делать, если маскировка настолько проста, что выглядит так, как многие хорошо выполняющиеся сценарии? Сигнатура для него приведет к неприемлемому числу ложных срабатываний. Ниже приведен пример сценария *этапа* , который слишком немягк для самостоятельного обнаружения.

![Пример скрипта этапа, который слишком немягк для самостоятельного обнаружения](images/AMSI5.png)

В этом примере мы скачиваем веб-страницу и получаем из нее некоторое содержимое. Ниже приведен эквивалент в сценарии Visual Basic.

![эквивалент в скрипте Visual Basic](images/AMSI6.png)

Что еще хуже в обоих этих примерах заключается в том, что антивирусный механизм проверяет файлы, открываемые пользователем. Если вредоносное содержимое находится только в памяти, возможно, атака может оказаться необнаруженной.

В этом разделе показаны ограничения на обнаружение с использованием традиционных подписей. Но хотя вредоносный сценарий может пройти несколько этапов дезапутывания, ему, в конечном итоге, необходимо предоставить обработчику сценариев простой, незамаскированный код. И на этом этапе, &mdash; как мы описывали в первом разделе на &mdash; основе встроенных в Windows 10 приложений для создания сценариев, вызывают интерфейсы API AMSI, чтобы запросить проверку этого незащищенного содержимого. И ваше приложение может сделать то же самое.

## <a name="related-resources"></a>Связанные ресурсы

* [Безфайловые угрозы](/windows/security/threat-protection/intelligence/fileless-threats)
* [Office VBA + AMSI: участие в оказывающихся вредоносных макросов](https://cloudblogs.microsoft.com/microsoftsecure/2018/09/12/office-vba-amsi-parting-the-veil-on-malicious-macros/)
* [Не все, но невидимые: уменьшение вредоносных программ без файлов с помощью мониторинга поведения, AMSI и следующего поколения AV](https://cloudblogs.microsoft.com/microsoftsecure/2018/09/27/out-of-sight-but-not-invisible-defeating-fileless-malware-with-behavior-monitoring-amsi-and-next-gen-av/)
