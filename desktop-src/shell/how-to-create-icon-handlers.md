---
description: Описывает создание обработчика для настраиваемых назначений значков.
ms.assetid: 23ed3a21-cf62-4440-b983-fae23aa56890
title: Создание обработчиков значков
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e2c620b6f6a4c05f8996a26c8365e4f4201ee0b4
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104985460"
---
# <a name="how-to-create-icon-handlers"></a><span data-ttu-id="24fb7-103">Создание обработчиков значков</span><span class="sxs-lookup"><span data-stu-id="24fb7-103">How to Create Icon Handlers</span></span>

<span data-ttu-id="24fb7-104">С [типом файла](fa-file-types.md) часто связан пользовательский значок, позволяющий легко распознать его члены в проводнике Windows.</span><span class="sxs-lookup"><span data-stu-id="24fb7-104">A [file type](fa-file-types.md) often has a custom icon associated with it, to make its members easily recognizable in Windows Explorer.</span></span> <span data-ttu-id="24fb7-105">Самый простой способ назначить пользовательский значок для типа файла — зарегистрировать файл значка.</span><span class="sxs-lookup"><span data-stu-id="24fb7-105">The simplest way to assign a custom icon to a file type is to register the icon's file.</span></span> <span data-ttu-id="24fb7-106">Однако значок, зарегистрированный таким образом, будет одинаковым для всех элементов типа файла.</span><span class="sxs-lookup"><span data-stu-id="24fb7-106">However, an icon registered in this way will be the same for all members of the file type.</span></span> <span data-ttu-id="24fb7-107">При назначении значков членам типа файлов можно обеспечить гораздо большую гибкость, реализуя *обработчик значков*.</span><span class="sxs-lookup"><span data-stu-id="24fb7-107">You can have much more flexibility in assigning icons to the members of the file type by implementing an *icon handler*.</span></span>

<span data-ttu-id="24fb7-108">Обработчик значков — это тип обработчика расширений оболочки, который позволяет динамически назначать значки элементам типа файлов.</span><span class="sxs-lookup"><span data-stu-id="24fb7-108">An icon handler is a type of Shell extension handler that allows you to dynamically assign icons to the members of a file type.</span></span> <span data-ttu-id="24fb7-109">Каждый раз, когда отображается файл типа, оболочка запрашивает у обработчика соответствующий значок.</span><span class="sxs-lookup"><span data-stu-id="24fb7-109">Every time a file of the type is displayed, the Shell queries the handler for the appropriate icon.</span></span> <span data-ttu-id="24fb7-110">Например, обработчик значков может назначать разные значки для разных элементов типа файлов или изменять значок в зависимости от текущего состояния файла.</span><span class="sxs-lookup"><span data-stu-id="24fb7-110">For instance, an icon handler can assign different icons to different members of the file type, or vary the icon based on the current state of the file.</span></span>

<span data-ttu-id="24fb7-111">Общие процедуры для реализации и регистрации обработчика расширений оболочки обсуждаются в разделе [Создание обработчиков расширений оболочки](handlers.md).</span><span class="sxs-lookup"><span data-stu-id="24fb7-111">The general procedures for implementing and registering a Shell extension handler are discussed in [Creating Shell Extension Handlers](handlers.md).</span></span> <span data-ttu-id="24fb7-112">В этом документе рассматриваются такие аспекты реализации, которые относятся к обработчикам значков.</span><span class="sxs-lookup"><span data-stu-id="24fb7-112">This document focuses on those aspects of implementation that are specific to icon handlers.</span></span>

-   [<span data-ttu-id="24fb7-113">Реализация обработчиков значков</span><span class="sxs-lookup"><span data-stu-id="24fb7-113">Implementing Icon Handlers</span></span>](#step-1-implementing-icon-handlers)
-   [<span data-ttu-id="24fb7-114">Реализация интерфейса Иекстрактикон</span><span class="sxs-lookup"><span data-stu-id="24fb7-114">Implementing the IExtractIcon Interface</span></span>](#step-2-implementing-the-iextracticon-interface)
-   [<span data-ttu-id="24fb7-115">Регистрация обработчиков значков</span><span class="sxs-lookup"><span data-stu-id="24fb7-115">Registering Icon Handlers</span></span>](#step-3-registering-icon-handlers)
-   [<span data-ttu-id="24fb7-116">См. также</span><span class="sxs-lookup"><span data-stu-id="24fb7-116">Related topics</span></span>](#related-topics)

## <a name="instructions"></a><span data-ttu-id="24fb7-117">Инструкции</span><span class="sxs-lookup"><span data-stu-id="24fb7-117">Instructions</span></span>

### <a name="step-1-implementing-icon-handlers"></a><span data-ttu-id="24fb7-118">Шаг 1. Реализация обработчиков значков</span><span class="sxs-lookup"><span data-stu-id="24fb7-118">Step 1: Implementing Icon Handlers</span></span>

<span data-ttu-id="24fb7-119">Как и все обработчики расширений оболочки, Обработчики значков — это объекты модели COM, реализованные в виде библиотек DLL.</span><span class="sxs-lookup"><span data-stu-id="24fb7-119">Like all Shell extension handlers, icon handlers are in-process Component Object Model (COM) objects implemented as DLLs.</span></span> <span data-ttu-id="24fb7-120">Помимо [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown): [**IPersistFile**](/windows/win32/api/objidl/nn-objidl-ipersistfile) и [**иекстрактикон**](/windows/win32/api/shlobj_core/nn-shlobj_core-iextracticona), они должны экспортировать два интерфейса.</span><span class="sxs-lookup"><span data-stu-id="24fb7-120">They must export two interfaces in addition to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown): [**IPersistFile**](/windows/win32/api/objidl/nn-objidl-ipersistfile) and [**IExtractIcon**](/windows/win32/api/shlobj_core/nn-shlobj_core-iextracticona).</span></span>

<span data-ttu-id="24fb7-121">Оболочка инициализирует обработчик с помощью своего интерфейса [**IPersistFile**](/windows/win32/api/objidl/nn-objidl-ipersistfile) .</span><span class="sxs-lookup"><span data-stu-id="24fb7-121">The Shell initializes the handler through its [**IPersistFile**](/windows/win32/api/objidl/nn-objidl-ipersistfile) interface.</span></span> <span data-ttu-id="24fb7-122">Он использует этот интерфейс для запроса идентификатора класса (CLSID) обработчика и предоставляет ему имя файла.</span><span class="sxs-lookup"><span data-stu-id="24fb7-122">It uses this interface to request the handler's class identifier (CLSID) and provides it with the file's name.</span></span> <span data-ttu-id="24fb7-123">Остальная часть операции выполняется через интерфейс [**иекстрактикон**](/windows/win32/api/shlobj_core/nn-shlobj_core-iextracticona) .</span><span class="sxs-lookup"><span data-stu-id="24fb7-123">The rest of the operation takes place through the [**IExtractIcon**](/windows/win32/api/shlobj_core/nn-shlobj_core-iextracticona) interface.</span></span> <span data-ttu-id="24fb7-124">Общее описание способов реализации обработчиков расширений оболочки, включая интерфейс **IPersistFile** , см. в разделе [Создание обработчиков расширений оболочки](handlers.md).</span><span class="sxs-lookup"><span data-stu-id="24fb7-124">For a general discussion of how to implement Shell extension handlers, including the **IPersistFile** interface, see [Creating Shell Extension Handlers](handlers.md).</span></span> <span data-ttu-id="24fb7-125">В оставшейся части этого документа описывается, как реализовать интерфейс **иекстрактикон** .</span><span class="sxs-lookup"><span data-stu-id="24fb7-125">The remainder of this document discusses how to implement the **IExtractIcon** interface.</span></span>

### <a name="step-2-implementing-the-iextracticon-interface"></a><span data-ttu-id="24fb7-126">Шаг 2. Реализация интерфейса Иекстрактикон</span><span class="sxs-lookup"><span data-stu-id="24fb7-126">Step 2: Implementing the IExtractIcon Interface</span></span>

<span data-ttu-id="24fb7-127">После инициализации интерфейса оболочка использует интерфейс [**иекстрактикон**](/windows/win32/api/shlobj_core/nn-shlobj_core-iextracticona) обработчика для запроса соответствующего значка.</span><span class="sxs-lookup"><span data-stu-id="24fb7-127">After the interface is initialized, the Shell uses the handler's [**IExtractIcon**](/windows/win32/api/shlobj_core/nn-shlobj_core-iextracticona) interface to request the appropriate icon.</span></span> <span data-ttu-id="24fb7-128">Интерфейс имеет два метода: [**иекстрактикон:: жетиконлокатион**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-geticonlocation) и [**Иекстрактикон:: Extract**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-extract).</span><span class="sxs-lookup"><span data-stu-id="24fb7-128">The interface has two methods: [**IExtractIcon::GetIconLocation**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-geticonlocation) and [**IExtractIcon::Extract**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-extract).</span></span>

<span data-ttu-id="24fb7-129">Значки определяются по их расположению в файловой системе.</span><span class="sxs-lookup"><span data-stu-id="24fb7-129">Icons are identified by their location in the file system.</span></span> <span data-ttu-id="24fb7-130">Для запроса этой информации вызывается метод [**иекстрактикон:: жетиконлокатион**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-geticonlocation) .</span><span class="sxs-lookup"><span data-stu-id="24fb7-130">The [**IExtractIcon::GetIconLocation**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-geticonlocation) method is called to request this information.</span></span> <span data-ttu-id="24fb7-131">Присвойте параметру *сзиконфиле* имя файла.</span><span class="sxs-lookup"><span data-stu-id="24fb7-131">Set the *szIconFile* parameter to the file name.</span></span> <span data-ttu-id="24fb7-132">Если в файле несколько значков, установите *пииндекс* в качестве индекса значка.</span><span class="sxs-lookup"><span data-stu-id="24fb7-132">If there is more than one icon in the file, set *piIndex* to the icon's index.</span></span> <span data-ttu-id="24fb7-133">Присвойте подходящие значения двум переменным флагов.</span><span class="sxs-lookup"><span data-stu-id="24fb7-133">Assign appropriate values to the two flag variables.</span></span> <span data-ttu-id="24fb7-134">Если вы не хотите указывать имя файла или не хотите, чтобы оболочка извлека этот значок, установите флаг **Джил \_ нотфиленаме** в параметре *пвфлагс* .</span><span class="sxs-lookup"><span data-stu-id="24fb7-134">If you do not want to specify a file name, or if you do not want the Shell to extract the icon, set the **GIL\_NOTFILENAME** flag in the *pwFlags* parameter.</span></span> <span data-ttu-id="24fb7-135">Вам не нужно присваивать значение *сзиконфиле*, но обработчик должен предоставить дескрипторы значков, когда оболочка вызовет [**Иекстрактикон:: Extract**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-extract).</span><span class="sxs-lookup"><span data-stu-id="24fb7-135">You do not need to assign a value to *szIconFile*, but the handler must provide icon handles when the Shell calls [**IExtractIcon::Extract**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-extract).</span></span>

<span data-ttu-id="24fb7-136">Если вы возвращаете имя файла, оболочка обычно пытается загрузить значок из своего кэша.</span><span class="sxs-lookup"><span data-stu-id="24fb7-136">If you return a file name, the Shell normally attempts to load the icon from its cache.</span></span> <span data-ttu-id="24fb7-137">Чтобы предотвратить загрузку кэшированного значка, установите флаг **Джил \_ донткаче** в параметре *пвфлагс* .</span><span class="sxs-lookup"><span data-stu-id="24fb7-137">To prevent the loading of a cached icon, set the **GIL\_DONTCACHE** flag in the *pwFlags* parameter.</span></span> <span data-ttu-id="24fb7-138">Если кэшированный значок не загружен, оболочка вызывает [**иекстрактикон:: Extract**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-extract) для запроса маркера значка.</span><span class="sxs-lookup"><span data-stu-id="24fb7-138">If a cached icon is not loaded, the Shell then calls [**IExtractIcon::Extract**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-extract) to request the icon handle.</span></span>

<span data-ttu-id="24fb7-139">Если файл и индекс были указаны с помощью [**иекстрактикон:: жетиконлокатион**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-geticonlocation), они передаются в [**Иекстрактикон:: Extract**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-extract) в параметрах *псзфиле* и *никониндекс* соответственно.</span><span class="sxs-lookup"><span data-stu-id="24fb7-139">If a file and index were specified by [**IExtractIcon::GetIconLocation**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-geticonlocation), they are passed to [**IExtractIcon::Extract**](/windows/win32/api/shlobj_core/nf-shlobj_core-iextracticona-extract) in the *pszFile* and *nIconIndex* parameters, respectively.</span></span> <span data-ttu-id="24fb7-140">Если указано имя файла, обработчик может вернуть \_ значение false, чтобы оболочка извлека этот значок.</span><span class="sxs-lookup"><span data-stu-id="24fb7-140">If a file name is provided, your handler can return S\_FALSE to have the Shell extract the icon.</span></span> <span data-ttu-id="24fb7-141">В противном случае обработчик должен извлекать или иным образом создавать крупные и мелкие значки и назначать их дескрипторы ХИКОН параметрам *фиконларже* и *фиконсмалл* .</span><span class="sxs-lookup"><span data-stu-id="24fb7-141">Otherwise, your handler must extract or otherwise produce large and small icons, and assign their HICON handles to the *phiconLarge* and *phiconSmall* parameters.</span></span> <span data-ttu-id="24fb7-142">Оболочка добавляет значки в свой кэш для ускорения последующих вызовов обработчика.</span><span class="sxs-lookup"><span data-stu-id="24fb7-142">The Shell adds the icons to its cache to expedite subsequent calls to the handler.</span></span>

### <a name="step-3-registering-icon-handlers"></a><span data-ttu-id="24fb7-143">Шаг 3. Регистрация обработчиков значков</span><span class="sxs-lookup"><span data-stu-id="24fb7-143">Step 3: Registering Icon Handlers</span></span>

<span data-ttu-id="24fb7-144">При [статической регистрации значка](icon.md) для [типа файла](fa-file-types.md)создается подраздел **дефаултикон** с идентификатором ProgID для типа файла.</span><span class="sxs-lookup"><span data-stu-id="24fb7-144">When you [statically register an icon](icon.md) for a [file type](fa-file-types.md), you create a **DefaultIcon** subkey under the ProgID for the file type.</span></span> <span data-ttu-id="24fb7-145">Его значение по умолчанию — файл, содержащий значок.</span><span class="sxs-lookup"><span data-stu-id="24fb7-145">Its default value is set to the file that contains the icon.</span></span> <span data-ttu-id="24fb7-146">Чтобы зарегистрировать обработчик значков, необходимо по-прежнему иметь подраздел **дефаултикон** , но его значение по умолчанию должно быть равно "%1".</span><span class="sxs-lookup"><span data-stu-id="24fb7-146">To register an icon handler, you must still have the **DefaultIcon** subkey, but its default value must be set to "%1".</span></span> <span data-ttu-id="24fb7-147">Добавьте подраздел **иконхандлер** в подраздел **шеллекс** подраздела ProgID и присвойте его значению по умолчанию СТРОКОВОМУ формату GUID CLSID обработчика.</span><span class="sxs-lookup"><span data-stu-id="24fb7-147">Add an **IconHandler** subkey to the **Shellex** subkey of the ProgID subkey, and set its default value to the string form of the handler's CLSID GUID.</span></span> <span data-ttu-id="24fb7-148">Общие сведения о регистрации обработчиков расширений оболочки см. в статье [Создание обработчиков расширений](handlers.md)оболочки.</span><span class="sxs-lookup"><span data-stu-id="24fb7-148">For a general discussion of how to register Shell extension handlers, see [Creating Shell Extension Handlers](handlers.md).</span></span>

<span data-ttu-id="24fb7-149">В следующем примере запись реестра изменяется в соответствии с [настройками значков](icon.md) , поэтому тип файла. МИП теперь использует обработчик контекстного меню вместо статически определенного значка.</span><span class="sxs-lookup"><span data-stu-id="24fb7-149">The following example modifies the registry entry from [Customizing Icons](icon.md) so that the .myp file type now uses a shortcut menu handler instead of a statically defined icon.</span></span>

```
HKEY_CLASSES_ROOT
   .myp
      (Default) = MyProgram.1
   MyProgram.1
      (Default) = MyProgram Application
      DefaultIcon
         (Default) = %1
      Shellex
         IconHandler
            (Default) = {The handler's CLSID GUID}
```

## <a name="related-topics"></a><span data-ttu-id="24fb7-150">См. также</span><span class="sxs-lookup"><span data-stu-id="24fb7-150">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="24fb7-151">Создание обработчиков расширений оболочки</span><span class="sxs-lookup"><span data-stu-id="24fb7-151">Creating Shell Extension Handlers</span></span>](handlers.md)
</dt> <dt>

[<span data-ttu-id="24fb7-152">**IPersistFile**</span><span class="sxs-lookup"><span data-stu-id="24fb7-152">**IPersistFile**</span></span>](/windows/win32/api/objidl/nn-objidl-ipersistfile)
</dt> <dt>

[<span data-ttu-id="24fb7-153">**иекстрактикон**</span><span class="sxs-lookup"><span data-stu-id="24fb7-153">**IExtractIcon**</span></span>](/windows/win32/api/shlobj_core/nn-shlobj_core-iextracticona)
</dt> </dl>

 

 
