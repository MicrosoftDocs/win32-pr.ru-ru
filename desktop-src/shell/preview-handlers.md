---
description: Обработчики просмотра вызываются, когда элемент выбран для отображения упрощенного, доступного только для чтения просмотра содержимого файла в области чтения представления. Это делается без запуска приложения, связанного с файлом.
ms.assetid: 166a4001-d237-44a4-a457-e320e995639c
title: Обработчик предварительной версии и узел предварительной версии оболочки
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 993c6c8e7b15d9bfc24b5dd42352407a3a53c45b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104985640"
---
# <a name="preview-handlers-and-shell-preview-host"></a><span data-ttu-id="b8cc8-104">Обработчик предварительной версии и узел предварительной версии оболочки</span><span class="sxs-lookup"><span data-stu-id="b8cc8-104">Preview Handlers and Shell Preview Host</span></span>

<span data-ttu-id="b8cc8-105">Обработчики просмотра вызываются, когда элемент выбран для отображения упрощенного, *доступного только для чтения* просмотра содержимого файла в области чтения представления.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-105">Preview handlers are called when an item is selected to show a lightweight, rich, *read-only* preview of the file's contents in the view's reading pane.</span></span> <span data-ttu-id="b8cc8-106">Это делается без запуска приложения, связанного с файлом.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-106">This is done without launching the file's associated application.</span></span>

<span data-ttu-id="b8cc8-107">В этом разделе рассматриваются следующие темы:</span><span class="sxs-lookup"><span data-stu-id="b8cc8-107">This topic discusses the following topics:</span></span>

-   [<span data-ttu-id="b8cc8-108">Архитектура обработчика просмотра</span><span class="sxs-lookup"><span data-stu-id="b8cc8-108">Preview Handler Architecture</span></span>](#preview-handler-architecture)
-   [<span data-ttu-id="b8cc8-109">Параметры серверной модели</span><span class="sxs-lookup"><span data-stu-id="b8cc8-109">Server Model Options</span></span>](#server-model-options)
-   [<span data-ttu-id="b8cc8-110">Инициализация</span><span class="sxs-lookup"><span data-stu-id="b8cc8-110">Initialization</span></span>](#initialization)
-   [<span data-ttu-id="b8cc8-111">Поток данных обработчика просмотра</span><span class="sxs-lookup"><span data-stu-id="b8cc8-111">Preview Handler Data Flow</span></span>](#preview-handler-data-flow)
-   [<span data-ttu-id="b8cc8-112">Отладка обработчика просмотра</span><span class="sxs-lookup"><span data-stu-id="b8cc8-112">Debugging a Preview Handler</span></span>](#debugging-a-preview-handler)
-   [<span data-ttu-id="b8cc8-113">Предоставление собственного процесса для обработчика просмотра</span><span class="sxs-lookup"><span data-stu-id="b8cc8-113">Providing Your Own Process for a Preview Handler</span></span>](#providing-your-own-process-for-a-preview-handler)
-   [<span data-ttu-id="b8cc8-114">См. также</span><span class="sxs-lookup"><span data-stu-id="b8cc8-114">Related topics</span></span>](#related-topics)

## <a name="preview-handler-architecture"></a><span data-ttu-id="b8cc8-115">Архитектура обработчика просмотра</span><span class="sxs-lookup"><span data-stu-id="b8cc8-115">Preview Handler Architecture</span></span>

<span data-ttu-id="b8cc8-116">Обработчик просмотра — это размещенное приложение.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-116">A preview handler is a hosted application.</span></span> <span data-ttu-id="b8cc8-117">Узлы включают проводник Windows в Windows Vista или Microsoft Outlook 2007.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-117">Hosts include the Windows Explorer in Windows Vista or Microsoft Outlook 2007.</span></span> <span data-ttu-id="b8cc8-118">Узлы реализуют [**IPreviewHandlerFrame**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandlerframe) в качестве метода взаимодействия между обработчиком просмотра и узлом.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-118">Hosts implement [**IPreviewHandlerFrame**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandlerframe) as a method of communication between the preview handler and the host.</span></span>

<span data-ttu-id="b8cc8-119">Обработчик предварительной версии реализует следующие интерфейсы:</span><span class="sxs-lookup"><span data-stu-id="b8cc8-119">The preview handler itself implements these interfaces:</span></span>

-   [<span data-ttu-id="b8cc8-120">**IInitializeWithStream**</span><span class="sxs-lookup"><span data-stu-id="b8cc8-120">**IInitializeWithStream**</span></span>](/windows/desktop/api/Propsys/nn-propsys-iinitializewithstream)
-   [<span data-ttu-id="b8cc8-121">**IObjectWithSite**</span><span class="sxs-lookup"><span data-stu-id="b8cc8-121">**IObjectWithSite**</span></span>](/windows/win32/api/ocidl/nn-ocidl-iobjectwithsite)
-   [<span data-ttu-id="b8cc8-122">**иолевиндов**</span><span class="sxs-lookup"><span data-stu-id="b8cc8-122">**IOleWindow**</span></span>](/windows/win32/api/oleidl/nn-oleidl-iolewindow)
-   [<span data-ttu-id="b8cc8-123">**IPreviewHandler**</span><span class="sxs-lookup"><span data-stu-id="b8cc8-123">**IPreviewHandler**</span></span>](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandler)
-   <span data-ttu-id="b8cc8-124">[**Ипревиевхандлервисуалс**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandlervisuals) (необязательно)</span><span class="sxs-lookup"><span data-stu-id="b8cc8-124">[**IPreviewHandlerVisuals**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandlervisuals) (Optional)</span></span>

<span data-ttu-id="b8cc8-125">Обработчик вызывается через его [**IObjectWithSite**](/windows/win32/api/ocidl/nn-ocidl-iobjectwithsite), который возвращает указатель [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) , с помощью которого вы запрашиваете объект [**IPreviewHandlerFrame**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandlerframe) для взаимодействия с узлом.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-125">Your handler is called through its [**IObjectWithSite**](/windows/win32/api/ocidl/nn-ocidl-iobjectwithsite), which returns an [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) pointer through which you request an [**IPreviewHandlerFrame**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ipreviewhandlerframe) object to interact with the host.</span></span>

## <a name="server-model-options"></a><span data-ttu-id="b8cc8-126">Параметры серверной модели</span><span class="sxs-lookup"><span data-stu-id="b8cc8-126">Server Model Options</span></span>

<span data-ttu-id="b8cc8-127">Обработчики предварительной версии всегда выполняются вне процесса.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-127">Preview handlers always run out of process.</span></span> <span data-ttu-id="b8cc8-128">Существует два метода реализации этого:</span><span class="sxs-lookup"><span data-stu-id="b8cc8-128">There are two methods of implementing this:</span></span>

1.  <span data-ttu-id="b8cc8-129">Обработчик просмотра можно построить как внутрипроцессный сервер, но выполнить его через внутрипроцессный суррогатный узел.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-129">A preview handler can be built as an in-process server but run through an out-of-process surrogate host.</span></span> <span data-ttu-id="b8cc8-130">Это является предпочтительным методом.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-130">This is the preferred method.</span></span> <span data-ttu-id="b8cc8-131">Система предоставляет суррогатный узел для этого в файле Prevhost.exe.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-131">The system provides a surrogate host for this in the Prevhost.exe file.</span></span> <span data-ttu-id="b8cc8-132">Обработчики просмотра, созданные с помощью этого метода, несовместимы с Outlook 2007 в Windows XP.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-132">Preview handlers built by this method are not compatible with Outlook 2007 on Windows XP.</span></span> <span data-ttu-id="b8cc8-133">Однако эти же обработчики будут работать в проводнике Windows и Outlook 2007, работающем под управлением Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-133">However, these same handlers will work in Windows Explorer and Outlook 2007 running on Windows Vista.</span></span>
2.  <span data-ttu-id="b8cc8-134">Обработчик просмотра можно построить как сервер модели COM.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-134">A preview handler can be built as a local Component Object Model (COM) server.</span></span> <span data-ttu-id="b8cc8-135">Это не рекомендуется по нескольким причинам.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-135">This is not recommended for several reasons.</span></span> <span data-ttu-id="b8cc8-136">Во-первых, реализация внутрипроцессного сервера упрощается.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-136">First, implementation of an in-process server is easier.</span></span> <span data-ttu-id="b8cc8-137">Что более важно, реализация в качестве внутрипроцессного сервера обеспечивает больший контроль над временем существования объекта обработчика, что обеспечивает лучшую очистку и эффективность.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-137">More importantly, implementation as an in-process server provides greater control over the lifetime of the handler object, which allows for better cleanup and efficiency.</span></span>

<span data-ttu-id="b8cc8-138">По умолчанию обработчики предварительной версии выполняются в процессе низкого уровня целостности (IL) по соображениям безопасности.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-138">By default, preview handlers run in a low integrity level (IL) process for security reasons.</span></span> <span data-ttu-id="b8cc8-139">При необходимости можно отключить запуск в качестве процесса с низким IL, задав в реестре следующее значение.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-139">You can optionally disable running as a low IL process by setting the following value in the registry.</span></span> <span data-ttu-id="b8cc8-140">Однако это не рекомендуется делать.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-140">However, it is not recommended to do so.</span></span> <span data-ttu-id="b8cc8-141">В конечном итоге системы могут быть настроены на отклонение любого процесса, который не имеет низкого уровня IL.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-141">Systems could eventually be configured to reject any process that is not low IL.</span></span>

```
HKEY_CLASSES_ROOT
   CLSID
      {YOUR HANDLER'S CLSID}
         DisableLowILProcessIsolation [DWORD] = 1
```

<span data-ttu-id="b8cc8-142">Разные обработчики просмотра по умолчанию используют один и тот же процесс.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-142">Different preview handlers share the same process by default.</span></span> <span data-ttu-id="b8cc8-143">Одновременно могут выполняться два экземпляра Prevhost.exe; один для обработчиков, выполняющихся в качестве процессов с низким IL, один для обработчиков, которые выказали от этого поведения.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-143">Two instances of Prevhost.exe can be running simultaneously; one for handlers running as low IL processes, one for handlers that have opted out of that behavior.</span></span>

## <a name="initialization"></a><span data-ttu-id="b8cc8-144">Инициализация</span><span class="sxs-lookup"><span data-stu-id="b8cc8-144">Initialization</span></span>

<span data-ttu-id="b8cc8-145">Как и в случае с эскизами и обработчиками свойств, настоятельно рекомендуется инициализировать обработчик с помощью потока.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-145">As with thumbnail and property handlers, it is strongly recommended that you initialize your handler with a stream.</span></span> <span data-ttu-id="b8cc8-146">При необходимости можно инициализировать по файлу или элементу, но потоки предоставляют наиболее безопасный способ реализации обработчика.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-146">You can initialize through a file or item if necessary, but streams provide the most secure way to implement a handler.</span></span> <span data-ttu-id="b8cc8-147">Инициализация через поток обеспечивает целостность файлов и повышает стабильность системы при выполнении обработчика в качестве процесса низкого IL, например при защите системы от переполнения буфера, ограничении места, в котором обработчик может записывать сведения, и ограничении связи с другими окнами.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-147">Initialization through a stream ensures file integrity and the stability benefits to the system of running the handler as a low IL process, such as protecting the system from buffer overruns, limiting where a handler can write information, and limiting communication with other windows.</span></span>

<span data-ttu-id="b8cc8-148">Если необходимо выполнить инициализацию с помощью файла или элемента оболочки, сохраните путь к файлу или ссылку на [**интерфейса IShellItem**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellitem).</span><span class="sxs-lookup"><span data-stu-id="b8cc8-148">If you must initialize with a file or Shell item, store the file path or a reference to the [**IShellItem**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellitem).</span></span> <span data-ttu-id="b8cc8-149">Не считайте данные из этих источников, пока не будет вызван [**IPreviewHandler::D опревиев**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-dopreview) .</span><span class="sxs-lookup"><span data-stu-id="b8cc8-149">Do not read data from these sources until [**IPreviewHandler::DoPreview**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-dopreview) is called.</span></span>

<span data-ttu-id="b8cc8-150">Как правило, инициализация не должна выполнять никаких больших действий, таких как составление и хранение предварительного изображения.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-150">In general, initialization should not do any heavy work such as composing and storing a preview image.</span></span> <span data-ttu-id="b8cc8-151">Для оптимальной эффективности такая обработка не должна выполняться до тех пор, пока не будет вызван предварительный просмотр для.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-151">For optimal efficiency, that sort of processing should not be done until the preview is called for.</span></span>

## <a name="preview-handler-data-flow"></a><span data-ttu-id="b8cc8-152">Поток данных обработчика просмотра</span><span class="sxs-lookup"><span data-stu-id="b8cc8-152">Preview Handler Data Flow</span></span>

<span data-ttu-id="b8cc8-153">Поток данных в процессе предварительной версии соответствует общему пути, показанному здесь.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-153">The data flow in the preview process follows the general path shown here.</span></span> <span data-ttu-id="b8cc8-154">Узел можно рассматривать как проводник Windows в Windows Vista или Outlook 2007.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-154">The host can be thought of as Windows Explorer in Windows Vista or Outlook 2007.</span></span>

1.  <span data-ttu-id="b8cc8-155">Обработчик просмотра инициализируется, желательно с потоком.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-155">The preview handler is initialized, preferably with a stream.</span></span>
2.  <span data-ttu-id="b8cc8-156">Окно представления передается с узла в обработчик через [**IPreviewHandler:: сетвиндов**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-setwindow).</span><span class="sxs-lookup"><span data-stu-id="b8cc8-156">The view window is passed from the host to the handler through [**IPreviewHandler::SetWindow**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-setwindow).</span></span>
3.  <span data-ttu-id="b8cc8-157">На этом этапе обработчик не должен выполнять никаких действий до тех пор, пока не будет вызван [**IPreviewHandler::D опревиев**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-dopreview) .</span><span class="sxs-lookup"><span data-stu-id="b8cc8-157">At this point, the handler should do nothing more until [**IPreviewHandler::DoPreview**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-dopreview) is called.</span></span>
4.  <span data-ttu-id="b8cc8-158">Предварительный просмотр отображается в области чтения с помощью вызова [**IPreviewHandler::D опревиев**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-dopreview).</span><span class="sxs-lookup"><span data-stu-id="b8cc8-158">The preview is displayed in the reading pane through a call to [**IPreviewHandler::DoPreview**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-dopreview).</span></span>
5.  <span data-ttu-id="b8cc8-159">Размер окна задается с помощью [**IPreviewHandler:: SetRect**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-setrect).</span><span class="sxs-lookup"><span data-stu-id="b8cc8-159">The size of the window is set through [**IPreviewHandler::SetRect**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-setrect).</span></span>
6.  <span data-ttu-id="b8cc8-160">При необходимости размер окна изменяется с помощью [**IPreviewHandler:: SetRect**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-setrect).</span><span class="sxs-lookup"><span data-stu-id="b8cc8-160">The window is resized when needed through [**IPreviewHandler::SetRect**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-setrect).</span></span>
7.  <span data-ttu-id="b8cc8-161">Предварительная версия выгружается, а ее ресурсы освобождаются, когда она больше не нужна, с помощью вызова [**IPreviewHandler:: unload**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-unload).</span><span class="sxs-lookup"><span data-stu-id="b8cc8-161">The preview is unloaded and its resources released when it is no longer needed, through a call to [**IPreviewHandler::Unload**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ipreviewhandler-unload).</span></span>

## <a name="debugging-a-preview-handler"></a><span data-ttu-id="b8cc8-162">Отладка обработчика просмотра</span><span class="sxs-lookup"><span data-stu-id="b8cc8-162">Debugging a Preview Handler</span></span>

<span data-ttu-id="b8cc8-163">Если вы выполнили рекомендации по реализации обработчика просмотра в качестве внутрипроцессного сервера, можно присоединиться к Prevhost.exe, чтобы выполнить отладку обработчика просмотра.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-163">If you have followed the recommendations to implement your preview handler as an in-process server, to debug your preview handler, you can attach to Prevhost.exe.</span></span> <span data-ttu-id="b8cc8-164">Как упоминалось ранее, имейте в виду, что могут существовать два экземпляра Prevhost.exe, один для обычных процессов с низким уровнем IL и один для обработчиков, которые не работают как процесс с низким IL.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-164">As mentioned earlier, be aware that there could be two instances of Prevhost.exe, one for normal low IL processes and one for those handlers that have opted out of running as a low IL process.</span></span>

<span data-ttu-id="b8cc8-165">Если вы не нашли Prevhost.exe в списке доступных процессов, возможно, он не был загружен в этот момент.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-165">If you do not find Prevhost.exe in your list of available processes, it probably has not been loaded at that point.</span></span> <span data-ttu-id="b8cc8-166">Если щелкнуть файл для предварительного просмотра, загружается суррогат, который затем должен отображаться как присоединяемый процесс.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-166">Clicking on a file for a preview loads the surrogate and it should then appear as an attachable process.</span></span>

## <a name="providing-your-own-process-for-a-preview-handler"></a><span data-ttu-id="b8cc8-167">Предоставление собственного процесса для обработчика просмотра</span><span class="sxs-lookup"><span data-stu-id="b8cc8-167">Providing Your Own Process for a Preview Handler</span></span>

<span data-ttu-id="b8cc8-168">Если требуется принудительно создать новый процесс для обработчика, а не для процесса по умолчанию, создайте новый подраздел для обработчика в каталоге **AppID** и задайте для его записи дллсуррогате значение "Prevhost.exe".</span><span class="sxs-lookup"><span data-stu-id="b8cc8-168">If you want to force the creation of a new process for your handler rather than running under the default process, create a new subkey for your handler under **AppID** and set its DllSurrogate entry to "Prevhost.exe".</span></span> <span data-ttu-id="b8cc8-169">Используйте этот подраздел **AppID** вместо Prevhost.exe **AppID** по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-169">Use that **AppID** subkey instead of the default Prevhost.exe **AppID**.</span></span>

<span data-ttu-id="b8cc8-170">Предоставляя новый процесс, обработчик может избежать выполнения в рамках общего процесса, как это будет сделано по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-170">By providing a new process, the handler can avoid running under a shared process as it would do by default.</span></span> <span data-ttu-id="b8cc8-171">Это позволяет, например, убедиться, что в процессе определена конкретная версия среды CLR.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-171">This could allow you, for example, to ensure the specific version of the common language runtime (CLR) in the process.</span></span> <span data-ttu-id="b8cc8-172">Это необходимо при построении управляемой реализации обработчика просмотра.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-172">This is required if you are building a managed implementation of a preview handler.</span></span>

> [!Note]  
> <span data-ttu-id="b8cc8-173">32-разрядные обработчики просмотра должны использовать **AppID** {534A1E02-D58F-44f0-B58B-36CBED287C7C} при установке в 64-разрядных операционных системах.</span><span class="sxs-lookup"><span data-stu-id="b8cc8-173">32-bit preview handlers should use **AppID** {534A1E02-D58F-44f0-B58B-36CBED287C7C} when installed on 64-bit operating systems.</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="b8cc8-174">См. также</span><span class="sxs-lookup"><span data-stu-id="b8cc8-174">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="b8cc8-175">Создание обработчиков предварительного просмотра</span><span class="sxs-lookup"><span data-stu-id="b8cc8-175">Building Preview Handlers</span></span>](building-preview-handlers.md)
</dt> <dt>

[<span data-ttu-id="b8cc8-176">Регистрация обработчика просмотра</span><span class="sxs-lookup"><span data-stu-id="b8cc8-176">How to Register a Preview Handler</span></span>](how-to-register-a-preview-handler.md)
</dt> <dt>

[<span data-ttu-id="b8cc8-177">Рекомендации по обработчику предварительной версии</span><span class="sxs-lookup"><span data-stu-id="b8cc8-177">Preview Handler Guidelines</span></span>](preview-handler-guidelines.md)
</dt> </dl>

 

 
