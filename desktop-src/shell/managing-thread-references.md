---
description: Эта статья содержит сведения об управлении ссылками на потоки с помощью функций из упрощенных служебных функций оболочки.
ms.assetid: d8d479fd-c45a-4dfa-b496-76abc7c09a42
title: Управление ссылками на потоки
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b629cd97c99e3b30e66810b5f54720d0dbb1c87d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104985656"
---
# <a name="managing-thread-references"></a><span data-ttu-id="71f7b-103">Управление ссылками на потоки</span><span class="sxs-lookup"><span data-stu-id="71f7b-103">Managing Thread References</span></span>

<span data-ttu-id="71f7b-104">Эта статья содержит сведения об управлении ссылками на потоки с помощью функций из упрощенных служебных функций оболочки.</span><span class="sxs-lookup"><span data-stu-id="71f7b-104">This article contains information about the management of thread references using functions from the Shell lightweight utility functions.</span></span>


<span data-ttu-id="71f7b-105">Ситуации возникают, когда родительский поток должен оставаться активным в течение времени существования дочернего потока.</span><span class="sxs-lookup"><span data-stu-id="71f7b-105">Situations arise when a parent thread must be kept active for the lifetime of a child thread.</span></span> <span data-ttu-id="71f7b-106">Например, если объект модели COM создается в родительском потоке и маршалируется в дочерний поток, этот родительский поток не может завершиться перед дочерним потоком.</span><span class="sxs-lookup"><span data-stu-id="71f7b-106">For instance, if a Component Object Model (COM) object is created on the parent thread and marshaled to the child thread, that parent thread cannot terminate before the child thread.</span></span> <span data-ttu-id="71f7b-107">Для этого оболочка предоставляет эти функции.</span><span class="sxs-lookup"><span data-stu-id="71f7b-107">To accomplish this, the Shell provides these functions.</span></span>

-   [<span data-ttu-id="71f7b-108">**шкреатесреадреф**</span><span class="sxs-lookup"><span data-stu-id="71f7b-108">**SHCreateThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref)
-   [<span data-ttu-id="71f7b-109">**шсетсреадреф**</span><span class="sxs-lookup"><span data-stu-id="71f7b-109">**SHSetThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref)
-   [<span data-ttu-id="71f7b-110">**шжетсреадреф**</span><span class="sxs-lookup"><span data-stu-id="71f7b-110">**SHGetThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref)

<span data-ttu-id="71f7b-111">Используйте эти функции в родительском потоке, как описано здесь.</span><span class="sxs-lookup"><span data-stu-id="71f7b-111">Use these functions in your parent thread as outlined here.</span></span>

1.  <span data-ttu-id="71f7b-112">Объявите определяемую приложением процедуру потока, следующую за формой функции [*среадпрок*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) .</span><span class="sxs-lookup"><span data-stu-id="71f7b-112">Declare an application-defined thread procedure following the form of the [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) function.</span></span>

    ``` syntax
    DWORD WINAPI ThreadProc(LPVOID lpParameter);
    ```

2.  <span data-ttu-id="71f7b-113">В [*среадпрок*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85))вызовите [**шкреатесреадреф**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) , чтобы создать ссылку на поток.</span><span class="sxs-lookup"><span data-stu-id="71f7b-113">In your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)), call [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) to create a reference to the thread.</span></span> <span data-ttu-id="71f7b-114">Это предоставляет указатель на экземпляр [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown).</span><span class="sxs-lookup"><span data-stu-id="71f7b-114">This provides a pointer to an instance of [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown).</span></span> <span data-ttu-id="71f7b-115">Этот **IUnknown** использует значение, на которое указывает *пкреф* , для поддержания счетчика ссылок.</span><span class="sxs-lookup"><span data-stu-id="71f7b-115">This **IUnknown** uses the value pointed to by *pcRef* to maintain a reference count.</span></span> <span data-ttu-id="71f7b-116">Пока значение счетчика больше 0, поток остается активным.</span><span class="sxs-lookup"><span data-stu-id="71f7b-116">As long as this count is greater than 0, the thread remains active.</span></span>
3.  <span data-ttu-id="71f7b-117">Используя этот указатель на [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), вызовите [**шсетсреадреф**](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref) в [*среадпрок*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="71f7b-117">Using that pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), call [**SHSetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref) in your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)).</span></span> <span data-ttu-id="71f7b-118">Это задает ссылку, чтобы последующие вызовы [**шжетсреадреф**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) могли извлекаться.</span><span class="sxs-lookup"><span data-stu-id="71f7b-118">This sets the reference so that subsequent calls to [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) have something to retrieve.</span></span>
4.  <span data-ttu-id="71f7b-119">Если [*среадпрок*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) создает другой поток, *среадпрок* этого потока может вызвать [**Шжетсреадреф**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) с указателем на [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) , полученным [**шкреатесреадреф**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref).</span><span class="sxs-lookup"><span data-stu-id="71f7b-119">If your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) creates another thread, that thread's *ThreadProc* can call [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) with the pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtained by [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref).</span></span> <span data-ttu-id="71f7b-120">Это увеличивает счетчик ссылок, на который указывает параметр *пкреф* в **шкреатесреадреф**.</span><span class="sxs-lookup"><span data-stu-id="71f7b-120">This increments the reference count pointed to by the *pcRef* parameter in **SHCreateThreadRef**.</span></span>
5.  <span data-ttu-id="71f7b-121">Создайте поток.</span><span class="sxs-lookup"><span data-stu-id="71f7b-121">Create the thread.</span></span> <span data-ttu-id="71f7b-122">Обычно это делается путем вызова [**шкреатесреад**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread), передавая указатель на [*среадпрок*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) в параметре *пфнсреадпрок* .</span><span class="sxs-lookup"><span data-stu-id="71f7b-122">This is usually done by calling [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread), passing a pointer to your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) in the *pfnThreadProc* parameter.</span></span> <span data-ttu-id="71f7b-123">Также передайте \_ \_ флаг ссылки потока КТФ в параметре *dwFlags* .</span><span class="sxs-lookup"><span data-stu-id="71f7b-123">Also pass the CTF\_THREAD\_REF flag in the *dwFlags* parameter.</span></span> <span data-ttu-id="71f7b-124">Поток активен при условии, что *среадпрок* исполняется.</span><span class="sxs-lookup"><span data-stu-id="71f7b-124">The thread is active as long as *ThreadProc* is executing.</span></span>
6.  <span data-ttu-id="71f7b-125">При создании дочернего потока передайте флаг **КТФ \_ ref \_ Count** в параметре *DwFlags* в вызове его [**шкреатесреад**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread).</span><span class="sxs-lookup"><span data-stu-id="71f7b-125">When a child thread is created, pass the **CTF\_REF\_COUNTED** flag in the *dwFlags* parameter in the call to its [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread).</span></span>
7.  <span data-ttu-id="71f7b-126">По мере завершения и освобождения дочерних потоков значение, на которое указывает *пкреф* родительский поток, уменьшается.</span><span class="sxs-lookup"><span data-stu-id="71f7b-126">As child threads complete and are released, the value pointed to by the parent thread's *pcRef* decreases.</span></span> <span data-ttu-id="71f7b-127">После завершения всех дочерних потоков исходный [*среадпрок*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) может завершиться и освободить итоговую ссылку на поток, удалив счетчик ссылок в 0.</span><span class="sxs-lookup"><span data-stu-id="71f7b-127">Once all child threads are complete, the original [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) can complete and release the final thread reference, dropping the reference count to 0.</span></span> <span data-ttu-id="71f7b-128">На этом этапе будет выпущена ссылка на исходный поток, Открытый с помощью [**шкреатесреад**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) , и поток завершился.</span><span class="sxs-lookup"><span data-stu-id="71f7b-128">At that point, the reference to the original thread opened by [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) is released and the thread completed.</span></span>

<span data-ttu-id="71f7b-129">Еще одна связанная функция — [**шрелеасесреадреф**](/windows/desktop/api/Shlwapi/nf-shlwapi-shreleasethreadref).</span><span class="sxs-lookup"><span data-stu-id="71f7b-129">Another related function is [**SHReleaseThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shreleasethreadref).</span></span> <span data-ttu-id="71f7b-130">Эта функция вызывается [*среадпрок*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) , если поток был создан с помощью [**шкреатесреад**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) с флагом **ссылки КТФ \_ Thread \_** .</span><span class="sxs-lookup"><span data-stu-id="71f7b-130">This function is called by the [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) if the thread has been created using [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) with the **CTF\_THREAD\_REF** flag.</span></span> <span data-ttu-id="71f7b-131">Однако *среадпрок* не требуется делать таким образом.</span><span class="sxs-lookup"><span data-stu-id="71f7b-131">However, the *ThreadProc* is not required to do so implicitly.</span></span> <span data-ttu-id="71f7b-132">Вызов [**IUnknown:: Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) на указатель на [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) , полученный через [**шкреатесреадреф**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) , должен быть выполнен.</span><span class="sxs-lookup"><span data-stu-id="71f7b-132">Calling [**IUnknown::Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) on the pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtained through [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) is all that needs to be done.</span></span>

 

 
