---
description: Возможности оболочки можно расширить с помощью записей реестра и ini-файлов.
ms.assetid: 74a81e4f-7357-4901-a118-ba44e8892f25
title: Создание обработчиков расширений оболочки
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 991f3c1684b7491e2ad29fae29f48164ffdd47cb
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104997718"
---
# <a name="creating-shell-extension-handlers"></a>Создание обработчиков расширений оболочки

Возможности оболочки можно расширить с помощью записей реестра и ini-файлов. Хотя этот подход к расширению оболочки прост и подходит для многих целей, он ограничен. Например, если вы используете реестр для задания пользовательского значка для типа файла, для каждого файла этого типа будет отображаться один и тот же значок. Расширение оболочки с помощью реестра не позволяет изменять значки для различных файлов одного типа. Другие аспекты оболочки, такие как страница свойств « **Свойства** », которая может отображаться при щелчке правой кнопкой мыши, не может быть изменена в реестре.

Более мощный и гибкий подход к расширению оболочки заключается в реализации *обработчиков расширения оболочки*. Эти обработчики можно реализовать для различных действий, которые может выполнять оболочка. Перед выполнением действия оболочка запрашивает обработчик расширения, предоставляя ему возможность изменить действие. Распространенным примером является обработчик расширения контекстного меню. Если один из файлов реализуется для типа файла, он запрашивается каждый раз при щелчке правой кнопкой мыши. Затем обработчик может указать дополнительные пункты меню для каждого файла, а не одинаковый набор для всего типа файлов.

В этом документе описывается, как реализовать обработчики расширений, позволяющие изменять различные действия оболочки. Следующие обработчики связаны с определенным типом файла и позволяют указать отдельно для каждого файла:



| Обработчик                                               | Описание                                                                                                                                                                |
|-------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [Обработчик контекстного меню](context-menu-handlers.md)    | Вызывается перед отображением контекстного меню файла. Он позволяет добавлять элементы в контекстное меню для каждого файла.                                               |
| [Обработчик данных](how-to-create-data-handlers.md)       | Вызывается при выполнении операции перетаскивания для объектов Драгшелл. Он позволяет предоставлять дополнительные форматы буфера обмена для целевого объекта перетаскивания.                        |
| [Удалить обработчик](how-to-create-drop-handlers.md)       | Вызывается, когда объект данных перетаскивается или удаляется в файле. Он позволяет преобразовать файл в цель перетаскивания.                                                          |
| [Обработчик значков](how-to-create-icon-handlers.md)       | Вызывается перед отображением значка файла. Он позволяет заменить значок файла по умолчанию на пользовательский значок для каждого файла.                                    |
| [Обработчик страницы свойств](propsheet-handlers.md)      | Вызывается перед отображением страницы свойств **Свойства** объекта. Он позволяет добавлять или заменять страницы.                                                              |
| [**Обработчик изображений эскиза**](/windows/desktop/api/Thumbcache/nn-thumbcache-ithumbnailprovider) | Предоставляет изображение для представления элемента.                                                                                                                                   |
| [**Обработчик подсказок**](/windows/win32/api/shlobj_core/nn-shlobj_core-iqueryinfo)                 | Предоставляет всплывающий текст, когда пользователь наводит указатель мыши на объект.                                                                                               |
| [**Обработчик метаданных**](/windows/win32/api/propsys/nn-propsys-ipropertystore)     | Предоставляет доступ на чтение и запись к метаданным (свойствам), хранящимся в файле. Это можно использовать для расширения подробного представления, инфотипс, страницы свойств и функций группирования. |



 

Другие обработчики не связаны с определенным типом файла, но вызываются перед некоторыми операциями оболочки:



| Обработчик                                                            | Описание                                                                                                                                  |
|--------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------|
| [Обработчик столбцов](../lwef/column-handlers.md)                             | Вызывается проводником Windows перед отображением подробного представления папки. Он позволяет добавлять пользовательские столбцы в представление Details.        |
| [Копирование обработчика перехватчика](how-to-create-copy-hook-handlers.md)          | Вызывается, когда объект папки или принтера собирается перемещаться, копироваться, удаляться или переименовываться. Она позволяет утвердить или отклонить операцию.   |
| [Обработчик действия перетаскивания](context-menu-handlers.md)                 | Вызывается при перетаскивании файла с помощью правой кнопки мыши. Это позволяет изменить отображаемое контекстное меню.                     |
| [Обработчик наложения значков](how-to-implement-icon-overlay-handlers.md) | Вызывается перед отображением значка файла. Он позволяет указать наложение для значка файла.                                          |
| [Поисковый обработчик](../lwef/search-handlers.md)                             | Вызывается для запуска поисковой системы. Она позволяет реализовать пользовательскую подсистему поиска, доступную в меню " **Пуск** " или в проводнике Windows. |



 

Сведения о реализации конкретных обработчиков расширений описаны в разделах, перечисленных выше. Оставшаяся часть этого документа охватывает некоторые проблемы реализации, общие для всех обработчиков расширений оболочки.

-   [Реализация обработчиков расширений оболочки](#implementing-shell-extension-handlers)
    -   [Реализация IPersistFile](#implementing-ipersistfile)
    -   [Реализация Ишеллекстинит](#implementing-ishellextinit)
    -   [Настройка всплывающей подсказки](#infotip-customization)
-   [Улучшение поиска Windows с помощью обработчиков расширений оболочки](#enhancing-windows-search-with-shell-extension-handlers)
-   [Регистрация обработчиков расширений оболочки](#registering-shell-extension-handlers)
    -   [Имена обработчиков](#handler-names)
    -   [Предопределенные объекты оболочки](#predefined-shell-objects)
    -   [Пример регистрации обработчика расширений](#example-of-an-extension-handler-registration)
-   [См. также](#related-topics)

## <a name="implementing-shell-extension-handlers"></a>Реализация обработчиков расширений оболочки

Большая часть реализации объекта обработчика расширений оболочки зависит от его типа. Однако есть некоторые распространенные элементы. В этом разделе обсуждаются аспекты реализации, совместно используемые всеми обработчиками расширений оболочки.

Многие обработчики расширений оболочки — это объекты модели COM. Им необходимо назначить идентификатор GUID и зарегистрировать, как описано в разделе Регистрация обработчиков расширений оболочки. Они реализуются в виде библиотек DLL и должны экспортировать следующие стандартные функции:

-   [**DllMain**](../dlls/dllmain.md). Стандартная точка входа для библиотеки DLL.
-   [**DllGetClassObject**](/windows/win32/api/combaseapi/nf-combaseapi-dllgetclassobject). Предоставляет фабрику класса объекта.
-   [**DllCanUnloadNow**](/windows/win32/api/combaseapi/nf-combaseapi-dllcanunloadnow). COM вызывает эту функцию, чтобы определить, обслуживает ли объект какие-либо клиенты. В противном случае система может выгрузить библиотеку DLL и освободить связанную с ней память.

Как и все COM-объекты, обработчики расширений оболочки должны реализовывать интерфейс [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) и [фабрику классов](../com/implementing-iclassfactory.md). Большинство обработчиков расширений также должны реализовывать интерфейс [**IPersistFile**](/windows/win32/api/objidl/nn-objidl-ipersistfile) или [**ИШЕЛЛЕКСТИНИТ**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit) в Windows XP или более ранней версии. Они были заменены на [**IInitializeWithStream**](/windows/desktop/api/Propsys/nn-propsys-iinitializewithstream), [**иинитиализевиситем**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-iinitializewithitem) и [**IInitializeWithFile**](/windows/desktop/api/Propsys/nn-propsys-iinitializewithfile) в Windows Vista. Оболочка использует эти интерфейсы для инициализации обработчика.

Интерфейс [**IPersistFile**](/windows/win32/api/objidl/nn-objidl-ipersistfile) должен быть реализован следующим образом:

-   Обработчики данных
-   Удалить обработчики

В прошлом Обработчики значков также требовались для реализации [**IPersistFile**](/windows/win32/api/objidl/nn-objidl-ipersistfile), но это не так. Для обработчиков значков **IPersistFile** теперь является необязательным, и другие интерфейсы, такие как [**иинитиализевиситем**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-iinitializewithitem) , являются предпочтительными.

Интерфейс [**ишеллекстинит**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit) должен быть реализован следующим образом:

-   Обработчики контекстного меню
-   Обработчики перетаскивания
-   Обработчики страницы свойств

### <a name="implementing-ipersistfile"></a>Реализация IPersistFile

Интерфейс [**IPersistFile**](/windows/win32/api/objidl/nn-objidl-ipersistfile) предназначен для того, чтобы объект был загружен или сохранен в файл на диске. В нем есть шесть методов в дополнение к [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), пять его собственных и методу [**ClassID**](/windows/win32/api/objidl/nf-objidl-ipersist-getclassid) , который он наследует от [**IPersist**](/windows/win32/api/objidl/nn-objidl-ipersist). С помощью расширений оболочки **IPersist** используется только для инициализации объекта обработчика расширений оболочки. Так как обычно нет необходимости выполнять чтение или запись на диск, только для методов **класса** и метода [**Load**](/windows/win32/api/objidl/nf-objidl-ipersistfile-load) требуется только реализация без маркера.

Оболочка вызывает метод [**ClassID**](/windows/win32/api/objidl/nf-objidl-ipersist-getclassid) , а функция возвращает идентификатор класса (CLSID) объекта обработчика расширений. Затем оболочка вызывает [**Load**](/windows/win32/api/objidl/nf-objidl-ipersistfile-load) и передает два значения. Первая, *pszFileName*, представляет собой строку в Юникоде с именем файла или папки, в которой будет выполняться оболочка. Второй — *двмоде*, который указывает режим доступа к файлу. Так как обычно нет необходимости в доступе к файлам, *двмоде* обычно равен нулю. Метод сохраняет эти значения в соответствии с последующими ссылками.

В следующем фрагменте кода показано, как типичный обработчик расширений оболочки реализует методы класса [**и метода-**](/windows/win32/api/objidl/nf-objidl-ipersistfile-load) [**ClassID**](/windows/win32/api/objidl/nf-objidl-ipersist-getclassid) . Он предназначен для работы с ANSI или Unicode. CLSID \_ сампликссандлер — это идентификатор GUID объекта обработчика расширений, а ксампликссандлер — имя класса, используемого для реализации интерфейса. Переменные **m \_ сзфиленаме** и **m \_ двмоде** являются частными переменными, которые используются для хранения имени файла и флагов доступа.


```C++
wchar_t m_szFileName[MAX_PATH];    // The file name
DWORD m_dwMode;                  // The file access mode

CSampleExtHandler::GetClassID(CLSID *pCLSID)
{
    *pCLSID = CLSID_SampleExtHandler;
}

CSampleExtHandler::Load(PCWSTR pszFile, DWORD dwMode)
{
    m_dwMode = dwMode;
    return StringCchCopy(_szFileName, ARRAYSIZE(m_szFileName), pszFile);
}
```

### <a name="implementing-ishellextinit"></a>Реализация Ишеллекстинит

Помимо [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), в интерфейсе [**ишеллекстинит**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit) имеется только один метод, [**ишеллекстинит:: Initialize**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize). Метод имеет три параметра, которые оболочка может использовать для передачи различных типов данных. Передаваемые значения зависят от типа обработчика, а некоторые могут иметь значение **null**.

-   *пидфолдер* содержит указатель папки на список идентификаторов элементов (Пидл). Для расширений таблицы свойств это значение равно **null**. Для расширений контекстного меню это ПИДЛ папки, содержащей элемент, контекстное меню которого отображается. Для обработчиков перетаскивания, не заданных по умолчанию, это ПИДЛ целевой папки.
-   *pDataObject* содержит указатель на интерфейс [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) объекта данных. Объект данных содержит одно или несколько имен файлов в формате [CF \_ HDROP](dragdrop.md) .
-   *хрегкэй* содержит раздел реестра для объекта File или типа Folder.

Метод [**ишеллекстинит:: Initialize**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) сохраняет имя файла, указатель [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) и раздел реестра, необходимые для последующего использования. В следующем фрагменте кода показана реализация **ишеллекстинит:: Initialize**. Для простоты в этом примере предполагается, что объект данных содержит только один файл. Как правило, он может содержать несколько файлов, которые необходимо извлечь.


```C++
LPCITEMIDLIST  m_pIDFolder;           //The folder's PIDL
wchar_t        m_szFile[MAX_PATH];    //The file name
IDataObject   *m_pDataObj;            //The IDataObject pointer
HKEY           m_hRegKey;             //The file or folder's registry key

STDMETHODIMP CShellExt::Initialize(LPCITEMIDLIST pIDFolder, 
                                   IDataObject *pDataObj, 
                                   HKEY hRegKey) 
{ 
    // If Initialize has already been called, release the old PIDL
    ILFree(m_pIDFolder);
    m_pIDFolder = nullptr;

    // Store the new PIDL.
    if (pIDFolder)
    {
        m_pIDFolder = ILClone(pIDFolder);
    }
    
    // If Initialize has already been called, release the old
    // IDataObject pointer.
    if (m_pDataObj)
    { 
        m_pDataObj->Release(); 
    }
     
    // If a data object pointer was passed in, save it and
    // extract the file name. 
    if (pDataObj) 
    { 
        m_pDataObj = pDataObj; 
        pDataObj->AddRef(); 
      
        STGMEDIUM   medium;
        FORMATETC   fe = {CF_HDROP, NULL, DVASPECT_CONTENT, -1, TYMED_HGLOBAL};
        UINT        uCount;

        if (SUCCEEDED(m_pDataObj->GetData(&fe, &medium)))
        {
            // Get the count of files dropped.
            uCount = DragQueryFile((HDROP)medium.hGlobal, (UINT)-1, NULL, 0);

            // Get the first file name from the CF_HDROP.
            if (uCount)
                DragQueryFile((HDROP)medium.hGlobal, 0, m_szFile, 
                              sizeof(m_szFile)/sizeof(TCHAR));

            ReleaseStgMedium(&medium);
        }
    }

    // Duplicate the registry handle. 
    if (hRegKey) 
        RegOpenKeyEx(hRegKey, nullptr, 0L, MAXIMUM_ALLOWED, &m_hRegKey); 
    return S_OK; 
}
```

Ксампликссандлер — имя класса, используемого для реализации интерфейса. Переменные **m \_ пидфолдер**, **m \_ pDataObject**, **m \_ сзфиленаме** и **m \_ хрегкэй** — это частные переменные, используемые для хранения передаваемых данных. Для простоты в этом примере предполагается, что объект данных будет содержать только одно имя файла. После получения структуры [**форматетк**](/windows/win32/api/objidl/ns-objidl-formatetc) из объекта данных [**драгкуерифиле**](/windows/desktop/api/Shellapi/nf-shellapi-dragqueryfilea) используется для извлечения имени файла из элемента **Medium. хглобал** структуры **форматетк** . Если передается раздел реестра, метод использует код [**RegOpenKeyEx**](/windows/win32/api/winreg/nf-winreg-regopenkeyexa) для открытия ключа и присваивает маркер **m \_ хрегкэй**.

### <a name="infotip-customization"></a>Настройка всплывающей подсказки

Существует два способа настройки инфотипс:

-   Реализуйте объект, который поддерживает [**икуеринфо**](/windows/win32/api/shlobj_core/nn-shlobj_core-iqueryinfo) , а затем зарегистрируйте этот объект в соответствующем подразделе реестра (см. раздел [Регистрация обработчиков расширений оболочки](#registering-shell-extension-handlers) ниже).
-   Укажите фиксированную строку или список определенных свойств файла для отображения.

Чтобы отобразить фиксированную строку для расширения пространства имен, создайте запись, вызываемую `InfoTip` в разделе *{CLSID}* расширения пространства имен. Задайте в качестве значения этой записи либо литеральную строку, которую нужно отобразить, как показано в этом примере, либо косвенную строку, указывающую ресурс и индекс в этом ресурсе (в целях локализации).

```
HKEY_CLASSES_ROOT
   CLSID
      {CLSID}
         InfoTip = InfoTip string for your namespace extension
```

Чтобы отобразить фиксированную строку для типа файла, создайте запись, вызываемую `InfoTip` в ключе *ProgID* этого типа файлов. Задайте в качестве значения этой записи либо литеральную строку, которую нужно отобразить, либо косвенную строку, указывающую ресурс и индекс в этом ресурсе (в целях локализации), как показано в этом примере.

```
HKEY_CLASSES_ROOT
   ProgID
      InfoTip = Resource.dll, 3
```

Если требуется, чтобы оболочка отображала определенные свойства файла в подсказке для конкретного типа файлов, создайте запись с именем `InfoTip` в разделе *ProgID* для этого типа файлов. Установите значение этой записи в виде разделенного точкой с запятой списка канонических имен свойств, идентификаторов FMTID (PID) или и того, и другого. Это значение должно начинаться с "Prop:", чтобы обозначить его как строку со списком свойств. Если опустить "Prop:", значение будет представлено в виде литеральной строки и отображаться таким образом.

В следующем примере *пропнаме* — это каноническое имя свойства (например, System. Date) и *{fmtid}, PID* — это пара [**fmtid/PID**](./objects.md) .

```
HKEY_CLASSES_ROOT
   ProgID
      InfoTip = prop:propname;propname;{fmtid},pid;{fmtid},pid
```

Можно использовать следующие имена свойств:



| Имя свойства    | Описание                   | Получено из                                                                             |
|------------------|-------------------------------|--------------------------------------------------------------------------------------------|
| Автор           | Автор документа        | [**\_Автор пидси**](../stg/the-summary-information-property-set.md)                              |
| Заголовок            | Название документа         | [**\_заголовок пидси**](../stg/the-summary-information-property-set.md)                               |
| Субъект          | Сводка по теме               | [**\_Тема пидси**](../stg/the-summary-information-property-set.md)                             |
| Комментировать          | Комментарии к документу             | [**Пидси \_ Свойства комментария**](../stg/the-summary-information-property-set.md) или папки/драйвера |
| PageCount        | Количество страниц               | [**ПИДСИ \_ PAGECOUNT**](../stg/the-summary-information-property-set.md)                           |
| Имя             | Понятное имя                 | Стандартное представление папки                                                                       |
| оригиналлокатион | Расположение исходного файла     | Папка "портфель" и папка "Корзина"                                                    |
| датеделетед      | Файл даты удален         | Папка корзины                                                                         |
| Тип             | Тип файла                  | Представление сведений о стандартной папке                                                               |
| Размер             | Размер файла                  | Представление сведений о стандартной папке                                                               |
| синккопин       | То же, что и Оригиналлокатион      | То же, что и Оригиналлокатион                                                                   |
| Изменен         | Дата последнего изменения            | Представление сведений о стандартной папке                                                               |
| Создание          | Дата создания                  | Представление сведений о стандартной папке                                                               |
| Обращения         | Дата последнего доступа            | Представление сведений о стандартной папке                                                               |
| Папка         | Каталог, содержащий файл | Результаты поиска документов                                                                    |
| Ранг             | Соответствие качества поиска       | Результаты поиска документов                                                                    |
| FreeSpace        | Доступное дисковое пространство       | Диски                                                                                |
| NumberOfVisits   | Количество посещений              | Папка "Избранное"                                                                           |
| Атрибуты       | Атрибуты файла               | Представление сведений о стандартной папке                                                               |
| Company          | Название организации                  | [**\_компания пиддси**](../stg/the-documentsummaryinformation-and-userdefined-property-sets.md)    |
| Category         | Категория документа             | [**\_Категория пиддси**](../stg/the-documentsummaryinformation-and-userdefined-property-sets.md)   |
| Авторские права        | Авторские права на мультимедиа               | [**ПИДМСИ \_ авторские права**](../stg/the-documentsummaryinformation-and-userdefined-property-sets.md)  |
| хтмлинфотипфиле  | Файл всплывающей подсказки HTML             | Файл Desktop.ini для папки                                                                |



 

## <a name="enhancing-windows-search-with-shell-extension-handlers"></a>Улучшение поиска Windows с помощью обработчиков расширений оболочки

Обработчики расширений оболочки могут использоваться для улучшения пользовательского интерфейса, предоставляемого обработчиком протокола поиска Windows. Чтобы включить такие улучшения, необходимо разработать вспомогательный обработчик расширения оболочки для интеграции с обработчиком протокола поиска в качестве источника данных. Сведения о расширении обработчика протокола поиска Windows с помощью интеграции с обработчиком расширений оболочки см. в разделе [Добавление значков, предварительных версий и контекстных меню](../search/-search-3x-wds-ph-ui-extensions.md). Дополнительные сведения о обработчиках протоколов поиска Windows см. в разделе [Разработка обработчиков протоколов](../search/-search-3x-wds-phaddins.md).

## <a name="registering-shell-extension-handlers"></a>Регистрация обработчиков расширений оболочки

Прежде чем оболочку сможет его использовать, необходимо зарегистрировать объект обработчика расширения оболочки. В этом разделе показано общее описание регистрации обработчика расширения оболочки.

Каждый раз при создании или изменении обработчика расширений оболочки важно уведомить систему, что вы внесли изменение в [**шчанженотифи**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shchangenotify), указав событие **шкне \_ ассокчанжед** . Если не вызвать **шчанженотифи**, изменение может быть не распознано, пока система не будет перезагружена.

Как и для всех COM-объектов, необходимо создать идентификатор GUID для обработчика с помощью такого средства, как UUIDGEN.exe. Создайте ключ в разделе **\_ классы hKey \_ root** \\ **CLSID** , имя которого является строковым форматом GUID. Так как обработчики расширений оболочки являются внутрипроцессного серверами, необходимо создать ключ **InprocServer32** в ключе GUID со значением по умолчанию, равным пути к DLL-файлу обработчика. Используйте модель потоков подразделений.

Каждый раз, когда оболочка принимает действие, которое может задействовать обработчик расширения оболочки, он проверяет соответствующий раздел реестра. Ключ, с которым зарегистрирован обработчик расширений, позволяет управлять тем, когда он будет вызываться. Например, при отображении оболочкой контекстного меню для элемента [типа файла](fa-file-types.md)обычно вызывается обработчик контекстного меню. В этом случае обработчик должен быть зарегистрирован в ключе **ProgID** типа файла.

### <a name="handler-names"></a>Имена обработчиков

Чтобы включить обработчик расширений оболочки, создайте подраздел с именем подраздела обработчика (см. ниже) в подразделе **шеллекс** (для типов файлов) **или в имени** типа объекта оболочки (для [предопределенных объектов оболочки](#predefined-shell-objects)).

Например, если вы хотите зарегистрировать обработчик расширения контекстного меню для MyProgram. 1, начните с создания следующего подраздела:

```
HKEY_CLASSES_ROOT
   MyProgram.1
      ShellEx
         ContextMenuHandlers
```

Для следующих обработчиков создайте подраздел под ключом "имя подраздела обработчика", имя которого является строковой версией CLSID расширения оболочки. Несколько расширений можно зарегистрировать с помощью ключа имени подраздела обработчика, создав несколько подразделов.



| Обработчик                                               | Интерфейс          | Имя подраздела обработчика       |
|-------------------------------------------------------|--------------------|---------------------------|
| Обработчик контекстного меню                                 | IContextMenu       | **контекстменухандлерс**   |
| Обработчик копихук                                      | икопихук          | **копихукхандлерс**      |
| Обработчик действия перетаскивания                                 | IContextMenu       | **драгдрофандлерс**      |
| Обработчик страницы свойств                                | ишеллпропшитекст | **пропертишисандлерс** |
| Обработчик поставщика столбцов (не рекомендуется в Windows Vista) | иколумнпровидер    | **колумнхандлерс**        |



 

Для следующих обработчиков значение по умолчанию ключа "имя подраздела обработчика" является строковой версией CLSID расширения оболочки. Для этих обработчиков можно зарегистрировать только одно расширение.



| Обработчик                 | Интерфейс                                         | Имя подраздела обработчика                        |
|-------------------------|---------------------------------------------------|--------------------------------------------|
| Обработчик данных            | IDataObject                                       | **DataHandler**                            |
| Удалить обработчик            | Интерфейс IDropTarget                                       | **дрофандлер**                            |
| Обработчик значков            | Иекстрактикона/W                                   | **иконхандлер**                            |
| Обработчик изображений           | иекстрактимаже                                     | **{BB2E617C-0920-11d1-9A0B-00C04FC2D6C1}** |
| Обработчик изображений эскиза | исумбнаилпровидер                                | **{E357FCCD-A995-4576-B01F-234630154E96}** |
| Обработчик подсказок         | икуеринфо                                        | **{00021500-0000-0000-C000-000000000046}** |
| Ссылка на оболочку (ANSI)      | ишелллинка                                       | **{000214EE-0000-0000-C000-000000000046}** |
| Ссылка на оболочку (Юникод)    | ишелллинкв                                       | **{000214F9-0000-0000-C000-000000000046}** |
| Структурированное хранилище      | Метод IStorage                                          | **{0000000B-0000-0000-C000-000000000046}** |
| Метаданные                | ипропертисторе                                    | **пропертихандлер**                        |
| Метаданные                | IPropertySetStorage (не рекомендуется в Windows Vista) | **пропертихандлер**                        |
| Закрепить в меню "Пуск"       | истартменупиннедлист                              | **{a2a9545d-a0c2-42b4-9708-a0b2badd77c8}** |
| Закрепление на панели задач          |                                                   | **{90AA3A4E-1CBA-4233-B8BB-535773D48449}** |



 

Подразделы, указанные для добавления **закрепления в меню "Пуск** " и " **закрепить на панели задач** " в контекстном меню элемента, необходимы только для типов файлов, включающих запись " [ярлык](./links.md) ".

В Windows Vista была удалена поддержка обработчиков поставщиков столбцов. Кроме того, начиная с Windows Vista, [**IPropertySetStorage**](/windows/win32/api/propidl/nn-propidl-ipropertysetstorage) является нерекомендуемым в пользу [**ипропертисторе**](/windows/win32/api/propsys/nn-propsys-ipropertystore).

Хотя [**иекстрактимаже**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-iextractimage) остается поддерживаемым, [**исумбнаилпровидер**](/windows/desktop/api/Thumbcache/nn-thumbcache-ithumbnailprovider) является предпочтительным для Windows Vista и более поздних версий.

### <a name="predefined-shell-objects"></a>Предопределенные объекты оболочки

Оболочка определяет дополнительные объекты в **\_ \_ корне классов hKey** , которые могут быть расширены так же, как и типы файлов. Например, чтобы добавить обработчик страницы свойств для всех файлов, можно выполнить регистрацию с помощью ключа **пропертишисандлерс** .

```
HKEY_CLASSES_ROOT
   *
      shellex
         PropertySheetHandlers
```

В следующей таблице приведены различные подразделы **\_ \_ корня классов hKey** , в которых можно регистрировать обработчики расширений. Обратите внимание, что многие обработчики расширений не могут быть зарегистрированы во всех перечисленных подразделах. Дополнительные сведения см. в документации по конкретному обработчику.



| Подраздел                    | Описание                                                          | Возможные обработчики                                | Version |
|---------------------------|----------------------------------------------------------------------|--------------------------------------------------|---------|
| **\** _                    | Все файлы                                                            | Контекстное меню, страница свойств, команды (см. ниже) | Все     |
| _ *Аллфилесистемобжектс**  | Все файлы и папки с файлами                                           | Контекстное меню, страница свойств, команды             | 4,71    |
| **Папка**                | Все папки                                                          | Контекстное меню, страница свойств, команды             | Все     |
| **Каталог**             | Папки с файлами                                                         | Контекстное меню, страница свойств, команды             | Все     |
| **\\Фон каталога** | Фон папки файлов                                               | Только контекстное меню                               | 4,71    |
| **Накопитель**                 | Все диски в MyComputer, например "C: \\ "                             | Контекстное меню, страница свойств, команды             | Все     |
| **Network**               | Вся сеть (в разделе Мое сетевое окружение)                             | Контекстное меню, страница свойств, команды             | Все     |
| **\\Тип сети\\\#**     | Все объекты типа \# (см. ниже)                                   | Контекстное меню, страница свойств, команды             | 4,71    |
| **нетшаре**              | Все общие сетевые папки                                                   | Контекстное меню, страница свойств, команды             | 4,71    |
| **нетсервер**             | Все сетевые серверы                                                  | Контекстное меню, страница свойств, команды             | 4,71    |
| *\_имя поставщика \_ сети* | Все объекты, предоставляемые поставщиком сетевых услуг "*\_ \_ имя поставщика* сети" | Контекстное меню, страница свойств, команды             | Все     |
| **принтеры;**              | Все принтеры                                                         | Контекстное меню, страница свойств                    | Все     |
| **аудиокд**               | Звуковой компакт-диск в дисководе компакт-дисков                                                 | Только глаголы                                       | Все     |
| **ОПТИЧЕСКИ**                   | DVD-дисковод (Windows 2000)                                             | Контекстное меню, страница свойств, команды             | 4,71    |



 

Примечания.

-   Доступ к контекстному меню фонового доступа к папке осуществляется путем щелчка правой кнопкой мыши в папке файла, но не для содержимого папки.
-   "Глаголы" — это специальные команды, зарегистрированные в команде оболочки **\_ \_ корневого** \\ *подраздела* для классов hKey \\  \\  .
-   Для  \\ **типа** сети \\ **\#** " \# " — это код типа поставщика сети в десятичном формате. Код типа поставщика сети — это старшее слово типа сети. Список сетевых типов указан в файле заголовка Виннетвк. h ( \_ значения вннк NET \_ \* ). Например, вннк \_ net \_ «0x00330000», поэтому соответствующий ключ типа будет содержать классы в **\_ \_ корневой** \\ **сети** \\ **типа** \\ **51** .
-   "*\_ \_ имя поставщика сети*" — это имя поставщика сети, указанное в [**внетжетпровидернаме**](/windows/win32/api/winnetwk/nf-winnetwk-wnetgetprovidernamea), а пробелы преобразуются в символы подчеркивания. Например, если установлен поставщик сетевых сетей Microsoft, его имя поставщика — «Microsoft Windows Network», а соответствующее *\_ \_ имя поставщика сети* — **Microsoft \_ Windows \_ Network**.

### <a name="example-of-an-extension-handler-registration"></a>Пример регистрации обработчика расширений

Чтобы включить определенный обработчик, создайте подключ в разделе типа обработчика расширений с именем обработчика. Оболочка не использует имя обработчика, но должно отличаться от всех других имен в подразделе этого типа. Задайте значение по умолчанию для подраздела Name в виде строки идентификатора GUID обработчика.

В следующем примере показаны записи реестра, которые позволяют использовать контекстное меню и обработчики расширений страниц свойств с использованием типа файла example. МИП:

```
HKEY_CLASSES_ROOT
   .myp
      (Default) = MyProgram.1
   CLSID
      {00000000-1111-2222-3333-444444444444}
         InProcServer32
            (Default) = C:\MyDir\MyCommand.dll
            ThreadingModel = Apartment
      {11111111-2222-3333-4444-555555555555}
         InProcServer32
            (Default) = C:\MyDir\MyPropSheet.dll
            ThreadingModel = Apartment
   MyProgram.1
      (Default) = MyProgram Application
      Shellex
         ContextMenuHandler
            MyCommand
               (Default) = {00000000-1111-2222-3333-444444444444}
         PropertySheetHandlers
            MyPropSheet
               (Default) = {11111111-2222-3333-4444-555555555555}
```

Процедура регистрации, описанная в этом разделе, должна соблюдаться для всех систем Windows.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Руководство по реализации расширений In-Process](shell-and-managed-code.md)
</dt> </dl>

 

 
