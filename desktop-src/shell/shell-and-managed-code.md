---
description: Внутрипроцессный расширения загружаются в любые процессы, которые их инициируют.
title: Руководство по реализации расширений In-Process
ms.topic: article
ms.date: 05/31/2018
ms.assetid: FE830DBF-3F18-453c-9A51-91E10559D0E8
api_name: ''
api_type: ''
api_location: ''
topic_type:
- kbArticle
ms.openlocfilehash: e4dc9fd0573f3f98f0ec1110079f95f56a8c42e1
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103999621"
---
# <a name="guidance-for-implementing-in-process-extensions"></a><span data-ttu-id="35371-103">Руководство по реализации расширений In-Process</span><span class="sxs-lookup"><span data-stu-id="35371-103">Guidance for Implementing In-Process Extensions</span></span>

<span data-ttu-id="35371-104">Внутрипроцессный расширения загружаются в любые процессы, которые их инициируют.</span><span class="sxs-lookup"><span data-stu-id="35371-104">In-process extensions are loaded into any processes that trigger them.</span></span> <span data-ttu-id="35371-105">Например, расширение пространства имен оболочки может быть загружено в любой процесс, который обращается к пространству имен оболочки напрямую или косвенно.</span><span class="sxs-lookup"><span data-stu-id="35371-105">For example, a Shell namespace extension can be loaded into any process which accesses the Shell namespace either directly or indirectly.</span></span> <span data-ttu-id="35371-106">Пространство имен оболочки используется многими операциями оболочки, такими как отображение общего файла диалогового окна, запуск документа через связанное приложение или получение значка, используемого для представления файла.</span><span class="sxs-lookup"><span data-stu-id="35371-106">The Shell namespace is used by many Shell operations, such as the display of a common file dialog, the launch of a document through its associated application, or the obtaining of the icon used to represent a file.</span></span> <span data-ttu-id="35371-107">Так как добавочные расширения могут загружаться в произвольные процессы, следует соблюдать осторожность, чтобы они не влияли на ведущее приложение или другие внутрипроцессный расширения.</span><span class="sxs-lookup"><span data-stu-id="35371-107">Because in-process extensions can be loaded into arbitrary processes, care must be taken that they do not negatively impact the host application or other in-process extensions.</span></span>

<span data-ttu-id="35371-108">Одной из сред выполнения определенной заметки является *общеязыковая среда выполнения (CLR)*, также известная как *управляемый код* или *платформа .NET Framework*.</span><span class="sxs-lookup"><span data-stu-id="35371-108">One runtime of particular note is the *common language runtime (CLR)*, also known as *managed code* or the *.NET Framework*.</span></span> <span data-ttu-id="35371-109">**Корпорация Майкрософт рекомендует писать управляемые встроенные расширения в проводнике Windows или Windows Internet Explorer и не считать их поддерживаемым сценарием.**</span><span class="sxs-lookup"><span data-stu-id="35371-109">**Microsoft recommends against writing managed in-process extensions to Windows Explorer or Windows Internet Explorer and does not consider them a supported scenario.**</span></span>

<span data-ttu-id="35371-110">В этом разделе обсуждаются факторы, которые следует учитывать при определении того, подходит ли любая среда выполнения, отличная от среды CLR, для использования в внутрипроцессного расширениях.</span><span class="sxs-lookup"><span data-stu-id="35371-110">This topic discusses factors to consider when you determine whether any runtime other than the CLR is suitable for use by in-process extensions.</span></span> <span data-ttu-id="35371-111">Примерами других сред выполнения являются Java, Visual Basic, JavaScript, ECMAScript, Delphi и библиотека времени выполнения C/C++.</span><span class="sxs-lookup"><span data-stu-id="35371-111">Examples of other runtimes include Java, Visual Basic, JavaScript/ECMAScript, Delphi, and the C/C++ runtime library.</span></span> <span data-ttu-id="35371-112">В этом разделе также приведены некоторые причины, по которым управляемый код не поддерживается в внутрипроцессного расширениях.</span><span class="sxs-lookup"><span data-stu-id="35371-112">This topic also provides some reasons that managed code is unsupported in in-process extensions.</span></span>

## <a name="version-conflicts"></a><span data-ttu-id="35371-113">Конфликты версий</span><span class="sxs-lookup"><span data-stu-id="35371-113">Version Conflicts</span></span>

<span data-ttu-id="35371-114">Конфликт версий может возникать в среде выполнения, которая не поддерживает загрузку нескольких версий среды выполнения в рамках одного процесса.</span><span class="sxs-lookup"><span data-stu-id="35371-114">A version conflict can arise through a runtime that does not support the loading of multiple runtime versions within a single process.</span></span> <span data-ttu-id="35371-115">Версии среды CLR до версии 4,0 попадают в эту категорию.</span><span class="sxs-lookup"><span data-stu-id="35371-115">Versions of the CLR prior to version 4.0 fall into this category.</span></span> <span data-ttu-id="35371-116">Если загрузка одной версии среды выполнения препятствует загрузке других версий этой же среды выполнения, это может создать конфликт, если ведущее приложение или другое внутрипроцессный расширение использует конфликтующую версию.</span><span class="sxs-lookup"><span data-stu-id="35371-116">If the loading of one version of a runtime precludes the loading of other versions of that same runtime, this can create a conflict if the host application or another in-process extension uses a conflicting version.</span></span> <span data-ttu-id="35371-117">В случае конфликта версий с другим внутрипроцессный расширением конфликт может быть трудно воспроизвести, так как при сбое требуются правильные расширения, а режим сбоя зависит от порядка, в котором загружаются конфликтующие расширения.</span><span class="sxs-lookup"><span data-stu-id="35371-117">In the case of a version conflict with another in-process extension, the conflict can be difficult to reproduce because the failure requires the right conflicting extensions and the failure mode depends on the order in which the conflicting extensions are loaded.</span></span>

<span data-ttu-id="35371-118">Рассмотрим внутрипроцессный модуль, написанный с помощью версии CLR до версии 4,0.</span><span class="sxs-lookup"><span data-stu-id="35371-118">Consider an in-process extension written using a version of the CLR prior to version 4.0.</span></span> <span data-ttu-id="35371-119">Каждое приложение на компьютере, использующем диалоговое окно **открытия** файла, потенциально может иметь управляемый код диалогового окна и зависимость CLR от его участника, загруженного в процесс приложения.</span><span class="sxs-lookup"><span data-stu-id="35371-119">Every application on the computer that uses a file **Open** dialog box could potentially have the dialog's managed code and its attendant CLR dependency loaded into the application's process.</span></span> <span data-ttu-id="35371-120">Приложение или расширение, которое сначала загружает 4,0 предварительную версию среды CLR в процесс приложения, ограничены тем, какие версии среды CLR могут использоваться этим процессом в дальнейшем.</span><span class="sxs-lookup"><span data-stu-id="35371-120">The application or extension that is first to load a pre-4.0 version of the CLR into the application's process restricts which versions of the CLR can be used subsequently by that process.</span></span> <span data-ttu-id="35371-121">Если управляемое приложение с **открытым** диалоговым окном построено на основе конфликтующей версии среды CLR, то расширение может завершиться неудачно и может привести к сбоям в работе приложения.</span><span class="sxs-lookup"><span data-stu-id="35371-121">If a managed application with an **Open** dialog box is built on a conflicting version of the CLR, then the extension could fail to run correctly and could cause failures in the application.</span></span> <span data-ttu-id="35371-122">И наоборот, если расширение является первым для загрузки в процессе, а конфликтующая версия управляемого кода пытается запуститься после этого (возможно, управляемое приложение или запущенное приложение загружает CLR по требованию), операция завершается ошибкой.</span><span class="sxs-lookup"><span data-stu-id="35371-122">Conversely, if the extension is the first to load in a process and a conflicting version of managed code tries to launch after that (perhaps a managed application or a running application loads the CLR on demand), the operation fails.</span></span> <span data-ttu-id="35371-123">Пользователю кажется, что некоторые функции приложения случайным образом перестают работать или приложение мистериаусли аварийно завершает работу.</span><span class="sxs-lookup"><span data-stu-id="35371-123">To the user, it appears that some features of the application randomly stop working, or the application mysteriously crashes.</span></span>

<span data-ttu-id="35371-124">Обратите внимание, что версии CLR, равные или более поздние, чем версия 4,0, обычно не подвержены проблеме с управлением версиями, так как они предназначены для совместного использования и с большинством предварительно 4,0 версий среды CLR (за исключением версии 1,0, которая не может сосуществовать с другими версиями).</span><span class="sxs-lookup"><span data-stu-id="35371-124">Note that versions of the CLR equal to or later than version 4.0 are not generally susceptible to the versioning problem because they are designed to coexist with each other and with most pre-4.0 versions of the CLR (with the exception of version 1.0, which cannot coexist with other versions).</span></span> <span data-ttu-id="35371-125">Однако в оставшейся части этого раздела могут возникнуть проблемы, отличные от конфликтов версий.</span><span class="sxs-lookup"><span data-stu-id="35371-125">However, issues other than version conflicts can arise as discussed in the remainder of this topic.</span></span>

## <a name="performance-issues"></a><span data-ttu-id="35371-126">Проблемы с производительностью</span><span class="sxs-lookup"><span data-stu-id="35371-126">Performance Issues</span></span>

<span data-ttu-id="35371-127">Проблемы с производительностью могут возникать в средах выполнения, которые приводят к значительному снижению производительности при загрузке в процесс.</span><span class="sxs-lookup"><span data-stu-id="35371-127">Performance issues can arise with runtimes that impose a significant performance penalty when they are loaded into a process.</span></span> <span data-ttu-id="35371-128">Снижение производительности может быть в виде использования памяти, загрузки ЦП, затраченного времени или даже использования адресного пространства.</span><span class="sxs-lookup"><span data-stu-id="35371-128">The performance penalty can be in the form of memory usage, CPU usage, elapsed time, or even address space consumption.</span></span> <span data-ttu-id="35371-129">CLR, JavaScript, ECMAScript и Java известны как среды выполнения с высокой степенью влияния.</span><span class="sxs-lookup"><span data-stu-id="35371-129">The CLR, JavaScript/ECMAScript, and Java are known to be high-impact runtimes.</span></span> <span data-ttu-id="35371-130">Так как добавочные расширения могут загружаться во многие процессы и часто выполняются с учетом времени, зависящего от производительности (например, при подготовке меню к отображению пользователя), среда выполнения с высокой степенью влияния может негативно повлиять на общую скорость реагирования.</span><span class="sxs-lookup"><span data-stu-id="35371-130">Since in-process extensions can be loaded into many processes, and are often done so at performance-sensitive moments (such as when preparing a menu to be displayed the user), high-impact runtimes can negatively impact overall responsiveness.</span></span>

<span data-ttu-id="35371-131">Среда выполнения с высоким уровнем влияния, которая потребляет значительные ресурсы, может вызвать сбой в хост-процессе или другом внутрипроцессного расширении.</span><span class="sxs-lookup"><span data-stu-id="35371-131">A high-impact runtime that consumes significant resources can cause a failure in the host process or another in-process extension.</span></span> <span data-ttu-id="35371-132">Например, среда выполнения с высоким уровнем влияния, которая потребляет сотни мегабайт адресного пространства для кучи, может привести к тому, что ведущему приложению не удастся загрузить большой набор данных.</span><span class="sxs-lookup"><span data-stu-id="35371-132">For example, a high-impact runtime that consumes hundreds of megabytes of address space for its heap can result in the host application being unable to load a large dataset.</span></span> <span data-ttu-id="35371-133">Более того, так как добавочные расширения могут загружаться в несколько процессов, высокое потребление ресурсов в одном расширении может быстро преноситься к общему потреблению ресурсов во всей системе.</span><span class="sxs-lookup"><span data-stu-id="35371-133">Furthermore, because in-process extensions can be loaded into multiple processes, high resource consumption in a single extension can quickly multiply into high resource consumption across the entire system.</span></span>

<span data-ttu-id="35371-134">Если среда выполнения остается загруженной или продолжает потреблять ресурсы, даже если расширение, использующее эту среду выполнения, выгружено, то среда выполнения не подходит для использования в расширении.</span><span class="sxs-lookup"><span data-stu-id="35371-134">If a runtime remains loaded or otherwise continues to consume resources even when the extension that uses that runtime has unloaded, then that runtime is not suitable for use in an extension.</span></span>

## <a name="issues-specific-to-the-net-framework"></a><span data-ttu-id="35371-135">Проблемы, характерные для платформа .NET Framework</span><span class="sxs-lookup"><span data-stu-id="35371-135">Issues Specific to the .NET Framework</span></span>

<span data-ttu-id="35371-136">В следующих разделах рассматриваются примеры проблем, обнаруженных с помощью управляемого кода для расширений.</span><span class="sxs-lookup"><span data-stu-id="35371-136">The following sections discuss examples of issues found with using managed code for extensions.</span></span> <span data-ttu-id="35371-137">Они не являются полным списком возможных проблем, которые могут возникнуть.</span><span class="sxs-lookup"><span data-stu-id="35371-137">They are not a complete list of all possible issues that you might encounter.</span></span> <span data-ttu-id="35371-138">Обсуждаемые здесь проблемы являются причиной того, что управляемый код не поддерживается в расширениях и моменты, которые следует учитывать при оценке использования других сред выполнения.</span><span class="sxs-lookup"><span data-stu-id="35371-138">The issues discussed here are both reasons that managed code is not supported in extensions and points to consider when you evaluate the use of other runtimes.</span></span>

### <a name="re-entrancy"></a><span data-ttu-id="35371-139">Повторный вход</span><span class="sxs-lookup"><span data-stu-id="35371-139">Re-entrancy</span></span>

<span data-ttu-id="35371-140">Если среда CLR блокирует поток однопотокового подразделения (STA), например из-за оператора Monitor. Enter, WaitHandle. WaitOne или инструкции [**Lock**](https://msdn.microsoft.com/library/c5kehkcz(v=VS.71).aspx) , среда CLR, в своей стандартной конфигурации, вводит вложенный цикл обработки сообщений в ожидании.</span><span class="sxs-lookup"><span data-stu-id="35371-140">When the CLR blocks a single-threaded apartment (STA) thread, for example, due to a Monitor.Enter, WaitHandle.WaitOne, or contended [**lock**](https://msdn.microsoft.com/library/c5kehkcz(v=VS.71).aspx) statement, the CLR, in its standard configuration, enters a nested message loop while it waits.</span></span> <span data-ttu-id="35371-141">Многие методы расширения запрещают обработку сообщений, и этот непредсказуемый и непредвиденный повторный вход может привести к аномальному поведению, что сложно воспроизвести и диагностировать.</span><span class="sxs-lookup"><span data-stu-id="35371-141">Many extension methods are prohibited from processing messages, and this unpredictable and unexpected reentrancy can result in anomalous behavior which is difficult to reproduce and diagnose.</span></span>

### <a name="the-multithreaded-apartment"></a><span data-ttu-id="35371-142">Многопоточный апартамент</span><span class="sxs-lookup"><span data-stu-id="35371-142">The Multithreaded Apartment</span></span>

<span data-ttu-id="35371-143">Среда CLR создает *вызываемые обертки среды выполнения* для COM-объектов.</span><span class="sxs-lookup"><span data-stu-id="35371-143">The CLR creates *Runtime Callable Wrappers* for Component Object Model (COM) objects.</span></span> <span data-ttu-id="35371-144">Эти же вызываемые оболочки времени выполнения уничтожаются позже методом завершения среды CLR, который является частью многопоточного подразделения (MTA).</span><span class="sxs-lookup"><span data-stu-id="35371-144">These same Runtime Callable Wrappers are destroyed later by the CLR's finalizer, which is part of the multithreaded apartment (MTA).</span></span> <span data-ttu-id="35371-145">Для перемещения прокси-сервера из STA в MTA требуется маршалинг, но не все интерфейсы, используемые расширениями, могут быть упакованы.</span><span class="sxs-lookup"><span data-stu-id="35371-145">Moving the proxy from the STA to the MTA requires marshaling, but not all interfaces used by extensions can be marshalled.</span></span>

### <a name="non-deterministic-object-lifetimes"></a><span data-ttu-id="35371-146">Недетерминированные времена жизни объектов</span><span class="sxs-lookup"><span data-stu-id="35371-146">Non-Deterministic Object Lifetimes</span></span>

<span data-ttu-id="35371-147">Среда CLR обеспечивает более слабое время существования объектов, чем машинный код.</span><span class="sxs-lookup"><span data-stu-id="35371-147">The CLR has weaker object lifetime guarantees than native code.</span></span> <span data-ttu-id="35371-148">Многие расширения имеют требования к количеству ссылок на объекты и интерфейсы, а модель сбора мусора, используемая средой CLR, не может удовлетворить эти требования.</span><span class="sxs-lookup"><span data-stu-id="35371-148">Many extensions have reference count requirements on objects and interfaces, and the garbage-collection model employed by the CLR cannot fulfill these requirements.</span></span>

-   <span data-ttu-id="35371-149">Если объект CLR получает ссылку на COM-объект, ссылка на COM-объект, удерживаемая вызываемой оболочкой времени выполнения, не освобождается до тех пор, пока вызываемая оболочка не будет собрана сборщиком мусора.</span><span class="sxs-lookup"><span data-stu-id="35371-149">If a CLR object obtains a reference to a COM object, the COM object reference held by the Runtime Callable Wrapper is not released until the Runtime Callable Wrapper is garbage-collected.</span></span> <span data-ttu-id="35371-150">Недетерминированное поведение выпуска может конфликтовать с некоторыми контрактами интерфейса.</span><span class="sxs-lookup"><span data-stu-id="35371-150">Nondeterministic release behavior can conflict with some interface contracts.</span></span> <span data-ttu-id="35371-151">Например, метод [**IPersistPropertyBag:: Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/aa768206(v=vs.85)) требует, чтобы ссылка на контейнер свойств не сохранялась объектом при возврате из метода **Load** .</span><span class="sxs-lookup"><span data-stu-id="35371-151">For example, the [**IPersistPropertyBag::Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/aa768206(v=vs.85)) method requires that no reference to the property bag be retained by the object when the **Load** method returns.</span></span>
-   <span data-ttu-id="35371-152">Если ссылка на объект CLR возвращается в машинный код, вызываемая оболочка времени выполнения освобождает ссылку на объект CLR, [**когда выполняется окончательный**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) вызов вызываемой оболочки времени выполнения, но базовый объект CLR не завершается до тех пор, пока не будет собран сборщик мусора.</span><span class="sxs-lookup"><span data-stu-id="35371-152">If a CLR object reference is returned to native code, the Runtime Callable Wrapper relinquishes its reference to the CLR object when the Runtime Callable Wrapper's final call to [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) is made, but the underlying CLR object is not finalized until it is garbage-collected.</span></span> <span data-ttu-id="35371-153">Недетерминированная финализация может конфликтовать с некоторыми контрактами интерфейса.</span><span class="sxs-lookup"><span data-stu-id="35371-153">Nondeterministic finalization can conflict with some interface contracts.</span></span> <span data-ttu-id="35371-154">Например, обработчики эскизов должны освобождать все ресурсы немедленно, если их счетчик ссылок становится равным нулю.</span><span class="sxs-lookup"><span data-stu-id="35371-154">For example, thumbnail handlers are required to release all resources immediately when their reference count drops to zero.</span></span>

## <a name="acceptable-uses-of-managed-code-and-other-runtimes"></a><span data-ttu-id="35371-155">Допустимые варианты использования управляемого кода и других сред выполнения</span><span class="sxs-lookup"><span data-stu-id="35371-155">Acceptable Uses of Managed Code and Other Runtimes</span></span>

<span data-ttu-id="35371-156">Для реализации необработанных расширений допустимо использовать управляемый код и другие среды выполнения.</span><span class="sxs-lookup"><span data-stu-id="35371-156">It is acceptable to use managed code and other runtimes to implement out-of-process extensions.</span></span> <span data-ttu-id="35371-157">Ниже приведены примеры расширений вне процесса оболочки.</span><span class="sxs-lookup"><span data-stu-id="35371-157">Examples of out-of-process Shell extensions include the following:</span></span>

-   <span data-ttu-id="35371-158">Обработчики просмотра</span><span class="sxs-lookup"><span data-stu-id="35371-158">Preview handlers</span></span>
-   <span data-ttu-id="35371-159">Действия на основе командной строки, такие как зарегистрированные в  \\  \\ подразделах **команд** оболочки.</span><span class="sxs-lookup"><span data-stu-id="35371-159">Command-line-based actions such as those registered under **shell**\\*verb*\\**command** subkeys.</span></span>
-   <span data-ttu-id="35371-160">COM-объекты, реализованные на локальном сервере, для точек расширения оболочки, допускающих незавершенную активацию.</span><span class="sxs-lookup"><span data-stu-id="35371-160">COM objects implemented in a local server, for Shell extension points that allow out-of-process activation.</span></span>

<span data-ttu-id="35371-161">Некоторые расширения могут быть реализованы либо как внутрипроцессный, либо вне процесса.</span><span class="sxs-lookup"><span data-stu-id="35371-161">Some extensions can be implemented either as in-process or out-of-process extensions.</span></span> <span data-ttu-id="35371-162">Эти расширения можно реализовать как необработанные расширения, если они не соответствуют этим требованиям для внутрипроцессного расширения.</span><span class="sxs-lookup"><span data-stu-id="35371-162">You can implement these extensions as out-of-process extensions if they do not meet these requirements for in-process extensions.</span></span> <span data-ttu-id="35371-163">В следующем списке приведены примеры расширений, которые могут быть реализованы как в внутрипроцессный, так и в необработанных расширениях.</span><span class="sxs-lookup"><span data-stu-id="35371-163">The following list shows examples of extensions that can be implemented as either in-process or out-of-process extensions:</span></span>

-   <span data-ttu-id="35371-164">[**Иексекутекомманд**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-iexecutecommand) , связанная с записью **делегатиксекуте** , зарегистрированной в  \\  \\ подразделе **Командная команда** оболочки.</span><span class="sxs-lookup"><span data-stu-id="35371-164">[**IExecuteCommand**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-iexecutecommand) associated with a **DelegateExecute** entry registered under a **shell**\\*verb*\\**command** subkey.</span></span>
-   <span data-ttu-id="35371-165">[**Интерфейс IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) , связанный с CLSID, зарегистрированным в \\  \\ подразделе оболочки **дроптаржет** .</span><span class="sxs-lookup"><span data-stu-id="35371-165">[**IDropTarget**](/windows/win32/api/oleidl/nn-oleidl-idroptarget) associated with the CLSID registered under a **shell**\\*verb*\\**DropTarget** subkey.</span></span>
-   <span data-ttu-id="35371-166">[**Иексплореркоммандстате**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-iexplorercommandstate) , связанный с записью **коммандстатехандлер** , зарегистрированной в  \\ подразделе *команды* оболочки.</span><span class="sxs-lookup"><span data-stu-id="35371-166">[**IExplorerCommandState**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-iexplorercommandstate) associated with a **CommandStateHandler** entry registered under a **shell**\\*verb* subkey.</span></span>

 

 
