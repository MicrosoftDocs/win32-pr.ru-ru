---
description: Функция обратного вызова Кплапплет обрабатывает все сообщения, отправляемые в элемент панели управления Windows. Сообщения, отправляемые в функцию, задаются в определенном порядке. С помощью одного и того же маркера элемент. cpl требует, чтобы сообщения обрабатывались особым образом.
ms.assetid: 70302698-f9d5-4de4-a662-4815002eea52
title: Обработка сообщений в панели управления
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0b8b43c6e265030279a6644547f41e3630208325
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103999051"
---
# <a name="control-panel-message-processing"></a><span data-ttu-id="b4e59-105">Обработка сообщений в панели управления</span><span class="sxs-lookup"><span data-stu-id="b4e59-105">Control Panel Message Processing</span></span>

<span data-ttu-id="b4e59-106">Функция обратного вызова [**кплапплет**](/windows/win32/api/cpl/nc-cpl-applet_proc) обрабатывает все сообщения, отправляемые в элемент панели управления Windows.</span><span class="sxs-lookup"><span data-stu-id="b4e59-106">The [**CPlApplet**](/windows/win32/api/cpl/nc-cpl-applet_proc) callback function processes all messages sent to a Control Panel item by Windows.</span></span> <span data-ttu-id="b4e59-107">Сообщения, отправляемые в функцию, задаются в определенном порядке.</span><span class="sxs-lookup"><span data-stu-id="b4e59-107">Messages sent to the function are in a specific order.</span></span> <span data-ttu-id="b4e59-108">С помощью одного и того же маркера элемент. cpl требует, чтобы сообщения обрабатывались особым образом.</span><span class="sxs-lookup"><span data-stu-id="b4e59-108">By the same token, the .cpl item requires the messages to be processed in a specific way.</span></span>

<span data-ttu-id="b4e59-109">Во первых, функция [**кплапплет**](/windows/win32/api/cpl/nc-cpl-applet_proc) получает сообщение CPL \_ init, когда Windows впервые загружает элемент панели управления.</span><span class="sxs-lookup"><span data-stu-id="b4e59-109">First, the [**CPlApplet**](/windows/win32/api/cpl/nc-cpl-applet_proc) function receives the CPL\_INIT message when Windows first loads the Control Panel item.</span></span> <span data-ttu-id="b4e59-110">Функция должна выполнять любую инициализацию, например выделение памяти, и возвращать ненулевое значение.</span><span class="sxs-lookup"><span data-stu-id="b4e59-110">The function should carry out any initialization, such as allocating memory, and return nonzero.</span></span> <span data-ttu-id="b4e59-111">Если **кплапплет** не может завершить инициализацию, он должен вернуть ноль, направляя Windows для завершения обмена данными и освобождения библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="b4e59-111">If **CPlApplet** cannot complete the initialization, it must return zero, directing Windows to terminate communication and release the DLL.</span></span>

<span data-ttu-id="b4e59-112">Затем, если сообщение CPL \_ init прошло удачно, Windows отправляет \_ сообщение CPL NOCOUNT.</span><span class="sxs-lookup"><span data-stu-id="b4e59-112">Next, if the CPL\_INIT message succeeded, Windows sends the CPL\_GETCOUNT message.</span></span> <span data-ttu-id="b4e59-113">Затем функция должна возвращать количество элементов панели управления, поддерживаемое DLL-файлом.</span><span class="sxs-lookup"><span data-stu-id="b4e59-113">The function must then return the number of Control Panel items supported by the .dll file.</span></span>

<span data-ttu-id="b4e59-114">Затем функция [**кплапплет**](/windows/win32/api/cpl/nc-cpl-applet_proc) получает одно \_ сообщение с запросом CPL и одно \_ сообщение CPL Невинкуире для каждого элемента панели управления, поддерживаемого DLL-файлом.</span><span class="sxs-lookup"><span data-stu-id="b4e59-114">The [**CPlApplet**](/windows/win32/api/cpl/nc-cpl-applet_proc) function then receives one CPL\_INQUIRE message and one CPL\_NEWINQUIRE message for each Control Panel item supported by the .dll file.</span></span> <span data-ttu-id="b4e59-115">Функция заполняет структуру [**кплинфо**](/windows/win32/api/cpl/ns-cpl-cplinfo) или [**невкплинфо**](/windows/win32/api/cpl/ns-cpl-newcplinfoa) сведениями об элементе, например его имя, значок и описательную строку.</span><span class="sxs-lookup"><span data-stu-id="b4e59-115">The function fills in a [**CPLINFO**](/windows/win32/api/cpl/ns-cpl-cplinfo) or [**NEWCPLINFO**](/windows/win32/api/cpl/ns-cpl-newcplinfoa) structure with information about your item, such as its name, icon, and a descriptive string.</span></span> <span data-ttu-id="b4e59-116">Большинство приложений должны обрабатывать сообщение с \_ запросом CPL и игнорировать сообщение CPL \_ невинкуире.</span><span class="sxs-lookup"><span data-stu-id="b4e59-116">Most applications should process the CPL\_INQUIRE message and ignore the CPL\_NEWINQUIRE message.</span></span> <span data-ttu-id="b4e59-117">Сообщение с \_ запросом CPL предоставляет сведения в форме, которую Windows может кэшировать, что приводит к значительному повышению производительности.</span><span class="sxs-lookup"><span data-stu-id="b4e59-117">The CPL\_INQUIRE message provides information in a form that Windows can cache, which results in much better performance.</span></span> <span data-ttu-id="b4e59-118">Сообщение CPL \_ невинкуире используется только в том случае, если необходимо изменить значок элемента или отобразить строки в зависимости от состояния компьютера.</span><span class="sxs-lookup"><span data-stu-id="b4e59-118">The CPL\_NEWINQUIRE message is used only if you need to change your item's icon or display strings based on the state of the computer.</span></span> <span data-ttu-id="b4e59-119">Элементы панели управления, использующие CPL \_ невинкуире, не могут быть найдены в меню " **Пуск** " в Windows Vista, так как они полагаются на кэширование.</span><span class="sxs-lookup"><span data-stu-id="b4e59-119">Control Panel items that use CPL\_NEWINQUIRE cannot be found by a **Start** menu search in Windows Vista because it relies on caching.</span></span>

<span data-ttu-id="b4e59-120">Функция [**кплапплет**](/windows/win32/api/cpl/nc-cpl-applet_proc) далее получает \_ сообщение CPL дблклк в качестве уведомления о том, что пользователь выбрал значок, представляющий элемент панели управления.</span><span class="sxs-lookup"><span data-stu-id="b4e59-120">The [**CPlApplet**](/windows/win32/api/cpl/nc-cpl-applet_proc) function next receives a CPL\_DBLCLK message as a notification that the user has chosen the icon that represents the Control Panel item.</span></span> <span data-ttu-id="b4e59-121">Функция может получить это сообщение любое количество раз.</span><span class="sxs-lookup"><span data-stu-id="b4e59-121">The function might receive this message any number of times.</span></span> <span data-ttu-id="b4e59-122">Сообщение содержит идентификатор элемента и указатель **лпдата** , возвращенный в структуре [**кплинфо**](/windows/win32/api/cpl/ns-cpl-cplinfo) или [**невкплинфо**](/windows/win32/api/cpl/ns-cpl-newcplinfoa) в вызове [**CPL \_**](cpl-inquire.md) Call или [**CPL \_ невинкуире**](cpl-newinquire.md).</span><span class="sxs-lookup"><span data-stu-id="b4e59-122">The message includes the item identifier and the **lpData** pointer returned in the [**CPLINFO**](/windows/win32/api/cpl/ns-cpl-cplinfo) or [**NEWCPLINFO**](/windows/win32/api/cpl/ns-cpl-newcplinfoa) structure in the call to [**CPL\_INQUIRE**](cpl-inquire.md) or [**CPL\_NEWINQUIRE**](cpl-newinquire.md).</span></span> <span data-ttu-id="b4e59-123">Функция должна отображать соответствующее диалоговое окно и обрабатывать последующие входные данные пользователя.</span><span class="sxs-lookup"><span data-stu-id="b4e59-123">The function should display the corresponding dialog box and process subsequent user input.</span></span>

<span data-ttu-id="b4e59-124">Помимо CPL \_ дблклк, сообщение CPL \_ стартвпармс может быть отправлено, если элемент панели управления вызывается с входными параметрами, например из командной строки или из другой программы.</span><span class="sxs-lookup"><span data-stu-id="b4e59-124">Besides CPL\_DBLCLK, the CPL\_STARTWPARMS message can be sent if a Control Panel item is invoked with input parameters, such as from a command prompt or from another program.</span></span> <span data-ttu-id="b4e59-125">Сообщение содержит идентификатор элемента вместе с дополнительной строкой параметра.</span><span class="sxs-lookup"><span data-stu-id="b4e59-125">The message includes the item identifier along with the additional parameter string.</span></span>

<span data-ttu-id="b4e59-126">Перед завершением управления приложением [**кплапплет**](/windows/win32/api/cpl/nc-cpl-applet_proc) получает \_ сообщение об ошибке CPL по одному разу для каждого элемента панели управления, поддерживаемого DLL-файлом.</span><span class="sxs-lookup"><span data-stu-id="b4e59-126">Before the controlling application terminates, [**CPlApplet**](/windows/win32/api/cpl/nc-cpl-applet_proc) receives the CPL\_STOP message once for each Control Panel item supported by the .dll file.</span></span> <span data-ttu-id="b4e59-127">Сообщение содержит идентификатор для элемента панели управления и указатель **лпдата** , возвращенный в структуре [**кплинфо**](/windows/win32/api/cpl/ns-cpl-cplinfo) или [**невкплинфо**](/windows/win32/api/cpl/ns-cpl-newcplinfoa) в вызове [**CPL \_ запрос**](cpl-inquire.md) или [**CPL \_ невинкуире**](cpl-newinquire.md).</span><span class="sxs-lookup"><span data-stu-id="b4e59-127">The message includes the identifier for the Control Panel item and the **lpData** pointer returned in the [**CPLINFO**](/windows/win32/api/cpl/ns-cpl-cplinfo) or [**NEWCPLINFO**](/windows/win32/api/cpl/ns-cpl-newcplinfoa) structure in the call to [**CPL\_INQUIRE**](cpl-inquire.md) or [**CPL\_NEWINQUIRE**](cpl-newinquire.md).</span></span> <span data-ttu-id="b4e59-128">Функция должна освободить память, выделенную для указанного диалогового окна.</span><span class="sxs-lookup"><span data-stu-id="b4e59-128">The function should free any memory that it allocated for the specified dialog box.</span></span>

<span data-ttu-id="b4e59-129">После последнего \_ сообщения об ошибке CPL [**кплапплет**](/windows/win32/api/cpl/nc-cpl-applet_proc) получает сообщение о \_ выходе CPL.</span><span class="sxs-lookup"><span data-stu-id="b4e59-129">After the last CPL\_STOP message, [**CPlApplet**](/windows/win32/api/cpl/nc-cpl-applet_proc) receives a CPL\_EXIT message.</span></span> <span data-ttu-id="b4e59-130">Функция должна освободить всю оставшуюся выделенную память и отменить регистрацию всех закрытых классов окна, которые могли быть зарегистрированы.</span><span class="sxs-lookup"><span data-stu-id="b4e59-130">The function should free all remaining allocated memory and unregister any private window classes that it might have registered.</span></span> <span data-ttu-id="b4e59-131">Сразу после того, как функция возвращает из этого сообщения, Windows освобождает элемент панели управления, вызывая функцию [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) .</span><span class="sxs-lookup"><span data-stu-id="b4e59-131">Immediately after the function returns from this message, Windows releases the Control Panel item by calling the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function.</span></span>

## <a name="related-topics"></a><span data-ttu-id="b4e59-132">См. также</span><span class="sxs-lookup"><span data-stu-id="b4e59-132">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="b4e59-133">Элементы панели управления</span><span class="sxs-lookup"><span data-stu-id="b4e59-133">Control Panel Items</span></span>](control-panel-applications.md)
</dt> <dt>

[<span data-ttu-id="b4e59-134">Руководство по работе пользователей</span><span class="sxs-lookup"><span data-stu-id="b4e59-134">User Experience Guidelines</span></span>](user-experience-guidelines.md)
</dt> <dt>

[<span data-ttu-id="b4e59-135">Регистрация элементов панели управления</span><span class="sxs-lookup"><span data-stu-id="b4e59-135">Registering Control Panel Items</span></span>](registering-control-panel-items.md)
</dt> <dt>

[<span data-ttu-id="b4e59-136">Использование Кплапплет</span><span class="sxs-lookup"><span data-stu-id="b4e59-136">Using CPLApplet</span></span>](using-cplapplet.md)
</dt> <dt>

[<span data-ttu-id="b4e59-137">Исполнение элементов панели управления</span><span class="sxs-lookup"><span data-stu-id="b4e59-137">Executing Control Panel Items</span></span>](executing-control-panel-items.md)
</dt> <dt>

[<span data-ttu-id="b4e59-138">Расширение элементов панели управления "система"</span><span class="sxs-lookup"><span data-stu-id="b4e59-138">Extending System Control Panel Items</span></span>](extending-system-control-panel-items.md)
</dt> <dt>

[<span data-ttu-id="b4e59-139">Назначение категорий панели управления</span><span class="sxs-lookup"><span data-stu-id="b4e59-139">Assigning Control Panel Categories</span></span>](assigning-control-panel-categories.md)
</dt> <dt>

[<span data-ttu-id="b4e59-140">Создание ссылок на задачи с возможностью поиска для элемента панели управления</span><span class="sxs-lookup"><span data-stu-id="b4e59-140">Creating Searchable Task Links for a Control Panel Item</span></span>](creating-searchable-task-links.md)
</dt> <dt>

[<span data-ttu-id="b4e59-141">Доступ к панели управления в защищенном режиме в Windows Vista</span><span class="sxs-lookup"><span data-stu-id="b4e59-141">Accessing the Control Panel in Safe Mode under Windows Vista</span></span>](accessing-the-cp-in-safe-mode-under-vista.md)
</dt> </dl>

 

 
