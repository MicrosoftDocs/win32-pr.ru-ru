---
title: О модели текстовых объектов
description: В этом разделе представлен общий обзор тома.
ms.assetid: e304ec18-ec2e-4ea7-91c6-6f6ab63b72ae
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b934aab1cbd3dca932b58e4aa99498843cb8cc97
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2020
ms.locfileid: "104070734"
---
# <a name="about-text-object-model"></a>О модели текстовых объектов

Объектная модель текста (TOM) определяет набор интерфейсов обработки текста, которые в различной степени поддерживаются несколькими Microsoft Text Solutions, включая элемент управления Rich Edit. В этом разделе представлен общий обзор тома. В нем рассматриваются следующие темы.

-   [Объекты TOM версии 2](#tom-version-2-objects)
-   [Соглашения об интерфейсах TOM](#tom-interface-conventions)
-   [Тип Томбул](#the-tombool-type)
-   [Математические накрутки и построение](#math-buildup-and-build-down)
-   [TOM RTF](#tom-rtf)
-   [Поиск форматированного текста](#finding-rich-text)
-   [Доступ к тому](#tom-accessibility)
    -   [Интерфейс из таблицы выполняющегося объекта](#interface-from-running-object-table)
    -   [Интерфейс из оконных сообщений](#interface-from-window-messages)
    -   [Ориентированные на специальные методы](#accessibility-oriented-methods)
-   [Наборы совпадений символов](#character-match-sets)

## <a name="tom-version-2-objects"></a>Объекты TOM версии 2

TOM версии 2 (TOM 2) расширяет исходную объектную модель текста. новые интерфейсы являются производными от старых. Обновленный API TOM включает поддержку новых свойств формата символов и абзацев, табличной модели, множественного выбора и встроенного объекта, поддерживающего математические и Ruby.

Объект тома верхнего уровня 2 определяется интерфейсом [**ITextDocument2**](/windows/desktop/api/Tom/nn-tom-itextdocument2) , который имеет методы для создания и извлечения объектов ниже в иерархии объектов. Для простой обработки в обычном тексте можно получить объект [**ITextRange2**](/windows/desktop/api/Tom/nn-tom-itextrange2) из объекта **ITextDocument2** и выполнить все операции с ним. Если необходимо добавить форматирование текста, объекты [**ITextFont2**](/windows/desktop/api/Tom/nn-tom-itextfont2) и [**ITextPara2**](/windows/desktop/api/Tom/nn-tom-itextpara2) можно получить из объекта **ITextRange2** . **ITextFont2** предоставляет программный эквивалент диалогового окна формат Microsoft Word — шрифт, и **ITextPara2** предоставляет эквивалент диалогового окна Формат абзаца Word.

Помимо этих трех объектов более низкого уровня, TOM 2 имеет объект Selection ([**ITextSelection2**](/windows/win32/api/tom/nn-tom-itextselection2)), который является объектом [**ITextRange2**](/windows/desktop/api/Tom/nn-tom-itextrange2) с выделением выделения и некоторыми методами, ориентированными на интерфейс пользователя.

Объекты Range и Selection включают в себя методы, ориентированные на экран, которые позволяют программам проверять текст на экране или текст, который можно прокручивать на экране. Эти возможности помогают сделать текст доступным для людей с непарным зрением, например.

Каждый интерфейс с суффиксом 2 наследует от соответствующего интерфейса без суффикса 2. Например, [**ITextDocument2**](/windows/desktop/api/Tom/nn-tom-itextdocument2) наследует от [**итекстдокумент**](/windows/desktop/api/Tom/nn-tom-itextdocument).

Объекты TOM 2 имеют следующую иерархию.

``` syntax
ITextDocument2         Top-level editing object
    ITextRange2        Primary text interface: a range of text
        ITextFont2     Character-attribute interface
        ITextPara2     Paragraph-attribute interface
        ITextRow       Table interface
    ITextSelection2    Screen highlighted text range
        ITextRange2    Selection inherits all range methods
    ITextDisplays      Displays collection (not yet defined)
    ITextStrings       Rich-text strings collection
    ITextStoryRanges2  Enumerator for stories in document
```

Объект [**ITextDocument2**](/windows/desktop/api/Tom/nn-tom-itextdocument2) описывает один или несколько смежных диапазонов текста, называемых *историями*. Истории представляют различные части документа, такие как основной текст документа, верхние и нижние колонтитулы, сноски, заметки и многофункциональный текстовый пробел. История вспомогательной панели используется при преобразовании между математическими выражениями с линейным форматированием и встроенной формой. История вспомогательной панели также используется при сохранении содержимого диапазона, который является текущим источником копирования, когда содержимое будет изменено.

Объект [**ITextRange2**](/windows/desktop/api/Tom/nn-tom-itextrange2) определяется с помощью смещения начального и конечного символов и объекта истории. Он не существует независимо от родительского объекта истории, хотя его текст может быть скопирован в буфер обмена или в другие целевые объекты. Объект текстового диапазона отличается от электронных таблиц и других объектов Range, которые определяются другими видами смещений. Например, "строка/столбец" или "координата графика" (x, y). Объект текстового диапазона может изменяться различными способами, может возвращать дубликат самого себя, и его можно передать с помощью команды, чтобы скопировать начальные и конечные позиции символов и указатель истории к текущему выделенному фрагменту.

Явный объект истории не требуется, так как объект [**итекстранже**](/windows/desktop/api/Tom/nn-tom-itextrange) всегда может быть создан для представления любой конкретной истории. В частности, объект [**итекстдокумент**](/windows/desktop/api/Tom/nn-tom-itextdocument) может создать объект [**итекстсториранжес**](/windows/desktop/api/Tom/nn-tom-itextstoryranges) для перечисления историй в документе с точки зрения диапазонов с начальными и конечными символами, описывающими полные истории (например, 0 и **томфорвард**).

При использовании объекта [**ITextStoryRanges2**](/windows/desktop/api/Tom/nn-tom-itextstoryranges2) явный объект истории не требуется, так как каждая история описывается объектом [**ITextRange2**](/windows/desktop/api/Tom/nn-tom-itextrange2) . В частности, объект [**ITextDocument2**](/windows/desktop/api/tom/nn-tom-itextdocument2) может создать объект [**ITextStoryRanges2**](/windows/desktop/api/tom/nn-tom-itextstoryranges2) для перечисления историй в документе с точки зрения диапазонов с начальными и конечными символами, описывающими полные истории (например, 0 и **томфорвард**).

Интерфейс [**итекстров**](/windows/desktop/api/Tom/nn-tom-itextrow) вместе с методами [**Итекстранже:: Move**](/windows/desktop/api/Tom/nf-tom-itextrange-move) и [**итекстранже:: Expand**](/windows/desktop/api/Tom/nf-tom-itextrange-expand) предоставляет возможность вставки, запроса и изменения таблиц.

## <a name="tom-interface-conventions"></a>Соглашения об интерфейсах TOM

Все методы TOM возвращают значения **HRESULT** . Как правило, методы TOM возвращают следующие стандартные значения.

-   E \_ OUTOFMEMORY
-   E \_ INVALIDARG
-   E \_ нотимпл
-   E \_ FILENOTFOUND
-   E \_ ACCESSDENIED
-   \_Ошибка E
-   \_ \_ отпущено E
-   Ошибка (то же, что S \_ OK)
-   S \_ false

Имейте в виду, что если экземпляр редактирования, связанный с объектом TOM, например [**итекстранже**](/windows/desktop/api/Tom/nn-tom-itextrange) , удаляется, объект Tom становится бесполезным, а все его методы возвращают CO \_ E \_ .

Помимо возвращаемых значений **HRESULT** , многие методы включают параметры out, которые являются указателями, используемыми для возвращения значений. Для всех интерфейсов следует проверить все параметры указателя, чтобы убедиться, что они не равны нулю, прежде чем использовать их. Если значение null передается в метод, которому требуется допустимый указатель, метод возвращает E \_ INVALIDARG. Необязательные указатели с значениями NULL игнорируются.

Используйте методы с префиксами Get и Set для получения и задания свойств. Логические переменные используют **томфалсе** (0) для **false** и **томтруе** (-1) для **true**.

Константы TOM определяются в типе перечисления [**томконстантс**](/windows/win32/api/tom/ne-tom-tomconstants) и начинаются с префикса *Tom*, например **томворд**.

## <a name="the-tombool-type"></a>Тип Томбул

Многие методы TOM используют специальный тип переменной с именем «Томбул» для атрибутов с расширенным текстом, имеющих двоичные состояния. Тип Томбул отличается от **логического** типа, так как он может принимать четыре значения: **томтруе**, **томфалсе**, **томтоггле** и **tomUndefined**. Значения **томтруе** и **томфалсе** указывают true и false. Значение **томтоггле** используется для переключения свойства. Значение **tomUndefined** , которое обычно называется нинч, — это специальное значение без ввода, которое работает с длинными, плавающими значениями и **COLORREF** s. Для строк **tomUndefined** (или нинч) представляется пустой строкой. Для операций с установкой свойств использование **tomUndefined** не изменяет целевое свойство. Для операций получения свойства **tomUndefined** означает, что символы в диапазоне имеют разные значения (в диалоговых окнах свойств отображается серый флажок).

## <a name="math-buildup-and-build-down"></a>Математические накрутки и построение

Метод [**ITextRange2:: буилдупмас**](/windows/desktop/api/Tom/nf-tom-itextrange2-buildupmath) можно использовать для преобразования математических выражений с линейным форматированием в встроенные версии. Метод [**ITextRange2:: линеаризе**](/windows/desktop/api/Tom/nf-tom-itextrange2-linearize) выполняет обратное преобразование, называемое обрезкой или построение, для преобразования встроенных версий математических выражений обратно в линейный формат. Функция математических построений полезна, если необходимо экспортировать обычный текст или включить определенные типы редактирования.

## <a name="tom-rtf"></a>TOM RTF

В том, для обмена форматированным текстом можно использовать наборы явных вызовов методов или передачи форматированного текста в формате RTF. В этом разделе приводятся таблицы управляющих слов RTF для свойств абзаца и для свойств символов.

**Управляющие слова в абзаце TOM RTF**

| Управляющее слово   | Значение                                                                                                                                                                                                                                                                        |
|----------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| \\ Fi *n*      | Отступ первой строки (по умолчанию равен нулю).                                                                                                                                                                                                                                       |
| \\ отслеживать        | Сохранение абзаца без изменений.                                                                                                                                                                                                                                                         |
| \\ кипн       | Не отключайте следующий абзац.                                                                                                                                                                                                                                                  |
| \\ Li *n*      | Отступ слева (по умолчанию равен нулю).                                                                                                                                                                                                                                             |
| \\ Inline      | Без нумерации строк.                                                                                                                                                                                                                                                             |
| \\ новидктлпар | Отключите элемент управления "висячие" или "висячие".                                                                                                                                                                                                                                                 |
| \\ пажебб      | Прервать страницу перед абзацем.                                                                                                                                                                                                                                                   |
| \\ ценн         | Новый абзац.                                                                                                                                                                                                                                                                 |
| \\ пард        | Сбрасывает свойства абзаца по умолчанию.                                                                                                                                                                                                                                        |
| \\ QL          | По левому краю (по умолчанию).                                                                                                                                                                                                                                                    |
| \\ QR-          | По правому краю.                                                                                                                                                                                                                                                                 |
| \\ QJ          | По ширине.                                                                                                                                                                                                                                                                     |
| \\ очеред          | По центру.                                                                                                                                                                                                                                                                      |
| \\ RI *n*      | Отступ справа (значение по умолчанию — 0).                                                                                                                                                                                                                                            |
| \\ с *n*       | Стиль *n*.                                                                                                                                                                                                                                                                     |
| \\ SA *n*      | Пробел после (значение по умолчанию равно нулю).                                                                                                                                                                                                                                             |
| \\ SB *n*      | Пробел перед (значение по умолчанию равно нулю).                                                                                                                                                                                                                                            |
| \\ SL *n*      | Если отсутствует или *n*= 1000, междустрочный интервал определяется с помощью самого высокого символа в строке (однострочный интервал); Если *n*> нулевое значение, используется по крайней мере такой размер; Если *n* равно < нулю, \|  \| то используется ровно n. Междустрочный зазор состоит из нескольких строк, если \\ слмулт 1. |
| \\ слмулт *м*  | Следует за \\ SL. *m* = ноль: по крайней мере или в точности строкового интервала, как описано в \\ SL *n*. *m* = 1: интервал между строками = *n*/240 раз в один междустрочный интервал.                                                                                                                              |
| \\ ТБ *n*      | Расположение вкладки на панели в твипах от левого поля.                                                                                                                                                                                                                              |
| \\ тлдот       | Точки заполнения табуляции.                                                                                                                                                                                                                                                               |
| \\ тлек        | Знак табуляции со знаком равенства.                                                                                                                                                                                                                                                         |
| \\ тлхиф      | Знаки заполнения табуляции.                                                                                                                                                                                                                                                            |
| \\ тлс        | Толстая линия табулятора.                                                                                                                                                                                                                                                         |
| \\ тлул        | Подчеркнутый символ табуляции.                                                                                                                                                                                                                                                          |
| \\ ткк         | Вкладка по центру.                                                                                                                                                                                                                                                                  |
| \\ ткдек       | Десятичная вкладка.                                                                                                                                                                                                                                                                   |
| \\ ткр         | Вкладка "Сброс" — справа.                                                                                                                                                                                                                                                               |
| \\ TX *n*      | Позицию табуляции в твипах от левого поля.                                                                                                                                                                                                                                  |



 

**Управляющие слова в символьном формате тома RTF**

| Управляющее слово     | Значение                                                                                                                                                                                                                                  |
|------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| \\ анимация *n* | Задает тип анимации *n*.                                                                                                                                                                                                              |
| \\ &             | Делять.                                                                                                                                                                                                                                    |
| \\ Lock          | Все прописные.                                                                                                                                                                                                                            |
| \\ CF *n*        | Цвет переднего плана (значение по умолчанию — **томаутоколор**).                                                                                                                                                                                      |
| \\ CS *n*        | Стиль символа *n*.                                                                                                                                                                                                                     |
| \\ DN *n*        | Позиция индекса в половинных точках (значение по умолчанию — 6).                                                                                                                                                                                    |
| \\ ембо          | Приподнятый.                                                                                                                                                                                                                                |
| \\ f *n*         | Номер шрифта, *n* означает запись в таблице Font.                                                                                                                                                                                   |
| \\ FS *n*        | Размер шрифта в половинных точках (значение по умолчанию — 24).                                                                                                                                                                                            |
| \\ выделить *n* | Цвет фона (значение по умолчанию — **томаутоколор**).                                                                                                                                                                                      |
| \\ сохранении             | Деле.                                                                                                                                                                                                                                  |
| \\ импр          | Отпечатке.                                                                                                                                                                                                                                 |
| \\ lang *n*      | Применяет язык к символу. *n* — это число, соответствующее языку. \\Текстовое поле обычного элемента управления сбрасывает свойство Language на язык, определенный \\ дефланг *n* в свойствах документа.                             |
| \\ носуперсуб    | Отключает верхний или нижний индексы.                                                                                                                                                                                                      |
| \\ аутл          | Обзор.                                                                                                                                                                                                                                 |
| \\ Plain         | Сбрасывает свойства форматирования символов в значение по умолчанию, определенное приложением. Также сбрасываются связанные свойства форматирования символов (описанные в разделе связанные свойства символов в спецификации RTF). |
| \\ скапс         | Малые прописные.                                                                                                                                                                                                                          |
| \\ оттенк          | Скрыть.                                                                                                                                                                                                                                  |
| \\ зачеркнутый        | Черкивания.                                                                                                                                                                                                                           |
| \\ Директор           | Применяет нижний индекс к тексту и сокращает размер кегля в соответствии со сведениями о шрифтах.                                                                                                                                                          |
| \\ является         | Применяет надстрочные знаки к тексту и сокращает размер кегля в соответствии со сведениями о шрифтах.                                                                                                                                                        |
| \\ признан            | Непрерывное подчеркивание. \\ ul0 выключает все подчеркивания.                                                                                                                                                                                  |
| \\ улд           | Пунктирное подчеркивание.                                                                                                                                                                                                                        |
| \\ улдб          | Двойное подчеркивание.                                                                                                                                                                                                                        |
| \\ улноне        | Остановка всех подчеркивания.                                                                                                                                                                                                                   |
| \\ улв           | Подчеркивание слов.                                                                                                                                                                                                                          |
| \\ Up *n*        | Позиция надстрочного знака в половинных точках (значение по умолчанию — 6).                                                                                                                                                                                  |
| \\ 3,3             | Скрытый текст.                                                                                                                                                                                                                             |



 

## <a name="finding-rich-text"></a>Поиск форматированного текста

Для поиска форматированного текста, определенного диапазоном текста, можно использовать методы TOM. Найти такой форматированный текст очень часто требуется при обработке текста, хотя он никогда не был выполнен в «том, что вы видите, это то, что вы получаете с помощью текстового редактора (WYSIWYG). Очевидно, что существует более крупный домен с расширенным текстом, позволяющий игнорировать некоторые свойства форматирования символов (или включить форматирование абзаца и/или содержимое объекта), но такие обобщения выходят за рамки этого раздела.

Одной из целей этой функции является использование диалогового окна **поиска** с расширенным текстом для определения форматированного текста, который нужно найти в документе. Диалоговое окно будет реализовано с помощью элемента управления Rich Edit, а для выполнения поиска в документе будет использоваться TOM-методы. Можно либо скопировать нужный форматированный текст из документа в диалоговое окно **найти** , либо ввести и отформатировать его непосредственно в диалоговом окне **найти** .

В следующем примере показано, как использовать методы TOM для поиска текста, содержащего сочетания точного форматирования символов. Алгоритм ищет обычный текст в диапазоне совпадений, который называется `pr1` . Если обнаружен обычный текст, на него указывает пробный диапазон, который называется `pr2` . Затем используются два диапазона точек вставки ( `prip1` и `prip2` ) для пошагового анализа диапазона пробных версий, сравнивающих форматирование символов с `pr1` . Если они точно совпадают, входной диапазон (заданный параметром `ppr` ) обновляется, чтобы указывать на текст пробного диапазона, а функция возвращает количество символов в сопоставленном диапазоне. Два объекта [**итекстфонт**](/windows/desktop/api/Tom/nn-tom-itextfont) ( `pf1` и `pf2` ) используются в сравнении форматирования символов. Они присоединяются к диапазонам точек вставки `prip1` и `prip2` .


```
LONG FindRichText (
    ITextRange **ppr,             // Ptr to range to search
    ITextRange *pr1)              // Range with rich text to find
{
    BSTR        bstr;             // pr1 plain-text to search for
    LONG        cch;              // Text string count
    LONG        cch1, cch2;       // tomCharFormat run char counts
    LONG        cchMatch = 0;     // Nothing matched yet
    LONG        cp;               // Handy char position
    LONG        cpFirst1;         // pr1 cpFirst
    LONG        cpFirst2;         // pr2 cpFirst
    ITextFont  *    pf1, *pf      // Fonts corresponding to IPs prip1 and prip2
    ITextRange *pr2;              // Range duplicate to search with
    ITextRange *prip1, *prip      // Insertion points to walk pr1, pr2

    if (!ppr || !*ppr || !pr1)
        return E_INVALIDARG;

    // Initialize range and font objects used in search
    if ((*ppr)->GetDuplicate(&pr2)    != NOERROR ||
        pr1->GetDuplicate(&prip1)     != NOERROR ||
        pr2->GetDuplicate(&prip2)     != NOERROR ||
        prip1->GetFont(&pf1)          != NOERROR ||
        prip2->GetFont(&pf2)          != NOERROR ||
        pr1->GetText(&bstr)           != NOERROR )
    {
        return E_OUTOFMEMORY;
    }

    pr1->GetStart(&cpFirst1);

    // Keep searching till rich text is matched or no more plain-text hits
    while(!cchMatch && pr2->FindText(bstr, tomForward, 0, &cch) == NOERROR)
    {
        pr2->GetStart(&cpFirst2);                 // pr2 is a new trial range
        prip1->SetRange(cpFirst1, cpFirst1);      // Set up IPs to scan match
        prip2->SetRange(cpFirst2, cpFirst2);      //  and trial ranges

        while(cch > 0 &&
            pf1->IsEqual(pf2, NULL) == NOERROR)   // Walk match & trial ranges
        {                                         //  together comparing font
            prip1->GetStart(&cch1);               //  properties
            prip1->Move(tomCharFormat, 1, NULL);
            prip1->GetStart(&cp);
            cch1 = cp - cch1;                     // cch of next match font run

            prip2->GetStart(&cch2);
            prip2->Move(tomCharFormat, 1, NULL);
            prip2->GetStart(&cp);
            cch2 = cp - cch2;                      // cch of next trial font run

            if(cch1 < cch)                         // There is more to compare
            {
                if(cch1 != cch2)                   // Different run lengths:
                    break;                         //  no formatting match
                cch = cch - cch1;                  // Matched format run
            }
            else if(cch2 < cch)                    // Trial range format run too
                break;                             //  short

            else                                   // Both match and trial runs
            {                                      //  reach at least to match
                pr2->GetEnd(&cp);                  //  text end: rich-text match
                (*ppr)->SetRange(cpFirst2, cp)     // Set input range to hit
                cchMatch = cp - cpFirst2;          //  coordinates and return
                break;                             //  length of matched string
            }
        }
    }
    pr2->Release();
    prip1->Release();
    prip2->Release();
    pf1->Release();
    pf2->Release();
    SysFreeString(bstr);

    return cchMatch;
}
```



## <a name="tom-accessibility"></a>Доступ к тому

TOM предоставляет поддержку специальных возможностей через интерфейсы [**итекстселектион**](/windows/desktop/api/Tom/nn-tom-itextselection) и [**итекстранже**](/windows/desktop/api/Tom/nn-tom-itextrange) . В этом разделе описываются методы, которые удобно использовать для специальных возможностей, а также сведения о том, как программа может определить координату экрана *x*, *y* объекта.

Так как программы специальных возможностей на основе пользовательского интерфейса обычно работают с экраном и мышью, распространенной проблемой является поиск соответствующего интерфейса [**итекстдокумент**](/windows/desktop/api/Tom/nn-tom-itextdocument) для текущего положения мыши (в координатах экрана). В следующих разделах представлены два способа определения правильного интерфейса:

-   [Через таблицу с выполняющимся объектом](#interface-from-running-object-table)
-   С помощью сообщения [**EM \_ жетолеинтерфаце**](em-getoleinterface.md) , которое работает для экземпляров окон с богатыми возможностями редактирования, если клиент находится в одном и том же пространстве процесса ( *Упаковка* не требуется).

Дополнительные сведения см. в спецификации Microsoft Active Accessibility. После получения объекта из позиции экрана можно использовать для интерфейса [**итекстдокумент**](/windows/desktop/api/Tom/nn-tom-itextdocument) и вызвать метод [**ранжефромпоинт**](/windows/desktop/api/Tom/nf-tom-itextdocument-rangefrompoint) для получения пустого объекта Range в CP, соответствующем положению экрана.

### <a name="interface-from-running-object-table"></a>Интерфейс из таблицы выполняющегося объекта

Выполняемая таблица объектов (ROT) сообщает, какие экземпляры объектов являются активными. Запрашивая эту таблицу, можно ускорить процесс подключения клиента к объекту, если объект уже выполняется. Чтобы программы могли получить доступ к томам TOM через таблицу запущенных объектов, экземпляру TOM с окном необходимо зарегистрировать в таблице ROT с помощью моникера. Моникер создается из строки, содержащей шестнадцатеричное значение его [**HWND**](/windows/desktop/WinProg/windows-data-types). В следующем образце кода показано, как это сделать.


```
// This TOM implementation code is executed when a new windowed 
// instance starts up. 
// Variables with leading underscores are members of this class.

HRESULT hr;
OLECHAR szBuf[10];            // Place to put moniker
MONIKER *pmk;

hr = StringCchPrintf(szBuff, 10, "%x", _hwnd);
if (FAILED(hr))
{
    //
    // TODO: write error handler
    //
}
CreateFileMoniker(szBuf, &pmk);
OleStdRegisterAsRunning(this, pmk, &_dwROTcookie);
....................
 
// Accessibility Client: 
//    Find hwnd for window pointed to by mouse cursor.

GetCursorPos(&pt);
hwnd = WindowFromPoint(pt);

// Look in ROT (running object table) for an object attached to hwnd

hr = StringCchPrintf(szBuff, 10, "%x", hwnd);
if (FAILED(hr))
{
    //
    // TODO: write error handler
    //
}
CreateFileMoniker(szBuf, &pmk);
CreateBindContext(0, &pbc);
pmk->BindToObject(pbc, NULL, IID_ITextDocument, &pDoc);
pbc->Release();

if( pDoc )
{
    pDoc->RangeFromPoint(pt.x, pt.y, &pRange);
    // ...now do whatever with the range pRange
}
```



### <a name="interface-from-window-messages"></a>Интерфейс из оконных сообщений

Сообщение [**EM \_ жетолеинтерфаце**](em-getoleinterface.md) предоставляет другой способ получения интерфейса [**IUnknown**](/windows/desktop/api/unknwn/nn-unknwn-iunknown) для объекта в заданной позиции экрана. Как описано в разделе [интерфейс из выполняемой таблицы объектов](#interface-from-running-object-table), вы получаете [**HWND**](/windows/desktop/WinProg/windows-data-types) для расположения экрана, а затем отправляете это сообщение в этот **HWND**. Сообщение **EM \_ жетолеинтерфаце** имеет богатый характер для редактирования и возвращает указатель на интерфейс [**иричедитоле**](/windows/desktop/api/Richole/nn-richole-iricheditole) в переменной, адресованной параметром *lParam*.

**Совет** Если возвращается указатель (обязательно установите объект, для которого параметр *lParam* указывает на значение null перед отправкой сообщения), можно вызвать его метод [**IUnknown:: QueryInterface**](/windows/desktop/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) , чтобы получить интерфейс [**итекстдокумент**](/windows/desktop/api/Tom/nn-tom-itextdocument) . Этот подход показан в следующем примере кода.


```
    HWND    hwnd;
    ITextDocument *pDoc;
    ITextRange *pRange;
    POINT    pt;
    IUnknown *pUnk = NULL;
    
    GetCursorPos(&pt);
    hwnd = WindowFromPoint(pt);
    SendMessage(hwnd, EM_GETOLEINTERFACE, 0, (LPARAM)&pUnk);
    if(pUnk && 
        pUnk->QueryInterface(IID_ITextDocument, &pDoc) == NOERROR)
    {
        pDoc->RangeFromPoint(pt.x, pt.y, &pRange);
        //  ... continue with rest of program
    }
```



### <a name="accessibility-oriented-methods"></a>Ориентированные на специальные методы

Некоторые из них особенно полезны для навигации по экрану, а другие — к тому, что можно делать при прибытии в интересующие места. В следующей таблице описаны наиболее полезные методы.



| Метод                                                 | Как он способствует специальным возможностям                                                                                                                                                                 |
|--------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**Выборка**](/windows/desktop/api/Tom/nf-tom-itextdocument-getselection)     | Этот метод получает активный выбор, который можно использовать для различных целей, ориентированных на представление, таких как выделение текста и прокрутка.                                                      |
| [**ранжефромпоинт**](/windows/desktop/api/Tom/nf-tom-itextdocument-rangefrompoint) | При использовании в активном выделении этот метод гарантированно получает диапазон, связанный с определенным представлением.                                                                                 |
| [**Разверните**](/windows/desktop/api/Tom/nf-tom-itextrange-expand)                    | Увеличивает диапазон текста, чтобы все содержащиеся в нем части полностью содержались. Например, `Expand(tomWindow)` расширяет диапазон, чтобы включить видимую часть истории диапазона. |
| [**Повторяющаяся копия**](/windows/desktop/api/Tom/nf-tom-itextrange-getduplicate)        | При использовании в активном выделении этот метод гарантированно получает диапазон, связанный с определенным представлением. См. Описание [**ранжефромпоинт**](/windows/desktop/api/Tom/nf-tom-itextdocument-rangefrompoint).  |
| [**Наpoint**](/windows/desktop/api/Tom/nf-tom-itextrange-getpoint)                | Возвращает экранные координаты для позиции начального или конечного символа в диапазоне текста.                                                                                                        |
| [**скроллинтовиев**](/windows/desktop/api/Tom/nf-tom-itextrange-scrollintoview)    | Прокручивает текстовый диапазон в представлении.                                                                                                                                                               |
| [**сетпоинт**](/windows/desktop/api/Tom/nf-tom-itextrange-setpoint)                | Выделяет текст в указанной точке или вверх.                                                                                                                                              |



 

## <a name="character-match-sets"></a>Наборы совпадений символов

Параметр *Variant* различных методов **Move** \* в [**Итекстранже**](/windows/desktop/api/Tom/nn-tom-itextrange), таких как [**мовевхиле**](/windows/desktop/api/Tom/nf-tom-itextrange-movewhile) и [**мовеунтил**](/windows/desktop/api/Tom/nf-tom-itextrange-moveuntil), может принимать явную строку или 32-разрядный индекс в кодировке. Индексы определяются либо диапазонами Юникода, либо [**жетстрингтипикс**](/windows/win32/api/stringapiset/nf-stringapiset-getstringtypeexw) наборами символов. Диапазон Юникода, начинающийся с *n* и длиной *l* (< 32768), задается индексом *n* + (*l <*< 16) + 0x80000000. Например, прописные буквы в греческом языке определяются символом CR \_ греческого языка = 0x805f0370, а печатаемые символы ASCII определяются CR \_ асЦиипринт = 0x805e0020. Кроме того, методы **мовевхиле** и **мовеунтил** позволяют быстро обходить диапазон символов в любой кодировке **жетстрингтипикс** или в диапазоне символов, не находящиеся ни в одном из этих наборов символов.

Наборы [**жетстрингтипикс**](/windows/win32/api/stringapiset/nf-stringapiset-getstringtypeexw) задаются значениями для *Ctype1*, *Ctype2* и *Ctype3* и определяются следующим образом.



| ксет                 | Значение                          |
|----------------------|----------------------------------|
| *Ctype1*             | Сочетание \_ типов CTYPE1 CT. |
| *Ctype2* + tomCType2 | Любой \_ тип CTYPE2 CT.             |
| *Ctype3* + tomCType3 | Сочетание \_ типов CTYPE3 CT. |



 

В частности, *Ctype1* может быть любым сочетанием следующих параметров.



| Имя Ctype1 | Значение  | Значение                                                           |
|-------------|--------|-------------------------------------------------------------------|
| C1, \_ верхняя   | 0x0001 | Верхний регистр.                                                        |
| \_Вниз C1   | 0x0002 | Пишут.                                                        |
| \_Цифра C1   | 0x0004 | Десятичные цифры.                                                   |
| \_Пространство C1   | 0x0008 | Пробельные символы.                                                 |
| C1 \_ PUNCT   | 0x0010 | Знаки препинания.                                                      |
| C1 \_ вкладка   | 0x0020 | Управляющие символы.                                               |
| \_Пустой C1   | 0x0040 | Пустые символы.                                                 |
| C1 \_ ксдигит  | 0x0080 | Шестнадцатеричные цифры.                                               |
| \_Альфа-канал C1   | 0x0100 | Любой лингвистический символ (алфавитный, слоговый или Идеографическая). |
| \_Определено C1 | 0x0200 | Определенный символ, но не один из других \_ \* типов C1.       |



 

Типы *Ctype2* поддерживают правильный макет текста в Юникоде. Атрибуты направления присваиваются таким образом, чтобы алгоритм двунаправленного макета, стандартизированный в Юникоде, получал точные результаты. Эти типы являются взаимоисключающими. Дополнительные сведения об использовании этих атрибутов см *. в статье Стандарт Юникода: Кодировка международных символов, тома 1 и 2*, Addison-Wesley публикация компании: 1991, 1992.



| Имя CType2          | Значение | Значение                          |
|----------------------|-------|----------------------------------|
| Надежный              |       |                                  |
| C2 \_ LEFTTORIGHT      | 0x1   | Слева направо.                   |
| C2 \_ RIGHTTOLEFT      | 0x2   | Справа налево.                   |
| Безопасные                |       |                                  |
| C2 \_ еуропенумбер     | 0x3   | Европейский номер, Европейский знак. |
| C2 \_ еуропесепаратор  | 0x4   | Европейский числовой разделитель.      |
| C2 \_ еуропетерминатор | 0x5   | Европейский числовой признак конца.     |
| C2 \_ арабикнумбер     | 0x6   | Номер для арабского языка.                   |
| C2 \_ коммонсепаратор  | 0x7   | Общий числовой разделитель.        |
| Нейтральные             |       |                                  |
| C2 \_ блокксепаратор   | 0x8   | Разделитель блоков.                 |
| C2 \_ сегментсепаратор | 0x9   | Разделитель сегментов.               |
| Пробел в C2 \_       | 0xA   | Пробел.                     |
| C2 \_ осернеутрал     | 0xB   | Другие нейтральные.                  |
| Неприменимо:      |       |                                  |
| C2 \_ применимо    | 0x0   | Неявное направление.           |



 

Типы *Ctype3* должны быть заполнителями для РАСШИРЕНИЙ типов POSIX, необходимых для общей обработки текста или для стандартных функций библиотеки C.



| Имя CType3       | Значение  | Значение                                                             |
|-------------------|--------|---------------------------------------------------------------------|
| \_НЕразрывный C3    | 0x1    | Несамостоятельный знак.                                                    |
| \_Диакритический знак C3     | 0x2    | Диакритический знак неразрыва.                                          |
| C3 \_ вовелмарк     | 0x4    | Гласная Несамостоятельная метка.                                              |
| \_Символ C3        | 0x8    | Знак.                                                             |
| C3 \_ катакана      | 0x10   | Символ катакана.                                                 |
| C3 ( \_ хирагана)      | 0x20   | Символ хирагана.                                                 |
| По заданному \_ C3     | 0x40   | Символ половинной ширины.                                               |
| По \_ ширине C3     | 0x80   | Символ полной ширины.                                               |
| C3 \_ иероглифы     | 0x100  | Идеографическая символ.                                              |
| C3 \_ кашиды       | 0x200  | Арабская буква кашиды.                                           |
| \_Альфа-канал C3         | 0x8000 | Все лингвистические символы (алфавитные, слоговые и идеографические). |
| C3 \_ применимо | 0x0    | Не применяется                                                     |



 

Пакет SDK для редактирования (ЕДК) может включать определения индексов *ПВАР* для следующих диапазонов, описанных в стандарте Юникода.



| Набор знаков         | Диапазон Юникода | Набор знаков             | Диапазон Юникода |
|-----------------------|---------------|---------------------------|---------------|
| ASCII                 | 0x0 — 0x7F      | ANSI                      | 0x0 — 0xFF      |
| асЦиипринт            | 0x20 — 0x7E     | Latin1                    | 0x20 — 0xFF     |
| Latin1Supp            | 0x82 — 0xFF     | латинкса                   | 0x100 — 0x17f   |
| латинксб               | 0x180—0x24f   | ипакс                      | 0x250—0x2af   |
| спацемод              | 0x2b0—0x2ff   | Объединение                 | 0x300—0x36f   |
| Греческий                 | 0x370—0x3ff   | басикгрик                | 0x370—0x3cf   |
| гриксимболс          | 0x3d0—0x3ff   | Кириллица                  | 0x400 — 0x4ff   |
| Армянский              | 0x530—0x58f   | Иврит                    | 0x590—0x5ff   |
| басичебрев           | 0x5d0—0x5ea   | хебревкса                  | 0x590—0x5cf   |
| хебревксб              | 0x5eb—0x5ff   | Арабский                    | 0x600—0x6ff   |
| басикарабик           | 0x600—0x652   | арабиккс                   | 0x653—0x6ff   |
| Блок             | 0x900—0x97f   | Бенгальский (ранее Бенгальская) | 0x980—0x9ff   |
| Гурмукхи              | 0xa00—0xa7f   | Гуджарати                  | 0xa80—0xaff   |
| Ория (прежнее название — Ория) | 0xb00—0xb7f   | Тамильский                     | 0xb80—0xbff   |
| телуга                | 0xc00—0xc7f   | Каннада                   | 0xc80—0xcff   |
| Малаялам             | 0xd00—0xd7f   | Тайский                      | 0xe00—0xe7f   |
| Лаосский                   | 0xe80—0xeff   | жеоргианкс                 | 0x10a0—0xa0cf |
| баскжеоргиан          | 0x10d0—0x10ff | Джамо                      | 0x1100—0x11ff |
| латинксадд             | 0x1e00—0x1eff | гриккс                    | 0x1f00—0x1fff |
| женпункт              | 0x2000 — 0x206f | Надстрочный               | 0x2070—0x207f |
| Подстрочный             | 0x2080—0x208f | суперсубскрипт            | 0x2070—0x209f |
| Валюта              | 0x20a0—0x20cf | комбмарксим               | 0x20d0—0x20ff |
| Буквоподобных            | 0x2100—0x214f | нумберформс               | 0x2150—0x218f |
| Стрелки                | 0x2190—0x21ff | масопс                   | 0x2200—0x22ff |
| мисктеч              | 0x2300—0x23ff | ктрлпиктурес              | 0x2400—0x243f |
| оптчарреког          | 0x2440—0x245f | енклалфанум              | 0x2460—x24ff  |
| боксдравинг            | 0x2500—0x257f | блоккелемент              | 0x2580—0x259f |
| жеометшапес          | 0x25a0—0x25ff | мисксимболс               | 0x2600—0x26ff |
| Dingbats              | 0x2700—0x27bf | кжксимпункт               | 0x3000—0x303f |
| Хирагана              | 0x3040—0x309f | Катакана                  | 0x30a0—0x30ff |
| Бопомофо              | 0x3100—0x312f | хангулжамо                | 0x3130—0x318f |
| кжлмиск               | 0x3190—0x319f | енклкжк                   | 0x3200—0x32ff |
| кжккомпатибл          | 0x3300—0x33ff | Хан                       | 0x3400—0xabff |
| Символы Хангула (Hangul)                | 0xac00—0xd7ff | UTF16Lead                 | 0xD800 — 0xDBFF |
| UTF16Trail            | 0xDC00 — 0xDFFF | приватеусе                | 0xe000—0xf800 |
| кжккомпидеог          | 0xf900—0xfaff | алфапрес                 | 0xfb00—0xfb4f |
| арабикпреса           | 0xfb50—0xfdff | комбхалфмарк              | 0xfe20—0xfe2f |
| кжккомпформ           | 0xfe30—0xfe4f | смаллформвар              | 0xfe50—0xfe6f |
| арабикпресб           | 0xfe70—0xfefe | халффуллформ              | 0xff00—0xffef |
| Блок              | 0xfff0—0xfffd |                           |               |



 

 

 