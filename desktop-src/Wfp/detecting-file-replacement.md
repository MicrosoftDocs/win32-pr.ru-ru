---
description: Защита ресурсов Windows (WRP) предотвращает замену необходимых системных файлов, папок и разделов реестра, установленных в составе Windows Vista или Windows Server 2008.
ms.assetid: 1cb67b4a-dc75-4bd7-b314-d695c10d5558
title: Обнаружение замены ресурсов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 62dc1855b98ca5834ef9e13e2f48bf7cca492e94
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103817040"
---
# <a name="detecting-resource-replacement"></a>Обнаружение замены ресурсов

Защита ресурсов Windows (WRP) предотвращает замену необходимых системных файлов, папок и разделов реестра, установленных в составе Windows Vista или Windows Server 2008.

WRP защищает файлы, папки и разделы реестра в Windows Vista или Windows Server 2008, выявляя и предотвращая попытки замены защищенных ресурсов. Эта защита основана на списке управления доступом на уровне пользователей Windows (DACL) и списках управления доступом (ACL), определенных для защищенных ресурсов. Разрешение на полный доступ для изменения ресурсов, защищенных WRP, ограничено TrustedInstaller. Ресурсы, защищенные WRP, можно изменять только с помощью [поддерживаемых механизмов замены ресурсов](supported-file-replacement-mechanisms.md) в службе установщика модулей Windows. Приложения, пытающиеся изменить ресурс, защищенный WRP, никогда не изменяют ресурс и могут получить сообщение об ошибке, сообщающее, что доступ к ресурсу запрещен.

Приложения и установщики могут использовать функции [**сфЦисфилепротектед**](/windows/desktop/api/Sfc/nf-sfc-sfcisfileprotected) и [**сфЦискэйпротектед**](/windows/desktop/api/Sfc/nf-sfc-sfciskeyprotected) , чтобы определить, защищен ли файл или раздел реестра.

* * Windows Server 2003 и Windows XP: * *

Защита файлов Windows (WFP) защищает системные файлы путем обнаружения попыток замены защищенных системных файлов. Эта защита активируется после того, как WFP получает уведомление об изменении каталога для файла в защищенном каталоге. Когда WFP получает это уведомление, он определяет, какой файл был изменен. Если файл защищен, WFP ищет подпись файла в файле каталога, чтобы определить, является ли новый файл правильной версией. Если версия файла неверна, система заменяет файл правильной версией из кэша или с носителя распространения в зависимости от того, находится ли файл в кэше. WFP ищет правильный файл в следующем порядке:

1.  Поиск в каталоге кэша.
2.  Поиск пути сетевой установки, если система была установлена с помощью сетевой установки.
3.  Поиск на компакт-диске Windows, если система была установлена с компакт-диска.

Если WFP не может автоматически найти файл в первых двух местах, отображается следующее сообщение:

![сообщение WFP, отображаемое, если файл не найден в каталоге кэша или пути сетевой установки](images/wfp-1.png)

Если система была установлена с помощью компакт-диска, WFP отображает следующее сообщение:

![отображается сообщение WFP, предлагающее пользователю вставить компакт-диск Windows](images/wfp-2.png)

Если администратор не вошел в систему, WFP не сможет отобразить какое-либо из этих диалоговых окон. WFP отобразит диалоговое окно после входа администратора в систему.

WFP также регистрирует попытки замены файлов в журнале системных событий. Если администратор отменил восстановление правильного файла, WFP регистрирует отмену.

## <a name="retrieving-the-list-of-protected-files"></a>Получение списка защищенных файлов

В следующем примере показано, как приложения и установщики могут использовать функцию [**сфкжетнекстпротектедфиле**](/windows/desktop/api/Sfc/nf-sfc-sfcgetnextprotectedfile) для получения полного списка защищенных файлов.


```C++
#include <windows.h>
#include <sfc.h>
#include <stdio.h>

#pragma comment(lib, "sfc")

void wmain (int argc, WCHAR ** argv)
{  UNREFERENCED_PARAMETER(argc);    
   PROTECTED_FILE_DATA pfd = {0};
   BOOL fResult;

   wprintf (L"List of protected files:\n\n", argv[1]);

   while (FALSE != (fResult = SfcGetNextProtectedFile (NULL, &pfd)))
   {
      wprintf (L"   %lu   %s\n", pfd.FileNumber, pfd.FileName);
   }

   if (GetLastError() == ERROR_NO_MORE_FILES)
   {
      wprintf (L"\nAll %lu protected files listed\n", pfd.FileNumber);
   }
   else
   {
      wprintf (L"\nerror %lu: SfcGetNextProtectedFile() failed unexpectedly\n", GetLastError());
   }

}
```



 

 



