---
description: Когда установщик обрабатывает скрипт установки, он одновременно создает скрипт отката.
ms.assetid: 5b9bfc5a-6a78-4b0e-aed8-f25aba089af1
title: Откат настраиваемых действий
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1c4ad91f8f94145399d51ed2ef53999ab0a91d65
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103898309"
---
# <a name="rollback-custom-actions"></a><span data-ttu-id="0eff6-103">Откат настраиваемых действий</span><span class="sxs-lookup"><span data-stu-id="0eff6-103">Rollback Custom Actions</span></span>

<span data-ttu-id="0eff6-104">Когда установщик обрабатывает скрипт установки, он одновременно создает скрипт отката.</span><span class="sxs-lookup"><span data-stu-id="0eff6-104">When the installer processes the installation script, it simultaneously generates a rollback script.</span></span> <span data-ttu-id="0eff6-105">Помимо скрипта отката, установщик сохраняет копию каждого файла, который он удаляет, во время установки.</span><span class="sxs-lookup"><span data-stu-id="0eff6-105">In addition to the rollback script, the installer saves a copy of every file it deletes during the installation.</span></span> <span data-ttu-id="0eff6-106">Эти файлы хранятся в скрытом системном каталоге.</span><span class="sxs-lookup"><span data-stu-id="0eff6-106">These files are kept in a hidden system directory.</span></span> <span data-ttu-id="0eff6-107">После завершения установки сценарий отката и сохраненные файлы удаляются.</span><span class="sxs-lookup"><span data-stu-id="0eff6-107">Once the installation is complete, the rollback script and the saved files are deleted.</span></span> <span data-ttu-id="0eff6-108">Если установка завершается неудачно, установщик пытается выполнить откат изменений, сделанных во время установки, и восстановить исходное состояние компьютера.</span><span class="sxs-lookup"><span data-stu-id="0eff6-108">If an installation is unsuccessful, the installer attempts to rollback the changes made during the installation and restore the original state of the computer.</span></span>

<span data-ttu-id="0eff6-109">Несмотря на то, что пользовательские действия, запланирующие системные операции путем вставки строк в таблицу базы данных, обращены к откату установки, настраиваемым действиям, которые изменяют систему напрямую или выдают команды другим системным службам, не всегда могут быть отменены в результате отката.</span><span class="sxs-lookup"><span data-stu-id="0eff6-109">Although custom actions that schedule system operations by inserting rows into database table are reversed by a rollback of the installation, custom actions that change the system directly, or that issue commands to other system services, cannot always be reversed by a rollback.</span></span> <span data-ttu-id="0eff6-110">Настраиваемое действие отката — это действие, выполняемое установщиком только во время отката установки, и его целью является отмена настраиваемого действия, которое внес изменения в систему.</span><span class="sxs-lookup"><span data-stu-id="0eff6-110">A rollback custom action is an action that the installer executes only during an installation rollback, and its purpose is to reverse a custom action that has made changes to the system.</span></span>

<span data-ttu-id="0eff6-111">Настраиваемое действие отката — это тип [отложенного выполнения настраиваемого действия](deferred-execution-custom-actions.md), поскольку его выполнение откладывается при вызове во время последовательности установки.</span><span class="sxs-lookup"><span data-stu-id="0eff6-111">A rollback custom action is a type of [deferred execution custom action](deferred-execution-custom-actions.md), because its execution is deferred when it is invoked during the installation sequence.</span></span> <span data-ttu-id="0eff6-112">Он отличается от обычного отложенного настраиваемого действия в том, что оно выполняется только во время отката.</span><span class="sxs-lookup"><span data-stu-id="0eff6-112">It differs from a regular deferred custom action in that it is only executed during a rollback.</span></span> <span data-ttu-id="0eff6-113">Настраиваемое действие отката всегда должно предшествовать отложенному пользовательскому действию, которое возвращается в последовательности действий.</span><span class="sxs-lookup"><span data-stu-id="0eff6-113">A rollback custom action must always precede the deferred custom action it rolls back in the action sequence.</span></span> <span data-ttu-id="0eff6-114">Настраиваемое действие отката также должно работать в случае, когда отложенное пользовательское действие прерывается в процессе выполнения.</span><span class="sxs-lookup"><span data-stu-id="0eff6-114">A rollback custom action should also handle the case where the deferred custom action is interrupted in the middle of execution.</span></span> <span data-ttu-id="0eff6-115">Например, если пользователь нажмет кнопку «Отмена» во время выполнения настраиваемого действия.</span><span class="sxs-lookup"><span data-stu-id="0eff6-115">For example, if the user were to press the Cancel button while the custom action was executing.</span></span>

<span data-ttu-id="0eff6-116">Обратите внимание, что настраиваемые действия отката не могут выполняться асинхронно.</span><span class="sxs-lookup"><span data-stu-id="0eff6-116">Note that Rollback Custom Actions cannot run asynchronously.</span></span> <span data-ttu-id="0eff6-117">См. раздел [синхронные и асинхронные настраиваемые действия](synchronous-and-asynchronous-custom-actions.md).</span><span class="sxs-lookup"><span data-stu-id="0eff6-117">See [Synchronous and Asynchronous Custom Actions](synchronous-and-asynchronous-custom-actions.md).</span></span>

<span data-ttu-id="0eff6-118">Дополнение к настраиваемому действию отката — это [настраиваемое действие фиксации](commit-custom-actions.md).</span><span class="sxs-lookup"><span data-stu-id="0eff6-118">The complement to a rollback custom action is a [commit custom action](commit-custom-actions.md).</span></span> <span data-ttu-id="0eff6-119">Установщик выполняет пользовательское действие фиксации во время последовательности установки, копирует пользовательское действие в скрипт отката, но не выполняет это действие во время отката.</span><span class="sxs-lookup"><span data-stu-id="0eff6-119">The installer executes a commit custom action during the installation sequence, copies the custom action into the rollback script, but does not execute the action during rollback.</span></span>

<span data-ttu-id="0eff6-120">Обратите внимание, что пользовательское действие отката может не иметь возможности удалить все изменения, сделанные настраиваемыми действиями фиксации.</span><span class="sxs-lookup"><span data-stu-id="0eff6-120">Note that a rollback custom action may not be able to remove all of the changes made by commit custom actions.</span></span> <span data-ttu-id="0eff6-121">Несмотря на то, что установщик записывает как откат, так и фиксацию пользовательских действий в скрипте отката, пользовательские действия записываются только после того, как установщик успешно обработал сценарий установки.</span><span class="sxs-lookup"><span data-stu-id="0eff6-121">Although the installer writes both rollback and commit custom actions into the rollback script, commit custom actions only run after the installer has successfully processed the installation script.</span></span> <span data-ttu-id="0eff6-122">Фиксация настраиваемых действий — это первые действия, выполняемые в скрипте отката.</span><span class="sxs-lookup"><span data-stu-id="0eff6-122">Commit custom actions are the first actions to run in the rollback script.</span></span> <span data-ttu-id="0eff6-123">Если пользовательское действие фиксации завершается ошибкой, установщик инициирует откат, но может выполнять только откат тех операций, которые уже записаны в скрипт отката.</span><span class="sxs-lookup"><span data-stu-id="0eff6-123">If a commit custom action fails, the installer initiates rollback but can only rollback those operations already written to the rollback script.</span></span> <span data-ttu-id="0eff6-124">Это означает, что в зависимости от настраиваемого действия фиксации откат может не иметь возможности отменить изменения, внесенные действием.</span><span class="sxs-lookup"><span data-stu-id="0eff6-124">This means that depending on the commit custom action, a rollback may not be able to undo the changes made by the action.</span></span> <span data-ttu-id="0eff6-125">Можно пропускать сбои при фиксации настраиваемых действий путем создания настраиваемого действия для игнорирования кодов возврата.</span><span class="sxs-lookup"><span data-stu-id="0eff6-125">You can ignore failures in commit custom actions by authoring the custom action to ignore return codes.</span></span>

<span data-ttu-id="0eff6-126">Когда установщик запускает настраиваемое действие отката, единственным параметром mode, который он задает, будет МСИРУНМОДЕ \_ Rollback.</span><span class="sxs-lookup"><span data-stu-id="0eff6-126">When the installer runs a rollback custom action, the only mode parameter it will set is MSIRUNMODE\_ROLLBACK.</span></span> <span data-ttu-id="0eff6-127">Описание параметров режима выполнения см. в разделе [**мсижетмоде**](/windows/desktop/api/Msiquery/nf-msiquery-msigetmode) .</span><span class="sxs-lookup"><span data-stu-id="0eff6-127">See [**MsiGetMode**](/windows/desktop/api/Msiquery/nf-msiquery-msigetmode) for a description of the run mode parameters.</span></span>

<span data-ttu-id="0eff6-128">Пользовательское действие отката можно указать, добавив флаг параметра в поле Тип [таблицы CustomAction](customaction-table.md).</span><span class="sxs-lookup"><span data-stu-id="0eff6-128">A rollback custom action can be specified by adding an option flag to the Type field of the [CustomAction table](customaction-table.md).</span></span> <span data-ttu-id="0eff6-129">Дополнительные сведения см. в разделе [настраиваемое действие In-Script параметры выполнения](custom-action-in-script-execution-options.md) для флага параметра, определяющего настраиваемое действие отката.</span><span class="sxs-lookup"><span data-stu-id="0eff6-129">See [Custom Action In-Script Execution Options](custom-action-in-script-execution-options.md) for the option flag designating a rollback custom action.</span></span>

<span data-ttu-id="0eff6-130">Пользовательские действия отката и фиксации не выполняются, если откат отключен.</span><span class="sxs-lookup"><span data-stu-id="0eff6-130">Rollback and commit custom actions do not run when rollback is disabled.</span></span> <span data-ttu-id="0eff6-131">Если автор пакета требует этих типов настраиваемых действий для правильной установки, они должны использовать свойство [**роллбаккдисаблед**](rollbackdisabled.md) в условии, которое не позволяет продолжить установку после отключения отката.</span><span class="sxs-lookup"><span data-stu-id="0eff6-131">If a package author requires these types of custom actions for proper installation, they should use the [**RollbackDisabled**](rollbackdisabled.md) property in a condition that prevents the installation from continuing when rollback is disabled.</span></span> <span data-ttu-id="0eff6-132">Сведения о том, как отключить откат, см. в разделе [ROLLBACK Installation (установщик Windows)](rollback-installation.md).</span><span class="sxs-lookup"><span data-stu-id="0eff6-132">For information on how to disable rollback see [Rollback Installation (Windows Installer)](rollback-installation.md).</span></span>

 

 



