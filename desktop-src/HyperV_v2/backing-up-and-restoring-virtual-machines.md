---
description: Hyper-V использует служба теневого копирования томов (VSS) для резервного копирования и восстановления виртуальных машин.
ms.assetid: 94C67F22-658D-49DD-9588-6BB4FCF7ADA9
title: Резервное копирование и восстановление виртуальных машин
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6f9cf6d5b80a4c7392fb38e893a4fafad3f90435
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105683434"
---
# <a name="backing-up-and-restoring-virtual-machines"></a><span data-ttu-id="f6c9d-103">Резервное копирование и восстановление виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="f6c9d-103">Backing up and restoring virtual machines</span></span>

<span data-ttu-id="f6c9d-104">Hyper-V использует служба теневого копирования томов (VSS) для резервного копирования и восстановления виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-104">Hyper-V uses the Volume Shadow Copy Service (VSS) to backup and restore virtual machines.</span></span> <span data-ttu-id="f6c9d-105">Если службы интеграции резервного копирования (моментального снимка тома) установлены в операционной системе на виртуальной машине, то устанавливается инициатор запроса VSS, который позволит модулям записи VSS в гостевой операционной системе участвовать в резервной копии виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-105">If the backup (volume snapshot) integration services are installed in the guest operating system, a VSS requester is installed that will allow VSS writers in the guest operating system to participate in the backup of the virtual machine.</span></span> <span data-ttu-id="f6c9d-106">Дополнительные сведения см. в следующих разделах:</span><span class="sxs-lookup"><span data-stu-id="f6c9d-106">For details, see the following sections:</span></span>

-   [<span data-ttu-id="f6c9d-107">Резервное копирование виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="f6c9d-107">Backing up the virtual machines</span></span>](#backing-up-the-virtual-machines)
-   [<span data-ttu-id="f6c9d-108">Восстановление виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="f6c9d-108">Restoring the virtual machines</span></span>](#restoring-the-virtual-machines)
-   [<span data-ttu-id="f6c9d-109">Отказоустойчивая кластеризация и Hyper-V VSS</span><span class="sxs-lookup"><span data-stu-id="f6c9d-109">Failover clustering and Hyper-V VSS</span></span>](#failover-clustering-and-hyper-v-vss)
-   [<span data-ttu-id="f6c9d-110">Сведения о модуле записи VSS Hyper-V</span><span class="sxs-lookup"><span data-stu-id="f6c9d-110">Details on the Hyper-V VSS Writer</span></span>](#details-on-the-hyper-v-vss-writer)
-   [<span data-ttu-id="f6c9d-111">См. также</span><span class="sxs-lookup"><span data-stu-id="f6c9d-111">Related topics</span></span>](#related-topics)

## <a name="backing-up-the-virtual-machines"></a><span data-ttu-id="f6c9d-112">Резервное копирование виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="f6c9d-112">Backing up the virtual machines</span></span>

<span data-ttu-id="f6c9d-113">Hyper-V использует один из двух механизмов резервного копирования каждой виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-113">Hyper-V uses one of two mechanisms to back up each virtual machine.</span></span> <span data-ttu-id="f6c9d-114">Механизм резервного копирования по умолчанию называется методом "сохраненное состояние", где виртуальная машина переводится в сохраненное состояние во время обработки события Препарефорснапшот, моментальные снимки берутся из соответствующих томов, а виртуальная машина возвращается в предыдущее состояние во время обработки события моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-114">The default backup mechanism is called the "Saved State" method, where the virtual machine is put into a saved state during the processing of the PrepareForSnapshot event, snapshots are taken of the appropriate volumes, and the virtual machine is returned to the previous state during the processing of the PostSnapshot event.</span></span>

<span data-ttu-id="f6c9d-115">Другой механизм резервного копирования называется методом "моментальный снимок дочерней виртуальной машины", который использует VSS внутри дочерней виртуальной машины для участия в резервной копии.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-115">The other backup mechanism is called the "Child VM Snapshot" method, which uses VSS inside the child virtual machine to participate in the backup.</span></span> <span data-ttu-id="f6c9d-116">Для поддержки метода "моментальный снимок дочерней виртуальной машины" должны быть выполнены все следующие условия.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-116">For the "Child VM Snapshot" method to be supported, all of the following conditions must be met:</span></span>

-   <span data-ttu-id="f6c9d-117">Служба интеграции резервного копирования (моментальный снимок тома) установлена и запущена на дочерней виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-117">Backup (volume snapshot) Integration Service is installed and running in the child virtual machine.</span></span> <span data-ttu-id="f6c9d-118">Имя службы — "инициатор запроса теневого копирования тома Hyper-V".</span><span class="sxs-lookup"><span data-stu-id="f6c9d-118">The service name is "Hyper-V Volume Shadow Copy Requestor".</span></span>
-   <span data-ttu-id="f6c9d-119">Дочерняя виртуальная машина должна находиться в состоянии выполняется.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-119">The child virtual machine must be in the running state.</span></span>
-   <span data-ttu-id="f6c9d-120">В качестве расположения файла моментального снимка для виртуальной машины выбран тот же том, что и VHD-файлы виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-120">The Snapshot File Location for the virtual machine is set to be the same volume in the host operating system as the VHD files for the virtual machine.</span></span>
-   <span data-ttu-id="f6c9d-121">Все тома на дочерней виртуальной машине являются базовыми дисками, а динамические диски отсутствуют.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-121">All volumes on the child virtual machine are basic disks and there are no dynamic disks.</span></span>
-   <span data-ttu-id="f6c9d-122">Все диски на дочерней виртуальной машине должны использовать файловую систему, поддерживающую моментальные снимки (например, NTFS).</span><span class="sxs-lookup"><span data-stu-id="f6c9d-122">All disks on the child virtual machine must use a file system that supports snapshots (for example, NTFS).</span></span>

<span data-ttu-id="f6c9d-123">Как правило, процесс резервного копирования виртуальных машин аналогичен описанному в [разделе Общие сведения об обработке резервной копии в VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span><span class="sxs-lookup"><span data-stu-id="f6c9d-123">In general, the process for backing up virtual machines is the same as described in [Overview of Processing a Backup Under VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span></span> <span data-ttu-id="f6c9d-124">Уникальное поведение возникает, когда модуль записи VSS Hyper-V (компонент службы управления виртуальными машинами Hyper-V) обрабатывает событие Препарефорснапшот.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-124">The unique behavior happens when the Hyper-V VSS writer (part of the "Hyper-V Virtual Machine Management" service) processes the PrepareForSnapshot event.</span></span> <span data-ttu-id="f6c9d-125">Если резервная копия была выполнена с помощью метода "моментальный снимок дочерней виртуальной машины", то выполняется дополнительная обработка, но она не видна дочерней виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-125">If the backup was done using the "Child VM Snapshot" method, there is additional processing done but it is not visible to the child virtual machine.</span></span>

<span data-ttu-id="f6c9d-126">В следующей процедуре описывается, как выполнять резервное копирование виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-126">The following procedure describes how to back up virtual machines.</span></span>

<span data-ttu-id="f6c9d-127">**Архивация виртуальных машин**</span><span class="sxs-lookup"><span data-stu-id="f6c9d-127">**To back up virtual machines**</span></span>

1.  <span data-ttu-id="f6c9d-128">Для каждой виртуальной машины в метаданных модуля записи, если используется метод "сохраненное состояние", виртуальная машина переводится в сохраненное состояние.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-128">For each virtual machine in the writer metadata, if the "Saved State" method is used, the virtual machine is put into a saved state.</span></span> <span data-ttu-id="f6c9d-129">Для виртуальных машин, использующих метод "моментальный снимок дочерней виртуальной машины", служба запроса теневого копирования томов Hyper-V на дочерней виртуальной машине обрабатывает резервную копию, как описано в статье [Общие сведения об обработке резервной копии в VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span><span class="sxs-lookup"><span data-stu-id="f6c9d-129">For virtual machines using the "Child VM Snapshot" method, the Hyper-V Volume Shadow Copy Requestor Service in the child virtual machine processes the backup as detailed in [Overview of Processing a Backup Under VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span></span> <span data-ttu-id="f6c9d-130">Все события VSS на дочерней виртуальной машине происходят во время обработки события Препарефорснапшот в операционной системе узла.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-130">All VSS events on the child virtual machine occur during the host operating system processing of the PrepareForSnapshot event.</span></span>
2.  <span data-ttu-id="f6c9d-131">После того как все виртуальные машины будут помещены в сохраненное состояние или были созданы моментальные снимки, модуль записи VSS Hyper-V Возвращает событие Препарефорснапшот.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-131">After all virtual machines have either been put in the saved state or had snapshots taken, the Hyper-V VSS writer returns from the PrepareForSnapshot event.</span></span> <span data-ttu-id="f6c9d-132">Не выполняется обработка модулем записи VSS Hyper-V во время событий замораживания и разморозки.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-132">No processing is done by the Hyper-V VSS writer during the Freeze and Thaw events.</span></span>
3.  <span data-ttu-id="f6c9d-133">Когда модуль записи VSS Hyper-V обрабатывает событие моментального снимка, виртуальные машины, для которых было выполнено резервное копирование с помощью метода "сохраненное состояние" и были переведены в сохраненное состояние, модуль записи VSS Hyper-V возвращается в состояние, в котором они находились до начала резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-133">When the Hyper-V VSS writer processes the PostSnapshot event, virtual machines that were backed up using the "Saved State" method and were put into a saved state by the Hyper-V VSS writer are returned to the state they were in before the backup started.</span></span> <span data-ttu-id="f6c9d-134">Для виртуальных машин, резервная копия которых была создана с помощью метода "моментальный снимок дочерней виртуальной машины", образ VHD-файлов, для которых были созданы моментальные снимки, будет возвращен в моментальный снимок, сделанный во время обработки события Препарефорснапшот.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-134">For the virtual machines that were backed up using the "Child VM Snapshot" method, the host image of the VHD files that had the snapshots taken are rolled back to the snapshot taken during the processing of the PrepareForSnapshot event.</span></span> <span data-ttu-id="f6c9d-135">Эта обработка выполняется независимо от модулей записи VSS на дочерних виртуальных машинах, поэтому создаваемые моментальные снимки должны быть восстановлены в автоматическом виде.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-135">This processing is done independently of the VSS writers on the child virtual machines so the snapshots taken must be auto-recoverable.</span></span> <span data-ttu-id="f6c9d-136">(Служба **VSS \_ VOLSNAP attr не устанавливает \_ \_ \_ Автовосстановление** в контексте.)</span><span class="sxs-lookup"><span data-stu-id="f6c9d-136">(**VSS\_VOLSNAP\_ATTR\_NO\_AUTORECOVERY** is not set in the context.)</span></span>

<span data-ttu-id="f6c9d-137">Частичные резервные копии не поддерживаются.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-137">Partial backups are not supported.</span></span> <span data-ttu-id="f6c9d-138">Если какой-либо виртуальной машине не удается создать моментальный снимок, резервное копирование виртуальных машин не выполняется.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-138">If any virtual machine fails to create a snapshot, no virtual machines will be backed up.</span></span>

> [!Note]  
> <span data-ttu-id="f6c9d-139">Диски с передаваемыми и iSCSI не видны операционной системе узла и, следовательно, не поддерживаются модулем записи VSS Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-139">Pass-through and iSCSI disks are not visible to the host operating system and therefore not backed up by the Hyper-V VSS writer.</span></span> <span data-ttu-id="f6c9d-140">Резервное копирование этих томов должно выполняться полностью на виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-140">Backups of these volumes must be done entirely on the virtual machine.</span></span>

 

## <a name="restoring-the-virtual-machines"></a><span data-ttu-id="f6c9d-141">Восстановление виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="f6c9d-141">Restoring the virtual machines</span></span>

<span data-ttu-id="f6c9d-142">Восстановление виртуальных машин полностью выполняется операционной системой узла; модули записи VSS на дочерних виртуальных машинах не задействованы.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-142">Restoring the virtual machines is done entirely by the host operating system; the VSS writers on the child virtual machines are not involved.</span></span>

<span data-ttu-id="f6c9d-143">В следующей процедуре описывается восстановление виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-143">The following procedure describes how to restore virtual machines.</span></span>

<span data-ttu-id="f6c9d-144">**Восстановление виртуальных машин**</span><span class="sxs-lookup"><span data-stu-id="f6c9d-144">**To restore virtual machines**</span></span>

1.  <span data-ttu-id="f6c9d-145">Во время обработки события предварительного восстановления модуль записи VSS Hyper-V отключает и удаляет все виртуальные машины, которые будут восстановлены.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-145">During the processing of the PreRestore event, the Hyper-V VSS writer turns off and deletes any virtual machines that are about to be restored.</span></span>
2.  <span data-ttu-id="f6c9d-146">После того как все модули записи VSS обрабатывали событие, выполняемое перед восстановлением, файлы восстанавливаются.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-146">After all VSS writers have processed the PreRestore event, the files are restored.</span></span>
3.  <span data-ttu-id="f6c9d-147">Во время обработки события Restore модуль записи VSS Hyper-V вызывает метод [**ивсскомпонент:: жетфилересторестатус**](/windows/desktop/api/vswriter/nf-vswriter-ivsscomponent-getfilerestorestatus) .</span><span class="sxs-lookup"><span data-stu-id="f6c9d-147">During the processing of the PostRestore event, the Hyper-V VSS writer calls the [**IVssComponent::GetFileRestoreStatus**](/windows/desktop/api/vswriter/nf-vswriter-ivsscomponent-getfilerestorestatus) method.</span></span> <span data-ttu-id="f6c9d-148">Если возвращается не **все службы VSS \_ RS \_**, модуль записи VSS Hyper-V вызывает метод [**сетвритерфаилуре**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-setwriterfailure) и возвращает **false** из метода [**онпостресторе**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-onpostrestore) .</span><span class="sxs-lookup"><span data-stu-id="f6c9d-148">If the return is not **VSS\_RS\_ALL**, then the Hyper-V VSS writer calls the [**SetWriterFailure**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-setwriterfailure) method and returns **False** from the [**OnPostRestore**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-onpostrestore) method.</span></span>
4.  <span data-ttu-id="f6c9d-149">Для каждой восстановленной виртуальной машины модуль записи VSS Hyper-V регистрирует виртуальную машину в службе управления Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-149">For each virtual machine that was restored, the Hyper-V VSS writer registers the virtual machine with the Hyper-V management service.</span></span> <span data-ttu-id="f6c9d-150">Если виртуальная машина восстанавливается в расположение, не используемое по умолчанию, в расположении по умолчанию, связанном с этим расположением, создается символьная ссылка.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-150">If the virtual machine is restored to a nondefault location, a symbolic link is created in the default location linking to that location.</span></span>
5.  <span data-ttu-id="f6c9d-151">Для каждого восстановленного виртуального жесткого диска расположение сравнивается с указанным для этой виртуальной машины значением.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-151">For each VHD that was restored, the location is compared with the one specified for that virtual machine.</span></span> <span data-ttu-id="f6c9d-152">Если расположение отличается, конфигурация обновляется в соответствии с соответствующим расположением.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-152">If the location is different, then the configuration is updated with the proper location.</span></span>
6.  <span data-ttu-id="f6c9d-153">Конфигурация сети обновлена.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-153">The network configuration is updated.</span></span> <span data-ttu-id="f6c9d-154">Если виртуальные коммутаторы, к которым подключена виртуальная машина, в момент выхода из резервной копии все еще завершаются, создаются новые порты, которые подключаются к виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-154">If the virtual switches that the virtual machine was connected to when it was backed up still exit, new ports are created and connected to the virtual machine.</span></span>

## <a name="failover-clustering-and-hyper-v-vss"></a><span data-ttu-id="f6c9d-155">Отказоустойчивая кластеризация и Hyper-V VSS</span><span class="sxs-lookup"><span data-stu-id="f6c9d-155">Failover clustering and Hyper-V VSS</span></span>

<span data-ttu-id="f6c9d-156">Модуль записи VSS Hyper-V не учитывает виртуальные машины, которые являются частью отказоустойчивого кластера.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-156">The Hyper-V VSS writer does not give any consideration to virtual machines that are part of a failover cluster.</span></span> <span data-ttu-id="f6c9d-157">Во время резервного копирования метода "сохраненное состояние" и всех восстановлений виртуальная машина будет переведена в сохраненное состояние или полностью удалена.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-157">During both the "Saved State" method backups and all restores, the virtual machine would be put into the saved state or deleted entirely.</span></span> <span data-ttu-id="f6c9d-158">Это будет рассматриваться как сбой службы кластеров и привести к отработки отказа приложений на этих узлах на другие узлы.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-158">This would be seen as a failure by the clustering service and cause the applications on those nodes to be failed over to other nodes.</span></span> <span data-ttu-id="f6c9d-159">Чтобы избежать этого во время резервного копирования "сохраненного состояния", состояние виртуальной машины необходимо сохранить с помощью службы кластеризации.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-159">To avoid this during "Saved State" backups, the virtual machine state must be saved using the clustering service.</span></span> <span data-ttu-id="f6c9d-160">Чтобы избежать этой ситуации во время восстановления, необходимо перевести ресурсы виртуальной машины в автономный режим.</span><span class="sxs-lookup"><span data-stu-id="f6c9d-160">To avoid this during a restore, the resources on the virtual machine would need to be taken offline.</span></span>

## <a name="details-on-the-hyper-v-vss-writer"></a><span data-ttu-id="f6c9d-161">Сведения о модуле записи VSS Hyper-V</span><span class="sxs-lookup"><span data-stu-id="f6c9d-161">Details on the Hyper-V VSS Writer</span></span>

<span data-ttu-id="f6c9d-162">Имя модуля записи: Microsoft Hyper-V модуль записи VSS</span><span class="sxs-lookup"><span data-stu-id="f6c9d-162">Writer Name: Microsoft Hyper-V VSS Writer</span></span>

<span data-ttu-id="f6c9d-163">Идентификатор модуля записи: 66841CD4-6DED-4F4B-8F17-FD23F8DDC3DE</span><span class="sxs-lookup"><span data-stu-id="f6c9d-163">Writer ID: 66841cd4-6ded-4f4b-8f17-fd23f8ddc3de</span></span>

## <a name="related-topics"></a><span data-ttu-id="f6c9d-164">См. также</span><span class="sxs-lookup"><span data-stu-id="f6c9d-164">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="f6c9d-165">Общие сведения об обработке резервной копии в VSS</span><span class="sxs-lookup"><span data-stu-id="f6c9d-165">Overview of Processing a Backup Under VSS</span></span>](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss)
</dt> <dt>

[<span data-ttu-id="f6c9d-166">Общие сведения об обработке восстановления в VSS</span><span class="sxs-lookup"><span data-stu-id="f6c9d-166">Overview of Processing a Restore Under VSS</span></span>](/windows/desktop/VSS/overview-of-processing-a-restore-under-vss)
</dt> </dl>

 

 
