---
title: Структура примера классического приложения
description: Структура примера классического приложения
ms.assetid: e042470d-dc78-488c-bcad-2e8d34714d5d
keywords:
- Диспетчер устройств Windows Media, примеры
- Диспетчер устройств, примеры
- Классические приложения, примеры
- Windows Media диспетчер устройств, пример классического приложения
- Диспетчер устройств, пример классического приложения
- Примеры, классические приложения
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 34fb377c1bb6ebf943721b55ec6175e65f70ddde
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "103776655"
---
# <a name="structure-of-the-sample-desktop-application"></a><span data-ttu-id="41548-109">Структура примера классического приложения</span><span class="sxs-lookup"><span data-stu-id="41548-109">Structure of the Sample Desktop Application</span></span>

<span data-ttu-id="41548-110">Пример классического приложения состоит из двух основных частей:</span><span class="sxs-lookup"><span data-stu-id="41548-110">The sample desktop application consists of two main pieces:</span></span>

-   <span data-ttu-id="41548-111">Проект вмдапп содержит большинство классов, которые отображают пользовательский интерфейс, выполняют перетаскивание и выполняют все необходимые функции программы.</span><span class="sxs-lookup"><span data-stu-id="41548-111">The wmdapp project contains most of the classes that display the user interface, handle dragging and dropping, and perform all the required functionality of the program.</span></span>
-   <span data-ttu-id="41548-112">Проект прогхелп — это вспомогательное приложение, которое содержит ненужные классы для обслуживания уведомлений о состоянии и передачи файлов вручную с рабочего стола в приложение.</span><span class="sxs-lookup"><span data-stu-id="41548-112">The proghelp project is a helper application that contains nonessential classes to handle status notifications and manual file transfers from the desktop to the application.</span></span>

<span data-ttu-id="41548-113">Исполняемый проект используется во вспомогательном проекте только в том случае, если пользователь выбирает **параметр** **использовать интерфейс операции** в меню Параметры для обработки вручную перемещения файлов на устройство, а также для увеличения строки состояния в форме ход загрузки.</span><span class="sxs-lookup"><span data-stu-id="41548-113">The executable uses the helper project only when the user selects **Use Operation Interface** on the **Options** menu to handle manual file transfer to the device, and to increment the status bar in the download progress form.</span></span> <span data-ttu-id="41548-114">Все остальные приложения обрабатываются в проекте вмдапп.</span><span class="sxs-lookup"><span data-stu-id="41548-114">All the rest of the application is handled in the wmdapp project.</span></span>



| <span data-ttu-id="41548-115">Класс</span><span class="sxs-lookup"><span data-stu-id="41548-115">Class</span></span>                | <span data-ttu-id="41548-116">Файл</span><span class="sxs-lookup"><span data-stu-id="41548-116">File</span></span>                    | <span data-ttu-id="41548-117">Описание</span><span class="sxs-lookup"><span data-stu-id="41548-117">Description</span></span>                                                                                                                                                                                                                                                                                                                                                                                     |
|----------------------|-------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="41548-118">—</span><span class="sxs-lookup"><span data-stu-id="41548-118">—</span></span>                    | <span data-ttu-id="41548-119">вмдмапп. cpp</span><span class="sxs-lookup"><span data-stu-id="41548-119">wmdmapp.cpp</span></span>             | <span data-ttu-id="41548-120">Класс, обрабатывающий родительское окно пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="41548-120">The class that handles the parent window of the user interface.</span></span> <span data-ttu-id="41548-121">Код в этом файле также обрабатывает некоторые входные пользователем данные, не обрабатываемые Кдевфилес, такие как создание списка воспроизведения или альбома на устройстве, удаление файлов и регистрация вариантов меню.</span><span class="sxs-lookup"><span data-stu-id="41548-121">The code in this file also handles some user input not handled by CDevFiles, such as creating a playlist or album on a device, deleting files, and registering menu choices.</span></span>                                                                                                                                                    |
| <span data-ttu-id="41548-122">кдевицес</span><span class="sxs-lookup"><span data-stu-id="41548-122">CDevices</span></span>             | <span data-ttu-id="41548-123">Devices. cpp</span><span class="sxs-lookup"><span data-stu-id="41548-123">Devices.cpp</span></span>             | <span data-ttu-id="41548-124">Класс, обрабатывающий левую панель главного окна приложения, где перечислены доступные устройства.</span><span class="sxs-lookup"><span data-stu-id="41548-124">The class that handles the left-hand pane of the main application window, where the available devices are listed.</span></span> <span data-ttu-id="41548-125">Этот класс управляет циклом обмена сообщениями, который обрабатывает входные данные пользователя, такие как выбор устройства и уведомление панели Кдевфилес для загрузки соответствующих файлов при изменении выбора устройства.</span><span class="sxs-lookup"><span data-stu-id="41548-125">This class manages the messaging loop, which handles user input such as selecting a device and notifying the CDevFiles pane to load the appropriate files when the device selection has changed.</span></span>                                                                              |
| <span data-ttu-id="41548-126">кдевфилес</span><span class="sxs-lookup"><span data-stu-id="41548-126">CDevFiles</span></span>            | <span data-ttu-id="41548-127">Девфилес. cpp</span><span class="sxs-lookup"><span data-stu-id="41548-127">Devfiles.cpp</span></span>            | <span data-ttu-id="41548-128">Класс, обрабатывающий правую панель главного окна приложения, где перечислены файлы на выбранном устройстве.</span><span class="sxs-lookup"><span data-stu-id="41548-128">The class that handles the right-hand pane of the main application window, where the files on the selected device are listed.</span></span> <span data-ttu-id="41548-129">Этот класс управляет циклом обмена сообщениями и обрабатывает вводимые пользователем данные, такие как перетаскивание файлов на устройство и удаление файлов с устройства.</span><span class="sxs-lookup"><span data-stu-id="41548-129">This class manages the messaging loop, and handles user input such as dragging files onto the device and deleting files from the device.</span></span>                                                                                                                          |
| <span data-ttu-id="41548-130">кстатус</span><span class="sxs-lookup"><span data-stu-id="41548-130">CStatus</span></span>              | <span data-ttu-id="41548-131">Status. cpp</span><span class="sxs-lookup"><span data-stu-id="41548-131">Status.cpp</span></span>              | <span data-ttu-id="41548-132">Класс, обрабатывающий нижнюю строку состояния в главном окне, где указано количество устройств и файлов, а также объем свободной и используемой памяти на выбранном устройстве.</span><span class="sxs-lookup"><span data-stu-id="41548-132">The class that handles the bottom status bar in the main window, where the number of devices and files is listed, along with the amount of free and used memory on the selected device.</span></span>                                                                                                                                                                                                         |
| <span data-ttu-id="41548-133">квмдм</span><span class="sxs-lookup"><span data-stu-id="41548-133">CWMDM</span></span>                | <span data-ttu-id="41548-134">Вмдевмгр. cpp</span><span class="sxs-lookup"><span data-stu-id="41548-134">Wmdevmgr.cpp</span></span>            | <span data-ttu-id="41548-135">Интерфейс верхнего уровня для диспетчер устройств Windows Media.</span><span class="sxs-lookup"><span data-stu-id="41548-135">The top-level interface for Windows Media Device Manager.</span></span> <span data-ttu-id="41548-136">Этот класс обрабатывает проверку подлинности, получает интерфейс **ивмдевицеманажер** верхнего уровня и регистрирует уведомления с помощью интерфейса **ивмдмнотификатион** .</span><span class="sxs-lookup"><span data-stu-id="41548-136">This class handles authentication, retrieves the top-level **IWMDeviceManager** interface, and registers for notifications with the **IWMDMNotification** interface.</span></span>                                                                                                                                                                  |
| <span data-ttu-id="41548-137">кпрогресс</span><span class="sxs-lookup"><span data-stu-id="41548-137">CProgress</span></span>            | <span data-ttu-id="41548-138">Progress. cpp</span><span class="sxs-lookup"><span data-stu-id="41548-138">Progress.cpp</span></span>            | <span data-ttu-id="41548-139">Класс в главном проекте приложения, который создает и управляет диалоговым окном, отображающим ход выполнения события.</span><span class="sxs-lookup"><span data-stu-id="41548-139">The class in the main application project that creates and manages the dialog box showing the progress of an event.</span></span>                                                                                                                                                                                                                                                                             |
| <span data-ttu-id="41548-140">Цитемдата</span><span class="sxs-lookup"><span data-stu-id="41548-140">CItemData</span></span>            | <span data-ttu-id="41548-141">Итемдата. cpp</span><span class="sxs-lookup"><span data-stu-id="41548-141">ItemData.cpp</span></span>            | <span data-ttu-id="41548-142">Класс-оболочка, который содержит указатель на хранилище (если представляет собой файл или папку на устройстве) или устройство (если представляет устройство), а также различные сведения об объекте, включая размер и атрибуты.</span><span class="sxs-lookup"><span data-stu-id="41548-142">A wrapper class that holds a pointer to a storage (if representing a file or folder on the device) or a device (if representing a device), as well as a variety of information about the object including size and attributes.</span></span>                                                                                                                                                                  |
| <span data-ttu-id="41548-143">кнотификатионхандлер</span><span class="sxs-lookup"><span data-stu-id="41548-143">CNotificationHandler</span></span> | <span data-ttu-id="41548-144">Нотификатионхандлер. cpp</span><span class="sxs-lookup"><span data-stu-id="41548-144">Notificationhandler.cpp</span></span> | <span data-ttu-id="41548-145">Обрабатывает уведомления о получении и удалении устройств, уведомляя окно Кдевицес.</span><span class="sxs-lookup"><span data-stu-id="41548-145">Handles device arrival and removal notifications by alerting the CDevices window.</span></span>                                                                                                                                                                                                                                                                                                               |
| <span data-ttu-id="41548-146">кпрогресшелпер</span><span class="sxs-lookup"><span data-stu-id="41548-146">CProgressHelper</span></span>      | <span data-ttu-id="41548-147">Прогресшелпер. cpp</span><span class="sxs-lookup"><span data-stu-id="41548-147">ProgressHelper.cpp</span></span>      | <span data-ttu-id="41548-148">Создано Кдевфилес в локальных функциях для получения уведомлений от диспетчер устройств Windows Media путем реализации **ивмдмпрогресс**.</span><span class="sxs-lookup"><span data-stu-id="41548-148">Created by CDevFiles in local functions to receive notifications from Windows Media Device Manager by implementing **IWMDMProgress**.</span></span> <span data-ttu-id="41548-149">Он используется классом Кпрогресс для определения объема полос на индикаторе выполнения и по завершении действия.</span><span class="sxs-lookup"><span data-stu-id="41548-149">It is used by the CProgress class to determine the amount of bars in the progress bar, and when an action is finished.</span></span> <span data-ttu-id="41548-150">Этот класс определен как COM-объект, предоставляющий интерфейс SDK **ивмдмпрогресс** и пользовательский интерфейс ивмдмпрогресшелпер.</span><span class="sxs-lookup"><span data-stu-id="41548-150">This class is defined as a COM object that exposes the SDK interface **IWMDMProgress** and a custom interface IWMDMProgressHelper.</span></span> |
| <span data-ttu-id="41548-151">коператионхелпер</span><span class="sxs-lookup"><span data-stu-id="41548-151">COperationHelper</span></span>     | <span data-ttu-id="41548-152">Оператионхелпер. cpp</span><span class="sxs-lookup"><span data-stu-id="41548-152">Operationhelper.cpp</span></span>     | <span data-ttu-id="41548-153">Этот класс реализует **ивмдмоператион** для выполнения ручной пересылки файлов.</span><span class="sxs-lookup"><span data-stu-id="41548-153">This class implements **IWMDMOperation** to handle manual transfer of files.</span></span> <span data-ttu-id="41548-154">Это многопоточный процесс, позволяющий асинхронно выполняться и определяться как COM-объект, предоставляющий пользовательский интерфейс Ивмдмоператионхелпер для создания и инициализации класса.</span><span class="sxs-lookup"><span data-stu-id="41548-154">It is multi-threaded to allow it to occur asynchronously, and is defined as a COM object that exposes a custom interface, IWMDMOperationHelper, to instantiate and initialize the class.</span></span> <span data-ttu-id="41548-155">Этот класс используется только в том случае, если пользователь выбирает параметр "использовать интерфейс операции" в меню " **Параметры** ".</span><span class="sxs-lookup"><span data-stu-id="41548-155">This class is only used if the user selects "Use Operation Interface" in the **Options** menu.</span></span>                            |



 

<span data-ttu-id="41548-156">В следующих списках описаны основные шаги, выполняемые для различных действий пользователя.</span><span class="sxs-lookup"><span data-stu-id="41548-156">The following lists outline the basic steps that occur for various user actions:</span></span>

<span data-ttu-id="41548-157">**При запуске**</span><span class="sxs-lookup"><span data-stu-id="41548-157">**On startup**</span></span>

<span data-ttu-id="41548-158">При запуске примера приложения выполняются следующие основные шаги.</span><span class="sxs-lookup"><span data-stu-id="41548-158">The following main steps occur when the sample application is started.</span></span>

1.  <span data-ttu-id="41548-159">Выполняется создание экземпляра и проверка подлинности глобальной переменной КВМДМ, а также регистрация для получения уведомлений.</span><span class="sxs-lookup"><span data-stu-id="41548-159">The global CWMDM variable is instantiated and authenticated, and registers to receive notifications</span></span>
2.  <span data-ttu-id="41548-160">Создается глобальный Кдевицес, и вызывается Кдевицес:: Create для создания и заполнения панели устройства.</span><span class="sxs-lookup"><span data-stu-id="41548-160">A global CDevices is instantiated, and CDevices::Create is called to create and fill the devices pane.</span></span>
3.  <span data-ttu-id="41548-161">Создается глобальный Кдевфилес, и вызывается Кдевфилес:: Create, чтобы создать панель файлов (которая не заполняется до тех пор, пока пользователь не выберет устройство).</span><span class="sxs-lookup"><span data-stu-id="41548-161">A global CDevFiles is instantiated, and CDevFiles::Create is called to create the files pane (which is not filled until the user selects a device).</span></span>
4.  <span data-ttu-id="41548-162">Создается глобальный Кстатус, и вызывается Кстатус:: Create для создания экземпляра строки состояния.</span><span class="sxs-lookup"><span data-stu-id="41548-162">A global CStatus is instantiated, and CStatus::Create is called to instantiate the status bar.</span></span>
5.  <span data-ttu-id="41548-163">\_Онвиеврефреш перечисляет все устройства и инициализирует и добавляет все устройства (Цитемдата) в Кдевицес и обновляет строку состояния для отображения числа устройств.</span><span class="sxs-lookup"><span data-stu-id="41548-163">\_OnViewRefresh enumerates through all devices and initializes and adds all devices (CItemData) to CDevices and updates the status bar to show the number of devices.</span></span>
6.  <span data-ttu-id="41548-164">Кдевицес:: AddItem добавляет элемент в TreeView, представляющий устройства, с указателем на себя в виде ТВИТЕМ. lParam.</span><span class="sxs-lookup"><span data-stu-id="41548-164">CDevices::AddItem adds the item to the treeview representing the devices, with a pointer to itself as the TVITEM.lparam.</span></span> <span data-ttu-id="41548-165">Все объекты Кдевице (Devices) и Кдевфилес (File) хранятся в этом элементе узла TreeView в соответствующем окне.</span><span class="sxs-lookup"><span data-stu-id="41548-165">All CDevice (devices) and CDevFiles (file) objects are stored in this member of the treeview node in the appropriate window.</span></span>

<span data-ttu-id="41548-166">**Выбор устройства**</span><span class="sxs-lookup"><span data-stu-id="41548-166">**On selecting a device**</span></span>

<span data-ttu-id="41548-167">Следующие основные шаги выполняются, когда пользователь выбирает устройство в левой области окна приложения.</span><span class="sxs-lookup"><span data-stu-id="41548-167">The following main steps occur when the user selects a device in the left-hand pane of the application window.</span></span>

1.  <span data-ttu-id="41548-168">Окно Кдевицес перехватывает щелчок и отправляет \_ сообщение УПДАТЕДЕВИЦЕ WM DRM \_ в само себя.</span><span class="sxs-lookup"><span data-stu-id="41548-168">The CDevices window traps a click and posts a WM\_DRM\_UPDATEDEVICE message, to itself.</span></span>
2.  <span data-ttu-id="41548-169">Кдевицес получает собственное сообщение и вызывает UpdateSelection, который сообщает глобальному объекту Кдевфилес очистить все, перечислить все элементы верхнего уровня на устройстве и вызывает Кдевфилес:: AddItem, чтобы добавить их в область "файлы".</span><span class="sxs-lookup"><span data-stu-id="41548-169">CDevices receives its own message and calls UpdateSelection, which tells the global CDevFiles object to clear everything, enumerate all the top-level items in the device, and calls CDevFiles::AddItem to add each to the files pane.</span></span>
3.  <span data-ttu-id="41548-170">Наконец, Кдевицес вызывает Кдевфилес:: Упдатестатусбар, чтобы обновить строку состояния, указав правильные сведения об устройстве и файле.</span><span class="sxs-lookup"><span data-stu-id="41548-170">Finally, CDevices calls CDevFiles::UpdateStatusBar to update the status bar with the correct device and file information.</span></span>

<span data-ttu-id="41548-171">**Создание списка воспроизведения**</span><span class="sxs-lookup"><span data-stu-id="41548-171">**On creating a playlist**</span></span>

<span data-ttu-id="41548-172">После нажатия кнопки "создать список воспроизведения" в меню " **контейнеры** " приложение вызывает локальную функцию \_ онкреатеплайлист, которая выполняет следующие действия:</span><span class="sxs-lookup"><span data-stu-id="41548-172">After clicking "Create Playlist" on the **Containers** menu, the application calls the local function \_OnCreatePlaylist, which performs the following actions:</span></span>

1.  <span data-ttu-id="41548-173">Получение числа выбранных элементов из глобальной переменной Кдевфилес.</span><span class="sxs-lookup"><span data-stu-id="41548-173">Get the number of selected items from the global CDevFiles variable.</span></span>
2.  <span data-ttu-id="41548-174">Вызовите локальную функцию Длгнамеплайлист, чтобы открыть диалоговое окно для получения имени списка воспроизведения.</span><span class="sxs-lookup"><span data-stu-id="41548-174">Call the local function DlgNamePlaylist to open a dialog box to get a name for the playlist.</span></span>
3.  <span data-ttu-id="41548-175">Вызовите метод Кпрогресс:: Create, чтобы создать диалоговое окно, отображающее ход выполнения действия, и задайте параметры для класса Кпрогресс, такие как текст заголовка, диапазон, текущее значение и т. д.</span><span class="sxs-lookup"><span data-stu-id="41548-175">Call the CProgress::Create to create a dialog window showing the progress of the action, and set parameters on the CProgress class, such as the title text, range, current value, and so on.</span></span>
4.  <span data-ttu-id="41548-176">Перебрать все выбранные элементы в объекте представления в виде дерева Кдевфилес и запросите объект Цитемдата, связанный с каждым выбранным файлом в представлении в виде дерева, увеличив диалоговое окно хода выполнения на каждый файл.</span><span class="sxs-lookup"><span data-stu-id="41548-176">Loop through all the selected items in the CDevFiles tree view object, and request the CItemData object associated with each selected file in the tree view, incrementing the progress dialog bar with each file.</span></span> <span data-ttu-id="41548-177">Файлы добавляются в массив интерфейсов [**ивмдмстораже**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmstorage) .</span><span class="sxs-lookup"><span data-stu-id="41548-177">The files are added to an array of [**IWMDMStorage**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmstorage) interfaces.</span></span>
5.  <span data-ttu-id="41548-178">Получить маркер текущего выбранного элемента и запросить его для интерфейса [**IWMDMStorageControl3**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmstoragecontrol3) , который будет использоваться позже для создания нового списка воспроизведения на устройстве.</span><span class="sxs-lookup"><span data-stu-id="41548-178">Get a handle to the currently selected item and query it for an [**IWMDMStorageControl3**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmstoragecontrol3) interface, which will be used later to create the new playlist on the device.</span></span>
6.  <span data-ttu-id="41548-179">Запросите выбранный объект для [**IWMDMStorage3**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmstorage3)и вызовите [**креатимптиметадатаобжект**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmstorage3-createemptymetadataobject) , чтобы создать новый интерфейс [**ивмдмметадата**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmmetadata).</span><span class="sxs-lookup"><span data-stu-id="41548-179">Query the selected object for [**IWMDMStorage3**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmstorage3), and call [**CreateEmptyMetadataObject**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmstorage3-createemptymetadataobject) to create a new [**IWMDMMetaData**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmmetadata)interface.</span></span>
7.  <span data-ttu-id="41548-180">Добавьте \_ \_ код формата вмдм форматкоде абстрактаудиовидеоплайлист в новый интерфейс **ивмдмметадата** и создайте список воспроизведения на устройстве, вызвав [**IWMDMStorageControl3:: Insert3**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmstoragecontrol3-insert3), передав интерфейс метаданных.</span><span class="sxs-lookup"><span data-stu-id="41548-180">Add the WMDM\_FORMATCODE\_ABSTRACTAUDIOVIDEOPLAYLIST format code to the new **IWMDMMetadata** interface and create a playlist on the device by calling [**IWMDMStorageControl3::Insert3**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmstoragecontrol3-insert3), passing in the metadata interface.</span></span> <span data-ttu-id="41548-181">Метод получает указатель на новый **ивмдмстораже** на устройстве.</span><span class="sxs-lookup"><span data-stu-id="41548-181">The method retrieves a pointer to the new **IWMDMStorage** on the device.</span></span>
8.  <span data-ttu-id="41548-182">Заполните список воспроизведения, запросив новое хранилище для [**IWMDMStorage4**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmstorage4)и вызвав [**IWMDMStorage4:: сетреференцес**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmstorage4-setreferences), передав массив **ивмдмстораженых** указателей, собранных на шаге 4.</span><span class="sxs-lookup"><span data-stu-id="41548-182">Fill the playlist by querying the new storage for [**IWMDMStorage4**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmstorage4), and calling [**IWMDMStorage4::SetReferences**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmstorage4-setreferences), passing in the array of **IWMDMStorage** pointers collected in step 4.</span></span>
9.  <span data-ttu-id="41548-183">Наконец, создайте новый объект Цитемдата для хранения нового списка воспроизведения на устройстве, инициализируйте его с новым хранилищем и вызовите Кдевфилес:: AddItem, чтобы добавить его в область Кдевфилес.</span><span class="sxs-lookup"><span data-stu-id="41548-183">Finally, create a new CItemData object to hold the new playlist on the device, initialize it with the new storage, and call CDevFiles::AddItem to add it to the CDevFiles pane.</span></span>

## <a name="related-topics"></a><span data-ttu-id="41548-184">См. также</span><span class="sxs-lookup"><span data-stu-id="41548-184">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="41548-185">**Пример классического приложения**</span><span class="sxs-lookup"><span data-stu-id="41548-185">**Sample Desktop Application**</span></span>](sample-desktop-application.md)
</dt> </dl>

 

 




