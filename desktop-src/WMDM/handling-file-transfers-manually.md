---
title: Обработка передачи файлов вручную
description: Обработка передачи файлов вручную
ms.assetid: ff94191b-a0f2-4118-996c-d040f214fb9b
keywords:
- Диспетчер устройств Windows Media, ручная передача файлов
- Диспетчер устройств, ручная передача файлов
- Руководство по программированию, передача файлов вручную
- Классические приложения, ручная передача файлов
- Создание приложений диспетчер устройств Windows Media, ручная передача файлов
- ручная передача файлов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a2bf12404e8cd83b6f0c0e4f1c8ec8b0b7bda205
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "103792853"
---
# <a name="handling-file-transfers-manually"></a><span data-ttu-id="9f4ee-109">Обработка передачи файлов вручную</span><span class="sxs-lookup"><span data-stu-id="9f4ee-109">Handling File Transfers Manually</span></span>

<span data-ttu-id="9f4ee-110">Приложение может реализовать интерфейс [**ивмдмоператион**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmoperation) для управления частью процесса чтения или записи.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-110">Your application can implement the [**IWMDMOperation**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmoperation) interface to manage part of the reading or writing process.</span></span> <span data-ttu-id="9f4ee-111">При чтении с устройства реализация позволяет приложению принимать блоки необработанных данных из файла устройства.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-111">On a read from device, the implementation enables the application to receive blocks of raw data from a device file.</span></span> <span data-ttu-id="9f4ee-112">При записи на устройство оно позволяет приложению отсылать блоки необработанных данных в файл на устройстве.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-112">On a write to device, it enables the application to send blocks of raw data to a file on the device.</span></span>

<span data-ttu-id="9f4ee-113">В операциях чтения и записи метод [**ивмдмоператион:: трансферобжектдата**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) передает данные между компьютером и устройством.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-113">In both read and write operations, the [**IWMDMOperation::TransferObjectData**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) method passes the data between the computer and the device.</span></span> <span data-ttu-id="9f4ee-114">Чтобы определить направление передачи данных, приложение должно установить флаг, когда Windows Media диспетчер устройств вызывает [**BeginRead**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginread) или [**BeginWrite**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginwrite).</span><span class="sxs-lookup"><span data-stu-id="9f4ee-114">To know the direction of the data transfer, your application must set a flag when Windows Media Device Manager calls [**BeginRead**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginread) or [**BeginWrite**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginwrite).</span></span> <span data-ttu-id="9f4ee-115">При вызове метода [**End**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) приложение должно сбросить этот флаг.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-115">When the [**End**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) method is called, the application should reset this flag.</span></span>

> [!Note]  
> <span data-ttu-id="9f4ee-116">Если поставщик услуг и устройство правильно реализуют [**IMDSPObject2**](/windows/desktop/api/mswmdm/nn-mswmdm-imdspobject2), сначала будет вызван метод [IWMDMOperation3:: трансферобжектдатаонклеарчаннел](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation3-transferobjectdataonclearchannel) приложения, если он реализован.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-116">If the service provider and device properly implement [**IMDSPObject2**](/windows/desktop/api/mswmdm/nn-mswmdm-imdspobject2), it will first call the application's [IWMDMOperation3::TransferObjectDataOnClearChannel](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation3-transferobjectdataonclearchannel) method, if implemented.</span></span> <span data-ttu-id="9f4ee-117">Этот метод является более эффективным способом передачи данных.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-117">This method is a more efficient way of transferring data.</span></span> <span data-ttu-id="9f4ee-118">**Трансферобжектдатаонклеарчаннел** обрабатывается так же, как **трансферобжектдата**, за исключением того, что данные никогда не шифруются и не имеют значений Mac для проверки.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-118">**TransferObjectDataOnClearChannel** is handled the same way as **TransferObjectData**, except that the data is never encrypted and has no MAC values to verify.</span></span>

 

<span data-ttu-id="9f4ee-119">В следующих разделах описывается процесс чтения и записи, когда приложение реализует **ивмдмоператион**.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-119">The following sections describe both the reading and the writing process, when your application implements **IWMDMOperation**.</span></span>

<span data-ttu-id="9f4ee-120">**Чтение с устройства**</span><span class="sxs-lookup"><span data-stu-id="9f4ee-120">**Reading from a device**</span></span>

<span data-ttu-id="9f4ee-121">При чтении файла с устройства Windows Media диспетчер устройств вызывает следующие методы **ивмдмоператион** по порядку:</span><span class="sxs-lookup"><span data-stu-id="9f4ee-121">When reading a file from a device, Windows Media Device Manager calls the following **IWMDMOperation** methods in order:</span></span>

-   <span data-ttu-id="9f4ee-122">[**BeginRead**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginread) Вызывается для уведомления приложения о начале чтения с устройства.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-122">[**BeginRead**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginread) Called to notify the application that a read from device is beginning.</span></span>
-   <span data-ttu-id="9f4ee-123">[**Трансферобжектдата**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) Вызывается один или несколько раз.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-123">[**TransferObjectData**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) Called one or more times.</span></span> <span data-ttu-id="9f4ee-124">Обработка данных описывается в следующих шагах.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-124">The processing of data is described in the following steps:</span></span>
    1.  <span data-ttu-id="9f4ee-125">**Трансферобжектдата** получает буфер, *PData*, размер *пдвсизе* байт, заполненный данными и Mac для проверки входящих данных.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-125">**TransferObjectData** receives a buffer, *pData*, of size *pdwSize* bytes, filled with data, and a MAC to verify the incoming data.</span></span>
    2.  <span data-ttu-id="9f4ee-126">Приложение проверяет входящие параметры с помощью MAC-адреса входящих данных.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-126">The application verifies the incoming parameters with the incoming data MAC.</span></span>
    3.  <span data-ttu-id="9f4ee-127">Приложение расшифровывает и считывает большую часть данных в *pData* , как это возможно, и изменяет возвращаемое значение *пдвсизе* , чтобы указать, сколько байтов было фактически считано.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-127">The application decrypts and reads as much of the data in *pData* as it can, and modifies the returned value of *pdwSize* to indicate how many bytes were actually read.</span></span>
    4.  <span data-ttu-id="9f4ee-128">Приложение расшифровывает данные с помощью [**ксекуречаннелклиент::D екриптпарам**](/previous-versions/bb231586(v=vs.85)), сохраняет их или использует при необходимости.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-128">The application decrypts the data, using [**CSecureChannelClient::DecryptParam**](/previous-versions/bb231586(v=vs.85)), and stores it or uses it, as needed.</span></span>
    5.  <span data-ttu-id="9f4ee-129">**Трансферобжектдата** возвращает S \_ ОК.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-129">**TransferObjectData** returns S\_OK.</span></span>
    6.  <span data-ttu-id="9f4ee-130">Windows Media диспетчер устройств по-своему вызывает **трансферобжектдата** до тех пор, пока приложение не прочитает все данные из файла, или приложение возвращает вмдм \_ E \_ \_ отменено для отмены операции (в этом случае чтение отменяется, а Windows Media Диспетчер устройств вызывает **End**).</span><span class="sxs-lookup"><span data-stu-id="9f4ee-130">Windows Media Device Manager continues to call **TransferObjectData** until the application has read all the data from the file, or the application returns WMDM\_E\_USER\_CANCELLED to cancel the operation (in which case the read is canceled, and Windows Media Device Manager calls **End**).</span></span>
-   <span data-ttu-id="9f4ee-131">[**Конец**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) Вызывается для уведомления приложения о завершении чтения с устройства.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-131">[**End**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) Called to notify the application that a read from device is ending.</span></span>

<span data-ttu-id="9f4ee-132">**Запись на устройство**</span><span class="sxs-lookup"><span data-stu-id="9f4ee-132">**Writing to a device**</span></span>

<span data-ttu-id="9f4ee-133">При записи файла на устройство Windows Media диспетчер устройств вызывает следующие методы **ивмдмоператион** по порядку:</span><span class="sxs-lookup"><span data-stu-id="9f4ee-133">When writing a file to the device, Windows Media Device Manager calls the following **IWMDMOperation** methods in order:</span></span>

-   <span data-ttu-id="9f4ee-134">[**Жетобжектнаме**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjectname) Вызывается, чтобы разрешить приложению указывать имя нового хранилища.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-134">[**GetObjectName**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjectname) Called to allow the application to specify a name for the new storage.</span></span> <span data-ttu-id="9f4ee-135">Этот метод вызывается только в том случае, если приложение не указало имя в методе **INSERT** .</span><span class="sxs-lookup"><span data-stu-id="9f4ee-135">This method is only called if the application did not specify a name in the **Insert** method.</span></span>
-   <span data-ttu-id="9f4ee-136">[**Жетобжектаттрибутес**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjectattributes) Вызывается, чтобы разрешить приложению указывать атрибуты для нового хранилища на устройстве.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-136">[**GetObjectAttributes**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjectattributes) Called to allow the application to specify attributes for the new storage on the device.</span></span>
-   <span data-ttu-id="9f4ee-137">[**BeginWrite**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginwrite) Вызывается для уведомления о начале записи на устройство.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-137">[**BeginWrite**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginwrite) Called to notify that that a write to device is beginning.</span></span>
-   <span data-ttu-id="9f4ee-138">[**Жетобжекттоталсизе**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjecttotalsize) Вызывается для получения общего размера объекта, записываемого на устройство, для обеспечения оптимизации передачи, а также для предоставления Windows Media диспетчер устройств возможность отмены передачи, если файл слишком велик для устройства.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-138">[**GetObjectTotalSize**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjecttotalsize) Called to retrieve the total size of the object being written to the device, to enable optimization of the transfer, and also to give Windows Media Device Manager an opportunity to cancel the transfer if the file is too large for the device.</span></span>
-   <span data-ttu-id="9f4ee-139">[**Трансферобжектдата**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) Вызывается один или несколько раз.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-139">[**TransferObjectData**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) Called one or more times.</span></span> <span data-ttu-id="9f4ee-140">Обработка данных описывается в следующих шагах.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-140">The processing of data is described in the following steps:</span></span>
    1.  <span data-ttu-id="9f4ee-141">**Трансферобжектдата** получает указатель на буфер размера *пдвсизе* байт.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-141">**TransferObjectData** receives a pointer to a buffer of size *pdwSize* bytes.</span></span>
    2.  <span data-ttu-id="9f4ee-142">Приложение получает блок данных для отправки на устройство, обычно путем считывания данных из файла и заполняет полученный буфер размером до *пдвсизе* байт.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-142">The application gets a block of data to send to the device, usually by reading data from a file, and fills the received buffer with up to *pdwSize* bytes.</span></span> <span data-ttu-id="9f4ee-143">Он должен изменить *пдвсизе* (при необходимости), чтобы отобразить количество байтов, добавленных в буфер.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-143">It should modify *pdwSize* (if necessary) to reflect how many bytes were added to the buffer.</span></span>
    3.  <span data-ttu-id="9f4ee-144">Приложение создает MAC для всех параметров метода.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-144">The application creates a MAC of all the method parameters.</span></span>
    4.  <span data-ttu-id="9f4ee-145">Приложение шифрует данные в буфере с помощью [**ксекуречаннелклиент:: енкриптпарам**](/previous-versions/bb231587(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="9f4ee-145">The application encrypts the data in the buffer, using [**CSecureChannelClient::EncryptParam**](/previous-versions/bb231587(v=vs.85)).</span></span>
    5.  <span data-ttu-id="9f4ee-146">**Трансферобжектдата** возвращает " \_ ОК", чтобы указать, что имеется больше данных, или "ложь", \_ чтобы указать, что больше нет данных.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-146">**TransferObjectData** returns S\_OK to indicate that there is more data, or S\_FALSE to indicate that there is no more data.</span></span> <span data-ttu-id="9f4ee-147">Если приложение возвращает ВМДМ \_ \_ \_ отменено пользователем, операция записи отменяется, а диспетчер устройств Windows Media выполнит вызов **End**.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-147">If the application returns WMDM\_E\_USER\_CANCELLED, the write operation is canceled and Windows Media Device Manager will call **End**.</span></span>
    6.  <span data-ttu-id="9f4ee-148">Windows Media диспетчер устройств по мере необходимости вызывает **трансферобжектдата** , пока приложение возвращает значение S \_ ОК.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-148">Windows Media Device Manager continues to call **TransferObjectData** as long as the application returns S\_OK.</span></span>
-   <span data-ttu-id="9f4ee-149">[**Конец**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) Вызывается для уведомления о завершении записи на устройство.</span><span class="sxs-lookup"><span data-stu-id="9f4ee-149">[**End**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) Called to notify that a write to device is ending.</span></span>

<span data-ttu-id="9f4ee-150">Пример кода см. в разделе [Шифрование и расшифровка](encryption-and-decryption.md).</span><span class="sxs-lookup"><span data-stu-id="9f4ee-150">For a code example, see [Encryption and Decryption](encryption-and-decryption.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="9f4ee-151">См. также</span><span class="sxs-lookup"><span data-stu-id="9f4ee-151">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="9f4ee-152">**Создание приложения диспетчер устройств Windows Media**</span><span class="sxs-lookup"><span data-stu-id="9f4ee-152">**Creating a Windows Media Device Manager Application**</span></span>](creating-a-windows-media-device-manager-application.md)
</dt> </dl>

 

 