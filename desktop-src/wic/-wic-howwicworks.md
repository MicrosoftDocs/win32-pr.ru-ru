---
description: Дополнительные сведения о том, как работает компонент Windows Imaging.
ms.assetid: c233e25b-bec6-4e67-8fbf-2bf9b70c7522
title: Принцип работы компонента Windows Imaging
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9bc9fe31ae4346f2c2d1f0b273e78ed10a0ec7e6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103815472"
---
# <a name="how-the-windows-imaging-component-works"></a><span data-ttu-id="0d83b-103">Принцип работы компонента Windows Imaging</span><span class="sxs-lookup"><span data-stu-id="0d83b-103">How the Windows Imaging Component Works</span></span>

<span data-ttu-id="0d83b-104">В этом разделе содержатся следующие подразделы.</span><span class="sxs-lookup"><span data-stu-id="0d83b-104">This topic contains the following sections:</span></span>

-   [<span data-ttu-id="0d83b-105">Обнаружение и арбитраж</span><span class="sxs-lookup"><span data-stu-id="0d83b-105">Discovery and Arbitration</span></span>](#discovery-and-arbitration)
-   [<span data-ttu-id="0d83b-106">Декодирование</span><span class="sxs-lookup"><span data-stu-id="0d83b-106">Decoding</span></span>](#decoding)
-   [<span data-ttu-id="0d83b-107">Кодирование</span><span class="sxs-lookup"><span data-stu-id="0d83b-107">Encoding</span></span>](#encoding)
-   [<span data-ttu-id="0d83b-108">Время существования кодека</span><span class="sxs-lookup"><span data-stu-id="0d83b-108">The Lifetime of a Codec</span></span>](#the-lifetime-of-a-codec)
-   [<span data-ttu-id="0d83b-109">Как WIC поддерживает кодек</span><span class="sxs-lookup"><span data-stu-id="0d83b-109">How to WIC-enabled a Codec</span></span>](#how-to-wic-enabled-a-codec)
-   [<span data-ttu-id="0d83b-110">Поддержка многопоточных подразделений в WIC</span><span class="sxs-lookup"><span data-stu-id="0d83b-110">Multi-Threaded Apartment Support in WIC</span></span>](#multi-threaded-apartment-support-in-wic)
-   [<span data-ttu-id="0d83b-111">См. также</span><span class="sxs-lookup"><span data-stu-id="0d83b-111">Related topics</span></span>](#related-topics)

## <a name="discovery-and-arbitration"></a><span data-ttu-id="0d83b-112">Обнаружение и арбитраж</span><span class="sxs-lookup"><span data-stu-id="0d83b-112">Discovery and Arbitration</span></span>

<span data-ttu-id="0d83b-113">Перед декодированием образа необходимо найти соответствующий кодек, который может декодировать этот формат изображения.</span><span class="sxs-lookup"><span data-stu-id="0d83b-113">Before an image can be decoded, an appropriate codec must be found that can decode that image format.</span></span> <span data-ttu-id="0d83b-114">В большинстве систем, поскольку поддерживаемые форматы изображений жестко запрограммированы, процесс обнаружения не требуется.</span><span class="sxs-lookup"><span data-stu-id="0d83b-114">In most systems, because the supported image formats are hard-coded, no discovery process is required.</span></span> <span data-ttu-id="0d83b-115">Поскольку платформа компонента Windows Imaging Component (WIC) является расширяемой, необходимо иметь возможность определять формат изображения и сопоставлять его с соответствующим кодеком.</span><span class="sxs-lookup"><span data-stu-id="0d83b-115">Because the Windows Imaging Component (WIC) platform is extensible, it’s necessary to be able to identify the format of an image and match it with an appropriate codec.</span></span>

<span data-ttu-id="0d83b-116">Для поддержки обнаружения во время выполнения каждый формат изображения должен иметь идентифицирующий шаблон, который можно использовать для идентификации соответствующего декодера для этого формата.</span><span class="sxs-lookup"><span data-stu-id="0d83b-116">To support run-time discovery, each image format must have an identifying pattern that can be used to identify the appropriate decoder for that format.</span></span> <span data-ttu-id="0d83b-117">(Настоятельно рекомендуется, чтобы для новых форматов файлов использовался идентификатор GUID для идентифицирующего шаблона, так как он гарантированно уникален.) Идентифицирующий шаблон должен быть внедрен в каждый файл изображения, который соответствует этому формату изображения.</span><span class="sxs-lookup"><span data-stu-id="0d83b-117">(It is strongly recommended that, for new file formats, you use a GUID for the identifying pattern, because it is guaranteed to be unique.) The identifying pattern must be embedded in each image file that conforms to that image format.</span></span> <span data-ttu-id="0d83b-118">У каждого декодера есть запись реестра, указывающая шаблон или шаблоны форматов изображений, которые он может декодировать.</span><span class="sxs-lookup"><span data-stu-id="0d83b-118">Each decoder has a registry entry that specifies the identifying pattern or patterns of the image formats it can decode.</span></span> <span data-ttu-id="0d83b-119">Когда приложению необходимо открыть образ, оно запрашивает декодер из WIC.</span><span class="sxs-lookup"><span data-stu-id="0d83b-119">When an application needs to open an image, it requests a decoder from WIC.</span></span> <span data-ttu-id="0d83b-120">Компонент WIC ищет доступные декодеры в реестре и проверяет каждую запись реестра на наличие идентифицирующего шаблона, соответствующего шаблону, внедренному в файл изображения.</span><span class="sxs-lookup"><span data-stu-id="0d83b-120">WIC looks up the available decoders in the registry, and checks each registry entry for an identifying pattern that matches the pattern embedded in the image file.</span></span> <span data-ttu-id="0d83b-121">Дополнительные сведения о записях реестра декодера см. в разделе [записи реестра, относящиеся к кодировщику](-wic-decoderregentries.md) .</span><span class="sxs-lookup"><span data-stu-id="0d83b-121">For more information on decoder registry entries, see [Encoder-Specific Registry Entries](-wic-decoderregentries.md)</span></span>

<span data-ttu-id="0d83b-122">Когда компонент WIC находит один декодер, соответствующий идентифицирующему шаблону в изображении, он создает экземпляр декодера и передает ему файл изображения.</span><span class="sxs-lookup"><span data-stu-id="0d83b-122">When WIC finds a single decoder that matches the identifying pattern in the image, it creates an instance of the decoder and passes the image file to it.</span></span> <span data-ttu-id="0d83b-123">Если компонент WIC находит несколько совпадений, он вызывает метод, именуемый [**куерикапабилити**](/windows/desktop/api/Wincodec/nf-wincodec-iwicbitmapdecoder-querycapability) , для каждого соответствующего декодера, чтобы запрограммировать их и найти лучшее соответствие.</span><span class="sxs-lookup"><span data-stu-id="0d83b-123">If WIC finds more than one match, it invokes a method called [**QueryCapability**](/windows/desktop/api/Wincodec/nf-wincodec-iwicbitmapdecoder-querycapability) on each matching decoder to arbitrate among them and find the best match.</span></span> <span data-ttu-id="0d83b-124">Дополнительные сведения см. в разделе [куерикапабилитиес](-wic-imp-iwicbitmapdecoder.md) в [реализации ивикбитмапдекодер](-wic-imp-iwicbitmapdecoder.md).</span><span class="sxs-lookup"><span data-stu-id="0d83b-124">For more information, see the [QueryCapabilities](-wic-imp-iwicbitmapdecoder.md) section in the [Implementing IWICBitmapDecoder](-wic-imp-iwicbitmapdecoder.md).</span></span>

## <a name="decoding"></a><span data-ttu-id="0d83b-125">Декодирование</span><span class="sxs-lookup"><span data-stu-id="0d83b-125">Decoding</span></span>

<span data-ttu-id="0d83b-126">После выбора и создания экземпляра нужного декодера приложение напрямую обращается к декодеру.</span><span class="sxs-lookup"><span data-stu-id="0d83b-126">After the appropriate decoder has been selected and instantiated, the application talks directly to the decoder.</span></span> <span data-ttu-id="0d83b-127">У декодера есть несколько обязанностей, которые он реализует через различные интерфейсы.</span><span class="sxs-lookup"><span data-stu-id="0d83b-127">The decoder has several responsibilities, which it implements through various interfaces.</span></span> <span data-ttu-id="0d83b-128">Эти службы можно классифицировать следующим образом:</span><span class="sxs-lookup"><span data-stu-id="0d83b-128">These services can be classified as:</span></span>

-   <span data-ttu-id="0d83b-129">Службы уровня контейнера</span><span class="sxs-lookup"><span data-stu-id="0d83b-129">Container-level services</span></span>
-   <span data-ttu-id="0d83b-130">Службы уровня кадров</span><span class="sxs-lookup"><span data-stu-id="0d83b-130">Frame-level services</span></span>
-   <span data-ttu-id="0d83b-131">Службы перечисления метаданных</span><span class="sxs-lookup"><span data-stu-id="0d83b-131">Metadata enumeration services</span></span>
-   <span data-ttu-id="0d83b-132">Встроенные преобразования декодера</span><span class="sxs-lookup"><span data-stu-id="0d83b-132">Native decoder transforms</span></span>
-   <span data-ttu-id="0d83b-133">Уведомления о ходе выполнения и поддержка отмены</span><span class="sxs-lookup"><span data-stu-id="0d83b-133">Progress notifications and cancellation support</span></span>
-   <span data-ttu-id="0d83b-134">Службы обработки RAW</span><span class="sxs-lookup"><span data-stu-id="0d83b-134">Raw processing services</span></span>

<span data-ttu-id="0d83b-135">Службы уровня контейнера включают извлечение эскиза верхнего уровня (если поддерживается), предварительный просмотр, контекст цвета, палитру (если применимо) и формат контейнера, а также предоставление доступа к отдельным кадрам изображений в контейнере.</span><span class="sxs-lookup"><span data-stu-id="0d83b-135">Container-level services include retrieving the top-level thumbnail (if supported), preview, color contexts, palette (if applicable), and container format, as well as providing access to the individual image frames within the container.</span></span> <span data-ttu-id="0d83b-136">(Некоторые контейнеры содержат только один кадр, а другие, например формат TIFF, могут содержать несколько кадров.) Этот набор служб также включает в себя предоставление сведений о самом декодере и его возможностях относительно конкретного файла изображения.</span><span class="sxs-lookup"><span data-stu-id="0d83b-136">(Some containers contain only a single frame while others, such as Tagged Image File Format (TIFF), can contain multiple frames.) This set of services also includes providing information about the decoder itself, and its capabilities with respect to a specific image file.</span></span>

<span data-ttu-id="0d83b-137">Отдельные кадры имеют собственные эскизы, а также могут иметь собственные контексты цвета, палитры и другие свойства, которые предоставляются на уровне фрейма.</span><span class="sxs-lookup"><span data-stu-id="0d83b-137">Individual frames have their own thumbnails, and may also have their own color contexts, palettes, and other properties, which are exposed at the frame level.</span></span> <span data-ttu-id="0d83b-138">Однако наиболее важной операцией, выполняемой на уровне кадров, является фактическое декодирование битов изображения для этого кадра.</span><span class="sxs-lookup"><span data-stu-id="0d83b-138">The most important operation performed at the frame level, though, is the actual decoding of the image bits for that frame.</span></span>

<span data-ttu-id="0d83b-139">WIC предоставляет средства чтения метаданных для наиболее распространенных форматов метаданных (IFD, EXIF, IPTC, XMP, APP0, APP1 и другие форматы), а также поддерживает расширение для форматов метаданных сторонних производителей.</span><span class="sxs-lookup"><span data-stu-id="0d83b-139">WIC provides metadata readers for the most common metadata formats (IFD, EXIF, IPTC, XMP, APP0, APP1, and other formats), and also supports extensibility for third-party metadata formats.</span></span> <span data-ttu-id="0d83b-140">Это освобождает кодек ответственности за синтаксический анализ метаданных.</span><span class="sxs-lookup"><span data-stu-id="0d83b-140">This frees the codec of the responsibility for parsing metadata.</span></span> <span data-ttu-id="0d83b-141">Однако кодек отвечает за перечисление блоков метаданных и запрос модуля чтения метаданных для каждого блока.</span><span class="sxs-lookup"><span data-stu-id="0d83b-141">However, the codec is responsible for enumerating the metadata blocks and requesting a metadata reader for each block.</span></span> <span data-ttu-id="0d83b-142">Компонент WIC выполняет обнаружение обработчиков метаданных так же, как и для кодеков, основываясь на шаблоне в заголовке блока, соответствующем шаблону в записи реестра обработчика метаданных.</span><span class="sxs-lookup"><span data-stu-id="0d83b-142">WIC performs discovery for metadata handlers the same way it does for codecs, based on a pattern in the block header matching a pattern in the metadata handler’s registry entry.</span></span> <span data-ttu-id="0d83b-143">Дополнительные сведения см. в разделе [записи реестра, относящиеся к кодировщику](-wic-decoderregentries.md) .</span><span class="sxs-lookup"><span data-stu-id="0d83b-143">For more information, see the [Encoder-Specific Registry Entries](-wic-decoderregentries.md)</span></span>

<span data-ttu-id="0d83b-144">Декодерам не требуется встроенная поддержка операций преобразования, но это позволяет значительно оптимизировать производительность, обеспечивая более эффективное взаимодействие с конечными пользователями.</span><span class="sxs-lookup"><span data-stu-id="0d83b-144">Decoders are not required to natively support transform operations, but doing so enables significant performance optimizations that provide a better end-user experience.</span></span> <span data-ttu-id="0d83b-145">Например, приложение может создать конвейер различных преобразований (масштабирование, кадрирование, вращение и преобразование формата пикселей) для выполнения на изображении перед отрисовкой изображения.</span><span class="sxs-lookup"><span data-stu-id="0d83b-145">For example, an application can create a pipeline of various transforms (scaling, cropping, rotation, and pixel format conversion) to perform on an image before the image is rendered.</span></span> <span data-ttu-id="0d83b-146">Дополнительные сведения о конвейерах преобразований см. в разделе [IWICBitmapSource](-wic-imp-iwicbitmapsource.md).</span><span class="sxs-lookup"><span data-stu-id="0d83b-146">For more information on transform pipelines, see [IWICBitmapSource](-wic-imp-iwicbitmapsource.md).</span></span> <span data-ttu-id="0d83b-147">После создания конвейера преобразования приложение запрашивает завершающее преобразование в конвейере для создания точечного рисунка, полученного в результате применения всех преобразований к источнику изображения.</span><span class="sxs-lookup"><span data-stu-id="0d83b-147">After creating a transform pipeline, the application requests the final transform in the pipeline to produce the bitmap that results from applying all the transforms to the image source.</span></span> <span data-ttu-id="0d83b-148">На этом этапе, если декодер способен выполнять операции преобразования, компонент WIC запрашивает, какие из запрошенных преобразований он может выполнить.</span><span class="sxs-lookup"><span data-stu-id="0d83b-148">At that point, if the decoder itself is able to perform transform operations, WIC asks which of the requested transforms it can perform.</span></span> <span data-ttu-id="0d83b-149">Все запрошенные преобразования, которые не удается выполнить, будут выполняться компонентом WIC в декодированном изображении перед возвращением вызывающему объекту.</span><span class="sxs-lookup"><span data-stu-id="0d83b-149">Any requested transforms the decoder cannot perform will be performed by WIC on the decoded image before returning it to the caller.</span></span> <span data-ttu-id="0d83b-150">Этот оптимизированный конвейер преобразований обеспечивает лучшую производительность по сравнению с выполнением каждого преобразования последовательно в памяти, особенно в том случае, если во время декодирования может быть выполнено несколько или всех преобразований.</span><span class="sxs-lookup"><span data-stu-id="0d83b-150">This optimized transform pipeline provides better performance than performing each transform sequentially in memory, particularly when some or all of the transforms can be accomplished during the decoding process.</span></span>

<span data-ttu-id="0d83b-151">Уведомления о ходе выполнения и поддержка отмены позволяют приложению запрашивать уведомления о ходе выполнения для длительных операций, а также позволять приложению предоставить пользователю возможность отменить операцию, которая занимает слишком много времени.</span><span class="sxs-lookup"><span data-stu-id="0d83b-151">Progress notifications and cancellation support enable an application to request progress notifications for lengthy operations, and also enable the application to give the user an opportunity to cancel an operation that is taking too long.</span></span> <span data-ttu-id="0d83b-152">Это важно, поскольку если пользователь не может отменить операцию, он может покажется, что процесс завис, и попытаться отменить его, закрыв приложение.</span><span class="sxs-lookup"><span data-stu-id="0d83b-152">This is important because if a user cannot cancel an operation, he or she may feel the process has hung, and try to cancel it by closing the application.</span></span>

<span data-ttu-id="0d83b-153">Эти интерфейсы подробно описаны в разделе [Реализация декодера WIC-Enabled](-wic-implementingwicdecoder.md).</span><span class="sxs-lookup"><span data-stu-id="0d83b-153">These interfaces are described in detail in the section on [Implementing a WIC-Enabled Decoder](-wic-implementingwicdecoder.md).</span></span>

<span data-ttu-id="0d83b-154">Службы обработки необработанных текстов включают в себя настройку параметров камеры, таких как экспозиция, контрастность и резкость, или изменение цветового пространства перед обработкой необработанных битов.</span><span class="sxs-lookup"><span data-stu-id="0d83b-154">Raw processing services include adjusting camera settings, such as exposure, contrast, and sharpening, or changing the color space before processing the raw bits.</span></span>

## <a name="encoding"></a><span data-ttu-id="0d83b-155">Кодирование</span><span class="sxs-lookup"><span data-stu-id="0d83b-155">Encoding</span></span>

<span data-ttu-id="0d83b-156">Как и декодеры, кодировщики имеют ответственность за их реализацию через интерфейсы.</span><span class="sxs-lookup"><span data-stu-id="0d83b-156">Like decoders, encoders have responsibilities that they implement through interfaces.</span></span> <span data-ttu-id="0d83b-157">Службы, предоставляемые кодировщиками, являются дополнением к службам, предоставляемым декодерами, за исключением того, что они записывают данные образа, а не читают их.</span><span class="sxs-lookup"><span data-stu-id="0d83b-157">The services that encoders provide are complementary to the services provided by decoders, except they write out image data rather than reading it.</span></span> <span data-ttu-id="0d83b-158">Кодировщики также предоставляют службы в следующих категориях:</span><span class="sxs-lookup"><span data-stu-id="0d83b-158">Encoders also provide services in the following categories:</span></span>

-   <span data-ttu-id="0d83b-159">Службы уровня контейнера</span><span class="sxs-lookup"><span data-stu-id="0d83b-159">Container-level services</span></span>
-   <span data-ttu-id="0d83b-160">Службы уровня кадров</span><span class="sxs-lookup"><span data-stu-id="0d83b-160">Frame-level services</span></span>
-   <span data-ttu-id="0d83b-161">Перечисление метаданных и службы обновления</span><span class="sxs-lookup"><span data-stu-id="0d83b-161">Metadata enumeration and update services</span></span>
-   <span data-ttu-id="0d83b-162">Поддержка уведомлений о ходе выполнения и отмены</span><span class="sxs-lookup"><span data-stu-id="0d83b-162">Progress notification and cancellation support</span></span>

<span data-ttu-id="0d83b-163">Службы на уровне контейнера для кодировщика включают настройку эскиза верхнего уровня (если поддерживается), предварительный просмотр и палитру (если применимо) и перебор отдельных кадров изображения, чтобы их можно было сериализовать в контейнер.</span><span class="sxs-lookup"><span data-stu-id="0d83b-163">Container-level services for an encoder include setting the top-level thumbnail (if supported), preview, and palette (if applicable), and iterating through the individual image frames so they can be serialized into the container.</span></span>

<span data-ttu-id="0d83b-164">Службы уровня кадров для отражения кодировщика, за исключением того, что они записывают данные изображения, эскиз и любую связанную палитру или другой компонент, а не считывают их.</span><span class="sxs-lookup"><span data-stu-id="0d83b-164">Frame-level services for an encoder mirror those for the decoder, except that they write out the image data, thumbnail, and any associated palette or other component, rather than reading them.</span></span>

<span data-ttu-id="0d83b-165">Кроме того, службы перечисления метаданных для кодировщика включают перебор блоков метаданных для записи и вызов соответствующих средств записи метаданных для сериализации метаданных на диск.</span><span class="sxs-lookup"><span data-stu-id="0d83b-165">Also, metadata enumeration services for an encoder include iterating through the metadata blocks to be written, and invoking the appropriate metadata writers to serialize the metadata to disk.</span></span>

<span data-ttu-id="0d83b-166">Эти интерфейсы подробно описаны в разделе [Реализация кодировщика WIC-Enabled](-wic-implementingwicencoder.md).</span><span class="sxs-lookup"><span data-stu-id="0d83b-166">These interfaces are described in detail in the section on [Implementing a WIC-Enabled Encoder](-wic-implementingwicencoder.md).</span></span>

## <a name="the-lifetime-of-a-codec"></a><span data-ttu-id="0d83b-167">Время существования кодека</span><span class="sxs-lookup"><span data-stu-id="0d83b-167">The Lifetime of a Codec</span></span>

<span data-ttu-id="0d83b-168">Создается экземпляр кодека WIC для обработки одного образа и обычно имеет короткое время существования.</span><span class="sxs-lookup"><span data-stu-id="0d83b-168">A WIC codec is instantiated to handle a single image, and usually has a short lifetime.</span></span> <span data-ttu-id="0d83b-169">Он создается при загрузке изображения и освобождается при закрытии изображения.</span><span class="sxs-lookup"><span data-stu-id="0d83b-169">It’s created when an image is loaded and is released when the image is closed.</span></span> <span data-ttu-id="0d83b-170">Приложение может использовать большое количество кодеков одновременно с перекрывающимися жизненными циклами (Подумайте о прокрутке каталога, содержащего сотни изображений), и несколько приложений могут сделать это одновременно.</span><span class="sxs-lookup"><span data-stu-id="0d83b-170">An application may use a large number of codecs simultaneously with overlapping lifetimes (think of scrolling through a directory containing hundreds of images), and multiple applications may be doing this at the same time.</span></span>

<span data-ttu-id="0d83b-171">Хотя некоторые кодеки имеют жизненный цикл, ограниченный временем существования процесса, в котором они находятся, это не так с кодеками WIC.</span><span class="sxs-lookup"><span data-stu-id="0d83b-171">Although some codecs have a lifetime that is scoped to the lifetime of the process in which they live, this is not the case with WIC codecs.</span></span> <span data-ttu-id="0d83b-172">Фотоальбом Windows Vista, проводник Windows и средство просмотра фотографий, а также многочисленные другие приложения основаны на WIC и будут использовать кодек для вывода изображений и эскизов.</span><span class="sxs-lookup"><span data-stu-id="0d83b-172">The Windows Vista Photo Gallery, Windows Explorer, and Photo Viewer, as well as numerous other applications, are built on WIC and will be using your codec to display images and thumbnails.</span></span> <span data-ttu-id="0d83b-173">Если время жизни кодека ограничено временем существования процесса, каждый раз, когда изображение или эскиз отображались в проводнике Windows Vista, кодек, созданный для декодирования этого изображения, будет оставаться в памяти до следующего момента, когда пользователь перезапускает свой компьютер.</span><span class="sxs-lookup"><span data-stu-id="0d83b-173">If the lifetime of your codec were scoped to the lifetime of the process, every time an image or thumbnail was displayed in the Windows Vista Explorer, the codec instantiated to decode that image would remain in memory until the next time the user restarted his or her computer.</span></span> <span data-ttu-id="0d83b-174">Если кодек никогда не выгружается, его ресурсы, по сути, называются «утечками», поскольку они не могут использоваться любым другим компонентом в системе.</span><span class="sxs-lookup"><span data-stu-id="0d83b-174">If your codec is never unloaded, its resources are, in effect, "leaked" because they can't be used by any other component in the system.</span></span>

## <a name="how-to-wic-enabled-a-codec"></a><span data-ttu-id="0d83b-175">Как WIC поддерживает кодек</span><span class="sxs-lookup"><span data-stu-id="0d83b-175">How to WIC-enabled a Codec</span></span>

1.  <span data-ttu-id="0d83b-176">Реализуйте класс декодера уровня контейнера и класс декодера уровня кадров, который предоставляет необходимые интерфейсы WIC для декодирования изображений и итерации по блокам метаданных.</span><span class="sxs-lookup"><span data-stu-id="0d83b-176">Implement a container-level decoder class and a frame-level decoder class that exposes the required WIC interfaces for decoding images and iterating through blocks of metadata.</span></span> <span data-ttu-id="0d83b-177">Это позволяет всем приложениям на основе WIC взаимодействовать с кодеком так же, как они взаимодействуют с стандартными форматами изображений.</span><span class="sxs-lookup"><span data-stu-id="0d83b-177">This enables all WIC-based applications to interact with your codec the same way they interact with standard image formats.</span></span>
2.  <span data-ttu-id="0d83b-178">Реализуйте класс кодировщика уровня контейнера и класс кодировщика на уровне кадров, который предоставляет необходимые интерфейсы WIC для кодирования изображений и сериализации блоков метаданных в файл изображения.</span><span class="sxs-lookup"><span data-stu-id="0d83b-178">Implement a container-level encoder class and a frame-level encoder class that exposes the required WIC interfaces for encoding images and serializing blocks of metadata into an image file.</span></span>
3.  <span data-ttu-id="0d83b-179">Если ваш формат контейнера не основан на контейнере TIFF или JPEG, может потребоваться написать обработчики метаданных для общих форматов метаданных (EXIF, XMP).</span><span class="sxs-lookup"><span data-stu-id="0d83b-179">If your container format is not based on a TIFF or JPEG container, you may need to write metadata handlers for the common metadata formats (EXIF, XMP).</span></span> <span data-ttu-id="0d83b-180">Однако, если используется формат контейнера на основе TIFF или JPEG, это необязательно, так как можно делегировать обработчики метаданных, предоставляемых системой.</span><span class="sxs-lookup"><span data-stu-id="0d83b-180">However, if you use a TIFF-based or JPEG-based container format, this is not necessary because you can delegate to the system-provided metadata handlers.</span></span>
4.  <span data-ttu-id="0d83b-181">Внедрите уникальный идентифицирующий шаблон (рекомендуется GUID) во всех файлах изображений.</span><span class="sxs-lookup"><span data-stu-id="0d83b-181">Embed a unique identifying pattern (we recommend a GUID) in all your image files.</span></span> <span data-ttu-id="0d83b-182">Это позволяет сопоставить формат изображения с кодеком во время обнаружения.</span><span class="sxs-lookup"><span data-stu-id="0d83b-182">This enables your image format to be matched against your codec during the discovery.</span></span> <span data-ttu-id="0d83b-183">При написании оболочки WIC для существующего формата изображения необходимо найти шаблон битов, который кодировщик всегда записывает в свои файлы изображений, уникальные для этого формата изображений, и использовать его в качестве идентифицирующего шаблона.)</span><span class="sxs-lookup"><span data-stu-id="0d83b-183">If you are writing a WIC wrapper for an existing image format, you must find a pattern of bits that the encoder always writes into its image files that’s unique to that image format, and use this as the identifying pattern.)</span></span>
5.  <span data-ttu-id="0d83b-184">Зарегистрируйте кодек во время установки.</span><span class="sxs-lookup"><span data-stu-id="0d83b-184">Register your codec at installation time.</span></span> <span data-ttu-id="0d83b-185">Это позволяет обнаружить кодек во время выполнения, сопоставляя идентифицирующий шаблон в реестре с шаблоном, внедренным в файл изображения.</span><span class="sxs-lookup"><span data-stu-id="0d83b-185">This enables your codec to be discovered at run time by matching the identifying pattern in the registry with the pattern embedded in the image file.</span></span>
6.  <span data-ttu-id="0d83b-186">Начиная с Windows 7, компонент WIC требует, чтобы кодеки применялись к типу подразделения COM "both".</span><span class="sxs-lookup"><span data-stu-id="0d83b-186">As of Windows 7, WIC requires that codecs be of COM apartment type "Both".</span></span> <span data-ttu-id="0d83b-187">Это означает, что необходимо выполнить соответствующую блокировку для обработки вызывающих объектов и вызывающих потоков в многопоточных сценариях.</span><span class="sxs-lookup"><span data-stu-id="0d83b-187">This means that you must do the appropriate locking to handle cross-apartment callers and callers in multi-threaded scenarios.</span></span> <span data-ttu-id="0d83b-188">Дополнительные сведения см. в следующем разделе о поддержке многопоточного подразделения.</span><span class="sxs-lookup"><span data-stu-id="0d83b-188">For more information, see the next section on multi-threaded apartment support.</span></span>
7.  <span data-ttu-id="0d83b-189">Поддержка 64-разрядных платформ. для Windows 7 компонент WIC потребует, чтобы кодеки сторонних производителей были доставлены как с 32, так и с 64-битным собственным двоичным кодом.</span><span class="sxs-lookup"><span data-stu-id="0d83b-189">Support for 64-bit platforms: For Windows 7, WIC will require that third-party WIC codecs be delivered as both 32-bit and 64-bit native binaries.</span></span> <span data-ttu-id="0d83b-190">Кроме того, 32-разрядная форма должна устанавливаться и работать на 64-разрядных системах, а установщик стороннего производителя Windows 7 должен установить как 32-разрядные, так и 64-разрядные двоичные файлы в 64-разрядных системах.</span><span class="sxs-lookup"><span data-stu-id="0d83b-190">Further, the 32-bit form must install and run on 64-bit systems, and the third party Windows 7 codec installer must install both the 32-bit and 64-bit binaries on 64-bit systems.</span></span>

## <a name="multi-threaded-apartment-support-in-wic"></a><span data-ttu-id="0d83b-191">Поддержка многопоточных подразделений в WIC</span><span class="sxs-lookup"><span data-stu-id="0d83b-191">Multi-Threaded Apartment Support in WIC</span></span>

<span data-ttu-id="0d83b-192">Объекты в многопоточном апартаменте (MTA) могут вызываться параллельно любым числом потоков в MTA.</span><span class="sxs-lookup"><span data-stu-id="0d83b-192">Objects within a Multi-Threaded Apartment (MTA) may be called concurrently by any number of threads within the MTA.</span></span> <span data-ttu-id="0d83b-193">Это обеспечивает лучшую производительность в многоядерных системах и определенных серверных сценариях.</span><span class="sxs-lookup"><span data-stu-id="0d83b-193">This allows for better performance on multi-core systems and certain server scenarios.</span></span> <span data-ttu-id="0d83b-194">Кроме того, кодеки WIC в MTA могут вызывать другие объекты в MTA без затрат на упаковку, связанные с вызовом между потоками в разных апартаментах STA.</span><span class="sxs-lookup"><span data-stu-id="0d83b-194">In addition, WIC codecs in an MTA can call other objects in the MTA without the marshalling cost associated with calling between threads in different STA apartments.</span></span> <span data-ttu-id="0d83b-195">В Windows 7 все встроенные кодеки WIC обновлены для поддержки MTA, включая JPEG, TIFF, PNG, GIF, ICO и BMP.</span><span class="sxs-lookup"><span data-stu-id="0d83b-195">In Windows 7, all in-box WIC codecs have been updated to support MTAs, including JPEG, TIFF, PNG, GIF, ICO, and BMP.</span></span> <span data-ttu-id="0d83b-196">Настоятельно рекомендуется написать сторонние кодеки для поддержки MTA.</span><span class="sxs-lookup"><span data-stu-id="0d83b-196">It is highly recommended that third-party codecs be written to support MTAs.</span></span> <span data-ttu-id="0d83b-197">Сторонние кодеки, которые не поддерживают MTA, приводят к существенным затратам на производительность в многопоточных приложениях из-за упаковки.</span><span class="sxs-lookup"><span data-stu-id="0d83b-197">Third-party codecs that do not to support MTAs cause significant performance costs in multi-threaded applications because of marshaling.</span></span> <span data-ttu-id="0d83b-198">Для включения поддержки агента передачи сообщений требуется, чтобы была реализована правильная синхронизация в кодеке стороннего производителя.</span><span class="sxs-lookup"><span data-stu-id="0d83b-198">Enabling MTA support requires proper synchronization to be implemented in the third-party codec.</span></span> <span data-ttu-id="0d83b-199">Точная реализация этих методов синхронизации выходит за рамки данного документа.</span><span class="sxs-lookup"><span data-stu-id="0d83b-199">Exact implementation of these synchronization techniques is beyond the scope of this paper.</span></span> <span data-ttu-id="0d83b-200">Дополнительные сведения о синхронизации COM-объектов см. в разделе [Основные сведения и использование потоковых моделей COM](/previous-versions/ms809971(v=msdn.10)).</span><span class="sxs-lookup"><span data-stu-id="0d83b-200">For more information on synchronizing COM objects, see [Understanding and Using COM Threading Models](/previous-versions/ms809971(v=msdn.10)).</span></span>

## <a name="related-topics"></a><span data-ttu-id="0d83b-201">См. также</span><span class="sxs-lookup"><span data-stu-id="0d83b-201">Related topics</span></span>

<dl> <dt>

<span data-ttu-id="0d83b-202">**Зрения**</span><span class="sxs-lookup"><span data-stu-id="0d83b-202">**Conceptual**</span></span>
</dt> <dt>

[<span data-ttu-id="0d83b-203">Введение (написание WIC-Enabled КОДЕка)</span><span class="sxs-lookup"><span data-stu-id="0d83b-203">Introduction (How to Write a WIC-Enabled CODEC)</span></span>](-wic-howtowriteacodec-intro.md)
</dt> <dt>

[<span data-ttu-id="0d83b-204">Реализация декодера WIC-Enabled</span><span class="sxs-lookup"><span data-stu-id="0d83b-204">Implementing a WIC-Enabled Decoder</span></span>](-wic-implementingwicdecoder.md)
</dt> <dt>

[<span data-ttu-id="0d83b-205">Написание WIC-Enabled КОДЕка</span><span class="sxs-lookup"><span data-stu-id="0d83b-205">How to Write a WIC-Enabled CODEC</span></span>](-wic-howtowriteacodec.md)
</dt> <dt>

[<span data-ttu-id="0d83b-206">Общие сведения о компоненте создания образов Windows</span><span class="sxs-lookup"><span data-stu-id="0d83b-206">Windows Imaging Component Overview</span></span>](-wic-about-windows-imaging-codec.md)
</dt> <dt>

[<span data-ttu-id="0d83b-207">Общие сведения о метаданных компонента WIC</span><span class="sxs-lookup"><span data-stu-id="0d83b-207">WIC Metadata Overview</span></span>](-wic-about-metadata.md)
</dt> </dl>

 

 



