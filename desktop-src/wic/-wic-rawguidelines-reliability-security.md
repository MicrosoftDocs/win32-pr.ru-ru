---
description: Надежность и безопасность
ms.assetid: 1cbfabce-3d56-4e23-b9a7-02369c67e392
title: Надежность и безопасность
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8a0f0e4a244de2c1463cdadb76162c18b041812b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105684034"
---
# <a name="reliability-and-security"></a><span data-ttu-id="1361f-103">Надежность и безопасность</span><span class="sxs-lookup"><span data-stu-id="1361f-103">Reliability and Security</span></span>

<span data-ttu-id="1361f-104">Поскольку кодеки компонента Windows Imaging Component (WIC) будут вызываться из оболочки Windows и фотоальбома, авторы кодеков должны выполнить все усилия, чтобы обеспечить высокий уровень надежности и безопасности кодеков WIC.</span><span class="sxs-lookup"><span data-stu-id="1361f-104">Because Windows Imaging Component (WIC) codecs will be invoked from within the Windows shell and Photo Gallery, codec authors should make every effort to ensure a high level of reliability and security in their WIC codecs.</span></span>

<span data-ttu-id="1361f-105">Написание надежного кода во многом зависит от оптимальных методов программирования, эффективных проверок кода, тщательного тестирования модулей и тестирования сценариев.</span><span class="sxs-lookup"><span data-stu-id="1361f-105">Writing reliable code largely depends on good coding practices, effective code reviews, and thorough unit testing and scenario testing.</span></span> <span data-ttu-id="1361f-106">Кроме того, следующие рекомендации помогут убедиться, что кодек соответствует политикам Windows Vista в отношении надежности.</span><span class="sxs-lookup"><span data-stu-id="1361f-106">In addition, the following guidelines will help ensure that the codec complies with Windows Vista policies regarding reliability.</span></span>

-   <span data-ttu-id="1361f-107">Включить отмену ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="1361f-107">Enable I/O cancellation.</span></span>

    <span data-ttu-id="1361f-108">Авторы кодека должны предоставить конечному пользователю возможность отмены любой длительной операции.</span><span class="sxs-lookup"><span data-stu-id="1361f-108">Codec authors should provide a way for the end user to cancel any long-running operation.</span></span> <span data-ttu-id="1361f-109">Эти кодеки поддерживаются кодеками WIC путем реализации Ивикбитмаппрогресснотификатион.</span><span class="sxs-lookup"><span data-stu-id="1361f-109">WIC codecs support this by implementing IWICBitmapProgressNotification.</span></span> <span data-ttu-id="1361f-110">Это позволяет вызывающему приложению указать функцию обратного вызова, которая будет вызываться кодеком через определенные интервалы для уведомления вызывающего объекта о ходе выполнения текущей операции.</span><span class="sxs-lookup"><span data-stu-id="1361f-110">This allows a calling application to specify a callback function for the codec to call at specified intervals to notify the caller of the progress of the current operation.</span></span> <span data-ttu-id="1361f-111">Когда приложение возвращает ошибку \_ , отменяемую из функции обратного вызова, кодек должен отменить все выполняющиеся операции и передать HRESULT обратно вызывающему объекту.</span><span class="sxs-lookup"><span data-stu-id="1361f-111">When an application returns ERROR\_CANCELLED from the callback function, the codec must cancel whatever operation is in progress and propagate the HRESULT back to the caller.</span></span> <span data-ttu-id="1361f-112">Это особенно важно для необработанных кодеков, поскольку для декодирования полного необработанного изображения может потребоваться несколько секунд, а приложениям требуется способ отмены этой обработки.</span><span class="sxs-lookup"><span data-stu-id="1361f-112">This is especially important for RAW codecs, because it might take several seconds to decode a full-size RAW image and applications need a way to abort this processing.</span></span>

-   <span data-ttu-id="1361f-113">Убедитесь, что код выполняется в наименьшей области, необходимой для выполнения своей функции.</span><span class="sxs-lookup"><span data-stu-id="1361f-113">Make sure that code runs in the smallest scope that is required to perform its function.</span></span>

    <span data-ttu-id="1361f-114">Авторы кодека должны убедиться, что кодек не потребляет больше ресурсов, чем требуется, или иметь больший объем области, чем требует.</span><span class="sxs-lookup"><span data-stu-id="1361f-114">Codec authors must ensure that the codec does not consume more resources than necessary or have a greater scope than is required.</span></span> <span data-ttu-id="1361f-115">Областью кодеков в WIC является один файл изображения; кодек создается при загрузке файла изображения, а кодек освобождается при закрытии изображения.</span><span class="sxs-lookup"><span data-stu-id="1361f-115">The scope of a codec in WIC is a single image file; the codec is created when an image file is loaded, and the codec is released when the image is closed.</span></span> <span data-ttu-id="1361f-116">Так как компонент WIC является расширяемой платформой на основе компонентов, кодеки WIC будут перекрываться и выгружаться, а также запускаться и останавливаться в рамках одного процесса.</span><span class="sxs-lookup"><span data-stu-id="1361f-116">Because WIC is an extensible component-based platform, WIC codecs will have overlapping loads and unloads, and starts and stops, all within the same process.</span></span> <span data-ttu-id="1361f-117">Если базовая инфраструктура кодека требует, чтобы операции запуска и завершения в области больше одного образа, будет затронуто надежность.</span><span class="sxs-lookup"><span data-stu-id="1361f-117">If the underlying infrastructure of a codec requires start and stop operations at a scope larger than a single image, reliability will be impacted.</span></span> <span data-ttu-id="1361f-118">Программные кодеки с поддержкой WIC будут использоваться проводником Windows, а также другими приложениями.</span><span class="sxs-lookup"><span data-stu-id="1361f-118">WIC-enabled codecs will be used by the Windows Explorer, as well as other applications.</span></span> <span data-ttu-id="1361f-119">Таким образом, если кодек остается загруженным в течение времени существования процесса, память не будет эффективно освобождена, а сбой кодека может зависнуть в проводнике Windows и потенциально требует перезагрузки компьютера.</span><span class="sxs-lookup"><span data-stu-id="1361f-119">Therefore, if a codec remains loaded for the lifetime of the process, memory will not be released efficiently and a failure of the codec could hang Windows Explorer and potentially require the machine to be rebooted.</span></span> <span data-ttu-id="1361f-120">(Рассмотрите, что кодек будет вызываться каждый раз при первом эскизе изображения в проводнике Windows: очень важно, чтобы это была упрощенная операция.)</span><span class="sxs-lookup"><span data-stu-id="1361f-120">(Consider that the codec will be invoked every time an image is thumbnailed for the first time in Windows Explorer: it is essential that this be a lightweight operation.)</span></span>

-   <span data-ttu-id="1361f-121">Используйте средства статического и динамического анализа кода.</span><span class="sxs-lookup"><span data-stu-id="1361f-121">Use static and dynamic code analysis tools.</span></span>

    -   <span data-ttu-id="1361f-122">Средства статического анализа:</span><span class="sxs-lookup"><span data-stu-id="1361f-122">Static analysis tools:</span></span>

        <span data-ttu-id="1361f-123">PREfix — для обнаружения ошибок во время компиляции.</span><span class="sxs-lookup"><span data-stu-id="1361f-123">PREfix - for detecting errors at compile time.</span></span>

        <span data-ttu-id="1361f-124">Предварительная проверка кода на наличие ошибок.</span><span class="sxs-lookup"><span data-stu-id="1361f-124">PREfast - for analyzing code for bugs.</span></span>

    -   <span data-ttu-id="1361f-125">Средства динамического анализа:</span><span class="sxs-lookup"><span data-stu-id="1361f-125">Dynamic analysis tools:</span></span>

        <span data-ttu-id="1361f-126">AppVerifier — позволяет сделать приложения более устойчивыми, имитируя распространенные проблемы с реальными приложениями.</span><span class="sxs-lookup"><span data-stu-id="1361f-126">AppVerifier - which helps make applications more resilient by simulating common real-world software issues.</span></span>

-   <span data-ttu-id="1361f-127">Проверьте все входные данные в проверках кода.</span><span class="sxs-lookup"><span data-stu-id="1361f-127">Verify all inputs in code reviews.</span></span>

    <span data-ttu-id="1361f-128">Все параметры экспортированных методов и всех файловых данных должны быть тщательно проверены на допустимость и надежно отклоняться в случае сбоя, чтобы обеспечить защиту от переполнения буфера и невыполнения, арифметического переполнения, нестрогого потока и непредвиденных типов.</span><span class="sxs-lookup"><span data-stu-id="1361f-128">All parameters for exported methods and all file data must be carefully verified for validity and robustly rejected if faulty, in order to protect against buffer overruns and underruns, arithmetic overflows and underflows, and unexpected types.</span></span>

-   <span data-ttu-id="1361f-129">Используйте методы нечеткого тестирования файлов для обнаружения возможных сбоев и зависаний.</span><span class="sxs-lookup"><span data-stu-id="1361f-129">Use file fuzzing techniques to discover potential crashes and hangs.</span></span>

    <span data-ttu-id="1361f-130">Нечеткое тестирование файлов — это процесс тестирования кодека с произвольными входными переставляются.</span><span class="sxs-lookup"><span data-stu-id="1361f-130">File fuzzing is the process of testing the codec with randomly permuted inputs.</span></span>

    <span data-ttu-id="1361f-131">Существует две формы нечетких файлов: ненаправленный (случайный) нечеткий и направленный нечеткий.</span><span class="sxs-lookup"><span data-stu-id="1361f-131">There are two forms of file fuzzing: undirected (random) fuzzing and directed fuzzing.</span></span> <span data-ttu-id="1361f-132">Непрямое нечеткое преобразование приводит к перенаправлению случайных битов, чтобы увидеть, может ли случайный ввод завершить работу кодека.</span><span class="sxs-lookup"><span data-stu-id="1361f-132">Undirected fuzzing does some random bit flipping to see if random input can crash the codec.</span></span> <span data-ttu-id="1361f-133">При нечетком вводе пермутес входные данные на основе некоторых знаний о формате файла.</span><span class="sxs-lookup"><span data-stu-id="1361f-133">Directed fuzzing permutes the input based on some knowledge of the file format.</span></span> <span data-ttu-id="1361f-134">Например, если имеется проверка избыточности цикла (CRC) в байте со смещением 32, то изменение всех байтов без обновления контрольной суммы, скорее всего, не будет выполнять большую часть кодепасс.</span><span class="sxs-lookup"><span data-stu-id="1361f-134">For example, if there is a cycle redundancy check (CRC) at byte offset 32, then changing any bytes without updating the CRC will likely not exercise most of the codepaths.</span></span> <span data-ttu-id="1361f-135">В этом примере направленный четкий запрос должен исправить CRC при изменении любого байта.</span><span class="sxs-lookup"><span data-stu-id="1361f-135">In this example, a directed fuzzer should fix the CRC when any bytes are modified.</span></span>

    <span data-ttu-id="1361f-136">Входной набор образов для нечетких файлов должен быть создан таким образом, чтобы проверялось каждое сочетание параметров, поддерживаемое декодером.</span><span class="sxs-lookup"><span data-stu-id="1361f-136">The input set of images for file fuzzing should be created so that each parameter combination that the decoder supports is tested.</span></span> <span data-ttu-id="1361f-137">Например, если декодер поддерживает файлы с небольшим и обратным порядком байтов и три параметра сжатия, входной набор изображения должен состоять из файлов с прямым порядком байтов для каждого параметра сжатия и файлов с обратным порядком байтов для каждого параметра сжатия.</span><span class="sxs-lookup"><span data-stu-id="1361f-137">For example, if the decoder supports little- and big-endian files and three compression settings, then the input set of image should consist of little-endian files of each compression setting and big-endian files for each compression setting.</span></span> <span data-ttu-id="1361f-138">Этот подход даст вам большой, но очень надежный набор входных образов для тестирования.</span><span class="sxs-lookup"><span data-stu-id="1361f-138">This approach will yield a large, but very robust set of input images to be tested.</span></span> <span data-ttu-id="1361f-139">Даже если ни одна камера не создает каждое из сочетаний, но декодер поддерживает эти теоретическые сочетания, авторы кодеков должны четко использовать эти входные данные.</span><span class="sxs-lookup"><span data-stu-id="1361f-139">Even if no camera produces each of the combinations but the decoder supports these theoretical combinations, codec authors should fuzz these inputs.</span></span>

    <span data-ttu-id="1361f-140">Безопасность может значительно повыситься за счет регулярного выполнения тестирования методом Монте для файлов изображений во время разработки кодека.</span><span class="sxs-lookup"><span data-stu-id="1361f-140">Security can be greatly enhanced by regularly performing fuzz testing of image files during codec development.</span></span> <span data-ttu-id="1361f-141">Кодеки всегда должны иметь возможность обнаруживать повреждение файла изображения и корректно завершать работу в случае неправильно сформированного запроса или неверно сформированных данных.</span><span class="sxs-lookup"><span data-stu-id="1361f-141">Codecs should always be able to detect image file corruption and fail gracefully in the case of a malformed request or of malformed data.</span></span>

-   <span data-ttu-id="1361f-142">Нагрузить код.</span><span class="sxs-lookup"><span data-stu-id="1361f-142">Stress the code.</span></span>

    <span data-ttu-id="1361f-143">Протестируйте кодек, запустив его непрерывно в нескольких одновременных процессах, выполняя все поддерживаемые операции во всех возможных последовательностях, на изображениях разного размера (включая очень крупные изображения) с каждой поддерживаемой камеры.</span><span class="sxs-lookup"><span data-stu-id="1361f-143">Stress-test the codec by running it continually in multiple simultaneous processes, performing all supported operations in all possible sequences, on images of varying sizes (including very large images) from every supported camera.</span></span>

-   <span data-ttu-id="1361f-144">Безопасность потоков.</span><span class="sxs-lookup"><span data-stu-id="1361f-144">Thread safety.</span></span>

    <span data-ttu-id="1361f-145">Начиная с Windows 7, компонент WIC требует, чтобы необработанные КОДЕки применялись к типу подразделения COM "both".</span><span class="sxs-lookup"><span data-stu-id="1361f-145">As of Windows 7, WIC requires that RAW CODECs be of COM apartment type "Both".</span></span> <span data-ttu-id="1361f-146">Это означает, что необходимо выполнить соответствующую блокировку для обработки вызывающих объектов и вызывающих потоков в многопоточных сценариях.</span><span class="sxs-lookup"><span data-stu-id="1361f-146">This means that you must do the appropriate locking to handle cross-apartment callers and callers in multi-threaded scenarios.</span></span> <span data-ttu-id="1361f-147">Объекты в многопоточном апартаменте (MTA) могут вызываться параллельно любым числом потоков в MTA, что позволяет повысить производительность многоядерных систем и определенных серверных сценариев.</span><span class="sxs-lookup"><span data-stu-id="1361f-147">Objects within an Multi Threaded Apartment (MTA) may be called concurrently by any number of threads within the MTA, allowing for better performance on multi-core systems and certain server scenarios.</span></span> <span data-ttu-id="1361f-148">Кроме того, КОДЕки WIC, которые находятся в агенте передачи сообщений, могут вызывать другие объекты, действующие в MTA, без затрат на упаковку, связанные с вызовом между потоками, которые находятся в разных апартаментах STA.</span><span class="sxs-lookup"><span data-stu-id="1361f-148">In addition, WIC CODECs that live within an MTA can call other objects that live within the MTA without the marshalling cost associated of calling between threads that live in different STA apartments.</span></span> <span data-ttu-id="1361f-149">В Windows 7 все встроенные КОДЕки WIC обновлены для поддержки MTA, включая JPEG, TIFF, PNG, GIF, ICO и BMP.</span><span class="sxs-lookup"><span data-stu-id="1361f-149">In Windows 7, all in-box WIC CODECs have been updated to support MTAs, including JPEG, TIFF, PNG, GIF, ICO, and BMP.</span></span> <span data-ttu-id="1361f-150">сторонние КОДЕки, которые не поддерживают MTA, приводят к значительным затратам на производительность в многопоточных приложениях из-за упаковки.</span><span class="sxs-lookup"><span data-stu-id="1361f-150">3rd-party CODECs that do not to support MTAs will cause significant performance costs in multithreaded applications due to marshaling.</span></span> <span data-ttu-id="1361f-151">Для включения поддержки агента передачи сообщений необходимо, чтобы в коде стороннего производителя была реализована правильная синхронизация.</span><span class="sxs-lookup"><span data-stu-id="1361f-151">Enabling MTA support requires proper synchronization to be implemented in the 3rd-party CODEC.</span></span> <span data-ttu-id="1361f-152">Точная реализация этих методов синхронизации выходит за рамки данного документа.</span><span class="sxs-lookup"><span data-stu-id="1361f-152">Exact implementation of these synchronization techniques is beyond the scope of this paper.</span></span> <span data-ttu-id="1361f-153">Ниже приведен общий справочник по синхронизации COM-объектов.</span><span class="sxs-lookup"><span data-stu-id="1361f-153">A general reference for synchronizing COM objects is provided below.</span></span>

    https://msdn.microsoft.com/library/ms809971.aspx

## <a name="related-topics"></a><span data-ttu-id="1361f-154">См. также</span><span class="sxs-lookup"><span data-stu-id="1361f-154">Related topics</span></span>

<dl> <dt>

<span data-ttu-id="1361f-155">**Зрения**</span><span class="sxs-lookup"><span data-stu-id="1361f-155">**Conceptual**</span></span>
</dt> <dt>

[<span data-ttu-id="1361f-156">Общие сведения о компоненте создания образов Windows</span><span class="sxs-lookup"><span data-stu-id="1361f-156">Windows Imaging Component Overview</span></span>](-wic-about-windows-imaging-codec.md)
</dt> <dt>

[<span data-ttu-id="1361f-157">Рекомендации по WIC для форматов необработанных изображений Camera</span><span class="sxs-lookup"><span data-stu-id="1361f-157">WIC Guidelines for Camera RAW Image Formats</span></span>](-wic-rawguidelines.md)
</dt> <dt>

[<span data-ttu-id="1361f-158">Написание WIC-Enabled КОДЕка</span><span class="sxs-lookup"><span data-stu-id="1361f-158">How to Write a WIC-Enabled CODEC</span></span>](-wic-howtowriteacodec.md)
</dt> </dl>

 

 



