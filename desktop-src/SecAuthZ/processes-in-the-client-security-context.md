---
description: Серверное приложение может вызвать функцию параметр CreateProcessAsUser, чтобы создать новый процесс, выполняемый в контексте безопасности клиентов.
ms.assetid: bd416109-fe76-4d55-bc63-3ebbcf32b92a
title: Процессы в контексте Client Security
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 29c9bafb576bd0d195ae762c69be885ac32f1071
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105650566"
---
# <a name="processes-in-the-client-security-context"></a><span data-ttu-id="ff89c-103">Процессы в контексте Client Security</span><span class="sxs-lookup"><span data-stu-id="ff89c-103">Processes in the Client Security Context</span></span>

<span data-ttu-id="ff89c-104">Серверное приложение может вызвать функцию [**параметр CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) , чтобы создать новый процесс, выполняемый в [*контексте безопасности*](/windows/desktop/SecGloss/s-gly)клиента.</span><span class="sxs-lookup"><span data-stu-id="ff89c-104">A server application can call the [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) function to create a new process that runs in a client's [*security context*](/windows/desktop/SecGloss/s-gly).</span></span> <span data-ttu-id="ff89c-105">При вызове с [*маркером доступа*](/windows/desktop/SecGloss/a-gly)клиента **параметр CreateProcessAsUser** требует \_ привилегий SE ассигнпримаритокен \_ Name и SE \_ увеличить \_ имя квоты \_ , которые хранятся в службах Windows, работающих в [учетной записи LocalSystem](/windows/desktop/Services/localsystem-account).</span><span class="sxs-lookup"><span data-stu-id="ff89c-105">When called with a client's [*access token*](/windows/desktop/SecGloss/a-gly), **CreateProcessAsUser** requires the SE\_ASSIGNPRIMARYTOKEN\_NAME and SE\_INCREASE\_QUOTA\_NAME privileges, which are held by Windows services running in the [LocalSystem Account](/windows/desktop/Services/localsystem-account).</span></span>

<span data-ttu-id="ff89c-106">Для функции [**параметр CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) также требуется [*основной маркер доступа*](/windows/desktop/SecGloss/p-gly).</span><span class="sxs-lookup"><span data-stu-id="ff89c-106">The [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) function also requires a [*primary access token*](/windows/desktop/SecGloss/p-gly).</span></span> <span data-ttu-id="ff89c-107">Сервер может получить основной маркер доступа для клиента либо путем [запуска сеанса входа](client-logon-sessions.md) для клиента, либо путем [олицетворения клиента](client-impersonation.md) и дублирования [*маркера олицетворения*](/windows/desktop/SecGloss/i-gly).</span><span class="sxs-lookup"><span data-stu-id="ff89c-107">A server can get a primary access token for a client either by [starting a logon session](client-logon-sessions.md) for the client or by [impersonating the client](client-impersonation.md) and duplicating the [*impersonation token*](/windows/desktop/SecGloss/i-gly).</span></span>

<span data-ttu-id="ff89c-108">В следующих процедурах описаны два способа создания клиентского процесса.</span><span class="sxs-lookup"><span data-stu-id="ff89c-108">The following procedures describe two ways to create a client process.</span></span>

<span data-ttu-id="ff89c-109">**Создание клиентского процесса путем входа на клиент**</span><span class="sxs-lookup"><span data-stu-id="ff89c-109">**To create a client process by logging on to the client**</span></span>

1.  <span data-ttu-id="ff89c-110">Заносить клиент на локальный компьютер, используя [*учетные данные*](/windows/desktop/SecGloss/c-gly) клиента при вызове функции [**LogonUser**](/windows/desktop/api/winbase/nf-winbase-logonusera).</span><span class="sxs-lookup"><span data-stu-id="ff89c-110">Log the client on to the local computer using the client's [*credentials*](/windows/desktop/SecGloss/c-gly) in a call to [**LogonUser**](/windows/desktop/api/winbase/nf-winbase-logonusera).</span></span> <span data-ttu-id="ff89c-111">**LogonUser** создает основной маркер для [*сеанса входа*](/windows/desktop/SecGloss/l-gly)клиента.</span><span class="sxs-lookup"><span data-stu-id="ff89c-111">**LogonUser** produces a primary token for the client's [*logon session*](/windows/desktop/SecGloss/l-gly).</span></span>
2.  <span data-ttu-id="ff89c-112">Если сервер должен использовать контекст безопасности клиента, получите доступ к исполняемому файлу для клиентского [*процесса*](/windows/desktop/SecGloss/p-gly) с помощью первичного маркера в вызове функции [**имперсонателогжедонусер**](/windows/win32/api/securitybaseapi/nf-securitybaseapi-impersonateloggedonuser) .</span><span class="sxs-lookup"><span data-stu-id="ff89c-112">If the server needs to use the client's security context, get access to the executable file for the client [*process*](/windows/desktop/SecGloss/p-gly) by using the primary token in a call to the [**ImpersonateLoggedOnUser**](/windows/win32/api/securitybaseapi/nf-securitybaseapi-impersonateloggedonuser) function.</span></span>
3.  <span data-ttu-id="ff89c-113">Создайте процесс в контексте безопасности клиента с помощью основного маркера в вызове [**параметр CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera).</span><span class="sxs-lookup"><span data-stu-id="ff89c-113">Create a process in the client's security context by using the primary token in a call to [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera).</span></span>

> [!Note]  
> <span data-ttu-id="ff89c-114">Процесс, созданный с помощью следующего метода, может не иметь доступа к сетевым ресурсам, если он не содержит [*учетные данные*](/windows/desktop/SecGloss/c-gly)клиента.</span><span class="sxs-lookup"><span data-stu-id="ff89c-114">A process created by using the following technique may not be able to access network resources unless it has the client's [*credentials*](/windows/desktop/SecGloss/c-gly).</span></span>

 

<span data-ttu-id="ff89c-115">**Создание клиентского процесса путем олицетворения клиента**</span><span class="sxs-lookup"><span data-stu-id="ff89c-115">**To create a client process by impersonating the client**</span></span>

1.  <span data-ttu-id="ff89c-116">Запустите олицетворение с помощью функции олицетворения, например [**имперсонатенамедпипеклиент**](/windows/win32/api/namedpipeapi/nf-namedpipeapi-impersonatenamedpipeclient).</span><span class="sxs-lookup"><span data-stu-id="ff89c-116">Start the impersonation by using an impersonation function, such as [**ImpersonateNamedPipeClient**](/windows/win32/api/namedpipeapi/nf-namedpipeapi-impersonatenamedpipeclient).</span></span>
2.  <span data-ttu-id="ff89c-117">Вызовите функцию [**опенсреадтокен**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-openthreadtoken) , чтобы получить маркер олицетворения с контекстом безопасности клиента.</span><span class="sxs-lookup"><span data-stu-id="ff89c-117">Call the [**OpenThreadToken**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-openthreadtoken) function to get an impersonation token that has the security context of the client.</span></span>
3.  <span data-ttu-id="ff89c-118">Вызовите функцию [**дупликатетокенекс**](/windows/win32/api/securitybaseapi/nf-securitybaseapi-duplicatetokenex) , чтобы преобразовать токен олицетворения в основной токен.</span><span class="sxs-lookup"><span data-stu-id="ff89c-118">Call the [**DuplicateTokenEx**](/windows/win32/api/securitybaseapi/nf-securitybaseapi-duplicatetokenex) function to convert the impersonation token into a primary token.</span></span>
4.  <span data-ttu-id="ff89c-119">Используйте основной маркер в вызове функции [**параметр CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) , чтобы создать процесс в контексте безопасности клиента.</span><span class="sxs-lookup"><span data-stu-id="ff89c-119">Use the primary token in a call to the [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) function to create a process in the client's security context.</span></span>

<span data-ttu-id="ff89c-120">По умолчанию [**параметр CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) создает клиентский [*процесс*](/windows/desktop/SecGloss/p-gly) на неинтерактивных оконных станциях и настольных системах.</span><span class="sxs-lookup"><span data-stu-id="ff89c-120">By default, [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) creates the client [*process*](/windows/desktop/SecGloss/p-gly) on a noninteractive window station and desktop.</span></span> <span data-ttu-id="ff89c-121">Чтобы создать интерактивный процесс, сервер должен сначала задать [*избирательные списки управления доступом*](/windows/desktop/SecGloss/d-gly) (DACL) для интерактивной рабочей станции и рабочего стола, чтобы убедиться, что клиенту разрешен доступ к ним.</span><span class="sxs-lookup"><span data-stu-id="ff89c-121">To create an interactive process, the server must first set the [*discretionary access control lists*](/windows/desktop/SecGloss/d-gly) (DACLs) of the interactive window station and desktop to ensure that the client is allowed access to them.</span></span> <span data-ttu-id="ff89c-122">Предпочтительным способом сделать это является запись клиента в журнал, [Получение идентификатора безопасности (SID) сеанса входа клиента](/previous-versions//aa446670(v=vs.85)), а затем использование этого идентификатора SID в разрешенных для доступа элементах ACE как на интерактивной рабочей станции, так и на рабочем столе.</span><span class="sxs-lookup"><span data-stu-id="ff89c-122">The preferred way to do this is to log the client on, [get the security identifier (SID) of the client's logon session](/previous-versions//aa446670(v=vs.85)), and then use that SID in access-allowed ACEs on both the interactive window station and desktop.</span></span> <span data-ttu-id="ff89c-123">Затем сервер может вызвать **параметр CreateProcessAsUser**, указав интерактивную станцию окон и настольную winsta0 \\ по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="ff89c-123">The server can then call **CreateProcessAsUser**, specifying the interactive window station and desktop winsta0\\default.</span></span> <span data-ttu-id="ff89c-124">Пример, демонстрирующий эту процедуру, см. [в разделе Запуск интерактивного клиентского процесса на C++](/previous-versions//aa379608(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="ff89c-124">For an example that shows this procedure, see [Starting an Interactive Client Process in C++](/previous-versions//aa379608(v=vs.85)).</span></span>

 

 
