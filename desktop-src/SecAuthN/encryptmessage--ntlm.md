---
description: Шифрует сообщение для обеспечения конфиденциальности с помощью NTLM.
ms.assetid: 852a4624-792d-4f7d-bd3e-5a28692e2ef3
title: Функция Енкриптмессаже (NTLM)
ms.topic: reference
ms.date: 07/25/2019
ms.openlocfilehash: 5c36ce31793a7dc889b6dec40acac7606cc38bf3
ms.sourcegitcommit: 9b5faa61c38b2d0c432b7f2dbee8c127b0e28a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2021
ms.locfileid: "122480810"
---
# <a name="encryptmessage-ntlm-function"></a>Функция Енкриптмессаже (NTLM)

Функция **енкриптмессаже (NTLM)** шифрует сообщение для обеспечения [*конфиденциальности*](../secgloss/p-gly.md). **Енкриптмессаже (NTLM)** позволяет приложению выбирать из [*алгоритмов шифрования*](../secgloss/c-gly.md) , поддерживаемых выбранным механизмом. Функция **енкриптмессаже (NTLM)** использует [*контекст безопасности*](../secgloss/s-gly.md) , на который ссылается маркер контекста. Некоторые пакеты не имеют зашифрованных и не расшифрованных сообщений, а предоставляют [*хэш*](../secgloss/h-gly.md) целостности, который можно проверить.

> [!Note]  
> **Енкриптмессаже (NTLM)** и [**декриптмессаже (NTLM)**](decryptmessage--ntlm.md) могут вызываться одновременно из двух разных потоков в одном контексте SSPI, если [*один поток*](../secgloss/s-gly.md) шифруется, а другой расшифровывается. При шифровании нескольких потоков или при расшифровке более одного потока каждый поток должен получить уникальный контекст.

## <a name="syntax"></a>Синтаксис

```C++
SECURITY_STATUS SEC_Entry EncryptMessage(
  _In_    PCtxtHandle    phContext,
  _In_    ULONG          fQOP,
  _Inout_ PSecBufferDesc pMessage,
  _In_    ULONG          MessageSeqNo
);
```

## <a name="parameters"></a>Параметры

*фконтекст* \[ окне\]

Маркер [*контекста безопасности*](../secgloss/s-gly.md) , который будет использоваться для шифрования сообщения.

*фкоп* \[ окне\]

Зависящие от пакета флаги, указывающие качество защиты. [*Пакет безопасности*](../secgloss/s-gly.md) может использовать этот параметр, чтобы включить выбор [*алгоритмов шифрования*](../secgloss/c-gly.md).

Этот параметр может иметь следующий флаг.


| Значение | Значение | 
|-------|---------|
| <span id="SECQOP_WRAP_NO_ENCRYPT"></span><span id="secqop_wrap_no_encrypt"></span><dl><dt><strong>SECQOP_WRAP_NO_ENCRYPT</strong></dt></dl> | Создать заголовок или трейлер, но не шифровать сообщение.<br /><blockquote>[!Note]<br />KERB_WRAP_NO_ENCRYPT имеет то же значение и то же самое.</blockquote><br /> | 


*пмессаже* \[ в, out\]

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) . На входе структура ссылается на одну или несколько структур [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) , которые могут иметь тип данных pvbuffer \_ . Этот буфер содержит сообщение для шифрования. Сообщение шифруется на месте, перезаписывая исходное содержимое структуры.

Функция не обрабатывает буферы с \_ атрибутом pvbuffer ReadOnly.

Длина структуры [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) , которая содержит сообщение, не должна превышать **кбмаксимуммессаже**, которая получена из функции [**QueryContextAttributes (NTLM)**](querycontextattributes--ntlm.md) ( \_ Размер потока SECPKG attr \_ \_ ).

Приложения, не использующие SSL, должны предоставить [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) типа pvbuffer \_ Padding.

*Мессажесекно* \[ окне\]

Порядковый номер, назначенный сообщению транспортным приложением. Если транспортное приложение не поддерживает порядковые номера, этот параметр должен быть равен нулю.

## <a name="return-value"></a>Возвращаемое значение

Если функция завершается успешно, функция возвращает значение секунды \_ E \_ ОК.

Если функция завершается ошибкой, возвращается один из следующих кодов ошибок.

| Код возврата                         | Описание                                                                                                                          |
|-------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------|
| **\_ \_ \_ слишком \_ маленький буфер E с**      | Выходной буфер слишком мал. Дополнительные сведения см. в подразделе "Примечания".                                                                   |
| **с \_ \_ \_ истекшим сроком действия в контексте E**        | Приложение ссылается на контекст, который уже был закрыт. Правильно написанное приложение не должно получить эту ошибку. |
| **с \_ е \_ . \_ неправильная система шифрования E \_** | [*Шифр*](../secgloss/c-gly.md) , выбранный для [*контекста безопасности*](../secgloss/s-gly.md) , не поддерживается.                                |
| **СЕК \_ . \_ недостаточный \_ объем памяти**    | Недостаточно доступной памяти для завершения запрошенного действия.                                                               |
| **c \_ E \_ Недопустимый \_ маркер**         | В параметре *фконтекст* указан недопустимый маркер контекста.                                                       |
| **в секунду \_ E \_ Недопустимый \_ токен**          | Не \_ найден буфер типа данных pvbuffer.                                                                                            |
| **с \_ е \_ КОП \_ не \_ поддерживается**>    | [*Контекст безопасности*](../secgloss/s-gly.md)не поддерживает ни конфиденциальность, ни [*целостность*](../secgloss/i-gly.md) .             |

## <a name="remarks"></a>Комментарии

Функция **енкриптмессаже (NTLM)** шифрует сообщение на основе сообщения и [*ключа сеанса*](../secgloss/s-gly.md) из [*контекста безопасности*](../secgloss/s-gly.md).

Если приложение транспорта создало [*контекст безопасности*](../secgloss/s-gly.md) для поддержки обнаружения последовательности и вызывающий объект предоставляет порядковый номер, функция включает эти сведения в зашифрованное сообщение. Включение этой информации обеспечивает защиту от воспроизведения, вставки и подавления сообщений. [*Пакет безопасности*](../secgloss/s-gly.md) включает порядковый номер, переданный из транспортного приложения.

> [!Note]  
> Эти буферы должны быть представлены в указанном порядке.

| Тип буфера                | Описание                                                                                 |
|----------------------------|---------------------------------------------------------------------------------------------|
| \_заголовок потока \_ pvbuffer  | Для внутреннего использования. Инициализация не требуется.                                                |
| \_данные pvbuffer            | Содержит зашифрованное сообщение в [*виде открытого текста*](../secgloss/s-gly.md) . |
| \_трейлер потока \_ pvbuffer | Для внутреннего использования. Инициализация не требуется.                                                |
| PVBUFFER \_ пусто           | Для внутреннего использования. Инициализация не требуется. Размер может быть равен нулю.                              |

Для оптимальной производительности структуры *пмессаже* должны выделяться из непрерывной памяти.

**Windows XP:** Эта функция также называлась **сеалмессаже**. Теперь приложения должны использовать только **енкриптмессаже (NTLM)** .

## <a name="requirements"></a>Требования

| Требование | Значение |
| -------------------------|-------------------------------------------|
| Минимальная версия клиента | Windows \[Только классические приложения XP\]          |
| Минимальная версия сервера | Windows Только для \[ настольных приложений сервера 2003\] |
| Заголовок                   | SSPI. h (включая Security. h)               |
| Библиотека                  | Secur32. lib                               |
| DLL                      | Secur32.dll                               |

## <a name="see-also"></a>См. также

- [Функции SSPI](authentication-functions.md#sspi-functions)
- [**AcceptSecurityContext (NTLM)**](acceptsecuritycontext--ntlm.md)
- [**Декриптмессаже (NTLM)**](decryptmessage--ntlm.md)
- [**InitializeSecurityContext (NTLM)**](initializesecuritycontext--ntlm.md)
- [**QueryContextAttributes (NTLM)**](querycontextattributes--ntlm.md)
- [**Pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer)
- [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc)
