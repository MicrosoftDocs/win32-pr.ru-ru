---
description: Шифрует сообщение для обеспечения конфиденциальности с помощью Negotiate.
ms.assetid: b80b3d64-9c0a-4602-9378-1e208f6593fc
title: Функция Енкриптмессаже (Negotiate)
ms.topic: reference
ms.date: 07/25/2019
ms.openlocfilehash: d4aac05a4ad030e72953cc997671b7d348cb2a598a0f56f80963f69847cdf357
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119008312"
---
# <a name="encryptmessage-negotiate-function"></a>Функция Енкриптмессаже (Negotiate)

Функция **енкриптмессаже (Negotiate)** шифрует сообщение для обеспечения [*конфиденциальности*](../secgloss/p-gly.md). **Енкриптмессаже (Negotiate)** позволяет приложению выбирать между [*алгоритмами шифрования*](../secgloss/c-gly.md) , поддерживаемыми выбранным механизмом. Функция **енкриптмессаже (Negotiate)** использует [*контекст безопасности*](../secgloss/s-gly.md) , на который ссылается маркер контекста. Некоторые пакеты не имеют зашифрованных и не расшифрованных сообщений, а предоставляют [*хэш*](../secgloss/h-gly.md) целостности, который можно проверить.

> [!Note]  
> **Енкриптмессаже (Negotiate)** и [**декриптмессаже (Negotiate)**](decryptmessage--negotiate.md) могут быть вызваны одновременно из двух разных потоков в одном контексте SSPI, [*Если один поток*](../secgloss/s-gly.md) шифруется, а другой расшифровывается. При шифровании нескольких потоков или при расшифровке более одного потока каждый поток должен получить уникальный контекст.

## <a name="syntax"></a>Синтаксис

```C++
SECURITY_STATUS SEC_Entry EncryptMessage(
  _In_    PCtxtHandle    phContext,
  _In_    ULONG          fQOP,
  _Inout_ PSecBufferDesc pMessage,
  _In_    ULONG          MessageSeqNo
);
```

## <a name="parameters"></a>Параметры

*фконтекст* \[ в \] маркере [*контекста безопасности*](../secgloss/s-gly.md) , который будет использоваться для шифрования сообщения.

*фкоп* \[ в \] флагах для конкретного пакета, которые указывают качество защиты. [*Пакет безопасности*](../secgloss/s-gly.md) может использовать этот параметр, чтобы включить выбор [*алгоритмов шифрования*](../secgloss/c-gly.md).

Этот параметр может иметь следующий флаг.

| Значение                  | Значение                                                     |
|------------------------|-------------------------------------------------------------|
| SECQOP_WRAP_NO_ENCRYPT | Создать заголовок или трейлер, но не шифровать сообщение. |

> [!NOTE]
> KERB_WRAP_NO_ENCRYPT имеет то же значение и то же самое.

*пмессаже* \[ в \] Выведите указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) . На входе структура ссылается на одну или несколько структур [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) , которые могут иметь тип данных pvbuffer \_ . Этот буфер содержит сообщение для шифрования. Сообщение шифруется на месте, перезаписывая исходное содержимое структуры.

Функция не обрабатывает буферы с \_ атрибутом pvbuffer ReadOnly.

Длина структуры [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) , которая содержит сообщение, не должна превышать **кбмаксимуммессаже**, которая получена из функции [**QueryContextAttributes (Negotiate)**](querycontextattributes--negotiate.md) (SECPKG \_ attr \_ Streams \_ sizes).

Приложения, не использующие SSL, должны предоставить [**pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer) типа pvbuffer \_ Padding.

*Мессажесекно* \[ в \] порядковом номере, назначенном сообщению транспортным приложением. Если транспортное приложение не поддерживает порядковые номера, этот параметр должен быть равен нулю.

## <a name="return-value"></a>Возвращаемое значение

Если функция завершается успешно, функция возвращает значение секунды \_ E \_ ОК.

Если функция завершается ошибкой, возвращается один из следующих кодов ошибок.

| Код возврата                         | Описание                                                                                                                          |
|-------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------|
| **\_ \_ \_ слишком \_ маленький буфер E с**      | Выходной буфер слишком мал. Дополнительные сведения см. в подразделе "Примечания".                                                                   |
| **с \_ \_ \_ истекшим сроком действия в контексте E**        | Приложение ссылается на контекст, который уже был закрыт. Правильно написанное приложение не должно получить эту ошибку. |
| **с \_ е \_ . \_ неправильная система шифрования E \_** | [*Шифр*](../secgloss/c-gly.md) , выбранный для [*контекста безопасности*](../secgloss/s-gly.md) , не поддерживается.                                |
| **СЕК \_ . \_ недостаточный \_ объем памяти**    | Недостаточно доступной памяти для завершения запрошенного действия.                                                               |
| **c \_ E \_ Недопустимый \_ маркер**         | В параметре *фконтекст* указан недопустимый маркер контекста.                                                       |
| **в секунду \_ E \_ Недопустимый \_ токен**          | Не \_ найден буфер типа данных pvbuffer.                                                                                            |
| **с \_ е \_ КОП \_ не \_ поддерживается**     | [*Контекст безопасности*](../secgloss/s-gly.md)не поддерживает ни конфиденциальность, ни [*целостность*](../secgloss/i-gly.md) .             |

## <a name="remarks"></a>Remarks

Функция **енкриптмессаже (Negotiate)** шифрует сообщение на основе сообщения и [*ключа сеанса*](../secgloss/s-gly.md) из [*контекста безопасности*](../secgloss/s-gly.md).

Если приложение транспорта создало [*контекст безопасности*](../secgloss/s-gly.md) для поддержки обнаружения последовательности и вызывающий объект предоставляет порядковый номер, функция включает эти сведения в зашифрованное сообщение. Включение этой информации обеспечивает защиту от воспроизведения, вставки и подавления сообщений. [*Пакет безопасности*](../secgloss/s-gly.md) включает порядковый номер, переданный из транспортного приложения.

> [!Note]  
> Эти буферы должны быть представлены в указанном порядке.

| Тип буфера                | Описание                                                                                 |
|----------------------------|---------------------------------------------------------------------------------------------|
| \_заголовок потока \_ pvbuffer  | Для внутреннего использования. Инициализация не требуется.                                                |
| \_данные pvbuffer            | Содержит зашифрованное сообщение в [*виде открытого текста*](../secgloss/s-gly.md) . |
| \_трейлер потока \_ pvbuffer | Для внутреннего использования. Инициализация не требуется.                                                |
| PVBUFFER \_ пусто           | Для внутреннего использования. Инициализация не требуется. Размер может быть равен нулю.                              |

Для оптимальной производительности структуры *пмессаже* должны выделяться из непрерывной памяти.

**Windows XP:** Эта функция также называлась **сеалмессаже**. Теперь приложения должны использовать только **енкриптмессаже (Negotiate)** .

## <a name="requirements"></a>Требования

| Требование | Значение |
|--------------------------|-------------------------------------------------|
| Минимальная версия клиента | Windows \[Только классические приложения XP\]                |
| Минимальная версия сервера | Windows Только для \[ настольных приложений сервера 2003\]       |
| Заголовок                   | SSPI. h (включая Security. h)                     |
| Библиотека                  | Secur32. lib                                     |
| DLL                      | Secur32.dll                                     |

## <a name="see-also"></a>См. также раздел

- [Функции SSPI](authentication-functions.md#sspi-functions)
- [**AcceptSecurityContext (согласование)**](acceptsecuritycontext--negotiate.md)
- [**Декриптмессаже (согласование)**](decryptmessage--negotiate.md)
- [**InitializeSecurityContext (согласование)**](initializesecuritycontext--negotiate.md)
- [**QueryContextAttributes (согласование)**](querycontextattributes--negotiate.md)
- [**Pvbuffer**](/windows/win32/api/sspi/ns-sspi-secbuffer)
- [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc)
