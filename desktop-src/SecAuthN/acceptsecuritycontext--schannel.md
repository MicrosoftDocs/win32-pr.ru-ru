---
description: Позволяет компоненту сервера транспортного приложения устанавливать [*контекст безопасности*](../secgloss/s-gly.md) между сервером и удаленным клиентом, использующим SChannel.
ms.assetid: 03fd5272-8476-4c93-8590-0d00acf6a130
title: Функция AcceptSecurityContext (Schannel) (SSPI. h)
ms.topic: reference
ms.date: 07/25/2019
ms.openlocfilehash: ba353cfbe64d6471230a720680301ebab0da511a
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105719537"
---
# <a name="acceptsecuritycontext-schannel-function"></a>Функция AcceptSecurityContext (Schannel)

Функция **AcceptSecurityContext (Schannel)** позволяет компоненту сервера транспортного приложения устанавливать [*контекст безопасности*](../secgloss/s-gly.md) между сервером и удаленным клиентом. Удаленный клиент использует функцию [**InitializeSecurityContext (Schannel)**](initializesecuritycontext--schannel.md) для запуска процесса установки [*контекста безопасности*](../secgloss/s-gly.md). Серверу может потребоваться один или несколько маркеров ответа от удаленного клиента для завершения установки [*контекста безопасности*](../secgloss/s-gly.md).

## <a name="syntax"></a>Синтаксис


```C++
SECURITY_STATUS SEC_Entry AcceptSecurityContext(
  _In_opt_    PCredHandle    phCredential,
  _Inout_opt_ PCtxtHandle    phContext,
  _In_opt_    PSecBufferDesc pInput,
  _In_        ULONG          fContextReq,
  _In_        ULONG          TargetDataRep,
  _Inout_opt_ PCtxtHandle    phNewContext,
  _Inout_opt_ PSecBufferDesc pOutput,
  _Out_       PULONG         pfContextAttr,
  _Out_opt_   PTimeStamp     ptsTimeStamp
);
```



## <a name="parameters"></a>Параметры

<dl> <dt>

*фкредентиал* \[ в необязательное\]
</dt> <dd>

Маркер учетных данных сервера. Сервер вызывает функцию [**AcquireCredentialsHandle (Schannel)**](acquirecredentialshandle--schannel.md) с \_ \_ флагом SECPKG CRED Inbound или SECPKG CRED, \_ \_ установленным для получения этого маркера.

</dd> <dt>

*фконтекст* \[ в, out, необязательно\]
</dt> <dd>

Указатель на структуру [кткссандле](sspi-handles.md) . При первом вызове **AcceptSecurityContext (Schannel)** этот указатель имеет **значение NULL**. При последующих вызовах *фконтекст* — это описатель частично сформированного контекста, который был возвращен в параметре *фневконтекст* при первом вызове.

</dd> <dt>

*пинпут* \[ в необязательное\]
</dt> <dd>

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) , созданную клиентским вызовом к [**InitializeSecurityContext (Schannel)**](initializesecuritycontext--schannel.md) , который содержит дескриптор входного буфера.

При использовании [*поставщика поддержки безопасности*](../secgloss/s-gly.md) (SSP) SChannel первый буфер должен иметь тип pvbuffer \_ Token и содержать маркер безопасности, полученный от клиента. Второй буфер должен иметь тип PVBUFFER \_ Empty.

</dd> <dt>

*фконтекстрек* \[ окне\]
</dt> <dd>

Битовые флаги, указывающие атрибуты, необходимые серверу для установки контекста. Битовые флаги можно комбинировать с помощью операций побитового **или** . Этот параметр может принимать одно или несколько следующих значений.



| Значение                                                                                                                                                                                         | Значение                                                                                                                                                                                                 |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span id="ASC_REQ_ALLOCATE_MEMORY"></span><span id="asc_req_allocate_memory"></span><dl> <dt>**по УБЫВАНИЮ \_ требований \_ выделить \_ память**</dt> </dl> | Digest и SChannel будут выделять выходные буферы. Завершив использование выходных буферов, освободите их, вызвав функцию [**фриконтекстбуффер**](/windows/win32/api/sspi/nf-sspi-freecontextbuffer) .<br/> |
| <span id="ASC_REQ_CONFIDENTIALITY"></span><span id="asc_req_confidentiality"></span><dl> <dt>**конфиденциальность по УБЫВАНИЮ \_ требований \_**</dt> </dl>  | Шифрование и расшифровка сообщений.<br/> Хэш-код дайджеста поддерживает этот флаг только для SASL.<br/>                                                                                                    |
| <span id="ASC_REQ_CONNECTION"></span><span id="asc_req_connection"></span><dl> <dt>**\_Подключение ASC req \_**</dt> </dl>                 | [*Контекст безопасности*](../secgloss/s-gly.md) не будет работать с сообщениями форматирования.<br/>                                                                                                                                    |
| <span id="ASC_REQ_EXTENDED_ERROR"></span><span id="asc_req_extended_error"></span><dl> <dt>**\_ \_ Расширенная ошибка по убыванию требований \_**</dt> </dl>    | При возникновении ошибок удаленная сторона будет уведомлена.<br/>                                                                                                                                        |
| <span id="ASC_REQ_MUTUAL_AUTH"></span><span id="asc_req_mutual_auth"></span><dl> <dt>**\_ \_ взаимная \_ Проверка подлинности по убыванию требований**</dt> </dl>             | Клиент должен предоставить сертификат, который будет использоваться для проверки подлинности клиента.<br/>                                                                                                         |
| <span id="ASC_REQ_REPLAY_DETECT"></span><span id="asc_req_replay_detect"></span><dl> <dt>**Обнаружение повторного \_ воспроизведения требований ASC \_ \_**</dt> </dl>       | Обнаружение воспроизводимых пакетов.<br/>                                                                                                                                                                     |
| <span id="ASC_REQ_SEQUENCE_DETECT"></span><span id="asc_req_sequence_detect"></span><dl> <dt>**\_ \_ Обнаружение последовательности "ASC req" \_**</dt> </dl> | Обнаружение сообщений, полученных за пределами последовательности.<br/>                                                                                                                                                    |
| <span id="ASC_REQ_STREAM"></span><span id="asc_req_stream"></span><dl> <dt>**\_поток требований \_ ASC**</dt> </dl>                             | Поддерживать соединение с потоковой ориентацией.<br/> Этот флаг поддерживается только SChannel.<br/>                                                                                                    |



 

Возможные флаги атрибутов и их значения см. в разделе [требования к контексту](context-requirements.md). Флаги, используемые для этого параметра, имеют префикс ASC \_ req, например, ASC \_ req \_ Delegate.

Запрошенные атрибуты могут не поддерживаться клиентом. Дополнительные сведения см. в описании параметра *пфконтекстаттр* .

</dd> <dt>

*Таржетдатареп* \[ окне\]
</dt> <dd>

Этот параметр не используется с SChannel. Укажите ноль для этого параметра.

</dd> <dt>

*фневконтекст* \[ в, out, необязательно\]
</dt> <dd>

Указатель на структуру [кткссандле](sspi-handles.md) . При первом вызове **AcceptSecurityContext (Schannel)** этот указатель получает новый обработчик контекста. При последующих вызовах *фневконтекст* может совпадать с маркером, указанным в параметре *фконтекст* .

</dd> <dt>

*паутпут* \[ в, out, необязательно\]
</dt> <dd>

Указатель на структуру [**секбуффердеск**](/windows/win32/api/sspi/ns-sspi-secbufferdesc) , содержащую дескриптор выходного буфера. Этот буфер отправляется клиенту для ввода в дополнительные вызовы [**InitializeSecurityContext (Schannel)**](initializesecuritycontext--schannel.md). Выходной буфер может быть создан, даже если функция возвращает значение в СЕКУНДах \_ \_ . Любой созданный буфер должен быть отправлен обратно клиентскому приложению.

На выходе этот буфер получает маркер для [*контекста безопасности*](../secgloss/s-gly.md). Маркер должен быть отправлен клиенту. Функция также может возвращать буфер типа PVBUFFER " \_ дополнительный". Кроме того, вызывающий объект должен передать в буфер типа **\_ Alert pvbuffer**. В выходных данных, если создается предупреждение, этот буфер содержит сведения об этом предупреждении, и функция завершается ошибкой.

</dd> <dt>

*пфконтекстаттр* \[ заполняет\]
</dt> <dd>

Указатель на переменную, которая получает набор битовых флагов, указывающих атрибуты установленного контекста. Описание различных атрибутов см. в разделе [требования к контексту](context-requirements.md). Флаги, используемые для этого параметра, имеют префикс ASC \_ RET, например, ASC \_ RET \_ Delegate.

Не проверяйте атрибуты, связанные с безопасностью, до тех пор, пока завершающий вызов функции не вернется успешно. Флаги атрибутов, не связанные с безопасностью, такие как \_ \_ флаг ASC \_ , выделенная память, можно проверить перед окончательным возвратом.

</dd> <dt>

*птстиместамп* \[ out, необязательно\]
</dt> <dd>

Указатель на структуру [**метки времени**](timestamp.md) , которая получает время окончания срока действия контекста. Рекомендуется, чтобы [*пакет безопасности*](../secgloss/s-gly.md) всегда возвращал это значение в местное время.

Это необязательно при использовании поставщика общих служб SChannel. Когда удаленная сторона предоставил сертификат, который будет использоваться для проверки подлинности, этот параметр получает срок действия этого сертификата. Если сертификат не был указан, возвращается максимальное значение времени.

> [!Note]  
> До последнего вызова процесса проверки подлинности время истечения срока действия контекста может быть неправильным, поскольку на последующих этапах согласования будут предоставлены дополнительные сведения. Таким образом, *птстиместамп* должен иметь **значение NULL** до последнего вызова функции.

 

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Эта функция возвращает одно из следующих значений.



<table><colgroup><col style="width: 50%" /><col style="width: 50%" /></colgroup><thead><tr class="header"><th>Возвращаемый код и значение</th><th>Описание</th></tr></thead><tbody><tr class="odd"><td><dl> <dt><strong>SEC_E_INCOMPLETE_MESSAGE</strong></dt> <dt>0x80090318L</dt> </dl></td><td>Функция выполнена успешно. Данные во входном буфере неполны. Приложение должно считывать дополнительные данные из клиента и повторно вызывать [<strong>AcceptSecurityContext (Schannel)</strong>] (AcceptSecurityContext--SChannel.md).<br/> При возвращении этого значения буфер <em>пинпут</em> содержит структуру [<strong>pvbuffer</strong>] (/Windows/Win32/API/SSPI/NS-SSPI-secbuffer) с членом <strong>буффертипе</strong> <strong>SECBUFFER_MISSING</strong>. Элемент <strong>кббуффер</strong> объекта <strong>pvbuffer</strong> содержит значение, указывающее число дополнительных байтов, которое функция должна считывать с клиента перед тем, как эта функция будет выполнена. Хотя это число не всегда точнее, его использование может повысить производительность за счет предотвращения нескольких вызовов этой функции.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_E_INSUFFICIENT_MEMORY</strong></dt> <dt>0x80090300L</dt> </dl></td><td>Ошибка при выполнении функции. Недостаточно доступной памяти для завершения запрошенного действия.<br/></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_E_INTERNAL_ERROR</strong></dt> <dt>0x80090304L</dt> </dl></td><td>Ошибка при выполнении функции. Произошла ошибка, которая не сопоставлена с кодом ошибки SSPI.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_E_INVALID_HANDLE</strong></dt> <dt>0x80100003L</dt> </dl></td><td>Ошибка при выполнении функции. В функцию передан недопустимый маркер.<br/></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_E_INVALID_TOKEN</strong></dt> <dt>0x80090308L</dt> </dl></td><td>Ошибка при выполнении функции. В функцию передан недопустимый токен.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_E_LOGON_DENIED</strong></dt> <dt>0x8009030CL</dt> </dl></td><td>Ошибка входа в систему.<br/></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_E_NO_AUTHENTICATING_AUTHORITY</strong></dt> <dt>0x80090311L</dt> </dl></td><td>Ошибка при выполнении функции. Не удалось связаться с центром сертификации для проверки подлинности. Это может быть вызвано следующими причинами.<br/><ul><li>Неверное доменное имя субъекта проверки подлинности.</li><li>Домен недоступен.</li><li>Не удалось установить отношение доверия.</li></ul></td></tr><tr class="even"><td><dl> <dt><strong>SEC_E_NO_CREDENTIALS</strong></dt> <dt>0x8009030EL</dt> </dl></td><td>Ошибка при выполнении функции. Недопустимый обработчик учетных данных, указанный в параметре <em>фкредентиал</em> . Это значение может быть возвращено при использовании дайджеста или поставщика общих служб SChannel.<br/></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_E_OK</strong></dt> <dt>0x00000000</dt> </dl></td><td>Функция выполнена успешно. Был принят [*контекст безопасности*](../secgloss/s-gly.md) , полученный от клиента. Если выходная лексема была создана функцией, она должна быть отправлена в клиентский процесс.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_E_UNSUPPORTED_FUNCTION</strong></dt> <dt>0x80090302L</dt> </dl></td><td>Ошибка при выполнении функции. Недопустимый флаг атрибута контекста (ASC_REQ_DELEGATE или ASC_REQ_PROMPT_FOR_CREDS) был указан в параметре <em>фконтекстрек</em> .<br/></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_E_APPLICATION_PROTOCOL_MISMATCH</strong></dt> <dt>0x80090367L</dt> </dl></td><td>Между клиентом и сервером не существует общего протокола приложения.<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_I_COMPLETE_AND_CONTINUE</strong></dt> <dt>0x00090314L</dt> </dl></td><td>Функция выполнена успешно. Сервер должен вызвать [<strong>CompleteAuthToken</strong>] (/Windows/Win32/API/SSPI/NF-SSPI-completeauthtoken) и передать выходной токен клиенту. Затем сервер ждет возврата токена от клиента, а затем выполняет еще один вызов [<strong>AcceptSecurityContext (Schannel)</strong>] (AcceptSecurityContext--SChannel.md). <br/></td></tr><tr class="odd"><td><dl> <dt><strong>SEC_I_COMPLETE_NEEDED</strong></dt> <dt>0x00090313L</dt> </dl></td><td>Функция выполнена успешно. Сервер должен завершить создание сообщения от клиента, а затем вызвать функцию [<strong>CompleteAuthToken</strong>] (/Windows/Win32/API/SSPI/NF-SSPI-completeauthtoken).<br/></td></tr><tr class="even"><td><dl> <dt><strong>SEC_I_CONTINUE_NEEDED</strong></dt> <dt>0x00090312L</dt> </dl></td><td>Функция выполнена успешно. Сервер должен отправить выходной токен клиенту и дождаться возвращенного маркера. Возвращаемый токен должен передаваться в <em>пинпут</em> для другого вызова [<strong>AcceptSecurityContext (Schannel)</strong>] (AcceptSecurityContext--SChannel.md).<br/></td></tr><tr class="odd"><td><dl> <dt><strong>STATUS_LOGON_FAILURE</strong></dt> <dt>0xC000006DL</dt> </dl></td><td>Ошибка при выполнении функции. Функция [<strong>AcceptSecurityContext (Schannel)</strong>] (AcceptSecurityContext--SChannel.md) была вызвана после установки указанного контекста. Это значение может быть возвращено при использовании дайджест-поставщика общих служб.<br/></td></tr></tbody></table>



 

## <a name="remarks"></a>Комментарии

Функция **AcceptSecurityContext (Schannel)** является аналогом сервера функции [**InitializeSecurityContext (Schannel)**](initializesecuritycontext--schannel.md) .

Когда сервер получает запрос от клиента, сервер использует параметр *фконтекстрек* , чтобы указать, что он требует для сеанса. Таким образом, сервер может указать, что клиенты должны иметь возможность использовать конфиденциальную сессию или сеанс с проверкой [*целостности*](../secgloss/i-gly.md), а также могут отклонять клиенты, которые не могут удовлетворить это требование. Кроме того, сервер может не потребовать ничего, а любой клиент, который может предоставить или требуется, возвращается в параметре *пфконтекстаттр* .

Для пакета, поддерживающего многоэтапную проверку подлинности, например взаимную проверку подлинности, вызывающая последовательность выглядит следующим образом:

1.  Клиент передает токен на сервер.
2.  Сервер вызывает **AcceptSecurityContext (Schannel)** в первый раз, что создает маркер ответа, который затем отправляется клиенту.
3.  Клиент получает маркер и передает его в [**InitializeSecurityContext (Schannel)**](initializesecuritycontext--schannel.md). Если **InitializeSecurityContext (Schannel)** возвращает значение \_ \_ в секунду, выполняется взаимная проверка подлинности и может начаться безопасный сеанс. Если **InitializeSecurityContext (Schannel)** возвращает код ошибки, согласование взаимной проверки подлинности завершается. В противном случае маркер безопасности, возвращенный **InitializeSecurityContext (Schannel)** , отправляется клиенту, а шаги 2 и 3 повторяются.

Параметры *фконтекстрек* и *пфконтекстаттр* представляют собой битовую маску, представляющую различные атрибуты контекста. Описание различных атрибутов см. в разделе [требования к контексту](context-requirements.md).

> [!Note]  
> Параметр *пфконтекстаттр* допустим при любом успешном возвращении, но только при окончательном успешном возвращении следует изучить флаги, относящиеся к аспектам безопасности контекста. Промежуточные возвраты могут задавать, например, \_ флаг « \_ Выделенная память ISC» \_ .

 

Вызывающий объект отвечает за определение того, достаточно ли атрибутов последнего контекста. Если, например, был запрошен параметр конфиденциальность (шифрование), но его не удалось установить, некоторые приложения могут немедленно завершить подключение. Если невозможно установить [*контекст безопасности*](../secgloss/s-gly.md) , сервер должен освободить частично созданный контекст, вызвав функцию [**делетесекуритиконтекст**](/windows/win32/api/sspi/nf-sspi-deletesecuritycontext) . Сведения о том, когда следует вызывать функцию **делетесекуритиконтекст** , см. в разделе **делетесекуритиконтекст**.

После установки [*контекста безопасности*](../secgloss/s-gly.md) серверное приложение может использовать функцию [**куерисекуритиконтексттокен**](/windows/win32/api/sspi/nf-sspi-querysecuritycontexttoken) для получения маркера учетной записи пользователя, которой сопоставлен сертификат клиента. Кроме того, сервер может использовать функцию [**имперсонатесекуритиконтекст**](/windows/win32/api/sspi/nf-sspi-impersonatesecuritycontext) для олицетворения пользователя.

## <a name="requirements"></a>Требования



| Требование | Значение |
|-------------------------------------|--------------------------------------------------------------------------------------------------------|
| Минимальная версия клиента<br/> | \[Только Windows 8.1 Классические приложения\]<br/>                                                           |
| Минимальная версия сервера<br/> | Только классические приложения Windows Server 2012 R2 \[\]<br/>                                                |
| Header<br/>                   | <dl> <dt>SSPI. h (включая Security. h)</dt> </dl> |
| Библиотека<br/>                  | <dl> <dt>Secur32. lib</dt> </dl>                 |
| DLL<br/>                      | <dl> <dt>Secur32.dll</dt> </dl>                 |



## <a name="see-also"></a>См. также раздел

<dl> <dt>

[Функции SSPI](authentication-functions.md#sspi-functions)
</dt> <dt>

[**делетесекуритиконтекст**](/windows/win32/api/sspi/nf-sspi-deletesecuritycontext)
</dt> <dt>

[**InitializeSecurityContext (Schannel)**](initializesecuritycontext--schannel.md)
</dt> </dl>

 

 
