---
description: Распределенные (клиент/серверные) приложения используют пакеты безопасности для получения прошедших проверку подлинности подключений и обмена сообщениями.
ms.assetid: 8f28177f-335a-4fa2-bf66-2ec1698bebec
title: Инициализация пользовательского режима
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 473b06daf2e1c3612b02583d203ce4cd9afebabd
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103999092"
---
# <a name="user-mode-initialization"></a>Инициализация пользовательского режима

Распределенные (клиент/серверные) приложения используют [*пакеты безопасности*](../secgloss/s-gly.md) для получения прошедших проверку подлинности подключений и обмена сообщениями. Приложение вызывает функции интерфейса поставщика поддержки безопасности (SSPI), сопоставленные с [функциями, реализованными SSP или ТД](authentication-functions.md), а также [функциями, реализованными с помощью SSP или ТД пользовательского режима](authentication-functions.md). Это сопоставление выполняется с помощью библиотеки DLL поставщика безопасности (Secur32.dll или Security.dll), которую можно загрузить в клиентские и серверные процессы динамически. Библиотека DLL также может быть статически связана с помощью Secur32. lib. Библиотеки DLL и LIB входят в состав пакета средств разработки программного обеспечения (SDK) для Microsoft Windows.

Загрузка пакета безопасности в процесс клиента или сервера обрабатывается системой, если DLL-библиотека SSP/AP, содержащая пакет безопасности, правильно зарегистрирована.

Сервер начинает процесс получения безопасного соединения с клиентом, отслеживая порт, ожидая отправки клиентом сообщения. Клиент начинает процесс получения безопасного соединения с сервером путем вызова функции SSPI [**InitializeSecurityContext (Общие)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta). Эта функция сопоставляется с функцией [**спинитлсамодеконтекст**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) пользовательского пакета безопасности. **Спинитлсамодеконтекст** возвращает клиенту маркер, который перенаправляет его на сервер.

После получения маркера от клиента сервер вызывает функцию SSPI [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext), которая отправляется в функцию [**спакцептлсамодеконтекст**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) пакета безопасности. Если функция **спакцептлсамодеконтекст** завершается успешно и для установки контекста безопасности больше не требуется обработка, функция должна вернуть \_ вызывающему объекту состояние Success. Если требуется дополнительная обработка, функция должна вернуть секунды \_ \_ \_ , а затем вернуть маркер на сервер. Сервер пересылает маркер клиенту, который снова вызывает [**InitializeSecurityContext (Общие)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) .

Этот вызывающий цикл может повторяться по мере необходимости, пока не будет установлено или не завершится подключение, прошедшее проверку подлинности. В ходе этого процесса, если функция [**спакцептлсамодеконтекст**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) или [**спинитлсамодеконтекст**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) завершается успешно и для установки [*контекста безопасности*](../secgloss/s-gly.md)больше не требуется обработка, функция должна вернуть \_ вызывающему объекту состояние Success. Если требуется дополнительная обработка, функция должна вернуть секунды, \_ \_ \_ а затем вернуть маркер вызывающему объекту, который отвечает за его пересылку.

Протокол, реализуемый пакетом безопасности, определяет количество повторов этого цикла. Например, в пакетах безопасности, поддерживающих обоюдную взаимную проверку подлинности, вызывающая последовательность выглядит следующим образом:

1.  Клиент получает маркер путем вызова [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)и отправляет его на сервер. Сервер вызывает [**AcceptSecurityContext (Общие)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) в первый раз и возвращает маркер ответа, который он отправляет клиенту.
2.  Клиент использует токен, полученный от сервера, во второй вызов [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)и возвращает окончательный маркер. Клиент отправляет этот токен серверу.
3.  Сервер получает маркер, созданный в подобласти 2, которая используется в последнем вызове [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext).

Если функции [**спакцептлсамодеконтекст**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) и [**спинитлсамодеконтекст**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) выполняются успешно и для установки контекста безопасности больше не требуется обработка, функции должны возвращать \_ вызывающему объекту состояние Success. Кроме того, если пользовательский пакет безопасности поддерживает [функции, реализованные с помощью SSP или ТД пользовательского режима](authentication-functions.md), **спакцептлсамодеконтекст** и **Спинитлсамодеконтекст** должны возвращать **значение true** с помощью параметра *маппедконтекст* . Значение *маппедконтекст* не передается обратно в приложение; он перехватывается LSA.

Если *маппедконтекст* имеет **значение true**, LSA вызывает функцию [**спусермодеинитиализе**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) библиотеки SSP/AP DLL. Эта функция предоставляет таблицы указателей на функции пользовательского режима, реализуемые каждым пакетом безопасности. Функция [**спинстанцеинит**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) каждого пакета вызывается с использованием таблиц функций, возвращаемых **спусермодеинитиализе**. **Спинстанцеинит** получает таблицу указателей на [функции LSA, вызываемые SSP или ТД пользовательского режима](authentication-functions.md).

 

 
