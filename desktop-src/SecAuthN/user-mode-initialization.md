---
description: Распределенные (клиент/серверные) приложения используют пакеты безопасности для получения прошедших проверку подлинности подключений и обмена сообщениями.
ms.assetid: 8f28177f-335a-4fa2-bf66-2ec1698bebec
title: Инициализация пользовательского режима
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 473b06daf2e1c3612b02583d203ce4cd9afebabd
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103999092"
---
# <a name="user-mode-initialization"></a><span data-ttu-id="82856-103">Инициализация пользовательского режима</span><span class="sxs-lookup"><span data-stu-id="82856-103">User Mode Initialization</span></span>

<span data-ttu-id="82856-104">Распределенные (клиент/серверные) приложения используют [*пакеты безопасности*](../secgloss/s-gly.md) для получения прошедших проверку подлинности подключений и обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="82856-104">Distributed (client/server) applications use [*security packages*](../secgloss/s-gly.md) to obtain authenticated connections and to exchange messages.</span></span> <span data-ttu-id="82856-105">Приложение вызывает функции интерфейса поставщика поддержки безопасности (SSPI), сопоставленные с [функциями, реализованными SSP или ТД](authentication-functions.md), а также [функциями, реализованными с помощью SSP или ТД пользовательского режима](authentication-functions.md).</span><span class="sxs-lookup"><span data-stu-id="82856-105">The application calls security support provider interface (SSPI) functions which are mapped to [functions implemented by SSP/APs](authentication-functions.md), and [functions implemented by User-mode SSP/APs](authentication-functions.md).</span></span> <span data-ttu-id="82856-106">Это сопоставление выполняется с помощью библиотеки DLL поставщика безопасности (Secur32.dll или Security.dll), которую можно загрузить в клиентские и серверные процессы динамически.</span><span class="sxs-lookup"><span data-stu-id="82856-106">This mapping is performed by the security provider DLL (Secur32.dll or Security.dll), which can be loaded into the client and server processes dynamically.</span></span> <span data-ttu-id="82856-107">Библиотека DLL также может быть статически связана с помощью Secur32. lib.</span><span class="sxs-lookup"><span data-stu-id="82856-107">The DLL can also be statically linked using Secur32.lib.</span></span> <span data-ttu-id="82856-108">Библиотеки DLL и LIB входят в состав пакета средств разработки программного обеспечения (SDK) для Microsoft Windows.</span><span class="sxs-lookup"><span data-stu-id="82856-108">Both the DLL and LIB ship with the Microsoft Windows Software Development Kit (SDK).</span></span>

<span data-ttu-id="82856-109">Загрузка пакета безопасности в процесс клиента или сервера обрабатывается системой, если DLL-библиотека SSP/AP, содержащая пакет безопасности, правильно зарегистрирована.</span><span class="sxs-lookup"><span data-stu-id="82856-109">Loading the security package into the client or server's process is handled by the system, if the SSP/AP DLL that contains the security package is properly registered.</span></span>

<span data-ttu-id="82856-110">Сервер начинает процесс получения безопасного соединения с клиентом, отслеживая порт, ожидая отправки клиентом сообщения.</span><span class="sxs-lookup"><span data-stu-id="82856-110">The server begins the process of obtaining a secure connection with a client by monitoring a port, waiting for a client to send a message.</span></span> <span data-ttu-id="82856-111">Клиент начинает процесс получения безопасного соединения с сервером путем вызова функции SSPI [**InitializeSecurityContext (Общие)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta).</span><span class="sxs-lookup"><span data-stu-id="82856-111">The client begins the process of obtaining a secure connection to the server by calling the SSPI function [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta).</span></span> <span data-ttu-id="82856-112">Эта функция сопоставляется с функцией [**спинитлсамодеконтекст**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) пользовательского пакета безопасности.</span><span class="sxs-lookup"><span data-stu-id="82856-112">This function is mapped to the custom security package's [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function.</span></span> <span data-ttu-id="82856-113">**Спинитлсамодеконтекст** возвращает клиенту маркер, который перенаправляет его на сервер.</span><span class="sxs-lookup"><span data-stu-id="82856-113">**SpInitLsaModeContext** returns a token to the client, who forwards it to the server.</span></span>

<span data-ttu-id="82856-114">После получения маркера от клиента сервер вызывает функцию SSPI [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext), которая отправляется в функцию [**спакцептлсамодеконтекст**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) пакета безопасности.</span><span class="sxs-lookup"><span data-stu-id="82856-114">Upon receiving the token from the client, the server calls the SSPI function [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext), which is dispatched to the security package's [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) function.</span></span> <span data-ttu-id="82856-115">Если функция **спакцептлсамодеконтекст** завершается успешно и для установки контекста безопасности больше не требуется обработка, функция должна вернуть \_ вызывающему объекту состояние Success.</span><span class="sxs-lookup"><span data-stu-id="82856-115">If the **SpAcceptLsaModeContext** function succeeds and no more processing is required to establish the security context, the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="82856-116">Если требуется дополнительная обработка, функция должна вернуть секунды \_ \_ \_ , а затем вернуть маркер на сервер.</span><span class="sxs-lookup"><span data-stu-id="82856-116">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the server.</span></span> <span data-ttu-id="82856-117">Сервер пересылает маркер клиенту, который снова вызывает [**InitializeSecurityContext (Общие)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) .</span><span class="sxs-lookup"><span data-stu-id="82856-117">The server forwards the token to the client, who calls [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) again.</span></span>

<span data-ttu-id="82856-118">Этот вызывающий цикл может повторяться по мере необходимости, пока не будет установлено или не завершится подключение, прошедшее проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="82856-118">This calling cycle may be repeated as often as necessary until an authenticated connection is established or fails.</span></span> <span data-ttu-id="82856-119">В ходе этого процесса, если функция [**спакцептлсамодеконтекст**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) или [**спинитлсамодеконтекст**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) завершается успешно и для установки [*контекста безопасности*](../secgloss/s-gly.md)больше не требуется обработка, функция должна вернуть \_ вызывающему объекту состояние Success.</span><span class="sxs-lookup"><span data-stu-id="82856-119">During this process, if the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) or [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function succeeds and no more processing is required to establish the [*security context*](../secgloss/s-gly.md), the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="82856-120">Если требуется дополнительная обработка, функция должна вернуть секунды, \_ \_ \_ а затем вернуть маркер вызывающему объекту, который отвечает за его пересылку.</span><span class="sxs-lookup"><span data-stu-id="82856-120">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the caller, who is responsible for forwarding it.</span></span>

<span data-ttu-id="82856-121">Протокол, реализуемый пакетом безопасности, определяет количество повторов этого цикла.</span><span class="sxs-lookup"><span data-stu-id="82856-121">The protocol implemented by the security package determines the number of times this cycle is repeated.</span></span> <span data-ttu-id="82856-122">Например, в пакетах безопасности, поддерживающих обоюдную взаимную проверку подлинности, вызывающая последовательность выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="82856-122">For example, in security packages that supports three-leg mutual authentication, the calling sequence is as follows:</span></span>

1.  <span data-ttu-id="82856-123">Клиент получает маркер путем вызова [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)и отправляет его на сервер.</span><span class="sxs-lookup"><span data-stu-id="82856-123">Client obtains a token by calling [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and sends it to the server.</span></span> <span data-ttu-id="82856-124">Сервер вызывает [**AcceptSecurityContext (Общие)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) в первый раз и возвращает маркер ответа, который он отправляет клиенту.</span><span class="sxs-lookup"><span data-stu-id="82856-124">The server calls [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) the first time, and gets back a reply token which it sends to the client.</span></span>
2.  <span data-ttu-id="82856-125">Клиент использует токен, полученный от сервера, во второй вызов [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)и возвращает окончательный маркер.</span><span class="sxs-lookup"><span data-stu-id="82856-125">The client uses the token received from the server in a second call to [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and gets back a final token.</span></span> <span data-ttu-id="82856-126">Клиент отправляет этот токен серверу.</span><span class="sxs-lookup"><span data-stu-id="82856-126">The client sends this token to the server.</span></span>
3.  <span data-ttu-id="82856-127">Сервер получает маркер, созданный в подобласти 2, которая используется в последнем вызове [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext).</span><span class="sxs-lookup"><span data-stu-id="82856-127">The server receives the token generated in leg 2 which it uses in the final call to [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext).</span></span>

<span data-ttu-id="82856-128">Если функции [**спакцептлсамодеконтекст**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) и [**спинитлсамодеконтекст**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) выполняются успешно и для установки контекста безопасности больше не требуется обработка, функции должны возвращать \_ вызывающему объекту состояние Success.</span><span class="sxs-lookup"><span data-stu-id="82856-128">When the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) and [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) functions succeed and no more processing is required to establish the security context, the functions should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="82856-129">Кроме того, если пользовательский пакет безопасности поддерживает [функции, реализованные с помощью SSP или ТД пользовательского режима](authentication-functions.md), **спакцептлсамодеконтекст** и **Спинитлсамодеконтекст** должны возвращать **значение true** с помощью параметра *маппедконтекст* .</span><span class="sxs-lookup"><span data-stu-id="82856-129">Additionally, if the custom security package supports the [functions implemented by user-mode SSP/APs](authentication-functions.md), **SpAcceptLsaModeContext** and **SpInitLsaModeContext** must return **TRUE** by way of the *MappedContext* parameter.</span></span> <span data-ttu-id="82856-130">Значение *маппедконтекст* не передается обратно в приложение; он перехватывается LSA.</span><span class="sxs-lookup"><span data-stu-id="82856-130">The *MappedContext* value is not passed back to the application; it is intercepted by the LSA.</span></span>

<span data-ttu-id="82856-131">Если *маппедконтекст* имеет **значение true**, LSA вызывает функцию [**спусермодеинитиализе**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) библиотеки SSP/AP DLL.</span><span class="sxs-lookup"><span data-stu-id="82856-131">When *MappedContext* is **true**, the LSA calls the SSP/AP DLL's [**SpUsermodeInitialize**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) function.</span></span> <span data-ttu-id="82856-132">Эта функция предоставляет таблицы указателей на функции пользовательского режима, реализуемые каждым пакетом безопасности.</span><span class="sxs-lookup"><span data-stu-id="82856-132">This function provides tables of pointers to the user-mode functions implemented by each security package.</span></span> <span data-ttu-id="82856-133">Функция [**спинстанцеинит**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) каждого пакета вызывается с использованием таблиц функций, возвращаемых **спусермодеинитиализе**.</span><span class="sxs-lookup"><span data-stu-id="82856-133">Each package's [**SpInstanceInit**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) function is called, using the function tables returned by **SpUsermodeInitialize**.</span></span> <span data-ttu-id="82856-134">**Спинстанцеинит** получает таблицу указателей на [функции LSA, вызываемые SSP или ТД пользовательского режима](authentication-functions.md).</span><span class="sxs-lookup"><span data-stu-id="82856-134">**SpInstanceInit** receives a table of pointers to [LSA functions called by user-mode SSP/APs](authentication-functions.md).</span></span>

 

 
