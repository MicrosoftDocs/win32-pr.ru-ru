---
description: Когда приложение вызывает функции LoadLibrary или LoadLibraryEx, система пытается найти библиотеку DLL (Дополнительные сведения см. в разделе порядок поиска в библиотеке Dynamic-Link).
ms.assetid: 81e237a9-3c32-46a5-88d3-c978f43dad54
title: Run-Time динамическая компоновка
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a9e215ac83ecdc0615b8030e2e215857c67fe6e5
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105662613"
---
# <a name="run-time-dynamic-linking"></a><span data-ttu-id="21c1c-103">Run-Time динамическая компоновка</span><span class="sxs-lookup"><span data-stu-id="21c1c-103">Run-Time Dynamic Linking</span></span>

<span data-ttu-id="21c1c-104">Когда приложение вызывает функции [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) , система пытается найти библиотеку DLL (Дополнительные сведения см. в статье [Порядок поиска библиотек динамической компоновки](dynamic-link-library-search-order.md)).</span><span class="sxs-lookup"><span data-stu-id="21c1c-104">When the application calls the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) functions, the system attempts to locate the DLL (for details, see [Dynamic-Link Library Search Order](dynamic-link-library-search-order.md)).</span></span> <span data-ttu-id="21c1c-105">Если поиск выполняется, система сопоставляет модуль DLL с виртуальным адресным пространством процесса и увеличивает значение счетчика ссылок.</span><span class="sxs-lookup"><span data-stu-id="21c1c-105">If the search succeeds, the system maps the DLL module into the virtual address space of the process and increments the reference count.</span></span> <span data-ttu-id="21c1c-106">Если при вызове **LoadLibrary** или **LoadLibraryEx** указана библиотека DLL, код которой уже сопоставлен с виртуальным адресным пространством вызывающего процесса, функция просто возвращает маркер в библиотеку DLL и увеличивает счетчик ссылок DLL.</span><span class="sxs-lookup"><span data-stu-id="21c1c-106">If the call to **LoadLibrary** or **LoadLibraryEx** specifies a DLL whose code is already mapped into the virtual address space of the calling process, the function simply returns a handle to the DLL and increments the DLL reference count.</span></span> <span data-ttu-id="21c1c-107">Обратите внимание, что две библиотеки DLL с одинаковыми базовыми именами и расширениями файлов, но находятся в разных каталогах, не считаются одной и той же библиотекой DLL.</span><span class="sxs-lookup"><span data-stu-id="21c1c-107">Note that two DLLs that have the same base file name and extension but are found in different directories are not considered to be the same DLL.</span></span>

<span data-ttu-id="21c1c-108">Система вызывает функцию точки входа в контексте потока, который вызвал [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa).</span><span class="sxs-lookup"><span data-stu-id="21c1c-108">The system calls the entry-point function in the context of the thread that called [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa).</span></span> <span data-ttu-id="21c1c-109">Функция точки входа не вызывается, если библиотека DLL уже была загружена процессом посредством вызова **LoadLibrary** или **LoadLibraryEx** без соответствующего вызова функции [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) .</span><span class="sxs-lookup"><span data-stu-id="21c1c-109">The entry-point function is not called if the DLL was already loaded by the process through a call to **LoadLibrary** or **LoadLibraryEx** with no corresponding call to the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function.</span></span>

<span data-ttu-id="21c1c-110">Если системе не удается найти библиотеку DLL или если функция точки входа возвращает значение FALSE, то [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) возвращает значение null.</span><span class="sxs-lookup"><span data-stu-id="21c1c-110">If the system cannot find the DLL or if the entry-point function returns FALSE, [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) returns NULL.</span></span> <span data-ttu-id="21c1c-111">Если **LoadLibrary** или **LoadLibraryEx** завершается, возвращается маркер модуля DLL.</span><span class="sxs-lookup"><span data-stu-id="21c1c-111">If **LoadLibrary** or **LoadLibraryEx** succeeds, it returns a handle to the DLL module.</span></span> <span data-ttu-id="21c1c-112">Процесс может использовать этот обработчик для обнаружения библиотеки DLL при вызове функции [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress), [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary)или [**фрилибраряндекситсреад**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibraryandexitthread) .</span><span class="sxs-lookup"><span data-stu-id="21c1c-112">The process can use this handle to identify the DLL in a call to the [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress), [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary), or [**FreeLibraryAndExitThread**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibraryandexitthread) function.</span></span>

<span data-ttu-id="21c1c-113">Функция [**Ошибка GetModuleHandle**](/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulehandlea) возвращает маркер, используемый в [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress), [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary)или [**фрилибраряндекситсреад**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibraryandexitthread).</span><span class="sxs-lookup"><span data-stu-id="21c1c-113">The [**GetModuleHandle**](/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulehandlea) function returns a handle used in [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress), [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary), or [**FreeLibraryAndExitThread**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibraryandexitthread).</span></span> <span data-ttu-id="21c1c-114">Функция **Ошибка GetModuleHandle** выполняется, только если модуль DLL уже сопоставлен с адресным пространством процесса путем компоновки во время загрузки или путем предыдущего вызова [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa).</span><span class="sxs-lookup"><span data-stu-id="21c1c-114">The **GetModuleHandle** function succeeds only if the DLL module is already mapped into the address space of the process by load-time linking or by a previous call to [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa).</span></span> <span data-ttu-id="21c1c-115">В отличие от **LoadLibrary** или **LoadLibraryEx**, **Ошибка GetModuleHandle** не увеличивает счетчик ссылок на модуль.</span><span class="sxs-lookup"><span data-stu-id="21c1c-115">Unlike **LoadLibrary** or **LoadLibraryEx**, **GetModuleHandle** does not increment the module reference count.</span></span> <span data-ttu-id="21c1c-116">Функция [**GetModuleFileName**](/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulefilenamea) извлекает полный путь к модулю, связанному с маркером, возвращаемым **Ошибка GetModuleHandle**, **LoadLibrary** или **LoadLibraryEx**.</span><span class="sxs-lookup"><span data-stu-id="21c1c-116">The [**GetModuleFileName**](/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulefilenamea) function retrieves the full path of the module associated with a handle returned by **GetModuleHandle**, **LoadLibrary**, or **LoadLibraryEx**.</span></span>

<span data-ttu-id="21c1c-117">Процесс может использовать [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress) для получения адреса экспортированной функции в библиотеке DLL с помощью обработчика модуля DLL, возвращаемого [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa), [**Ошибка GetModuleHandle**](/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulehandlea).</span><span class="sxs-lookup"><span data-stu-id="21c1c-117">The process can use [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress) to get the address of an exported function in the DLL using a DLL module handle returned by [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa), [**GetModuleHandle**](/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulehandlea).</span></span>

<span data-ttu-id="21c1c-118">Если модуль DLL больше не нужен, процесс может вызвать [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) или [**фрилибраряндекситсреад**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibraryandexitthread).</span><span class="sxs-lookup"><span data-stu-id="21c1c-118">When the DLL module is no longer needed, the process can call [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) or [**FreeLibraryAndExitThread**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibraryandexitthread).</span></span> <span data-ttu-id="21c1c-119">Эти функции уменьшают число ссылок на модули и отменяют сопоставление кода DLL из виртуального адресного пространства процесса, если число ссылок равно нулю.</span><span class="sxs-lookup"><span data-stu-id="21c1c-119">These functions decrement the module reference count and unmap the DLL code from the virtual address space of the process if the reference count is zero.</span></span>

<span data-ttu-id="21c1c-120">Динамическая компоновка среды выполнения позволяет продолжить выполнение процесса, даже если библиотека DLL недоступна.</span><span class="sxs-lookup"><span data-stu-id="21c1c-120">Run-time dynamic linking enables the process to continue running even if a DLL is not available.</span></span> <span data-ttu-id="21c1c-121">Затем процесс может использовать альтернативный метод для выполнения своей цели.</span><span class="sxs-lookup"><span data-stu-id="21c1c-121">The process can then use an alternate method to accomplish its objective.</span></span> <span data-ttu-id="21c1c-122">Например, если процессу не удается разместить одну библиотеку DLL, он может попытаться использовать другой или уведомить пользователя об ошибке.</span><span class="sxs-lookup"><span data-stu-id="21c1c-122">For example, if a process is unable to locate one DLL, it can try to use another, or it can notify the user of an error.</span></span> <span data-ttu-id="21c1c-123">Если пользователь может предоставить полный путь к отсутствующей библиотеке DLL, процесс может использовать эти сведения для загрузки библиотеки DLL, несмотря на то, что она не находится в нормальном пути поиска.</span><span class="sxs-lookup"><span data-stu-id="21c1c-123">If the user can provide the full path of the missing DLL, the process can use this information to load the DLL even though it is not in the normal search path.</span></span> <span data-ttu-id="21c1c-124">Эта ситуация отличается от связывания во время загрузки, при которой система просто завершает процесс, если не удается найти библиотеку DLL.</span><span class="sxs-lookup"><span data-stu-id="21c1c-124">This situation contrasts with load-time linking, in which the system simply terminates the process if it cannot find the DLL.</span></span>

<span data-ttu-id="21c1c-125">Динамическая компоновка во время выполнения может вызвать проблемы, если библиотека DLL использует функцию [**DllMain**](dllmain.md) для выполнения инициализации каждого потока процесса, так как точка входа не вызывается для потоков, существовавших до вызова [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) .</span><span class="sxs-lookup"><span data-stu-id="21c1c-125">Run-time dynamic linking can cause problems if the DLL uses the [**DllMain**](dllmain.md) function to perform initialization for each thread of a process, because the entry-point is not called for threads that existed before [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) is called.</span></span> <span data-ttu-id="21c1c-126">Пример решения этой проблемы см. [в разделе Использование локального хранилища потока в библиотеке Dynamic-Link](using-thread-local-storage-in-a-dynamic-link-library.md).</span><span class="sxs-lookup"><span data-stu-id="21c1c-126">For an example showing how to deal with this problem, see [Using Thread Local Storage in a Dynamic-Link Library](using-thread-local-storage-in-a-dynamic-link-library.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="21c1c-127">См. также</span><span class="sxs-lookup"><span data-stu-id="21c1c-127">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="21c1c-128">Использование динамической компоновки во время выполнения</span><span class="sxs-lookup"><span data-stu-id="21c1c-128">Using Run-time Dynamic Linking</span></span>](using-run-time-dynamic-linking.md)
</dt> </dl>

 

 
