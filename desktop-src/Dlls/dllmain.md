---
description: Необязательная точка входа в библиотеку динамической компоновки (DLL). Когда система запускает или завершает процесс или поток, она вызывает функцию точки входа для каждой загруженной библиотеки DLL, используя первый поток процесса.
ms.assetid: 0c3e3083-9297-4626-b2a7-0062d1c2cf9e
title: Точка входа DllMain (Process. h)
ms.topic: reference
ms.date: 07/22/2020
topic_type:
- APIRef
- kbSyntax
api_name:
- DllMain
api_type:
- UserDefined
api_location:
- process.h
ms.openlocfilehash: ee182fd54f11909e54e98f827904f1da5e46f557
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105663540"
---
# <a name="dllmain-entry-point"></a><span data-ttu-id="6503d-104">Точка входа DllMain</span><span class="sxs-lookup"><span data-stu-id="6503d-104">DllMain entry point</span></span>

<span data-ttu-id="6503d-105">Необязательная точка входа в библиотеку динамической компоновки (DLL).</span><span class="sxs-lookup"><span data-stu-id="6503d-105">An optional entry point into a dynamic-link library (DLL).</span></span> <span data-ttu-id="6503d-106">Когда система запускает или завершает процесс или поток, она вызывает функцию точки входа для каждой загруженной библиотеки DLL, используя первый поток процесса.</span><span class="sxs-lookup"><span data-stu-id="6503d-106">When the system starts or terminates a process or thread, it calls the entry-point function for each loaded DLL using the first thread of the process.</span></span> <span data-ttu-id="6503d-107">Система также вызывает функцию точки входа для библиотеки DLL при ее загрузке или выгрузке с помощью функций [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) и [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) .</span><span class="sxs-lookup"><span data-stu-id="6503d-107">The system also calls the entry-point function for a DLL when it is loaded or unloaded using the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) and [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) functions.</span></span>

## <a name="example"></a><span data-ttu-id="6503d-108">Пример</span><span class="sxs-lookup"><span data-stu-id="6503d-108">Example</span></span>

```cpp
BOOL WINAPI DllMain(
    HINSTANCE hinstDLL,  // handle to DLL module
    DWORD fdwReason,     // reason for calling function
    LPVOID lpReserved )  // reserved
{
    // Perform actions based on the reason for calling.
    switch( fdwReason ) 
    { 
        case DLL_PROCESS_ATTACH:
         // Initialize once for each new process.
         // Return FALSE to fail DLL load.
            break;

        case DLL_THREAD_ATTACH:
         // Do thread-specific initialization.
            break;

        case DLL_THREAD_DETACH:
         // Do thread-specific cleanup.
            break;

        case DLL_PROCESS_DETACH:
         // Perform any necessary cleanup.
            break;
    }
    return TRUE;  // Successful DLL_PROCESS_ATTACH.
}
```

<span data-ttu-id="6503d-109">Это пример из [функции Entry-Point библиотеки динамической компоновки](dynamic-link-library-entry-point-function.md).</span><span class="sxs-lookup"><span data-stu-id="6503d-109">This is an example from the [Dynamic-Link Library Entry-Point Function](dynamic-link-library-entry-point-function.md).</span></span>


> [!WARNING]
> <span data-ttu-id="6503d-110">В отношении операций, выполняемых в точке входа DLL, действуют серьезные ограничения.</span><span class="sxs-lookup"><span data-stu-id="6503d-110">There are significant limits on what you can safely do in a DLL entry point.</span></span> <span data-ttu-id="6503d-111">См. раздел [Общие рекомендации](dynamic-link-library-best-practices.md) по конкретным API Windows, которые ненадежны для вызова в DllMain.</span><span class="sxs-lookup"><span data-stu-id="6503d-111">See [General Best Practices](dynamic-link-library-best-practices.md) for specific Windows APIs that are unsafe to call in DllMain.</span></span> <span data-ttu-id="6503d-112">Если требуется сделать что-то помимо простейшей инициализации, сделайте это в функции инициализации для DLL.</span><span class="sxs-lookup"><span data-stu-id="6503d-112">If you need anything but the simplest initialization then do that in an initialization function for the DLL.</span></span> <span data-ttu-id="6503d-113">Можно потребовать, чтобы приложения вызывали функцию инициализации после выполнения DllMain и перед вызовом любых других функций в библиотеке DLL.</span><span class="sxs-lookup"><span data-stu-id="6503d-113">You can require applications to call the initialization function after DllMain has run and before they call any other functions in the DLL.</span></span>

 

## <a name="syntax"></a><span data-ttu-id="6503d-114">Синтаксис</span><span class="sxs-lookup"><span data-stu-id="6503d-114">Syntax</span></span>


```C++
BOOL WINAPI DllMain(
  _In_ HINSTANCE hinstDLL,
  _In_ DWORD     fdwReason,
  _In_ LPVOID    lpvReserved
);
```



## <a name="parameters"></a><span data-ttu-id="6503d-115">Параметры</span><span class="sxs-lookup"><span data-stu-id="6503d-115">Parameters</span></span>

<dl> <dt>

<span data-ttu-id="6503d-116">*хинстдлл* \[ окне\]</span><span class="sxs-lookup"><span data-stu-id="6503d-116">*hinstDLL* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="6503d-117">Маркер модуля DLL.</span><span class="sxs-lookup"><span data-stu-id="6503d-117">A handle to the DLL module.</span></span> <span data-ttu-id="6503d-118">Значение является базовым адресом библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="6503d-118">The value is the base address of the DLL.</span></span> <span data-ttu-id="6503d-119">Значение **HINSTANCE** библиотеки DLL совпадает с **хмодуле** библиотеки DLL, поэтому *хинстдлл* может использоваться в вызовах функций, для которых требуется обработчик модуля.</span><span class="sxs-lookup"><span data-stu-id="6503d-119">The **HINSTANCE** of a DLL is the same as the **HMODULE** of the DLL, so *hinstDLL* can be used in calls to functions that require a module handle.</span></span>

</dd> <dt>

<span data-ttu-id="6503d-120">*фдвреасон* \[ окне\]</span><span class="sxs-lookup"><span data-stu-id="6503d-120">*fdwReason* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="6503d-121">Код причины, указывающий, почему вызывается функция точки входа DLL.</span><span class="sxs-lookup"><span data-stu-id="6503d-121">The reason code that indicates why the DLL entry-point function is being called.</span></span> <span data-ttu-id="6503d-122">Этот параметр может принимать одно из указанных ниже значений.</span><span class="sxs-lookup"><span data-stu-id="6503d-122">This parameter can be one of the following values.</span></span>



| <span data-ttu-id="6503d-123">Значение</span><span class="sxs-lookup"><span data-stu-id="6503d-123">Value</span></span>                                                                                                                                                                                                                                | <span data-ttu-id="6503d-124">Значение</span><span class="sxs-lookup"><span data-stu-id="6503d-124">Meaning</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span id="DLL_PROCESS_ATTACH"></span><span id="dll_process_attach"></span><dl> <span data-ttu-id="6503d-125"><dt>**Библиотека DLL \_ \_Присоединение процесса**</dt> <dt>1</dt></span><span class="sxs-lookup"><span data-stu-id="6503d-125"><dt>**DLL\_PROCESS\_ATTACH**</dt> <dt>1</dt></span></span> </dl> | <span data-ttu-id="6503d-126">Библиотека DLL загружается в виртуальное адресное пространство текущего процесса в результате запуска процесса или в результате вызова [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya).</span><span class="sxs-lookup"><span data-stu-id="6503d-126">The DLL is being loaded into the virtual address space of the current process as a result of the process starting up or as a result of a call to [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya).</span></span> <span data-ttu-id="6503d-127">Библиотеки DLL могут использовать эту возможность для инициализации любых данных экземпляра или использования функции [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) для выделения индекса локального хранилища потока (TLS).</span><span class="sxs-lookup"><span data-stu-id="6503d-127">DLLs can use this opportunity to initialize any instance data or to use the [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) function to allocate a thread local storage (TLS) index.</span></span><br/> <span data-ttu-id="6503d-128">Параметр *lpReserved* указывает, загружается ли библиотека DLL статически или динамически.</span><span class="sxs-lookup"><span data-stu-id="6503d-128">The *lpReserved* parameter indicates whether the DLL is being loaded statically or dynamically.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span id="DLL_PROCESS_DETACH"></span><span id="dll_process_detach"></span><dl> <span data-ttu-id="6503d-129"><dt>**Библиотека DLL \_ \_Отключить процесс**</dt> <dt>0</dt></span><span class="sxs-lookup"><span data-stu-id="6503d-129"><dt>**DLL\_PROCESS\_DETACH**</dt> <dt>0</dt></span></span> </dl> | <span data-ttu-id="6503d-130">Библиотека DLL выгружается из виртуального адресного пространства вызывающего процесса, так как она была загружена неудачно или значение счетчика ссылок достигло нуля (процессы либо прерываются, либо произошел один раз для каждого времени [**, именуемого**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="6503d-130">The DLL is being unloaded from the virtual address space of the calling process because it was loaded unsuccessfully or the reference count has reached zero (the processes has either terminated or called [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) one time for each time it called [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span><br/> <span data-ttu-id="6503d-131">Параметр *lpReserved* указывает, выгружается ли библиотека DLL в результате вызова [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) , сбоя загрузки или завершения процесса.</span><span class="sxs-lookup"><span data-stu-id="6503d-131">The *lpReserved* parameter indicates whether the DLL is being unloaded as a result of a [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) call, a failure to load, or process termination.</span></span><br/> <span data-ttu-id="6503d-132">Библиотека DLL может использовать эту возможность для вызова функции [**TlsFree**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree) , чтобы освободить все индексы TLS, выделенные с помощью функции [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) , и освободить локальные данные потока.</span><span class="sxs-lookup"><span data-stu-id="6503d-132">The DLL can use this opportunity to call the [**TlsFree**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree) function to free any TLS indices allocated by using [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) and to free any thread local data.</span></span><br/> <span data-ttu-id="6503d-133">Обратите внимание, что поток, получающий уведомление об **\_ \_ отсоединении процесса DLL** , не обязательно является тем же потоком, который получил уведомление о **\_ \_ присоединении процесса DLL** .</span><span class="sxs-lookup"><span data-stu-id="6503d-133">Note that the thread that receives the **DLL\_PROCESS\_DETACH** notification is not necessarily the same thread that received the **DLL\_PROCESS\_ATTACH** notification.</span></span><br/> |
| <span id="DLL_THREAD_ATTACH"></span><span id="dll_thread_attach"></span><dl> <span data-ttu-id="6503d-134"><dt>**Библиотека DLL \_ \_Присоединение потока**</dt> <dt>2</dt></span><span class="sxs-lookup"><span data-stu-id="6503d-134"><dt>**DLL\_THREAD\_ATTACH**</dt> <dt>2</dt></span></span> </dl>    | <span data-ttu-id="6503d-135">Текущий процесс — создание нового потока.</span><span class="sxs-lookup"><span data-stu-id="6503d-135">The current process is creating a new thread.</span></span> <span data-ttu-id="6503d-136">В этом случае система вызывает функцию точки входа для всех библиотек DLL, которые в настоящее время подключены к процессу.</span><span class="sxs-lookup"><span data-stu-id="6503d-136">When this occurs, the system calls the entry-point function of all DLLs currently attached to the process.</span></span> <span data-ttu-id="6503d-137">Вызов выполняется в контексте нового потока.</span><span class="sxs-lookup"><span data-stu-id="6503d-137">The call is made in the context of the new thread.</span></span> <span data-ttu-id="6503d-138">Библиотеки DLL могут использовать эту возможность для инициализации слота TLS для потока.</span><span class="sxs-lookup"><span data-stu-id="6503d-138">DLLs can use this opportunity to initialize a TLS slot for the thread.</span></span> <span data-ttu-id="6503d-139">Поток, вызывающий функцию точки входа DLL с **\_ \_ присоединением процесса DLL** , не вызывает функцию точки входа DLL с **\_ \_ присоединением потока DLL**.</span><span class="sxs-lookup"><span data-stu-id="6503d-139">A thread calling the DLL entry-point function with **DLL\_PROCESS\_ATTACH** does not call the DLL entry-point function with **DLL\_THREAD\_ATTACH**.</span></span> <br/> <span data-ttu-id="6503d-140">Обратите внимание, что функция точки входа библиотеки DLL вызывается с этим значением только в потоках, созданных после загрузки процессом библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="6503d-140">Note that a DLL's entry-point function is called with this value only by threads created after the DLL is loaded by the process.</span></span> <span data-ttu-id="6503d-141">Когда библиотека DLL загружается с помощью [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), существующие потоки не вызывают функцию точки входа вновь ЗАГРУЖЕННОЙ библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="6503d-141">When a DLL is loaded using [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), existing threads do not call the entry-point function of the newly loaded DLL.</span></span><br/>                                                                                                                                                                       |
| <span id="DLL_THREAD_DETACH"></span><span id="dll_thread_detach"></span><dl> <span data-ttu-id="6503d-142"><dt>**Библиотека DLL \_ \_Отсоединение потока**</dt> <dt>3</dt></span><span class="sxs-lookup"><span data-stu-id="6503d-142"><dt>**DLL\_THREAD\_DETACH**</dt> <dt>3</dt></span></span> </dl>    | <span data-ttu-id="6503d-143">Поток завершается чисто.</span><span class="sxs-lookup"><span data-stu-id="6503d-143">A thread is exiting cleanly.</span></span> <span data-ttu-id="6503d-144">Если библиотека DLL сохранила указатель на выделенную память в слоте TLS, она должна использовать эту возможность для освобождения памяти.</span><span class="sxs-lookup"><span data-stu-id="6503d-144">If the DLL has stored a pointer to allocated memory in a TLS slot, it should use this opportunity to free the memory.</span></span> <span data-ttu-id="6503d-145">Система вызывает функцию точки входа всех загруженных в данный момент библиотек DLL с этим значением.</span><span class="sxs-lookup"><span data-stu-id="6503d-145">The system calls the entry-point function of all currently loaded DLLs with this value.</span></span> <span data-ttu-id="6503d-146">Вызов выполняется в контексте выходного потока.</span><span class="sxs-lookup"><span data-stu-id="6503d-146">The call is made in the context of the exiting thread.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |



 

</dd> <dt>

<span data-ttu-id="6503d-147">*лпвресервед* \[ окне\]</span><span class="sxs-lookup"><span data-stu-id="6503d-147">*lpvReserved* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="6503d-148">Если *фдвреасон* является **\_ \_ присоединением процесса DLL**, *лпвресервед* имеет **значение NULL** для динамических нагрузок и не равно null для статических нагрузок.</span><span class="sxs-lookup"><span data-stu-id="6503d-148">If *fdwReason* is **DLL\_PROCESS\_ATTACH**, *lpvReserved* is **NULL** for dynamic loads and non-NULL for static loads.</span></span>

<span data-ttu-id="6503d-149">Если *фдвреасон* является **\_ \_ отсоединением процесса DLL**, *лпвресервед* имеет **значение NULL** , если была вызвана [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) , или если не удалось загрузить DLL и не **равно NULL** , если процесс завершается.</span><span class="sxs-lookup"><span data-stu-id="6503d-149">If *fdwReason* is **DLL\_PROCESS\_DETACH**, *lpvReserved* is **NULL** if [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) has been called or the DLL load failed and non-**NULL** if the process is terminating.</span></span>

</dd> </dl>

## <a name="return-value"></a><span data-ttu-id="6503d-150">Возвращаемое значение</span><span class="sxs-lookup"><span data-stu-id="6503d-150">Return value</span></span>

<span data-ttu-id="6503d-151">Когда система вызывает функцию **DllMain** с **\_ \_ присоединением к процессу DLL** , функция возвращает **значение true** , если она завершается успешно, или **значение false** , если инициализация завершается неудачно.</span><span class="sxs-lookup"><span data-stu-id="6503d-151">When the system calls the **DllMain** function with the **DLL\_PROCESS\_ATTACH** value, the function returns **TRUE** if it succeeds or **FALSE** if initialization fails.</span></span> <span data-ttu-id="6503d-152">Если возвращаемое значение равно **false** при вызове **DllMain** из-за того, что процесс использует функцию [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) , **LoadLibrary** возвращает значение null.</span><span class="sxs-lookup"><span data-stu-id="6503d-152">If the return value is **FALSE** when **DllMain** is called because the process uses the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) function, **LoadLibrary** returns NULL.</span></span> <span data-ttu-id="6503d-153">(Система немедленно вызывает функцию точки входа с **\_ \_ отсоединением процесса DLL** и выгружает библиотеку DLL.) Если возвращаемое значение равно **false** при вызове функции **DllMain** во время инициализации процесса, процесс завершается с ошибкой.</span><span class="sxs-lookup"><span data-stu-id="6503d-153">(The system immediately calls your entry-point function with **DLL\_PROCESS\_DETACH** and unloads the DLL.) If the return value is **FALSE** when **DllMain** is called during process initialization, the process terminates with an error.</span></span> <span data-ttu-id="6503d-154">Дополнительные сведения об ошибке можно получить, вызвав [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror).</span><span class="sxs-lookup"><span data-stu-id="6503d-154">To get extended error information, call [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror).</span></span>

<span data-ttu-id="6503d-155">Когда система вызывает функцию **DllMain** с любым значением, отличным от **\_ \_ присоединения к процессу DLL**, возвращаемое значение игнорируется.</span><span class="sxs-lookup"><span data-stu-id="6503d-155">When the system calls the **DllMain** function with any value other than **DLL\_PROCESS\_ATTACH**, the return value is ignored.</span></span>

## <a name="remarks"></a><span data-ttu-id="6503d-156">Комментарии</span><span class="sxs-lookup"><span data-stu-id="6503d-156">Remarks</span></span>

<span data-ttu-id="6503d-157">**DllMain** — это заполнитель для имени определяемой библиотекой функции.</span><span class="sxs-lookup"><span data-stu-id="6503d-157">**DllMain** is a placeholder for the library-defined function name.</span></span> <span data-ttu-id="6503d-158">Необходимо указать фактическое имя, используемое при сборке библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="6503d-158">You must specify the actual name you use when you build your DLL.</span></span> <span data-ttu-id="6503d-159">Дополнительные сведения см. в документации, входящей в состав средств разработки.</span><span class="sxs-lookup"><span data-stu-id="6503d-159">For more information, see the documentation included with your development tools.</span></span>

<span data-ttu-id="6503d-160">Во время запуска первого процесса или после вызова [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)система проверяет список загруженных библиотек DLL для процесса.</span><span class="sxs-lookup"><span data-stu-id="6503d-160">During initial process startup or after a call to [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), the system scans the list of loaded DLLs for the process.</span></span> <span data-ttu-id="6503d-161">Для каждой библиотеки DLL, которая еще не была вызвана с помощью значения **\_ \_ attach для процесса DLL** , система вызывает функцию точки входа библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="6503d-161">For each DLL that has not already been called with the **DLL\_PROCESS\_ATTACH** value, the system calls the DLL's entry-point function.</span></span> <span data-ttu-id="6503d-162">Этот вызов выполняется в контексте потока, который привел к изменению адресного пространства процесса, например к основному потоку процесса или к потоку, вызвавшему **LoadLibrary**.</span><span class="sxs-lookup"><span data-stu-id="6503d-162">This call is made in the context of the thread that caused the process address space to change, such as the primary thread of the process or the thread that called **LoadLibrary**.</span></span> <span data-ttu-id="6503d-163">Доступ к точке входа сериализуется системой на уровне процесса.</span><span class="sxs-lookup"><span data-stu-id="6503d-163">Access to the entry point is serialized by the system on a process-wide basis.</span></span> <span data-ttu-id="6503d-164">Потоки в *DllMain* сохраняют блокировку загрузчика, поэтому дополнительные библиотеки DLL не могут быть загружены или инициализированы динамически.</span><span class="sxs-lookup"><span data-stu-id="6503d-164">Threads in *DllMain* hold the loader lock so no additional DLLs can be dynamically loaded or initialized.</span></span>

<span data-ttu-id="6503d-165">Если функция точки входа библиотеки DLL возвращает значение FALSE после уведомления о **\_ \_ присоединении процесса DLL** , оно получает уведомление **об \_ \_ отсоединении процесса DLL** , и библиотека DLL немедленно выгружается.</span><span class="sxs-lookup"><span data-stu-id="6503d-165">If the DLL's entry-point function returns FALSE following a **DLL\_PROCESS\_ATTACH** notification, it receives a **DLL\_PROCESS\_DETACH** notification and the DLL is unloaded immediately.</span></span> <span data-ttu-id="6503d-166">Однако если код **\_ \_ присоединения процесса DLL** вызывает исключение, функция точки входа не будет принимать уведомление об **\_ \_ отсоединении процесса DLL** .</span><span class="sxs-lookup"><span data-stu-id="6503d-166">However, if the **DLL\_PROCESS\_ATTACH** code throws an exception, the entry-point function will not receive the **DLL\_PROCESS\_DETACH** notification.</span></span>

<span data-ttu-id="6503d-167">В некоторых случаях функция точки входа вызывается для завершающего потока, даже если функция точки входа никогда не вызывалась с **\_ \_ присоединением потока DLL** к потоку:</span><span class="sxs-lookup"><span data-stu-id="6503d-167">There are cases in which the entry-point function is called for a terminating thread even if the entry-point function was never called with **DLL\_THREAD\_ATTACH** for the thread:</span></span>

-   <span data-ttu-id="6503d-168">Поток был исходным потоком в процессе, поэтому система вызвала функцию точки входа со значением **\_ \_ присоединения процесса DLL** .</span><span class="sxs-lookup"><span data-stu-id="6503d-168">The thread was the initial thread in the process, so the system called the entry-point function with the **DLL\_PROCESS\_ATTACH** value.</span></span>
-   <span data-ttu-id="6503d-169">Поток уже выполнялся при вызове функции [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) , поэтому система никогда не вызывала для нее функцию точки входа.</span><span class="sxs-lookup"><span data-stu-id="6503d-169">The thread was already running when a call to the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) function was made, so the system never called the entry-point function for it.</span></span>

<span data-ttu-id="6503d-170">Когда библиотека DLL выгружается из процесса в результате неудачной загрузки библиотеки DLL, завершения процесса или вызова [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary), система не вызывает функцию точки входа библиотеки DLL в качестве значения **\_ \_ отсоединения потока библиотеки DLL** для отдельных потоков процесса.</span><span class="sxs-lookup"><span data-stu-id="6503d-170">When a DLL is unloaded from a process as a result of an unsuccessful load of the DLL, termination of the process, or a call to [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary), the system does not call the DLL's entry-point function with the **DLL\_THREAD\_DETACH** value for the individual threads of the process.</span></span> <span data-ttu-id="6503d-171">Библиотека DLL отправляет только уведомление об **\_ \_ отсоединении процесса DLL** .</span><span class="sxs-lookup"><span data-stu-id="6503d-171">The DLL is only sent a **DLL\_PROCESS\_DETACH** notification.</span></span> <span data-ttu-id="6503d-172">Библиотеки DLL могут использовать эту возможность для очистки всех ресурсов для всех потоков, известных библиотеке DLL.</span><span class="sxs-lookup"><span data-stu-id="6503d-172">DLLs can take this opportunity to clean up all resources for all threads known to the DLL.</span></span>

<span data-ttu-id="6503d-173">При обработке **\_ \_ отключения процесса DLL** библиотека DLL должна освобождать ресурсы, такие как память КУЧИ, только если библиотека DLL выгружается динамически (параметр *lpReserved* имеет **значение NULL**).</span><span class="sxs-lookup"><span data-stu-id="6503d-173">When handling **DLL\_PROCESS\_DETACH**, a DLL should free resources such as heap memory only if the DLL is being unloaded dynamically (the *lpReserved* parameter is **NULL**).</span></span> <span data-ttu-id="6503d-174">Если процесс завершается (параметр *лпвресервед* не **равен null**), все потоки в процессе, за исключением текущего потока, либо уже завершили работу, либо были явно прерваны вызовом функции [**ExitProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-exitprocess) , что может привести к непротиворечивости некоторых ресурсов процесса, таких как кучи.</span><span class="sxs-lookup"><span data-stu-id="6503d-174">If the process is terminating (the *lpvReserved* parameter is non-**NULL**), all threads in the process except the current thread either have exited already or have been explicitly terminated by a call to the [**ExitProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-exitprocess) function, which might leave some process resources such as heaps in an inconsistent state.</span></span> <span data-ttu-id="6503d-175">В этом случае библиотека DLL не является надежной для очистки ресурсов.</span><span class="sxs-lookup"><span data-stu-id="6503d-175">In this case, it is not safe for the DLL to clean up the resources.</span></span> <span data-ttu-id="6503d-176">Вместо этого библиотека DLL должна позволять операционной системе высвободить память.</span><span class="sxs-lookup"><span data-stu-id="6503d-176">Instead, the DLL should allow the operating system to reclaim the memory.</span></span>

<span data-ttu-id="6503d-177">При завершении процесса путем вызова [**терминатепроцесс**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) или [**терминатежобобжект**](/windows/desktop/api/jobapi2/nf-jobapi2-terminatejobobject)библиотеки DLL этого процесса не получают уведомления об **\_ \_ отсоединении процесса DLL** .</span><span class="sxs-lookup"><span data-stu-id="6503d-177">If you terminate a process by calling [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) or [**TerminateJobObject**](/windows/desktop/api/jobapi2/nf-jobapi2-terminatejobobject), the DLLs of that process do not receive **DLL\_PROCESS\_DETACH** notifications.</span></span> <span data-ttu-id="6503d-178">Если поток завершается вызовом [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread), библиотеки DLL этого потока не получают уведомления об **\_ \_ отсоединении потока DLL** .</span><span class="sxs-lookup"><span data-stu-id="6503d-178">If you terminate a thread by calling [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread), the DLLs of that thread do not receive **DLL\_THREAD\_DETACH** notifications.</span></span>

<span data-ttu-id="6503d-179">Функция точки входа должна выполнять только простые задачи инициализации или завершения.</span><span class="sxs-lookup"><span data-stu-id="6503d-179">The entry-point function should perform only simple initialization or termination tasks.</span></span> <span data-ttu-id="6503d-180">Он не должен вызывать функцию [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) (или функцию, которая вызывает эти функции), так как это может создавать циклы зависимостей в порядке загрузки DLL.</span><span class="sxs-lookup"><span data-stu-id="6503d-180">It must not call the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function (or a function that calls these functions), because this may create dependency loops in the DLL load order.</span></span> <span data-ttu-id="6503d-181">Это может привести к тому, что библиотека DLL будет использоваться до того, как система выполнила свой код инициализации.</span><span class="sxs-lookup"><span data-stu-id="6503d-181">This can result in a DLL being used before the system has executed its initialization code.</span></span> <span data-ttu-id="6503d-182">Аналогичным образом функция точки входа не должна вызывать функцию [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) (или функцию, которая вызывает **FreeLibrary**) во время завершения процесса, так как это может привести к тому, что библиотека DLL будет использоваться после того, как система выполнит свой код завершения.</span><span class="sxs-lookup"><span data-stu-id="6503d-182">Similarly, the entry-point function must not call the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function (or a function that calls **FreeLibrary**) during process termination, because this can result in a DLL being used after the system has executed its termination code.</span></span>

<span data-ttu-id="6503d-183">Поскольку Kernel32.dll гарантированно загружается в адресное пространство процесса при вызове функции точки входа, вызов функций в Kernel32.dll не приводит к тому, что библиотека DLL будет использоваться до выполнения кода инициализации.</span><span class="sxs-lookup"><span data-stu-id="6503d-183">Because Kernel32.dll is guaranteed to be loaded in the process address space when the entry-point function is called, calling functions in Kernel32.dll does not result in the DLL being used before its initialization code has been executed.</span></span> <span data-ttu-id="6503d-184">Поэтому функция точки входа может вызывать функции в Kernel32.dll, которые не загружают другие библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="6503d-184">Therefore, the entry-point function can call functions in Kernel32.dll that do not load other DLLs.</span></span> <span data-ttu-id="6503d-185">Например, функция *DllMain* может создавать [объекты синхронизации](/windows/desktop/Sync/synchronization-objects) , такие как критические разделы и мьютексы, и использовать TLS.</span><span class="sxs-lookup"><span data-stu-id="6503d-185">For example, *DllMain* can create [synchronization objects](/windows/desktop/Sync/synchronization-objects) such as critical sections and mutexes, and use TLS.</span></span> <span data-ttu-id="6503d-186">К сожалению, в Kernel32.dll нет исчерпывающего списка безбезопасность функций.</span><span class="sxs-lookup"><span data-stu-id="6503d-186">Unfortunately, there is not a comprehensive list of safe functions in Kernel32.dll.</span></span>

<span data-ttu-id="6503d-187">Вызов функций, требующих библиотек DLL, отличных от Kernel32.dll, может привести к проблемам, которые трудно диагностировать.</span><span class="sxs-lookup"><span data-stu-id="6503d-187">Calling functions that require DLLs other than Kernel32.dll may result in problems that are difficult to diagnose.</span></span> <span data-ttu-id="6503d-188">Например, вызов функций User, Shell и COM может вызвать ошибки нарушения прав доступа, так как некоторые функции загружают другие системные компоненты.</span><span class="sxs-lookup"><span data-stu-id="6503d-188">For example, calling User, Shell, and COM functions can cause access violation errors, because some functions load other system components.</span></span> <span data-ttu-id="6503d-189">И наоборот, вызов таких функций во время завершения может вызвать ошибки нарушения прав доступа, так как соответствующий компонент может быть уже выгружен или неинициализирован.</span><span class="sxs-lookup"><span data-stu-id="6503d-189">Conversely, calling functions such as these during termination can cause access violation errors because the corresponding component may already have been unloaded or uninitialized.</span></span>

<span data-ttu-id="6503d-190">Поскольку уведомления DLL сериализуются, функции точки входа не должны пытаться взаимодействовать с другими потоками или процессами.</span><span class="sxs-lookup"><span data-stu-id="6503d-190">Because DLL notifications are serialized, entry-point functions should not attempt to communicate with other threads or processes.</span></span> <span data-ttu-id="6503d-191">В результате могут возникнуть взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="6503d-191">Deadlocks may occur as a result.</span></span>

<span data-ttu-id="6503d-192">Дополнительные сведения о рекомендациях при написании библиотеки DLL см https://docs.microsoft.com/windows/win32/dlls/dynamic-link-library-best-practices . в разделе.</span><span class="sxs-lookup"><span data-stu-id="6503d-192">For information on best practices when writing a DLL, see https://docs.microsoft.com/windows/win32/dlls/dynamic-link-library-best-practices.</span></span>

<span data-ttu-id="6503d-193">Если библиотека DLL связана с библиотекой времени выполнения C (CRT), точка входа, предоставляемая CRT, вызывает конструкторы и деструкторы для глобальных и статических объектов C++.</span><span class="sxs-lookup"><span data-stu-id="6503d-193">If your DLL is linked with the C run-time library (CRT), the entry point provided by the CRT calls the constructors and destructors for global and static C++ objects.</span></span> <span data-ttu-id="6503d-194">Таким образом, эти ограничения для функции *DllMain* также применяются к конструкторам и деструкторам и к любому коду, который вызывается из них.</span><span class="sxs-lookup"><span data-stu-id="6503d-194">Therefore, these restrictions for *DllMain* also apply to constructors and destructors and any code that is called from them.</span></span>

<span data-ttu-id="6503d-195">Рассмотрите возможность вызова [**дисаблесреадлибрарикаллс**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) при получении **\_ \_ подключения к процессу DLL**, если только библиотека DLL не связана со статической библиотекой времени выполнения C (CRT).</span><span class="sxs-lookup"><span data-stu-id="6503d-195">Consider calling [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) when receiving **DLL\_PROCESS\_ATTACH**, unless your DLL is linked with static C run-time library (CRT).</span></span>


## <a name="requirements"></a><span data-ttu-id="6503d-196">Требования</span><span class="sxs-lookup"><span data-stu-id="6503d-196">Requirements</span></span>



| <span data-ttu-id="6503d-197">Требование</span><span class="sxs-lookup"><span data-stu-id="6503d-197">Requirement</span></span> | <span data-ttu-id="6503d-198">Значение</span><span class="sxs-lookup"><span data-stu-id="6503d-198">Value</span></span> |
|-------------------------------------|--------------------------------------------------------------------------------------|
| <span data-ttu-id="6503d-199">Минимальная версия клиента</span><span class="sxs-lookup"><span data-stu-id="6503d-199">Minimum supported client</span></span><br/> | <span data-ttu-id="6503d-200">Только для \[ классических приложений Windows XP\]</span><span class="sxs-lookup"><span data-stu-id="6503d-200">Windows XP \[desktop apps only\]</span></span><br/>                                          |
| <span data-ttu-id="6503d-201">Минимальная версия сервера</span><span class="sxs-lookup"><span data-stu-id="6503d-201">Minimum supported server</span></span><br/> | <span data-ttu-id="6503d-202">\[Только для настольных приложений Windows Server 2003\]</span><span class="sxs-lookup"><span data-stu-id="6503d-202">Windows Server 2003 \[desktop apps only\]</span></span><br/>                                 |
| <span data-ttu-id="6503d-203">Header</span><span class="sxs-lookup"><span data-stu-id="6503d-203">Header</span></span><br/>                   | <dl> <span data-ttu-id="6503d-204"><dt>Process. h</dt></span><span class="sxs-lookup"><span data-stu-id="6503d-204"><dt>Process.h</dt></span></span> </dl> |



## <a name="see-also"></a><span data-ttu-id="6503d-205">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="6503d-205">See also</span></span>

<dl> <dt>

[<span data-ttu-id="6503d-206">Функция Entry-Point библиотеки динамической компоновки</span><span class="sxs-lookup"><span data-stu-id="6503d-206">Dynamic-Link Library Entry-Point Function</span></span>](dynamic-link-library-entry-point-function.md)
</dt> <dt>

[<span data-ttu-id="6503d-207">Функции библиотеки динамической компоновки</span><span class="sxs-lookup"><span data-stu-id="6503d-207">Dynamic-Link Library Functions</span></span>](dynamic-link-library-functions.md)
</dt> <dt>

[<span data-ttu-id="6503d-208">**FreeLibrary**</span><span class="sxs-lookup"><span data-stu-id="6503d-208">**FreeLibrary**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary)
</dt> <dt>

[<span data-ttu-id="6503d-209">**GetModuleFileName**</span><span class="sxs-lookup"><span data-stu-id="6503d-209">**GetModuleFileName**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulefilenamea)
</dt> <dt>

[<span data-ttu-id="6503d-210">**LoadLibrary**</span><span class="sxs-lookup"><span data-stu-id="6503d-210">**LoadLibrary**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)
</dt> <dt>

[<span data-ttu-id="6503d-211">**TlsAlloc**</span><span class="sxs-lookup"><span data-stu-id="6503d-211">**TlsAlloc**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc)
</dt> <dt>

[<span data-ttu-id="6503d-212">**TlsFree**</span><span class="sxs-lookup"><span data-stu-id="6503d-212">**TlsFree**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree)
</dt> <dt>

[<span data-ttu-id="6503d-213">**дисаблесреадлибрарикаллс**</span><span class="sxs-lookup"><span data-stu-id="6503d-213">**DisableThreadLibraryCalls**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls)





</dt> </dl>
