---
description: Необязательная точка входа в библиотеку динамической компоновки (DLL). Когда система запускает или завершает процесс или поток, она вызывает функцию точки входа для каждой загруженной библиотеки DLL, используя первый поток процесса.
ms.assetid: 0c3e3083-9297-4626-b2a7-0062d1c2cf9e
title: Точка входа DllMain (Process. h)
ms.topic: reference
ms.date: 07/22/2020
topic_type:
- APIRef
- kbSyntax
api_name:
- DllMain
api_type:
- UserDefined
api_location:
- process.h
ms.openlocfilehash: ee182fd54f11909e54e98f827904f1da5e46f557
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105663540"
---
# <a name="dllmain-entry-point"></a>Точка входа DllMain

Необязательная точка входа в библиотеку динамической компоновки (DLL). Когда система запускает или завершает процесс или поток, она вызывает функцию точки входа для каждой загруженной библиотеки DLL, используя первый поток процесса. Система также вызывает функцию точки входа для библиотеки DLL при ее загрузке или выгрузке с помощью функций [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) и [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) .

## <a name="example"></a>Пример

```cpp
BOOL WINAPI DllMain(
    HINSTANCE hinstDLL,  // handle to DLL module
    DWORD fdwReason,     // reason for calling function
    LPVOID lpReserved )  // reserved
{
    // Perform actions based on the reason for calling.
    switch( fdwReason ) 
    { 
        case DLL_PROCESS_ATTACH:
         // Initialize once for each new process.
         // Return FALSE to fail DLL load.
            break;

        case DLL_THREAD_ATTACH:
         // Do thread-specific initialization.
            break;

        case DLL_THREAD_DETACH:
         // Do thread-specific cleanup.
            break;

        case DLL_PROCESS_DETACH:
         // Perform any necessary cleanup.
            break;
    }
    return TRUE;  // Successful DLL_PROCESS_ATTACH.
}
```

Это пример из [функции Entry-Point библиотеки динамической компоновки](dynamic-link-library-entry-point-function.md).


> [!WARNING]
> В отношении операций, выполняемых в точке входа DLL, действуют серьезные ограничения. См. раздел [Общие рекомендации](dynamic-link-library-best-practices.md) по конкретным API Windows, которые ненадежны для вызова в DllMain. Если требуется сделать что-то помимо простейшей инициализации, сделайте это в функции инициализации для DLL. Можно потребовать, чтобы приложения вызывали функцию инициализации после выполнения DllMain и перед вызовом любых других функций в библиотеке DLL.

 

## <a name="syntax"></a>Синтаксис


```C++
BOOL WINAPI DllMain(
  _In_ HINSTANCE hinstDLL,
  _In_ DWORD     fdwReason,
  _In_ LPVOID    lpvReserved
);
```



## <a name="parameters"></a>Параметры

<dl> <dt>

*хинстдлл* \[ окне\]
</dt> <dd>

Маркер модуля DLL. Значение является базовым адресом библиотеки DLL. Значение **HINSTANCE** библиотеки DLL совпадает с **хмодуле** библиотеки DLL, поэтому *хинстдлл* может использоваться в вызовах функций, для которых требуется обработчик модуля.

</dd> <dt>

*фдвреасон* \[ окне\]
</dt> <dd>

Код причины, указывающий, почему вызывается функция точки входа DLL. Этот параметр может принимать одно из указанных ниже значений.



| Значение                                                                                                                                                                                                                                | Значение                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span id="DLL_PROCESS_ATTACH"></span><span id="dll_process_attach"></span><dl> <dt>**Библиотека DLL \_ \_Присоединение процесса**</dt> <dt>1</dt> </dl> | Библиотека DLL загружается в виртуальное адресное пространство текущего процесса в результате запуска процесса или в результате вызова [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya). Библиотеки DLL могут использовать эту возможность для инициализации любых данных экземпляра или использования функции [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) для выделения индекса локального хранилища потока (TLS).<br/> Параметр *lpReserved* указывает, загружается ли библиотека DLL статически или динамически.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span id="DLL_PROCESS_DETACH"></span><span id="dll_process_detach"></span><dl> <dt>**Библиотека DLL \_ \_Отключить процесс**</dt> <dt>0</dt> </dl> | Библиотека DLL выгружается из виртуального адресного пространства вызывающего процесса, так как она была загружена неудачно или значение счетчика ссылок достигло нуля (процессы либо прерываются, либо произошел один раз для каждого времени [**, именуемого**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).<br/> Параметр *lpReserved* указывает, выгружается ли библиотека DLL в результате вызова [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) , сбоя загрузки или завершения процесса.<br/> Библиотека DLL может использовать эту возможность для вызова функции [**TlsFree**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree) , чтобы освободить все индексы TLS, выделенные с помощью функции [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) , и освободить локальные данные потока.<br/> Обратите внимание, что поток, получающий уведомление об **\_ \_ отсоединении процесса DLL** , не обязательно является тем же потоком, который получил уведомление о **\_ \_ присоединении процесса DLL** .<br/> |
| <span id="DLL_THREAD_ATTACH"></span><span id="dll_thread_attach"></span><dl> <dt>**Библиотека DLL \_ \_Присоединение потока**</dt> <dt>2</dt> </dl>    | Текущий процесс — создание нового потока. В этом случае система вызывает функцию точки входа для всех библиотек DLL, которые в настоящее время подключены к процессу. Вызов выполняется в контексте нового потока. Библиотеки DLL могут использовать эту возможность для инициализации слота TLS для потока. Поток, вызывающий функцию точки входа DLL с **\_ \_ присоединением процесса DLL** , не вызывает функцию точки входа DLL с **\_ \_ присоединением потока DLL**. <br/> Обратите внимание, что функция точки входа библиотеки DLL вызывается с этим значением только в потоках, созданных после загрузки процессом библиотеки DLL. Когда библиотека DLL загружается с помощью [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), существующие потоки не вызывают функцию точки входа вновь ЗАГРУЖЕННОЙ библиотеки DLL.<br/>                                                                                                                                                                       |
| <span id="DLL_THREAD_DETACH"></span><span id="dll_thread_detach"></span><dl> <dt>**Библиотека DLL \_ \_Отсоединение потока**</dt> <dt>3</dt> </dl>    | Поток завершается чисто. Если библиотека DLL сохранила указатель на выделенную память в слоте TLS, она должна использовать эту возможность для освобождения памяти. Система вызывает функцию точки входа всех загруженных в данный момент библиотек DLL с этим значением. Вызов выполняется в контексте выходного потока.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |



 

</dd> <dt>

*лпвресервед* \[ окне\]
</dt> <dd>

Если *фдвреасон* является **\_ \_ присоединением процесса DLL**, *лпвресервед* имеет **значение NULL** для динамических нагрузок и не равно null для статических нагрузок.

Если *фдвреасон* является **\_ \_ отсоединением процесса DLL**, *лпвресервед* имеет **значение NULL** , если была вызвана [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) , или если не удалось загрузить DLL и не **равно NULL** , если процесс завершается.

</dd> </dl>

## <a name="return-value"></a>Возвращаемое значение

Когда система вызывает функцию **DllMain** с **\_ \_ присоединением к процессу DLL** , функция возвращает **значение true** , если она завершается успешно, или **значение false** , если инициализация завершается неудачно. Если возвращаемое значение равно **false** при вызове **DllMain** из-за того, что процесс использует функцию [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) , **LoadLibrary** возвращает значение null. (Система немедленно вызывает функцию точки входа с **\_ \_ отсоединением процесса DLL** и выгружает библиотеку DLL.) Если возвращаемое значение равно **false** при вызове функции **DllMain** во время инициализации процесса, процесс завершается с ошибкой. Дополнительные сведения об ошибке можно получить, вызвав [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror).

Когда система вызывает функцию **DllMain** с любым значением, отличным от **\_ \_ присоединения к процессу DLL**, возвращаемое значение игнорируется.

## <a name="remarks"></a>Комментарии

**DllMain** — это заполнитель для имени определяемой библиотекой функции. Необходимо указать фактическое имя, используемое при сборке библиотеки DLL. Дополнительные сведения см. в документации, входящей в состав средств разработки.

Во время запуска первого процесса или после вызова [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)система проверяет список загруженных библиотек DLL для процесса. Для каждой библиотеки DLL, которая еще не была вызвана с помощью значения **\_ \_ attach для процесса DLL** , система вызывает функцию точки входа библиотеки DLL. Этот вызов выполняется в контексте потока, который привел к изменению адресного пространства процесса, например к основному потоку процесса или к потоку, вызвавшему **LoadLibrary**. Доступ к точке входа сериализуется системой на уровне процесса. Потоки в *DllMain* сохраняют блокировку загрузчика, поэтому дополнительные библиотеки DLL не могут быть загружены или инициализированы динамически.

Если функция точки входа библиотеки DLL возвращает значение FALSE после уведомления о **\_ \_ присоединении процесса DLL** , оно получает уведомление **об \_ \_ отсоединении процесса DLL** , и библиотека DLL немедленно выгружается. Однако если код **\_ \_ присоединения процесса DLL** вызывает исключение, функция точки входа не будет принимать уведомление об **\_ \_ отсоединении процесса DLL** .

В некоторых случаях функция точки входа вызывается для завершающего потока, даже если функция точки входа никогда не вызывалась с **\_ \_ присоединением потока DLL** к потоку:

-   Поток был исходным потоком в процессе, поэтому система вызвала функцию точки входа со значением **\_ \_ присоединения процесса DLL** .
-   Поток уже выполнялся при вызове функции [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) , поэтому система никогда не вызывала для нее функцию точки входа.

Когда библиотека DLL выгружается из процесса в результате неудачной загрузки библиотеки DLL, завершения процесса или вызова [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary), система не вызывает функцию точки входа библиотеки DLL в качестве значения **\_ \_ отсоединения потока библиотеки DLL** для отдельных потоков процесса. Библиотека DLL отправляет только уведомление об **\_ \_ отсоединении процесса DLL** . Библиотеки DLL могут использовать эту возможность для очистки всех ресурсов для всех потоков, известных библиотеке DLL.

При обработке **\_ \_ отключения процесса DLL** библиотека DLL должна освобождать ресурсы, такие как память КУЧИ, только если библиотека DLL выгружается динамически (параметр *lpReserved* имеет **значение NULL**). Если процесс завершается (параметр *лпвресервед* не **равен null**), все потоки в процессе, за исключением текущего потока, либо уже завершили работу, либо были явно прерваны вызовом функции [**ExitProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-exitprocess) , что может привести к непротиворечивости некоторых ресурсов процесса, таких как кучи. В этом случае библиотека DLL не является надежной для очистки ресурсов. Вместо этого библиотека DLL должна позволять операционной системе высвободить память.

При завершении процесса путем вызова [**терминатепроцесс**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) или [**терминатежобобжект**](/windows/desktop/api/jobapi2/nf-jobapi2-terminatejobobject)библиотеки DLL этого процесса не получают уведомления об **\_ \_ отсоединении процесса DLL** . Если поток завершается вызовом [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread), библиотеки DLL этого потока не получают уведомления об **\_ \_ отсоединении потока DLL** .

Функция точки входа должна выполнять только простые задачи инициализации или завершения. Он не должен вызывать функцию [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) (или функцию, которая вызывает эти функции), так как это может создавать циклы зависимостей в порядке загрузки DLL. Это может привести к тому, что библиотека DLL будет использоваться до того, как система выполнила свой код инициализации. Аналогичным образом функция точки входа не должна вызывать функцию [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) (или функцию, которая вызывает **FreeLibrary**) во время завершения процесса, так как это может привести к тому, что библиотека DLL будет использоваться после того, как система выполнит свой код завершения.

Поскольку Kernel32.dll гарантированно загружается в адресное пространство процесса при вызове функции точки входа, вызов функций в Kernel32.dll не приводит к тому, что библиотека DLL будет использоваться до выполнения кода инициализации. Поэтому функция точки входа может вызывать функции в Kernel32.dll, которые не загружают другие библиотеки DLL. Например, функция *DllMain* может создавать [объекты синхронизации](/windows/desktop/Sync/synchronization-objects) , такие как критические разделы и мьютексы, и использовать TLS. К сожалению, в Kernel32.dll нет исчерпывающего списка безбезопасность функций.

Вызов функций, требующих библиотек DLL, отличных от Kernel32.dll, может привести к проблемам, которые трудно диагностировать. Например, вызов функций User, Shell и COM может вызвать ошибки нарушения прав доступа, так как некоторые функции загружают другие системные компоненты. И наоборот, вызов таких функций во время завершения может вызвать ошибки нарушения прав доступа, так как соответствующий компонент может быть уже выгружен или неинициализирован.

Поскольку уведомления DLL сериализуются, функции точки входа не должны пытаться взаимодействовать с другими потоками или процессами. В результате могут возникнуть взаимоблокировки.

Дополнительные сведения о рекомендациях при написании библиотеки DLL см https://docs.microsoft.com/windows/win32/dlls/dynamic-link-library-best-practices . в разделе.

Если библиотека DLL связана с библиотекой времени выполнения C (CRT), точка входа, предоставляемая CRT, вызывает конструкторы и деструкторы для глобальных и статических объектов C++. Таким образом, эти ограничения для функции *DllMain* также применяются к конструкторам и деструкторам и к любому коду, который вызывается из них.

Рассмотрите возможность вызова [**дисаблесреадлибрарикаллс**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) при получении **\_ \_ подключения к процессу DLL**, если только библиотека DLL не связана со статической библиотекой времени выполнения C (CRT).


## <a name="requirements"></a>Требования



| Требование | Значение |
|-------------------------------------|--------------------------------------------------------------------------------------|
| Минимальная версия клиента<br/> | Только для \[ классических приложений Windows XP\]<br/>                                          |
| Минимальная версия сервера<br/> | \[Только для настольных приложений Windows Server 2003\]<br/>                                 |
| Header<br/>                   | <dl> <dt>Process. h</dt> </dl> |



## <a name="see-also"></a>См. также раздел

<dl> <dt>

[Функция Entry-Point библиотеки динамической компоновки](dynamic-link-library-entry-point-function.md)
</dt> <dt>

[Функции библиотеки динамической компоновки](dynamic-link-library-functions.md)
</dt> <dt>

[**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary)
</dt> <dt>

[**GetModuleFileName**](/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulefilenamea)
</dt> <dt>

[**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)
</dt> <dt>

[**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc)
</dt> <dt>

[**TlsFree**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree)
</dt> <dt>

[**дисаблесреадлибрарикаллс**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls)





</dt> </dl>
