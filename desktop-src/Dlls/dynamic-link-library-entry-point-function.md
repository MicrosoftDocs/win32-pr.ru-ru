---
description: DLL может дополнительно указывать функцию точки входа.
ms.assetid: ec035fc6-0a6f-4e52-a4cc-8d7a25a94366
title: Функция Entry-Point библиотеки Dynamic-Link
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b62bff557bfa2aa792b420e8fe1856bbe0726921
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103811482"
---
# <a name="dynamic-link-library-entry-point-function"></a><span data-ttu-id="d575d-103">Функция Entry-Point библиотеки Dynamic-Link</span><span class="sxs-lookup"><span data-stu-id="d575d-103">Dynamic-Link Library Entry-Point Function</span></span>

<span data-ttu-id="d575d-104">DLL может дополнительно указывать функцию точки входа.</span><span class="sxs-lookup"><span data-stu-id="d575d-104">A DLL can optionally specify an entry-point function.</span></span> <span data-ttu-id="d575d-105">При наличии система вызывает функцию точки входа каждый раз, когда процесс или поток загружает или выгружает библиотеку DLL.</span><span class="sxs-lookup"><span data-stu-id="d575d-105">If present, the system calls the entry-point function whenever a process or thread loads or unloads the DLL.</span></span> <span data-ttu-id="d575d-106">Его можно использовать для выполнения простых задач инициализации и очистки.</span><span class="sxs-lookup"><span data-stu-id="d575d-106">It can be used to perform simple initialization and cleanup tasks.</span></span> <span data-ttu-id="d575d-107">Например, он может настроить локальное хранилище потока при создании нового потока и очистить его после завершения потока.</span><span class="sxs-lookup"><span data-stu-id="d575d-107">For example, it can set up thread local storage when a new thread is created, and clean it up when the thread is terminated.</span></span>

<span data-ttu-id="d575d-108">Если библиотека DLL связывается с библиотекой времени выполнения C, она может предоставить функцию точки входа и предоставить отдельную функцию инициализации.</span><span class="sxs-lookup"><span data-stu-id="d575d-108">If you are linking your DLL with the C run-time library, it may provide an entry-point function for you, and allow you to provide a separate initialization function.</span></span> <span data-ttu-id="d575d-109">Дополнительные сведения см. в документации по библиотеке времени выполнения.</span><span class="sxs-lookup"><span data-stu-id="d575d-109">Check the documentation for your run-time library for more information.</span></span>

<span data-ttu-id="d575d-110">Если вы предоставляете собственную точку входа, см. раздел Функция [**DllMain**](dllmain.md) .</span><span class="sxs-lookup"><span data-stu-id="d575d-110">If you are providing your own entry-point, see the [**DllMain**](dllmain.md) function.</span></span> <span data-ttu-id="d575d-111">Имя **DllMain** — это заполнитель для определяемой пользователем функции.</span><span class="sxs-lookup"><span data-stu-id="d575d-111">The name **DllMain** is a placeholder for a user-defined function.</span></span> <span data-ttu-id="d575d-112">Необходимо указать фактическое имя, используемое при сборке библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="d575d-112">You must specify the actual name you use when you build your DLL.</span></span> <span data-ttu-id="d575d-113">Дополнительные сведения см. в документации, входящей в состав средств разработки.</span><span class="sxs-lookup"><span data-stu-id="d575d-113">For more information, see the documentation included with your development tools.</span></span>

## <a name="calling-the-entry-point-function"></a><span data-ttu-id="d575d-114">Вызов функции Entry-Point</span><span class="sxs-lookup"><span data-stu-id="d575d-114">Calling the Entry-Point Function</span></span>

<span data-ttu-id="d575d-115">Система вызывает функцию точки входа каждый раз, когда происходит одно из следующих событий:</span><span class="sxs-lookup"><span data-stu-id="d575d-115">The system calls the entry-point function whenever any one of the following events occurs:</span></span>

-   <span data-ttu-id="d575d-116">Процесс загружает библиотеку DLL.</span><span class="sxs-lookup"><span data-stu-id="d575d-116">A process loads the DLL.</span></span> <span data-ttu-id="d575d-117">Для процессов, использующих динамическую компоновку во время загрузки, Библиотека DLL загружается во время инициализации процесса.</span><span class="sxs-lookup"><span data-stu-id="d575d-117">For processes using load-time dynamic linking, the DLL is loaded during process initialization.</span></span> <span data-ttu-id="d575d-118">Для процессов, использующих связывание во время выполнения, Библиотека DLL загружается до возврата [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) .</span><span class="sxs-lookup"><span data-stu-id="d575d-118">For processes using run-time linking, the DLL is loaded before [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) returns.</span></span>
-   <span data-ttu-id="d575d-119">Процесс выгружает библиотеку DLL.</span><span class="sxs-lookup"><span data-stu-id="d575d-119">A process unloads the DLL.</span></span> <span data-ttu-id="d575d-120">Библиотека DLL выгружается, когда процесс завершается или вызывается функция [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) , а счетчик ссылок становится нулевым.</span><span class="sxs-lookup"><span data-stu-id="d575d-120">The DLL is unloaded when the process terminates or calls the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function and the reference count becomes zero.</span></span> <span data-ttu-id="d575d-121">Если процесс завершается в результате выполнения функции [**терминатепроцесс**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) или [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) , система не вызывает функцию точки входа DLL.</span><span class="sxs-lookup"><span data-stu-id="d575d-121">If the process terminates as a result of the [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) or [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) function, the system does not call the DLL entry-point function.</span></span>
-   <span data-ttu-id="d575d-122">Новый поток создается в процессе, который загрузил библиотеку DLL.</span><span class="sxs-lookup"><span data-stu-id="d575d-122">A new thread is created in a process that has loaded the DLL.</span></span> <span data-ttu-id="d575d-123">Функцию [**дисаблесреадлибрарикаллс**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) можно использовать для отключения уведомлений при создании потоков.</span><span class="sxs-lookup"><span data-stu-id="d575d-123">You can use the [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) function to disable notification when threads are created.</span></span>
-   <span data-ttu-id="d575d-124">Поток процесса, который загрузил библиотеку DLL, завершается нормально, но не использует [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) или [**терминатепроцесс**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess).</span><span class="sxs-lookup"><span data-stu-id="d575d-124">A thread of a process that has loaded the DLL terminates normally, not using [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) or [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess).</span></span> <span data-ttu-id="d575d-125">Когда процесс выгружает библиотеку DLL, функция точки входа вызывается только один раз для всего процесса, а не один раз для каждого существующего потока процесса.</span><span class="sxs-lookup"><span data-stu-id="d575d-125">When a process unloads the DLL, the entry-point function is called only once for the entire process, rather than once for each existing thread of the process.</span></span> <span data-ttu-id="d575d-126">[**Дисаблесреадлибрарикаллс**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) можно использовать для отключения уведомлений о завершении потоков.</span><span class="sxs-lookup"><span data-stu-id="d575d-126">You can use [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) to disable notification when threads are terminated.</span></span>

<span data-ttu-id="d575d-127">Только один поток за раз может вызвать функцию точки входа.</span><span class="sxs-lookup"><span data-stu-id="d575d-127">Only one thread at a time can call the entry-point function.</span></span>

<span data-ttu-id="d575d-128">Система вызывает функцию точки входа в контексте процесса или потока, который вызвал вызов функции.</span><span class="sxs-lookup"><span data-stu-id="d575d-128">The system calls the entry-point function in the context of the process or thread that caused the function to be called.</span></span> <span data-ttu-id="d575d-129">Это позволяет библиотеке DLL использовать свою функцию точки входа для выделения памяти в виртуальном адресном пространстве вызывающего процесса или для открытия дескрипторов, доступных процессу.</span><span class="sxs-lookup"><span data-stu-id="d575d-129">This allows a DLL to use its entry-point function for allocating memory in the virtual address space of the calling process or to open handles accessible to the process.</span></span> <span data-ttu-id="d575d-130">Функция точки входа также может выделить память, которая является закрытой для нового потока, используя локальное хранилище потока (TLS).</span><span class="sxs-lookup"><span data-stu-id="d575d-130">The entry-point function can also allocate memory that is private to a new thread by using thread local storage (TLS).</span></span> <span data-ttu-id="d575d-131">Дополнительные сведения о локальном хранилище потоков см. в разделе [Локальное хранилище потока](/windows/desktop/ProcThread/thread-local-storage).</span><span class="sxs-lookup"><span data-stu-id="d575d-131">For more information about thread local storage, see [Thread Local Storage](/windows/desktop/ProcThread/thread-local-storage).</span></span>

## <a name="entry-point-function-definition"></a><span data-ttu-id="d575d-132">Определение функции Entry-Point</span><span class="sxs-lookup"><span data-stu-id="d575d-132">Entry-Point Function Definition</span></span>

<span data-ttu-id="d575d-133">Функция точки входа DLL должна быть объявлена с соглашением о вызовах Standard-Call.</span><span class="sxs-lookup"><span data-stu-id="d575d-133">The DLL entry-point function must be declared with the standard-call calling convention.</span></span> <span data-ttu-id="d575d-134">Если точка входа DLL не объявлена должным образом, Библиотека DLL не загружается, а система отображает сообщение, указывающее, что точка входа DLL должна быть объявлена с помощью WINAPI.</span><span class="sxs-lookup"><span data-stu-id="d575d-134">If the DLL entry point is not declared correctly, the DLL is not loaded, and the system displays a message indicating that the DLL entry point must be declared with WINAPI.</span></span>

<span data-ttu-id="d575d-135">В теле функции можно выполнять любое сочетание следующих сценариев, в которых была вызвана точка входа DLL:</span><span class="sxs-lookup"><span data-stu-id="d575d-135">In the body of the function, you may handle any combination of the following scenarios in which the DLL entry point has been called:</span></span>

-   <span data-ttu-id="d575d-136">Процесс загружает библиотеку DLL (**\_ \_ Подключение к процессу DLL**).</span><span class="sxs-lookup"><span data-stu-id="d575d-136">A process loads the DLL (**DLL\_PROCESS\_ATTACH**).</span></span>
-   <span data-ttu-id="d575d-137">Текущий процесс создает новый поток (**\_ \_ присоединение потока DLL**).</span><span class="sxs-lookup"><span data-stu-id="d575d-137">The current process creates a new thread (**DLL\_THREAD\_ATTACH**).</span></span>
-   <span data-ttu-id="d575d-138">Поток завершается обычным образом **( \_ \_ Отключение потока DLL**).</span><span class="sxs-lookup"><span data-stu-id="d575d-138">A thread exits normally (**DLL\_THREAD\_DETACH**).</span></span>
-   <span data-ttu-id="d575d-139">Процесс выгружает библиотеку DLL (**\_ \_ отсоединение процесса DLL**).</span><span class="sxs-lookup"><span data-stu-id="d575d-139">A process unloads the DLL (**DLL\_PROCESS\_DETACH**).</span></span>

<span data-ttu-id="d575d-140">Функция точки входа должна выполнять только простые задачи инициализации.</span><span class="sxs-lookup"><span data-stu-id="d575d-140">The entry-point function should perform only simple initialization tasks.</span></span> <span data-ttu-id="d575d-141">Он не должен вызывать функцию [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) (или функцию, которая вызывает эти функции), так как это может создавать циклы зависимостей в порядке загрузки DLL.</span><span class="sxs-lookup"><span data-stu-id="d575d-141">It must not call the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function (or a function that calls these functions), because this may create dependency loops in the DLL load order.</span></span> <span data-ttu-id="d575d-142">Это может привести к тому, что библиотека DLL будет использоваться до того, как система выполнила свой код инициализации.</span><span class="sxs-lookup"><span data-stu-id="d575d-142">This can result in a DLL being used before the system has executed its initialization code.</span></span> <span data-ttu-id="d575d-143">Аналогичным образом функция точки входа не должна вызывать функцию [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) (или функцию, которая вызывает **FreeLibrary**) во время завершения процесса, так как это может привести к тому, что библиотека DLL будет использоваться после того, как система выполнит свой код завершения.</span><span class="sxs-lookup"><span data-stu-id="d575d-143">Similarly, the entry-point function must not call the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function (or a function that calls **FreeLibrary**) during process termination, because this can result in a DLL being used after the system has executed its termination code.</span></span>

<span data-ttu-id="d575d-144">Поскольку Kernel32.dll гарантированно загружается в адресное пространство процесса при вызове функции точки входа, вызов функций в Kernel32.dll не приводит к тому, что библиотека DLL будет использоваться до выполнения кода инициализации.</span><span class="sxs-lookup"><span data-stu-id="d575d-144">Because Kernel32.dll is guaranteed to be loaded in the process address space when the entry-point function is called, calling functions in Kernel32.dll does not result in the DLL being used before its initialization code has been executed.</span></span> <span data-ttu-id="d575d-145">Поэтому функция точки входа может создавать [объекты синхронизации](/windows/desktop/Sync/synchronization-objects) , такие как критические разделы и мьютексы, и использовать TLS, так как эти функции находятся в Kernel32.dll.</span><span class="sxs-lookup"><span data-stu-id="d575d-145">Therefore, the entry-point function can create [synchronization objects](/windows/desktop/Sync/synchronization-objects) such as critical sections and mutexes, and use TLS, because these functions are located in Kernel32.dll.</span></span> <span data-ttu-id="d575d-146">Не рекомендуется вызывать функции реестра, например, так как они находятся в Advapi32.dll.</span><span class="sxs-lookup"><span data-stu-id="d575d-146">It is not safe to call the registry functions, for example, because they are located in Advapi32.dll.</span></span>

<span data-ttu-id="d575d-147">Вызов других функций может привести к проблемам, которые трудно диагностировать.</span><span class="sxs-lookup"><span data-stu-id="d575d-147">Calling other functions may result in problems that are difficult to diagnose.</span></span> <span data-ttu-id="d575d-148">Например, вызов функций User, Shell и COM может вызвать ошибки нарушения прав доступа, так как некоторые функции в их библиотеках DLL вызывают функцию [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) для загрузки других компонентов системы.</span><span class="sxs-lookup"><span data-stu-id="d575d-148">For example, calling User, Shell, and COM functions can cause access violation errors, because some functions in their DLLs call [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) to load other system components.</span></span> <span data-ttu-id="d575d-149">И наоборот, вызов этих функций во время завершения может вызвать ошибки нарушения прав доступа, так как соответствующий компонент может быть уже выгружен или неинициализирован.</span><span class="sxs-lookup"><span data-stu-id="d575d-149">Conversely, calling those functions during termination can cause access violation errors because the corresponding component may already have been unloaded or uninitialized.</span></span>

<span data-ttu-id="d575d-150">В следующем примере показано, как структурировать функцию точки входа DLL.</span><span class="sxs-lookup"><span data-stu-id="d575d-150">The following example demonstrates how to structure the DLL entry-point function.</span></span>

``` syntax
BOOL WINAPI DllMain(
    HINSTANCE hinstDLL,  // handle to DLL module
    DWORD fdwReason,     // reason for calling function
    LPVOID lpReserved )  // reserved
{
    // Perform actions based on the reason for calling.
    switch( fdwReason ) 
    { 
        case DLL_PROCESS_ATTACH:
         // Initialize once for each new process.
         // Return FALSE to fail DLL load.
            break;

        case DLL_THREAD_ATTACH:
         // Do thread-specific initialization.
            break;

        case DLL_THREAD_DETACH:
         // Do thread-specific cleanup.
            break;

        case DLL_PROCESS_DETACH:
         // Perform any necessary cleanup.
            break;
    }
    return TRUE;  // Successful DLL_PROCESS_ATTACH.
}
```

## <a name="entry-point-function-return-value"></a><span data-ttu-id="d575d-151">Entry-Point возвращаемое значение функции</span><span class="sxs-lookup"><span data-stu-id="d575d-151">Entry-Point Function Return Value</span></span>

<span data-ttu-id="d575d-152">Когда вызывается функция точки входа библиотеки DLL из-за загрузки процесса, функция возвращает **значение true** , чтобы указать на успешное выполнение.</span><span class="sxs-lookup"><span data-stu-id="d575d-152">When a DLL entry-point function is called because a process is loading, the function returns **TRUE** to indicate success.</span></span> <span data-ttu-id="d575d-153">Для процессов, использующих связывание во время загрузки, возвращаемое значение **false** приводит к сбою инициализации процесса и завершению процесса.</span><span class="sxs-lookup"><span data-stu-id="d575d-153">For processes using load-time linking, a return value of **FALSE** causes the process initialization to fail and the process terminates.</span></span> <span data-ttu-id="d575d-154">Для процессов, использующих связывание во время выполнения, возвращаемое значение FALSE приводит к тому, что функция [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) или [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) возвращает **значение NULL**, означающее сбой.</span><span class="sxs-lookup"><span data-stu-id="d575d-154">For processes using run-time linking, a return value of FALSE causes the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function to return **NULL**, indicating failure.</span></span> <span data-ttu-id="d575d-155">(Система немедленно вызывает функцию точки входа с **\_ \_ отсоединением процесса DLL** и выгружает библиотеку DLL.) Возвращаемое значение функции точки входа не учитывается, если функция вызывается по какой-либо другой причине.</span><span class="sxs-lookup"><span data-stu-id="d575d-155">(The system immediately calls your entry-point function with **DLL\_PROCESS\_DETACH** and unloads the DLL.) The return value of the entry-point function is disregarded when the function is called for any other reason.</span></span>

 

 
