---
title: Поддержка нескольких прыжков в WinRM
description: Служба удаленного управления Windows (WinRM) поддерживает делегирование учетных данных пользователя на нескольких удаленных компьютерах.
ms.assetid: 0e6c8966-bb05-4dfb-b154-300fa76e8d9c
ms.tgt_platform: multiple
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f22c3d66e8605e932fe15b812f92d51350da2d69
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104495858"
---
# <a name="multi-hop-support-in-winrm"></a><span data-ttu-id="da520-103">Поддержка нескольких прыжков в WinRM</span><span class="sxs-lookup"><span data-stu-id="da520-103">Multi-Hop Support in WinRM</span></span>

<span data-ttu-id="da520-104">Служба удаленного управления Windows (WinRM) поддерживает делегирование учетных данных пользователя на нескольких удаленных компьютерах.</span><span class="sxs-lookup"><span data-stu-id="da520-104">Windows Remote Management (WinRM) supports the delegation of user credentials across multiple remote computers.</span></span> <span data-ttu-id="da520-105">Функция поддержки нескольких прыжков теперь может использовать поставщик службы безопасности учетных данных (CredSSP) для проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="da520-105">The multi-hop support functionality can now use Credential Security Service Provider (CredSSP) for authentication.</span></span> <span data-ttu-id="da520-106">CredSSP позволяет приложению делегировать учетные данные пользователя с клиентского компьютера на целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="da520-106">CredSSP enables an application to delegate the user's credentials from the client computer to the target server.</span></span>

<span data-ttu-id="da520-107">Проверка подлинности CredSSP предназначена для сред, где нельзя использовать делегирование Kerberos.</span><span class="sxs-lookup"><span data-stu-id="da520-107">CredSSP authentication is intended for environments where Kerberos delegation cannot be used.</span></span> <span data-ttu-id="da520-108">Добавлена поддержка CredSSP, позволяющая пользователю подключаться к удаленному серверу и иметь возможность доступа к компьютеру второго прыжка, например к общей папке.</span><span class="sxs-lookup"><span data-stu-id="da520-108">Support for CredSSP was added to allow a user to connect to a remote server and have the ability to access a second-hop machine, such as a file share.</span></span>

<span data-ttu-id="da520-109">Дополнительные сведения о CredSSP см. в статье [KB 951608](https://support.microsoft.com/kb/951608).</span><span class="sxs-lookup"><span data-stu-id="da520-109">For more information about CredSSP, see [KB 951608](https://support.microsoft.com/kb/951608).</span></span>

> [!Note]  
> <span data-ttu-id="da520-110">Клиенты и серверы WinRM будут поддерживать проверку подлинности CredSSP только с явными учетными данными.</span><span class="sxs-lookup"><span data-stu-id="da520-110">WinRM clients and servers will support CredSSP authentication only with explicit credentials.</span></span>

 

## <a name="multi-hop-support-configuration-setup-and-details"></a><span data-ttu-id="da520-111">Настройка конфигурации поддержки нескольких прыжков и сведения</span><span class="sxs-lookup"><span data-stu-id="da520-111">Multi-Hop Support Configuration Setup and Details</span></span>

<span data-ttu-id="da520-112">Существует несколько механизмов настройки параметров WinRM.</span><span class="sxs-lookup"><span data-stu-id="da520-112">There are multiple mechanisms for configuring WinRM settings.</span></span> <span data-ttu-id="da520-113">В следующей процедуре используются служебная программа **WinRM** и редактор групповая политика (**gpedit. msc**).</span><span class="sxs-lookup"><span data-stu-id="da520-113">In the following procedure, the **winrm** utility and Group Policy editor (**GPEdit.msc**) are used.</span></span> <span data-ttu-id="da520-114">Кроме того, CredSSP можно включить для WinRM с помощью Windows PowerShell.</span><span class="sxs-lookup"><span data-stu-id="da520-114">CredSSP can also be enabled for WinRM by using Windows PowerShell.</span></span> <span data-ttu-id="da520-115">Подробные сведения о конфигурации и примеры использования см. в разделе [Enable-WSManCredSSP](/powershell/module/Microsoft.WsMan.Management/Enable-WSManCredSSP?view=powershell-5.1&preserve-view=true), [Get-WSManCredSSP](/powershell/module/Microsoft.WsMan.Management/Get-WSManCredSSP?view=powershell-5.1&preserve-view=true)и [Disable-WSManCredSSP](/powershell/module/Microsoft.WsMan.Management/Disable-WSManCredSSP?view=powershell-5.1&preserve-view=true) командлеты Windows PowerShell.</span><span class="sxs-lookup"><span data-stu-id="da520-115">See the [Enable-WSManCredSSP](/powershell/module/Microsoft.WsMan.Management/Enable-WSManCredSSP?view=powershell-5.1&preserve-view=true), [Get-WSManCredSSP](/powershell/module/Microsoft.WsMan.Management/Get-WSManCredSSP?view=powershell-5.1&preserve-view=true), and [Disable-WSManCredSSP](/powershell/module/Microsoft.WsMan.Management/Disable-WSManCredSSP?view=powershell-5.1&preserve-view=true) Windows PowerShell cmdlets for detailed configuration information and usage examples.</span></span>

<span data-ttu-id="da520-116">Делегирование CredSSP должно быть включено в параметрах клиента и в параметрах службы на удаленном компьютере.</span><span class="sxs-lookup"><span data-stu-id="da520-116">CredSSP delegation must be enabled in the client settings and in the service settings on the remote computer.</span></span> <span data-ttu-id="da520-117">Кроме того, для использования CredSSP необходимо настроить [*прослушиватель*](windows-remote-management-glossary.md) HTTP или HTTPS на сервере.</span><span class="sxs-lookup"><span data-stu-id="da520-117">In addition, using CredSSP requires setting up an HTTP or HTTPS [*listener*](windows-remote-management-glossary.md) on the server.</span></span>

<span data-ttu-id="da520-118">**Настройка поддержки нескольких прыжков с помощью проверки подлинности CredSSP для WinRM**</span><span class="sxs-lookup"><span data-stu-id="da520-118">**To configure multi-hop support using CredSSP authentication for WinRM**</span></span>

1.  <span data-ttu-id="da520-119">В параметрах конфигурации клиента необходимо включить CredSSP.</span><span class="sxs-lookup"><span data-stu-id="da520-119">CredSSP must be enabled in the client configuration settings.</span></span> <span data-ttu-id="da520-120">Этот флаг можно включить вручную или с помощью параметра групповая политика.</span><span class="sxs-lookup"><span data-stu-id="da520-120">This flag can be enabled manually or through a Group Policy setting.</span></span> <span data-ttu-id="da520-121">Значение по умолчанию — **False**.</span><span class="sxs-lookup"><span data-stu-id="da520-121">The default setting is **False**.</span></span> <span data-ttu-id="da520-122">Параметр **Разрешить политику проверки подлинности CredSSP** расположен по следующему пути: Конфигурация компьютера \\ административный шаблон \\ компоненты Windows \\ Служба удаленного управления Windows (WinRM) \\ WinRM Client.</span><span class="sxs-lookup"><span data-stu-id="da520-122">The **Allow CredSSP authentication** policy is located at the following path: Computer Configuration\\Administrative template\\Windows Components\\Windows Remote Management (WinRM)\\WinRM Client.</span></span>

    <span data-ttu-id="da520-123">Следующая команда демонстрирует использование служебной программы WinRM для включения CredSSP на клиенте WinRM:</span><span class="sxs-lookup"><span data-stu-id="da520-123">The following command demonstrates how to use the winrm utility to enable CredSSP on the WinRM client:</span></span>

    <span data-ttu-id="da520-124">**WinRM set winrm/config/Client/auth @ {CredSSP = "true"}**</span><span class="sxs-lookup"><span data-stu-id="da520-124">**winrm set winrm/config/client/auth @{CredSSP="true"}**</span></span>

2.  <span data-ttu-id="da520-125">В параметрах конфигурации службы WinRM необходимо включить CredSSP.</span><span class="sxs-lookup"><span data-stu-id="da520-125">CredSSP must be enabled in the WinRM service configuration settings.</span></span> <span data-ttu-id="da520-126">Этот флаг можно включить вручную или с помощью параметра групповая политика.</span><span class="sxs-lookup"><span data-stu-id="da520-126">This flag can be enabled manually or through a Group Policy setting.</span></span> <span data-ttu-id="da520-127">Значение по умолчанию — **False**.</span><span class="sxs-lookup"><span data-stu-id="da520-127">The default setting is **False**.</span></span> <span data-ttu-id="da520-128">Параметр **Разрешить политику проверки подлинности CredSSP** расположен по следующему пути: Конфигурация компьютера \\ административный шаблон \\ компоненты Windows \\ Служба удаленного управления Windows (WinRM) \\ WinRM Service.</span><span class="sxs-lookup"><span data-stu-id="da520-128">The **Allow CredSSP authentication** policy is located at the following path: Computer Configuration\\Administrative template\\Windows Components\\Windows Remote Management (WinRM)\\WinRM Service.</span></span>

    <span data-ttu-id="da520-129">Следующая команда демонстрирует использование служебной программы WinRM для включения CredSSP в службе WinRM:</span><span class="sxs-lookup"><span data-stu-id="da520-129">The following command demonstrates how to use the winrm utility to enable CredSSP on the WinRM service:</span></span>

    <span data-ttu-id="da520-130">**WinRM set winrm/config/Service/auth @ {CredSSP = "true"}**</span><span class="sxs-lookup"><span data-stu-id="da520-130">**winrm set winrm/config/service/auth @{CredSSP="true"}**</span></span>

3.  <span data-ttu-id="da520-131">Параметр политики разрешить делегирование новых учетных данных (**алловфрешкредентиалс**) должен быть включен на клиенте WinRM, а имя субъекта-службы (SPN) с префиксом WSMan должно быть добавлено в политику.</span><span class="sxs-lookup"><span data-stu-id="da520-131">The Allow Delegating Fresh Credentials (**AllowFreshCredentials**) policy setting must be enabled on the WinRM client, and a Service Principal Name (SPN) with the WSMAN prefix must be added to the policy.</span></span> <span data-ttu-id="da520-132">Имя участника-службы представляет целевой компьютер, которому могут быть делегированы учетные данные пользователя.</span><span class="sxs-lookup"><span data-stu-id="da520-132">The SPN represents the target computer to which the user credentials can be delegated.</span></span> <span data-ttu-id="da520-133">Имя субъекта-службы можно задать для одного или нескольких компьютеров.</span><span class="sxs-lookup"><span data-stu-id="da520-133">The SPN can be set to one or more computers.</span></span> <span data-ttu-id="da520-134">В следующей таблице приведены примеры допустимых форматов для имен участников-служб.</span><span class="sxs-lookup"><span data-stu-id="da520-134">The following table contains examples of valid formats for SPNs.</span></span>

    

    | <span data-ttu-id="da520-135">SPN</span><span class="sxs-lookup"><span data-stu-id="da520-135">SPN</span></span>                                       | <span data-ttu-id="da520-136">Описание</span><span class="sxs-lookup"><span data-stu-id="da520-136">Description</span></span>                                                                         |
    |-------------------------------------------|-------------------------------------------------------------------------------------|
    | <span data-ttu-id="da520-137">WSMAN/myComputer. myDomain. com</span><span class="sxs-lookup"><span data-stu-id="da520-137">WSMAN/myComputer.myDomain.com</span></span><br/>  | <span data-ttu-id="da520-138">Сервер WinRM, работающий на myComputer.myDomain.com.</span><span class="sxs-lookup"><span data-stu-id="da520-138">WinRM server running on myComputer.myDomain.com.</span></span><br/>                         |
    | <span data-ttu-id="da520-139">WSMAN/ \* . mydomain.com</span><span class="sxs-lookup"><span data-stu-id="da520-139">WSMAN/\*.myDomain.com</span></span><br/>          | <span data-ttu-id="da520-140">Все серверы WinRM, работающие в myDomain.com.</span><span class="sxs-lookup"><span data-stu-id="da520-140">All WinRM servers running in myDomain.com.</span></span><br/>                               |
    | <span data-ttu-id="da520-141">WSMAN/ \* . fabrikam.mydomain.com</span><span class="sxs-lookup"><span data-stu-id="da520-141">WSMAN/\*.fabrikam.myDomain.com</span></span><br/> | <span data-ttu-id="da520-142">Все серверы WinRM, работающие в, на всех компьютерах в. fabrikam.myDomain.com.</span><span class="sxs-lookup"><span data-stu-id="da520-142">All WinRM servers running in on all computers in .fabrikam.myDomain.com.</span></span><br/> |

    

     

    <span data-ttu-id="da520-143">Дополнительные сведения о настройке групповых политик см. в разделе [Установка и настройка для служба удаленного управления Windows](installation-and-configuration-for-windows-remote-management.md).</span><span class="sxs-lookup"><span data-stu-id="da520-143">For more information about setting Group Policies, see [Installation and Configuration for Windows Remote Management](installation-and-configuration-for-windows-remote-management.md).</span></span>

    <span data-ttu-id="da520-144">Дополнительные сведения о политике **алловфрешкредентиалс** см. в описании политики, предоставляемой редактором групповая политика и [KB 951608](https://support.microsoft.com/kb/951608).</span><span class="sxs-lookup"><span data-stu-id="da520-144">For more information about the **AllowFreshCredentials** policy, see the policy description provided by the Group Policy editor and [KB 951608](https://support.microsoft.com/kb/951608).</span></span> <span data-ttu-id="da520-145">Политика **алловфрешкредентиалс** находится по следующему пути: конфигурация компьютера \\ Административные шаблоны \\ \\ Делегирование системных учетных данных.</span><span class="sxs-lookup"><span data-stu-id="da520-145">The **AllowFreshCredentials** policy is located at the following path: Computer Configuration\\Administrative Templates\\System\\Credentials Delegation.</span></span>

4.  <span data-ttu-id="da520-146">На сервере должен быть настроен [*прослушиватель*](windows-remote-management-glossary.md) HTTPS или HTTP.</span><span class="sxs-lookup"><span data-stu-id="da520-146">An HTTPS or HTTP [*listener*](windows-remote-management-glossary.md) must be configured on the server.</span></span> <span data-ttu-id="da520-147">Отпечаток сертификата, используемый для настройки *прослушивателя* HTTPS, также используется для настройки параметра CertificateThumbprint в параметрах службы WinRM.</span><span class="sxs-lookup"><span data-stu-id="da520-147">The certificate thumbprint used for configuring the HTTPS *listener* is also used to configure the CertificateThumbprint setting under the WinRM service settings.</span></span>

    <span data-ttu-id="da520-148">Следующая команда демонстрирует использование служебной программы WinRM для настройки [*прослушивателя*](windows-remote-management-glossary.md)HTTPS.</span><span class="sxs-lookup"><span data-stu-id="da520-148">The following command demonstrates how to use the winrm utility to configure an HTTPS [*listener*](windows-remote-management-glossary.md):</span></span>

    <span data-ttu-id="da520-149">**winrm quickconfig-Transport: HTTPS**</span><span class="sxs-lookup"><span data-stu-id="da520-149">**winrm quickconfig -transport:https**</span></span>

<span data-ttu-id="da520-150">Если проверка подлинности Kerberos между клиентом и сервером невозможна, пользователь должен настроить один из следующих параметров для поддержки нескольких прыжков:</span><span class="sxs-lookup"><span data-stu-id="da520-150">If Kerberos authentication between the client and server is not possible, the user must configure one of the following settings for multi-hop support:</span></span>

-   <span data-ttu-id="da520-151">Для повышения безопасности пользователь должен добавить атрибут **CertificateThumbprint** в параметр службы WinRM.</span><span class="sxs-lookup"><span data-stu-id="da520-151">For better security, the user should add the **CertificateThumbprint** attribute to the WinRM service setting.</span></span> <span data-ttu-id="da520-152">Если служба WinRM настроена с атрибутом **CertificateThumbprint** , служба пытается нахождение соответствующего сертификата в хранилище локального компьютера и использует этот сертификат для проверки подлинности CredSSP.</span><span class="sxs-lookup"><span data-stu-id="da520-152">If the WinRM service is configured with a **CertificateThumbprint** attribute, the service attempts to locate the corresponding certificate in the Local Machine store and uses this certificate for the CredSSP authentication.</span></span> <span data-ttu-id="da520-153">Если служба WinRM использует сертификат из хранилища локального компьютера для проверки подлинности сервера, учетной записи сетевой службы должен быть разрешен доступ к закрытому ключу сертификата.</span><span class="sxs-lookup"><span data-stu-id="da520-153">If the WinRM service uses a certificate from the Local Machine store to authenticate the server, the Network Service account must be allowed access to the private key of the certificate.</span></span>

    > [!Note]  
    > <span data-ttu-id="da520-154">Если параметр службы не настроен, сервер WinRM использует самозаверяющий сертификат, созданный в памяти для шифрования сообщений, отправляемых клиенту.</span><span class="sxs-lookup"><span data-stu-id="da520-154">If the service setting is not configured, the WinRM server uses a self-signed certificate that is created in memory to encrypt messages sent to the client.</span></span> <span data-ttu-id="da520-155">Однако этот сертификат не используется для проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="da520-155">However, this certificate is not used for authentication.</span></span>

     

-   <span data-ttu-id="da520-156">Если ни проверка подлинности Kerberos, ни отпечатки сертификатов не доступны, пользователь может включить проверку подлинности NTLM.</span><span class="sxs-lookup"><span data-stu-id="da520-156">If neither Kerberos authentication nor certificate thumbprints are available, the user can enable NTLM authentication.</span></span> <span data-ttu-id="da520-157">Если используется проверка подлинности NTLM, то должна быть включена политика разрешить новые учетные данные с проверкой подлинности сервера только в NTLM (**алловфрешкредентиалсвхеннтлмонли**), а в политику должно быть добавлено имя субъекта-службы с префиксом WSMan.</span><span class="sxs-lookup"><span data-stu-id="da520-157">If NTLM authentication is used, the Allow Fresh Credentials with NTLM-only Server Authentication (**AllowFreshCredentialsWhenNTLMOnly**) policy must be enabled, and an SPN with the WSMAN prefix must be added to the policy.</span></span> <span data-ttu-id="da520-158">Этот параметр менее безопасен, чем проверка подлинности Kerberos и отпечатки сертификата, так как учетные данные отправляются на сервер без проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="da520-158">This setting is less secure than both Kerberos authentication and certificate thumbprints, because credentials are sent to an unauthenticated server.</span></span>

    <span data-ttu-id="da520-159">Дополнительные сведения о политике **алловфрешкредентиалсвхеннтлмонли** см. в описании политики, предоставляемой редактором групповая политика и [KB 951608](https://support.microsoft.com/kb/951608).</span><span class="sxs-lookup"><span data-stu-id="da520-159">For more information about the **AllowFreshCredentialsWhenNTLMOnly** policy, see the policy description provided by the Group Policy editor and [KB 951608](https://support.microsoft.com/kb/951608).</span></span> <span data-ttu-id="da520-160">Политика **алловфрешкредентиалсвхеннтлмонли** находится по следующему пути: конфигурация компьютера \\ Административные шаблоны \\ \\ Делегирование системных учетных данных.</span><span class="sxs-lookup"><span data-stu-id="da520-160">The **AllowFreshCredentialsWhenNTLMOnly** policy is located at the following path: Computer Configuration\\Administrative Templates\\System\\Credentials Delegation.</span></span>

## <a name="using-credssp-authentication-with-explicit-credentials"></a><span data-ttu-id="da520-161">Использование проверки подлинности CredSSP с явными учетными данными</span><span class="sxs-lookup"><span data-stu-id="da520-161">Using CredSSP Authentication with Explicit Credentials</span></span>

<span data-ttu-id="da520-162">Пользователь может указать явные учетные данные по протоколам HTTP и HTTPS.</span><span class="sxs-lookup"><span data-stu-id="da520-162">A user can specify explicit credentials over both HTTP and HTTPS.</span></span> <span data-ttu-id="da520-163">Следующая команда демонстрирует использование служебной программы WinRM для выполнения удаленной операции с использованием проверки подлинности CredSSP с явными учетными данными по протоколу HTTPS:</span><span class="sxs-lookup"><span data-stu-id="da520-163">The following command demonstrates how to use the winrm utility to perform a remote operation using CredSSP authentication with explicit credentials over HTTPS:</span></span>

<span data-ttu-id="da520-164">**WinRM OPERATION — Remote: https://myMachine -authentication: CredSSP-имяпользователя: myUsername-Password: myPassword**</span><span class="sxs-lookup"><span data-stu-id="da520-164">**winrm OPERATION -remote:https://myMachine -authentication:CredSSP -username:myUsername -password:myPassword**</span></span>

 

