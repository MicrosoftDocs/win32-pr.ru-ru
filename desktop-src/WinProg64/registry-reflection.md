---
title: Отражение реестра
description: Перенаправитель реестра изолирует 32-разрядные и 64-разрядные приложения, предоставляя отдельные логические представления определенных частей реестра в эмуляторе WOW64. Однако значения некоторых разделов реестра должны быть одинаковыми в 32-разрядных и 64-битных представлениях.
ms.assetid: eac9038b-9f59-4ac7-8974-f94a4a62a257
keywords:
- отражение реестра 64-разрядное программирование для Windows
- отражение 64-разрядное программирование для Windows
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 523041004d9570bbdf101050e30f5d9139031913
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "105691588"
---
# <a name="registry-reflection"></a><span data-ttu-id="a5174-106">Отражение реестра</span><span class="sxs-lookup"><span data-stu-id="a5174-106">Registry Reflection</span></span>

<span data-ttu-id="a5174-107">\[Сведения в этом разделе относятся к Windows Server 2008, Windows Vista, Windows Server 2003 и Windows XP.</span><span class="sxs-lookup"><span data-stu-id="a5174-107">\[The information in this topic applies to Windows Server 2008, Windows Vista, Windows Server 2003, and Windows XP.</span></span> <span data-ttu-id="a5174-108">Начиная с Windows 7 и Windows Server 2008 R2, Подсистема WOW64 больше не использует отражение реестра, а ранее отраженные ключи являются общими.</span><span class="sxs-lookup"><span data-stu-id="a5174-108">Starting with Windows 7 and Windows Server 2008 R2, WOW64 no longer uses registry reflection and formerly reflected keys are shared instead.</span></span> <span data-ttu-id="a5174-109">Дополнительные сведения см. в разделе [разделы реестра, затрагиваемые WOW64](shared-registry-keys.md).\]</span><span class="sxs-lookup"><span data-stu-id="a5174-109">For more information, see [Registry Keys Affected by WOW64](shared-registry-keys.md).\]</span></span>

<span data-ttu-id="a5174-110">[Перенаправитель реестра](registry-redirector.md) изолирует 32-разрядные и 64-разрядные приложения, предоставляя отдельные логические представления определенных частей реестра в эмуляторе WOW64.</span><span class="sxs-lookup"><span data-stu-id="a5174-110">The [registry redirector](registry-redirector.md) isolates 32-bit and 64-bit applications by providing separate logical views of certain portions of the registry on WOW64.</span></span> <span data-ttu-id="a5174-111">Однако значения некоторых разделов реестра должны быть одинаковыми в 32-разрядных и 64-битных представлениях.</span><span class="sxs-lookup"><span data-stu-id="a5174-111">However, the values of some registry keys must be the same in both the 32-bit and 64-bit views.</span></span>

<span data-ttu-id="a5174-112">Процесс *отражения реестра* копирует разделы и значения реестра между двумя представлениями реестра, чтобы синхронизировать их.</span><span class="sxs-lookup"><span data-stu-id="a5174-112">The process of *registry reflection* copies registry keys and values between two registry views to keep them synchronized.</span></span> <span data-ttu-id="a5174-113">Каждое представление имеет отдельную физическую копию каждого отраженного раздела реестра, один для 32-разрядного представления реестра, а другой для 64-битного представления реестра.</span><span class="sxs-lookup"><span data-stu-id="a5174-113">Each view has a separate physical copy of each reflected registry key, one for the 32-bit registry view and the other for the 64-bit registry view.</span></span>

<span data-ttu-id="a5174-114">Отраженный ключ копируется при закрытии ключа путем вызова [**Ошибка RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey).</span><span class="sxs-lookup"><span data-stu-id="a5174-114">A reflected key is copied when a key is closed by calling [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey).</span></span> <span data-ttu-id="a5174-115">Обратите внимание, что это приводит к увеличению возможного состояния гонки: Если в нескольких процессах изменяется отраженный ключ, последний вызов **Ошибка RegCloseKey** определяет окончательное значение ключа.</span><span class="sxs-lookup"><span data-stu-id="a5174-115">Note that this gives rise to a possible race condition: if more than one process changes the reflected key, the last **RegCloseKey** call determines the key's final value.</span></span>

<span data-ttu-id="a5174-116">Отражатель копирует данные активации COM для локальных серверов между представлениями, но не копирует данные в процессе, так как 32/64 in-Process смешение данных не разрешено в 64-разрядной версии Windows.</span><span class="sxs-lookup"><span data-stu-id="a5174-116">The reflector copies COM activation data for Local servers between the views, but it does not copy in-process data because 32/64 in-process data mixing is not permitted on 64-bit Windows.</span></span>

<span data-ttu-id="a5174-117">Отражение не включено для общих разделов реестра или для разделов реестра, которые не перенаправляются.</span><span class="sxs-lookup"><span data-stu-id="a5174-117">Reflection is not enabled for shared registry keys or for registry keys that are not redirected.</span></span> <span data-ttu-id="a5174-118">Например, отражение не включено для **системного ключа hKey \_ локального \_ компьютера \\** .</span><span class="sxs-lookup"><span data-stu-id="a5174-118">For example, reflection is not enabled for the **HKEY\_LOCAL\_MACHINE\\System** key.</span></span> <span data-ttu-id="a5174-119">Список разделов реестра, которые перенаправлены, являются общими или отраженными, см. в разделе [разделы реестра, затрагиваемые WOW64](shared-registry-keys.md).</span><span class="sxs-lookup"><span data-stu-id="a5174-119">For a list of registry keys that are redirected, shared, or reflected, see [Registry Keys Affected by WOW64](shared-registry-keys.md).</span></span>

<span data-ttu-id="a5174-120">При отражении реестра используется политика "побеждает в последнюю очередь", как показано в следующем примере:</span><span class="sxs-lookup"><span data-stu-id="a5174-120">Registry reflection uses a "last writer wins" policy as illustrated in the following example:</span></span>

-   <span data-ttu-id="a5174-121">После завершения чистой установки 64-разрядной версии Windows 64-bit Wordpad.exe регистрируется для работы с файлами. doc.</span><span class="sxs-lookup"><span data-stu-id="a5174-121">After a clean installation of 64-bit Windows, 64-bit Wordpad.exe is registered to handle .doc files.</span></span> <span data-ttu-id="a5174-122">Отражатель копирует регистрацию doc из 64-разрядного представления реестра в представление реестра 32-bit.</span><span class="sxs-lookup"><span data-stu-id="a5174-122">The reflector copies the .doc registration from the 64-bit registry view into the 32-bit registry view.</span></span>
-   <span data-ttu-id="a5174-123">Администратор устанавливает 32-разрядную версию Office, которая регистрирует 32-разрядные Winword.exe для работы с Doc-файлами в представлении с реестром в 32 бит.</span><span class="sxs-lookup"><span data-stu-id="a5174-123">An administrator installs 32-bit Office, which registers 32-bit Winword.exe to handle .doc files in the 32-bit registry view.</span></span> <span data-ttu-id="a5174-124">Reflector в реестре копирует эту информацию в представление реестра 64-bit, поэтому оба 32-разрядных и 64-разрядных приложений запускают 32-разрядную версию Winword.exe для файлов. doc.</span><span class="sxs-lookup"><span data-stu-id="a5174-124">The registry reflector copies this information into the 64-bit registry view, so both 32-bit and 64-bit applications launch the 32-bit version of Winword.exe for .doc files.</span></span>
-   <span data-ttu-id="a5174-125">Администратор устанавливает 64-разрядную версию Office, которая регистрирует 64-разрядные Winword.exe для работы с Doc-файлами в представлении с реестром в 64 бит.</span><span class="sxs-lookup"><span data-stu-id="a5174-125">An administrator installs 64-bit Office, which registers 64-bit Winword.exe to handle .doc files in the 64-bit registry view.</span></span> <span data-ttu-id="a5174-126">Reflector в реестре копирует эту информацию в 32-разрядный реестр, поэтому оба 32-разрядных и 64-разрядных приложений запускают 64-разрядную версию Winword.exe для файлов. doc.</span><span class="sxs-lookup"><span data-stu-id="a5174-126">The registry reflector copies this information into the 32-bit registry, so both 32-bit and 64-bit applications launch the 64-bit version of Winword.exe for .doc files.</span></span>

<span data-ttu-id="a5174-127">Таким образом, сведения о сопоставлении файлов сохраняются для последнего установленного приложения.</span><span class="sxs-lookup"><span data-stu-id="a5174-127">Therefore, the file association information is preserved for the most recently installed application.</span></span>

<span data-ttu-id="a5174-128">Это может быть полезно для 32-разрядных и 64-разрядных приложений для совместного использования конкретных значений разделов реестра, которые обычно записываются в отдельные представления реестра.</span><span class="sxs-lookup"><span data-stu-id="a5174-128">It can be useful for 32-bit and 64-bit applications to share specific registry key values that are normally written to separate registry views.</span></span> <span data-ttu-id="a5174-129">Например, 32-разрядный сервер OLE, который может обслуживать запросы с 32-и 64-разрядных клиентов, может сделать его 32-разрядный доступ 64 к данным системного реестра.</span><span class="sxs-lookup"><span data-stu-id="a5174-129">For example, a 32-bit OLE server that can serve requests from both 32-bit and 64-bit clients could make its 32-bit registry data available to the 64-bit view of the system registry.</span></span>

<span data-ttu-id="a5174-130">Когда компонент записывает данные в системный реестр, WOW64 анализирует информацию и создает копию данных в альтернативном представлении реестра при необходимости.</span><span class="sxs-lookup"><span data-stu-id="a5174-130">When a component writes data in the system registry, WOW64 analyzes the information and makes a copy of the data in the alternate view of the registry when appropriate.</span></span> <span data-ttu-id="a5174-131">Как правило, этот процесс сохраняет две отдельные физические копии одних и тех же разделов реестра в обоих представлениях в реестре и называется отражением реестра или зеркальным отображением реестра.</span><span class="sxs-lookup"><span data-stu-id="a5174-131">Typically, this process keeps two separate physical copies of the same registry keys in both views in the registry, and is called registry reflection or registry mirroring.</span></span>

<span data-ttu-id="a5174-132">Большинство ключей в корне классов находятся в этой категории.</span><span class="sxs-lookup"><span data-stu-id="a5174-132">Most of the keys under the classes root are in this category.</span></span> <span data-ttu-id="a5174-133">Обновления ключей отражаются после завершения обновления и закрытия ключа.</span><span class="sxs-lookup"><span data-stu-id="a5174-133">Updates to the keys are reflected when the update completes and the handle to the key closes.</span></span> <span data-ttu-id="a5174-134">В определенных случаях запись в ключ не отражается, если у ключа есть зависимость разрядности.</span><span class="sxs-lookup"><span data-stu-id="a5174-134">In specific cases, writes to a key are not reflected if the key has some bitness dependency.</span></span> <span data-ttu-id="a5174-135">Например, 32-разрядный ключ InprocServer32 не относится к 64-разрядным приложениям, поэтому ключ InprocServer32 не отражается в представлении реестра 64-bit.</span><span class="sxs-lookup"><span data-stu-id="a5174-135">For example, the 32-bit InprocServer32 key is not relevant for 64-bit applications, so the InprocServer32 key is not reflected to the 64-bit registry view.</span></span> <span data-ttu-id="a5174-136">Однако 64-разрядные приложения могут использовать ключ 32-bit LocalServer32, а ключ LocalServer32 — отражен.</span><span class="sxs-lookup"><span data-stu-id="a5174-136">However, 64-bit applications can use the 32-bit LocalServer32 key and the LocalServer32 key gets reflected.</span></span>

<span data-ttu-id="a5174-137">Для **\_ классов " \_ \\ программное \\ обеспечение \\ на локальном компьютере" в hKey классы** CLSID и **hKey \_ текущие \_ пользовательские \\ классы программного обеспечения \\ \\ CLSID** отражаются только идентификаторы CLSID, не указывающие InprocServer32 или InprocHandler32.</span><span class="sxs-lookup"><span data-stu-id="a5174-137">For **HKEY\_LOCAL\_MACHINE\\Software\\Classes\\CLSID** and **HKEY\_CURRENT\_USER\\Software\\Classes\\CLSID**, only CLSIDs that do not specify InprocServer32 or InprocHandler32 are reflected.</span></span> <span data-ttu-id="a5174-138">Отражены только идентификаторы CLSID, так как они выполняются вне процесса и могут быть активированы с помощью 32 или 64-разрядных приложений.</span><span class="sxs-lookup"><span data-stu-id="a5174-138">Only LocalServer32 CLSIDs are reflected because they run out-of-process and can be activated by either 32- or 64-bit applications.</span></span> <span data-ttu-id="a5174-139">InProcServer32 CLSID не отражаются, так как невозможно загрузить 32-разрядную библиотеку DLL для выполнения в 64-разрядном процессе или 64-разрядную библиотеку DLL для выполнения в 32-разрядном процессе.</span><span class="sxs-lookup"><span data-stu-id="a5174-139">InProcServer32 CLSIDs are not reflected because it is not possible to load a 32-bit DLL for execution in a 64-bit process, or a 64-bit DLL for execution in a 32-bit process.</span></span>

<span data-ttu-id="a5174-140">Для **\_ \_ \\ классов программного обеспечения \\ \\ hKey на локальном компьютере AppID** и **hKey \_ текущие \_ пользовательские \\ классы программного обеспечения \\ \\ AppID**, значения реестра [дллсуррогате](../com/dllsurrogate.md) и [дллсуррогатиксекутабле]( ../com/dllsurrogateexecutable.md) не отражаются, если их значение является пустой строкой.</span><span class="sxs-lookup"><span data-stu-id="a5174-140">For **HKEY\_LOCAL\_MACHINE\\Software\\Classes\\Appid** and **HKEY\_CURRENT\_USER\\Software\\Classes\\Appid**, the [DllSurrogate](../com/dllsurrogate.md) and [DllSurrogateExecutable]( ../com/dllsurrogateexecutable.md) registry values are not reflected if their value is an empty string.</span></span>

<span data-ttu-id="a5174-141">Чтобы отключить и включить отражение реестра для определенного отраженного ключа, используйте функции [**регдисаблерефлектионкэй**](/windows/desktop/api/winreg/nf-winreg-regdisablereflectionkey) и [**реженаблерефлектионкэй**](/windows/desktop/api/winreg/nf-winreg-regenablereflectionkey) .</span><span class="sxs-lookup"><span data-stu-id="a5174-141">To disable and enable registry reflection for a particular reflected key, use the [**RegDisableReflectionKey**](/windows/desktop/api/winreg/nf-winreg-regdisablereflectionkey) and [**RegEnableReflectionKey**](/windows/desktop/api/winreg/nf-winreg-regenablereflectionkey) functions.</span></span> <span data-ttu-id="a5174-142">Эти функции не влияют на ключи, которые не находятся в списке отраженных ключей ранее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="a5174-142">These functions do not affect keys that are not on the list of reflected keys earlier in this topic.</span></span> <span data-ttu-id="a5174-143">Приложения должны отключать отражение только для разделов реестра, которые они создают, и не пытаться отключить отражение для стандартных ключей, таких как **hKey \_ локальный \_ компьютер** или **hKey \_ текущий \_ пользователь**.</span><span class="sxs-lookup"><span data-stu-id="a5174-143">Applications should disable reflection only for the registry keys that they create and not attempt to disable reflection for the predefined keys such as **HKEY\_LOCAL\_MACHINE** or **HKEY\_CURRENT\_USER**.</span></span> <span data-ttu-id="a5174-144">Чтобы определить, отключены ли ключи в списке отражения, используйте функцию [**регкуерирефлектионкэй**](/windows/desktop/api/winreg/nf-winreg-regqueryreflectionkey) .</span><span class="sxs-lookup"><span data-stu-id="a5174-144">To determine whether the keys on the reflection list have been disabled, use the [**RegQueryReflectionKey**](/windows/desktop/api/winreg/nf-winreg-regqueryreflectionkey) function.</span></span>

<span data-ttu-id="a5174-145">Отраженные ключи не следует использовать в операциях реестра с поддержкой транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5174-145">Reflected keys should not be used in transacted registry operations.</span></span> <span data-ttu-id="a5174-146">Запись в отраженные ключи во время транзакции может привести к сбою транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5174-146">Writing to reflected keys during a transaction can cause the transaction to fail.</span></span> <span data-ttu-id="a5174-147">Дополнительные сведения о транзакциях см. в разделе [Диспетчер транзакций ядра](/windows/desktop/Ktm/kernel-transaction-manager-portal).</span><span class="sxs-lookup"><span data-stu-id="a5174-147">For more information about transactions, see [Kernel Transaction Manager](/windows/desktop/Ktm/kernel-transaction-manager-portal).</span></span>

## <a name="related-topics"></a><span data-ttu-id="a5174-148">См. также</span><span class="sxs-lookup"><span data-stu-id="a5174-148">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="a5174-149">Перенаправитель реестра</span><span class="sxs-lookup"><span data-stu-id="a5174-149">Registry Redirector</span></span>](registry-redirector.md)
</dt> <dt>

[<span data-ttu-id="a5174-150">Отражение реестра в Windows</span><span class="sxs-lookup"><span data-stu-id="a5174-150">Registry Reflection in Windows</span></span>](/windows-hardware/drivers/display/microsoft-windows-vista-display-driver-64-bit-issues)
</dt> <dt>

[<span data-ttu-id="a5174-151">Разделы реестра, относящиеся к WOW64</span><span class="sxs-lookup"><span data-stu-id="a5174-151">Registry Keys Affected by WOW64</span></span>](shared-registry-keys.md)
</dt> </dl>

 

 