---
title: Сведения о реализации WOW64
description: Эмулятор WOW64 работает в пользовательском режиме.
ms.assetid: 93daf9d0-dfdb-42c3-8c3d-397b21991e83
keywords:
- WOW64 64-разрядное программирование Windows, переменные среды
- WOW64 64-разрядное программирование Windows, реализация
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4c7d095369b883171e39bffd4dc629b7f80a7f39
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "104134062"
---
# <a name="wow64-implementation-details"></a><span data-ttu-id="e855d-105">Сведения о реализации WOW64</span><span class="sxs-lookup"><span data-stu-id="e855d-105">WOW64 Implementation Details</span></span>

<span data-ttu-id="e855d-106">Эмулятор WOW64 работает в пользовательском режиме.</span><span class="sxs-lookup"><span data-stu-id="e855d-106">The WOW64 emulator runs in user mode.</span></span> <span data-ttu-id="e855d-107">Он предоставляет интерфейс между 32-разрядной версией Ntdll.dll и ядром процессора и перехватывает вызовы ядра.</span><span class="sxs-lookup"><span data-stu-id="e855d-107">It provides an interface between the 32-bit version of Ntdll.dll and the kernel of the processor, and it intercepts kernel calls.</span></span> <span data-ttu-id="e855d-108">Эмулятор WOW64 состоит из следующих библиотек DLL:</span><span class="sxs-lookup"><span data-stu-id="e855d-108">The WOW64 emulator consists of the following DLLs:</span></span>

-   <span data-ttu-id="e855d-109">Wow64.dll предоставляет основную инфраструктуру эмуляции и Преобразователи для функций Ntoskrnl.exe точки входа.</span><span class="sxs-lookup"><span data-stu-id="e855d-109">Wow64.dll provides the core emulation infrastructure and the thunks for the Ntoskrnl.exe entry-point functions.</span></span>
-   <span data-ttu-id="e855d-110">Wow64Win.dll предоставляет преобразователи для функций Win32k.sys точки входа.</span><span class="sxs-lookup"><span data-stu-id="e855d-110">Wow64Win.dll provides thunks for the Win32k.sys entry-point functions.</span></span>
-   <span data-ttu-id="e855d-111">(только x64) Wow64Cpu.dll обеспечивает поддержку для запуска программ x86 на x64.</span><span class="sxs-lookup"><span data-stu-id="e855d-111">(x64 only) Wow64Cpu.dll provides support for running x86 programs on x64.</span></span>
-   <span data-ttu-id="e855d-112">(Только для Intel Itanium) IA32Exec. bin содержит программный эмулятор x86.</span><span class="sxs-lookup"><span data-stu-id="e855d-112">(Intel Itanium only) IA32Exec.bin contains the x86 software emulator.</span></span>
-   <span data-ttu-id="e855d-113">(Только Intel Itanium) Wowia32x.dll предоставляет интерфейс между IA32Exec. bin и WOW64.</span><span class="sxs-lookup"><span data-stu-id="e855d-113">(Intel Itanium only) Wowia32x.dll provides the interface between IA32Exec.bin and WOW64.</span></span>
-   <span data-ttu-id="e855d-114">(Только ARM64) xtajit.dll содержит эмулятор программного обеспечения x86.</span><span class="sxs-lookup"><span data-stu-id="e855d-114">(ARM64 only) xtajit.dll contains the x86 software emulator.</span></span>
-   <span data-ttu-id="e855d-115">(Только ARM64) wowarmw.dll обеспечивает поддержку запуска программ ARM32 на ARM64.</span><span class="sxs-lookup"><span data-stu-id="e855d-115">(ARM64 only) wowarmw.dll provides support for running ARM32 programs on ARM64.</span></span>

<span data-ttu-id="e855d-116">Эти библиотеки DLL, а также 64-разрядная версия Ntdll.dll являются единственными 64-разрядными двоичными файлами, которые можно загрузить в 32-разрядный процесс.</span><span class="sxs-lookup"><span data-stu-id="e855d-116">These DLLs, along with the 64-bit version of Ntdll.dll, are the only 64-bit binaries that can be loaded into a 32-bit process.</span></span> <span data-ttu-id="e855d-117">В Windows 10 на ARM двоичные файлы ЧПЕ (скомпилированные гибридные переносимые исполняемые файлы) также могут быть загружены в 32-разрядный процесс x86.</span><span class="sxs-lookup"><span data-stu-id="e855d-117">On Windows 10 on ARM, CHPE (Compiled Hybrid Portable Executable) binaries may also be loaded into an x86 32-bit process.</span></span>

<span data-ttu-id="e855d-118">При запуске Wow64.dll загружает версию x86 Ntdll.dll (или версию ЧПЕ, если она включена) и выполняет свой код инициализации, который загружает все необходимые 32-разрядные библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="e855d-118">At startup, Wow64.dll loads the x86 version of Ntdll.dll (or the CHPE version, if enabled) and runs its initialization code, which loads all necessary 32-bit DLLs.</span></span> <span data-ttu-id="e855d-119">Почти все 32-разрядные библиотеки DLL являются немодифицированными копиями 32-разрядных двоичных файлов Windows, хотя некоторые из них загружаются как ЧПЕ по соображениям производительности.</span><span class="sxs-lookup"><span data-stu-id="e855d-119">Almost all 32-bit DLLs are unmodified copies of 32-bit Windows binaries, though some are loaded as CHPE for performance reasons.</span></span> <span data-ttu-id="e855d-120">Некоторые из этих библиотек DLL ведут себя по-разному для WOW64, чем в 32-разрядной Windows, обычно потому что они совместно используют память с 64-разрядными компонентами системы.</span><span class="sxs-lookup"><span data-stu-id="e855d-120">Some of these DLLs are written to behave differently on WOW64 than they do on 32-bit Windows, usually because they share memory with 64-bit system components.</span></span> <span data-ttu-id="e855d-121">Все адресное пространство пользовательского режима свыше 32-разрядного предела резервируется системой.</span><span class="sxs-lookup"><span data-stu-id="e855d-121">All user-mode address space above the 32-bit limit is reserved by the system.</span></span> <span data-ttu-id="e855d-122">Дополнительные сведения см. [в разделе Использование производительности и памяти в эмуляторе WOW64](performance-and-memory-consumption.md).</span><span class="sxs-lookup"><span data-stu-id="e855d-122">For more information, see [Performance and Memory Consumption under WOW64](performance-and-memory-consumption.md).</span></span>

<span data-ttu-id="e855d-123">Вместо использования последовательности вызовов системной службы x86, 32-разрядных двоичных файлов, которые делают системные вызовы, перестраиваются для использования пользовательской последовательности вызова.</span><span class="sxs-lookup"><span data-stu-id="e855d-123">Instead of using the x86 system-service call sequence, 32-bit binaries that make system calls are rebuilt to use a custom calling sequence.</span></span> <span data-ttu-id="e855d-124">Эта последовательность вызова недорога для перехвата WOW64, так как она полностью находится в пользовательском режиме.</span><span class="sxs-lookup"><span data-stu-id="e855d-124">This calling sequence is inexpensive for WOW64 to intercept because it remains entirely in user mode.</span></span> <span data-ttu-id="e855d-125">При обнаружении пользовательской последовательности вызовов ЦП WOW64 возвращается в собственный 64-разрядный режим и вызывается в Wow64.dll.</span><span class="sxs-lookup"><span data-stu-id="e855d-125">When the custom calling sequence is detected, the WOW64 CPU transitions back to native 64-bit mode and calls into Wow64.dll.</span></span> <span data-ttu-id="e855d-126">Преобразователь выполняется в пользовательском режиме, чтобы снизить воздействие на 64-разрядное ядро и снизить риск ошибки в преобразователе, которая может привести к сбою в режиме ядра, повреждению данных или бреши в безопасности.</span><span class="sxs-lookup"><span data-stu-id="e855d-126">Thunking is done in user mode to reduce the impact on the 64-bit kernel and to reduce the risk of a bug in the thunk that might cause a kernel-mode crash, data corruption, or a security hole.</span></span> <span data-ttu-id="e855d-127">Преобразователи извлекают аргументы из 32-битного стека, расширяют их до 64 бит, а затем выполняют собственный системный вызов.</span><span class="sxs-lookup"><span data-stu-id="e855d-127">The thunks extract arguments from the 32-bit stack, extend them to 64 bits, then make the native system call.</span></span>

## <a name="environment-variables"></a><span data-ttu-id="e855d-128">Переменные среды</span><span class="sxs-lookup"><span data-stu-id="e855d-128">Environment Variables</span></span>

<span data-ttu-id="e855d-129">При создании 32-разрядного процесса с помощью 64-разрядного процесса или при создании 64-bit процесса в 32-разрядном процессе WOW64 устанавливает переменные среды для созданного процесса, как показано в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="e855d-129">When a 32-bit process is created by a 64-bit process, or when a 64-bit process is created by a 32-bit process, WOW64 sets the environment variables for the created process as shown in the following table.</span></span>



| <span data-ttu-id="e855d-130">Процесс</span><span class="sxs-lookup"><span data-stu-id="e855d-130">Process</span></span>                   | <span data-ttu-id="e855d-131">Переменные среды</span><span class="sxs-lookup"><span data-stu-id="e855d-131">Environment variables</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|---------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="e855d-132">64-разрядный процесс</span><span class="sxs-lookup"><span data-stu-id="e855d-132">64-bit process</span></span><br/> | <span data-ttu-id="e855d-133">\_Архитектура процессора = amd64 или \_ архитектура процессора = ia64 или \_ архитектура процессора = ARM64</span><span class="sxs-lookup"><span data-stu-id="e855d-133">PROCESSOR\_ARCHITECTURE=AMD64 or PROCESSOR\_ARCHITECTURE=IA64 or PROCESSOR\_ARCHITECTURE=ARM64</span></span><br/> <span data-ttu-id="e855d-134">ProgramFiles =% ProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="e855d-134">ProgramFiles=%ProgramFiles%</span></span><br/> <span data-ttu-id="e855d-135">ProgramW6432 =% ProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="e855d-135">ProgramW6432=%ProgramFiles%</span></span><br/> <span data-ttu-id="e855d-136">CommonProgramFiles =% CommonProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="e855d-136">CommonProgramFiles=%CommonProgramFiles%</span></span><br/> <span data-ttu-id="e855d-137">CommonProgramW6432 =% CommonProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="e855d-137">CommonProgramW6432=%CommonProgramFiles%</span></span><br/> <span data-ttu-id="e855d-138">Windows **server 2008, Windows Vista, Windows server 2003 и Windows XP:** Переменные среды ProgramW6432 и CommonProgramW6432 были добавлены начиная с Windows 7 и Windows Server 2008 R2.</span><span class="sxs-lookup"><span data-stu-id="e855d-138">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** The ProgramW6432 and CommonProgramW6432 environment variables were added starting with Windows 7 and Windows Server 2008 R2.</span></span> <br/> |
| <span data-ttu-id="e855d-139">32-разрядный процесс</span><span class="sxs-lookup"><span data-stu-id="e855d-139">32-bit process</span></span><br/> | <span data-ttu-id="e855d-140">\_Архитектура процессора = x86</span><span class="sxs-lookup"><span data-stu-id="e855d-140">PROCESSOR\_ARCHITECTURE=x86</span></span><br/> <span data-ttu-id="e855d-141">ПРОЦЕССОР \_ ARCHITEW6432 =% \_ архитектура процессора%</span><span class="sxs-lookup"><span data-stu-id="e855d-141">PROCESSOR\_ARCHITEW6432=%PROCESSOR\_ARCHITECTURE%</span></span><br/> <span data-ttu-id="e855d-142">ProgramFiles =% ProgramFiles (x86)%</span><span class="sxs-lookup"><span data-stu-id="e855d-142">ProgramFiles=%ProgramFiles(x86)%</span></span><br/> <span data-ttu-id="e855d-143">ProgramW6432 =% ProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="e855d-143">ProgramW6432=%ProgramFiles%</span></span><br/> <span data-ttu-id="e855d-144">CommonProgramFiles =% CommonProgramFiles (x86)%</span><span class="sxs-lookup"><span data-stu-id="e855d-144">CommonProgramFiles=%CommonProgramFiles(x86)%</span></span><br/> <span data-ttu-id="e855d-145">CommonProgramW6432 =% CommonProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="e855d-145">CommonProgramW6432=%CommonProgramFiles%</span></span><br/>                                                                                                                                                                                                                  |



 

## <a name="global-hooks"></a><span data-ttu-id="e855d-146">Глобальные перехватчики</span><span class="sxs-lookup"><span data-stu-id="e855d-146">Global Hooks</span></span>

<span data-ttu-id="e855d-147">Функцию [**сетвиндовшукекс**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa) можно использовать для внедрения библиотеки DLL в другой процесс при соблюдении следующих условий.</span><span class="sxs-lookup"><span data-stu-id="e855d-147">The [**SetWindowsHookEx**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa) function can be used to inject a DLL into another process if the following conditions are met:</span></span>

-   <span data-ttu-id="e855d-148">32-разрядную библиотеку DLL можно внедрить только в 32-разрядный процесс, а 64-разрядную библиотеку DLL можно внедрить только в 64-разрядный процесс.</span><span class="sxs-lookup"><span data-stu-id="e855d-148">A 32-bit DLL can be injected only into a 32-bit process, and a 64-bit DLL can be injected only into a 64-bit process.</span></span> <span data-ttu-id="e855d-149">Невозможно внедрить 32-разрядную библиотеку DLL в 64-разрядный процесс или наоборот.</span><span class="sxs-lookup"><span data-stu-id="e855d-149">It is not possible to inject a 32-bit DLL into a 64-bit process or vice versa.</span></span>
-   <span data-ttu-id="e855d-150">32-разрядные и 64-разрядные библиотеки DLL должны иметь разные имена.</span><span class="sxs-lookup"><span data-stu-id="e855d-150">The 32-bit and 64-bit DLLs must have different names.</span></span>
-   <span data-ttu-id="e855d-151">Архитектуры библиотеки DLL и процесса должны совпадать.</span><span class="sxs-lookup"><span data-stu-id="e855d-151">The architectures of the DLL and the process must match.</span></span> <span data-ttu-id="e855d-152">Например, нельзя внедрить 32-разрядную DLL x86 в процесс с 32-разрядной ARM.</span><span class="sxs-lookup"><span data-stu-id="e855d-152">For instance, you cannot inject a 32-bit x86 DLL into a 32-bit ARM process.</span></span>

<span data-ttu-id="e855d-153">Дополнительные сведения см. в разделе [**сетвиндовшукекс**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa).</span><span class="sxs-lookup"><span data-stu-id="e855d-153">For more information, see [**SetWindowsHookEx**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa).</span></span>

<span data-ttu-id="e855d-154">Имейте в виду, что в потоке, в котором установлен обработчик, а не поток, обрабатывающий обработчик, можно вызывать такие возможности, как ввод в **\_ Журнал \***, что позволяет использовать **\_ оболочку** и низкоуровневые обработчики. **\_** **\_**</span><span class="sxs-lookup"><span data-stu-id="e855d-154">Be aware that the **WH\_MOUSE**, **WH\_KEYBOARD**, **WH\_JOURNAL\***, **WH\_SHELL**, and low-level hooks can be called on the thread that installed the hook rather than the thread processing the hook.</span></span> <span data-ttu-id="e855d-155">Для этих обработчиков возможно, что будут вызываться как 32-разрядные, так и 64-разрядные обработчики, если 32-разрядный обработчик впереди в цепочке прерываний до 64-разрядного обработчика.</span><span class="sxs-lookup"><span data-stu-id="e855d-155">For these hooks, it is possible that both the 32-bit and 64-bit hooks will be called if a 32-bit hook is ahead of a 64-bit hook in the hook chain.</span></span> <span data-ttu-id="e855d-156">Дополнительные сведения см. [в разделе Использование перехватчиков](../winmsg/using-hooks.md).</span><span class="sxs-lookup"><span data-stu-id="e855d-156">For more information, see [Using Hooks](../winmsg/using-hooks.md).</span></span>

 

