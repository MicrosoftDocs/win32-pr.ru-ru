---
title: Проблемы реализации поставщиков ADSI
description: Проблемы реализации поставщиков ADSI
ms.assetid: 0be772aa-e7d8-4d34-b55a-162abfb0bfd4
ms.tgt_platform: multiple
keywords:
- Проблемы реализации поставщиков ADSI ADSI
- поставщики ADSI, реализация
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c4c362b04244580e448e7bb7bd78889e66db12fe
ms.sourcegitcommit: b0ebdefc3dcd5c04bede94091833aa1015a2f95c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2020
ms.locfileid: "104413748"
---
# <a name="implementation-issues-for-adsi-providers"></a>Проблемы реализации поставщиков ADSI

Чтобы реализовать интерфейсы ADSI, сначала реализуйте COM-интерфейс [**идиректорйобжект**](/windows/desktop/api/Iads/nn-iads-idirectoryobject). Предоставляя этот интерфейс как минимальный уровень издержек, вы предоставляете клиентским приложениям элемент управления, необходимый для доступа к объектам каталога непосредственно из каталога, а не через кэш ADSI, что оптимизирует производительность сети. Использование этого интерфейса также предоставит собственную реализацию с наибольшей гибкостью.

Во вторых, реализуйте основные интерфейсы интерфейса ADSI, [**iAds**](/windows/desktop/api/Iads/nn-iads-iads), [**иадсконтаинер**](/windows/desktop/api/Iads/nn-iads-iadscontainer), [**иадсколлектион**](/windows/desktop/api/Iads/nn-iads-iadscollection)и [**иадспропертивалуе**](/windows/desktop/api/Iads/nn-iads-iadspropertyvalue), [**иадспропертентри**](/windows/desktop/api/Iads/nn-iads-iadspropertyentry), [**иадспропертилист**](/windows/desktop/api/Iads/nn-iads-iadspropertylist) свойства кэша свойств. [**Иадсграуп**](/windows/desktop/api/Iads/nn-iads-iadsgroup) и [**иадсмемберс**](/windows/desktop/api/Iads/nn-iads-iadsmembers) также являются интерфейсами частого спроса на программное обеспечение системного администрирования.

В третьих, реализуйте интерфейсы управления схемой, если ваша служба каталогов имеет базовую схему: [**иадскласс**](/windows/desktop/api/Iads/nn-iads-iadsclass), [**иадспроперти**](/windows/desktop/api/Iads/nn-iads-iadsproperty), [**иадссинтакс**](/windows/desktop/api/Iads/nn-iads-iadssyntax). Если базовая схема отсутствует, используйте эти интерфейсы для абстракции классов и свойств, используемых службой каталогов. Схемы можно использовать для публикации функций службы каталогов в клиентах ADSI.

## <a name="collections"></a>Коллекции

Компоненты поставщика ADSI могут следовать одной из трех моделей для кэширования коллекций во время перечисления. Выбор модели кэширования определяет поведение ADSI при удалении объекта из коллекции из базовой службы каталогов, внешней для ADSI.

К моделям кэширования относятся:

-   Предварительно кэшированные коллекции. Коллекция экземпляров объектов извлекается из базовой службы каталогов целиком при вызове [**иадсколлектион:: Get \_ \_ NewEnum**](/windows/desktop/api/Iads/nf-iads-iadscollection-get__newenum) для создания нового объекта перечислителя. Если исходный объект для экземпляра объекта Active Directory в извлеченной коллекции удаляется из базовой службы каталогов, клиент не распознает удаление до тех пор, пока не попытается получить доступ к коллекции с помощью методов [**iAds:: info**](/windows/desktop/api/Iads/nf-iads-iads-getinfo) или [**iAds:: сетинфо**](/windows/desktop/api/Iads/nf-iads-iads-setinfo) .
-   Коллекции с инкрементным кэшированием. Коллекция извлекается из базовой службы каталогов по одному объекту за раз, когда вызывается [**IEnumVARIANT:: Next**](/windows/win32/api/oaidl/nf-oaidl-ienumvariant-next) . [**IEnumVARIANT:: Reset**](/windows/win32/api/oaidl/nf-oaidl-ienumvariant-reset) вернет в начало коллекции в Cache, а **IEnumVARIANT:: Next** вернет кэшированные объекты до достижения конца кэша, после чего новые объекты будут добавлены из базового хранилища. Когда экземпляр объекта Active Directory находится в кэше, клиент не будет осведомлен о его удалении из базовой службы каталогов до тех пор, пока не попытается получить доступ к объекту с помощью параметра [**iAds::**](/windows/desktop/api/Iads/nf-iads-iads-getinfo) [**сетинфо или iAds::.**](/windows/desktop/api/Iads/nf-iads-iads-setinfo)
-   Коллекции не кэшированы. Коллекция извлекается из базовой службы каталогов по одному объекту за раз, когда вызывается [**IEnumVARIANT:: Next**](/windows/win32/api/oaidl/nf-oaidl-ienumvariant-next) . [**IEnumVARIANT:: Reset**](/windows/win32/api/oaidl/nf-oaidl-ienumvariant-reset) вернет в начало коллекции в базовом хранилище. Операции **IEnumVARIANT:: Next** и **IEnumVARIANT:: Reset** не могут получать удаленные объекты, так как объекты извлекаются по запросу из базовой службы каталогов. Кэшируется только текущий объект; Если текущий объект удален, клиент не будет осведомлен о его удалении из базовой службы каталогов до тех пор, пока не попытается получить доступ к объекту с помощью методов [**iAds::**](/windows/desktop/api/Iads/nf-iads-iads-getinfo) [**сетинфо или iAds::.**](/windows/desktop/api/Iads/nf-iads-iads-setinfo)

Независимо от модели кэширования следует помнить, что перечисление ADSI возвращает Active Directory интерфейсы службы вызывающему объекту. Чтобы избежать издержек при получении нового указателя на интерфейс, приложения ADSI должны кэшировать возвращаемые указатели интерфейса для объектов, которыми они предназначены. Например, приложение Visual Basic, которое перечисляет контейнер и заполняет список именами, может кэшировать указатели интерфейса, связанные с именами, для последующего использования. Такой подход обеспечит большую производительность, чем заполнение списка во время перечисления и получение нового указателя интерфейса при выборе пользователем.

## <a name="about-dispatch-ids"></a>Сведения об идентификаторах диспетчеризации

[**IDispatch**](/previous-versions/windows/desktop/automat/implementing-the-idispatch-interface) — это интерфейс автоматизации, определенный com для контроллеров, которые не используют интерфейсы COM напрямую. Доступ к объекту через **IDispatch** называется доступом с привязкой имени или с поздним связыванием, так как он происходит во время выполнения ("поздно") и использует строковые имена свойств и методов для разрешения ссылок ("имя"). Во время выполнения клиенты передают строковое имя свойства или метода, которые они хотят вызывать в метод [**IDispatch:: GetIdsOfNames**](/windows/win32/api/oaidl/nf-oaidl-idispatch-getidsofnames)(). Если свойство или метод существует в объекте, извлекается идентификатор диспетчеризации (DISPID) соответствующей функции. Затем DISPID используется для выполнения функции с помощью [**IDispatch:: Invoke**](/windows/win32/api/oaidl/nf-oaidl-idispatch-invoke)(). При использовании **интерфейса IDispatch** свойства и методы в интерфейсах, предоставляемых одним объектом, отображаются в виде плоского списка. Поскольку доступ с ограниченным именем требует двух вызовов функций, он менее эффективен, чем непосредственное использование COM-интерфейса. Клиентам рекомендуется использовать COM-интерфейсы ADSI для объектов, когда необходимо учитывать производительность. Расширенные контроллеры автоматизации, такие как Visual Basic 4,0, могут вызывать другие COM-интерфейсы, а также **IDispatch**, если интерфейсы соответствуют ограничениям автоматизации для типов данных и передачи параметров.

Поставщики ADSI создают идентификаторы DISPID динамически для каждого объекта Active Directory. Идентификаторы DISPID, полученные с помощью [**IDispatch:: GetIdsOfNames**](/windows/win32/api/oaidl/nf-oaidl-idispatch-getidsofnames) для заданного объекта, являются сгенерированными значениями, но не значениями, которые находятся в IDL для объекта. Пользователи [**IDispatch**](/previous-versions/windows/desktop/automat/implementing-the-idispatch-interface) должны вызывать **GetIDsOfNames** для получения допустимых идентификаторов DispId во время выполнения.

## <a name="type-information-and-type-libraries"></a>Сведения о типах и библиотеки типов

Пакет SDK для ADSI предоставляет библиотеку типов Активедс. tlb, которая документирует все стандартные интерфейсы, поддерживаемые интерфейсом ADSI. Поставщик должен предоставить схожую библиотеку типов для всех интерфейсов, найденных в Активедс. tlb, а также все дополнительные данные типа для интерфейсов, реализованных в компоненте поставщика.

Ниже приведен пример кода на IDL.

``` syntax
[ object, uuid(IID_IADsXYZ), oleautomation, dual ]
interface IADsXYZ: IDispatch
{
// Read-only properties.
[propget]
HRESULT AReadOnlyProp ([out, retval]BSTR *pbstrAReadOnlyProp);
 
// Read/write properties.
[propget]
HRESULT AReadWriteProp ([out, retval]long *plAReadWriteProp);
[propput]
HRESULT AReadWriteProp ([in]long lAReadWriteProp);
 
// Methods.
HRESULT AMethod ([in]DATE dateInParameter,
[out, retval]BSTR *pbstrReturnValue);
};
```

## <a name="thread-safety"></a>Потокобезопасность

Модель COM описывает следующие три модели потоков. Приложения COM указывают, какая модель используется при инициализации библиотеки COM с помощью функций [**CoInitialize**](/windows/win32/api/objbase/nf-objbase-coinitialize) и [**CoInitializeEx**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializeex) :

-   Единый поток. Однопотоковая модель предполагает выполнение одного потока выполнения в процессе. в дальнейшем предполагается, что для структур данных COM в процессе не требуется сериализация доступа.
-   Потоковое подразделение. COM-объект связан с потоком, создавшим его. Вызовы к объекту в другом потоке должны выполняться потоком, создавшим этот объект. Для этого исходный поток вызывает прокси клиента, который упорядочивает вызов метода и доставляет его в функцию-заглушку сервера в целевом потоке через очередь сообщений Win32, связанную с целевым потоком.
-   Свободная организация потоков. Предполагается, что COM-объекты являются потокобезопасными. Нескольким потокам разрешен доступ к любому объекту в процессе без сериализации.

ADSI не предполагает какую бы то ни было какую бы модель потоков. Модули записи компонентов поставщика должны использовать модель бессрочных потоков и гарантировать согласованность их внутренних структур данных, защищая их от ненадежного потока, то есть с несогласованными обновлениями с помощью объектов синхронизации, таких как критические разделы или семафоры.

## <a name="object-locking"></a>Блокировка объектов

ADSI не накладывает или не определяет схему блокировки объектов. Поставщики пространств имен, поддерживающих сериализацию доступа с помощью блокировки, могут предоставлять базовую схему блокировки через расширения, зависящие от поставщика, для ADSI.

## <a name="property-names-within-a-schema"></a>Имена свойств в схеме

ADSI представляет свойства как объекты свойств в контейнере схемы ADSI. Для этого необходимо, чтобы имена свойств были уникальными в пределах каждого контейнера схемы. Поставщик должен убедиться в отсутствии конфликтов имен.

## <a name="primary-interface"></a>Основной интерфейс

Если поставщик не может найти интерфейс, который должен быть возвращен в качестве основного интерфейса, возвращается **IID \_ iAds** . Это обеспечивает доступ с ограниченным именем ко всем свойствам объекта через [**IDispatch**](/previous-versions/windows/desktop/automat/implementing-the-idispatch-interface) и методы [**iAds:: Get**](/windows/desktop/api/Iads/nf-iads-iads-get), [**iAds:: жетекс**](/windows/desktop/api/Iads/nf-iads-iads-getex), [**iads::P UT**](/windows/desktop/api/Iads/nf-iads-iads-put)и [**iAds::P утекс**](/windows/desktop/api/Iads/nf-iads-iads-putex) .

 

 