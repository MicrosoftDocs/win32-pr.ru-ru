---
description: В этом разделе объясняется, как выполнять задачи, связанные с интерфейсом нескольких документов.
ms.assetid: 024744d3-362f-4162-8d0a-d4dac61de808
title: Использование интерфейса нескольких документов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b5e24aed7abc3640b441345520203c8a02e025e8
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105656685"
---
# <a name="using-the-multiple-document-interface"></a>Использование интерфейса нескольких документов

В этом разделе описывается выполнение следующих задач.

-   [Регистрация дочерних классов и окон фрейма](#registering-child-and-frame-window-classes)
-   [Создание фрейма и дочерних окон](#creating-frame-and-child-windows)
-   [Написание основного цикла сообщений](#writing-the-main-message-loop)
-   [Написание процедуры окна фрейма](#writing-the-frame-window-procedure)
-   [Написание процедуры дочернего окна](#writing-the-child-window-procedure)
-   [Создание дочернего окна](#creating-a-child-window)

Чтобы проиллюстрировать эти задачи, в этом разделе содержатся примеры из Мултипад, типичного приложения многодокументного интерфейса (MDI).

## <a name="registering-child-and-frame-window-classes"></a>Регистрация дочерних классов и окон фрейма

Обычное приложение MDI должно зарегистрировать два класса окон: одно для окна фрейма и одно для его дочерних окон. Если приложение поддерживает несколько типов документов (например, электронную таблицу и диаграмму), оно должно зарегистрировать класс окна для каждого типа.

Структура класса для фрейма окна аналогична структуре класса для главного окна в приложениях, не являющихся приложениями MDI. Структура класса для дочерних окон MDI немного отличается от структуры дочерних окон в приложениях, отличных от MDI, следующим образом:

-   Структура класса должна иметь значок, так как пользователь может максимально ограничить дочернее окно MDI так, как будто оно было обычным окном приложения.
-   Имя меню должно быть **равно NULL**, так как дочернее окно MDI не может иметь собственное меню.
-   Структура класса должна резервировать дополнительное пространство в структуре окна. С помощью этого пространства приложение может связывать данные, например имя файла, с конкретным дочерним окном.

В следующем примере показано, как Мултипад регистрирует свои фреймы и дочерние классы окон.


```
BOOL WINAPI InitializeApplication() 
{ 
    WNDCLASS wc; 
 
    // Register the frame window class. 
 
    wc.style         = 0; 
    wc.lpfnWndProc   = (WNDPROC) MPFrameWndProc; 
    wc.cbClsExtra    = 0; 
    wc.cbWndExtra    = 0; 
    wc.hInstance     = hInst; 
    wc.hIcon         = LoadIcon(hInst, IDMULTIPAD); 
    wc.hCursor       = LoadCursor((HANDLE) NULL, IDC_ARROW); 
    wc.hbrBackground = (HBRUSH) (COLOR_APPWORKSPACE + 1); 
    wc.lpszMenuName  = IDMULTIPAD; 
    wc.lpszClassName = szFrame; 
 
    if (!RegisterClass (&wc) ) 
        return FALSE; 
 
    // Register the MDI child window class. 
 
    wc.lpfnWndProc   = (WNDPROC) MPMDIChildWndProc; 
    wc.hIcon         = LoadIcon(hInst, IDNOTE); 
    wc.lpszMenuName  = (LPCTSTR) NULL; 
    wc.cbWndExtra    = CBWNDEXTRA; 
    wc.lpszClassName = szChild; 
 
    if (!RegisterClass(&wc)) 
        return FALSE; 
 
    return TRUE; 
} 
```



## <a name="creating-frame-and-child-windows"></a>Создание фрейма и дочерних окон

После регистрации классов окон приложение MDI может создать его окна. Сначала он создает окно фрейма с помощью функции [**CreateWindow**](/windows/win32/api/winuser/nf-winuser-createwindowa) или [**CreateWindowEx**](/windows/win32/api/winuser/nf-winuser-createwindowexa) . После создания окна фрейма приложение создает его клиентское окно с помощью **CreateWindow** или **CreateWindowEx**. Приложение должно указывать МДИКЛИЕНТ в качестве имени класса клиентского окна; **Мдиклиент** — это предварительно зарегистрированный класс окна, определенный системой. Параметр *Лпвпарам* **CreateWindow** или **CreateWindowEx** должен указывать на структуру [**клиенткреатеструкт**](/windows/win32/api/winuser/ns-winuser-clientcreatestruct) . Эта структура содержит элементы, описанные в следующей таблице.



| Член           | Описание                                                                                                                                                                                                                                                                                                           |
|------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **хвиндовмену**  | Обработано меню окон, используемое для управления дочерними окнами MDI. После создания дочерних окон приложение добавляет свои заголовки в меню окно в виде пунктов меню. Пользователь может активировать дочернее окно, щелкнув его заголовок в меню окно.                                                               |
| **идфирстчилд** | Задает идентификатор первого дочернего окна MDI. Этому идентификатору назначается Первое созданное дочернее окно MDI. Дополнительные окна создаются с увеличивающимися идентификаторами окон. При уничтожении дочернего окна система немедленно переназначит идентификаторы окон, чтобы они оставались непрерывными. |



 

Когда в меню окно добавляется заголовок дочернего окна, система присваивает идентификатор дочернему окну. Когда пользователь щелкает заголовок дочернего окна, окно фрейма получает сообщение [**\_ команды WM**](../menurc/wm-command.md) с идентификатором в параметре *wParam* . Необходимо указать значение для элемента **идфирстчилд** , который не конфликтует с идентификаторами элементов меню в меню окна фрейма.

Процедура окна фрейма мултипад создает клиентское окно MDI при обработке сообщения [**о \_ создании WM**](wm-create.md) . В следующем примере показано, как создается клиентское окно.


```
case WM_CREATE: 
    { 
        CLIENTCREATESTRUCT ccs; 
 
        // Retrieve the handle to the window menu and assign the 
        // first child window identifier. 
 
        ccs.hWindowMenu = GetSubMenu(GetMenu(hwnd), WINDOWMENU); 
        ccs.idFirstChild = IDM_WINDOWCHILD; 
 
        // Create the MDI client window. 
 
        hwndMDIClient = CreateWindow( "MDICLIENT", (LPCTSTR) NULL, 
            WS_CHILD | WS_CLIPCHILDREN | WS_VSCROLL | WS_HSCROLL, 
            0, 0, 0, 0, hwnd, (HMENU) 0xCAC, hInst, (LPSTR) &ccs); 
 
        ShowWindow(hwndMDIClient, SW_SHOW); 
    } 
    break; 
```



Названия дочерних окон добавляются в нижнюю часть меню окно. Если приложение добавляет строки в меню окно с помощью функции [**аппендмену**](/windows/win32/api/winuser/nf-winuser-appendmenua) , эти строки могут быть перезаписаны заголовками дочерних окон при перерисовки меню окна (при создании или уничтожении дочернего окна). Приложение MDI, добавляющее строки в меню окна, должно использовать функцию [**инсертмену**](/windows/win32/api/winuser/nf-winuser-insertmenua) и проверять, что заголовки дочерних окон не переписаны эти новые строки.

Используйте стиль **WS \_ клипчилдрен** , чтобы создать окно клиента MDI, чтобы предотвратить Рисование окна поверх его дочерних окон.

## <a name="writing-the-main-message-loop"></a>Написание основного цикла сообщений

Основной цикл обработки сообщений приложения MDI аналогичен сочетанию клавиш для работы с ускорителями, которые не обрабатываются в приложении MDI. Разница заключается в том, что цикл обработки сообщений MDI вызывает функцию [**транслатемдисисакцел**](/windows/win32/api/winuser/nf-winuser-translatemdisysaccel) перед проверкой для определенных приложением сочетаний клавиш или перед отправкой сообщения.

В следующем примере показан цикл обработки сообщений типичного приложения MDI. Обратите внимание, что при возникновении ошибки во внешнем [**сообщении**](/windows/win32/api/winuser/nf-winuser-getmessage) может возвращаться значение-1.


```
MSG msg;
BOOL bRet;

while ((bRet = GetMessage(&msg, (HWND) NULL, 0, 0)) != 0)
{
    if (bRet == -1)
    {
        // handle the error and possibly exit
    }
    else 
    { 
        if (!TranslateMDISysAccel(hwndMDIClient, &msg) && 
                !TranslateAccelerator(hwndFrame, hAccel, &msg))
        { 
            TranslateMessage(&msg); 
            DispatchMessage(&msg); 
        } 
    } 
}
```



Функция [**транслатемдисисакцел**](/windows/win32/api/winuser/nf-winuser-translatemdisysaccel) преобразует сообщения [**WM \_ KeyDown**](../inputdev/wm-keydown.md) в сообщения [**WM \_ сискомманд**](../menurc/wm-syscommand.md) и ОТПРАВЛЯЕТ их в активное дочернее окно MDI. Если сообщение не является сообщением ускорителя MDI, функция возвращает **значение false**, в этом случае приложение использует функцию [**TranslateAccelerator**](/windows/win32/api/winuser/nf-winuser-translateacceleratora) , чтобы определить, были ли нажаты какие-либо из определенных приложением сочетаний клавиш. Если нет, цикл отправляет сообщение в соответствующую процедуру окна.

## <a name="writing-the-frame-window-procedure"></a>Написание процедуры окна фрейма

Оконная процедура окна фрейма MDI похожа на окно главного окна приложения, не являющегося окном MDI. Разница заключается в том, что процедура окна фрейма передает все сообщения, которые она не обрабатывает, в функцию [**деффрамепрок**](/windows/win32/api/winuser/nf-winuser-defframeproca) , а не на функцию [**дефвиндовпрок**](/windows/desktop/api/winuser/nf-winuser-defwindowproca) . Кроме того, процедура окна фрейма также должна передавать некоторые сообщения, которые она обрабатывает, в том числе перечисленные в следующей таблице.



| Сообщение                                  | Ответ                                                                                                                                                                                                                                                            |
|------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**\_команда WM**](../menurc/wm-command.md)     | Активирует дочернее окно MDI, выбранное пользователем. Это сообщение отправляется, когда пользователь выбирает дочернее окно MDI в меню окно окна фрейма MDI. Идентификатор окна, сопровождающего это сообщение, определяет дочернее окно MDI, которое должно быть активировано. |
| [**WM \_ менучар**](../menurc/wm-menuchar.md)   | Открывает меню окно активного дочернего окна MDI, когда пользователь нажимает сочетание клавиш ALT + – (минус).                                                                                                                                                      |
| [**WM \_ SETFOCUS**](../inputdev/wm-setfocus.md) | Передает фокус клавиатуры окну клиента MDI, которое, в свою очередь, передает его в активное дочернее окно MDI.                                                                                                                                                         |
| [**\_Размер WM**](wm-size.md)              | Изменяет размер окна клиента MDI, чтобы оно поместилось в клиентскую область окна нового фрейма. Если процедура окна фрейма изменяет размер окна клиента MDI на другой, он не должен передавать сообщение в функцию [**дефвиндовпрок**](/windows/desktop/api/winuser/nf-winuser-defwindowproca) .                   |



 

Процедура окна фрейма в Мултипад называется Мпфрамевндпрок. Обработка других сообщений с помощью Мпфрамевндпрок аналогична обработке приложений, не относящихся к MDI. [**WM \_ КОМАНДные**](../menurc/wm-command.md) сообщения в мултипад обрабатываются локально определенной функцией коммандхандлер. Для командных сообщений Мултипад не обрабатывается, Коммандхандлер вызывает функцию [**деффрамепрок**](/windows/win32/api/winuser/nf-winuser-defframeproca) . Если Мултипад не использует **деффрамепрок** по умолчанию, пользователь не сможет активировать дочернее окно из меню окно, так как **сообщение \_ команды WM** , отправленное щелчком пункта меню окна, будет потеряно.

## <a name="writing-the-child-window-procedure"></a>Написание процедуры дочернего окна

Как и процедура окна фрейма, процедура дочернего окна MDI использует специальную функцию для обработки сообщений по умолчанию. Все сообщения, не обрабатываемые процедурой дочернего окна, должны передаваться в функцию [**дефмдичилдпрок**](/windows/win32/api/winuser/nf-winuser-defmdichildproca) , а не в функцию [**дефвиндовпрок**](/windows/desktop/api/winuser/nf-winuser-defwindowproca) . Кроме того, некоторые сообщения управления окнами должны передаваться в **дефмдичилдпрок**, даже если приложение обрабатывает сообщение, чтобы интерфейс MDI правильно функционировал. Ниже приведены сообщения, которые приложение должно передать в **дефмдичилдпрок**.



| Сообщение                                       | Ответ                                                                                                                                                                                                                                                  |
|-----------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**WM \_ чилдактивате**](wm-childactivate.md) | Выполняет обработку активации при изменении размера, перемещении или отображении дочерних окон MDI. Это сообщение должно быть передано.                                                                                                                                        |
| [**WM \_ жетминмаксинфо**](wm-getminmaxinfo.md) | Вычисляет размер развернутого дочернего окна MDI на основе текущего размера окна клиента MDI.                                                                                                                                                  |
| [**WM \_ менучар**](../menurc/wm-menuchar.md)        | Передает сообщение в окно фрейма MDI.                                                                                                                                                                                                               |
| [**\_Перемещение WM**](wm-move.md)                   | Повторно вычисляет полосы прокрутки клиента MDI, если они есть.                                                                                                                                                                                                 |
| [**WM \_ SETFOCUS**](../inputdev/wm-setfocus.md)      | Активирует дочернее окно, если оно не является активным дочерним окном MDI.                                                                                                                                                                                     |
| [**\_Размер WM**](wm-size.md)                   | Выполняет операции, необходимые для изменения размера окна, особенно для максимизации или восстановления дочернего окна MDI. Сбой передачи этого сообщения функции [**дефмдичилдпрок**](/windows/win32/api/winuser/nf-winuser-defmdichildproca) дает очень нежелательные результаты. |
| [**WM \_ сискомманд**](../menurc/wm-syscommand.md)    | Обрабатывает команды меню окна (ранее известные как системные): **SC \_ некствиндов**, **SC \_ преввиндов**, **SC \_ Move**, **SC \_ size** и **SC \_**.                                                                                                        |



 

## <a name="creating-a-child-window"></a>Создание дочернего окна

Чтобы создать дочернее окно MDI, приложение может либо вызвать функцию [**креатемдивиндов**](/windows/win32/api/winuser/nf-winuser-createmdiwindowa) , либо отправить сообщение [**\_ мдикреате WM**](wm-mdicreate.md) в окно клиента MDI. (Приложение может использовать функцию [**CreateWindowEx**](/windows/win32/api/winuser/nf-winuser-createwindowexa) с стилем **WS \_ ex \_ МДИЧИЛД** для создания дочерних окон MDI.) Однопотоковое приложение MDI может использовать любой из этих методов для создания дочернего окна. Поток в многопоточном приложении MDI должен использовать функцию **креатемдивиндов** или **CreateWindowEx** для создания дочернего окна в другом потоке.

Параметр *lParam* сообщения [**WM \_ мдикреате**](wm-mdicreate.md) является дальней указателем на структуру [**мдикреатеструкт**](/windows/win32/api/winuser/ns-winuser-mdicreatestructa) . Структура включает четыре элемента измерения: **x** и **y**, которые указывают горизонтальное и вертикальное положение окна, а также **CX** и **CY**, которые указывают горизонтальные и вертикальные экстенты окна. Любой из этих членов может быть явно назначен приложением или для них может быть задано значение **\_ Уседефаулт во Вт**. в этом случае система выбирает в соответствии с каскадным алгоритмом расположение, размер или и то, и другое. В любом случае необходимо инициализировать все четыре члена. Для всех измерений мултипад использует **\_ Уседефаулт во Вт** .

Последним элементом структуры [**мдикреатеструкт**](/windows/win32/api/winuser/ns-winuser-mdicreatestructa) является элемент **Style** , который может содержать биты стиля для окна. Чтобы создать дочернее окно MDI, которое может иметь любое сочетание стилей окна, укажите стиль окна **мдис \_ аллчилдстилес** . Если этот стиль не указан, дочернее окно MDI имеет стили **WS \_ Minimize**, **WS \_ максимизации**, **WS \_ HSCROLL** и **WS \_ VSCROLL** в качестве параметров по умолчанию.

Мултипад создает дочерние окна MDI, используя локально определенную функцию AddFile (расположенную в исходном файле МПФИЛЕ. C). Функция AddFile задает заголовок дочернего окна, присваивая элементу **сзтитле** структуры [**мдикреатеструкт**](/windows/win32/api/winuser/ns-winuser-mdicreatestructa) окна либо имя редактируемого файла, либо "без названия". Элементу **сзкласс** присваивается имя класса дочернего окна MDI, зарегистрированное в функции инитиализеаппликатион мултипад. Для элемента **ховнер** задается экземпляр приложения.

В следующем примере показана функция AddFile в Мултипад.


```
HWND APIENTRY AddFile(pName) 
TCHAR * pName; 
{ 
    HWND hwnd; 
    TCHAR sz[160]; 
    MDICREATESTRUCT mcs; 
 
    if (!pName) 
    { 
 
        // If the pName parameter is NULL, load the "Untitled" 
        // string from the STRINGTABLE resource and set the szTitle 
        // member of MDICREATESTRUCT. 
 
        LoadString(hInst, IDS_UNTITLED, sz, sizeof(sz)/sizeof(TCHAR)); 
        mcs.szTitle = (LPCTSTR) sz; 
    } 
    else 
 
        // Title the window with the full path and filename, 
        // obtained by calling the OpenFile function with the 
        // OF_PARSE flag, which is called before AddFile(). 
 
        mcs.szTitle = of.szPathName; 
 
    mcs.szClass = szChild; 
    mcs.hOwner  = hInst; 
 
    // Use the default size for the child window. 
 
    mcs.x = mcs.cx = CW_USEDEFAULT; 
    mcs.y = mcs.cy = CW_USEDEFAULT; 
 
    // Give the child window the default style. The styleDefault 
    // variable is defined in MULTIPAD.C. 
 
    mcs.style = styleDefault; 
 
    // Tell the MDI client window to create the child window. 
 
    hwnd = (HWND) SendMessage (hwndMDIClient, WM_MDICREATE, 0, 
        (LONG) (LPMDICREATESTRUCT) &mcs); 
 
    // If the file is found, read its contents into the child 
    // window's client area. 
 
    if (pName) 
    { 
        if (!LoadFile(hwnd, pName)) 
        { 
 
            // Cannot load the file; close the window. 
 
            SendMessage(hwndMDIClient, WM_MDIDESTROY, 
                (DWORD) hwnd, 0L); 
        } 
    } 
    return hwnd; 
} 
```



Указатель, переданный в параметре *lParam* сообщения [**WM \_ мдикреате**](wm-mdicreate.md) , передается в функцию [**CreateWindow**](/windows/win32/api/winuser/nf-winuser-createwindowa) и отображается как первый элемент в структуре [**CREATESTRUCT**](/windows/win32/api/winuser/ns-winuser-createstructa) , переданный в сообщении [**WM \_ CREATE**](wm-create.md) . В Мултипад дочернее окно инициализируется автоматически во время обработки сообщений обработчиком **WM \_** , путем инициализации переменных документа в дополнительных данных и создания дочернего окна редактирования элемента управления.

 

 
