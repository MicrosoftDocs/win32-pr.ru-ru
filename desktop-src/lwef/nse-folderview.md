---
title: Реализация представления папок
description: Оболочка Windows предоставляет стандартную реализацию представления папок разговорной речи, известного как Дефвиев, что позволяет избежать большей части работы по реализации расширения пространства имен.
ms.assetid: 8c6712d8-c3cb-4450-8277-3a8675622651
keywords:
- Объект представления папки
- ишеллвиев
- Ишеллбровсер, объекты представления папок
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 48c7b86d587154a034f276d4bdab903e5337ed4b
ms.sourcegitcommit: 469b6de41e2a565b7ead231d7f282ec4071ac158
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/11/2020
ms.locfileid: "104414024"
---
# <a name="implementing-a-folder-view"></a>Реализация представления папок

Оболочка Windows предоставляет стандартную реализацию представления папок разговорной речи, известного как Дефвиев, что позволяет избежать большей части работы по реализации расширения пространства имен. Поскольку некоторые функции представления не могут быть реализованы с помощью пользовательских представлений, часто рекомендуется использовать объект представления системной папки по умолчанию вместо пользовательского представления. Дополнительные сведения см. в разделе [**шкреатешеллфолдервиев**](/windows/desktop/api/shlobj_core/nf-shlobj_core-shcreateshellfolderview). В оставшейся части этого раздела обсуждается реализация пользовательского представления папки, которое не поддерживает новые функции представления.

В отличие от древовидного представления, проводник Windows не управляет содержимым представления папок. Вместо этого в окне представления папок размещается дочернее окно, предоставляемое объектом Folder. Объект Folder отвечает за создание объекта представления папок для отображения содержимого папки в дочернем окне.

Ключом к реализации объекта представления папки является интерфейс [**ишеллвиев**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellview) . Этот интерфейс используется проводником Windows для связи с объектом представления папки. Перед отображением представления папок проводник Windows вызывает метод [**ишеллфолдер:: креатевиевобжект**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-createviewobject) объекта Folder с параметром *riid* , равным IID \_ ишеллвиев. Создайте объект представления папки и возвратите его интерфейс **ишеллвиев** . Объект представления папок должен затем создать дочернее окно в окне представления папок и использовать дочернее окно для отображения сведений о содержимом папки.

Помимо управления отображением данных, расширения также могут настраивать ряд функций проводника Windows. Например, расширение может добавлять элементы на панель инструментов или в строку меню или отображать сведения в строке состояния.

-   [Объект представления папки](#the-folder-view-object)
-   [Инициализация объекта представления папки](#initializing-the-folder-view-object)
-   [Отображение представления папок](#displaying-the-folder-view)
-   [Реализация Ишеллвиев](#implementing-ishellview)
    -   [аддпропертишитпажес](#addpropertysheetpages)
    -   [жеткуррентинфо](#getcurrentinfo)
    -   [Обновить](#refresh)
    -   [SaveViewState](#saveviewstate)
    -   [транслатеацелератор](#translateacelerator)
-   [Использование Ишеллбровсер для взаимодействия с проводником Windows](#using-ishellbrowser-to-communicate-with-windows-explorer)
    -   [Изменение строки меню проводника Windows](#modifying-the-windows-explorer-menu-bar)
    -   [Изменение панели инструментов проводника Windows](#modifying-the-windows-explorer-toolbar)
    -   [Изменение строки состояния проводника Windows](#modifying-the-windows-explorer-status-bar)
    -   [Хранение сведений, относящихся к представлению](#storing-view-specific-information)

## <a name="the-folder-view-object"></a>Объект представления папки

Объект представления папок — это объект модели COM, предоставляющий интерфейс [**ишеллвиев**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellview) . Этот объект отвечает за:

-   Создание дочернего окна в окне представления папок и его использование для отображения содержимого папки.
-   Обработка связи с проводником Windows.
-   Добавление команд для конкретных папок в строку меню и панель инструментов проводника Windows и обработка этих команд при их выборе.
-   Управление взаимодействием пользователей с окном представления папок, например отображение контекстных меню или обработка операций перетаскивания.

В этом документе обсуждаются первые три раздела. Так как пользователь взаимодействует с представлением папки в дочернем окне, объект представления папки отвечает за его обработку так же, как и для любого другого окна.

Проводник Windows запрашивает объект представления папки, вызывая для объекта папки [**ишеллфолдер:: креатевиевобжект**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellfolder-createviewobject) с *riid* , равным IID \_ ишеллвиев. Процедура создания представления папок:

1.  Объект Folder создает новый экземпляр объекта представления папок и возвращает указатель на его интерфейс [**ишеллвиев**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellview) .
2.  Проводник Windows Инициализирует объект представления папки, вызывая метод [**ишеллвиев:: креатевиеввиндов**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-createviewwindow) . Создайте дочернее окно окна представления папок и верните его маркер в проводник Windows.
3.  Объект представления папок использует интерфейс [**Ишеллбровсер**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellbrowser) проводника для настройки панели инструментов проводника Windows, строки меню и строки состояния.
4.  Объект представления папки отображает содержимое папки в дочернем окне.
5.  Объект представления папок обрабатывает взаимодействие пользователя с представлением папки и любой панелью инструментов или элементами меню для конкретной папки.

## <a name="initializing-the-folder-view-object"></a>Инициализация объекта представления папки

Проводник Windows Инициализирует объект представления папки, вызывая метод [**ишеллвиев:: креатевиеввиндов**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-createviewwindow) . Параметры метода предоставляют объекту представления папки сведения, необходимые для создания дочернего окна, которое будет использоваться для отображения содержимого папки.

-   Указатель на интерфейс [**ишеллвиев**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellview) предыдущего объекта представления папки. Этому параметру можно присвоить **значение NULL**.
-   Структура [**фолдерсеттингс**](/windows/desktop/api/shobjidl_core/ns-shobjidl_core-foldersettings) , содержащая параметры предыдущего представления папки.
-   Указатель на интерфейс [**Ишеллбровсер**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellbrowser) проводника Windows.
-   Структура [Rect](/previous-versions//ms536136(v=vs.85)) с размерами окна представления папок.

Метод [**ишеллвиев:: креатевиеввиндов**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-createviewwindow) вызывается перед уничтожением предыдущего объекта представления папки. Таким образом, указатель интерфейса [**ишеллвиев**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellview) позволяет взаимодействовать с предыдущим объектом представления папки. Этот интерфейс в основном полезен, если предыдущая папка принадлежала расширению и использовала ту же схему вывода. В этом случае можно взаимодействовать с предыдущим объектом представления папки для таких целей, как обмен закрытыми параметрами.

Простой способ определить, принадлежит ли [**ишеллвиев**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellview) указатель к своему расширению, заключается в том, что все объекты представления папок предоставляют частный интерфейс. Вызовите метод [ишеллвиев:: QueryInterface](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) , чтобы запросить частный интерфейс, и изучите возвращаемое значение, чтобы определить, является ли объект представления папки одним из ваших. Затем можно использовать для обмена информацией частный метод этого интерфейса.

Структура [**фолдерсеттингс**](/windows/desktop/api/shobjidl_core/ns-shobjidl_core-foldersettings) содержит параметры отображения предыдущего представления папки. Основным параметром является режим просмотра: крупный значок, маленький значок, список или сведения. Также имеется флаг, который содержит параметры различных параметров отображения, например, должно ли представление быть вычислено по левому краю. Чтобы обеспечить пользователям единообразное взаимодействие при переходе из одной папки в другую, для просмотра папки должны быть доступны эти параметры. Эту структуру следует хранить и обновлять при изменении параметров. Проводник Windows вызывает [**ишеллвиев:: жеткуррентинфо**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-getcurrentinfo) , чтобы получить самое последнее значение этой структуры перед открытием следующего представления папки.

Интерфейс [**ишеллбровсер**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellbrowser) предоставляется проводником Windows. Этот интерфейс является вспомогательным для [**ишеллвиев**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellview) и позволяет объекту представления папки взаимодействовать с проводником Windows. Нет другого способа получить этот указатель на интерфейс, поэтому объект представления папки должен сохранить его для последующего использования. В частности, необходимо вызвать [ишеллбровсер:: Onwindow](/windows/win32/api/oleidl/nf-oleidl-iolewindow-getwindow) , чтобы получить окно представления родительской папки, которое будет использоваться для создания дочернего окна. Обратите внимание, что метод Ишеллбровсер::-Window не включен в документацию **ишеллбровсер** , так как он унаследован от [иолевиндов](/windows/win32/api/oleidl/nn-oleidl-iolewindow). После сохранения указателя интерфейса не забудьте вызвать метод [ишеллбровсер:: AddRef](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) , чтобы увеличить число ссылок интерфейса. Если интерфейс больше не нужен, вызовите [ишеллбровсер:: Release](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).

Чтобы создать дочернее окно, сделайте следующее:

1.  Изучите структуры [**фолдерсеттингс**](/windows/desktop/api/shobjidl_core/ns-shobjidl_core-foldersettings) и [Rect](/previous-versions//ms536136(v=vs.85)) .
2.  При необходимости получите частные настройки из предыдущего объекта представления папки.
3.  Вызовите [ишеллбровсер:: Onwindow](/windows/win32/api/oleidl/nf-oleidl-iolewindow-getwindow) , чтобы получить окно представления родительской папки.
4.  Создайте дочерний элемент для окна представления папок, полученного на предыдущем шаге, и верните его в проводник Windows.

## <a name="displaying-the-folder-view"></a>Отображение представления папок

После создания дочернего окна и возврата его в проводник Windows можно отобразить содержимое папки. Как правило, расширения отображают свою информацию, размещающий узел дочернего окна — [элемент управления представления списка](../controls/list-view-control-reference.md) или **элемент управления WebBrowser**. Элемент управления "представление списка" позволяет реплицировать [классический вид](web-view.md)проводника Windows. Элемент управления WebBrowser позволяет использовать динамический HTML (DHTML) для отображения информации, подобно веб-представлению проводника Windows. Дополнительные сведения см. в документации по этим элементам управления.

Окно представления папок всегда существует, даже если оно не имеет фокуса. Поэтому необходимо поддерживать три состояния для своего дочернего окна:

-   Активировано с фокусом. Представление папки создано и имеет фокус. Задать строку меню или элементы панели инструментов, соответствующие определенному состоянию.
-   Активирован без фокусировки. Представление папки создано и активно, но не имеет фокуса. Задать строку меню или элементы панели инструментов, подходящие для нефокусного состояния. Пропускать любые элементы, относящиеся к выделению элементов в представлении папки.
-   Деактивирован. Представление папки будет уничтожено. Удаление всех пунктов меню, относящихся к папке.

Проводник Windows уведомляет объект представления папки при изменении состояния окна путем вызова [**ишеллвиев:: уиактивате**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-uiactivate). В свою очередь, объект представления папок должен уведомлять проводник Windows о том, что пользователь активирует окно представления папки, вызывая [**ишеллбровсер:: онвиеввиндовактиве**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-onviewwindowactive). Дополнительные сведения об этом интерфейсе см. [в статье Использование ишеллбровсер для взаимодействия с проводником Windows](#using-ishellbrowser-to-communicate-with-windows-explorer).

Пока представление папки активно, необходимо обработать все сообщения Windows, например [ \_ Размер WM](../winmsg/wm-size.md), который принадлежит дочернему окну. Процедура окна также будет принимать [ \_ Командные сообщения WM](../menurc/wm-command.md) для всех элементов, добавленных в строку меню или панель инструментов проводника Windows.

После создания представления папок проводник Windows вызывает интерфейс [**ишеллвиев**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellview) объекта представления папки для передачи ему разнообразной информации. Объект должен соответствующим образом изменить его отображение. Когда представление папки собирается уничтожиться, проводник Windows уведомляет объект представления папки, вызвав его метод [**ишеллвиев::D естройвиеввиндов**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-destroyviewwindow) .

## <a name="implementing-ishellview"></a>Реализация Ишеллвиев

После создания объекта Folder проводник Windows вызывает различные методы [**ишеллвиев**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellview) для запроса информации или уведомления объекта об изменении в состоянии проводника Windows. В этом разделе описано, как реализовать эти методы **ишеллвиев** . Остальные методы используются в более специализированных целях, например в диалоговом окне Открыть общий файл. Дополнительные сведения см. в документации по **ишеллвиев** .

### <a name="addpropertysheetpages"></a>аддпропертишитпажес

Когда пользователь выбирает **Параметры папки** в меню **Сервис** проводника Windows, отображается страница свойств, позволяющая пользователю изменять параметры папки. Проводник Windows вызывает метод [**ишеллвиев:: аддпропертишитпажес**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-addpropertysheetpages) объекта представления папки, чтобы можно было добавить страницу в эту вкладку свойств.

Проводник Windows передает указатель на функцию обратного вызова [аддпропшитпажепрок](/windows/win32/api/prsht/nc-prsht-lpfnaddpropsheetpage) в параметре *лпфн* объекта [**ишеллвиев:: аддпропертишитпажес**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-addpropertysheetpages). Вызовите [креатепропертишитпаже](/windows/win32/api/prsht/nf-prsht-createpropertysheetpagea) , чтобы создать страницу, а затем вызовите аддпропшитпажепрок, чтобы добавить ее в страницу свойств. Дополнительные сведения об обработке страниц свойств см. в статье [страницы свойств](../controls/property-sheets.md).

### <a name="getcurrentinfo"></a>жеткуррентинфо

Когда пользователь переключается из одной папки в другую, проводник Windows пытается сохранить аналогичное представление папки. Например, если в предыдущем представлении папки были показаны крупные значки, то также следует и следующее. Когда проводник Windows вызывает [**ишеллвиев:: креатевиеввиндов**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-createviewwindow) для инициализации объекта представления папки, метод получает структуру [**фолдерсеттингс**](/windows/desktop/api/shobjidl_core/ns-shobjidl_core-foldersettings) . Эта структура содержит сведения, позволяющие сделать представление папки совместимым с предыдущим представлением папки.

Чтобы обеспечить соответствие следующего представления текущему представлению, сохраните структуру [**фолдерсеттингс**](/windows/desktop/api/shobjidl_core/ns-shobjidl_core-foldersettings) . Если представление изменяется, например, с большого до мелких значков, соответствующим образом обновите структуру. Перед переключением представлений проводник Windows вызовите [**ишеллвиев:: жеткуррентинфо**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-getcurrentinfo) , чтобы запросить текущие значения **фолдерсеттингс** , чтобы передать их в следующий объект представления папки.

### <a name="refresh"></a>Обновить

Пользователь может убедиться, что представление папки отражает текущее состояние папки, выбрав пункт **Обновить** в меню **вид** или нажав клавишу F5. Когда пользователь делает это, проводник Windows вызывает метод [**ишеллвиев:: Refresh**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-refresh) . Объект представления папок должен немедленно обновить отображение представления папок.

### <a name="saveviewstate"></a>SaveViewState

Проводник Windows вызывает метод [**ишеллвиев:: SaveViewState**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-saveviewstate) для запроса объекта представления папки на сохранение состояния представления. Затем можно восстановить состояние при следующем просмотре этой папки. Предпочтительным способом сохранения состояния представления является вызов метода [**ишеллбровсер:: жетвиевстатестреам**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-getviewstatestream) . Этот метод возвращает интерфейс [IStream](/windows/win32/api/objidl/nn-objidl-istream) , который объект представления папки может использовать для сохранения своего состояния. При создании другого представления папок можно вызвать тот же метод **ишеллбровсер:: жетвиевстатестреам** , чтобы получить указатель IStream, позволяющий считывать параметры, сохраненные в предыдущих представлениях папок.

### <a name="translateacelerator"></a>транслатеацелератор

Когда пользователь нажимает клавишу, проводник Windows передает сообщение в объект представления папок путем вызова [**ишеллвиев:: TranslateAccelerator**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-translateaccelerator). Возвращает \_ значение false, чтобы Проводник Windows обрабатывал сообщение. Если объект представления папки обработал сообщение, возвращается значение S \_ OK.

Когда окно представления папок находится в фокусе, проводник Windows вызывает [**ишеллвиев:: TranslateAccelerator**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-translateaccelerator) перед обработкой сообщения. Так как большинство сообщений обычно связаны с панелью меню или командами панели инструментов проводника Windows, объект представления папки должен обычно возвращать \_ значение false. Проводник Windows может обработать сообщение в обычном режиме. Вернуть \_ значение ОК, только если сообщение зависит от папки и вы не хотите, чтобы Проводник Windows пройдет дальнейшую обработку. Если представление папки не имеет фокуса, проводник Windows сначала обрабатывает сообщение. Он вызывает [**ишеллбровсер:: транслатеакцелераторсб**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-translateacceleratorsb) только в том случае, если он не обрабатывает сообщение.

## <a name="using-ishellbrowser-to-communicate-with-windows-explorer"></a>Использование Ишеллбровсер для взаимодействия с проводником Windows

Интерфейс [**ишеллбровсер**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellbrowser) используется объектом представления папок для взаимодействия с проводником Windows в различных целях, в том числе:

-   [Изменение строки меню проводника Windows](#modifying-the-windows-explorer-menu-bar)
-   [Изменение панели инструментов проводника Windows](#modifying-the-windows-explorer-toolbar)
-   [Изменение строки состояния проводника Windows](#modifying-the-windows-explorer-status-bar)
-   [Хранение сведений, относящихся к представлению](#storing-view-specific-information)

### <a name="modifying-the-windows-explorer-menu-bar"></a>Изменение строки меню проводника Windows

Панель меню проводника Windows позволяет пользователю запускать разнообразные команды. По умолчанию в строке меню поддерживаются только команды, характерные для проводника Windows. Соответствующие [ \_ Командные сообщения WM](../menurc/wm-command.md) обрабатываются проводником Windows и не передаются в объект представления папок. Однако можно изменить строку меню, включив в нее один или несколько элементов меню для конкретной папки с помощью [**ишеллбровсер**](/windows/desktop/api/shobjidl_core/nn-shobjidl_core-ishellbrowser). Проводник Windows передает связанные с ними \_ Командные сообщения WM в процедуру окна объекта папки для обработки. Можно также удалить или отключить любые стандартные команды, которые не применяются к приложению.

Объекты представления папок обычно изменяют строку меню перед первым отображением представления папки. При удалении представления папки они должны вернуть строку меню в исходное состояние. Также может потребоваться изменить строку меню при каждом получении или потере фокуса представлением папки.

Так как проводник Windows вызывает [**ишеллвиев:: уиактивате**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-uiactivate) каждый раз при изменении состояния окна представления папок, изменение строки меню обычно включается в реализацию этого метода. Ниже приведена основная процедура изменения строки меню проводника Windows.

1.  Вызовите [креатемену](/windows/win32/api/winuser/nf-winuser-createmenu) , чтобы создать маркер меню.
2.  Передайте этот маркер меню в проводник Windows, вызвав [**ишеллбровсер:: инсертменуссб**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-insertmenussb). В проводнике Windows будут заполняться сведения о меню.
3.  При необходимости измените меню.
4.  Вызовите [**ишеллбровсер:: сетменусб**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-setmenusb) , чтобы Проводник Windows отображал измененную строку меню.

В строке меню проводника Windows есть шесть всплывающих меню. Как и в случае со всеми контейнерами OLE, меню проводника Windows делится на шесть групп: файл, Правка, контейнер, объект, окно и Справка. В следующей таблице перечислены всплывающие меню проводника Windows и связанные с ними группы, а также идентификаторы меню.



| Всплывающее меню | ID                     | Группа     |
|-------------|------------------------|-----------|
| Файл        | \_файл меню \_ фЦидм      | Файл      |
| Изменить        | \_изменить меню \_ фЦидм      | Файл      |
| Представление        | \_представление меню \_ фЦидм      | Контейнер |
| Избранное   | \_Избранное меню \_ фЦидм | Контейнер |
| Инструменты       | \_средства меню \_ фЦидм     | Контейнер |
| Справка        | \_ \_ Справка по меню фЦидм      | Окно    |



 

При передаче маркера меню в проводник Windows путем вызова [**ишеллбровсер:: инсертменуссб**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-insertmenussb)необходимо также передать указатель на структуру [олеменуграупвидсс](/windows/win32/api/oleidl/ns-oleidl-olemenugroupwidths) , члены которой были инициализированы нулем.

При возвращении [**ишеллбровсер:: инсертменуссб**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-insertmenussb) в проводнике Windows будут добавлены элементы меню. Затем можно использовать возвращенный маркер меню с стандартными функциями меню Windows, такими как [инсертменуитем](/windows/win32/api/winuser/nf-winuser-insertmenuitema) :

-   Добавьте элементы во всплывающие меню проводника Windows.
-   Изменение или удаление существующих элементов во всплывающих меню проводника Windows.
-   Добавление новых всплывающих меню.

Используйте идентификаторы, перечисленные в таблице, чтобы указать различные всплывающие меню проводника Windows.

> [!Note]  
> Чтобы избежать конфликтов с идентификаторами команд проводника Windows, идентификаторы всех добавляемых элементов меню должны находиться между ФЦИДМ \_ швиевфирст и фЦидм \_ швиевласт. Эти два значения определены в Шлобж. h.

 

После завершения изменения меню вызовите [**ишеллбровсер:: сетменусб**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-setmenusb) , чтобы Проводник Windows отображал новую строку меню.

После первоначального отображения представления папок проводник Windows вызывает [**ишеллвиев:: уиактивате**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-uiactivate) каждый раз, когда представление папки получает или теряет фокус. Если у вас есть элементы меню, которые чувствительны к состоянию представления папки, следует соответствующим образом изменить это меню при каждом изменении состояния. Например, у вас может быть пункт меню, который работает с элементом в представлении папки, выбранным пользователем. Этот пункт меню следует отключать или удалять при потере фокуса представлением папки.

Когда проводник Windows вызывает [**ишеллвиев:: уиактивате**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-uiactivate) , чтобы указать, что представление папки деактивировано, восстановите его исходное состояние, вызвав [**Ишеллбровсер:: ремовеменуссб**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-removemenussb).

### <a name="modifying-the-windows-explorer-toolbar"></a>Изменение панели инструментов проводника Windows

В дополнение к изменению строки меню проводника Windows можно также добавлять кнопки на панель инструментов. Как и в строке меню, изменение панели инструментов обычно является частью реализации [**ишеллвиев:: уиактивате**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-uiactivate) . Процедура добавления кнопок на панель инструментов проводника Windows:

1.  Добавьте точечный рисунок кнопки в список изображений панели инструментов.
2.  Определите текстовую строку кнопки.
3.  Добавьте кнопку на панель инструментов.

Чтобы добавить растровое изображение в список изображений панели инструментов, отправьте панель инструментов с сообщением [ \_ Аддбитмап (ТБ](../controls/tb-addbitmap.md) ), вызвав [**ишеллбровсер:: сендконтролмсг**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-sendcontrolmsg). Чтобы указать элемент управления ToolBar, задайте для параметра *ID* метода значение **ФКВ \_ Toolbar**. Присвойте параметру *wParam* число изображений кнопок в битовой карте и *lParam* на адрес структуры [тбаддбитмап](/windows/win32/api/commctrl/ns-commctrl-tbaddbitmap) . Индекс изображения возвращается в параметре *Прет* .

Существует два способа определения строки для кнопки:

-   Присвойте строку элементу **истринг** структуры [тббуттон](/windows/win32/api/commctrl/ns-commctrl-tbbutton) кнопки.
-   Вызовите [**ишеллбровсер:: сендконтролмсг**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-sendcontrolmsg) , чтобы отправить элемент управления ToolBar с сообщением [ \_ ADDSTRING](../controls/tb-addstring.md) в виде ТБ. Параметру *wParam* должно быть присвоено значение 0, а параметру *lParam* — строка. Индекс строки возвращается в параметре *Прет* .

Чтобы добавить кнопку на панель инструментов, заполните структуру [тббуттон](/windows/win32/api/commctrl/ns-commctrl-tbbutton) и передайте ее в [**Ишеллбровсер:: сеттулбаритемс**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-settoolbaritems). Как и в меню, идентификатор команды должен находиться между ФЦИДМ \_ швиевфирст и фЦидм \_ швиевласт. Затем Панель инструментов добавит кнопку справа от существующих кнопок.

Например, следующий фрагмент кода добавляет одну стандартную кнопку на панель инструментов проводника Windows с ИДЕНТИФИКАТОРом IDB \_ MYBUTTON.


```
TBADDBITMAP tbadbm;
int iButtonIndex;
TBBUTTON tbb;

tbadbm.hInst = g_hInstance;    // The module's instance handle
tbadbm.nID = IDB_BUTTONIMAGE;  // The bitmap's resource ID

psb->SendControlMsg(FCW_TOOLBAR, TB_ADDBITMAP, 1,
                    reinterpret_cast<LPARAM>(&tbadbm), &iButtonIndex);

psb->SendControlMsg(FCW_TOOLBAR, TB_ADDSTRING, NULL,
                    reinterpret_cast<LPARAM>(szLabel), &iStringIndex);

ZeroMemory(&tbb, sizeof(TBBUTTON));
tbb.iBitmap = iButtonIndex;
tbb.iCommand = IDB_MYBUTTON;
tbb.iString = iStringIndex;
tbb.fsState = TBSTATE_ENABLED;
tbb.fsStyle = TBSTYLE_BUTTON;

psb->SetToolbarItems(&tbb, 1, FCT_MERGE);
```



Дополнительные сведения об обработке элементов управления панели инструментов см. в разделе [элементы управления ToolBar](../controls/toolbar-control-reference.md).

### <a name="modifying-the-windows-explorer-status-bar"></a>Изменение строки состояния проводника Windows

Строку состояния проводника Windows можно использовать для вывода различных полезных сведений. Существует два способа использования строки состояния.

-   Используйте [**ишеллбровсер:: сетстатустекстсб**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-setstatustextsb) для вывода текстовой строки в строке состояния.
-   Отправка сообщений непосредственно в элемент управления "строка состояния" с помощью [**ишеллбровсер:: сендконтролмсг**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-sendcontrolmsg).

Первый метод прост, но достаточно для многих целей. Для большей гибкости можно отправить сообщения непосредственно в элемент управления "строка состояния", вызвав [**ишеллбровсер:: сендконтролмсг**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-sendcontrolmsg) с параметром *ID* , имеющим значение **ФКВ \_ Status**. Дальнейшее обсуждение элементов управления "строка состояния" см. в разделе [строки состояния](../controls/status-bars.md).

### <a name="storing-view-specific-information"></a>Хранение сведений, относящихся к представлению

Когда представление собирается уничтожиться, часто бывает полезно хранить такие сведения, как состояние или параметры представления. Проводник Windows предлагает выполнить эту задачу, вызвав [**ишеллвиев:: SaveViewState**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellview-saveviewstate). Предпочтительным способом сохранения сведений, относящихся к конкретным представлениям, является вызов [**ишеллбровсер:: жетвиевстатестреам**](/windows/desktop/api/shobjidl_core/nf-shobjidl_core-ishellbrowser-getviewstatestream). Этот метод предоставляет интерфейс [IStream](/windows/win32/api/objidl/nn-objidl-istream) , который можно использовать для хранения информации. Вы можете использовать любой подходящий формат данных.

 

 
