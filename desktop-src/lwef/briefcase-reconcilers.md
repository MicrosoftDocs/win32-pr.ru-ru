---
title: Создание подверяющих портфелей
description: Средство согласования портфелей позволяет портфелу выверять различные версии документа.
ms.assetid: 86d66291-96ae-40ea-98ef-ef263f25aa82
keywords:
- посредники по портфелю
- процессе
- иреконЦилаблеобжект
- иреконЦилеинитиатор
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b925e7055e15f6c7a49408aa28d147fb2eef5a7e
ms.sourcegitcommit: ebd3ce6908ff865f1ef66f2fc96769be0aad82e1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2020
ms.locfileid: "104412805"
---
# <a name="creating-briefcase-reconcilers"></a>Создание подверяющих портфелей

Средство согласования портфелей позволяет портфелу выверять различные версии документа.

-   [О подверяющих портфелях](#about-briefcase-reconcilers)
    -   [Процессе](#reconciliation)
    -   [Создание синхронизатора портфеля](#creating-a-briefcase-reconciler)
    -   [Взаимодействие с пользователем при выверке](#user-interaction-in-reconciliation)
    -   [Согласование внедренных объектов](#reconciling-embedded-objects)
    -   [ресидуес](#residues)
-   [Справочник по выверке портфеля](#briefcase-reconciler-reference)
    -   [Интерфейсы и методы посредника портфеля](#briefcase-reconciler-interfaces-and-methods)

## <a name="about-briefcase-reconcilers"></a>О подверяющих портфелях

Синхронизатор портфеля объединяет различные входные версии документа для создания одной новой выходной версии документа. Возможно, потребуется создать посредник портфеля для поддержки вашего типа документа. В этом обзоре описываются посредники по портфелю и способы их создания.

Рассматриваются следующие темы:

-   [Процессе](#reconciliation)
-   [Создание синхронизатора портфеля](#creating-a-briefcase-reconciler)
-   [Взаимодействие с пользователем при выверке](#user-interaction-in-reconciliation)
-   [Согласование внедренных объектов](#reconciling-embedded-objects)
-   [ресидуес](#residues)

### <a name="reconciliation"></a>Процессе

Документ представляет собой коллекцию данных, которые можно копировать и изменять. Документ имеет разные версии, если содержимое по крайней мере двух копий документа отличается. Выверка создает одну версию документа из двух или более первоначальных версий. Как правило, выверенная версия представляет собой сочетание информации из первоначальных версий с самой последней или наиболее полезной сохраненной информацией.

Сверка инициируется портфелем, когда он определяет, что две или более копии одного и того же документа отличаются. Портфель, который выступает в качестве инициатора в этом контексте, находит и запускает посредника портфеля, связанный с данным типом документа. Посредник сравнивает документы и определяет, какие части документов следует хранить. Для завершения сверки некоторых посредников может потребоваться вмешательство пользователя. Другие могут выполнить выверку без взаимодействия с пользователем. Посредник может содержаться в приложении или быть расширением, реализованным в виде библиотеки DLL.

Некоторые посредники по портфелю могут создать ресидуес. Ресидуе — это документ, обычно имеющий тот же тип файлов, что и исходный документ, который содержит сведения, не сохраненные в объединенной версии. Ресидуес обычно используются, чтобы дать авторам возможность быстро определить, какая информация из их исходного документа не входит в окончательную объединенную версию. Если посредник поддерживает ресидуес, он создает один ресидуе для каждой из исходных версий документа. Ресидуес не создаются, если инициатор не запрашивает их.

Некоторые посредники портфелей работают с портфелем, чтобы позволить пользователю завершить выверку. Это важная функция для пользователя, который может решить, что сверка не должна выполняться. Как правило, посредник предоставляет объект завершения, когда для сверки требуется взаимодействие с пользователем и его длина может быть длительной. В некоторых средах посредник может разрешать частичную выверку, позволяя пользователю временно приостановить выверку и возобновить ее работу позже. Однако портфель в настоящее время не поддерживает частичную выверку.

### <a name="creating-a-briefcase-reconciler"></a>Создание синхронизатора портфеля

Вы создаете посредник портфеля, реализуя интерфейсы сверки. Как минимум, посредник реализует интерфейс [**иреконЦилаблеобжект**](/windows/win32/api/reconcil/nn-reconcil-ireconcilableobject) и интерфейс [иперсистстораже](/windows/win32/api/objidl/nn-objidl-ipersiststorage) или [IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile) . Как инициатор, портфель определяет, когда требуется сверка, и вызывает метод [**иреконЦилаблеобжект:: Reconcile**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile) для инициации выверки.

Хотя [**иреконЦилаблеобжект:: Reconcile**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile) предоставляет широкий набор возможностей сверки, в большинстве случаев он выполняет только минимальную выверку. В частности, портфель не требует от посредника поддержки создания ресидуе или поддержки объекта завершения. Кроме того, посредник выполняет единую сверку "сверху вниз" и не должен возвращать \_ значение REC E \_ ноткомплете. Это означает, что не следует пытаться выполнить частичную выверку.

Портфель предоставляет интерфейс [**иреконЦилеинитиатор**](ireconcileinitiator.md) . Чтобы задать объект завершения, синхронизатор портфеля может использовать метод [**иреконЦилеинитиатор:: сетаборткаллбакк**](/windows/win32/api/reconcil/nf-reconcil-ireconcileinitiator-setabortcallback) . Портфель не использует идентификаторы версий и не может, следовательно, предоставлять предыдущие версии документа, если посредник запрашивает их с помощью соответствующих методов в **иреконЦилеинитиатор**.

Портфель передается в [**иреконЦилаблеобжект:: согласовать**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile) моникеры файлов, представляющие версии документа для сверки. Синхронизатор по портфелю получает доступ к версиям с помощью метода [IMoniker:: биндтубжект](/windows/win32/api/objidl/nf-objidl-imoniker-bindtoobject) или [IMoniker:: биндтостораже](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage) . Последнее обычно выполняется быстрее и рекомендуется. Посредник должен освободить все объекты или хранилище, к которым он привязан.

Когда синхронизатор по портфелю использует [IMoniker:: биндтостораже](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage), он привязывается к хранилищу, которое является плоским хранилищем (потоком) или структурированным хранилищем, определяемым OLE. Если для посредника требуется плоское хранилище, то для запроса интерфейса [IStream](/windows/win32/api/objidl/nn-objidl-istream) следует использовать IMoniker:: биндтостораже. Если посреднику требуется структурированное хранилище, он должен запросить интерфейс [IStorage](/windows/win32/api/objidl/nn-objidl-istorage) . В обоих случаях он должен запрашивать доступ к хранилищу только для чтения (не т. е.). доступ для чтения и записи может быть недоступен.

Как правило, синхронизатор портфеля выглядит непосредственно на хранении других версий и работает с внедренными объектами очень примитивным образом, например путем объединения двух версий объекта, включая обе версии в выходной версии.

Инициатор находит соответствующий синхронизатор портфеля с помощью подмножества логики, реализованной функцией [жетклассфиле](/windows/win32/api/objbase/nf-objbase-getclassfile) , чтобы определить тип данного файла, а затем просматривает реестр для класса-посредника, связанного с заданным типом файла. Портфель, как и другие компоненты оболочки, определяет тип файла только по расширению имени файла. Расширение файла должно иметь зарегистрированный тип файлов для портфеля, чтобы вызвать посредника для файла. При установке посредника необходимо задать запись реестра следующего вида.

```
CLSID
   {the file CLSID}
      Roles
         Reconciler
            (Default) = {the reconciler-classid}
```

Класс должен быть быстрой загрузкой, должен быть назначен \_ мултиплеусе, и, если для интерфейса сверки не предоставлены маршалером, то должен быть внутрипроцессный сервер (содержащийся в библиотеке DLL), а не локальный сервер (реализован в exe-файле).

### <a name="user-interaction-in-reconciliation"></a>Взаимодействие с пользователем при выверке

Посредник портфеля должен попытаться выполнить выверку без участия пользователя. Чем более автоматизирована сверка, тем лучше восприятие процесса пользователем.

В некоторых случаях вмешательство пользователя может быть ценным. Например, системе документов может потребоваться, чтобы пользователь мог проверить изменения перед принятием объединенной версии документа или потребовать от пользователя комментарии, объясняющие внесенные изменения. В таких случаях инициатор, а не синхронизатор портфеля, отвечает за запрос пользователя и выполнение инструкций пользователя.

В других случаях может потребоваться вмешательство пользователя, например, если две версии были изменены с учетом несовместимых способов. В таких случаях инициатор или синхронизатор должен запросить у пользователя инструкции по устранению конфликта. Как правило, инициатор не может полагаться на завершение сверки, не ожидая какого-либо взаимодействия с пользователем. У посредников, с другой стороны, есть возможность взаимодействовать с пользователем для разрешения конфликтов или для запроса инициатора.

### <a name="reconciling-embedded-objects"></a>Согласование внедренных объектов

При выверке документа сам посредник портфеля может стать инициатором, если обнаруживает внедренный объект типа, который не может выполнить выверку. В этом случае посреднику необходимо рекурсивно согласовать каждый из внедренных объектов и предположить все обязанности инициатора.

Чтобы выполнить рекурсию, синхронизатор портфеля загружает объект и запросы для соответствующего интерфейса. Обработчик для объекта должен поддерживать интерфейс. Если любой метод интерфейса возвращает \_ значение OLE E \_ нотруннинг, то посредник должен запустить объект, чтобы выполнить операцию. Поскольку код для внедренных объектов не всегда доступен, посредник должен предоставить решение для этого условия. Например, посредник может включать в выверенную версию как старые, так и новые версии внедренного объекта. Посредник не должен пытаться согласовать по ссылкам.

Инициатор сохраняет объединяемые версии документа. Во многих случаях инициатор имеет доступ к хранилищу каждой версии и сохраняет результат сверки с помощью аналогичного хранилища. Однако иногда инициатор может иметь объект в памяти, для которого не доступна постоянная версия. Такая ситуация может возникнуть, когда документ, содержащий открытые внедренные объекты, должен быть согласован перед сохранением. В таких случаях инициатор сохраняет результат сверки в версии, найденной в памяти.

Инициатор использует интерфейс [иперсистстораже](/windows/win32/api/objidl/nn-objidl-ipersiststorage) для привязки (загрузки) Объединенной версии. Инициатор использует метод [иперсистстораже:: Load](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load) , если исходная версия уже создана, и использует метод [Иперсистстораже:: InitNew](/windows/win32/api/objidl/nf-objidl-ipersiststorage-initnew) для первоначальной версии. При загрузке объединенной версии инициатор использует [QueryInterface](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) для получения адреса интерфейса [**иреконЦилаблеобжект**](/windows/win32/api/reconcil/nn-reconcil-ireconcilableobject) . Этот интерфейс предоставляет инициатору доступ к хранилищу существующих ресидуес и дает возможность создавать хранилище для всех новых ресидуес. Затем инициатор направляет интерфейс для выполнения сверки. Инициатор фактически запрашивает интерфейс [IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile) перед иперсистстораже. Если посредник поддерживает IPersistFile, инициатор управляет репликой через IPersistFile, а не с помощью методов Иперсистстораже. Это позволяет выверять файлы, которые не хранятся в виде составных документов.

После завершения сверки инициатор может сохранить объединенную версию с помощью интерфейса [иперсистстораже](/windows/win32/api/objidl/nn-objidl-ipersiststorage) или [IPersistFile](/windows/win32/api/objidl/nn-objidl-ipersistfile) . Во время сверки с помощью синхронизатора портфеля создает ресидуес по мере необходимости и записывает их постоянные биты в хранилище. Если Объединенная версия является потоком, интерфейс [IStorage](/windows/win32/api/objidl/nn-objidl-istorage) , переданный в [Иперсистстораже:: Load](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load) , содержит поток с именем Content и состоянием хранилища, установленным в статебитс \_ Flat. (Можно задать биты состояния с помощью метода [IStorage:: stat](/windows/win32/api/objidl/nf-objidl-istorage-stat) .) После объединения инициатор сохраняет объединенную версию, записывая данные соответствующим образом. Он должен гарантировать, что СТАТЕБИТС \_ Flat задано соответствующим образом для хранилища.

### <a name="residues"></a>ресидуес

Инициатор указывает, требуется ли ресидуес, установив для параметра *пстгневресидуес* допустимый адрес при вызове метода [**ИреконЦилаблеобжект:: Reconcile**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile) . Если посредник не поддерживает создание ресидуес, он должен вернуть \_ значение REC E \_ норесидуес, если только параметр *dwFlags* не указывает значение **реконЦилеф \_ норесидуесок** .

Синхронизатор по портфелю возвращает ресидуес инициатору, создавая новые элементы хранения и копируя их в массив, на который указывает *пстгневресидуес*. Для структурированного хранилища ресидуес посредник копирует интерфейс [IStorage](/windows/win32/api/objidl/nn-objidl-istorage) , а для неструктурированного ресидуес хранилища копирует интерфейс [IStream](/windows/win32/api/objidl/nn-objidl-istream) или IStorage с \_ установленным флагом плоской статебитс. Посредник использует IStorage для создания необходимого хранилища, используя [IStorage:: креатестреам](/windows/win32/api/objidl/nf-objidl-istorage-createstream) для создания плоского хранилища для ресидуе, который является потоком, и [IStorage:: креатестораже](/windows/win32/api/objidl/nf-objidl-istorage-createstorage) для создания структурированного хранилища.

Инициатор подготавливает *пстгневресидуес* , чтобы он не содержал элементов в нерезервированной части пространства имен [IStorage](/windows/win32/api/objidl/nn-objidl-istorage) . Синхронизатор портфеля помещает каждый ресидуе в элемент, имя которого соответствует порядку начальной версии. Например, первый ресидуе содержится в «1», второй — в «2» и т. д. Если выверенный объект создает ресидуе, он находится в элементе с именем "0".

Синхронизатор по портфелю фиксирует каждый созданный элемент по отдельности, гарантируя, что инициатор получает доступ к информации. Однако посредник не фиксирует сам *пстгневресидуес* . Инициатор отвечает за фиксацию этого или его уничтожения.

## <a name="briefcase-reconciler-reference"></a>Справочник по выверке портфеля

В этом разделе содержатся сведения об интерфейсах сверки. При обработке ошибок метод может возвращать только те значения ошибок, которые явно определены как возможные возвращаемые значения. Кроме того, метод должен установить все переменные, адреса которых передаются в качестве параметров в **значение NULL** перед возвратом из ошибки.

### <a name="briefcase-reconciler-interfaces-and-methods"></a>Интерфейсы и методы посредника портфеля

-   [**иреконЦилаблеобжект**](/windows/win32/api/reconcil/nn-reconcil-ireconcilableobject) 
    -   -   [**ИреконЦилаблеобжект:: Жетпрогрессфидбаккмаксестимате**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-getprogressfeedbackmaxestimate)
        -   [**ИреконЦилаблеобжект:: Reconcile**](/windows/win32/api/reconcil/nf-reconcil-ireconcilableobject-reconcile)

-   [**иреконЦилеинитиатор**](ireconcileinitiator.md) 
    -   -   [**ИреконЦилеинитиатор:: Сетаборткаллбакк**](/windows/win32/api/reconcil/nf-reconcil-ireconcileinitiator-setabortcallback)
        -   [**ИреконЦилеинитиатор:: Сетпрогрессфидбакк**](/windows/win32/api/reconcil/nf-reconcil-ireconcileinitiator-setprogressfeedback)

-   [**инотифиреплика**](/windows/desktop/api/reconcil/nn-reconcil-inotifyreplica) 
    -   -   [**Инотифиреплика:: Йоуареареплика**](/windows/desktop/api/reconcil/nf-reconcil-inotifyreplica-youareareplica)

 

 