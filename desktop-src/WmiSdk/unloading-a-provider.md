---
description: После завершения работы инструментария WMI с поставщиком он выгружает поставщик из памяти.
ms.assetid: 6116769f-3402-42b3-835d-9bdb0fc27ce0
ms.tgt_platform: multiple
title: Выгрузка поставщика
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 123d8c4f6b9d9155cdc22dc435635466956bdb0a
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104544647"
---
# <a name="unloading-a-provider"></a><span data-ttu-id="50c91-103">Выгрузка поставщика</span><span class="sxs-lookup"><span data-stu-id="50c91-103">Unloading a Provider</span></span>

<span data-ttu-id="50c91-104">После завершения работы инструментария WMI с поставщиком он выгружает поставщик из памяти.</span><span class="sxs-lookup"><span data-stu-id="50c91-104">After WMI is finished with a provider, it unloads the provider from memory.</span></span> <span data-ttu-id="50c91-105">Основная причина, по которой WMI выгружает поставщик, — это экономия системных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="50c91-105">The primary reason WMI unloads a provider is to conserve system resources.</span></span> <span data-ttu-id="50c91-106">Поэтому необходимо добавить код, позволяющий инструментарию WMI эффективно выгружать поставщик.</span><span class="sxs-lookup"><span data-stu-id="50c91-106">Therefore, you must add code that allows WMI to unload your provider in an efficient manner.</span></span> <span data-ttu-id="50c91-107">Он занимает от интервала, указанного в элементе управления кэшем, дважды с интервалом, в течение которого WMI выгружает поставщик.</span><span class="sxs-lookup"><span data-stu-id="50c91-107">It takes anywhere from the interval specified in the cache control to twice that interval for WMI to unload a provider.</span></span>

<span data-ttu-id="50c91-108">Инструментарий WMI выгружает поставщик одним из следующих способов:</span><span class="sxs-lookup"><span data-stu-id="50c91-108">WMI unloads a provider in one of the following ways:</span></span>

-   <span data-ttu-id="50c91-109">Выгрузить поставщик после того, как поставщик завершит назначенные ему задачи.</span><span class="sxs-lookup"><span data-stu-id="50c91-109">Unload a provider after the provider finishes the tasks given to it.</span></span>
-   <span data-ttu-id="50c91-110">Быстрая выгрузка всех поставщиков при завершении работы системы пользователем.</span><span class="sxs-lookup"><span data-stu-id="50c91-110">Quickly unload all providers when the user shuts down the system.</span></span> <span data-ttu-id="50c91-111">Обратите внимание, что инструментарий WMI выгружает внутрипроцессный поставщик при завершении работы службы WMI из командной строки.</span><span class="sxs-lookup"><span data-stu-id="50c91-111">Note that WMI unloads in-process providers when the WMI service is shut down from the command line.</span></span>

<span data-ttu-id="50c91-112">Хотя первый сценарий является наиболее распространенным, необходимо написать поставщик для обеих возможностей.</span><span class="sxs-lookup"><span data-stu-id="50c91-112">While the first scenario is more common, you must write your provider for both possibilities.</span></span>

<span data-ttu-id="50c91-113">В этом разделе обсуждаются следующие разделы:</span><span class="sxs-lookup"><span data-stu-id="50c91-113">The following sections are discussed in this topic:</span></span>

-   [<span data-ttu-id="50c91-114">Выгрузка неактивного поставщика</span><span class="sxs-lookup"><span data-stu-id="50c91-114">Unloading an Idle Provider</span></span>](#unloading-an-idle-provider)
-   [<span data-ttu-id="50c91-115">Доступ к времени простоя для поставщика</span><span class="sxs-lookup"><span data-stu-id="50c91-115">Accessing the Idle Time for a Provider</span></span>](#accessing-the-idle-time-for-a-provider)
-   [<span data-ttu-id="50c91-116">Выгрузка поставщика, который также является клиентом WMI</span><span class="sxs-lookup"><span data-stu-id="50c91-116">Unloading a Provider That Is Also a WMI Client</span></span>](#unloading-a-provider-that-is-also-a-wmi-client)
-   [<span data-ttu-id="50c91-117">Выгрузка поставщика во время завершения работы</span><span class="sxs-lookup"><span data-stu-id="50c91-117">Unloading a Provider During Shutdown</span></span>](#unloading-a-provider-during-shutdown)
-   [<span data-ttu-id="50c91-118">См. также</span><span class="sxs-lookup"><span data-stu-id="50c91-118">Related topics</span></span>](#related-topics)

## <a name="unloading-an-idle-provider"></a><span data-ttu-id="50c91-119">Выгрузка неактивного поставщика</span><span class="sxs-lookup"><span data-stu-id="50c91-119">Unloading an Idle Provider</span></span>

<span data-ttu-id="50c91-120">При выгрузке неактивного поставщика Инструментарий WMI выполняет следующие действия:</span><span class="sxs-lookup"><span data-stu-id="50c91-120">WMI performs the following actions when it unloads an idle provider:</span></span>

-   <span data-ttu-id="50c91-121">Определяет, бездействует ли поставщик.</span><span class="sxs-lookup"><span data-stu-id="50c91-121">Determines if the provider is idle.</span></span>

    <span data-ttu-id="50c91-122">Инструментарий WMI использует свойство **клеарафтер** , чтобы определить, как долго поставщик может остаться в состоянии простоя перед выгрузкой этого поставщика.</span><span class="sxs-lookup"><span data-stu-id="50c91-122">WMI uses the **ClearAfter** property to determine how long a provider may stay idle before unloading that provider.</span></span> <span data-ttu-id="50c91-123">Дополнительные сведения см. [в разделе доступ к времени простоя для поставщика](#accessing-the-idle-time-for-a-provider).</span><span class="sxs-lookup"><span data-stu-id="50c91-123">For more information, see [Accessing the Idle Time for a Provider](#accessing-the-idle-time-for-a-provider).</span></span>

-   <span data-ttu-id="50c91-124">Вызывает метод [**выпуска**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) поставщика.</span><span class="sxs-lookup"><span data-stu-id="50c91-124">Calls the [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) method of the provider.</span></span>

    <span data-ttu-id="50c91-125">Если поставщик был чистым поставщиком, то [**выпуск**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) полностью удаляет поставщик из активной памяти.</span><span class="sxs-lookup"><span data-stu-id="50c91-125">If the provider was a pure provider, then [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) completely removes the provider from active memory.</span></span> <span data-ttu-id="50c91-126">Однако нечистый поставщик может продолжать работу после вызова метода WMI **Release**.</span><span class="sxs-lookup"><span data-stu-id="50c91-126">However, a nonpure provider may continue to run after WMI calls **Release**.</span></span>

## <a name="accessing-the-idle-time-for-a-provider"></a><span data-ttu-id="50c91-127">Доступ к времени простоя для поставщика</span><span class="sxs-lookup"><span data-stu-id="50c91-127">Accessing the Idle Time for a Provider</span></span>

<span data-ttu-id="50c91-128">Минимальный период времени, в течение которого поставщик остается активным, определяется свойством **клеарафтер** .</span><span class="sxs-lookup"><span data-stu-id="50c91-128">The minimum amount of time a provider remains active is determined by the **ClearAfter** property.</span></span> <span data-ttu-id="50c91-129">**Клеарафтер** можно найти в экземплярах классов, производных от класса системы WMI [**\_ \_ CacheControl**](--cachecontrol.md) в \\ корневом пространстве имен.</span><span class="sxs-lookup"><span data-stu-id="50c91-129">You can find **ClearAfter** in instances of classes derived from the WMI system class [**\_\_CacheControl**](--cachecontrol.md) in the \\root namespace.</span></span>

<span data-ttu-id="50c91-130">В следующем списке описываются классы, которые являются производными от [**\_ \_ CacheControl**](--cachecontrol.md), который управляет выгрузкой поставщика:</span><span class="sxs-lookup"><span data-stu-id="50c91-130">The following list describes the classes that are derived from [**\_\_CacheControl**](--cachecontrol.md), which controls provider unloading:</span></span>

-   [<span data-ttu-id="50c91-131">**\_\_евентконсумерпровидеркачеконтрол**</span><span class="sxs-lookup"><span data-stu-id="50c91-131">**\_\_EventConsumerProviderCacheControl**</span></span>](--eventconsumerprovidercachecontrol.md)
-   [<span data-ttu-id="50c91-132">**\_\_евентпровидеркачеконтрол**</span><span class="sxs-lookup"><span data-stu-id="50c91-132">**\_\_EventProviderCacheControl**</span></span>](--eventprovidercachecontrol.md)
-   [<span data-ttu-id="50c91-133">**\_\_евентсинккачеконтрол**</span><span class="sxs-lookup"><span data-stu-id="50c91-133">**\_\_EventSinkCacheControl**</span></span>](--eventsinkcachecontrol.md)
-   [<span data-ttu-id="50c91-134">**\_\_обжектпровидеркачеконтрол**</span><span class="sxs-lookup"><span data-stu-id="50c91-134">**\_\_ObjectProviderCacheControl**</span></span>](--objectprovidercachecontrol.md)
-   [<span data-ttu-id="50c91-135">**\_\_пропертипровидеркачеконтрол**</span><span class="sxs-lookup"><span data-stu-id="50c91-135">**\_\_PropertyProviderCacheControl**</span></span>](--propertyprovidercachecontrol.md)

<span data-ttu-id="50c91-136">Вы можете изменить минимальное время, в течение которого WMI позволяет поставщику оставаться неактивным, изменив свойство **клеарафтер** в экземпляре управления кэшем для конкретного типа поставщика.</span><span class="sxs-lookup"><span data-stu-id="50c91-136">You can change the minimum amount of time that WMI allows a provider to remain inactive by editing the **ClearAfter** property in the cache control instance for a specific type of provider.</span></span> <span data-ttu-id="50c91-137">Например, чтобы ограничить период времени, в течение которого поставщик свойств может оставаться бездействующим, можно изменить свойство **клеарафтер** экземпляра [**\_ \_ пропертипровидеркачеконтрол**](--propertyprovidercachecontrol.md) в \\ корневом пространстве имен.</span><span class="sxs-lookup"><span data-stu-id="50c91-137">For example, to limit the amount of time a property provider can remain idle, you would edit the **ClearAfter** property of a [**\_\_PropertyProviderCacheControl**](--propertyprovidercachecontrol.md) instance in the \\root namespace.</span></span>

## <a name="unloading-a-provider-that-is-also-a-wmi-client"></a><span data-ttu-id="50c91-138">Выгрузка поставщика, который также является клиентом WMI</span><span class="sxs-lookup"><span data-stu-id="50c91-138">Unloading a Provider That Is Also a WMI Client</span></span>

<span data-ttu-id="50c91-139">Поставщику может потребоваться оставить клиент WMI после того, как он завершит функции поставщика, для выполнения которых он был вызван.</span><span class="sxs-lookup"><span data-stu-id="50c91-139">Your provider may need to remain a client of WMI after it has completed the provider functions it was called to perform.</span></span> <span data-ttu-id="50c91-140">Например, поставщику push-уведомлений может потребоваться выдавать запросы к инструментарию WMI.</span><span class="sxs-lookup"><span data-stu-id="50c91-140">For example, a push provider may need to issue queries to WMI.</span></span> <span data-ttu-id="50c91-141">Дополнительные сведения см. в разделе [Определение состояния принудительной отправки или извлечения](determining-push-or-pull-status.md).</span><span class="sxs-lookup"><span data-stu-id="50c91-141">For more information, see [Determining Push or Pull Status](determining-push-or-pull-status.md).</span></span> <span data-ttu-id="50c91-142">В этом случае для **чистого** свойства экземпляра [**\_ \_ Win32Provider**](--win32provider.md) , представляющего поставщик, должно быть задано **значение true**.</span><span class="sxs-lookup"><span data-stu-id="50c91-142">In this case, the **Pure** property of the [**\_\_Win32Provider**](--win32provider.md) instance that represents the provider should be set to **TRUE**.</span></span> <span data-ttu-id="50c91-143">Если для **чистого** свойства задано **значение false**, поставщик готовится к выгрузке путем вызова [**IUnknown:: Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) для всех необработанных точек интерфейса, когда WMI вызывает метод Release своего основного интерфейса.</span><span class="sxs-lookup"><span data-stu-id="50c91-143">If the **Pure** property is set to **FALSE**, the provider prepares to unload by calling [**IUnknown::Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) on all outstanding interface points when WMI calls the Release method of its primary interface.</span></span> <span data-ttu-id="50c91-144">Дополнительные сведения см. в подразделе "Примечания" в [**\_ \_ Win32Provider**](--win32provider.md).</span><span class="sxs-lookup"><span data-stu-id="50c91-144">For more information, see the Remarks section in [**\_\_Win32Provider**](--win32provider.md).</span></span>

<span data-ttu-id="50c91-145">В следующей процедуре описывается реализация метода Release для основного интерфейса поставщика.</span><span class="sxs-lookup"><span data-stu-id="50c91-145">The following procedure describes how to implement a release method for the primary interface of your provider.</span></span>

<span data-ttu-id="50c91-146">**Выгрузка поставщика**</span><span class="sxs-lookup"><span data-stu-id="50c91-146">**To unload a provider**</span></span>

1.  <span data-ttu-id="50c91-147">Выпустите все указатели на интерфейсы, удерживаемые WMI, когда WMI вызывает метод [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) основного интерфейса поставщика.</span><span class="sxs-lookup"><span data-stu-id="50c91-147">Release all interface pointers held against WMI when WMI calls the [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) method of the primary interface of your provider.</span></span>

    <span data-ttu-id="50c91-148">Как правило, поставщик содержит указатели на интерфейсы [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) и [**ивбемконтекст**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemcontext) , предоставляемые в [**ивбемпровидеринит:: Initialize**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemproviderinit-initialize).</span><span class="sxs-lookup"><span data-stu-id="50c91-148">Typically, a provider holds pointers to the [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) and [**IWbemContext**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemcontext) interfaces supplied in [**IWbemProviderInit::Initialize**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemproviderinit-initialize).</span></span>

2.  <span data-ttu-id="50c91-149">Если для **чистого** свойства в связанном экземпляре [**\_ \_ Win32Provider**](--win32provider.md) задано **значение false**, поставщик может перейти к роли клиентского приложения после вызова метода WMI [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).</span><span class="sxs-lookup"><span data-stu-id="50c91-149">If the **Pure** property in the associated [**\_\_Win32Provider**](--win32provider.md) instance is set to **FALSE**, the provider can transition to the role of client application after WMI calls [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).</span></span> <span data-ttu-id="50c91-150">Однако Инструментарий WMI не может выгрузить поставщик, работающий в качестве клиентской системы, что повышает нагрузку на систему.</span><span class="sxs-lookup"><span data-stu-id="50c91-150">However, WMI cannot unload a provider that is operating as a client system, which increases the system overhead.</span></span>

    <span data-ttu-id="50c91-151">Поставщик с **чистым** значением **true** существует только для запросов на обслуживание.</span><span class="sxs-lookup"><span data-stu-id="50c91-151">A provider with **Pure** set to **TRUE** exists only to service requests.</span></span> <span data-ttu-id="50c91-152">Таким образом, этот тип поставщика не может принимать роль клиентского приложения, и инструментарий WMI может выгрузить его.</span><span class="sxs-lookup"><span data-stu-id="50c91-152">Therefore, this type of provider cannot take on the role of a client application and WMI can unload it.</span></span>

## <a name="unloading-a-provider-during-shutdown"></a><span data-ttu-id="50c91-153">Выгрузка поставщика во время завершения работы</span><span class="sxs-lookup"><span data-stu-id="50c91-153">Unloading a Provider During Shutdown</span></span>

<span data-ttu-id="50c91-154">При нормальных обстоятельствах использование рекомендаций в [выгрузке поставщика, который также является клиентом WMI,](#unloading-a-provider-that-is-also-a-wmi-client) позволяет инструментарию WMI правильно выгружать поставщик.</span><span class="sxs-lookup"><span data-stu-id="50c91-154">Under normal circumstances, using the guidelines in [Unloading a Provider That is Also a WMI Client](#unloading-a-provider-that-is-also-a-wmi-client) allows WMI to unload your provider properly.</span></span> <span data-ttu-id="50c91-155">Однако можно столкнуться с ситуациями, когда WMI не может инстигате нормальные процедуры выгрузки, например, когда пользователь решает выключить систему.</span><span class="sxs-lookup"><span data-stu-id="50c91-155">However, you may run into situations where WMI is unable to instigate the normal unloading procedures, such as when the user chooses to shut the system down.</span></span> <span data-ttu-id="50c91-156">Используя модель хранения данных в транзакциях, помимо реализации хорошей стратегии очистки, можно убедиться, что поставщик правильно выгружен.</span><span class="sxs-lookup"><span data-stu-id="50c91-156">By using a transaction model of data storage, in addition to implementing a good cleanup strategy, you can ensure that your provider is properly unloaded.</span></span>

<span data-ttu-id="50c91-157">Пользователь может в любое время приостанавливает работу инструментария WMI.</span><span class="sxs-lookup"><span data-stu-id="50c91-157">The user may stop WMI at any time.</span></span> <span data-ttu-id="50c91-158">В такой ситуации Инструментарий WMI не выгружает поставщиков или не вызывает точку входа [**DllCanUnloadNow**](/windows/win32/api/combaseapi/nf-combaseapi-dllcanunloadnow) для любого внутрипроцессного поставщика.</span><span class="sxs-lookup"><span data-stu-id="50c91-158">In such a situation, WMI does not unload any providers or call the [**DllCanUnloadNow**](/windows/win32/api/combaseapi/nf-combaseapi-dllcanunloadnow) entry point on any in-process provider.</span></span> <span data-ttu-id="50c91-159">Более того, если внутрипроцессный поставщик находится в середине вызова метода во время завершения работы, WMI может, возможно, завершить выполнение потока в середине вызова.</span><span class="sxs-lookup"><span data-stu-id="50c91-159">Moreover, if an in-process provider is in the middle of a method call at the time of the shutdown, WMI can possibly terminate the executing thread in the middle of the call.</span></span> <span data-ttu-id="50c91-160">В этом случае Инструментарий WMI не вызывает подпрограммы, которые обычно обрабатывали очистку, например деструктор объекта.</span><span class="sxs-lookup"><span data-stu-id="50c91-160">In this circumstance, WMI does not call routines that normally handle cleanup, such as an object destructor.</span></span> <span data-ttu-id="50c91-161">В большинстве случаев Инструментарий WMI будет вызывать только функцию [**DllMain**](/windows/desktop/Dlls/dllmain) .</span><span class="sxs-lookup"><span data-stu-id="50c91-161">At most, WMI will call [**DllMain**](/windows/desktop/Dlls/dllmain) only.</span></span>

<span data-ttu-id="50c91-162">Когда операционная система завершает работу инструментария WMI, система автоматически освобождает всю память, выделенную для внутрипроцессного поставщика.</span><span class="sxs-lookup"><span data-stu-id="50c91-162">When the operating system shuts down WMI, the system automatically releases all memory allocated to an in-process provider.</span></span> <span data-ttu-id="50c91-163">Операционная система также закрывает большинство ресурсов, удерживаемых поставщиком, например дескрипторы файлов, дескрипторы окон и т. д.</span><span class="sxs-lookup"><span data-stu-id="50c91-163">The operating system also closes most resources held by the provider, such as file handles, window handles, and so on.</span></span> <span data-ttu-id="50c91-164">Поставщику не нужно предпринимать никаких действий, чтобы сделать это.</span><span class="sxs-lookup"><span data-stu-id="50c91-164">The provider does not need to take any specific action to make this happen.</span></span>

<span data-ttu-id="50c91-165">Поскольку Инструментарий WMI может завершить работу в середине вызова, поставщик не должен оставлять источники данных в нестабильном состоянии.</span><span class="sxs-lookup"><span data-stu-id="50c91-165">Because WMI may shut down in the middle of a call, a provider should not leave data sources in an inconsistent state.</span></span> <span data-ttu-id="50c91-166">Нестабильное сохранение данных не является проблемой для поставщиков, предназначенных только для чтения.</span><span class="sxs-lookup"><span data-stu-id="50c91-166">Leaving your data in an inconsistent state is not a problem for read-only providers.</span></span> <span data-ttu-id="50c91-167">Однако поставщикам с возможностями записи может потребоваться реализовать некоторую модель транзакции, чтобы обеспечить надежный откат после внезапного завершения.</span><span class="sxs-lookup"><span data-stu-id="50c91-167">However, providers with write capabilities may want to implement some sort of transaction model to allow a safe rollback after an abrupt termination.</span></span>

<span data-ttu-id="50c91-168">В то время как операционная система может освободить некоторые общие системные ресурсы, система не освобождает все ресурсы автоматически.</span><span class="sxs-lookup"><span data-stu-id="50c91-168">While the operating system may release some general system resources, the system does not automatically release all resources.</span></span> <span data-ttu-id="50c91-169">Например, операционная система может не освободить сокет или подключение к базе данных.</span><span class="sxs-lookup"><span data-stu-id="50c91-169">For example, the operating system may not release a socket or a database connection.</span></span> <span data-ttu-id="50c91-170">Вместо этого поставщик может потребоваться вручную очистить такие ресурсы.</span><span class="sxs-lookup"><span data-stu-id="50c91-170">Instead, the provider may need to manually clean up such resources.</span></span> <span data-ttu-id="50c91-171">Чтобы избежать этих проблем, можно либо реализовать поставщик вне процесса, либо добавить код очистки.</span><span class="sxs-lookup"><span data-stu-id="50c91-171">To avoid these problems, you can either implement your provider out-of-process, or you can add cleanup code.</span></span>

<span data-ttu-id="50c91-172">Самым простым решением является реализация поставщика вне процесса.</span><span class="sxs-lookup"><span data-stu-id="50c91-172">The simplest solution is to implement your provider out-of-process.</span></span> <span data-ttu-id="50c91-173">Поставщик вне процесса не был завершен, когда инструментарий WMI завершает работу, хотя WMI выпустит поставщик после истечения времени ожидания COM.</span><span class="sxs-lookup"><span data-stu-id="50c91-173">An out-of-process provider is not killed when WMI shuts down, although WMI will release the provider after a COM timeout.</span></span> <span data-ttu-id="50c91-174">Поставщики, для которых проблемы с надежностью и завершением очистки являются более важными, чем производительность может быть вне процесса.</span><span class="sxs-lookup"><span data-stu-id="50c91-174">Providers for whom cleanup and termination robustness issues are more important than performance may be out-of-process.</span></span>

<span data-ttu-id="50c91-175">Если необходимо поместить код очистки в поставщик, у вас есть два варианта.</span><span class="sxs-lookup"><span data-stu-id="50c91-175">If you must place cleanup code in your provider, you have two options.</span></span> <span data-ttu-id="50c91-176">Одно из мест для выполнения такого рода очистки — [**DllMain**](/windows/desktop/Dlls/dllmain), функция точки входа библиотеки DLL, которая вызывается операционной системой при ВЫГРУЗКЕ библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="50c91-176">One place to perform this sort of cleanup is [**DllMain**](/windows/desktop/Dlls/dllmain), the DLL entry point function the operating system calls when unloading the DLL.</span></span> <span data-ttu-id="50c91-177">Код очистки можно добавить непосредственно в **DllMain**, выполняя его в ответ **на \_ \_ отсоединение процесса DLL**.</span><span class="sxs-lookup"><span data-stu-id="50c91-177">Cleanup code can be added directly into **DllMain**, executing it in response to **DLL\_PROCESS\_DETACH**.</span></span> <span data-ttu-id="50c91-178">Реализация кода очистки в **DllMain** может быть довольно сложной, особенно в средах программирования, таких как MFC или ATL.</span><span class="sxs-lookup"><span data-stu-id="50c91-178">Implementing cleanup code in **DllMain** can be somewhat difficult to arrange, especially in programming environments such as MFC or ATL.</span></span> <span data-ttu-id="50c91-179">Дополнительные сведения см. в статье базы знаний Майкрософт Q148791 "*как предоставить собственную функцию DllMain в обычной библиотеке DLL MFC".*</span><span class="sxs-lookup"><span data-stu-id="50c91-179">For more information, see the Microsoft Knowledge Base article Q148791, "*How to Provide Your Own DllMain in an MFC Regular DLL.*"</span></span> <span data-ttu-id="50c91-180">(Этот ресурс может быть недоступен в некоторых языках и странах или регионах.)</span><span class="sxs-lookup"><span data-stu-id="50c91-180">(This resource may not be available in some languages and countries or regions.)</span></span>

<span data-ttu-id="50c91-181">Кроме того, код очистки можно также разместить в деструкторе глобального класса.</span><span class="sxs-lookup"><span data-stu-id="50c91-181">Alternately, you could also place the cleanup code in the destructor of a global class.</span></span> <span data-ttu-id="50c91-182">Дополнительные сведения см. в разделе выгрузка поставщика.</span><span class="sxs-lookup"><span data-stu-id="50c91-182">For more information, see Unloading a Provider.</span></span> <span data-ttu-id="50c91-183">Операционная система Windows не выделяет глобальные объекты в куче.</span><span class="sxs-lookup"><span data-stu-id="50c91-183">The Windows operating system does not allocate global objects on the heap.</span></span> <span data-ttu-id="50c91-184">Вместо этого операционная система вызывает деструкторы во время выгрузки библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="50c91-184">Instead, the operating system calls the destructors during DLL unload.</span></span>

<span data-ttu-id="50c91-185">Ниже приведена простая процедура очистки, которая может поместиться в глобальный объект для инструментария WMI.</span><span class="sxs-lookup"><span data-stu-id="50c91-185">The following is a simple cleanup procedure that could fit inside a global object for WMI.</span></span>


```C++
class CMyCleanup
{
    ~CMyCleanup()
    {
        CloseHandle(m_hOpenFile);
        CloseDatabaseConnection(g_hDatabase);
    }
} g_Cleanup;
```



<span data-ttu-id="50c91-186">Существует множество ограничений на то, что можно сделать в коде очистки с помощью любого из подходов.</span><span class="sxs-lookup"><span data-stu-id="50c91-186">There are many restrictions as to what can be done in the cleanup code with either approach.</span></span> <span data-ttu-id="50c91-187">Например, ни один из потоков, ни DLL-библиотек, которые не связаны неявно, могут быть доступны каким-либо образом.</span><span class="sxs-lookup"><span data-stu-id="50c91-187">For example, neither threads nor any DLLs that are not implicitly linked may be accessed in any way.</span></span> <span data-ttu-id="50c91-188">Кроме того, нельзя выполнять вызовы COM при любых обстоятельствах.</span><span class="sxs-lookup"><span data-stu-id="50c91-188">Further, you cannot make COM calls under any circumstances.</span></span>

## <a name="related-topics"></a><span data-ttu-id="50c91-189">См. также</span><span class="sxs-lookup"><span data-stu-id="50c91-189">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="50c91-190">Настройка дескрипторов безопасности Намепаце</span><span class="sxs-lookup"><span data-stu-id="50c91-190">Setting Namepace Security Descriptors</span></span>](setting-namespace-security-descriptors.md)
</dt> <dt>

[<span data-ttu-id="50c91-191">Защита поставщика</span><span class="sxs-lookup"><span data-stu-id="50c91-191">Securing Your Provider</span></span>](securing-your-provider.md)
</dt> <dt>

[<span data-ttu-id="50c91-192">Разработка поставщика WMI</span><span class="sxs-lookup"><span data-stu-id="50c91-192">Developing a WMI Provider</span></span>](developing-a-wmi-provider.md)
</dt> </dl>

 

 
