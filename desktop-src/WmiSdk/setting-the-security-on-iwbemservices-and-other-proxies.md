---
description: 'В C++ можно настроить безопасность всего процесса, вызвав CoInitializeSecurity перед подключением к WMI через Ивбемлокатор:: Коннектсервер.'
ms.assetid: 83c04a96-3829-4c07-91a7-06e5b75b2c12
ms.tgt_platform: multiple
title: Настройка безопасности для IWbemServices и других прокси-серверов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d593c52091182b1f0580908624e0b4068ed3f8d3
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105712942"
---
# <a name="setting-the-security-on-iwbemservices-and-other-proxies"></a><span data-ttu-id="44748-103">Настройка безопасности для IWbemServices и других прокси-серверов</span><span class="sxs-lookup"><span data-stu-id="44748-103">Setting the Security on IWbemServices and Other Proxies</span></span>

<span data-ttu-id="44748-104">В C++ можно настроить безопасность всего процесса, вызвав [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity) перед подключением к WMI через [**Ивбемлокатор:: коннектсервер**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemlocator-connectserver).</span><span class="sxs-lookup"><span data-stu-id="44748-104">While in C++ you can set the security on the entire process by calling [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity) before connecting to WMI through [**IWbemLocator::ConnectServer**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemlocator-connectserver).</span></span> <span data-ttu-id="44748-105">Можно также изменить уровень проверки подлинности, уровень олицетворения или службу проверки подлинности в вызове, который получает указатель на прокси-сервер WMI, например [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) или [**ивбемкаллресулт**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemcallresult).</span><span class="sxs-lookup"><span data-stu-id="44748-105">You can also change the authentication level, impersonation level, or the authentication service in a call that obtains a pointer to a WMI proxy, such as [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) or [**IWbemCallResult**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemcallresult).</span></span> <span data-ttu-id="44748-106">Вызов [**CoSetProxyBlanket**](/windows/win32/api/combaseapi/nf-combaseapi-cosetproxyblanket) также позволяет изменить службу проверки подлинности (Kerberos, NTLM или Negotiate).</span><span class="sxs-lookup"><span data-stu-id="44748-106">Calling [**CoSetProxyBlanket**](/windows/win32/api/combaseapi/nf-combaseapi-cosetproxyblanket) also allows you to change the authentication service (Kerberos, NTLM, or negotiate).</span></span>

<span data-ttu-id="44748-107">Скрипты и Visual Basic приложения задают безопасность только для прокси-серверов косвенным образом посредством вызовов [**SwbemServices**](swbemservices.md) и других объектов автоматизации.</span><span class="sxs-lookup"><span data-stu-id="44748-107">Scripts and Visual Basic applications only set security on proxies indirectly through calls to [**SWbemServices**](swbemservices.md) and other automation objects.</span></span> <span data-ttu-id="44748-108">Дополнительные сведения о настройке и изменении проверки подлинности и олицетворения в скрипте см. в разделе [Задание уровня безопасности процесса по умолчанию с помощью VBScript](setting-the-default-process-security-level-using-vbscript.md).</span><span class="sxs-lookup"><span data-stu-id="44748-108">For more information about setting and changing authentication and impersonation in script, see [Setting the Default Process Security Level Using VBScript](setting-the-default-process-security-level-using-vbscript.md).</span></span>

<span data-ttu-id="44748-109">Изменение уровней безопасности или служб в основном является проблемой при подключении к инструментарию WMI на удаленном компьютере, работающем под управлением другой операционной системы.</span><span class="sxs-lookup"><span data-stu-id="44748-109">Changing security levels or services is primarily a concern when connecting to WMI on a remote computer that is running a different operating system.</span></span> <span data-ttu-id="44748-110">Дополнительные сведения см. в разделе [подключение между разными операционными системами](/windows/desktop/WmiSdk/troubleshooting-a-remote-wmi-connection).</span><span class="sxs-lookup"><span data-stu-id="44748-110">For more information, see [Connecting Between Different Operating Systems](/windows/desktop/WmiSdk/troubleshooting-a-remote-wmi-connection).</span></span>

<span data-ttu-id="44748-111">Клиентское приложение подключается к прокси-серверу WMI, используя удостоверение.</span><span class="sxs-lookup"><span data-stu-id="44748-111">A client application connects to a WMI proxy using an identity.</span></span> <span data-ttu-id="44748-112">Удостоверение — это объект данных, состоящий из параметров имени пользователя, пароля и центра.</span><span class="sxs-lookup"><span data-stu-id="44748-112">An identity is a data object that consists of a user name, password, and authority settings.</span></span> <span data-ttu-id="44748-113">Для клиентского приложения WMI вызов интерфейса [**ивбемлокатор:: коннектсервер**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemlocator-connectserver) создает начальное удостоверение.</span><span class="sxs-lookup"><span data-stu-id="44748-113">For a WMI client application, the call to the [**IWbemLocator::ConnectServer**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemlocator-connectserver) interface creates the initial identity.</span></span> <span data-ttu-id="44748-114">Метод [**коннектсервер**](swbemlocator-connectserver.md) принимает удостоверение в наборе из трех параметров, которые можно установить в **null** для указания текущего пользователя.</span><span class="sxs-lookup"><span data-stu-id="44748-114">The [**ConnectServer**](swbemlocator-connectserver.md) method takes the identity in a set of three parameters, which you can set to **NULL** to indicate the current user.</span></span> <span data-ttu-id="44748-115">Можно также указать параметр, отличный от **null** , для указания конкретного пользователя и домена.</span><span class="sxs-lookup"><span data-stu-id="44748-115">You can also specify a non-**NULL** parameter to indicate a specific user and domain.</span></span> <span data-ttu-id="44748-116">Если вызов выполнен успешно, **коннектсервер** возвращает указатель, с помощью которого можно получить доступ к различным удаленным процессам, например к службе WMI или к операционной системе Windows напрямую.</span><span class="sxs-lookup"><span data-stu-id="44748-116">If the call is successful, **ConnectServer** returns a pointer through which you can access a variety of remote processes, such as a WMI service or the Windows operating system directly.</span></span>

<span data-ttu-id="44748-117">Как и многие интерфейсы COM, [**коннектсервер**](swbemlocator-connectserver.md) возвращает указатель на прокси-сервер.</span><span class="sxs-lookup"><span data-stu-id="44748-117">Like many COM interfaces, [**ConnectServer**](swbemlocator-connectserver.md) returns a pointer to a proxy.</span></span> <span data-ttu-id="44748-118">Прокси — это объект данных, представляющий удаленный процесс, например WMI или удаленный поставщик.</span><span class="sxs-lookup"><span data-stu-id="44748-118">A proxy is a data object that represents a remote process, such as WMI or a remote provider.</span></span> <span data-ttu-id="44748-119">COM использует прокси-сервер, чтобы предоставить разработчикам доступ к удаленным данным, как если бы данные были локальными.</span><span class="sxs-lookup"><span data-stu-id="44748-119">COM uses a proxy to allow developers access to remote data as though the data were local.</span></span>

<span data-ttu-id="44748-120">Следующие интерфейсы WMI используют прокси-серверы:</span><span class="sxs-lookup"><span data-stu-id="44748-120">The following WMI interfaces use proxies:</span></span>

-   <span data-ttu-id="44748-121">[**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) (объект скрипта [**SwbemServices**](swbemservices.md) )</span><span class="sxs-lookup"><span data-stu-id="44748-121">[**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) ([**SWbemServices**](swbemservices.md) scripting object)</span></span>
-   [<span data-ttu-id="44748-122">**иенумвбемклассобжект**</span><span class="sxs-lookup"><span data-stu-id="44748-122">**IEnumWbemClassObject**</span></span>](/windows/desktop/api/Wbemcli/nn-wbemcli-ienumwbemclassobject)
-   [<span data-ttu-id="44748-123">**ивбемкаллресулт**</span><span class="sxs-lookup"><span data-stu-id="44748-123">**IWbemCallResult**</span></span>](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemcallresult)
-   <span data-ttu-id="44748-124">[**Ивбемрефрешер**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemrefresher) (объект скрипта [**свбемрефрешер**](swbemrefresher.md) )</span><span class="sxs-lookup"><span data-stu-id="44748-124">[**IWbemRefresher**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemrefresher) ([**SWbemRefresher**](swbemrefresher.md) scripting object)</span></span>

    <span data-ttu-id="44748-125">Обновитель WMI является особым случаем, поскольку ему передается указатель [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) , параметры безопасности которого должны быть установлены правильно.</span><span class="sxs-lookup"><span data-stu-id="44748-125">The WMI Refresher is a special case because it is passed an [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) pointer, whose security settings must be properly set.</span></span> <span data-ttu-id="44748-126">Дополнительные сведения об использовании объектов обновления см. [в разделе доступ к данным производительности в C++](accessing-performance-data-in-c--.md).</span><span class="sxs-lookup"><span data-stu-id="44748-126">For more information about using refresher objects, see [Accessing Performance Data in C++](accessing-performance-data-in-c--.md).</span></span>

<span data-ttu-id="44748-127">После получения указателя на удаленный процесс можно выполнить одно из двух действий.</span><span class="sxs-lookup"><span data-stu-id="44748-127">After you receive a pointer to a remote process, you can do one of two things.</span></span> <span data-ttu-id="44748-128">Если вы понимаете, что делает процесс, вы можете задать безопасность для указателя и получить доступ к процессу в обычном режиме.</span><span class="sxs-lookup"><span data-stu-id="44748-128">If you know what the process does, you can choose to set the security on the pointer and access the process normally.</span></span> <span data-ttu-id="44748-129">В этом случае большинство указателей на службу WMI.</span><span class="sxs-lookup"><span data-stu-id="44748-129">This is the case with most pointers to a WMI service.</span></span> <span data-ttu-id="44748-130">Дополнительные сведения см. в разделе [Установка уровней безопасности для WMI-соединения](setting-the-security-levels-on-a-wmi-connection.md).</span><span class="sxs-lookup"><span data-stu-id="44748-130">For more information, see [Setting the Security Levels on a WMI Connection](setting-the-security-levels-on-a-wmi-connection.md).</span></span> <span data-ttu-id="44748-131">Кроме того, необходимо получить доступ к другому COM-интерфейсу на прокси, например [**IUnknown:: Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release), посредством вызова интерфейса [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) на прокси-сервере.</span><span class="sxs-lookup"><span data-stu-id="44748-131">Alternately, you need to access a different COM interface on the proxy, such as [**IUnknown::Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release), through a call to the [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) interface on the proxy.</span></span>

## <a name="defaults-and-recommendations"></a><span data-ttu-id="44748-132">Значения по умолчанию и рекомендации</span><span class="sxs-lookup"><span data-stu-id="44748-132">Defaults and Recommendations</span></span>

<span data-ttu-id="44748-133">Распределенная версия модели объектов Component (DCOM) согласовывает службу проверки подлинности по умолчанию (Kerberos, NTLM или Negotiate), и вы не можете указать службу проверки подлинности по умолчанию с помощью [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity).</span><span class="sxs-lookup"><span data-stu-id="44748-133">The distributed version of the Component Object Model (DCOM) negotiates the default authentication service (Kerberos, NTLM, or Negotiate), and you cannot specify the default authentication service using [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity).</span></span> <span data-ttu-id="44748-134">Указание параметра **RPC \_ C \_ AUTHN \_ Default** в параметре службы проверки подлинности [**CoSetProxyBlanket**](/windows/win32/api/combaseapi/nf-combaseapi-cosetproxyblanket) позволяет DCOM выбрать соответствующую службу.</span><span class="sxs-lookup"><span data-stu-id="44748-134">Specifying **RPC\_C\_AUTHN\_DEFAULT** in the authentication service parameter of [**CoSetProxyBlanket**](/windows/win32/api/combaseapi/nf-combaseapi-cosetproxyblanket) allows DCOM to select the appropriate service.</span></span> <span data-ttu-id="44748-135">Для удаленных подключений служба по умолчанию — Negotiate, которая является рекомендуемой службой для приложений, работающих в доменах Kerberos и не-Kerberos.</span><span class="sxs-lookup"><span data-stu-id="44748-135">For remote connections the default service is Negotiate, which is the recommended service for applications functioning in both Kerberos and non-Kerberos domains.</span></span> <span data-ttu-id="44748-136">Для локальных соединений используется стандартная служба проверки подлинности NT LAN Manager (NTLM).</span><span class="sxs-lookup"><span data-stu-id="44748-136">For local connections, the default authentication service is NT LAN Manager (NTLM).</span></span>

<span data-ttu-id="44748-137">В следующем примере кода показана используемая служба проверки подлинности по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="44748-137">The following code example shows the default authentication service being used.</span></span>


```C++
// The pWbemServices variable is of type IWbemServices*

HRESULT hr = CoSetProxyBlanket(
     pWbemServices,                //Proxy
     RPC_C_AUTHN_DEFAULT,          //Authentication service 
     RPC_C_AUTHZ_DEFAULT,          //Authorization service 
     COLE_DEFAULT_PRINCIPAL,       //Server principal name used 
                                       // by authentication service
     RPC_C_AUTHN_LEVEL_DEFAULT,    //Authentication level
     RPC_C_IMP_LEVEL_IMPERSONATE,  //Impersonation level
     COLE_DEFAULT_AUTHINFO,       //Client identity
     EOAC_DEFAULT                  //Capability flags
     );
```



<span data-ttu-id="44748-138">Пример кода в этом разделе требует наличия следующих инструкций Reference и \# include.</span><span class="sxs-lookup"><span data-stu-id="44748-138">The code example in this topic requires the following reference and \#include statements.</span></span>


```C++
#define _WIN32_DCOM
#include <wbemidl.h>
#include <comdef.h>

#pragma comment(lib, "wbemuuid.lib")
```



<span data-ttu-id="44748-139">Для сценариев рекомендуется использовать значения по умолчанию, которые DCOM выбирает для удаленных вызовов.</span><span class="sxs-lookup"><span data-stu-id="44748-139">For scripting, it is recommended that you use the defaults that DCOM selects for remote calls.</span></span> <span data-ttu-id="44748-140">На локальном компьютере нельзя указать службу проверки подлинности для вызовов WMI.</span><span class="sxs-lookup"><span data-stu-id="44748-140">On the local machine you cannot specify an authentication service for calls to WMI.</span></span> <span data-ttu-id="44748-141">Дополнительные сведения см. в разделе [Настройка службы проверки подлинности с помощью VBScript](setting-the-authentication-service-using-vbscript.md) и [Создание строки моникера](constructing-a-moniker-string.md).</span><span class="sxs-lookup"><span data-stu-id="44748-141">For more information, see [Setting the Authentication Service Using VBScript](setting-the-authentication-service-using-vbscript.md) and [Constructing a Moniker String](constructing-a-moniker-string.md).</span></span>

 

 
