---
title: Масштабирование Mixed-Mode DPI и API с поддержкой DPI
description: .
ms.assetid: 44AC0B29-3283-4801-90F5-3E78CCD87B9F
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fb9f8a8f72b199aaba195002134855155925b30d
ms.sourcegitcommit: ebd3ce6908ff865f1ef66f2fc96769be0aad82e1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2020
ms.locfileid: "103987377"
---
# <a name="mixed-mode-dpi-scaling-and-dpi-aware-apis"></a><span data-ttu-id="92af1-103">Масштабирование Mixed-Mode DPI и API с поддержкой DPI</span><span class="sxs-lookup"><span data-stu-id="92af1-103">Mixed-Mode DPI Scaling and DPI-aware APIs</span></span>

## <a name="sub-process-dpi-awareness-support"></a><span data-ttu-id="92af1-104">Поддержка поддержки Sub-Process DPI</span><span class="sxs-lookup"><span data-stu-id="92af1-104">Sub-Process DPI Awareness Support</span></span>

<span data-ttu-id="92af1-105">[**Сетсреаддпиаваренессконтекст**](/windows/desktop/api/Winuser/nf-winuser-setthreaddpiawarenesscontext) позволяет использовать различные режимы масштабирования DPI в рамках одного процесса.</span><span class="sxs-lookup"><span data-stu-id="92af1-105">[**SetThreadDpiAwarenessContext**](/windows/desktop/api/Winuser/nf-winuser-setthreaddpiawarenesscontext) enables the use of different DPI scaling modes within a single process.</span></span> <span data-ttu-id="92af1-106">До наступления годовщины Windows 10 система отслеживания DPI в окне была привязана к режиму поддержки DPI в масштабе всего процесса (не учитывает DPI, DPI на уровне системы или Per-Monitor DPI).</span><span class="sxs-lookup"><span data-stu-id="92af1-106">Prior to the Windows 10 Anniversary Update, a window s DPI awareness was bound to the process-wide DPI awareness mode (DPI unaware, System DPI aware, or Per-Monitor DPI aware).</span></span> <span data-ttu-id="92af1-107">Но теперь, когда **сетсреаддпиаваренессконтекст**, окна верхнего уровня могут иметь режим поддержки dpi, отличный от режима поддержки dpi в масштабе процесса.</span><span class="sxs-lookup"><span data-stu-id="92af1-107">But now, with **SetThreadDpiAwarenessContext**, top-level windows can have a DPI awareness mode that is different than that of the process-wide DPI awareness mode.</span></span> <span data-ttu-id="92af1-108">Это также влияет на дочерние окна, так как они всегда будут иметь тот же режим поддержки DPI, что и их родительское окно.</span><span class="sxs-lookup"><span data-stu-id="92af1-108">This also effects child windows, as they will always have the same DPI awareness mode as their parent window.</span></span>

<span data-ttu-id="92af1-109">Использование **сетсреаддпиаваренессконтекст** позволяет разработчикам решить, где нужно сосредоточиться на разработке при определении поведения для настольных приложений в различных масштабах.</span><span class="sxs-lookup"><span data-stu-id="92af1-109">The use of **SetThreadDpiAwarenessContext** enables developers to decide where they want to focus their development efforts when defining DPI-specific behavior for desktop applications.</span></span> <span data-ttu-id="92af1-110">Например, основное окно приложения верхнего уровня можно масштабировать на отдельном мониторе, в то время как вторичные окна верхнего уровня можно масштабировать с помощью масштабирования по точечным рисункам операционной системы.</span><span class="sxs-lookup"><span data-stu-id="92af1-110">For example, an application's primary top-level window could be scaled on a per-monitor basis while secondary top-level windows could be scaled via bitmap-scaling by the operating system.</span></span>

## <a name="the-dpi-awareness-context"></a><span data-ttu-id="92af1-111">Контекст осведомленности о DPI</span><span class="sxs-lookup"><span data-stu-id="92af1-111">The DPI Awareness Context</span></span>

<span data-ttu-id="92af1-112">До уровня доступности **сетсреаддпиаваренессконтекст** сведения о dpi для процесса были определены либо в манифесте двоичного файла приложения, либо посредством вызова [**сетпроцессдпиаваренесс**](/windows/desktop/api/ShellScalingAPI/nf-shellscalingapi-setprocessdpiawareness) во время инициализации процесса.</span><span class="sxs-lookup"><span data-stu-id="92af1-112">Prior to the availability of **SetThreadDpiAwarenessContext** the DPI awareness of a process was defined either in the manifest of the application binary or via a call to [**SetProcessDpiAwareness**](/windows/desktop/api/ShellScalingAPI/nf-shellscalingapi-setprocessdpiawareness) during process initialization.</span></span> <span data-ttu-id="92af1-113">При использовании **сетсреаддпиаваренессконтекст** каждый поток может иметь контекст осведомленности об уровне dpi, который может отличаться от контекста режима поддержки dpi в масштабе процесса.</span><span class="sxs-lookup"><span data-stu-id="92af1-113">With **SetThreadDpiAwarenessContext**, each thread can have an individual DPI awareness context that may be different than that of the process-wide DPI awareness mode.</span></span> <span data-ttu-id="92af1-114">Контекст, осведомленный о DPI в потоке, представлен с типом \* \* \* \*, [ \_ \_ осведомленности о dpi](dpi-awareness-context.md) , и ведет себя следующим образом:</span><span class="sxs-lookup"><span data-stu-id="92af1-114">The DPI awareness context of a thread is represented with the [\*\*\*\*DPI\_AWARENESS\_CONTEXT\*\*\*\*](dpi-awareness-context.md) type, and behaves in the following ways:</span></span>

-   <span data-ttu-id="92af1-115">В любой момент времени в потоке может быть изменен контекст осведомленности о DPI.</span><span class="sxs-lookup"><span data-stu-id="92af1-115">A thread can have its DPI awareness context changed at any time.</span></span>
-   <span data-ttu-id="92af1-116">Любые вызовы API, сделанные после изменения контекста, будут выполняться в соответствующем контексте DPI (и могут быть виртуализированы).</span><span class="sxs-lookup"><span data-stu-id="92af1-116">Any API calls that are made after the context is changed will run in the corresponding DPI context (and may be virtualized).</span></span>
-   <span data-ttu-id="92af1-117">При создании окна его поддержка DPI определяется как осведомленность о DPI вызывающего потока в это время.</span><span class="sxs-lookup"><span data-stu-id="92af1-117">When a window is created, its DPI awareness is defined as the DPI awareness of the calling thread at that time.</span></span>
-   <span data-ttu-id="92af1-118">При вызове окна процедуры для окна поток автоматически переключается на контекст осведомленности о DPI, который использовался при создании окна.</span><span class="sxs-lookup"><span data-stu-id="92af1-118">When the window procedure for a window is called, the thread is automatically switched to the DPI awareness context that was in use when the window was created.</span></span>

<span data-ttu-id="92af1-119">Распространенным сценарием использования **сетсреаддпиаваренессконтекст** является следующее: начать с потока, который выполняется с одним контекстом (например, **\_ контекст осведомленности о dpi \_ \_ на \_ монитор \_**), временно переключиться в другой контекст (неосведомленный **\_ \_ контекст \_ о dpi**), создать окно, а затем немедленно переключить контекст потока обратно в предыдущее состояние.</span><span class="sxs-lookup"><span data-stu-id="92af1-119">A common scenario for the use of **SetThreadDpiAwarenessContext** is as follows: Begin with a thread that is running with one context (such as **DPI\_AWARENESS\_CONTEXT\_PER\_MONITOR\_AWARE**) temporarily switch to a different context (**DPI\_AWARENESS\_CONTEXT\_UNAWARE**), create a window, and then immediately switch the thread context back to its previous state.</span></span> <span data-ttu-id="92af1-120">Созданное окно будет иметь контекст DPI в **\_ \_ контексте \_ осведомленности о dpi**, в то время как контекст вызывающего потока s будет восстановлен в **\_ контексте осведомленности \_ \_ \_ \_ о мониторинге на монитор** при последующем вызове **сетсреаддпиаваренессконтекст**.</span><span class="sxs-lookup"><span data-stu-id="92af1-120">The created window will have a DPI context of **DPI\_AWARENESS\_CONTEXT\_UNAWARE**, while the calling thread s context will be restored to **DPI\_AWARENESS\_CONTEXT\_PER\_MONITOR\_AWARE** with a subsequent call to **SetThreadDpiAwarenessContext**.</span></span> <span data-ttu-id="92af1-121">В этом сценарии окно, связанное с вызывающим потоком, будет выполняться с контекстом для каждого монитора (и, следовательно, не будет растягиваться операционной системой), тогда как только что созданное окно не будет поддерживать DPI (и, следовательно, будет автоматически растягиваться в наборе отображения на >100% масштабирования).</span><span class="sxs-lookup"><span data-stu-id="92af1-121">In this scenario, the window associated with the calling thread would run with a per-monitor context (and therefore not be bitmap-stretched by the operating system) while the newly-created window would not be DPI aware (and therefore would be automatically bitmap stretched on a display set to >100% scaling).</span></span>

<span data-ttu-id="92af1-122">На рис. 1 показано, как основной поток процесса выполняется **с \_ контекстом осведомленности о dpi \_ \_ на \_ мониторе**, переключается в контекст **\_ осведомленности \_ \_** о несоответствии контекста и создает новое окно.</span><span class="sxs-lookup"><span data-stu-id="92af1-122">Figure 1 illustrates how the main process thread executes with **DPI\_AWARENESS\_CONTEXT\_PER\_MONITOR**, switches its context to **DPI\_AWARENESS\_CONTEXT\_UNAWARE**, and creates a new window.</span></span> <span data-ttu-id="92af1-123">Вновь созданное окно затем выполняется с контекстом, осведомленным об уровне dpi, независимо от того, отправляется ли сообщение в него или когда в него вносятся вызовы API. **\_ \_ \_**</span><span class="sxs-lookup"><span data-stu-id="92af1-123">The newly created window then executes with a DPI awareness context of **DPI\_AWARENESS\_CONTEXT\_UNAWARE** whenever a message is dispatched to it or API calls are made from it.</span></span> <span data-ttu-id="92af1-124">Сразу после создания нового окна основной поток восстанавливается до предыдущего контекста в **\_ контексте осведомленности о dpi \_ для \_ каждого \_ монитора**.</span><span class="sxs-lookup"><span data-stu-id="92af1-124">Immediately after creating the new window the main thread is restored to its previous context of **DPI\_AWARENESS\_CONTEXT\_PER\_MONITOR**.</span></span>

![Схема, показывающая осведомленность о dpi на уровне каждого монитора в действии](images/dpi-awareness-context.png)

## <a name="new-dpi-related-apis"></a><span data-ttu-id="92af1-126">Новые API-интерфейсы, связанные с DPI</span><span class="sxs-lookup"><span data-stu-id="92af1-126">New DPI-related APIs</span></span>

<span data-ttu-id="92af1-127">Помимо поддержки различных режимов определения DPI в рамках одного процесса, **сетсреаддпиаваренессконтекст** предложение, для классических приложений добавлены следующие функции, относящиеся к DPI:</span><span class="sxs-lookup"><span data-stu-id="92af1-127">In addition to the support for different DPI awareness modes within a single process that **SetThreadDpiAwarenessContext** offers, the following DPI-specific functionality has been added for desktop applications:</span></span><dl> <dd>[<span data-ttu-id="92af1-128">Енабленонклиентдпискалинг \* \* \* \*</span><span class="sxs-lookup"><span data-stu-id="92af1-128">\*\*\*\*EnableNonClientDpiScaling\*\*\*\*</span></span>](/windows/desktop/api/Winuser/nf-winuser-enablenonclientdpiscaling)<dl> <dt>



> [!Note]  
> <span data-ttu-id="92af1-129">Режим поддержки **каждого монитора версии 2** dpi автоматически включает эту функцию, и вызов **енабленонклиентдпискалинг** , следовательно, не требуется в приложениях, использующих его.</span><span class="sxs-lookup"><span data-stu-id="92af1-129">The **Per Monitor V2** DPI awareness mode automatically enables this functionality, and calling **EnableNonClientDpiScaling** is therefore unnecessary in applications using it.</span></span>

 

<span data-ttu-id="92af1-130">Вызов **енабленонклиентдпискалинг** из обработчика Window s **WM \_ нккреате** приведет к тому, что неклиентская область окна верхнего уровня автоматически масштабируется для dpi.</span><span class="sxs-lookup"><span data-stu-id="92af1-130">Calling **EnableNonClientDpiScaling** from within a window s **WM\_NCCREATE** handler will result in the non-client area of a top-level window automatically scaling for DPI.</span></span> <span data-ttu-id="92af1-131">Если окно верхнего уровня ориентировано на контроль DPI (независимо от того, является ли сам процесс ориентированным на контроль DPI или если окно было создано в рамках потока с поддержкой DPI для каждого монитора), строка заголовка, полосы прокрутки, меню и строки меню этих окон будут масштабироваться при каждом изменении DPI в Window s.</span><span class="sxs-lookup"><span data-stu-id="92af1-131">If the top-level window is per-monitor DPI-aware (whether because the process itself is per-monitor DPI-aware or because the window was created within a per-monitor DPI-aware thread), the caption bar, scroll bars, menus, and menu bars of these windows will DPI-scale whenever the window s DPI changes.</span></span>
</dt> <dt>

<span data-ttu-id="92af1-132">Обратите внимание, что неклиентские области дочернего окна, например неклиентские полосы прокрутки дочернего элемента управления "текст", не будут автоматически масштабироваться при использовании этого API.</span><span class="sxs-lookup"><span data-stu-id="92af1-132">Note that non-client areas of a child window, such as non-client scroll bars of a child edit control, will not DPI scale automatically when this API is used.</span></span>
</dt> <dt>

> [!Note]  
> <span data-ttu-id="92af1-133">**Енабленонклиентдпискалинг** должен вызываться из обработчика **\_ нккреате WM** .</span><span class="sxs-lookup"><span data-stu-id="92af1-133">**EnableNonClientDpiScaling** must be called from the **WM\_NCCREATE** handler.</span></span>

</dt> </dl> </dd> <dd> <span data-ttu-id="92af1-134"><b> API-интерфейсы Фордпи </b></span><span class="sxs-lookup"><span data-stu-id="92af1-134"><b> The \*ForDpi APIs </b></span></span>

-   <span data-ttu-id="92af1-135">Несколько часто используемых интерфейсов API, таких как [**жетсистемметрикс**](/windows/desktop/api/winuser/nf-winuser-getsystemmetrics) , не имеют контекста HWND и поэтому не имеют возможности вычислить соответствующую информацию о dpi для возвращаемых значений.</span><span class="sxs-lookup"><span data-stu-id="92af1-135">Several frequently-used APIs such as [**GetSystemMetrics**](/windows/desktop/api/winuser/nf-winuser-getsystemmetrics) do not have any context of an HWND and therefore have no way of deducing the proper DPI awareness for their return values.</span></span> <span data-ttu-id="92af1-136">Вызов этих API из потока, который выполняется в другом режиме поддержки DPI или в контексте, может возвращать значения, которые не масштабируются для контекста вызывающего потока.</span><span class="sxs-lookup"><span data-stu-id="92af1-136">Calling these APIs from a thread that is running in a different DPI awareness mode or context may return values that are not scaled for the context of the calling thread.</span></span> <span data-ttu-id="92af1-137">[\* \* \* \* Жетсистемметрикфордпи \* \*](/windows/desktop/api/Winuser/nf-winuser-getsystemmetricsfordpi)\* *, \* \* \* \* [системпараметерсинфофордпи \* \*](/windows/desktop/api/Winuser/nf-winuser-systemparametersinfofordpi)* \*, и [\* \* \* \* аджуствиндовректексфордпи \* \*](/windows/desktop/api/Winuser/nf-winuser-adjustwindowrectexfordpi) \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \*</span><span class="sxs-lookup"><span data-stu-id="92af1-137">[\*\*\*\*GetSystemMetricForDpi\*\*\*\*](/windows/desktop/api/Winuser/nf-winuser-getsystemmetricsfordpi), [\*\*\*\*SystemParametersInfoForDpi\*\*\*\*](/windows/desktop/api/Winuser/nf-winuser-systemparametersinfofordpi), and [\*\*\*\*AdjustWindowRectExForDpi\*\*\*\*](/windows/desktop/api/Winuser/nf-winuser-adjustwindowrectexfordpi) will perform the same functionality as their DPI unaware counterparts, but take a DPI as an argument and infer the dpi awareness from the current thread's context.</span></span>
-   <span data-ttu-id="92af1-138">**Жетсистемметрикфордпи** и **системпараметерсинфофордпи** будут возвращать значения системной метрики масштабирования DPI и значения системного параметра в соответствии с этим уравнением:</span><span class="sxs-lookup"><span data-stu-id="92af1-138">**GetSystemMetricForDpi** and **SystemParametersInfoForDpi** will return DPI-scaled system metric values and system parameter values in accordance to this equation:</span></span>

    |                                                                 |
    |-----------------------------------------------------------------|
    | <span data-ttu-id="92af1-139">Жетсистемметрикс (...) @ dpi = = Жетсистемметриксфордпи (..., DPI)</span><span class="sxs-lookup"><span data-stu-id="92af1-139">GetSystemMetrics(...) @ dpi == GetSystemMetricsForDpi(..., dpi)</span></span> |

    

     

    <span data-ttu-id="92af1-140">Таким образом, при вызове **жетсистемметрикс** (или **системпараметерсинфофордпи**) при выполнении на устройстве с определенным значением dpi на уровне системы будет возвращено то же значение, что и их варианты, учитывающие dpi (**жетсистемметриксфордпи** и **системпараметерсинфофордпи**), с учетом того же значения DPI, что и входные данные.</span><span class="sxs-lookup"><span data-stu-id="92af1-140">Therefore, calling **GetSystemMetrics** (or **SystemParametersInfoForDpi**), while running on a device with a certain system DPI value will return the same value that their DPI aware variants (**GetSystemMetricsForDpi** and **SystemParametersInfoForDpi**) will, given the same DPI value as input.</span></span>

-   <span data-ttu-id="92af1-141">[**Аджуствиндовректексфордпи**](/windows/desktop/api/Winuser/nf-winuser-adjustwindowrectexfordpi) принимает HWND и вычисляет требуемый размер прямоугольника окна с учетом dpi.</span><span class="sxs-lookup"><span data-stu-id="92af1-141">[**AdjustWindowRectExForDpi**](/windows/desktop/api/Winuser/nf-winuser-adjustwindowrectexfordpi) takes an HWND and will calculate the required size of a window rectangle in a DPI-sensitive way.</span></span>

</dd> <dd>

</dd> <dd><span data-ttu-id="92af1-142"><b><a href="/windows/desktop/api/Winuser/nf-winuser-getdpiforwindow">жетдпифорвиндов</a></b></span><span class="sxs-lookup"><span data-stu-id="92af1-142"><b><a href="/windows/desktop/api/Winuser/nf-winuser-getdpiforwindow">GetDpiForWindow</a></b></span></span><dl> <span data-ttu-id="92af1-143"><dt><b>Жетдпифорвиндов</b> будет возвращать значение dpi, связанное с ПРЕДОСТАВЛЕНным дескриптором HWND.</span><span class="sxs-lookup"><span data-stu-id="92af1-143"><dt> <b>GetDpiForWindow</b> will return the DPI associated with the HWND provided.</span></span> <span data-ttu-id="92af1-144">Ответ будет зависеть от режима поддержки DPI для HWND:</span><span class="sxs-lookup"><span data-stu-id="92af1-144">The answer will depend on the DPI awareness mode of the HWND:</span></span>

| <span data-ttu-id="92af1-145">Режим поддержки точек на дюйм для HWND</span><span class="sxs-lookup"><span data-stu-id="92af1-145">DPI Awareness mode of HWND</span></span> | <span data-ttu-id="92af1-146">Возвращаемое значение</span><span class="sxs-lookup"><span data-stu-id="92af1-146">Return value</span></span>                                                                                                                                                                                                  |
|----------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="92af1-147">Связан</span><span class="sxs-lookup"><span data-stu-id="92af1-147">Unaware</span></span>                    | <span data-ttu-id="92af1-148">96</span><span class="sxs-lookup"><span data-stu-id="92af1-148">96</span></span>                                                                                                                                                                                                            |
| <span data-ttu-id="92af1-149">Система</span><span class="sxs-lookup"><span data-stu-id="92af1-149">System</span></span>                     | <span data-ttu-id="92af1-150">DPI на уровне системы</span><span class="sxs-lookup"><span data-stu-id="92af1-150">The system DPI</span></span>                                                                                                                                                                                                |
| <span data-ttu-id="92af1-151">Per-Monitor</span><span class="sxs-lookup"><span data-stu-id="92af1-151">Per-Monitor</span></span>                | <span data-ttu-id="92af1-152">РАЗРЕШЕНИЕ экрана, в котором в первую очередь размещается связанное окно верхнего уровня</span><span class="sxs-lookup"><span data-stu-id="92af1-152">The DPI of display that the associated top-level window is primarily located on</span></span> <br/> <span data-ttu-id="92af1-153">(Если указано дочернее окно, будет возвращено значение DPI соответствующего родительского окна верхнего уровня).</span><span class="sxs-lookup"><span data-stu-id="92af1-153">(If a child window is provided, the DPI of the corresponding top-level parent window will be returned)</span></span><br/> |

</dt> </dl> </dd> <dd><span data-ttu-id="92af1-154"><b><a href="/windows/desktop/api/Winuser/nf-winuser-getdpiforsystem">жетдпифорсистем</a></b></span><span class="sxs-lookup"><span data-stu-id="92af1-154"><b><a href="/windows/desktop/api/Winuser/nf-winuser-getdpiforsystem">GetDpiForSystem</a></b></span></span><dl> <dt>

<span data-ttu-id="92af1-155">Вызов **жетдпифорсистем** более эффективен, чем вызов [**GetDC**](/windows/desktop/api/winuser/nf-winuser-getdc) и [**жетдевицекапс**](/windows/desktop/api/wingdi/nf-wingdi-getdevicecaps) для получения dpi системы.</span><span class="sxs-lookup"><span data-stu-id="92af1-155">Calling **GetDpiForSystem** is more efficient than calling [**GetDC**](/windows/desktop/api/winuser/nf-winuser-getdc) and [**GetDeviceCaps**](/windows/desktop/api/wingdi/nf-wingdi-getdevicecaps) to obtain the system DPI.</span></span>
</dt> <dt>

<span data-ttu-id="92af1-156">Любой компонент, который может выполняться в приложении, использующем осведомленность о DPI в подпроцессах, не должен рассчитывать на то, что значение DPI системы является статическим во время жизненного цикла процесса.</span><span class="sxs-lookup"><span data-stu-id="92af1-156">Any component that could be running in an application that uses sub-process DPI awareness should not assume that the system DPI is static during the lifecycle of the process.</span></span> <span data-ttu-id="92af1-157">Например, если поток, который выполняется в **\_ контексте осведомленности \_ \_** о том, что контекст неосведомленен о том, запрашивает dpi на уровне системы, ответ будет 96.</span><span class="sxs-lookup"><span data-stu-id="92af1-157">For example, if a thread that is running under **DPI\_AWARENESS\_CONTEXT\_UNAWARE** awareness context queries the system DPI, the answer will be 96.</span></span> <span data-ttu-id="92af1-158">Тем не менее, если тот же поток переключился на контекст осведомленности о состоянии **\_ \_ \_ системы** и не запрашивает dpi на уровне системы, ответ может отличаться.</span><span class="sxs-lookup"><span data-stu-id="92af1-158">However, if that same thread switched to **DPI\_AWARENESS\_CONTEXT\_SYSTEM** awareness context and queried the system DPI again, the answer could be different.</span></span> <span data-ttu-id="92af1-159">Чтобы избежать использования кэшированного (и, возможно, устаревшего) значения системного DPI, используйте **жетдпифорсистем** , чтобы получить значение dpi системы относительно режима поддержки dpi вызывающего потока.</span><span class="sxs-lookup"><span data-stu-id="92af1-159">To avoid the use of a cached (and possibly stale) system-DPI value, use **GetDpiForSystem** to retrieve the system DPI relative to the DPI awareness mode of the calling thread.</span></span> 
</dt> </dl> </dd> </dl>