---
description: Приложения должны синхронизировать доступ к переменным, которые являются общими для нескольких потоков.
ms.assetid: 729c0e68-ef52-4d6c-b771-a89043a937e6
title: Доступ к блокируемым переменным
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ca2e083d3e3420e870ad9781b0d262df3d0786f1
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105663883"
---
# <a name="interlocked-variable-access"></a><span data-ttu-id="1ea19-103">Доступ к блокируемым переменным</span><span class="sxs-lookup"><span data-stu-id="1ea19-103">Interlocked Variable Access</span></span>

<span data-ttu-id="1ea19-104">Приложения должны синхронизировать доступ к переменным, которые являются общими для нескольких потоков.</span><span class="sxs-lookup"><span data-stu-id="1ea19-104">Applications must synchronize access to variables that are shared by multiple threads.</span></span> <span data-ttu-id="1ea19-105">Приложения также должны гарантировать, что операции с этими переменными выполняются атомарно (полностью или вообще).</span><span class="sxs-lookup"><span data-stu-id="1ea19-105">Applications must also ensure that operations on these variables are performed atomically (performed in their entirety or not at all.)</span></span>

<span data-ttu-id="1ea19-106">Простые операции чтения и записи с надлежащим образом согласованными 32-разрядными переменными являются атомарными операциями.</span><span class="sxs-lookup"><span data-stu-id="1ea19-106">Simple reads and writes to properly-aligned 32-bit variables are atomic operations.</span></span> <span data-ttu-id="1ea19-107">Иными словами, не придется обновлять только одну часть переменной. все биты обновляются атомарным образом.</span><span class="sxs-lookup"><span data-stu-id="1ea19-107">In other words, you will not end up with only one portion of the variable updated; all bits are updated in an atomic fashion.</span></span> <span data-ttu-id="1ea19-108">Однако синхронизация доступа не гарантируется.</span><span class="sxs-lookup"><span data-stu-id="1ea19-108">However, access is not guaranteed to be synchronized.</span></span> <span data-ttu-id="1ea19-109">Если два потока считывают и записываются из одной и той же переменной, невозможно определить, будет ли один поток выполнять операцию чтения, прежде чем другой выполняет операцию записи.</span><span class="sxs-lookup"><span data-stu-id="1ea19-109">If two threads are reading and writing from the same variable, you cannot determine if one thread will perform its read operation before the other performs its write operation.</span></span>

<span data-ttu-id="1ea19-110">Простые операции чтения и записи для правильно согласованных 64-разрядных переменных являются атомарными для 64-разрядных систем Windows.</span><span class="sxs-lookup"><span data-stu-id="1ea19-110">Simple reads and writes to properly aligned 64-bit variables are atomic on 64-bit Windows.</span></span> <span data-ttu-id="1ea19-111">Операции чтения и записи в 64-разрядные значения не обязательно должны быть атомарными в 32-разрядной версии Windows.</span><span class="sxs-lookup"><span data-stu-id="1ea19-111">Reads and writes to 64-bit values are not guaranteed to be atomic on 32-bit Windows.</span></span> <span data-ttu-id="1ea19-112">Операции чтения и записи в переменные других размеров не обязательно должны быть атомарными на какой бы то ни было платформе.</span><span class="sxs-lookup"><span data-stu-id="1ea19-112">Reads and writes to variables of other sizes are not guaranteed to be atomic on any platform.</span></span>

## <a name="the-interlocked-api"></a><span data-ttu-id="1ea19-113">Блокируемый API</span><span class="sxs-lookup"><span data-stu-id="1ea19-113">The Interlocked API</span></span>

<span data-ttu-id="1ea19-114">Блокируемые функции предоставляют простой механизм для синхронизации доступа к переменной, совместно используемой несколькими потоками.</span><span class="sxs-lookup"><span data-stu-id="1ea19-114">The interlocked functions provide a simple mechanism for synchronizing access to a variable that is shared by multiple threads.</span></span> <span data-ttu-id="1ea19-115">Они также выполняют операции с переменными атомарным способом.</span><span class="sxs-lookup"><span data-stu-id="1ea19-115">They also perform operations on variables in an atomic manner.</span></span> <span data-ttu-id="1ea19-116">Потоки различных процессов могут использовать эти функции, если переменная находится в общей памяти.</span><span class="sxs-lookup"><span data-stu-id="1ea19-116">The threads of different processes can use these functions if the variable is in shared memory.</span></span>

<span data-ttu-id="1ea19-117">Функции [**интерлоккединкремент**](/windows/win32/api/winnt/nf-winnt-interlockedincrement) и [**интерлоккеддекремент**](/windows/win32/api/winnt/nf-winnt-interlockeddecrement) объединяют шаги, связанные с увеличением или уменьшением переменной, в атомарную операцию.</span><span class="sxs-lookup"><span data-stu-id="1ea19-117">The [**InterlockedIncrement**](/windows/win32/api/winnt/nf-winnt-interlockedincrement) and [**InterlockedDecrement**](/windows/win32/api/winnt/nf-winnt-interlockeddecrement) functions combine the steps involved in incrementing or decrementing a variable into an atomic operation.</span></span> <span data-ttu-id="1ea19-118">Эта функция полезна в многозадачной операционной системе, в которой система может прерывать выполнение одного потока, чтобы предоставить срез времени процессора другому потоку.</span><span class="sxs-lookup"><span data-stu-id="1ea19-118">This feature is useful in a multitasking operating system, in which the system can interrupt one thread's execution to grant a slice of processor time to another thread.</span></span> <span data-ttu-id="1ea19-119">Без такой синхронизации два потока могут считать одно и то же значение, увеличивать его на 1 и сохранять новое значение для общего увеличения 1 вместо 2.</span><span class="sxs-lookup"><span data-stu-id="1ea19-119">Without such synchronization, two threads could read the same value, increment it by 1, and store the new value for a total increase of 1 instead of 2.</span></span> <span data-ttu-id="1ea19-120">Блокируемые функции доступа к переменным, защищающие от подобных ошибок.</span><span class="sxs-lookup"><span data-stu-id="1ea19-120">The interlocked variable-access functions protect against this kind of error.</span></span>

<span data-ttu-id="1ea19-121">Функции [**интерлоккедексчанже**](/windows/win32/api/winnt/nf-winnt-interlockedexchange) и [**интерлоккедексчанжепоинтер**](/windows/win32/api/winnt/nf-winnt-interlockedexchangepointer) атомарно обмениваются значениями указанных переменных.</span><span class="sxs-lookup"><span data-stu-id="1ea19-121">The [**InterlockedExchange**](/windows/win32/api/winnt/nf-winnt-interlockedexchange) and [**InterlockedExchangePointer**](/windows/win32/api/winnt/nf-winnt-interlockedexchangepointer) functions atomically exchange the values of the specified variables.</span></span> <span data-ttu-id="1ea19-122">Функция [**интерлоккедексчанжеадд**](/windows/win32/api/winnt/nf-winnt-interlockedexchangeadd) объединяет две операции: одновременное добавление двух переменных и сохранение результата в одной из переменных.</span><span class="sxs-lookup"><span data-stu-id="1ea19-122">The [**InterlockedExchangeAdd**](/windows/win32/api/winnt/nf-winnt-interlockedexchangeadd) function combines two operations: adding two variables together and storing the result in one of the variables.</span></span>

<span data-ttu-id="1ea19-123">Функции [**интерлоккедкомпариксчанже**](/windows/win32/api/winnt/nf-winnt-interlockedcompareexchange), [**InterlockedCompare64Exchange128**](/previous-versions/windows/desktop/legacy/ms683553(v=vs.85))и [**интерлоккедкомпариксчанжепоинтер**](/windows/win32/api/winnt/nf-winnt-interlockedcompareexchangepointer) объединяют две операции: сравнение двух значений и сохранение третьего значения в одной из переменных в зависимости от результата сравнения.</span><span class="sxs-lookup"><span data-stu-id="1ea19-123">The [**InterlockedCompareExchange**](/windows/win32/api/winnt/nf-winnt-interlockedcompareexchange), [**InterlockedCompare64Exchange128**](/previous-versions/windows/desktop/legacy/ms683553(v=vs.85)), and [**InterlockedCompareExchangePointer**](/windows/win32/api/winnt/nf-winnt-interlockedcompareexchangepointer) functions combine two operations: comparing two values and storing a third value in one of the variables, based on the outcome of the comparison.</span></span>

<span data-ttu-id="1ea19-124">Функции [**интерлоккеданд**](/windows/win32/api/winnt/nf-winnt-interlockedand), [**взаимоблокировки**](/windows/win32/api/winnt/nf-winnt-interlockedor)и [**интерлоккедксор**](/windows/win32/api/winnt/nf-winnt-interlockedxor) выполняют атомарное выполнение операций and, OR и XOR соответственно.</span><span class="sxs-lookup"><span data-stu-id="1ea19-124">The [**InterlockedAnd**](/windows/win32/api/winnt/nf-winnt-interlockedand), [**InterlockedOr**](/windows/win32/api/winnt/nf-winnt-interlockedor), and [**InterlockedXor**](/windows/win32/api/winnt/nf-winnt-interlockedxor) functions atomically perform AND, OR, and XOR operations, respectively.</span></span>

<span data-ttu-id="1ea19-125">Существуют функции, специально предназначенные для блокировки доступа к переменным в 64-битных значениях и адресах памяти и оптимизированные для использования в 64-разрядной версии Windows.</span><span class="sxs-lookup"><span data-stu-id="1ea19-125">There are functions that are specifically designed to perform interlocked variable access on 64-bit memory values and addresses, and are optimized for use on 64-bit Windows.</span></span> <span data-ttu-id="1ea19-126">Каждая из этих функций содержит "64" в имени; Например, [**InterlockedDecrement64**](/windows/win32/api/winnt/nf-winnt-interlockeddecrement64) и [**InterlockedCompareExchangeAcquire64**](/previous-versions/windows/desktop/legacy/ms683566(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="1ea19-126">Each of these functions contains "64" in the name; for example, [**InterlockedDecrement64**](/windows/win32/api/winnt/nf-winnt-interlockeddecrement64) and [**InterlockedCompareExchangeAcquire64**](/previous-versions/windows/desktop/legacy/ms683566(v=vs.85)).</span></span>

<span data-ttu-id="1ea19-127">Большая часть блокируемых функций предоставляет полные барьеры памяти на всех платформах Windows.</span><span class="sxs-lookup"><span data-stu-id="1ea19-127">Most of the interlocked functions provide full memory barriers on all Windows platforms.</span></span> <span data-ttu-id="1ea19-128">Существуют также функции, сочетающие базовые операции доступа с блокируемыми переменными с семантикой упорядочивания и освобождения памяти, поддерживаемой определенными процессорами.</span><span class="sxs-lookup"><span data-stu-id="1ea19-128">There are also functions that combine the basic interlocked variable access operations with the acquire and release memory ordering semantics supported by certain processors.</span></span> <span data-ttu-id="1ea19-129">Каждая из этих функций содержит слово "получение" или "выпуск" в именах; Например, [**интерлоккеддекрементаккуире**](/previous-versions/windows/desktop/legacy/ms683583(v=vs.85)) и [**интерлоккеддекрементрелеасе**](/previous-versions/windows/desktop/legacy/ms683586(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="1ea19-129">Each of these functions contains the word "Acquire" or "Release" in their names; for example, [**InterlockedDecrementAcquire**](/previous-versions/windows/desktop/legacy/ms683583(v=vs.85)) and [**InterlockedDecrementRelease**](/previous-versions/windows/desktop/legacy/ms683586(v=vs.85)).</span></span> <span data-ttu-id="1ea19-130">Семантика получения памяти указывает, что операция с памятью, выполняемая текущим потоком, будет видна перед попыткой выполнения любых других операций с памятью.</span><span class="sxs-lookup"><span data-stu-id="1ea19-130">Acquire memory semantics specify that the memory operation being performed by the current thread will be visible before any other memory operations are attempted.</span></span> <span data-ttu-id="1ea19-131">Семантика высвобождения памяти указывает, что операция с памятью, выполняемая текущим потоком, будет видна после завершения всех других операций с памятью.</span><span class="sxs-lookup"><span data-stu-id="1ea19-131">Release memory semantics specify that the memory operation being performed by the current thread will be visible after all other memory operations have been completed.</span></span> <span data-ttu-id="1ea19-132">Эти семантики позволяют принудительно выполнять операции с памятью в определенном порядке.</span><span class="sxs-lookup"><span data-stu-id="1ea19-132">These semantics allow you to force memory operations to be performed in a specific order.</span></span> <span data-ttu-id="1ea19-133">Используйте семантику получения при вводе защищенной области и семантики выпуска при ее сохранении.</span><span class="sxs-lookup"><span data-stu-id="1ea19-133">Use acquire semantics when entering a protected region and release semantics when leaving it.</span></span>

## <a name="related-topics"></a><span data-ttu-id="1ea19-134">См. также</span><span class="sxs-lookup"><span data-stu-id="1ea19-134">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="1ea19-135">Встроенные инструкции компилятора</span><span class="sxs-lookup"><span data-stu-id="1ea19-135">Compiler Intrinsics</span></span>](/cpp/intrinsics/compiler-intrinsics?view=vs-2019)
</dt> <dt>

[<span data-ttu-id="1ea19-136">Проблемы синхронизации и многопроцессорности</span><span class="sxs-lookup"><span data-stu-id="1ea19-136">Synchronization and Multiprocessor Issues</span></span>](synchronization-and-multiprocessor-issues.md)
</dt> </dl>

 

 
