---
description: Объект критической секции обеспечивает синхронизацию, аналогичную той, которая предоставляется объектом Mutex, за исключением того, что критическая секция может использоваться только потоками одного процесса.
ms.assetid: 2ec11a42-3d12-4d60-9dd7-dc38926d56e1
title: Объекты критических секций
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: cbcada1f2ddbc6d370445f36a3dbd51c5c9f54bf
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105663886"
---
# <a name="critical-section-objects"></a><span data-ttu-id="6359c-103">Объекты критических секций</span><span class="sxs-lookup"><span data-stu-id="6359c-103">Critical Section Objects</span></span>

<span data-ttu-id="6359c-104">*Объект критической секции* обеспечивает синхронизацию, аналогичную той, которая предоставляется объектом Mutex, за исключением того, что критическая секция может использоваться только потоками одного процесса.</span><span class="sxs-lookup"><span data-stu-id="6359c-104">A *critical section object* provides synchronization similar to that provided by a mutex object, except that a critical section can be used only by the threads of a single process.</span></span> <span data-ttu-id="6359c-105">Объекты критических секций нельзя совместно использовать в процессах.</span><span class="sxs-lookup"><span data-stu-id="6359c-105">Critical section objects cannot be shared across processes.</span></span>

<span data-ttu-id="6359c-106">Объекты событий, мьютексов и семафоров также можно использовать в однопроцессном приложении, но критически важные объекты раздела обеспечивают несколько более быстрый и эффективный механизм взаимной синхронизации (инструкции по тестированию и определению конкретного процессора).</span><span class="sxs-lookup"><span data-stu-id="6359c-106">Event, mutex, and semaphore objects can also be used in a single-process application, but critical section objects provide a slightly faster, more efficient mechanism for mutual-exclusion synchronization (a processor-specific test and set instruction).</span></span> <span data-ttu-id="6359c-107">Как и объект Mutex, объект критической секции может принадлежать только одному потоку за раз, что позволяет защитить общий ресурс от одновременного доступа.</span><span class="sxs-lookup"><span data-stu-id="6359c-107">Like a mutex object, a critical section object can be owned by only one thread at a time, which makes it useful for protecting a shared resource from simultaneous access.</span></span> <span data-ttu-id="6359c-108">В отличие от объекта Mutex, невозможно определить, был ли прерван критический раздел.</span><span class="sxs-lookup"><span data-stu-id="6359c-108">Unlike a mutex object, there is no way to tell whether a critical section has been abandoned.</span></span>

<span data-ttu-id="6359c-109">Начиная с Windows Server 2003 с пакетом обновления 1 (SP1), потоки, ожидающие критической секции, не получают критический раздел на основе первых поступающих.</span><span class="sxs-lookup"><span data-stu-id="6359c-109">Starting with Windows Server 2003 with Service Pack 1 (SP1), threads waiting on a critical section do not acquire the critical section on a first-come, first-serve basis.</span></span> <span data-ttu-id="6359c-110">Это изменение значительно повышает производительность для большинства кодов.</span><span class="sxs-lookup"><span data-stu-id="6359c-110">This change increases performance significantly for most code.</span></span> <span data-ttu-id="6359c-111">Однако некоторые приложения зависят от порядка "первым поступил — первым обслужен" (FIFO) и могут работать плохо или не вообще на всех текущих версиях Windows (например, приложения, использующие критические разделы в качестве ограничения).</span><span class="sxs-lookup"><span data-stu-id="6359c-111">However, some applications depend on first-in, first-out (FIFO) ordering and may perform poorly or not at all on current versions of Windows (for example, applications that have been using critical sections as a rate-limiter).</span></span> <span data-ttu-id="6359c-112">Чтобы обеспечить правильную работу кода, может потребоваться добавить дополнительный уровень синхронизации.</span><span class="sxs-lookup"><span data-stu-id="6359c-112">To ensure that your code continues to work correctly, you may need to add an additional level of synchronization.</span></span> <span data-ttu-id="6359c-113">Например, предположим, что у вас есть поток-производитель и поток-потребитель, который использует объект критического раздела для синхронизации своей работы.</span><span class="sxs-lookup"><span data-stu-id="6359c-113">For example, suppose you have a producer thread and a consumer thread that are using a critical section object to synchronize their work.</span></span> <span data-ttu-id="6359c-114">Создайте два объекта событий — по одному для каждого потока, чтобы сообщить о готовности для продолжения работы другого потока.</span><span class="sxs-lookup"><span data-stu-id="6359c-114">Create two event objects, one for each thread to use to signal that it is ready for the other thread to proceed.</span></span> <span data-ttu-id="6359c-115">Поток-потребитель ждет, пока производитель сообщит о своем событии перед входом в критическую секцию, и поток-производитель ожидает, пока поток-потребитель не сообщит о своем событии перед входом в критическую секцию.</span><span class="sxs-lookup"><span data-stu-id="6359c-115">The consumer thread will wait for the producer to signal its event before entering the critical section, and the producer thread will wait for the consumer thread to signal its event before entering the critical section.</span></span> <span data-ttu-id="6359c-116">После того как каждый поток покидает критическую секцию, он сигнализирует своему событию освободить другой поток.</span><span class="sxs-lookup"><span data-stu-id="6359c-116">After each thread leaves the critical section, it signals its event to release the other thread.</span></span>

<span data-ttu-id="6359c-117">**Windows Server 2003 и Windows XP:** Потоки, ожидающие критического раздела, добавляются в очередь ожидания. они пробуждении и обычно запрашивают критическую секцию в том порядке, в котором они были добавлены в очередь.</span><span class="sxs-lookup"><span data-stu-id="6359c-117">**Windows Server 2003 and Windows XP:** Threads that are waiting on a critical section are added to a wait queue; they are woken and generally acquire the critical section in the order in which they were added to the queue.</span></span> <span data-ttu-id="6359c-118">Однако если потоки добавляются в эту очередь с достаточной скоростью, производительность может быть снижена из-за времени, затрачиваемого на пробуждение каждого ожидающего потока.</span><span class="sxs-lookup"><span data-stu-id="6359c-118">However, if threads are added to this queue at a fast enough rate, performance can be degraded because of the time it takes to awaken each waiting thread.</span></span>

<span data-ttu-id="6359c-119">Процесс отвечает за выделение памяти, используемой критическим разделом.</span><span class="sxs-lookup"><span data-stu-id="6359c-119">The process is responsible for allocating the memory used by a critical section.</span></span> <span data-ttu-id="6359c-120">Как правило, это делается путем простого объявления переменной с типом **критической \_ Секции**.</span><span class="sxs-lookup"><span data-stu-id="6359c-120">Typically, this is done by simply declaring a variable of type **CRITICAL\_SECTION**.</span></span> <span data-ttu-id="6359c-121">Прежде чем потоки процесса смогут использовать его, инициализируйте критическую секцию с помощью функции [**инитиализекритикалсектион**](/windows/win32/api/synchapi/nf-synchapi-initializecriticalsection) или [**инитиализекритикалсектионандспинкаунт**](/windows/win32/api/synchapi/nf-synchapi-initializecriticalsectionandspincount) .</span><span class="sxs-lookup"><span data-stu-id="6359c-121">Before the threads of the process can use it, initialize the critical section by using the [**InitializeCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-initializecriticalsection) or [**InitializeCriticalSectionAndSpinCount**](/windows/win32/api/synchapi/nf-synchapi-initializecriticalsectionandspincount) function.</span></span>

<span data-ttu-id="6359c-122">Поток использует функцию [**EnterCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-entercriticalsection) или [**трентеркритикалсектион**](/windows/win32/api/synchapi/nf-synchapi-tryentercriticalsection) для запроса владения критическим разделом.</span><span class="sxs-lookup"><span data-stu-id="6359c-122">A thread uses the [**EnterCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-entercriticalsection) or [**TryEnterCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-tryentercriticalsection) function to request ownership of a critical section.</span></span> <span data-ttu-id="6359c-123">Она использует функцию [**LeaveCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-leavecriticalsection) для освобождения владения критическим разделом.</span><span class="sxs-lookup"><span data-stu-id="6359c-123">It uses the [**LeaveCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-leavecriticalsection) function to release ownership of a critical section.</span></span> <span data-ttu-id="6359c-124">Если объект критического раздела в настоящее время принадлежит другому потоку, **EnterCriticalSection** ожидает неопределенного времени владения.</span><span class="sxs-lookup"><span data-stu-id="6359c-124">If the critical section object is currently owned by another thread, **EnterCriticalSection** waits indefinitely for ownership.</span></span> <span data-ttu-id="6359c-125">В отличие от этого, если объект Mutex используется для взаимного исключения, [функции Wait](wait-functions.md) принимают заданный интервал времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="6359c-125">In contrast, when a mutex object is used for mutual exclusion, the [wait functions](wait-functions.md) accept a specified time-out interval.</span></span> <span data-ttu-id="6359c-126">Функция **трентеркритикалсектион** пытается войти в критическую секцию, не блокируя вызывающий поток.</span><span class="sxs-lookup"><span data-stu-id="6359c-126">The **TryEnterCriticalSection** function attempts to enter a critical section without blocking the calling thread.</span></span>

<span data-ttu-id="6359c-127">Когда поток владеет критическим разделом, он может выполнять дополнительные вызовы [**EnterCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-entercriticalsection) или [**трентеркритикалсектион**](/windows/win32/api/synchapi/nf-synchapi-tryentercriticalsection) , не блокируя его выполнение.</span><span class="sxs-lookup"><span data-stu-id="6359c-127">When a thread owns a critical section, it can make additional calls to [**EnterCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-entercriticalsection) or [**TryEnterCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-tryentercriticalsection) without blocking its execution.</span></span> <span data-ttu-id="6359c-128">Это предотвращает взаимную взаимоблокировку потока при ожидании того, что он уже принадлежит критическому разделу.</span><span class="sxs-lookup"><span data-stu-id="6359c-128">This prevents a thread from deadlocking itself while waiting for a critical section that it already owns.</span></span> <span data-ttu-id="6359c-129">Чтобы освободить владение, поток должен вызвать [**LeaveCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-leavecriticalsection) один раз для каждого момента, когда он вошел в критическую секцию.</span><span class="sxs-lookup"><span data-stu-id="6359c-129">To release its ownership, the thread must call [**LeaveCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-leavecriticalsection) one time for each time that it entered the critical section.</span></span> <span data-ttu-id="6359c-130">Не гарантируется порядок, в котором ожидающие потоки будут получать владение критическим разделом.</span><span class="sxs-lookup"><span data-stu-id="6359c-130">There is no guarantee about the order in which waiting threads will acquire ownership of the critical section.</span></span>

<span data-ttu-id="6359c-131">Поток использует функцию [**инитиализекритикалсектионандспинкаунт**](/windows/win32/api/synchapi/nf-synchapi-initializecriticalsectionandspincount) или [**сеткритикалсектионспинкаунт**](/windows/win32/api/synchapi/nf-synchapi-setcriticalsectionspincount) для задания счетчика прокрутки для объекта критической секции.</span><span class="sxs-lookup"><span data-stu-id="6359c-131">A thread uses the [**InitializeCriticalSectionAndSpinCount**](/windows/win32/api/synchapi/nf-synchapi-initializecriticalsectionandspincount) or [**SetCriticalSectionSpinCount**](/windows/win32/api/synchapi/nf-synchapi-setcriticalsectionspincount) function to specify a spin count for the critical section object.</span></span> <span data-ttu-id="6359c-132">Цикличность означает, что когда поток пытается получить критический раздел, который заблокирован, поток входит в цикл, проверяет, снята ли блокировка, и если блокировка не была снята, поток переходит в спящий режим.</span><span class="sxs-lookup"><span data-stu-id="6359c-132">Spinning means that when a thread tries to acquire a critical section that is locked, the thread enters a loop, checks to see if the lock is released, and if the lock is not released, the thread goes to sleep.</span></span> <span data-ttu-id="6359c-133">В однопроцессорных системах счетчик пропусков игнорируется, а для счетчика критического раздела — значение 0 (ноль).</span><span class="sxs-lookup"><span data-stu-id="6359c-133">On single-processor systems, the spin count is ignored and the critical section spin count is set to 0 (zero).</span></span> <span data-ttu-id="6359c-134">В многопроцессорных системах, если критический раздел недоступен, вызывающий поток вращает *двспинкаунт* раз перед выполнением операции ожидания семафора, связанного с критическим разделом.</span><span class="sxs-lookup"><span data-stu-id="6359c-134">On multiprocessor systems, if the critical section is unavailable, the calling thread spins *dwSpinCount* times before performing a wait operation on a semaphore that is associated with the critical section.</span></span> <span data-ttu-id="6359c-135">Если критическая секция будет свободна во время операции Spin, вызывающий поток не будет выполнять операцию ожидания.</span><span class="sxs-lookup"><span data-stu-id="6359c-135">If the critical section becomes free during the spin operation, the calling thread avoids the wait operation.</span></span>

<span data-ttu-id="6359c-136">Любой поток процесса может использовать функцию [**делетекритикалсектион**](/windows/win32/api/synchapi/nf-synchapi-deletecriticalsection) для освобождения системных ресурсов, выделенных при инициализации объекта критической секции.</span><span class="sxs-lookup"><span data-stu-id="6359c-136">Any thread of the process can use the [**DeleteCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-deletecriticalsection) function to release the system resources that are allocated when the critical section object is initialized.</span></span> <span data-ttu-id="6359c-137">После вызова этой функции объект критической секции не может быть использован для синхронизации.</span><span class="sxs-lookup"><span data-stu-id="6359c-137">After this function is called, the critical section object cannot be used for synchronization.</span></span>

<span data-ttu-id="6359c-138">При владении объектом критической секции единственными затронутыми потоками являются потоки, ожидающие владение вызовом [**EnterCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-entercriticalsection).</span><span class="sxs-lookup"><span data-stu-id="6359c-138">When a critical section object is owned, the only other threads affected are the threads that are waiting for ownership in a call to [**EnterCriticalSection**](/windows/win32/api/synchapi/nf-synchapi-entercriticalsection).</span></span> <span data-ttu-id="6359c-139">Потоки, которые не ожидают ожидания, могут продолжать выполняться.</span><span class="sxs-lookup"><span data-stu-id="6359c-139">Threads that are not waiting are free to continue running.</span></span>

## <a name="related-topics"></a><span data-ttu-id="6359c-140">См. также</span><span class="sxs-lookup"><span data-stu-id="6359c-140">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="6359c-141">Мьютексные объекты</span><span class="sxs-lookup"><span data-stu-id="6359c-141">Mutex Objects</span></span>](mutex-objects.md)
</dt> <dt>

[<span data-ttu-id="6359c-142">Использование объектов критических секций</span><span class="sxs-lookup"><span data-stu-id="6359c-142">Using Critical Section Objects</span></span>](using-critical-section-objects.md)
</dt> </dl>

 

 
