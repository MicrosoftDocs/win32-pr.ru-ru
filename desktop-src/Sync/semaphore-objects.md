---
description: Объект семафора — это объект синхронизации, который поддерживает число от нуля до указанного максимального значения.
ms.assetid: d9da1d98-a306-4e2d-a149-1eef6a724751
title: Объекты семафора
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a77f36313d76c5d98c786a76f10ad8439965f180
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105664356"
---
# <a name="semaphore-objects"></a><span data-ttu-id="44d58-103">Объекты семафора</span><span class="sxs-lookup"><span data-stu-id="44d58-103">Semaphore Objects</span></span>

<span data-ttu-id="44d58-104">*Объект семафора* — это объект синхронизации, который поддерживает число от нуля до указанного максимального значения.</span><span class="sxs-lookup"><span data-stu-id="44d58-104">A *semaphore object* is a synchronization object that maintains a count between zero and a specified maximum value.</span></span> <span data-ttu-id="44d58-105">Счетчик уменьшается каждый раз, когда поток завершает ожидание объекта семафора и увеличивается каждый раз, когда поток освобождает семафор.</span><span class="sxs-lookup"><span data-stu-id="44d58-105">The count is decremented each time a thread completes a wait for the semaphore object and incremented each time a thread releases the semaphore.</span></span> <span data-ttu-id="44d58-106">Когда счетчик достигнет нуля, больше ни один поток не сможет успешно ожидать, пока состояние объекта семафора не станет сигнальным.</span><span class="sxs-lookup"><span data-stu-id="44d58-106">When the count reaches zero, no more threads can successfully wait for the semaphore object state to become signaled.</span></span> <span data-ttu-id="44d58-107">Состояние семафора становится сигнальным, когда это число становится больше нуля, и несигнальным, когда равно нулю.</span><span class="sxs-lookup"><span data-stu-id="44d58-107">The state of a semaphore is set to signaled when its count is greater than zero, and nonsignaled when its count is zero.</span></span>

<span data-ttu-id="44d58-108">Объект семафора полезен при управлении общим ресурсом, который может поддерживать ограниченное число пользователей.</span><span class="sxs-lookup"><span data-stu-id="44d58-108">The semaphore object is useful in controlling a shared resource that can support a limited number of users.</span></span> <span data-ttu-id="44d58-109">Он выступает в качестве шлюза, ограничивающего количество потоков, совместно использующих ресурс, до указанного максимального числа.</span><span class="sxs-lookup"><span data-stu-id="44d58-109">It acts as a gate that limits the number of threads sharing the resource to a specified maximum number.</span></span> <span data-ttu-id="44d58-110">Например, приложение может устанавливать ограничение на количество создаваемых окон.</span><span class="sxs-lookup"><span data-stu-id="44d58-110">For example, an application might place a limit on the number of windows that it creates.</span></span> <span data-ttu-id="44d58-111">Он использует семафор с максимальным числом, равным ограничению окна, уменьшая число при создании окна и увеличивая его при каждом закрытии окна.</span><span class="sxs-lookup"><span data-stu-id="44d58-111">It uses a semaphore with a maximum count equal to the window limit, decrementing the count whenever a window is created and incrementing it whenever a window is closed.</span></span> <span data-ttu-id="44d58-112">Приложение задает объект семафора в вызове одной из [функций ожидания](wait-functions.md) перед созданием каждого окна.</span><span class="sxs-lookup"><span data-stu-id="44d58-112">The application specifies the semaphore object in call to one of the [wait functions](wait-functions.md) before each window is created.</span></span> <span data-ttu-id="44d58-113">Если значение счетчика равно нулю — это означает, что достигнуто предельное число окон, функция wait блокирует выполнение кода создания окна.</span><span class="sxs-lookup"><span data-stu-id="44d58-113">When the count is zero—indicating that the window limit has been reached—the wait function blocks execution of the window-creation code.</span></span>

<span data-ttu-id="44d58-114">Поток использует функцию [**createsemaphore-**](/windows/desktop/api/WinBase/nf-winbase-createsemaphorea) или [**креатесемафорикс**](/windows/desktop/api/WinBase/nf-winbase-createsemaphoreexa) для создания объекта семафора.</span><span class="sxs-lookup"><span data-stu-id="44d58-114">A thread uses the [**CreateSemaphore**](/windows/desktop/api/WinBase/nf-winbase-createsemaphorea) or [**CreateSemaphoreEx**](/windows/desktop/api/WinBase/nf-winbase-createsemaphoreexa) function to create a semaphore object.</span></span> <span data-ttu-id="44d58-115">В процессе создания потока указывается начальное число и максимальное значение счетчика для объекта.</span><span class="sxs-lookup"><span data-stu-id="44d58-115">The creating thread specifies the initial count and the maximum value of the count for the object.</span></span> <span data-ttu-id="44d58-116">Начальное число не должно быть меньше нуля или больше максимального значения.</span><span class="sxs-lookup"><span data-stu-id="44d58-116">The initial count must be neither less than zero nor greater than the maximum value.</span></span> <span data-ttu-id="44d58-117">В создаваемом потоке также можно указать имя для объекта семафора.</span><span class="sxs-lookup"><span data-stu-id="44d58-117">The creating thread can also specify a name for the semaphore object.</span></span> <span data-ttu-id="44d58-118">Потоки в других процессах могут открыть обработчик для существующего объекта семафора, указав его имя в вызове функции [**опенсемафоре**](/windows/win32/api/synchapi/nf-synchapi-opensemaphorew) .</span><span class="sxs-lookup"><span data-stu-id="44d58-118">Threads in other processes can open a handle to an existing semaphore object by specifying its name in a call to the [**OpenSemaphore**](/windows/win32/api/synchapi/nf-synchapi-opensemaphorew) function.</span></span> <span data-ttu-id="44d58-119">Дополнительные сведения об именах для мьютексов, событий, семафоров и объектов таймера см. в разделе [межпроцессная синхронизация](interprocess-synchronization.md).</span><span class="sxs-lookup"><span data-stu-id="44d58-119">For additional information about names for mutex, event, semaphore, and timer objects, see [Interprocess Synchronization](interprocess-synchronization.md).</span></span>

<span data-ttu-id="44d58-120">Если в семафоре ожидается несколько потоков, выбирается ожидающий поток.</span><span class="sxs-lookup"><span data-stu-id="44d58-120">If more than one thread is waiting on a semaphore, a waiting thread is selected.</span></span> <span data-ttu-id="44d58-121">Не думайте порядок "первым поступил — первым обслужен" (FIFO).</span><span class="sxs-lookup"><span data-stu-id="44d58-121">Do not assume a first-in, first-out (FIFO) order.</span></span> <span data-ttu-id="44d58-122">Внешние события, такие как режим ядра APC, могут изменять порядок ожидания.</span><span class="sxs-lookup"><span data-stu-id="44d58-122">External events such as kernel-mode APCs can change the wait order.</span></span>

<span data-ttu-id="44d58-123">Каждый раз, когда одна из [функций Wait](wait-functions.md) возвращает сигнал, так как состояние семафора было равно сигнальному, счетчик семафора уменьшается на единицу.</span><span class="sxs-lookup"><span data-stu-id="44d58-123">Each time one of the [wait functions](wait-functions.md) returns because the state of a semaphore was set to signaled, the count of the semaphore is decreased by one.</span></span> <span data-ttu-id="44d58-124">Функция [**ReleaseSemaphore**](/windows/win32/api/synchapi/nf-synchapi-releasesemaphore) увеличивает значение счетчика семафора на указанный объем.</span><span class="sxs-lookup"><span data-stu-id="44d58-124">The [**ReleaseSemaphore**](/windows/win32/api/synchapi/nf-synchapi-releasesemaphore) function increases a semaphore's count by a specified amount.</span></span> <span data-ttu-id="44d58-125">Число не может быть меньше нуля или больше максимального значения.</span><span class="sxs-lookup"><span data-stu-id="44d58-125">The count can never be less than zero or greater than the maximum value.</span></span>

<span data-ttu-id="44d58-126">Первоначальное число семафора обычно равно максимальному значению.</span><span class="sxs-lookup"><span data-stu-id="44d58-126">The initial count of a semaphore is typically set to the maximum value.</span></span> <span data-ttu-id="44d58-127">Затем счетчик уменьшается с этого уровня, когда потребляется защищенный ресурс.</span><span class="sxs-lookup"><span data-stu-id="44d58-127">The count is then decremented from that level as the protected resource is consumed.</span></span> <span data-ttu-id="44d58-128">Кроме того, можно создать семафор с начальным счетчиком, равным нулю, чтобы заблокировать доступ к защищенному ресурсу во время инициализации приложения.</span><span class="sxs-lookup"><span data-stu-id="44d58-128">Alternatively, you can create a semaphore with an initial count of zero to block access to the protected resource while the application is being initialized.</span></span> <span data-ttu-id="44d58-129">После инициализации можно использовать [**ReleaseSemaphore**](/windows/win32/api/synchapi/nf-synchapi-releasesemaphore) , чтобы увеличить число до максимального значения.</span><span class="sxs-lookup"><span data-stu-id="44d58-129">After initialization, you can use [**ReleaseSemaphore**](/windows/win32/api/synchapi/nf-synchapi-releasesemaphore) to increment the count to the maximum value.</span></span>

<span data-ttu-id="44d58-130">Поток, владеющий объектом Mutex, может многократно ожидать для того же объекта мьютекса, чтобы он стал сигнальным, не блокируя его выполнение.</span><span class="sxs-lookup"><span data-stu-id="44d58-130">A thread that owns a mutex object can wait repeatedly for the same mutex object to become signaled without its execution becoming blocked.</span></span> <span data-ttu-id="44d58-131">Однако поток, который ожидает повторное выполнение для одного и того же объекта семафора, уменьшает количество семафора каждый раз, когда завершается операция ожидания. поток блокируется, когда число становится равным нулю.</span><span class="sxs-lookup"><span data-stu-id="44d58-131">A thread that waits repeatedly for the same semaphore object, however, decrements the semaphore's count each time a wait operation is completed; the thread is blocked when the count gets to zero.</span></span> <span data-ttu-id="44d58-132">Аналогично, только поток, владеющий мьютексом, может успешно вызвать функцию [**ReleaseMutex**](/windows/win32/api/synchapi/nf-synchapi-releasemutex) , хотя любой поток может использовать [**ReleaseSemaphore**](/windows/win32/api/synchapi/nf-synchapi-releasesemaphore) для увеличения числа объектов семафора.</span><span class="sxs-lookup"><span data-stu-id="44d58-132">Similarly, only the thread that owns a mutex can successfully call the [**ReleaseMutex**](/windows/win32/api/synchapi/nf-synchapi-releasemutex) function, though any thread can use [**ReleaseSemaphore**](/windows/win32/api/synchapi/nf-synchapi-releasesemaphore) to increase the count of a semaphore object.</span></span>

<span data-ttu-id="44d58-133">Поток может уменьшить число семафоров несколько раз, повторно указав один и тот же объект семафора в вызовах любой из [функций ожидания](wait-functions.md).</span><span class="sxs-lookup"><span data-stu-id="44d58-133">A thread can decrement a semaphore's count more than once by repeatedly specifying the same semaphore object in calls to any of the [wait functions](wait-functions.md).</span></span> <span data-ttu-id="44d58-134">Однако вызов одной из функций ожидания с несколькими объектами с массивом, содержащим несколько дескрипторов одного и того же семафора, не приводит к множественному уменьшению.</span><span class="sxs-lookup"><span data-stu-id="44d58-134">However, calling one of the multiple-object wait functions with an array that contains multiple handles of the same semaphore does not result in multiple decrements.</span></span>

<span data-ttu-id="44d58-135">Завершив использование объекта семафора, вызовите функцию [**CloseHandle**](/windows/win32/api/handleapi/nf-handleapi-closehandle) , чтобы закрыть этот обработчик.</span><span class="sxs-lookup"><span data-stu-id="44d58-135">When you have finished using the semaphore object, call the [**CloseHandle**](/windows/win32/api/handleapi/nf-handleapi-closehandle) function to close the handle.</span></span> <span data-ttu-id="44d58-136">Объект семафора уничтожается при закрытии его последнего маркера.</span><span class="sxs-lookup"><span data-stu-id="44d58-136">The semaphore object is destroyed when its last handle has been closed.</span></span> <span data-ttu-id="44d58-137">Закрытие маркера не влияет на число семафоров; Поэтому обязательно вызовите [**ReleaseSemaphore**](/windows/win32/api/synchapi/nf-synchapi-releasesemaphore) перед закрытием обработчика или до завершения процесса.</span><span class="sxs-lookup"><span data-stu-id="44d58-137">Closing the handle does not affect the semaphore count; therefore, be sure to call [**ReleaseSemaphore**](/windows/win32/api/synchapi/nf-synchapi-releasesemaphore) before closing the handle or before the process terminates.</span></span> <span data-ttu-id="44d58-138">В противном случае ожидающие операции ожидания истечет либо время ожидания, либо продолжить неограниченно в зависимости от того, было ли указано значение времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="44d58-138">Otherwise, pending wait operations will either time out or continue indefinitely, depending on whether a time-out value has been specified.</span></span>

## <a name="related-topics"></a><span data-ttu-id="44d58-139">См. также</span><span class="sxs-lookup"><span data-stu-id="44d58-139">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="44d58-140">Использование объектов семафора</span><span class="sxs-lookup"><span data-stu-id="44d58-140">Using Semaphore Objects</span></span>](using-semaphore-objects.md)
</dt> </dl>

 

 
