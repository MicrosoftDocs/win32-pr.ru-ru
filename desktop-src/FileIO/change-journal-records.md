---
description: По мере добавления, удаления и изменения файлов, каталогов и других объектов файловой системы NTFS файловая система NTFS вводит в потоки записи журнала изменений, по одному для каждого тома на компьютере.
ms.assetid: c41aa3a8-c8d8-4bf2-9bbb-d6a6a556c5e4
title: Записи журнала изменений
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 56580a28c01ca164af4598cb290a37c8e36828f5
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105684380"
---
# <a name="change-journal-records"></a><span data-ttu-id="d5c1a-103">Записи журнала изменений</span><span class="sxs-lookup"><span data-stu-id="d5c1a-103">Change Journal Records</span></span>

<span data-ttu-id="d5c1a-104">По мере добавления, удаления и изменения файлов, каталогов и других объектов файловой системы NTFS файловая система NTFS вводит в потоки записи журнала изменений, по одному для каждого тома на компьютере.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-104">As files, directories, and other NTFS file system objects are added, deleted, and modified, the NTFS file system enters change journal records in streams, one for each volume on the computer.</span></span> <span data-ttu-id="d5c1a-105">В каждой записи указывается тип изменения и измененный объект.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-105">Each record indicates the type of change and the object changed.</span></span> <span data-ttu-id="d5c1a-106">Смещение от начала потока для конкретной записи называется порядковым номером обновления (USN) для конкретной записи.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-106">The offset from the beginning of the stream for a particular record is called the update sequence number (USN) for the particular record.</span></span> <span data-ttu-id="d5c1a-107">Новые записи добавляются в конец потока.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-107">New records are appended to the end of the stream.</span></span>

<span data-ttu-id="d5c1a-108">Файловая система NTFS может удалять старые записи для экономии пространства.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-108">The NTFS file system may delete old records to conserve space.</span></span> <span data-ttu-id="d5c1a-109">Если необходимые записи были удалены, служба индексирования восстанавливается путем повторного индексирования тома, как это происходит, если журнал изменений не существует.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-109">If needed records have been deleted, the indexing service recovers by re-indexing the volume, as it does when no change journal exists.</span></span>

<span data-ttu-id="d5c1a-110">Журнал изменений регистрирует только факт изменения файла и причины изменения (например, операции записи, усечение, увеличение, удаление и т. д.).</span><span class="sxs-lookup"><span data-stu-id="d5c1a-110">The change journal logs only the fact of a change to a file and the reason for the change (for example, write operations, truncation, lengthening, deletion, and so on).</span></span> <span data-ttu-id="d5c1a-111">Он не записывает достаточно информации, чтобы разрешить изменение.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-111">It does not record enough information to allow reversing the change.</span></span>

<span data-ttu-id="d5c1a-112">Кроме того, несколько изменений в одном файле могут привести к добавлению только одного флага причин к текущей записи.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-112">In addition, multiple changes to the same file may result in only one reason flag being added to the current record.</span></span> <span data-ttu-id="d5c1a-113">Если один и тот же тип изменения происходит несколько раз, файловая система NTFS не записывает новую запись для изменений после первой.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-113">If the same kind of change occurs more than once, the NTFS file system does not write a new record for the changes after the first.</span></span> <span data-ttu-id="d5c1a-114">Например, несколько операций записи без промежуточных операций закрытия и повторного открытия приводят к появлению только одной записи изменений с флагом причины USN \_ \_ \_ набор перезаписи данных причины.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-114">For example, several write operations with no intervening close and reopen operations result in only one change record with the reason flag USN\_REASON\_DATA\_OVERWRITE set.</span></span>

<span data-ttu-id="d5c1a-115">Чтобы продемонстрировать, как работает журнал изменений, предположим, что пользователь обращается к файлу в следующем порядке:</span><span class="sxs-lookup"><span data-stu-id="d5c1a-115">To illustrate how the change journal works, suppose a user accesses a file in the following order:</span></span>

1.  <span data-ttu-id="d5c1a-116">Выполняет запись в файл.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-116">Writes to the file.</span></span>
2.  <span data-ttu-id="d5c1a-117">Задает отметку времени для файла.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-117">Sets the time stamp for the file.</span></span>
3.  <span data-ttu-id="d5c1a-118">Выполняет запись в файл.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-118">Writes to the file.</span></span>
4.  <span data-ttu-id="d5c1a-119">Усекает файл.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-119">Truncates the file.</span></span>
5.  <span data-ttu-id="d5c1a-120">Выполняет запись в файл.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-120">Writes to the file.</span></span>
6.  <span data-ttu-id="d5c1a-121">Закрывает файл.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-121">Closes the file.</span></span>

<span data-ttu-id="d5c1a-122">В этом случае файловая система NTFS выполняет следующие действия в журнале изменений (где \| указывает побитовую операцию или).</span><span class="sxs-lookup"><span data-stu-id="d5c1a-122">In this case, the NTFS file system takes the following actions in the change journal (where \| indicates a bitwise OR operation).</span></span>



| <span data-ttu-id="d5c1a-123">Событие</span><span class="sxs-lookup"><span data-stu-id="d5c1a-123">Event</span></span>                                 | <span data-ttu-id="d5c1a-124">Действие файловой системы NTFS</span><span class="sxs-lookup"><span data-stu-id="d5c1a-124">NTFS file system action</span></span>                                                                                                                                                                                                                                                    |
|---------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="d5c1a-125">Начальная операция записи</span><span class="sxs-lookup"><span data-stu-id="d5c1a-125">Initial write operation</span></span><br/>    | <span data-ttu-id="d5c1a-126">Файловая система NTFS записывает новую запись USN с \_ \_ \_ установленным флагом причины перезаписи данных причины USN.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-126">The NTFS file system writes a new USN record with the USN\_REASON\_DATA\_OVERWRITE reason flag set.</span></span> <span data-ttu-id="d5c1a-127">Дополнительные сведения о возможных флагах причин см. в разделе Структура [**\_ записи USN**](/windows/desktop/api/WinIoCtl/ns-winioctl-usn_record_v2) .</span><span class="sxs-lookup"><span data-stu-id="d5c1a-127">For more information on possible reason flags, see the [**USN\_RECORD**](/windows/desktop/api/WinIoCtl/ns-winioctl-usn_record_v2) structure.</span></span><br/>                                                     |
| <span data-ttu-id="d5c1a-128">Параметр метки времени файла</span><span class="sxs-lookup"><span data-stu-id="d5c1a-128">Setting of file time stamp</span></span><br/> | <span data-ttu-id="d5c1a-129">Файловая система NTFS записывает новую запись USN с флажком " \_ \_ \_ перезаписать данные причины USN \| \_ \_ Основные сведения" \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="d5c1a-129">The NTFS file system writes a new USN record with the flag setting USN\_REASON\_DATA\_OVERWRITE \| USN\_REASON\_BASIC\_INFO\_CHANGE.</span></span><br/>                                                                                                                            |
| <span data-ttu-id="d5c1a-130">Вторая операция записи</span><span class="sxs-lookup"><span data-stu-id="d5c1a-130">Second write operation</span></span><br/>     | <span data-ttu-id="d5c1a-131">Файловая система NTFS не записывает новую запись USN.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-131">The NTFS file system does not write a new USN record.</span></span> <span data-ttu-id="d5c1a-132">Так как \_ для \_ \_ существующей записи уже задана причина USN, то изменения записи не вносятся.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-132">Because USN\_REASON\_DATA\_OVERWRITE is already set for the existing record, no changes are made to the record.</span></span><br/>                                                                                           |
| <span data-ttu-id="d5c1a-133">Усечение файлов</span><span class="sxs-lookup"><span data-stu-id="d5c1a-133">File truncation</span></span><br/>            | <span data-ttu-id="d5c1a-134">Файловая система NTFS записывает новую запись USN с указанием параметра USN \_ Причина \_ перезаписи данных причины USN \_ \| \_ \_ основные \_ сведения \_ изменение \| \_ данных причина \_ \_ усечения.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-134">The NTFS file system writes a new USN record with the flag setting USN\_REASON\_DATA\_OVERWRITE \| USN\_REASON\_BASIC\_INFO\_CHANGE \| USN\_REASON\_DATA\_TRUNCATION.</span></span><br/>                                                                                           |
| <span data-ttu-id="d5c1a-135">Третья операция записи</span><span class="sxs-lookup"><span data-stu-id="d5c1a-135">Third write operation</span></span><br/>      | <span data-ttu-id="d5c1a-136">Файловая система NTFS не записывает новую запись USN.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-136">The NTFS file system does not write a new USN record.</span></span> <span data-ttu-id="d5c1a-137">Так как \_ для \_ \_ существующей записи уже задана причина USN, то изменения записи не вносятся.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-137">Because USN\_REASON\_DATA\_OVERWRITE is already set for the existing record, no changes are made to the record.</span></span><br/>                                                                                           |
| <span data-ttu-id="d5c1a-138">Операция закрытия</span><span class="sxs-lookup"><span data-stu-id="d5c1a-138">Close operation</span></span><br/>            | <span data-ttu-id="d5c1a-139">Если пользователь, выполняющий изменения, является единственным пользователем файла, то файловая система NTFS записывает новую запись USN со следующим значением флага: USN \_ Причина \_ \_ Перезаписать \| USN \_ Причина \_ основные \_ сведения \_ изменение USN причина \| \_ \_ усечения данных USN \_ \| \_ Причина \_ закрытия.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-139">If the user making changes is the only user of the file, the NTFS file system writes a new USN record with the following flag setting: USN\_REASON\_DATA\_OVERWRITE \| USN\_REASON\_BASIC\_INFO\_CHANGE \| USN\_REASON\_DATA\_TRUNCATION \| USN\_REASON\_CLOSE.</span></span><br/> |



 

<span data-ttu-id="d5c1a-140">Журнал изменений накапливает ряд записей между первым открытием и последним закрытием файла.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-140">The change journal accumulates a series of records between the first opening and last closing of a file.</span></span> <span data-ttu-id="d5c1a-141">Для каждой записи задан новый флаг причины, указывающий на то, что произошло изменение нового типа.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-141">Each record has a new reason flag set, indicating that a new kind of change has occurred.</span></span> <span data-ttu-id="d5c1a-142">Последовательность записей содержит частичную историю файла.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-142">The sequence of records gives a partial history of the file.</span></span> <span data-ttu-id="d5c1a-143">Последняя запись, созданная при закрытии файла, добавляет \_ флаг закрытия причины USN \_ .</span><span class="sxs-lookup"><span data-stu-id="d5c1a-143">The final record, created when the file is closed, adds the USN\_REASON\_CLOSE flag.</span></span> <span data-ttu-id="d5c1a-144">Эта запись представляет сводку изменений в файле, но, в отличие от предыдущих записей, не дает указания на порядок изменений.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-144">This record represents a summary of changes to the file, but unlike the prior records, gives no indication of the order of the changes.</span></span>

<span data-ttu-id="d5c1a-145">Следующий пользователь для доступа к файлу и его изменения создает новую запись USN с одним флагом причины.</span><span class="sxs-lookup"><span data-stu-id="d5c1a-145">The next user to access and change the file generates a new USN record with a single reason flag.</span></span>

 

 




