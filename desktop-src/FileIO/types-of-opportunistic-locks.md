---
description: Описывает уровень 1, уровень 2, пакетную обработку и фильтрацию уступающей блокировки.
ms.assetid: 06136348-0c08-4e9c-9c96-fd3af33cbdc0
title: Типы уступающей блокировки
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a755a6ff766f5d19e13d4b269c1ba4bb9803e934
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103912308"
---
# <a name="types-of-opportunistic-locks"></a><span data-ttu-id="4e603-103">Типы уступающей блокировки</span><span class="sxs-lookup"><span data-stu-id="4e603-103">Types of Opportunistic Locks</span></span>

<span data-ttu-id="4e603-104">Операции оппортунистической блокировки работают с четырьмя типами уступающей блокировки: уровень 1, уровень 2, пакетная обработка и фильтр.</span><span class="sxs-lookup"><span data-stu-id="4e603-104">The opportunistic lock operations work with four types of opportunistic locks: level 1, level 2, batch, and filter.</span></span> <span data-ttu-id="4e603-105">*Эксклюзивные уступающей блокировки* — это блокировки уровня 1, пакетной службы и фильтра.</span><span class="sxs-lookup"><span data-stu-id="4e603-105">*Exclusive opportunistic locks* are level 1, batch, and filter locks.</span></span> <span data-ttu-id="4e603-106">Если поток имеет монопольную блокировку на файл, он также не может иметь блокировку уровня 2 для одного и того же файла.</span><span class="sxs-lookup"><span data-stu-id="4e603-106">If a thread has any type of exclusive lock on a file, it cannot also have a level 2 lock on the same file.</span></span>

## <a name="level-1-opportunistic-locks"></a><span data-ttu-id="4e603-107">Оппортунистической блокировки уровня 1</span><span class="sxs-lookup"><span data-stu-id="4e603-107">Level 1 Opportunistic Locks</span></span>

<span data-ttu-id="4e603-108">Оппортунистическая блокировка уровня 1 для файла позволяет клиенту заранее прочитать файл и кэшировать данные из файла в локальной среде.</span><span class="sxs-lookup"><span data-stu-id="4e603-108">A level 1 opportunistic lock on a file allows a client to read ahead in the file and cache both read-ahead and write data from the file locally.</span></span> <span data-ttu-id="4e603-109">При условии, что у клиента есть единственный доступ к файлу, нет опасности для согласования данных в предоставлении оппортунистической блокировки уровня 1.</span><span class="sxs-lookup"><span data-stu-id="4e603-109">As long as the client has sole access to a file, there is no danger to data coherency in providing a level 1 opportunistic lock.</span></span>

<span data-ttu-id="4e603-110">После открытия файла клиент может запрашивать уступающую блокировку уровня 1.</span><span class="sxs-lookup"><span data-stu-id="4e603-110">The client can request a level 1 opportunistic lock after opening a file.</span></span> <span data-ttu-id="4e603-111">Если ни один другой клиент (или другой поток в том же клиенте) не открыл файл, сервер может предоставить уступающую блокировку.</span><span class="sxs-lookup"><span data-stu-id="4e603-111">If no other client (or no other thread on the same client) has the file open, the server may grant the opportunistic lock.</span></span> <span data-ttu-id="4e603-112">Затем клиент может кэшировать чтение и запись данных из файла локально.</span><span class="sxs-lookup"><span data-stu-id="4e603-112">The client can then cache read and write data from the file locally.</span></span> <span data-ttu-id="4e603-113">Если файл открыт другим клиентом, сервер отказывается от уступающей блокировки, а клиент не выполняет локальное кэширование.</span><span class="sxs-lookup"><span data-stu-id="4e603-113">If another client has opened the file, then the server refuses the opportunistic lock and the client does no local caching.</span></span> <span data-ttu-id="4e603-114">(Сервер может отказаться от оппортунистической блокировки по другим причинам, например без поддержки уступающей блокировки).</span><span class="sxs-lookup"><span data-stu-id="4e603-114">(The server may refuse the opportunistic lock for other reasons as well, such as not supporting opportunistic locks.)</span></span>

<span data-ttu-id="4e603-115">Когда сервер открывает файл, у которого уже есть оппортунистическая блокировка уровня 1, сервер проверяет состояние общего доступа к файлу до того, как он прервет блокировку уровня 1.</span><span class="sxs-lookup"><span data-stu-id="4e603-115">When the server opens a file that already has a level 1 opportunistic lock on it, the server examines the sharing state of the file before it breaks the level 1 opportunistic lock.</span></span> <span data-ttu-id="4e603-116">Если сервер нарушает блокировку после проверки, то время, которое клиент с бывшей блокировкой тратит на очистку кэша записи, — время ожидания клиента, запрашивающего файл.</span><span class="sxs-lookup"><span data-stu-id="4e603-116">If the server breaks the lock after this examination, the time the client with the former lock spends flushing its write cache is time the client requesting the file must wait.</span></span> <span data-ttu-id="4e603-117">Этот расход означает, что при открытии файлов, открытых многими клиентами, следует избегать уступающей блокировки уровня 1.</span><span class="sxs-lookup"><span data-stu-id="4e603-117">This time expenditure means that level 1 opportunistic locks should be avoided on files that many clients open.</span></span>

<span data-ttu-id="4e603-118">Тем не менее, поскольку сервер проверяет состояние общего доступа до того, как оно нарушает блокировку, в случае, когда сервер отклоняет открытый запрос из-за конфликта общего доступа, сервер не нарушает блокировку.</span><span class="sxs-lookup"><span data-stu-id="4e603-118">However, because the server checks the sharing state before it breaks the lock, in the case where the server would deny an open request due to a sharing conflict the server does not break the lock.</span></span> <span data-ttu-id="4e603-119">Например, если вы открыли файл, отклонили общий доступ для операций записи и получили блокировку уровня 1, сервер отклоняет запрос другого клиента на открытие файла для записи, прежде чем он даже проверит блокировку файла.</span><span class="sxs-lookup"><span data-stu-id="4e603-119">For example, if you have opened a file, denied sharing for write operations, and obtained a level 1 lock, the server denies another client's request to open the file for writing before it even examines your lock on the file.</span></span> <span data-ttu-id="4e603-120">В этом случае оппортунистическая блокировка не разбивается.</span><span class="sxs-lookup"><span data-stu-id="4e603-120">In this instance, your opportunistic lock is not broken.</span></span>

<span data-ttu-id="4e603-121">Пример того, как работает оппортунистическая блокировка уровня 1, см. в разделе пример оппортунистической блокировки уровня 1.</span><span class="sxs-lookup"><span data-stu-id="4e603-121">For an example of how a level 1 opportunistic lock works, see Level 1 Opportunistic Lock Example.</span></span> <span data-ttu-id="4e603-122">Дополнительные сведения о нарушении уступающей блокировки см. в разделе [разбиение уступающей блокировки](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="4e603-122">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="level-2-opportunistic-locks"></a><span data-ttu-id="4e603-123">Оппортунистической блокировки уровня 2</span><span class="sxs-lookup"><span data-stu-id="4e603-123">Level 2 Opportunistic Locks</span></span>

<span data-ttu-id="4e603-124">Оппортунистическая блокировка уровня 2 информирует клиента о том, что существует несколько параллельных клиентов файла и что он еще не изменил его.</span><span class="sxs-lookup"><span data-stu-id="4e603-124">A level 2 opportunistic lock informs a client that there are multiple concurrent clients of a file and that none has yet modified it.</span></span> <span data-ttu-id="4e603-125">Эта блокировка позволяет клиенту выполнять операции чтения и получать атрибуты файлов с помощью кэшированной или упреждающего чтения локальной информации, но клиент должен отправить на сервер все остальные запросы (например, операции записи).</span><span class="sxs-lookup"><span data-stu-id="4e603-125">This lock allows the client to perform read operations and obtain file attributes using cached or read-ahead local information, but the client must send all other requests (such as for write operations) to the server.</span></span> <span data-ttu-id="4e603-126">Приложение должно использовать уступающую блокировку уровня 2, если предполагается, что другие приложения могут записывать файлы в случайном режиме или в случайном порядке или последовательного чтения файла.</span><span class="sxs-lookup"><span data-stu-id="4e603-126">Your application should use the level 2 opportunistic lock when you expect other applications to write to the file at random or read the file at random or sequentially.</span></span>

<span data-ttu-id="4e603-127">Оппортунистическая блокировка уровня 2 очень похожа на фильтр оппортунистической блокировки.</span><span class="sxs-lookup"><span data-stu-id="4e603-127">A level 2 opportunistic lock is very similar to a filter opportunistic lock.</span></span> <span data-ttu-id="4e603-128">В большинстве случаев приложение должно использовать уступающую блокировку уровня 2.</span><span class="sxs-lookup"><span data-stu-id="4e603-128">In most situations, your application should use the level 2 opportunistic lock.</span></span> <span data-ttu-id="4e603-129">Используйте блокировку фильтра только в том случае, если не нужно, чтобы операции чтения приводили к нарушениям в режиме общего доступа в промежутке времени между открытием файла приложением и получением блокировки.</span><span class="sxs-lookup"><span data-stu-id="4e603-129">Only use the filter lock if you do not want open operations for reading to cause sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="4e603-130">Дополнительные сведения см. в разделе Фильтрация уступающей блокировки и [ответ сервера на открытые запросы к заблокированным файлам](server-response-to-open-requests-on-locked-files.md).</span><span class="sxs-lookup"><span data-stu-id="4e603-130">For more information, see Filter Opportunistic Locks and [Server Response to Open Requests on Locked Files](server-response-to-open-requests-on-locked-files.md).</span></span>

<span data-ttu-id="4e603-131">Дополнительные сведения о нарушении уступающей блокировки см. в разделе [разбиение уступающей блокировки](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="4e603-131">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="batch-opportunistic-locks"></a><span data-ttu-id="4e603-132">Оппортунистической блокировки пакетной службы</span><span class="sxs-lookup"><span data-stu-id="4e603-132">Batch Opportunistic Locks</span></span>

<span data-ttu-id="4e603-133">Оппортунистическая блокировка пакетной службы управляет вакансиями и закрытием файлов.</span><span class="sxs-lookup"><span data-stu-id="4e603-133">A batch opportunistic lock manipulates file openings and closings.</span></span> <span data-ttu-id="4e603-134">Например, при выполнении пакетного файла пакетный файл может быть открыт и закрыт один раз для каждой строки файла.</span><span class="sxs-lookup"><span data-stu-id="4e603-134">For example, in the execution of a batch file, the batch file may be opened and closed once for each line of the file.</span></span> <span data-ttu-id="4e603-135">Пакетная оппортунистическая блокировка открывает пакетный файл на сервере и сохраняет его открытым.</span><span class="sxs-lookup"><span data-stu-id="4e603-135">A batch opportunistic lock opens the batch file on the server and keeps it open.</span></span> <span data-ttu-id="4e603-136">По мере того, как обработчик команд открывает и закрывает пакетный файл, перенаправитель сети перехватывает команды Open и Close.</span><span class="sxs-lookup"><span data-stu-id="4e603-136">As the command processor "opens" and "closes" the batch file, the network redirector intercepts the open and close commands.</span></span> <span data-ttu-id="4e603-137">Все, что получает сервер, — это команды поиска и чтения.</span><span class="sxs-lookup"><span data-stu-id="4e603-137">All the server receives are the seek and read commands.</span></span> <span data-ttu-id="4e603-138">Если клиент также выполняет чтение заранее, сервер получает определенный запрос на чтение не более одного раза.</span><span class="sxs-lookup"><span data-stu-id="4e603-138">If the client is also reading ahead, the server receives a particular read request at most one time.</span></span>

<span data-ttu-id="4e603-139">При открытии файла, который уже содержит пакетную блокировку, сервер проверяет состояние общего доступа к файлу после нарушения блокировки.</span><span class="sxs-lookup"><span data-stu-id="4e603-139">When opening a file that already has a batch opportunistic lock, the server checks the sharing state of the file after breaking the lock.</span></span> <span data-ttu-id="4e603-140">Эта проверка дает владельцу блокировки шанс завершить очистку своего кэша и закрыть этот файл.</span><span class="sxs-lookup"><span data-stu-id="4e603-140">This check gives the holder of the lock a chance to complete flushing its cache and to close the file handle.</span></span> <span data-ttu-id="4e603-141">Попытка операции открытия, выполняемой во время проверки общего доступа, не приводит к сбою проверки общего доступа, если блокировка снимает блокировку.</span><span class="sxs-lookup"><span data-stu-id="4e603-141">An open operation attempted during the sharing check does not cause the sharing check to fail if the lock holder releases the lock.</span></span>

<span data-ttu-id="4e603-142">Пример работы оппортунистической блокировки пакетной службы см. в разделе пример оппортунистической блокировки пакетной службы.</span><span class="sxs-lookup"><span data-stu-id="4e603-142">For an example of how a batch opportunistic lock works, see Batch Opportunistic Lock Example.</span></span> <span data-ttu-id="4e603-143">Дополнительные сведения о нарушении уступающей блокировки см. в разделе [разбиение уступающей блокировки](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="4e603-143">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="filter-opportunistic-locks"></a><span data-ttu-id="4e603-144">Фильтрация уступающей блокировки</span><span class="sxs-lookup"><span data-stu-id="4e603-144">Filter Opportunistic Locks</span></span>

<span data-ttu-id="4e603-145">Фильтр оппортунистической блокировки блокирует файл, чтобы его нельзя было открыть для записи или удаления.</span><span class="sxs-lookup"><span data-stu-id="4e603-145">A filter opportunistic lock locks a file so that it cannot be opened for either write or delete access.</span></span> <span data-ttu-id="4e603-146">Все клиенты должны иметь возможность совместно использовать файл.</span><span class="sxs-lookup"><span data-stu-id="4e603-146">All clients must be able to share the file.</span></span> <span data-ttu-id="4e603-147">Блокировки фильтров позволяют приложениям выполнять неагрессивные операции фильтрации данных файлов (например, код, открывающий компилятор или программу каталогизации).</span><span class="sxs-lookup"><span data-stu-id="4e603-147">Filter locks allow applications to perform nonintrusive filtering operations on file data (for example, a compiler opening source code or a cataloging program).</span></span>

<span data-ttu-id="4e603-148">Фильтр оппортунистической блокировки отличается от уступающей блокировки уровня 2 тем, что она позволяет открытым операциям чтения выполнять операции без нарушения общего доступа в промежутке времени между открытием файла приложением и получением блокировки.</span><span class="sxs-lookup"><span data-stu-id="4e603-148">A filter opportunistic lock differs from a level 2 opportunistic lock in that it allows open operations for reading to occur without sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="4e603-149">Бесполезное применение фильтра — это лучшая блокировка, когда важно разрешить другим клиентам доступ на чтение.</span><span class="sxs-lookup"><span data-stu-id="4e603-149">The filter opportunistic lock is the best lock to use when it is important to allow other clients reading access.</span></span> <span data-ttu-id="4e603-150">В других случаях приложение должно использовать уступающую блокировку уровня 2.</span><span class="sxs-lookup"><span data-stu-id="4e603-150">In other cases, your application should use a level 2 opportunistic lock.</span></span> <span data-ttu-id="4e603-151">Фильтр оппортунистической блокировки отличается от оппортунистической блокировки пакетной службы тем, что она не допускает, чтобы несколько закрываемых и закрывающих сторон были обработаны перенаправлением сети, как это делает Пакетная блокировка.</span><span class="sxs-lookup"><span data-stu-id="4e603-151">A filter opportunistic lock differs from a batch opportunistic lock in that it does not allow multiple openings and closings to be handled by the network redirector the way a batch opportunistic lock does.</span></span>

<span data-ttu-id="4e603-152">Приложение должно запрашивать фильтр оппортунистической блокировки файла в три этапа:</span><span class="sxs-lookup"><span data-stu-id="4e603-152">Your application should request a filter opportunistic lock on a file in three steps:</span></span>

1.  <span data-ttu-id="4e603-153">Используйте функцию [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) , чтобы открыть в файле маркер с параметром *десиредакцесс* , которому присвоено значение 0, указывающее на отсутствие доступа, а параметру *двшаремоде* — флаг **\_ \_ чтения общей папки** , чтобы разрешить общий доступ для чтения.</span><span class="sxs-lookup"><span data-stu-id="4e603-153">Use the [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) function to open a handle to the file with the *DesiredAccess* parameter set to zero, indicating no access, and the *dwShareMode* parameter set to the **FILE\_SHARE\_READ** flag to allow sharing for reading.</span></span> <span data-ttu-id="4e603-154">Полученный на этом этапе маркер называется маркером блокировки.</span><span class="sxs-lookup"><span data-stu-id="4e603-154">The handle obtained at this point is called the locking handle.</span></span>
2.  <span data-ttu-id="4e603-155">Запросите блокировку этого маркера с помощью управляющего кода [**\_ \_ фильтрации \_ запросов фсктл**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) .</span><span class="sxs-lookup"><span data-stu-id="4e603-155">Request a lock on this handle with the [**FSCTL\_REQUEST\_FILTER\_OPLOCK**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) control code.</span></span>
3.  <span data-ttu-id="4e603-156">Когда блокировка будет предоставлена, используйте [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) , чтобы снова открыть файл с параметром *десиредакцесс* , равным **универсальному флагу \_ Read** .</span><span class="sxs-lookup"><span data-stu-id="4e603-156">When the lock is granted, use [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) to open the file again with *DesiredAccess* set to the **GENERIC\_READ** flag.</span></span> <span data-ttu-id="4e603-157">Задайте для параметра *двшаремоде* значение флаг **\_ \_ чтения общей папки** , чтобы разрешить другим пользователям читать файл, пока он открыт, с помощью флага **\_ \_ удаления общей папки** , чтобы разрешить другим пользователям пометить файл для удаления, пока он открыт, или оба.</span><span class="sxs-lookup"><span data-stu-id="4e603-157">Set *dwShareMode* to the **FILE\_SHARE\_READ** flag to allow others to read the file while you have it open, the **FILE\_SHARE\_DELETE** flag to allow others to mark the file for deletion while you have it open, or both.</span></span> <span data-ttu-id="4e603-158">Полученный на этом этапе маркер называется маркером чтения.</span><span class="sxs-lookup"><span data-stu-id="4e603-158">The handle obtained at this point is called the read handle.</span></span>

<span data-ttu-id="4e603-159">Используйте маркер чтения для чтения или записи содержимого файла.</span><span class="sxs-lookup"><span data-stu-id="4e603-159">Use the read handle to read from or write to the contents of the file.</span></span>

<span data-ttu-id="4e603-160">При открытии файла, у которого уже есть фильтр оппортунистической блокировки, сервер прерывает блокировку, а затем проверяет состояние общего доступа к файлу.</span><span class="sxs-lookup"><span data-stu-id="4e603-160">When opening a file that already has a filter opportunistic lock, the server breaks the lock and then checks the sharing state of the file.</span></span> <span data-ttu-id="4e603-161">Эта проверка дает клиенту, который удерживает бывшую уступающую блокировку, возможность отменять любые кэшированные данные и подтверждать перерыв.</span><span class="sxs-lookup"><span data-stu-id="4e603-161">This check gives the client that held the former opportunistic lock a chance to abandon any cached data and acknowledge the break.</span></span> <span data-ttu-id="4e603-162">Операция открытия, выполняемая во время этой проверки общего доступа, не приводит к сбою проверки общего доступа, если предыдущая блокировка снимает блокировку.</span><span class="sxs-lookup"><span data-stu-id="4e603-162">An open operation attempted during this sharing check does not cause the sharing check to fail if the former lock holder releases the lock.</span></span> <span data-ttu-id="4e603-163">Файловая система находится в абэйанце операции открытия до тех пор, пока владелец блокировки не закроет как маркер чтения, так и маркер блокировки.</span><span class="sxs-lookup"><span data-stu-id="4e603-163">The file system holds in abeyance the open operation until the lock's owner closes both the read handle and then the locking handle.</span></span> <span data-ttu-id="4e603-164">После этого запрос на открытие другого клиента может быть продолжен.</span><span class="sxs-lookup"><span data-stu-id="4e603-164">After this is done, the other client's open request can proceed.</span></span>

<span data-ttu-id="4e603-165">Дополнительные сведения о нарушении уступающей блокировки см. в разделе [разбиение уступающей блокировки](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="4e603-165">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

 

 
