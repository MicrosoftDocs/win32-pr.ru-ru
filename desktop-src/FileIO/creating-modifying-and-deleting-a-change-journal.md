---
description: Администраторы могут создавать, удалять и повторно создавать журналы изменений.
ms.assetid: 26cbacc2-d26b-434b-91b5-31aedc96da13
title: Создание, изменение и удаление журнала изменений
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 50c8cf7296f93549e7d9ec05f5d614131cc342ce
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105664287"
---
# <a name="creating-modifying-and-deleting-a-change-journal"></a><span data-ttu-id="d972e-103">Создание, изменение и удаление журнала изменений</span><span class="sxs-lookup"><span data-stu-id="d972e-103">Creating, Modifying, and Deleting a Change Journal</span></span>

<span data-ttu-id="d972e-104">Администраторы могут создавать, удалять и повторно создавать журналы изменений.</span><span class="sxs-lookup"><span data-stu-id="d972e-104">Administrators can create, delete, and re-create change journals at will.</span></span> <span data-ttu-id="d972e-105">Администратор должен удалить журнал, если текущее значение порядкового номера обновления (USN) приближается к максимально возможному значению USN, как указано элементом **максусн** структуры [**\_ \_ данных журнала USN**](/windows/desktop/api/WinIoCtl/ns-winioctl-usn_journal_data_v0) .</span><span class="sxs-lookup"><span data-stu-id="d972e-105">An administrator should delete a journal when the current update sequence number (USN) value approaches the maximum possible USN value, as indicated by the **MaxUsn** member of the [**USN\_JOURNAL\_DATA**](/windows/desktop/api/WinIoCtl/ns-winioctl-usn_journal_data_v0) structure.</span></span> <span data-ttu-id="d972e-106">Администратор может также удалить и повторно создать журнал изменений, чтобы освободить место на диске.</span><span class="sxs-lookup"><span data-stu-id="d972e-106">An administrator might also delete and re-create a change journal to reclaim disk space.</span></span> <span data-ttu-id="d972e-107">Для выполнения этой операции и всех остальных непрограммных операций с журналом изменений требуются права системного администратора.</span><span class="sxs-lookup"><span data-stu-id="d972e-107">To perform this and all other non-programmatic change journal operations, you must have system administrator privileges.</span></span> <span data-ttu-id="d972e-108">То есть необходимо быть членом группы администраторов.</span><span class="sxs-lookup"><span data-stu-id="d972e-108">That is, you must be a member of the Administrators group.</span></span>

<span data-ttu-id="d972e-109">Чтобы создать или изменить журнал изменений на указанном томе программным путем, используйте управляющий код [**фсктл \_ Create \_ USN \_**](/windows/win32/api/winioctl/ni-winioctl-fsctl_create_usn_journal) .</span><span class="sxs-lookup"><span data-stu-id="d972e-109">To create or modify a change journal on a specified volume programmatically, use the [**FSCTL\_CREATE\_USN\_JOURNAL**](/windows/win32/api/winioctl/ni-winioctl-fsctl_create_usn_journal) control code.</span></span>

<span data-ttu-id="d972e-110">При создании нового или изменении существующего журнала изменений файловая система NTFS устанавливает сведения для этого журнала изменений из сведений в структуре [**\_ \_ \_ данных журнала USN**](/windows/desktop/api/WinIoCtl/ns-winioctl-create_usn_journal_data) , которая [**фсктл \_ создать \_ \_ журнал USN**](/windows/win32/api/winioctl/ni-winioctl-fsctl_create_usn_journal) .</span><span class="sxs-lookup"><span data-stu-id="d972e-110">When you create a new change journal or modify an existing one, the NTFS file system sets information for that change journal from information in the [**CREATE\_USN\_JOURNAL\_DATA**](/windows/desktop/api/WinIoCtl/ns-winioctl-create_usn_journal_data) structure, which [**FSCTL\_CREATE\_USN\_JOURNAL**](/windows/win32/api/winioctl/ni-winioctl-fsctl_create_usn_journal) takes as input.</span></span> <span data-ttu-id="d972e-111">**Создание \_ \_ \_ Данные журнала USN** имеют элементы **MaximumSize** и **аллокатионделта**.</span><span class="sxs-lookup"><span data-stu-id="d972e-111">**CREATE\_USN\_JOURNAL\_DATA** has the members **MaximumSize** and **AllocationDelta**.</span></span>

<span data-ttu-id="d972e-112">**MaximumSize** — это максимальный целевой размер журнала изменений в байтах.</span><span class="sxs-lookup"><span data-stu-id="d972e-112">**MaximumSize** is the target maximum size for the change journal in bytes.</span></span> <span data-ttu-id="d972e-113">Журнал изменений может увеличиваться больше этого значения, но в файловой системе NTFS контрольные точки файловой системы NTFS проверяют журнал и обрезают его, если его размер превышает значение **MaximumSize** плюс значение **аллокатионделта**.</span><span class="sxs-lookup"><span data-stu-id="d972e-113">The change journal can grow larger than this value, but at NTFS file system checkpoints the NTFS file system examines the journal and trims it when its size exceeds the value of **MaximumSize** plus the value of **AllocationDelta**.</span></span> <span data-ttu-id="d972e-114">(В контрольных точках файловой системы NTFS операционная система записывает записи в файл журнала файловой системы NTFS, который позволяет файловой системе NTFS определить, какая обработка необходима для восстановления после сбоя.)</span><span class="sxs-lookup"><span data-stu-id="d972e-114">(At NTFS file system checkpoints, the operating system writes records to the NTFS file system log file that allow the NTFS file system to determine what processing is required to recover from a failure.)</span></span>

<span data-ttu-id="d972e-115">**Аллокатионделта** — число байтов, добавленных к концу и удаляемых из начала журнала изменений при каждом выделении или освобождении памяти.</span><span class="sxs-lookup"><span data-stu-id="d972e-115">**AllocationDelta** is the number of bytes added to the end and removed from the beginning of the change journal each time memory is allocated or deallocated.</span></span> <span data-ttu-id="d972e-116">Иными словами, выделение и освобождение выполняются в единицах этого размера.</span><span class="sxs-lookup"><span data-stu-id="d972e-116">In other words, allocation and deallocation take place in units of this size.</span></span> <span data-ttu-id="d972e-117">Целое число, кратное размеру кластера, является разумным значением для этого члена.</span><span class="sxs-lookup"><span data-stu-id="d972e-117">An integer multiple of a cluster size is a reasonable value for this member.</span></span>

<span data-ttu-id="d972e-118">Если администратор изменяет существующий журнал изменений таким образом, чтобы он имел более крупное значение **MaximumSize** , например если слишком часто выполняется повторное индексирование тома, журнал изменений просто получает новые записи, пока не превысит новый максимальный размер.</span><span class="sxs-lookup"><span data-stu-id="d972e-118">If an administrator modifies an existing change journal to have a larger **MaximumSize** value, for example if a volume is being re-indexed too often, the change journal simply receives new entries until it exceeds the new maximum size.</span></span>

<span data-ttu-id="d972e-119">Чтобы удалить журнал изменений, используйте управляющий [**код \_ удаления \_ \_ журнала USN фсктл**](/windows/win32/api/winioctl/ni-winioctl-fsctl_delete_usn_journal) .</span><span class="sxs-lookup"><span data-stu-id="d972e-119">To delete a change journal, use the [**FSCTL\_DELETE\_USN\_JOURNAL**](/windows/win32/api/winioctl/ni-winioctl-fsctl_delete_usn_journal) control code.</span></span> <span data-ttu-id="d972e-120">При использовании этой операции она проходит по всем файлам на томе и сбрасывает USN для каждого файла в ноль.</span><span class="sxs-lookup"><span data-stu-id="d972e-120">When you use this operation, it walks through all of the files on the volume and resets the USN for each file to zero.</span></span> <span data-ttu-id="d972e-121">Затем операция удаляет существующий журнал изменений.</span><span class="sxs-lookup"><span data-stu-id="d972e-121">The operation then deletes the existing change journal.</span></span> <span data-ttu-id="d972e-122">Эта операция сохраняется по перезапуску системы до ее завершения.</span><span class="sxs-lookup"><span data-stu-id="d972e-122">This operation persists across system restarts until it completes.</span></span> <span data-ttu-id="d972e-123">Любая попытка чтения, создания или изменения журнала изменений во время этого процесса завершается ошибкой с кодом ошибки **« \_ \_ Удаление журнала \_ \_ ошибок**».</span><span class="sxs-lookup"><span data-stu-id="d972e-123">Any attempt to read, create, or modify the change journal during this process fails with the error code **ERROR\_JOURNAL\_DELETE\_IN\_PROGRESS**.</span></span>

<span data-ttu-id="d972e-124">Вы также можете использовать управляющий код [**фсктл \_ DELETE \_ USN \_**](/windows/win32/api/winioctl/ni-winioctl-fsctl_delete_usn_journal) , чтобы определить, выполняется ли удаление, запущенное другим процессом.</span><span class="sxs-lookup"><span data-stu-id="d972e-124">You can also use the [**FSCTL\_DELETE\_USN\_JOURNAL**](/windows/win32/api/winioctl/ni-winioctl-fsctl_delete_usn_journal) control code to determine if a deletion started by some other process is in progress.</span></span> <span data-ttu-id="d972e-125">Например, приложение, когда оно запускается, может определить, выполняется ли удаление.</span><span class="sxs-lookup"><span data-stu-id="d972e-125">For example, your application, when it is started, can determine if a deletion is in progress.</span></span> <span data-ttu-id="d972e-126">Поскольку операции удаления журналов сохраняются при перезапуске системы, службы и приложения, запущенные при перезагрузке системы, должны проверить текущее удаление.</span><span class="sxs-lookup"><span data-stu-id="d972e-126">Because journal deletions persist across system restarts, services and applications started at system restart should check for an ongoing deletion.</span></span>

<span data-ttu-id="d972e-127">Журналы изменений не обязательно создаются при запуске.</span><span class="sxs-lookup"><span data-stu-id="d972e-127">Change journals are not necessarily created at startup.</span></span> <span data-ttu-id="d972e-128">Чтобы создать журнал изменений, администратор может сделать это явным образом или запустить другую службу, для которой требуется журнал изменений.</span><span class="sxs-lookup"><span data-stu-id="d972e-128">To create a change journal, an administrator may do so explicitly or start another service that requires a change journal.</span></span>

 

 
