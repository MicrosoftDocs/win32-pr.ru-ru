---
description: Рекомендации по оптимизации транзакций файловой системы.
ms.assetid: 847939ff-5322-4023-8ef7-9d845e80d65c
title: Рекомендации по производительности для транзакционной NTFS
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3a71f7e100e1ddd8524932a4a259a12092bddcb6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103999154"
---
# <a name="performance-considerations-for-transactional-ntfs"></a><span data-ttu-id="3b191-103">Рекомендации по производительности для транзакционной NTFS</span><span class="sxs-lookup"><span data-stu-id="3b191-103">Performance Considerations for Transactional NTFS</span></span>

<span data-ttu-id="3b191-104">Транзакционная NTFS (TxF) была тщательно спроектирована для повышения производительности и обычно выполняется лучше, чем для транзакционных альтернатив общего назначения в рамках аналогичных сценариев.</span><span class="sxs-lookup"><span data-stu-id="3b191-104">Transactional NTFS (TxF) has been carefully designed for performance and will typically perform better than general-purpose transactional alternatives under similar scenarios.</span></span> <span data-ttu-id="3b191-105">Однако транзакции файловой системы имеют больший расход ресурсов, чем операции, не относящиеся к транзакции, и ожидается снижение производительности ввода-вывода по сравнению с операциями ввода-вывода, не являющимися транзакционными.</span><span class="sxs-lookup"><span data-stu-id="3b191-105">However, file system transactions have more overhead than non-transacted operations, and some reduction in I/O performance compared to non-transacted I/O is to be expected.</span></span> <span data-ttu-id="3b191-106">Приложения, критические для производительности, должны выполнять цикл квалификации внедрения технологий, оценивая влияние транзакционной файловой системы на производительность.</span><span class="sxs-lookup"><span data-stu-id="3b191-106">Performance-critical applications should perform a technology adoption qualification cycle, evaluating the performance impact of transacted file system operations.</span></span>

## <a name="overview-of-txf-operations"></a><span data-ttu-id="3b191-107">Общие сведения об операциях TxF</span><span class="sxs-lookup"><span data-stu-id="3b191-107">Overview of TxF Operations</span></span>

<span data-ttu-id="3b191-108">TxF использует ведение журнала *отмены* для записи изменений, необходимых для возвращения файловой системы в целостное состояние, которое также называется откатом, если происходит прерывание транзакции.</span><span class="sxs-lookup"><span data-stu-id="3b191-108">TxF uses *undo* logging to record the changes necessary to put the file system back into a consistent state, also referred to as a rollback, should a transaction abort occur.</span></span> <span data-ttu-id="3b191-109">Это ведение журнала отмены создает дополнительные операции ввода-вывода и является источником издержек на производительность TxF по сравнению с операциями файловой системы, которые не являются транзакционными.</span><span class="sxs-lookup"><span data-stu-id="3b191-109">This undo logging generates additional I/O and is the source of TxF performance overhead compared to non-transactional file system operations.</span></span>

<span data-ttu-id="3b191-110">Общая сводка о том, как работает TxF, выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="3b191-110">A high-level summary of how TxF operates is as follows:</span></span>

-   <span data-ttu-id="3b191-111">По мере выполнения транзакции TxF записывает *отменяющие* записи в файл журнала для каждого изменения, внесенного в файловую систему.</span><span class="sxs-lookup"><span data-stu-id="3b191-111">As a transaction progresses, TxF writes *undo* records into its log file for each modification it makes to the file system.</span></span> <span data-ttu-id="3b191-112">В случае прерывания эти записи отмены анализируются, чтобы вернуть файловую систему в состояние, в котором она находилась до начала транзакции.</span><span class="sxs-lookup"><span data-stu-id="3b191-112">If an abort occurs, these undo records are parsed to put the file system back in the state it was before the transaction began.</span></span>
-   <span data-ttu-id="3b191-113">Запись отмены *изменений метаданных* описывает изменение только метаданных файловой системы.</span><span class="sxs-lookup"><span data-stu-id="3b191-113">A *metadata change* undo record describes a change only to the file system's metadata.</span></span> <span data-ttu-id="3b191-114">Некоторые примеры таких элементов: перемещение, переименование, Добавление и изменение атрибутов.</span><span class="sxs-lookup"><span data-stu-id="3b191-114">Some examples of this are moves, renames, appends, and attribute changes.</span></span> <span data-ttu-id="3b191-115">Для записей отмены изменений метаданных все сведения, необходимые для отмены изменения, находятся в записи и хранятся в файле журнала.</span><span class="sxs-lookup"><span data-stu-id="3b191-115">For metadata change undo records, all of the information necessary to undo the change is in the record and stored in the log file.</span></span>
-   <span data-ttu-id="3b191-116">Запись отмены *перезаписи* описывает перезапись части файла.</span><span class="sxs-lookup"><span data-stu-id="3b191-116">An *overwrite* undo record describes an overwrite of a portion of a file.</span></span> <span data-ttu-id="3b191-117">Когда происходит перезапись файла, исходное содержимое файла сохраняется в специальном файле отмены в скрытом каталоге, а запись отмены изменений перезаписи указывает на этот файл.</span><span class="sxs-lookup"><span data-stu-id="3b191-117">When a file overwrite occurs, the file's original contents are stored in a special undo file in a hidden directory and the overwrite undo record points to this file.</span></span> <span data-ttu-id="3b191-118">Когда обновления файлов в конечном итоге сбрасываются из кэша на диск, содержимое файла отмены также должно быть очищено, поэтому транзакционная перезапись файла может создать до двух случайных операций ввода-вывода: один для чтения старых данных, а другой для записи в файл отката.</span><span class="sxs-lookup"><span data-stu-id="3b191-118">When file updates are eventually flushed from cache to disk, the contents of the undo file must also be flushed, so a transacted file overwrite could generate up to two extra random I/O operations: one to read the old data and one to write it to the undo file.</span></span> <span data-ttu-id="3b191-119">Эти дополнительные операции ввода-вывода представляют собой стоимость производительности TxF.</span><span class="sxs-lookup"><span data-stu-id="3b191-119">These extra I/O operations are a performance cost of TxF.</span></span>
-   <span data-ttu-id="3b191-120">Когда происходит фиксация, TxF сначала очищает все сведения об отмене, затем очищает фактические изменения файла, а затем записывает и очищает запись фиксации.</span><span class="sxs-lookup"><span data-stu-id="3b191-120">When a commit occurs, TxF first flushes all undo information, then flushes the actual file changes, and then writes and flushes a commit record.</span></span> <span data-ttu-id="3b191-121">Если нет файлов отмены для сброса, то при записи журнала на диск удаляются только дополнительные издержки TxF, относящиеся к нетранзакционным операциям ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="3b191-121">If there are no undo files to flush, the only additional TxF overhead relative to non-transacted I/O is the log flushes themselves.</span></span> <span data-ttu-id="3b191-122">Однако сброс журнала приводит к эффективному большим последовательным операциям записи, поэтому затраты на производительность минимальны.</span><span class="sxs-lookup"><span data-stu-id="3b191-122">However, log flushes result in efficient large sequential writes so the performance cost is minimal.</span></span>
-   <span data-ttu-id="3b191-123">Система TxF оптимизирована для фиксации.</span><span class="sxs-lookup"><span data-stu-id="3b191-123">TxF is optimized for commit.</span></span> <span data-ttu-id="3b191-124">Ожидается, что большинство транзакций будут выполнены без необходимости отката, поэтому все записи отмены для транзакции должны быть неиспользуемыми.</span><span class="sxs-lookup"><span data-stu-id="3b191-124">It is expected that most transactions will succeed and not need to rollback, therefore all undo records for a transaction are expected to go unused.</span></span> <span data-ttu-id="3b191-125">С точки зрения производительности операции фиксации TxF выполняются быстро, а откаты — с большим объемом ресурсов.</span><span class="sxs-lookup"><span data-stu-id="3b191-125">From a performance perspective, TxF commit operations are fast and rollbacks are resource-intensive.</span></span>
-   <span data-ttu-id="3b191-126">Откат требует больше ресурсов, чем фиксация.</span><span class="sxs-lookup"><span data-stu-id="3b191-126">Rollback is more resource-intensive than commit.</span></span> <span data-ttu-id="3b191-127">Во время отката все изменения, внесенные в транзакцию, должны быть отменены.</span><span class="sxs-lookup"><span data-stu-id="3b191-127">During rollback, all the changes that were made in the transaction have to be un-done.</span></span> <span data-ttu-id="3b191-128">Как правило, длительность отката может быть приблизительно такой же, как и для первоначального внесения изменений.</span><span class="sxs-lookup"><span data-stu-id="3b191-128">In general, rollback duration can be approximately the same it took to originally make the changes.</span></span> <span data-ttu-id="3b191-129">Например, если для внесения всех изменений потребуется одна секунда, для ее отмены может потребоваться около 1 секунды.</span><span class="sxs-lookup"><span data-stu-id="3b191-129">For example, if it took 1 second to make all the changes then it could take about 1 second to undo them.</span></span> <span data-ttu-id="3b191-130">Для очень длинных транзакций откат может повысить производительность.</span><span class="sxs-lookup"><span data-stu-id="3b191-130">For very long transactions, rollback can create additional performance impacts.</span></span> <span data-ttu-id="3b191-131">Например, время загрузки системы может быть отложено, если система должна автоматически отменять транзакцию в случае, если система перестает отвечать на запросы и должна выполнить незапланированную перезагрузку.</span><span class="sxs-lookup"><span data-stu-id="3b191-131">For example, system boot time can be delayed if the system must automatically rollback a transaction in the event that the system stops responding and must perform an unscheduled restart.</span></span>

<span data-ttu-id="3b191-132">Сводные выводы о производительности, которые могут быть выведены из предыдущего списка, приведены ниже.</span><span class="sxs-lookup"><span data-stu-id="3b191-132">The summary conclusions about performance that can be drawn from the previous list are as follows:</span></span>

-   <span data-ttu-id="3b191-133">Производительность TxF для транзакций, включающих в себя перезапись файлов, может быть значительной.</span><span class="sxs-lookup"><span data-stu-id="3b191-133">The performance cost of TxF for transactions involving file overwrites can be significant.</span></span>
-   <span data-ttu-id="3b191-134">Стоимость производительности TxF для транзакций, включающих только операции с метаданными, может быть относительно низкой, если используются большие транзакции.</span><span class="sxs-lookup"><span data-stu-id="3b191-134">The performance cost of TxF for transactions involving only metadata operations can be relatively low, provided large transactions be used.</span></span> <span data-ttu-id="3b191-135">Большая транзакция имеет большое количество записей отмены для каждой записи фиксации.</span><span class="sxs-lookup"><span data-stu-id="3b191-135">A large transaction is when there are many undo records for every commit record.</span></span>

## <a name="recommendations-for-best-performance"></a><span data-ttu-id="3b191-136">Рекомендации по лучшей производительности</span><span class="sxs-lookup"><span data-stu-id="3b191-136">Recommendations For Best Performance</span></span>

<span data-ttu-id="3b191-137">Выведите издержки TxF за более крупные транзакции.</span><span class="sxs-lookup"><span data-stu-id="3b191-137">Amortize TxF overhead over larger transactions.</span></span> <span data-ttu-id="3b191-138">Например, если у вас есть *n* наборов изменений, чтобы сделать так, чтобы каждое изменение имело шаги *m* , и вы можете сделать это как *N* транзакций из *m* шагов каждый или сделать все как одну транзакцию с *м* \* *N* шагами, последний вариант будет более эффективным.</span><span class="sxs-lookup"><span data-stu-id="3b191-138">For example, if you have *N* sets of changes to make where each change has *M* steps and you have the option to either do this as *N* transactions of *M* steps each or do it all as a single transaction with *M*\**N* steps, the latter option would be more efficient.</span></span>

<span data-ttu-id="3b191-139">Учитывайте возможное влияние на загрузку очень больших транзакций.</span><span class="sxs-lookup"><span data-stu-id="3b191-139">Consider the possible impact on boot of very large transactions.</span></span> <span data-ttu-id="3b191-140">Как было сказано ранее, откат может быть медленным и будет задерживать время загрузки, если система должна выполнять автоматический откат в качестве времени загрузки.</span><span class="sxs-lookup"><span data-stu-id="3b191-140">As previously stated, rollback can be slow and will delay boot time if the system needs to perform automatic rollbacks as boot time.</span></span> <span data-ttu-id="3b191-141">Чем больше транзакция, тем дольше задержка.</span><span class="sxs-lookup"><span data-stu-id="3b191-141">The larger the transaction, the longer the delay.</span></span>

<span data-ttu-id="3b191-142">Продерживайте транзакции в большинстве операций с метаданными.</span><span class="sxs-lookup"><span data-stu-id="3b191-142">Keep transactions to mostly metadata operations.</span></span> <span data-ttu-id="3b191-143">Это то, что система TxF оптимизирована для и, в целом, производительность аналогична операции файлового ввода-вывода, не являющейся транзакционной, для транзакций с большими метаданными.</span><span class="sxs-lookup"><span data-stu-id="3b191-143">This is what TxF is optimized for and, in general, the performance is about the same as non-transacted file I/O for large metadata transactions.</span></span> <span data-ttu-id="3b191-144">Примерами эффективных метаданных могут служить функции TxF [**мовефилетрансактед**](/windows/desktop/api/WinBase/nf-winbase-movefiletransacteda), [**сетфилеаттрибутестрансактед**](/windows/desktop/api/WinBase/nf-winbase-setfileattributestransacteda), [**копифилетрансактед**](/windows/desktop/api/WinBase/nf-winbase-copyfiletransacteda), [**делетефилетрансактед**](/windows/desktop/api/WinBase/nf-winbase-deletefiletransacteda), [**CreateHardLinkTransacted**](/windows/desktop/api/WinBase/nf-winbase-createhardlinktransacteda), а также добавленные операции записи (вызовы функции [**WriteFile**](/windows/desktop/api/FileAPI/nf-fileapi-writefile) , когда указатель файла находится в конце файла или *EOF*).</span><span class="sxs-lookup"><span data-stu-id="3b191-144">Examples of efficient metadata TxF functions are [**MoveFileTransacted**](/windows/desktop/api/WinBase/nf-winbase-movefiletransacteda), [**SetFileAttributesTransacted**](/windows/desktop/api/WinBase/nf-winbase-setfileattributestransacteda), [**CopyFileTransacted**](/windows/desktop/api/WinBase/nf-winbase-copyfiletransacteda), [**DeleteFileTransacted**](/windows/desktop/api/WinBase/nf-winbase-deletefiletransacteda), [**CreateHardLinkTransacted**](/windows/desktop/api/WinBase/nf-winbase-createhardlinktransacteda), and appended writes (calls to the [**WriteFile**](/windows/desktop/api/FileAPI/nf-fileapi-writefile) function when the file pointer as at the end the file, or *EOF*).</span></span> <span data-ttu-id="3b191-145">Примером ресурсоемких операций, не связанных с метаданными, являются вызовы функции **WriteFile** , если указатель файла находится не на EOF.</span><span class="sxs-lookup"><span data-stu-id="3b191-145">An example of resource-intensive non-metadata operations are calls to the **WriteFile** function when the file pointer is not at the EOF.</span></span>

## <a name="summary-of-txf-performance-expectations"></a><span data-ttu-id="3b191-146">Сводка по ожиданиям производительности TxF</span><span class="sxs-lookup"><span data-stu-id="3b191-146">Summary of TxF Performance Expectations</span></span>

<span data-ttu-id="3b191-147">Для обновлений на месте перезапись в раздел файла будет выполняться значительно медленнее, чем в операциях файлового ввода-вывода, а производительность TxF для операций с метаданными файловой системы (например, создание, перемещение и добавление) сравнима с операциями файлового ввода-вывода для больших транзакций.</span><span class="sxs-lookup"><span data-stu-id="3b191-147">For in-place updates, overwrites to a section of a file will be much slower than non-transacted file I/O, while TxF performance for file system metadata operations (for example, create, move, and append) is comparable to non-transacted file I/O for large transactions.</span></span>

 

 



