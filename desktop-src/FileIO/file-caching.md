---
description: Windows кэширует файловые данные, которые считываются с дисков и записываются на диски.
ms.assetid: 0865c741-63e3-4246-ba69-801b02153e4a
title: Кэширование файлов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1a14fb668af16cfb8a4e42b59b25b73ecefbb7cb
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103912867"
---
# <a name="file-caching"></a><span data-ttu-id="70e37-103">Кэширование файлов</span><span class="sxs-lookup"><span data-stu-id="70e37-103">File Caching</span></span>

<span data-ttu-id="70e37-104">По умолчанию Windows кэширует данные файлов, которые считываются с дисков и записываются на диски.</span><span class="sxs-lookup"><span data-stu-id="70e37-104">By default, Windows caches file data that is read from disks and written to disks.</span></span> <span data-ttu-id="70e37-105">Это означает, что операции чтения считывают файловые данные из области в системной памяти, которая называется кэшем системных файлов, а не с физического диска.</span><span class="sxs-lookup"><span data-stu-id="70e37-105">This implies that read operations read file data from an area in system memory known as the system file cache, rather than from the physical disk.</span></span> <span data-ttu-id="70e37-106">Соответственно, при операциях записи данные файлов записываются в системный файловый кэш, а не на диск. Такой тип кэша называется кэшем обратной записи.</span><span class="sxs-lookup"><span data-stu-id="70e37-106">Correspondingly, write operations write file data to the system file cache rather than to the disk, and this type of cache is referred to as a write-back cache.</span></span> <span data-ttu-id="70e37-107">Управление кэшированием осуществляется для каждого файлового объекта.</span><span class="sxs-lookup"><span data-stu-id="70e37-107">Caching is managed per file object.</span></span>

<span data-ttu-id="70e37-108">Кэширование выполняется в направлении *диспетчера кэша*, которое постоянно работает во время работы Windows.</span><span class="sxs-lookup"><span data-stu-id="70e37-108">Caching occurs under the direction of the *cache manager*, which operates continuously while Windows is running.</span></span> <span data-ttu-id="70e37-109">Данные файлов в кэше системных файлов записываются на диск с интервалами, определенными операционной системой, и память, ранее используемая этими данными файлов, освобождается — это называется *сбросом* кэша.</span><span class="sxs-lookup"><span data-stu-id="70e37-109">File data in the system file cache is written to the disk at intervals determined by the operating system, and the memory previously used by that file data is freed—this is referred to as *flushing* the cache.</span></span> <span data-ttu-id="70e37-110">Политика задержки записи данных в файл и удерживает ее в кэше до тех пор, пока кэш не будет сброшен, а диспетчер кэша запустится с интервалом времени завершения.</span><span class="sxs-lookup"><span data-stu-id="70e37-110">The policy of delaying the writing of the data to the file and holding it in the cache until the cache is flushed is called lazy writing, and it is triggered by the cache manager at a determinate time interval.</span></span> <span data-ttu-id="70e37-111">Время записи на диск блока данных частично зависит от длительности его хранения в кэше, а также от времени, прошедшего с момента последнего обращения к этим данным при выполнении операции чтения.</span><span class="sxs-lookup"><span data-stu-id="70e37-111">The time at which a block of file data is flushed is partially based on the amount of time it has been stored in the cache and the amount of time since the data was last accessed in a read operation.</span></span> <span data-ttu-id="70e37-112">Это гарантирует, что данные файлов, которые часто считываются, останутся доступными в системном файловом кэше максимально долго.</span><span class="sxs-lookup"><span data-stu-id="70e37-112">This ensures that file data that is frequently read will stay accessible in the system file cache for the maximum amount of time.</span></span>

<span data-ttu-id="70e37-113">Этот процесс кэширования данных файлов показан на следующем рисунке.</span><span class="sxs-lookup"><span data-stu-id="70e37-113">This file data caching process is illustrated in the following figure.</span></span>

![процесс кэширования файловых данных](images/fig3.png)

<span data-ttu-id="70e37-115">Как показано сплошными стрелками на предыдущем рисунке, область данных размером 256 КБ считывается в области кэша 256 КБ в системном адресном пространстве при первом запросе диспетчером кэша во время операции чтения файла.</span><span class="sxs-lookup"><span data-stu-id="70e37-115">As depicted by the solid arrows in the previous figure, a 256 KB region of data is read into a 256 KB cache "slot" in system address space when it is first requested by the cache manager during a file read operation.</span></span> <span data-ttu-id="70e37-116">Затем процесс пользовательского режима копирует данные из этого слота в свое собственное адресное пространство.</span><span class="sxs-lookup"><span data-stu-id="70e37-116">A user-mode process then copies the data in this slot to its own address space.</span></span> <span data-ttu-id="70e37-117">Завершив обращение к данным, процесс записывает измененные данные в тот же слот в системном кэше. На рисунке это обозначено пунктирной стрелкой между адресным пространством процесса и системным кэшем.</span><span class="sxs-lookup"><span data-stu-id="70e37-117">When the process has completed its data access, it writes the altered data back to the same slot in the system cache, as shown by the dotted arrow between the process address space and the system cache.</span></span> <span data-ttu-id="70e37-118">Когда диспетчер кэша определит, что данные больше не понадобятся в течение определенного промежутка времени, они записывают измененные данные обратно в файл на диске, как показано стрелкой пунктира между системным кэшем и диском.</span><span class="sxs-lookup"><span data-stu-id="70e37-118">When the cache manager has determined that the data will no longer be needed for a certain amount of time, it writes the altered data back to the file on the disk, as shown by the dotted arrow between the system cache and the disk.</span></span>

<span data-ttu-id="70e37-119">Количество операций ввода-вывода, которые предлагает кэширование файловых данных, зависит от размера считываемых или записываемых блоков файловых файлов.</span><span class="sxs-lookup"><span data-stu-id="70e37-119">The amount of I/O performance improvement that file data caching offers depends on the size of the file data block being read or written.</span></span> <span data-ttu-id="70e37-120">Когда большие блоки файловых данных считываются и записываются, скорее всего, для завершения операции ввода-вывода будет необходимо чтение и запись с диска.</span><span class="sxs-lookup"><span data-stu-id="70e37-120">When large blocks of file data are read and written, it is more likely that disk reads and writes will be necessary to finish the I/O operation.</span></span> <span data-ttu-id="70e37-121">Производительность операций ввода-вывода будет все более нарушена, так как выполняется больше операций ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="70e37-121">I/O performance will be increasingly impaired as more of this kind of I/O operation occurs.</span></span>

<span data-ttu-id="70e37-122">В таких ситуациях кэширование может быть отключено.</span><span class="sxs-lookup"><span data-stu-id="70e37-122">In these situations, caching can be turned off.</span></span> <span data-ttu-id="70e37-123">Это делается во время открытия файла путем передачи **\_ флага файла \_ без \_ буферизации** в качестве значения параметра *двфлагсандаттрибутес* [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea).</span><span class="sxs-lookup"><span data-stu-id="70e37-123">This is done at the time the file is opened by passing **FILE\_FLAG\_NO\_BUFFERING** as a value for the *dwFlagsAndAttributes* parameter of [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea).</span></span> <span data-ttu-id="70e37-124">Если кэширование отключено, все операции чтения и записи напрямую обращаются к физическому диску.</span><span class="sxs-lookup"><span data-stu-id="70e37-124">When caching is disabled, all read and write operations directly access the physical disk.</span></span> <span data-ttu-id="70e37-125">Однако метаданные файла могут по-прежнему кэшироваться.</span><span class="sxs-lookup"><span data-stu-id="70e37-125">However, the file metadata may still be cached.</span></span> <span data-ttu-id="70e37-126">Чтобы записать метаданные на диск, используйте функцию [**FlushFileBuffers**](/windows/desktop/api/FileAPI/nf-fileapi-flushfilebuffers) .</span><span class="sxs-lookup"><span data-stu-id="70e37-126">To flush the metadata to disk, use the [**FlushFileBuffers**](/windows/desktop/api/FileAPI/nf-fileapi-flushfilebuffers) function.</span></span>

<span data-ttu-id="70e37-127">Частота, с которой происходит запись в систему, является важным фактором, позволяющим сбалансировать производительность системы с надежностью системы.</span><span class="sxs-lookup"><span data-stu-id="70e37-127">The frequency at which flushing occurs is an important consideration that balances system performance with system reliability.</span></span> <span data-ttu-id="70e37-128">Если система записывает кэш слишком часто, количество операций записи большого объема может значительно снизить производительность системы.</span><span class="sxs-lookup"><span data-stu-id="70e37-128">If the system flushes the cache too often, the number of large write operations flushing incurs will degrade system performance significantly.</span></span> <span data-ttu-id="70e37-129">Если система не записывается достаточно часто, то вероятность будет выше, когда кэш будет исчерпан из-за превышения объема памяти или внезапного сбоя системы (например, потери питания компьютера) перед очисткой.</span><span class="sxs-lookup"><span data-stu-id="70e37-129">If the system is not flushed often enough, then the likelihood is greater that either system memory will be depleted by the cache, or a sudden system failure (such as a loss of power to the computer) will happen before the flush.</span></span> <span data-ttu-id="70e37-130">В последнем случае кэшированные данные будут потеряны.</span><span class="sxs-lookup"><span data-stu-id="70e37-130">In the latter instance, the cached data will be lost.</span></span>

<span data-ttu-id="70e37-131">Чтобы обеспечить правильное количество операций очистки, диспетчер кэша создает процесс каждую секунду с именем отложенной записи.</span><span class="sxs-lookup"><span data-stu-id="70e37-131">To ensure that the right amount of flushing occurs, the cache manager spawns a process every second called a lazy writer.</span></span> <span data-ttu-id="70e37-132">Процесс отложенной записи помещает в очередь одну восьмую страниц, которые не были недавно записаны для записи на диск.</span><span class="sxs-lookup"><span data-stu-id="70e37-132">The lazy writer process queues one-eighth of the pages that have not been flushed recently to be written to disk.</span></span> <span data-ttu-id="70e37-133">Он постоянно оценивает объем данных, записываемых на диск, для оптимальной производительности системы, а также в том случае, если больше данных необходимо записать в очередь больше данных.</span><span class="sxs-lookup"><span data-stu-id="70e37-133">It constantly reevaluates the amount of data being flushed for optimal system performance, and if more data needs to be written it queues more data.</span></span> <span data-ttu-id="70e37-134">Отложенные модули записи не сбрасывают временные файлы, поскольку предполагается, что они будут удалены приложением или системой.</span><span class="sxs-lookup"><span data-stu-id="70e37-134">Lazy writers do not flush temporary files, because the assumption is that they will be deleted by the application or system.</span></span>

<span data-ttu-id="70e37-135">Некоторые приложения, например антивирусная программа, занимают немедленный сброс операций записи на диск. Windows обеспечивает такую возможность благодаря кэшированию с возможностью записи.</span><span class="sxs-lookup"><span data-stu-id="70e37-135">Some applications, such as virus-checking software, require that their write operations be flushed to disk immediately; Windows provides this ability through write-through caching.</span></span> <span data-ttu-id="70e37-136">Процесс обеспечивает кэширование сквозного чтения для определенной операции ввода-вывода путем передачи **\_ флага файла \_ Write \_ через** флаг в вызов [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea).</span><span class="sxs-lookup"><span data-stu-id="70e37-136">A process enables write-through caching for a specific I/O operation by passing the **FILE\_FLAG\_WRITE\_THROUGH** flag into its call to [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea).</span></span> <span data-ttu-id="70e37-137">При включенном кэшировании с возможностью записи данные по-прежнему записываются в кэш, но диспетчер кэша записывает данные сразу на диск, а не задерживает задержку с помощью модуля отложенной записи.</span><span class="sxs-lookup"><span data-stu-id="70e37-137">With write-through caching enabled, data is still written into the cache, but the cache manager writes the data immediately to disk rather than incurring a delay by using the lazy writer.</span></span> <span data-ttu-id="70e37-138">Процесс также может принудительно выполнить сброс открытого файла, вызвав функцию [**FlushFileBuffers**](/windows/desktop/api/FileAPI/nf-fileapi-flushfilebuffers) .</span><span class="sxs-lookup"><span data-stu-id="70e37-138">A process can also force a flush of a file it has opened by calling the [**FlushFileBuffers**](/windows/desktop/api/FileAPI/nf-fileapi-flushfilebuffers) function.</span></span>

<span data-ttu-id="70e37-139">Метаданные файловой системы всегда кэшируются.</span><span class="sxs-lookup"><span data-stu-id="70e37-139">File system metadata is always cached.</span></span> <span data-ttu-id="70e37-140">Таким образом, для сохранения любых изменений метаданных на диске файл должен быть сброшен или открыт с **\_ флагом файла \_ Write \_** by.</span><span class="sxs-lookup"><span data-stu-id="70e37-140">Therefore, to store any metadata changes to disk, the file must either be flushed or be opened with **FILE\_FLAG\_WRITE\_THROUGH**.</span></span>

 

 



