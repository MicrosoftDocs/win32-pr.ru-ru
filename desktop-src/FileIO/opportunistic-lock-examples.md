---
description: Схемы представлений сетевого трафика для уступающей блокировки уровня 1, оппортунистической блокировки пакетной службы и фильтра оппортунистической блокировки.
ms.assetid: 78830113-b18e-40c7-8ec4-8896dbc58030
title: Примеры оппортунистической блокировки
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ae8b8a0c5b04897ddc2fc8f2e3bdec20f2fdb02d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104545711"
---
# <a name="opportunistic-lock-examples"></a><span data-ttu-id="c7f66-103">Примеры оппортунистической блокировки</span><span class="sxs-lookup"><span data-stu-id="c7f66-103">Opportunistic Lock Examples</span></span>

<span data-ttu-id="c7f66-104">В следующих примерах показано перемещение данных и сообщений SMB при внесении и нарушении уступающей блокировки.</span><span class="sxs-lookup"><span data-stu-id="c7f66-104">The following examples show data and SMB message movements as opportunistic locks are made and broken.</span></span> <span data-ttu-id="c7f66-105">Обратите внимание, что клиенты могут кэшировать данные атрибутов файлов, а также данные файлов.</span><span class="sxs-lookup"><span data-stu-id="c7f66-105">Note that clients can cache file attribute data as well as file data.</span></span>

<span data-ttu-id="c7f66-106">Также обратите внимание, что эти примеры основаны на ситуациях, когда клиентские приложения запрашивают уступающей блокировку с удаленных серверов.</span><span class="sxs-lookup"><span data-stu-id="c7f66-106">Also note that these examples are based on situations where client applications are requesting opportunistic locks from remote servers.</span></span> <span data-ttu-id="c7f66-107">Эти процессы автоматически инициируются сетевым перенаправительм и удаленным сервером — прямое участие в клиентских приложениях или приложениях отсутствует.</span><span class="sxs-lookup"><span data-stu-id="c7f66-107">These processes are automatically initiated by the network redirector and the remote server—there is no direct involvement by the client application or applications.</span></span> <span data-ttu-id="c7f66-108">Процессы, описанные в этих примерах, можно обобщить в ситуации, когда локальные клиентские приложения напрямую запрашивают уступающей блокировку из локальной файловой системы, за исключением того, что обмен данными по сети не выполняется.</span><span class="sxs-lookup"><span data-stu-id="c7f66-108">The processes described by these examples can be generalized into situations where local client applications are directly requesting opportunistic locks from the local file system, with the exception that no exchange of data over the network is involved.</span></span>

## <a name="level-1-opportunistic-lock"></a><span data-ttu-id="c7f66-109">Оппортунистическая блокировка уровня 1</span><span class="sxs-lookup"><span data-stu-id="c7f66-109">Level 1 Opportunistic Lock</span></span>

<span data-ttu-id="c7f66-110">На следующей схеме показано представление сетевого трафика для оппортунистической блокировки уровня 1 на файл.</span><span class="sxs-lookup"><span data-stu-id="c7f66-110">The following diagram shows a network-traffic view of a level 1 opportunistic lock on a file.</span></span> <span data-ttu-id="c7f66-111">Стрелки указывают направление перемещения данных, если таковые имеются.</span><span class="sxs-lookup"><span data-stu-id="c7f66-111">The arrows indicate the direction of data movement, if any.</span></span>



| <span data-ttu-id="c7f66-112">Событие</span><span class="sxs-lookup"><span data-stu-id="c7f66-112">Event</span></span> | <span data-ttu-id="c7f66-113">Клиент X</span><span class="sxs-lookup"><span data-stu-id="c7f66-113">Client X</span></span>                                          | <span data-ttu-id="c7f66-114">Сервер</span><span class="sxs-lookup"><span data-stu-id="c7f66-114">Server</span></span>                                   | <span data-ttu-id="c7f66-115">Клиент Y</span><span class="sxs-lookup"><span data-stu-id="c7f66-115">Client Y</span></span>                                          |
|-------|---------------------------------------------------|------------------------------------------|---------------------------------------------------|
| <span data-ttu-id="c7f66-116">1</span><span class="sxs-lookup"><span data-stu-id="c7f66-116">1</span></span>     | <span data-ttu-id="c7f66-117">Открывает файл, запрашивает блокировку уровня 1 = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-117">Opens file, requests level 1 lock ==></span></span>          |                                          |                                                   |
| <span data-ttu-id="c7f66-118">2</span><span class="sxs-lookup"><span data-stu-id="c7f66-118">2</span></span>     |                                                   | <span data-ttu-id="c7f66-119"><= = предоставление оппортунистической блокировки уровня 1</span><span class="sxs-lookup"><span data-stu-id="c7f66-119"><== Grants level 1 opportunistic lock</span></span> |                                                   |
| <span data-ttu-id="c7f66-120">3</span><span class="sxs-lookup"><span data-stu-id="c7f66-120">3</span></span>     | <span data-ttu-id="c7f66-121">Выполняет операции чтения, записи и других операций = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-121">Performs read, write, and other operations ==></span></span> |                                          |                                                   |
| <span data-ttu-id="c7f66-122">4</span><span class="sxs-lookup"><span data-stu-id="c7f66-122">4</span></span>     |                                                   |                                          | <span data-ttu-id="c7f66-123"><= = запросы на открытие файла</span><span class="sxs-lookup"><span data-stu-id="c7f66-123"><== Requests to open file</span></span>                      |
| <span data-ttu-id="c7f66-124">5</span><span class="sxs-lookup"><span data-stu-id="c7f66-124">5</span></span>     |                                                   | <span data-ttu-id="c7f66-125"><= = разрывает уступающую блокировку</span><span class="sxs-lookup"><span data-stu-id="c7f66-125"><== Breaks opportunistic lock</span></span>         |                                                   |
| <span data-ttu-id="c7f66-126">6</span><span class="sxs-lookup"><span data-stu-id="c7f66-126">6</span></span>     | <span data-ttu-id="c7f66-127">Отменяет данные упреждающего чтения</span><span class="sxs-lookup"><span data-stu-id="c7f66-127">Discards read-ahead data</span></span>                          |                                          |                                                   |
| <span data-ttu-id="c7f66-128">7</span><span class="sxs-lookup"><span data-stu-id="c7f66-128">7</span></span>     | <span data-ttu-id="c7f66-129">Записывает данные = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-129">Writes data ==></span></span>                                |                                          |                                                   |
| <span data-ttu-id="c7f66-130">8</span><span class="sxs-lookup"><span data-stu-id="c7f66-130">8</span></span>     | <span data-ttu-id="c7f66-131">Отправляет сообщение "Close" или "Done" = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-131">Sends "close" or "done" message ==></span></span>            |                                          |                                                   |
| <span data-ttu-id="c7f66-132">9</span><span class="sxs-lookup"><span data-stu-id="c7f66-132">9</span></span>     |                                                   | <span data-ttu-id="c7f66-133">Открытые операции = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-133">Okays open operation ==></span></span>              |                                                   |
| <span data-ttu-id="c7f66-134">10</span><span class="sxs-lookup"><span data-stu-id="c7f66-134">10</span></span>    | <span data-ttu-id="c7f66-135">Выполняет операции чтения, записи и других операций = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-135">Performs read, write, and other operations ==></span></span> |                                          | <span data-ttu-id="c7f66-136"><= = выполняет операции чтения, записи и других операций</span><span class="sxs-lookup"><span data-stu-id="c7f66-136"><== Performs read, write, and other operations</span></span> |



 

<span data-ttu-id="c7f66-137">В событии 1 клиент X открывает файл и в ходе операции открытия запрашивает оппортунистической блокировки уровня 1 для файла.</span><span class="sxs-lookup"><span data-stu-id="c7f66-137">In event 1, client X opens a file and as part of the open operation requests a level 1 opportunistic lock on the file.</span></span> <span data-ttu-id="c7f66-138">В событии 2 сервер предоставляет блокировку уровня 1, так как никакой другой клиент не открывает файл.</span><span class="sxs-lookup"><span data-stu-id="c7f66-138">In event 2, the server grants the level 1 lock because no other client has the file open.</span></span> <span data-ttu-id="c7f66-139">Клиент переходит к файлу обычным способом в событии 3.</span><span class="sxs-lookup"><span data-stu-id="c7f66-139">The client proceeds to access the file in the usual manner in event 3.</span></span>

<span data-ttu-id="c7f66-140">В событии 4 Клиент Y пытается открыть файл и запрашивает уступающую блокировку.</span><span class="sxs-lookup"><span data-stu-id="c7f66-140">In event 4, client Y attempts to open the file and requests an opportunistic lock.</span></span> <span data-ttu-id="c7f66-141">Сервер видит, что этот файл открыт на клиенте X.</span><span class="sxs-lookup"><span data-stu-id="c7f66-141">The server sees that client X has the file open.</span></span> <span data-ttu-id="c7f66-142">Сервер игнорирует запрос Y, в то время как клиент X очищает все данные записи и отменяет его кэш чтения для файла.</span><span class="sxs-lookup"><span data-stu-id="c7f66-142">The server ignores Y's request while client X flushes any write data and abandons its read cache for the file.</span></span>

<span data-ttu-id="c7f66-143">Сервер принудительно очищает X, отправляя в X сообщение SMB, разбивая оппортунистическая блокировку, событие 5.</span><span class="sxs-lookup"><span data-stu-id="c7f66-143">The server forces X to clean up by sending to X an SMB message breaking the opportunistic lock, event 5.</span></span> <span data-ttu-id="c7f66-144">Клиент X "без уведомления" отменяет все данные, которые были прочитаны. Иными словами, этот процесс не создает сетевого трафика.</span><span class="sxs-lookup"><span data-stu-id="c7f66-144">Client X "silently" discards any read-ahead data; in other words, this process generates no network traffic.</span></span> <span data-ttu-id="c7f66-145">В событии 7 клиент X записывает все кэшированные данные записи на сервер.</span><span class="sxs-lookup"><span data-stu-id="c7f66-145">In event 7, client X writes any cached write data to the server.</span></span> <span data-ttu-id="c7f66-146">Когда клиент X выполняет запись кэшированных данных на сервер, клиент X отправляет на сервер сообщение «Close» или «done», событие 8.</span><span class="sxs-lookup"><span data-stu-id="c7f66-146">When client X is done writing cached data to the server, client X sends either a "close" or a "done" message to the server, event 8.</span></span>

<span data-ttu-id="c7f66-147">После того как сервер получил уведомления о том, что клиент X запустил свой кэш записи на сервере или закрыл файл, сервер может открыть файл для клиента Y в событии 9.</span><span class="sxs-lookup"><span data-stu-id="c7f66-147">After the server has been notified that client X is done flushing its write cache to the server or has closed the file, then the server can open the file for client Y, in event 9.</span></span> <span data-ttu-id="c7f66-148">Поскольку сервер теперь имеет два клиента с одним и тем же файлом, он предоставляет оппортунистическая блокировку ни для одного из них.</span><span class="sxs-lookup"><span data-stu-id="c7f66-148">Because the server now has two clients with the same file open, it grants an opportunistic lock to neither.</span></span> <span data-ttu-id="c7f66-149">Оба клиента продолжают считывать данные из файла и один или ни одной записи в файл.</span><span class="sxs-lookup"><span data-stu-id="c7f66-149">Both clients proceed to read from the file, and one or neither writes to the file.</span></span>

## <a name="batch-opportunistic-lock"></a><span data-ttu-id="c7f66-150">Оппортунистическая блокировка пакетной службы</span><span class="sxs-lookup"><span data-stu-id="c7f66-150">Batch Opportunistic Lock</span></span>

<span data-ttu-id="c7f66-151">На следующей схеме показано представление сетевого трафика оппортунистической блокировки пакетной службы.</span><span class="sxs-lookup"><span data-stu-id="c7f66-151">The following diagram shows a network-traffic view of a batch opportunistic lock.</span></span> <span data-ttu-id="c7f66-152">Стрелки указывают направление перемещения данных, если таковые имеются.</span><span class="sxs-lookup"><span data-stu-id="c7f66-152">The arrows indicate the direction of data movement, if any.</span></span>



| <span data-ttu-id="c7f66-153">Событие</span><span class="sxs-lookup"><span data-stu-id="c7f66-153">Event</span></span> | <span data-ttu-id="c7f66-154">Клиент X</span><span class="sxs-lookup"><span data-stu-id="c7f66-154">Client X</span></span>                               | <span data-ttu-id="c7f66-155">Сервер</span><span class="sxs-lookup"><span data-stu-id="c7f66-155">Server</span></span>                                 | <span data-ttu-id="c7f66-156">Клиент Y</span><span class="sxs-lookup"><span data-stu-id="c7f66-156">Client Y</span></span>                                          |
|-------|----------------------------------------|----------------------------------------|---------------------------------------------------|
| <span data-ttu-id="c7f66-157">1</span><span class="sxs-lookup"><span data-stu-id="c7f66-157">1</span></span>     | <span data-ttu-id="c7f66-158">Открывает файл, запрашивает блокировку пакета = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-158">Opens file, requests batch lock ==></span></span> |                                        |                                                   |
| <span data-ttu-id="c7f66-159">2</span><span class="sxs-lookup"><span data-stu-id="c7f66-159">2</span></span>     |                                        | <span data-ttu-id="c7f66-160"><= = предоставляет уступающую пакетную блокировку</span><span class="sxs-lookup"><span data-stu-id="c7f66-160"><== Grants batch opportunistic lock</span></span> |                                                   |
| <span data-ttu-id="c7f66-161">3</span><span class="sxs-lookup"><span data-stu-id="c7f66-161">3</span></span>     | <span data-ttu-id="c7f66-162">Чтение файла = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-162">Reads file ==></span></span>                      |                                        |                                                   |
| <span data-ttu-id="c7f66-163">4</span><span class="sxs-lookup"><span data-stu-id="c7f66-163">4</span></span>     |                                        | <span data-ttu-id="c7f66-164"><= = отправка данных</span><span class="sxs-lookup"><span data-stu-id="c7f66-164"><== Sends data</span></span>                      |                                                   |
| <span data-ttu-id="c7f66-165">5</span><span class="sxs-lookup"><span data-stu-id="c7f66-165">5</span></span>     | <span data-ttu-id="c7f66-166">Закрывает файл</span><span class="sxs-lookup"><span data-stu-id="c7f66-166">Closes file</span></span>                            |                                        |                                                   |
| <span data-ttu-id="c7f66-167">6</span><span class="sxs-lookup"><span data-stu-id="c7f66-167">6</span></span>     | <span data-ttu-id="c7f66-168">Открытие файла</span><span class="sxs-lookup"><span data-stu-id="c7f66-168">Opens file</span></span>                             |                                        |                                                   |
| <span data-ttu-id="c7f66-169">7</span><span class="sxs-lookup"><span data-stu-id="c7f66-169">7</span></span>     | <span data-ttu-id="c7f66-170">Выполняет поиск данных</span><span class="sxs-lookup"><span data-stu-id="c7f66-170">Searches for data</span></span>                      |                                        |                                                   |
| <span data-ttu-id="c7f66-171">8</span><span class="sxs-lookup"><span data-stu-id="c7f66-171">8</span></span>     | <span data-ttu-id="c7f66-172">Считывает данные = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-172">Reads data ==></span></span>                      |                                        |                                                   |
| <span data-ttu-id="c7f66-173">9</span><span class="sxs-lookup"><span data-stu-id="c7f66-173">9</span></span>     |                                        | <span data-ttu-id="c7f66-174"><= = отправка данных</span><span class="sxs-lookup"><span data-stu-id="c7f66-174"><== Sends data</span></span>                      |                                                   |
| <span data-ttu-id="c7f66-175">10</span><span class="sxs-lookup"><span data-stu-id="c7f66-175">10</span></span>    | <span data-ttu-id="c7f66-176">Закрывает файл</span><span class="sxs-lookup"><span data-stu-id="c7f66-176">Closes file</span></span>                            |                                        |                                                   |
| <span data-ttu-id="c7f66-177">11</span><span class="sxs-lookup"><span data-stu-id="c7f66-177">11</span></span>    |                                        |                                        | <span data-ttu-id="c7f66-178"><= = открывает файл</span><span class="sxs-lookup"><span data-stu-id="c7f66-178"><== Opens file</span></span>                                 |
| <span data-ttu-id="c7f66-179">12</span><span class="sxs-lookup"><span data-stu-id="c7f66-179">12</span></span>    |                                        | <span data-ttu-id="c7f66-180"><= = разрывает уступающую блокировку</span><span class="sxs-lookup"><span data-stu-id="c7f66-180"><== Breaks opportunistic lock</span></span>       |                                                   |
| <span data-ttu-id="c7f66-181">13</span><span class="sxs-lookup"><span data-stu-id="c7f66-181">13</span></span>    | <span data-ttu-id="c7f66-182">Закрывает файл = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-182">Closes file ==></span></span>                     |                                        |                                                   |
| <span data-ttu-id="c7f66-183">14</span><span class="sxs-lookup"><span data-stu-id="c7f66-183">14</span></span>    |                                        | <span data-ttu-id="c7f66-184">Открытые операции = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-184">Okays open operation ==></span></span>            |                                                   |
| <span data-ttu-id="c7f66-185">15</span><span class="sxs-lookup"><span data-stu-id="c7f66-185">15</span></span>    |                                        |                                        | <span data-ttu-id="c7f66-186"><= = выполняет операции чтения, записи и других операций</span><span class="sxs-lookup"><span data-stu-id="c7f66-186"><== Performs read, write, and other operations</span></span> |



 

<span data-ttu-id="c7f66-187">В оппортунистической блокировке пакетной службы клиент X открывает файл, событие 1, а сервер предоставляет пакетную блокировку Client X в событии 2.</span><span class="sxs-lookup"><span data-stu-id="c7f66-187">In the batch opportunistic lock, client X opens a file, event 1, and the server grants client X a batch lock in event 2.</span></span> <span data-ttu-id="c7f66-188">Клиент X пытается считать данные, событие 3, на которое сервер отвечает на данные, событие 4.</span><span class="sxs-lookup"><span data-stu-id="c7f66-188">Client X attempts to read data, event 3, to which the server responds with data, event 4.</span></span>

<span data-ttu-id="c7f66-189">В событии 5 показана оппортунистическая блокировка пакета на работе.</span><span class="sxs-lookup"><span data-stu-id="c7f66-189">Event 5 shows the batch opportunistic lock at work.</span></span> <span data-ttu-id="c7f66-190">Приложение на клиенте X закрывает файл.</span><span class="sxs-lookup"><span data-stu-id="c7f66-190">The application on Client X closes the file.</span></span> <span data-ttu-id="c7f66-191">Однако перенаправитель сети отфильтровывает операцию закрытия и не передает сообщение закрытия, тем самым выполняя «Silent» закрытие.</span><span class="sxs-lookup"><span data-stu-id="c7f66-191">However, the network redirector filters out the close operation and does not transmit a close message, thus performing a "silent" close.</span></span> <span data-ttu-id="c7f66-192">Это может сделать сетевой перенаправитель, так как клиент X имеет единственного владельца файла.</span><span class="sxs-lookup"><span data-stu-id="c7f66-192">The network redirector can do this because client X has sole ownership of the file.</span></span> <span data-ttu-id="c7f66-193">Позже, в событии 6, приложение повторно откроет файл.</span><span class="sxs-lookup"><span data-stu-id="c7f66-193">Later on, in event 6, the application reopens the file.</span></span> <span data-ttu-id="c7f66-194">Опять же, потоки данных в сети отсутствуют.</span><span class="sxs-lookup"><span data-stu-id="c7f66-194">Again, no data flows across the network.</span></span> <span data-ttu-id="c7f66-195">С точки зрения сервера этот клиент открыл файл с момента создания события 2.</span><span class="sxs-lookup"><span data-stu-id="c7f66-195">As far as the server is concerned, this client has had the file open since event 2.</span></span>

<span data-ttu-id="c7f66-196">События 7, 8 и 9 показывают обычное направление сетевого трафика.</span><span class="sxs-lookup"><span data-stu-id="c7f66-196">Events 7, 8, and 9 show the usual course of network traffic.</span></span> <span data-ttu-id="c7f66-197">В событии 10 происходит еще одно автоматическое закрытие.</span><span class="sxs-lookup"><span data-stu-id="c7f66-197">In event 10, another silent close occurs.</span></span>

<span data-ttu-id="c7f66-198">В событии 11 клиент Y пытается открыть файл.</span><span class="sxs-lookup"><span data-stu-id="c7f66-198">In event 11, client Y attempts to open the file.</span></span> <span data-ttu-id="c7f66-199">Сервер имеет представление о том, что клиент X открыт, несмотря на то, что приложение на клиенте X его закрыло.</span><span class="sxs-lookup"><span data-stu-id="c7f66-199">The server's view of the file is that client X has it open, even though the application on client X has closed it.</span></span> <span data-ttu-id="c7f66-200">Таким образом, сервер отправляет сообщение, разбивая оппортунистической блокировки на клиент X. Клиент X теперь отправляет сообщение о закрытии по сети, событие 13.</span><span class="sxs-lookup"><span data-stu-id="c7f66-200">Therefore, the server sends an a message breaking the opportunistic lock to client X. Client X now sends the close message across the network, event 13.</span></span> <span data-ttu-id="c7f66-201">Событие 14 следует за тем, как сервер открывает файл для клиента Y. Приложение на клиенте X закрыло файл, поэтому он больше не передает на сервер или с сервера для этого файла.</span><span class="sxs-lookup"><span data-stu-id="c7f66-201">Event 14 follows as the server opens the file for client Y. The application on client X has closed the file, so it does no more transfers to or from the server for that file.</span></span> <span data-ttu-id="c7f66-202">Клиент Y начинает передачу данных обычным образом в событии 15.</span><span class="sxs-lookup"><span data-stu-id="c7f66-202">Client Y begins data transfers as usual in event 15.</span></span>

<span data-ttu-id="c7f66-203">Между временем, когда клиент X получает блокировку файла в событии 2 и Последнее закрытие в событии 13, все данные файлов, кэшированные клиентом, являются допустимыми, несмотря на операции открытия и закрытия приложения.</span><span class="sxs-lookup"><span data-stu-id="c7f66-203">Between the time client X is granted the lock on the file in event 2 and the final close at event 13, any file data that the client has cached is valid, in spite of the intervening application open and close operations.</span></span> <span data-ttu-id="c7f66-204">Однако после разрыва оппортунистической блокировки кэшированные данные не могут считаться допустимыми.</span><span class="sxs-lookup"><span data-stu-id="c7f66-204">However, after the opportunistic lock is broken, cached data cannot be considered valid.</span></span>

## <a name="filter-opportunistic-lock"></a><span data-ttu-id="c7f66-205">Фильтрация уступающей блокировки</span><span class="sxs-lookup"><span data-stu-id="c7f66-205">Filter Opportunistic Lock</span></span>

<span data-ttu-id="c7f66-206">На следующей схеме показано представление сетевого трафика для фильтра оппортунистической блокировки.</span><span class="sxs-lookup"><span data-stu-id="c7f66-206">The following diagram shows a network-traffic view of a filter opportunistic lock.</span></span> <span data-ttu-id="c7f66-207">Стрелки указывают направление перемещения данных, если таковые имеются.</span><span class="sxs-lookup"><span data-stu-id="c7f66-207">The arrows indicate the direction of data movement, if any.</span></span>



| <span data-ttu-id="c7f66-208">Событие</span><span class="sxs-lookup"><span data-stu-id="c7f66-208">Event</span></span> | <span data-ttu-id="c7f66-209">Клиент X</span><span class="sxs-lookup"><span data-stu-id="c7f66-209">Client X</span></span>                                | <span data-ttu-id="c7f66-210">Сервер</span><span class="sxs-lookup"><span data-stu-id="c7f66-210">Server</span></span>                   | <span data-ttu-id="c7f66-211">Клиент Y</span><span class="sxs-lookup"><span data-stu-id="c7f66-211">Client Y</span></span>                    |
|-------|-----------------------------------------|--------------------------|-----------------------------|
| <span data-ttu-id="c7f66-212">1</span><span class="sxs-lookup"><span data-stu-id="c7f66-212">1</span></span>     | <span data-ttu-id="c7f66-213">Открывает файл без прав доступа = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-213">Opens file with no access rights ==></span></span> |                          |                             |
| <span data-ttu-id="c7f66-214">2</span><span class="sxs-lookup"><span data-stu-id="c7f66-214">2</span></span>     |                                         | <span data-ttu-id="c7f66-215"><= = открывает файл</span><span class="sxs-lookup"><span data-stu-id="c7f66-215"><== Opens the file</span></span>    |                             |
| <span data-ttu-id="c7f66-216">3</span><span class="sxs-lookup"><span data-stu-id="c7f66-216">3</span></span>     | <span data-ttu-id="c7f66-217">Запросов блокировки фильтра = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-217">Requests filter lock==></span></span>              |                          |                             |
| <span data-ttu-id="c7f66-218">4</span><span class="sxs-lookup"><span data-stu-id="c7f66-218">4</span></span>     |                                         | <span data-ttu-id="c7f66-219"><= = предоставление блокировки</span><span class="sxs-lookup"><span data-stu-id="c7f66-219"><== Grants lock</span></span>       |                             |
| <span data-ttu-id="c7f66-220">5</span><span class="sxs-lookup"><span data-stu-id="c7f66-220">5</span></span>     | <span data-ttu-id="c7f66-221">Открывает файл для чтения = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-221">Opens file for reading ==></span></span>           |                          |                             |
| <span data-ttu-id="c7f66-222">6</span><span class="sxs-lookup"><span data-stu-id="c7f66-222">6</span></span>     |                                         | <span data-ttu-id="c7f66-223"><= = повторно открывает файл</span><span class="sxs-lookup"><span data-stu-id="c7f66-223"><== Reopens the file</span></span>  |                             |
| <span data-ttu-id="c7f66-224">7</span><span class="sxs-lookup"><span data-stu-id="c7f66-224">7</span></span>     | <span data-ttu-id="c7f66-225">Считывает данные с помощью маркера чтения = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-225">Reads data using the read handle ==></span></span> |                          |                             |
| <span data-ttu-id="c7f66-226">8</span><span class="sxs-lookup"><span data-stu-id="c7f66-226">8</span></span>     |                                         | <span data-ttu-id="c7f66-227"><= = отправка данных</span><span class="sxs-lookup"><span data-stu-id="c7f66-227"><== Sends data</span></span>        |                             |
| <span data-ttu-id="c7f66-228">9</span><span class="sxs-lookup"><span data-stu-id="c7f66-228">9</span></span>     |                                         | <span data-ttu-id="c7f66-229"><= = отправка данных</span><span class="sxs-lookup"><span data-stu-id="c7f66-229"><== Sends data</span></span>        |                             |
| <span data-ttu-id="c7f66-230">10</span><span class="sxs-lookup"><span data-stu-id="c7f66-230">10</span></span>    |                                         | <span data-ttu-id="c7f66-231"><= = отправка данных</span><span class="sxs-lookup"><span data-stu-id="c7f66-231"><== Sends data</span></span>        |                             |
| <span data-ttu-id="c7f66-232">11</span><span class="sxs-lookup"><span data-stu-id="c7f66-232">11</span></span>    |                                         |                          | <span data-ttu-id="c7f66-233"><= = открывает файл</span><span class="sxs-lookup"><span data-stu-id="c7f66-233"><== Opens the file</span></span>       |
| <span data-ttu-id="c7f66-234">12</span><span class="sxs-lookup"><span data-stu-id="c7f66-234">12</span></span>    |                                         | <span data-ttu-id="c7f66-235">Открывает файл = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-235">Opens the file ==></span></span>    |                             |
| <span data-ttu-id="c7f66-236">13</span><span class="sxs-lookup"><span data-stu-id="c7f66-236">13</span></span>    |                                         |                          | <span data-ttu-id="c7f66-237"><= = блокировка фильтра запросов</span><span class="sxs-lookup"><span data-stu-id="c7f66-237"><== Requests filter lock</span></span> |
| <span data-ttu-id="c7f66-238">14</span><span class="sxs-lookup"><span data-stu-id="c7f66-238">14</span></span>    |                                         | <span data-ttu-id="c7f66-239">Запрещает блокировку фильтра = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-239">Denies filter lock==></span></span> |                             |
| <span data-ttu-id="c7f66-240">15</span><span class="sxs-lookup"><span data-stu-id="c7f66-240">15</span></span>    |                                         |                          | <span data-ttu-id="c7f66-241"><= = чтение данных</span><span class="sxs-lookup"><span data-stu-id="c7f66-241"><== Reads data</span></span>           |
| <span data-ttu-id="c7f66-242">16</span><span class="sxs-lookup"><span data-stu-id="c7f66-242">16</span></span>    |                                         | <span data-ttu-id="c7f66-243">Отправляет данные = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-243">Sends data ==></span></span>        |                             |
| <span data-ttu-id="c7f66-244">17</span><span class="sxs-lookup"><span data-stu-id="c7f66-244">17</span></span>    | <span data-ttu-id="c7f66-245">Чтение (кэшированных) данных</span><span class="sxs-lookup"><span data-stu-id="c7f66-245">Reads (cached) data</span></span>                     |                          |                             |
| <span data-ttu-id="c7f66-246">18</span><span class="sxs-lookup"><span data-stu-id="c7f66-246">18</span></span>    | <span data-ttu-id="c7f66-247">Закрывает файл = =></span><span class="sxs-lookup"><span data-stu-id="c7f66-247">Closes file ==></span></span>                      |                          |                             |
| <span data-ttu-id="c7f66-248">19</span><span class="sxs-lookup"><span data-stu-id="c7f66-248">19</span></span>    |                                         |                          | <span data-ttu-id="c7f66-249"><= = закрывает файл</span><span class="sxs-lookup"><span data-stu-id="c7f66-249"><== Closes file</span></span>          |



 

<span data-ttu-id="c7f66-250">В случае оппортунистической блокировки «фильтр» клиент X открывает файл, событие 1, а сервер отвечает на событие 2.</span><span class="sxs-lookup"><span data-stu-id="c7f66-250">In the filter opportunistic lock, client X opens a file, event 1, and the server responds in event 2.</span></span> <span data-ttu-id="c7f66-251">Затем клиент запрашивает фильтр оппортунистической блокировки в событии 3, за которым следует сервер, предоставляющий уступающую блокировку в событии 4.</span><span class="sxs-lookup"><span data-stu-id="c7f66-251">The client then requests a filter opportunistic lock in event 3, followed by the server granting the opportunistic lock in event 4.</span></span> <span data-ttu-id="c7f66-252">Затем клиент X снова открывает файл для чтения в событии 5, в которое сервер отвечает на событие 6.</span><span class="sxs-lookup"><span data-stu-id="c7f66-252">Client X then opens the file again for reading in event 5, to which the server responds in event 6.</span></span> <span data-ttu-id="c7f66-253">Затем клиент пытается считать данные, на которые сервер отвечает на данные, событие 8.</span><span class="sxs-lookup"><span data-stu-id="c7f66-253">The client then attempts to read data, to which the server responds with data, event 8.</span></span>

<span data-ttu-id="c7f66-254">В событии 9 показан фильтр "оппортунистическая блокировка" на работе.</span><span class="sxs-lookup"><span data-stu-id="c7f66-254">Event 9 shows the filter opportunistic lock at work.</span></span> <span data-ttu-id="c7f66-255">Сервер считывает данные перед клиентом и отправляет их по сети, даже если клиент не запрашивал его.</span><span class="sxs-lookup"><span data-stu-id="c7f66-255">The server reads ahead of the client and sends the data over the network even though the client has not requested it.</span></span> <span data-ttu-id="c7f66-256">Клиент кэширует данные.</span><span class="sxs-lookup"><span data-stu-id="c7f66-256">The client caches the data.</span></span> <span data-ttu-id="c7f66-257">В событии 10 сервер также ожидает будущий запрос данных и отправляет клиенту другую часть файла для кэширования.</span><span class="sxs-lookup"><span data-stu-id="c7f66-257">In event 10, the server also anticipates a future request for data and sends another portion of the file for the client to cache.</span></span>

<span data-ttu-id="c7f66-258">В событии 11 и 12 другой клиент, Y, открывает файл.</span><span class="sxs-lookup"><span data-stu-id="c7f66-258">In event 11 and 12, another client, Y, opens the file.</span></span> <span data-ttu-id="c7f66-259">Клиент Y также запрашивает уступающую блокировку фильтра.</span><span class="sxs-lookup"><span data-stu-id="c7f66-259">Client Y also requests a filter opportunistic lock.</span></span> <span data-ttu-id="c7f66-260">В событии 14 сервер отклоняет его.</span><span class="sxs-lookup"><span data-stu-id="c7f66-260">In event 14, the server denies it.</span></span> <span data-ttu-id="c7f66-261">В событии 15 клиент Y запрашивает данные, которые сервер отправляет в событии 16.</span><span class="sxs-lookup"><span data-stu-id="c7f66-261">In event 15, client Y requests data, which the server sends in event 16.</span></span> <span data-ttu-id="c7f66-262">Ни один из этих элементов не влияет на клиент X. В любой момент времени другой клиент может открыть этот файл для доступа на чтение.</span><span class="sxs-lookup"><span data-stu-id="c7f66-262">None of this affects client X. At any time, another client can open this file for read access.</span></span> <span data-ttu-id="c7f66-263">Никакой другой клиент не влияет на блокировку фильтра клиента X.</span><span class="sxs-lookup"><span data-stu-id="c7f66-263">No other client affects client X's filter lock.</span></span>

<span data-ttu-id="c7f66-264">В событии 17 показана пересчитанные данные клиентом X.</span><span class="sxs-lookup"><span data-stu-id="c7f66-264">Event 17 shows client X reading data.</span></span> <span data-ttu-id="c7f66-265">Однако, поскольку сервер уже отправил данные и кэширует его, трафик не пересекает сеть.</span><span class="sxs-lookup"><span data-stu-id="c7f66-265">However, because the server has already sent the data and the client has cached it, no traffic crosses the network.</span></span>

<span data-ttu-id="c7f66-266">В этом примере клиент X никогда не пытается прочитать все данные в файле, поэтому упреждающее чтение, обозначенное событиями 9 и 10, считается незанятым. то есть данные никогда не используются.</span><span class="sxs-lookup"><span data-stu-id="c7f66-266">In this example, client X never tries to read all the data in the file, so the read-ahead indicated by events 9 and 10 is "wasted"; that is, the data is never actually used.</span></span> <span data-ttu-id="c7f66-267">Это приемлемая утрата, так как упреждающее чтение ускоряют приложение.</span><span class="sxs-lookup"><span data-stu-id="c7f66-267">This is an acceptable loss because the read-ahead has sped up the application.</span></span>

<span data-ttu-id="c7f66-268">В событии 18 клиент X закрывает файл.</span><span class="sxs-lookup"><span data-stu-id="c7f66-268">In event 18, client X closes the file.</span></span> <span data-ttu-id="c7f66-269">Перенаправитель сети клиента отменяет кэшированные данные.</span><span class="sxs-lookup"><span data-stu-id="c7f66-269">The client's network redirector abandons the cached data.</span></span> <span data-ttu-id="c7f66-270">Сервер закрывает файл.</span><span class="sxs-lookup"><span data-stu-id="c7f66-270">The server closes the file.</span></span>

 

 



