---
description: Оппортунистическая блокировка (также называемая жесткой блокировкой) — это блокировка, размещенная клиентом в файле, размещенном на сервере.
ms.assetid: b4c2f5f0-a29b-4598-a49b-da99e93d2991
title: Оппортунистической блокировки
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: faec833caae05bff247a7a3655885b1a967f3435
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103810450"
---
# <a name="opportunistic-locks"></a><span data-ttu-id="4d83c-103">Оппортунистической блокировки</span><span class="sxs-lookup"><span data-stu-id="4d83c-103">Opportunistic Locks</span></span>

<span data-ttu-id="4d83c-104">Оппортунистическая блокировка (также называемая жесткой блокировкой) — это блокировка, размещенная клиентом в файле, размещенном на сервере.</span><span class="sxs-lookup"><span data-stu-id="4d83c-104">An opportunistic lock (also called an oplock) is a lock placed by a client on a file residing on a server.</span></span> <span data-ttu-id="4d83c-105">В большинстве случаев клиент запрашивает уступающую блокировку, чтобы она могла локально кэшировать данные, таким образом уменьшая сетевой трафик и повышая очевидное время ответа.</span><span class="sxs-lookup"><span data-stu-id="4d83c-105">In most cases, a client requests an opportunistic lock so it can cache data locally, thus reducing network traffic and improving apparent response time.</span></span> <span data-ttu-id="4d83c-106">Для сетевых перенаправок используются сетевые перенаправителя на клиентах с удаленными серверами, а также клиентскими приложениями на локальных серверах.</span><span class="sxs-lookup"><span data-stu-id="4d83c-106">Opportunistic locks are used by network redirectors on clients with remote servers, as well as by client applications on local servers.</span></span>

<span data-ttu-id="4d83c-107">Оппортунистическая блокировка координирует кэширование и согласованность данных между клиентами и серверами и несколькими клиентами.</span><span class="sxs-lookup"><span data-stu-id="4d83c-107">Opportunistic locks coordinate data caching and coherency between clients and servers and among multiple clients.</span></span> <span data-ttu-id="4d83c-108">Согласованные данные — это данные, которые являются одинаковыми по сети.</span><span class="sxs-lookup"><span data-stu-id="4d83c-108">Data that is coherent is data that is the same across the network.</span></span> <span data-ttu-id="4d83c-109">Иными словами, если данные согласованы, данные на сервере и все клиенты синхронизируются.</span><span class="sxs-lookup"><span data-stu-id="4d83c-109">In other words, if data is coherent, data on the server and all the clients is synchronized.</span></span>

<span data-ttu-id="4d83c-110">Оппортунистическая блокировки не являются командами клиента на сервере.</span><span class="sxs-lookup"><span data-stu-id="4d83c-110">Opportunistic locks are not commands by the client to the server.</span></span> <span data-ttu-id="4d83c-111">Они являются запросами от клиента к серверу.</span><span class="sxs-lookup"><span data-stu-id="4d83c-111">They are requests from the client to the server.</span></span> <span data-ttu-id="4d83c-112">С точки зрения клиента они являются уступающей.</span><span class="sxs-lookup"><span data-stu-id="4d83c-112">From the point of view of the client, they are opportunistic.</span></span> <span data-ttu-id="4d83c-113">Другими словами, сервер предоставляет такие блокировки всякий раз, когда другие факторы делают блокировки возможными.</span><span class="sxs-lookup"><span data-stu-id="4d83c-113">In other words, the server grants such locks whenever other factors make the locks possible.</span></span>

<span data-ttu-id="4d83c-114">Когда локальное приложение запрашивает доступ к удаленному файлу, реализация уступающей блокировки прозрачна для приложения.</span><span class="sxs-lookup"><span data-stu-id="4d83c-114">When a local application requests access to a remote file, the implementation of opportunistic locks is transparent to the application.</span></span> <span data-ttu-id="4d83c-115">Сетевой перенаправитель и сервер, участвующие в открытии, открывают и автоматически закрывают оппортунистической блокировки.</span><span class="sxs-lookup"><span data-stu-id="4d83c-115">The network redirector and the server involved open and close the opportunistic locks automatically.</span></span> <span data-ttu-id="4d83c-116">Однако оппортунистическая блокировки также можно использовать, когда локальное приложение запрашивает доступ к локальному файлу, а доступ других приложений и процессов должен быть делегирован для предотвращения повреждения файла.</span><span class="sxs-lookup"><span data-stu-id="4d83c-116">However, opportunistic locks can also be used when a local application requests access to a local file, and access by other applications and processes must be delegated to prevent corruption of the file.</span></span> <span data-ttu-id="4d83c-117">В этом случае локальное приложение напрямую запрашивает уступающую блокировку из локальной файловой системы и кэширует файл локально.</span><span class="sxs-lookup"><span data-stu-id="4d83c-117">In this case, the local application directly requests an opportunistic lock from the local file system and caches the file locally.</span></span> <span data-ttu-id="4d83c-118">При таком использовании оппортунистическая блокировка фактически является семафором, управляемым локальным сервером, и в основном используется в целях согласования данных в уведомлениях о доступе к файлам и файлам.</span><span class="sxs-lookup"><span data-stu-id="4d83c-118">When used in this way, the opportunistic lock is effectively a semaphore managed by the local server, and is mainly used for the purposes of data coherency in the file and file access notification.</span></span>

<span data-ttu-id="4d83c-119">Перед использованием уступающей блокировки в приложении необходимо ознакомиться с режимами доступа к файлам и совместного использования, описанными в разделе [Создание и открытие файлов](creating-and-opening-files.md).</span><span class="sxs-lookup"><span data-stu-id="4d83c-119">Before using opportunistic locks in your application, you should be familiar with the file access and sharing modes described in [Creating and Opening Files](creating-and-opening-files.md).</span></span>

<span data-ttu-id="4d83c-120">Максимальное количество одновременно создаваемых гибких блокировок ограничено только объемом доступной памяти.</span><span class="sxs-lookup"><span data-stu-id="4d83c-120">The maximum number of concurrent opportunistic locks that you can create is limited only by the amount of available memory.</span></span>

<span data-ttu-id="4d83c-121">Локальные приложения не должны пытаться запрашивать оппортунистической блокировки с удаленных серверов.</span><span class="sxs-lookup"><span data-stu-id="4d83c-121">Local applications should not attempt to request opportunistic locks from remote servers.</span></span> <span data-ttu-id="4d83c-122">Если была предпринята попытка выполнить эту операцию, будет возвращена ошибка [**DeviceIoControl**](/windows/desktop/api/ioapiset/nf-ioapiset-deviceiocontrol) .</span><span class="sxs-lookup"><span data-stu-id="4d83c-122">An error will be returned by [**DeviceIoControl**](/windows/desktop/api/ioapiset/nf-ioapiset-deviceiocontrol) if an attempt is made to do this.</span></span>

<span data-ttu-id="4d83c-123">Оппортунистическая блокировки — это очень ограниченное использование для приложений.</span><span class="sxs-lookup"><span data-stu-id="4d83c-123">Opportunistic locks are of very limited use for applications.</span></span> <span data-ttu-id="4d83c-124">Единственная практическая работа — Проверка сетевого перенаправителя или оппортунистической блокировки сервера.</span><span class="sxs-lookup"><span data-stu-id="4d83c-124">The only practical use is to test a network redirector or a server opportunistic lock handler.</span></span> <span data-ttu-id="4d83c-125">Как правило, файловые системы реализуют поддержку уступающей блокировки.</span><span class="sxs-lookup"><span data-stu-id="4d83c-125">Typically, file systems implement support for opportunistic locks.</span></span> <span data-ttu-id="4d83c-126">Как правило, приложения применяют уступающую управление блокировками к драйверам файловой системы.</span><span class="sxs-lookup"><span data-stu-id="4d83c-126">Applications generally leave opportunistic lock management to the file system drivers.</span></span> <span data-ttu-id="4d83c-127">Любой пользователь, реализующий файловую систему, должен использовать [набор устанавливаемых файловых систем (IFS)](https://www.microsoft.com/whdc/devtools/ifskit/default.mspx).</span><span class="sxs-lookup"><span data-stu-id="4d83c-127">Anyone implementing a file system should use the [Installable File System (IFS) Kit](https://www.microsoft.com/whdc/devtools/ifskit/default.mspx).</span></span> <span data-ttu-id="4d83c-128">Любой пользователь, разрабатывающих драйвер устройства, отличный от устанавливаемой файловой системы, должен использовать [набор драйверов для Windows (WDK)](https://www.microsoft.com/?ref=go).</span><span class="sxs-lookup"><span data-stu-id="4d83c-128">Anyone developing a device driver other than an installable file system should use the [Windows Driver Kit (WDK)](https://www.microsoft.com/?ref=go).</span></span>

<span data-ttu-id="4d83c-129">Уступающей блокировки и связанные с ними операции являются надмножеством части оппортунистической блокировки протокола Интернета (CIFS), Интернет-черновика.</span><span class="sxs-lookup"><span data-stu-id="4d83c-129">Opportunistic locks and the associated operations are a superset of the opportunistic lock portion of the Common Internet File System (CIFS) protocol, an Internet Draft.</span></span> <span data-ttu-id="4d83c-130">Протокол CIFS — это улучшенная версия протокола SMB.</span><span class="sxs-lookup"><span data-stu-id="4d83c-130">The CIFS protocol is an enhanced version of the Server Message Block (SMB) protocol.</span></span> <span data-ttu-id="4d83c-131">Дополнительные сведения см. в [статье Обзор протокола SMB и протокола CIFS](microsoft-smb-protocol-and-cifs-protocol-overview.md).</span><span class="sxs-lookup"><span data-stu-id="4d83c-131">For more information, see [Microsoft SMB Protocol and CIFS Protocol Overview](microsoft-smb-protocol-and-cifs-protocol-overview.md).</span></span> <span data-ttu-id="4d83c-132">Интернет-черновик CIFS явно определяет, что реализация CIFS может реализовать уступающей блокировку, отклонить их.</span><span class="sxs-lookup"><span data-stu-id="4d83c-132">The CIFS Internet Draft explicitly identifies that a CIFS implementation may implement opportunistic locks by refusing to grant them.</span></span>

<span data-ttu-id="4d83c-133">В следующих разделах описываются уступающей блокировки.</span><span class="sxs-lookup"><span data-stu-id="4d83c-133">The following topics identify opportunistic locks.</span></span>

## <a name="in-this-section"></a><span data-ttu-id="4d83c-134">В этом разделе</span><span class="sxs-lookup"><span data-stu-id="4d83c-134">In this section</span></span>



| <span data-ttu-id="4d83c-135">Раздел</span><span class="sxs-lookup"><span data-stu-id="4d83c-135">Topic</span></span>                                                                                                               | <span data-ttu-id="4d83c-136">Описание</span><span class="sxs-lookup"><span data-stu-id="4d83c-136">Description</span></span>                                                                                                                                                                                                                                                                                       |
|---------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="4d83c-137">Локальное кэширование</span><span class="sxs-lookup"><span data-stu-id="4d83c-137">Local Caching</span></span>](local-caching.md)<br/>                                                                       | <span data-ttu-id="4d83c-138">*Локальное кэширование* данных — это метод, используемый для ускорения сетевого доступа к файлам данных.</span><span class="sxs-lookup"><span data-stu-id="4d83c-138">*Local caching* of data is a technique used to speed network access to data files.</span></span> <span data-ttu-id="4d83c-139">Он включает кэширование данных на клиентах, а не на серверах, когда это возможно.</span><span class="sxs-lookup"><span data-stu-id="4d83c-139">It involves caching data on clients rather than on servers when possible.</span></span><br/>                                                                                                                           |
| [<span data-ttu-id="4d83c-140">Согласование данных</span><span class="sxs-lookup"><span data-stu-id="4d83c-140">Data Coherency</span></span>](data-coherency.md)<br/>                                                                     | <span data-ttu-id="4d83c-141">Если данные согласованы, данные на сервере и все клиенты синхронизируются.</span><span class="sxs-lookup"><span data-stu-id="4d83c-141">If data is coherent, data on the server and all the clients is synchronized.</span></span> <span data-ttu-id="4d83c-142">Один из типов программной системы, обеспечивающей согласованность данных, — это система контроля версий (RCS).</span><span class="sxs-lookup"><span data-stu-id="4d83c-142">One type of software system that provides data coherency is a revision control system (RCS).</span></span><br/>                                                                                                              |
| [<span data-ttu-id="4d83c-143">Как запросить уступающую блокировку</span><span class="sxs-lookup"><span data-stu-id="4d83c-143">How to Request an Opportunistic Lock</span></span>](how-to-request-an-opportunistic-lock.md)<br/>                         | <span data-ttu-id="4d83c-144">Для запроса уступающей блокировки сначала открывается файл с разрешениями и флагами, соответствующими приложению, открывающему файл.</span><span class="sxs-lookup"><span data-stu-id="4d83c-144">Opportunistic locks are requested by first opening a file with permissions and flags appropriate to the application opening the file.</span></span> <span data-ttu-id="4d83c-145">Все файлы, для которых будут запрошены уступающей блокировки, должны быть открыты для перекрывающихся (асинхронных) операций.</span><span class="sxs-lookup"><span data-stu-id="4d83c-145">All files for which opportunistic locks will be requested must be opened for overlapped (asynchronous) operation.</span></span><br/>                                |
| [<span data-ttu-id="4d83c-146">Ответ сервера на открытые запросы к заблокированным файлам</span><span class="sxs-lookup"><span data-stu-id="4d83c-146">Server Response to Open Requests on Locked Files</span></span>](server-response-to-open-requests-on-locked-files.md)<br/> | <span data-ttu-id="4d83c-147">Вы можете уменьшить влияние приложения на другие клиенты и влияние их на приложение, предоставив максимально возможный общий доступ, запросив минимальный уровень доступа и используя наименее агрессивную оппортунистической блокировку, подходящую для вашего приложения.</span><span class="sxs-lookup"><span data-stu-id="4d83c-147">You can minimize the impact your application has on other clients and the impact they have on your application by granting as much sharing as possible, requesting the minimum access level necessary, and using the least intrusive opportunistic lock suitable for your application.</span></span><br/> |
| [<span data-ttu-id="4d83c-148">Типы уступающей блокировки</span><span class="sxs-lookup"><span data-stu-id="4d83c-148">Types of Opportunistic Locks</span></span>](types-of-opportunistic-locks.md)<br/>                                         | <span data-ttu-id="4d83c-149">Описывает уровень 1, уровень 2, пакетную обработку и фильтрацию уступающей блокировки.</span><span class="sxs-lookup"><span data-stu-id="4d83c-149">Describes level 1, level 2, batch, and filter opportunistic locks.</span></span><br/>                                                                                                                                                                                                                     |
| [<span data-ttu-id="4d83c-150">Разбиение уступающей блокировки</span><span class="sxs-lookup"><span data-stu-id="4d83c-150">Breaking Opportunistic Locks</span></span>](breaking-opportunistic-locks.md)<br/>                                         | <span data-ttu-id="4d83c-151">Разбиение уступающей блокировки — это процесс снижения блокировки, которую один клиент имеет на файл, чтобы другой клиент мог открыть файл с оппортунистической блокировкой или без нее.</span><span class="sxs-lookup"><span data-stu-id="4d83c-151">Breaking an opportunistic lock is the process of degrading the lock that one client has on a file so that another client can open the file, with or without an opportunistic lock.</span></span><br/>                                                                                                     |
| [<span data-ttu-id="4d83c-152">Примеры оппортунистической блокировки</span><span class="sxs-lookup"><span data-stu-id="4d83c-152">Opportunistic Lock Examples</span></span>](opportunistic-lock-examples.md)<br/>                                           | <span data-ttu-id="4d83c-153">Схемы представлений сетевого трафика для уступающей блокировки уровня 1, оппортунистической блокировки пакетной службы и фильтра оппортунистической блокировки.</span><span class="sxs-lookup"><span data-stu-id="4d83c-153">Diagrams of network-traffic views for a level 1 opportunistic lock, a batch opportunistic lock, and a filter opportunistic lock.</span></span><br/>                                                                                                                                                       |
| [<span data-ttu-id="4d83c-154">Операции оппортунистической блокировки</span><span class="sxs-lookup"><span data-stu-id="4d83c-154">Opportunistic Lock Operations</span></span>](opportunistic-lock-operations.md)<br/>                                       | <span data-ttu-id="4d83c-155">Если приложение запрашивает уступающую блокировку, все файлы, для которых он запрашивает блокировки, должны быть открыты для перекрывающихся (асинхронных) входных и выходных данных с помощью функции [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) с флагом **File \_ Flag \_ OVERLAPPED** .</span><span class="sxs-lookup"><span data-stu-id="4d83c-155">If an application requests opportunistic locks, all files for which it requests locks must be opened for overlapped (asynchronous) input and output by using the [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) function with the **FILE\_FLAG\_OVERLAPPED** flag.</span></span><br/>                                   |



 

<span data-ttu-id="4d83c-156">Дополнительные сведения о уступающей блокировке см. в документе Интернет – черновике CIFS.</span><span class="sxs-lookup"><span data-stu-id="4d83c-156">For additional information about opportunistic locks, see the CIFS Internet Draft document.</span></span> <span data-ttu-id="4d83c-157">Все расхождения между этой темой и текущим черным черновиком CIFS должны быть разрешены в соответствии с черновиком CIFS Интернета.</span><span class="sxs-lookup"><span data-stu-id="4d83c-157">Any discrepancies between this topic and the current CIFS Internet Draft should be resolved in favor of the CIFS Internet Draft.</span></span>

 

