---
description: Управление дескрипторами файлов транзакций в транзакционной NTFS.
ms.assetid: 29879a3f-14b4-462c-a001-46c3c3eb74d1
title: Как использовать транзакционную NTFS
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 43681f0d5b27f0db03d8b6c44564b792fce4b467
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105684369"
---
# <a name="how-to-use-transactional-ntfs"></a><span data-ttu-id="79679-103">Как использовать транзакционную NTFS</span><span class="sxs-lookup"><span data-stu-id="79679-103">How to Use Transactional NTFS</span></span>

## <a name="transacted-file-handles"></a><span data-ttu-id="79679-104">Транзакционные дескрипторы файлов</span><span class="sxs-lookup"><span data-stu-id="79679-104">Transacted File Handles</span></span>

<span data-ttu-id="79679-105">Транзакционная NTFS (TxF) привязывает файловый обработчик к транзакции.</span><span class="sxs-lookup"><span data-stu-id="79679-105">Transactional NTFS (TxF) binds a file handle to a transaction.</span></span> <span data-ttu-id="79679-106">Для операций, которые работают с маркером (например, функции [**ReadFile**](/windows/desktop/api/FileAPI/nf-fileapi-readfile) и [**WriteFile**](/windows/desktop/api/FileAPI/nf-fileapi-writefile) ), фактический вызов функции API не изменяется.</span><span class="sxs-lookup"><span data-stu-id="79679-106">For operations that work on a handle (for example, the [**ReadFile**](/windows/desktop/api/FileAPI/nf-fileapi-readfile) and [**WriteFile**](/windows/desktop/api/FileAPI/nf-fileapi-writefile) functions), the actual API function call does not change.</span></span> <span data-ttu-id="79679-107">Для операций с файлами, которые принимают имя, для этих операций существуют явные транзакционные функции.</span><span class="sxs-lookup"><span data-stu-id="79679-107">For file operations that take a name, there are explicit transacted functions for these operations.</span></span> <span data-ttu-id="79679-108">Например, вместо вызова функции [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea)вызовите [**креатефилетрансактед**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda).</span><span class="sxs-lookup"><span data-stu-id="79679-108">For example, instead of calling [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea), call [**CreateFileTransacted**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda).</span></span> <span data-ttu-id="79679-109">При этом создается файловый обработчик транзакций, который затем может использоваться для всех файловых операций, требующих маркера.</span><span class="sxs-lookup"><span data-stu-id="79679-109">This creates a transacted file handle, which can then be used for all file operations requiring a handle.</span></span> <span data-ttu-id="79679-110">Все последующие операции, использующие этот обработчик, являются транзакционными операциями.</span><span class="sxs-lookup"><span data-stu-id="79679-110">All subsequent operations using this handle are transacted operations.</span></span>

## <a name="basic-txf-usage"></a><span data-ttu-id="79679-111">Основные сведения об использовании TxF</span><span class="sxs-lookup"><span data-stu-id="79679-111">Basic TxF Usage</span></span>

<span data-ttu-id="79679-112">Приведенная ниже последовательность действий представляет собой наиболее простой способ использования TxF.</span><span class="sxs-lookup"><span data-stu-id="79679-112">The following series of steps represents the most basic usage for TxF.</span></span> <span data-ttu-id="79679-113">Более сложные сценарии также поддерживаются по усмотрению конструктора приложений.</span><span class="sxs-lookup"><span data-stu-id="79679-113">More complex scenarios are also supported, at the discretion of the application designer.</span></span>

1.  <span data-ttu-id="79679-114">Создайте транзакцию путем вызова функции KTM [**CreateTransaction**](/windows/desktop/api/ktmw32/nf-ktmw32-createtransaction) или с помощью интерфейса **IKernelTransaction** [координатор распределенных транзакций](/previous-versions/windows/desktop/mscs/distributed-transaction-coordinator) (DTC).</span><span class="sxs-lookup"><span data-stu-id="79679-114">Create a transaction by calling the KTM function [**CreateTransaction**](/windows/desktop/api/ktmw32/nf-ktmw32-createtransaction) or by using the **IKernelTransaction** interface of the [Distributed Transaction Coordinator](/previous-versions/windows/desktop/mscs/distributed-transaction-coordinator) (DTC).</span></span>
2.  <span data-ttu-id="79679-115">Получение обрабатываемых файлов транзакций путем вызова [**креатефилетрансактед**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda).</span><span class="sxs-lookup"><span data-stu-id="79679-115">Get transacted file handle(s) by calling [**CreateFileTransacted**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda).</span></span>
3.  <span data-ttu-id="79679-116">При необходимости измените файлы с помощью транзакционных файлов (file handles).</span><span class="sxs-lookup"><span data-stu-id="79679-116">Modify the file(s) as necessary using the transacted file handle(s).</span></span>
4.  <span data-ttu-id="79679-117">Закройте все дескрипторы файлов транзакций, связанные с транзакцией, созданной на шаге 1.</span><span class="sxs-lookup"><span data-stu-id="79679-117">Close all transacted file handles associated with the transaction created in step 1.</span></span>
5.  <span data-ttu-id="79679-118">Зафиксируйте или прервать транзакцию, вызвав соответствующую функцию KTM или DTC.</span><span class="sxs-lookup"><span data-stu-id="79679-118">Commit or abort the transaction by calling the corresponding KTM or DTC function.</span></span>

## <a name="key-points-of-the-txf-programming-model"></a><span data-ttu-id="79679-119">Основные моменты модели программирования TxF</span><span class="sxs-lookup"><span data-stu-id="79679-119">Key Points of the TxF Programming Model</span></span>

<span data-ttu-id="79679-120">Модель программирования TxF имеет следующие ключевые моменты, которые необходимо учитывать при разработке приложения TxF:</span><span class="sxs-lookup"><span data-stu-id="79679-120">The TxF programming model has the following key points for you to consider when you develop a TxF application:</span></span>

-   <span data-ttu-id="79679-121">Настоятельно рекомендуется, чтобы приложение закрывало все дескрипторы файлов транзакций перед фиксацией или откатом транзакции.</span><span class="sxs-lookup"><span data-stu-id="79679-121">It is highly recommended that an application close all transacted file handles before committing or rolling back a transaction.</span></span> <span data-ttu-id="79679-122">Система делает недействительными все обработанные дескрипторы транзакций при завершении транзакции.</span><span class="sxs-lookup"><span data-stu-id="79679-122">The system invalidates all transacted handles when a transaction ends.</span></span> <span data-ttu-id="79679-123">Любая операция, кроме Close, выполненная для транзакционного обработчика после завершения транзакции, возвращает следующую ошибку: **\_ \_ \_ \_ недопустимый обработчик ошибок**.</span><span class="sxs-lookup"><span data-stu-id="79679-123">Any operation, except close, performed on a transacted handle after the transaction ends returns the following error: **ERROR\_HANDLE\_NO\_LONGER\_VALID**.</span></span>
-   <span data-ttu-id="79679-124">Файл просматривается как единица хранения.</span><span class="sxs-lookup"><span data-stu-id="79679-124">A file is viewed as a unit of storage.</span></span> <span data-ttu-id="79679-125">Поддерживаются частичные обновления и полная перезапись файлов.</span><span class="sxs-lookup"><span data-stu-id="79679-125">Partial updates and complete file overwrites are supported.</span></span> <span data-ttu-id="79679-126">Несколько транзакций не могут одновременно изменять один и тот же файл.</span><span class="sxs-lookup"><span data-stu-id="79679-126">Multiple transactions cannot concurrently modify the same file.</span></span>
-   <span data-ttu-id="79679-127">Отображаемые в памяти операции ввода-вывода прозрачны и соответствуют обычным файловым операциям ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="79679-127">Memory mapped I/O is transparent and consistent with the regular file I/O.</span></span> <span data-ttu-id="79679-128">Приложение должно очистить и закрыть открытый раздел перед фиксацией транзакции.</span><span class="sxs-lookup"><span data-stu-id="79679-128">An application must flush and close an opened section before committing a transaction.</span></span> <span data-ttu-id="79679-129">Невыполнение этого действия может привести к частичному изменению сопоставленного файла в рамках транзакции.</span><span class="sxs-lookup"><span data-stu-id="79679-129">Failure to do this can result in partial changes to the mapped file within the transaction.</span></span> <span data-ttu-id="79679-130">Если это не сделано, происходит сбой отката.</span><span class="sxs-lookup"><span data-stu-id="79679-130">A rollback fails if this is not done.</span></span>

## <a name="common-programming-errors"></a><span data-ttu-id="79679-131">Распространенные ошибки программирования</span><span class="sxs-lookup"><span data-stu-id="79679-131">Common Programming Errors</span></span>

<span data-ttu-id="79679-132">При разработке транзакционных приложений могут возникать следующие распространенные ошибки.</span><span class="sxs-lookup"><span data-stu-id="79679-132">The following common errors can occur when developing transacted applications:</span></span>

-   <span data-ttu-id="79679-133">Использование маркера файла после завершения транзакции.</span><span class="sxs-lookup"><span data-stu-id="79679-133">Using a file handle after a transaction is completed.</span></span>
-   <span data-ttu-id="79679-134">Не удается закрыть дескрипторы для удаленных файлов и каталогов перед фиксацией транзакции, что предотвратит выполнение операций удаления.</span><span class="sxs-lookup"><span data-stu-id="79679-134">Failing to close handles to deleted files and directories before committing a transaction, which will prevent the delete operations from occurring.</span></span> <span data-ttu-id="79679-135">Это событие должно произойти перед выполнением фиксации для того, чтобы операция удаления считалась частью транзакции.</span><span class="sxs-lookup"><span data-stu-id="79679-135">This event must occur before performing the commit for the delete operation to be considered part of the transaction.</span></span> <span data-ttu-id="79679-136">Это обусловлено тем, что система фактически не удаляет файл до тех пор, пока не будет закрыт последний его обработчик, даже если операция не является транзакционной, как часть подсистемы ввода-вывода Windows.</span><span class="sxs-lookup"><span data-stu-id="79679-136">This is because the system does not actually delete a file until the last handle to it is closed, even when the operation is not transacted, as part of the Windows file I/O subsystem.</span></span>
-   <span data-ttu-id="79679-137">Не удается выполнить откат транзакций, инициированных системой, что может произойти в любое время; Например, транзакция откатывается, если ресурсы системы исчерпаны.</span><span class="sxs-lookup"><span data-stu-id="79679-137">Failing to account for system-initiated transaction rollbacks, which may happen at any time; for example, a transaction is rolled back if the system resources are exhausted.</span></span>

 

 
