---
description: Определите, поддерживает ли файловая система разреженные файлы, вызвав функцию Жетволумеинформатион.
ms.assetid: a08f6bbc-c139-4396-8964-4aa63285f3f5
title: Операции с разреженными файлами
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 2c23d26fc1c52db32ca7674aec2fc487a826e9a6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105662532"
---
# <a name="sparse-file-operations"></a><span data-ttu-id="84600-103">Операции с разреженными файлами</span><span class="sxs-lookup"><span data-stu-id="84600-103">Sparse File Operations</span></span>

<span data-ttu-id="84600-104">Чтобы определить, поддерживает ли файловая система разреженные файлы, вызовите функцию [**жетволумеинформатион**](/windows/desktop/api/FileAPI/nf-fileapi-getvolumeinformationa) и изучите файл поддержка битового флага **\_ \_ разреженных \_ файлов** , возвращаемого с помощью параметра *лпфилесистемфлагс* .</span><span class="sxs-lookup"><span data-stu-id="84600-104">To determine whether a file system supports sparse files, call the [**GetVolumeInformation**](/windows/desktop/api/FileAPI/nf-fileapi-getvolumeinformationa) function and examine the **FILE\_SUPPORTS\_SPARSE\_FILES** bit flag returned through the *lpFileSystemFlags* parameter.</span></span>

<span data-ttu-id="84600-105">Большинство приложений не знают о разреженных файлах и не создают разреженные файлы.</span><span class="sxs-lookup"><span data-stu-id="84600-105">Most applications are not aware of sparse files and will not create sparse files.</span></span> <span data-ttu-id="84600-106">Тот факт, что приложение считывает разреженный файл, является прозрачным для приложения.</span><span class="sxs-lookup"><span data-stu-id="84600-106">The fact that an application is reading a sparse file is transparent to the application.</span></span> <span data-ttu-id="84600-107">Приложение, осведомленное о разреженных файлах, должно определять, подходит ли его набор данных для хранения в разреженном файле.</span><span class="sxs-lookup"><span data-stu-id="84600-107">An application that is aware of sparse-files should determine whether its data set is suitable to be kept in a sparse file.</span></span> <span data-ttu-id="84600-108">После этого приложение должно явным образом объявить файл как разреженный с помощью [**фсктл \_ Set \_ разреженный**](/windows/win32/api/winioctl/ni-winioctl-fsctl_set_sparse) код элемента управления.</span><span class="sxs-lookup"><span data-stu-id="84600-108">After that determination is made, the application must explicitly declare a file as sparse, using the [**FSCTL\_SET\_SPARSE**](/windows/win32/api/winioctl/ni-winioctl-fsctl_set_sparse) control code.</span></span>

<span data-ttu-id="84600-109">После того как приложение настроило разреженный файл, приложение может использовать код элемента управления [**фсктл \_ Set \_ Zero \_**](/windows/win32/api/winioctl/ni-winioctl-fsctl_set_zero_data) , чтобы установить в качестве региона файла нулевое значение.</span><span class="sxs-lookup"><span data-stu-id="84600-109">After an application has set a file to be sparse, the application can use the [**FSCTL\_SET\_ZERO\_DATA**](/windows/win32/api/winioctl/ni-winioctl-fsctl_set_zero_data) control code to set a region of the file to zero.</span></span> <span data-ttu-id="84600-110">Кроме того, приложение может использовать [**\_ \_ выделенный \_ запрос фсктл**](/windows/win32/api/winioctl/ni-winioctl-fsctl_query_allocated_ranges) , управляющий кодом, чтобы ускорить поиск ненулевых данных в разреженном файле.</span><span class="sxs-lookup"><span data-stu-id="84600-110">In addition, the application can use the [**FSCTL\_QUERY\_ALLOCATED\_RANGES**](/windows/win32/api/winioctl/ni-winioctl-fsctl_query_allocated_ranges) control code to speed searches for nonzero data in the sparse file.</span></span>

<span data-ttu-id="84600-111">При выполнении операции записи (с функцией или операцией, отличной от [**фсктл \_ набора \_ нулевых \_ данных**](/windows/win32/api/winioctl/ni-winioctl-fsctl_set_zero_data)), данные которых состоят из нуля и равны нулю, нули записываются на диск для всей длины записи.</span><span class="sxs-lookup"><span data-stu-id="84600-111">When you perform a write operation (with a function or operation other than [**FSCTL\_SET\_ZERO\_DATA**](/windows/win32/api/winioctl/ni-winioctl-fsctl_set_zero_data)) whose data consists of nothing but zeros, zeros will be written to the disk for the entire length of the write.</span></span> <span data-ttu-id="84600-112">Чтобы обнулить диапазон файла и сохранить разреженность, используйте **фсктл \_ набор \_ нулевых \_ данных**.</span><span class="sxs-lookup"><span data-stu-id="84600-112">To zero out a range of the file and maintain sparseness, use **FSCTL\_SET\_ZERO\_DATA**.</span></span>

<span data-ttu-id="84600-113">Приложение, поддерживающее разреженность, также может задавать разреженность существующего файла.</span><span class="sxs-lookup"><span data-stu-id="84600-113">A sparseness-aware application may also set an existing file to be sparse.</span></span> <span data-ttu-id="84600-114">Если приложение задает разреженный файл, он должен просканировать файл для регионов, содержащих нули, и использовать [**фсктл \_ \_ нулевые \_ данные**](/windows/win32/api/winioctl/ni-winioctl-fsctl_set_zero_data) для сброса этих регионов, что может привести к отмене выделения места на физическом диске.</span><span class="sxs-lookup"><span data-stu-id="84600-114">If an application sets an existing file to be sparse, it should then scan the file for regions which contain zeros, and use [**FSCTL\_SET\_ZERO\_DATA**](/windows/win32/api/winioctl/ni-winioctl-fsctl_set_zero_data) to reset those regions, thereby possibly deallocating some physical disk storage.</span></span> <span data-ttu-id="84600-115">Приложение, обновленное до уровня разреженного файла, должно выполнить это преобразование.</span><span class="sxs-lookup"><span data-stu-id="84600-115">An application upgraded to sparse file awareness should perform this conversion.</span></span>

<span data-ttu-id="84600-116">При выполнении операции чтения с обнуленной части разреженного файла операционная система может не считывать с жесткого диска.</span><span class="sxs-lookup"><span data-stu-id="84600-116">When you perform a read operation from a zeroed-out portion of a sparse file, the operating system may not read from the hard disk drive.</span></span> <span data-ttu-id="84600-117">Вместо этого система распознает, что часть файла, которая должна быть считана, содержит нули и возвращает буфер, заполненный нулями без фактического считывания с диска.</span><span class="sxs-lookup"><span data-stu-id="84600-117">Instead, the system recognizes that the portion of the file to be read contains zeros, and it returns a buffer full of zeros without actually reading from the disk.</span></span>

<span data-ttu-id="84600-118">Как и в случае с любым другим файлом, система может записывать данные или считывать их из любой места в разреженном файле.</span><span class="sxs-lookup"><span data-stu-id="84600-118">As with any other file, the system can write data to or read data from any position in a sparse file.</span></span> <span data-ttu-id="84600-119">Ненулевые данные, записываемые в ранее нулевую часть файла, могут привести к выделению места на диске.</span><span class="sxs-lookup"><span data-stu-id="84600-119">Nonzero data being written to a previously zeroed portion of the file may result in allocation of disk space.</span></span> <span data-ttu-id="84600-120">Нули, записываемые на ненулевые данные (только с [**\_ нулевым набором \_ \_ данных фсктл**](/windows/win32/api/winioctl/ni-winioctl-fsctl_set_zero_data)), могут привести к освобождению места на диске.</span><span class="sxs-lookup"><span data-stu-id="84600-120">Zeros being written over nonzero data (only with [**FSCTL\_SET\_ZERO\_DATA**](/windows/win32/api/winioctl/ni-winioctl-fsctl_set_zero_data)) may result in a deallocation of disk space.</span></span>

> [!Note]  
> <span data-ttu-id="84600-121">Приложение может поддерживать разреженность, записывая нули с [**фсктл \_ набором \_ \_ данных**](/windows/win32/api/winioctl/ni-winioctl-fsctl_set_zero_data).</span><span class="sxs-lookup"><span data-stu-id="84600-121">It is up to the application to maintain sparseness by writing zeros with [**FSCTL\_SET\_ZERO\_DATA**](/windows/win32/api/winioctl/ni-winioctl-fsctl_set_zero_data).</span></span>

 

<span data-ttu-id="84600-122">Средства дефрагментации, обрабатывающие сжатые файлы в файловых системах NTFS, будут правильно работать с разреженными файлами на томах с файловой системой NTFS.</span><span class="sxs-lookup"><span data-stu-id="84600-122">Defragmentation tools that handle compressed files on NTFS file systems will correctly handle sparse files on NTFS file system volumes.</span></span> <span data-ttu-id="84600-123">Большие и сильно фрагментированные разреженные файлы могут превысить ограничение NTFS в экстентах диска до того, как будет использовано доступное пространство.</span><span class="sxs-lookup"><span data-stu-id="84600-123">Large and highly fragmented sparse files can exceed the NTFS limitation on disk extents before available space is used.</span></span> <span data-ttu-id="84600-124">Дополнительные сведения см. в разделе [расширение файла может завершиться ошибкой с ошибкой переполнения диска, даже если на томе свободно свободное место](https://support.microsoft.com/default.aspx/kb/957180).</span><span class="sxs-lookup"><span data-stu-id="84600-124">For more information, see [Extending a File may fail with "Disk Full" Error even though Volume has Free Space](https://support.microsoft.com/default.aspx/kb/957180).</span></span>

 

 
