---
description: Пример обмена пакетами протокола SMB (Майкрософт) между клиентом и сервером.
ms.assetid: f831d0de-0e38-4141-811c-892a1b5c4037
title: Сценарий обмена пакетами протокола SMB (Майкрософт)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e8a03e2f75b00aa93e629b3e698631c5efde4694
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104343192"
---
# <a name="microsoft-smb-protocol-packet-exchange-scenario"></a><span data-ttu-id="a39da-103">Сценарий обмена пакетами протокола SMB (Майкрософт)</span><span class="sxs-lookup"><span data-stu-id="a39da-103">Microsoft SMB Protocol Packet Exchange Scenario</span></span>

<span data-ttu-id="a39da-104">В этом разделе приводится пример обмена пакетами протокола SMB (Майкрософт) между клиентом и сервером.</span><span class="sxs-lookup"><span data-stu-id="a39da-104">This topic gives an example of a Microsoft SMB Protocol packet exchange between a client and a server.</span></span> <span data-ttu-id="a39da-105">Следующие шаги являются обзором процесса.</span><span class="sxs-lookup"><span data-stu-id="a39da-105">The following steps are an overview of the process:</span></span>

1.  <span data-ttu-id="a39da-106">Клиент и сервер устанавливают сеанс NetBIOS.</span><span class="sxs-lookup"><span data-stu-id="a39da-106">The client and server establish a NetBIOS session.</span></span>
2.  <span data-ttu-id="a39da-107">Клиент и сервер согласовывают диалект протокола SMB (Майкрософт).</span><span class="sxs-lookup"><span data-stu-id="a39da-107">The client and server negotiate the Microsoft SMB Protocol dialect.</span></span>
3.  <span data-ttu-id="a39da-108">Клиент входит в систему на сервере.</span><span class="sxs-lookup"><span data-stu-id="a39da-108">The client logs on to the server.</span></span>
4.  <span data-ttu-id="a39da-109">Клиент подключается к общей папке на сервере.</span><span class="sxs-lookup"><span data-stu-id="a39da-109">The client connects to a share on the server.</span></span>
5.  <span data-ttu-id="a39da-110">Клиент открывает файл в общей папке.</span><span class="sxs-lookup"><span data-stu-id="a39da-110">The client opens a file on the share.</span></span>
6.  <span data-ttu-id="a39da-111">Клиент считывает данные из файла.</span><span class="sxs-lookup"><span data-stu-id="a39da-111">The client reads from the file.</span></span>

<span data-ttu-id="a39da-112">Во-первых, клиент может установить полное дуплексное TCP-соединение с сервером.</span><span class="sxs-lookup"><span data-stu-id="a39da-112">First, a full-duplex TCP connection is established by the client with the server.</span></span> <span data-ttu-id="a39da-113">Затем клиент создает и отправляет пакет запроса сеанса NetBIOS через TCP-соединение.</span><span class="sxs-lookup"><span data-stu-id="a39da-113">Then the client builds and sends a NetBIOS session request packet over the TCP connection.</span></span> <span data-ttu-id="a39da-114">Если пакет был отформатирован правильно, сервер возвращает пакет, содержащий сообщение с подтверждением того, что сеанс был установлен.</span><span class="sxs-lookup"><span data-stu-id="a39da-114">If the packet was formatted correctly, the server then returns a packet that contains a message acknowledging that the session has been established.</span></span> <span data-ttu-id="a39da-115">После этого клиент отправляет на сервер первые пакеты протокола SMB Microsoft.</span><span class="sxs-lookup"><span data-stu-id="a39da-115">After this, the client sends the first Microsoft SMB Protocol packets to the server.</span></span>



|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="a39da-116">**Пакет 1: \_ \_ согласование SMB com**</span><span class="sxs-lookup"><span data-stu-id="a39da-116">**Packet 1:  SMB\_COM\_NEGOTIATE**</span></span><br/> <span data-ttu-id="a39da-117">**Направление:** С клиента на сервер</span><span class="sxs-lookup"><span data-stu-id="a39da-117">**Direction:** Client to server</span></span><br/> <span data-ttu-id="a39da-118">**Описание:** Клиент запрашивает, что сервер согласовывает диалект протокола SMB Microsoft.</span><span class="sxs-lookup"><span data-stu-id="a39da-118">**Description:** The client requests that the server negotiate the Microsoft SMB Protocol dialect.</span></span> <span data-ttu-id="a39da-119">В пакет входит список строк, определяющих диалекты, с которыми может работать клиент.</span><span class="sxs-lookup"><span data-stu-id="a39da-119">A list of strings identifying the dialects that the client can work with is included in the packet.</span></span><br/>                                                                                                                                                                                                                                                                                                                                   |
| <span data-ttu-id="a39da-120">**Пакет 2. \_ \_ согласование SMB com**</span><span class="sxs-lookup"><span data-stu-id="a39da-120">**Packet 2:  SMB\_COM\_NEGOTIATE**</span></span><br/> <span data-ttu-id="a39da-121">**Направление:** От сервера к клиенту</span><span class="sxs-lookup"><span data-stu-id="a39da-121">**Direction:** Server to client</span></span><br/> <span data-ttu-id="a39da-122">**Описание:** Сервер отвечает на запрос клиента, чтобы определить диалект протокола Microsoft SMB, который будет использоваться в сеансе.</span><span class="sxs-lookup"><span data-stu-id="a39da-122">**Description:** The server responds to the client's request to identify the Microsoft SMB Protocol dialect that is going to be used in the session.</span></span> <span data-ttu-id="a39da-123">Возвращаемый пакет также включает 8-байтовую случайную строку, которая будет использоваться на следующем шаге для проверки подлинности клиента в процессе входа в систему.</span><span class="sxs-lookup"><span data-stu-id="a39da-123">The returned packet also includes an 8-byte random string that will be used in the next step to authenticate the client during the logon process.</span></span><br/>                                                                                                                                                                                                                                   |
| <span data-ttu-id="a39da-124">**Пакет 3. \_ \_ \_ андкс установки сеанса com \_ SMB**</span><span class="sxs-lookup"><span data-stu-id="a39da-124">**Packet 3:  SMB\_COM\_SESSION\_SETUP\_ANDX**</span></span><br/> <span data-ttu-id="a39da-125">**Направление:** С клиента на сервер</span><span class="sxs-lookup"><span data-stu-id="a39da-125">**Direction:** Client to server</span></span><br/> <span data-ttu-id="a39da-126">**Описание:** Этот пакет содержит сведения о возможностях клиента, поэтому этот пакет необходимо отправить, даже если сервер реализовал только безопасность на уровне общего доступа.</span><span class="sxs-lookup"><span data-stu-id="a39da-126">**Description:** This packet includes information about client capabilities, so this packet must be sent even if the server has implemented only share-level security.</span></span><br/> <span data-ttu-id="a39da-127">**Пакет 3. \_ \_ \_ андкс установки сеанса com \_ SMB**</span><span class="sxs-lookup"><span data-stu-id="a39da-127">**Packet 3:  SMB\_COM\_SESSION\_SETUP\_ANDX**</span></span><br/> <span data-ttu-id="a39da-128">**Направление:** От сервера к клиенту</span><span class="sxs-lookup"><span data-stu-id="a39da-128">**Direction:** Server to client</span></span><br/> <span data-ttu-id="a39da-129">**Описание:** Если запрос или ответ принимается сервером, в пакет, возвращаемый клиенту, включается действительный идентификатор UID.</span><span class="sxs-lookup"><span data-stu-id="a39da-129">**Description:** If the challenge/response is accepted by the server, a valid UID is included in the packet that is returned to the client.</span></span> <span data-ttu-id="a39da-130">Если оно не принято, сервер возвратит код ошибки в этом пакете и отклонит доступ.</span><span class="sxs-lookup"><span data-stu-id="a39da-130">If it is not accepted, the server will return an error code in this packet and deny access.</span></span><br/> |
| <span data-ttu-id="a39da-131">**Пакет 4. \_ \_ \_ Подключение андкс к ДЕРЕВу com SMB \_**</span><span class="sxs-lookup"><span data-stu-id="a39da-131">**Packet 4:  SMB\_COM\_TREE\_CONNECT\_ANDX**</span></span><br/> <span data-ttu-id="a39da-132">**Направление:** С клиента на сервер</span><span class="sxs-lookup"><span data-stu-id="a39da-132">**Direction:** Client to server</span></span><br/> <span data-ttu-id="a39da-133">**Описание:** Клиент запрашивает доступ к общей папке.</span><span class="sxs-lookup"><span data-stu-id="a39da-133">**Description:** The client requests access to the share.</span></span> <span data-ttu-id="a39da-134">Пакет содержит полностью указанный путь к общей папке в формате UNC.</span><span class="sxs-lookup"><span data-stu-id="a39da-134">The packet contains the fully specified path of the share in UNC format.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                             |
| <span data-ttu-id="a39da-135">**Пакет 5. \_ \_ \_ Подключение андкс к ДЕРЕВу com SMB \_**</span><span class="sxs-lookup"><span data-stu-id="a39da-135">**Packet 5:  SMB\_COM\_TREE\_CONNECT\_ANDX**</span></span><br/> <span data-ttu-id="a39da-136">**Направление:** От сервера к клиенту</span><span class="sxs-lookup"><span data-stu-id="a39da-136">**Direction:** Server to client</span></span><br/> <span data-ttu-id="a39da-137">**Описание:** Если предоставлен доступ к общей папке, сервер возвращает 16-разрядный идентификатор дерева (TID), соответствующий общему ресурсу в этом пакете.</span><span class="sxs-lookup"><span data-stu-id="a39da-137">**Description:** If access to the share is granted, then the server returns the 16-bit tree ID (TID) that corresponds to the share in this packet.</span></span> <span data-ttu-id="a39da-138">Если общая папка не существует или у пользователя недостаточно учетных данных для доступа к общей папке, сервер возвратит код ошибки в этом пакете и отклонит доступ к общей папке.</span><span class="sxs-lookup"><span data-stu-id="a39da-138">If the share does not exist or the user has insufficient credentials to access the share, the server will return an error code in this packet and deny access to the share.</span></span><br/>                                                                                                                                                                                                 |
| <span data-ttu-id="a39da-139">**Пакет 6. SMB \_ COM \_ Open \_ андкс**</span><span class="sxs-lookup"><span data-stu-id="a39da-139">**Packet 6:  SMB\_COM\_OPEN\_ANDX**</span></span><br/> <span data-ttu-id="a39da-140">**Направление:** С клиента на сервер</span><span class="sxs-lookup"><span data-stu-id="a39da-140">**Direction:** Client to server</span></span><br/> <span data-ttu-id="a39da-141">**Описание:** Клиент запрашивает у сервера открытие файла в общей папке от имени клиента.</span><span class="sxs-lookup"><span data-stu-id="a39da-141">**Description:** The client requests the server to open a file on the accessed share on behalf of the client.</span></span> <span data-ttu-id="a39da-142">Этот пакет содержит имя открываемого файла.</span><span class="sxs-lookup"><span data-stu-id="a39da-142">This packet contains the name of the file to be opened.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                   |
| <span data-ttu-id="a39da-143">**Пакет 7: SMB \_ COM \_ Open \_ андкс**</span><span class="sxs-lookup"><span data-stu-id="a39da-143">**Packet 7:  SMB\_COM\_OPEN\_ANDX**</span></span><br/> <span data-ttu-id="a39da-144">**Направление:** От сервера к клиенту</span><span class="sxs-lookup"><span data-stu-id="a39da-144">**Direction:** Server to client</span></span><br/> <span data-ttu-id="a39da-145">**Описание:** Если доступ к файлу предоставлен, сервер возвращает идентификатор запрошенного файла.</span><span class="sxs-lookup"><span data-stu-id="a39da-145">**Description:** If access to the file is granted, then the server returns the file ID of the requested file.</span></span> <span data-ttu-id="a39da-146">Если файл не существует или у пользователя недостаточно учетных данных для доступа к файлу, сервер возвратит код ошибки в этом пакете и отклонит доступ к файлу.</span><span class="sxs-lookup"><span data-stu-id="a39da-146">If the file does not exist or the user has insufficient credentials to access the file, the server will return an error code in this packet and deny access to the file.</span></span><br/>                                                                                                                                                                                                                                                  |
| <span data-ttu-id="a39da-147">**Пакет 8: SMB \_ COM \_ Read \_ андкс**</span><span class="sxs-lookup"><span data-stu-id="a39da-147">**Packet 8:  SMB\_COM\_READ\_ANDX**</span></span><br/> <span data-ttu-id="a39da-148">**Направление:** С клиента на сервер</span><span class="sxs-lookup"><span data-stu-id="a39da-148">**Direction:** Client to server</span></span><br/> <span data-ttu-id="a39da-149">**Описание:** Клиент запрашивает у сервера чтение данных из открытого файла от имени клиента и возвращает эти данные клиенту.</span><span class="sxs-lookup"><span data-stu-id="a39da-149">**Description:** The client requests the server to read data from the opened file on behalf of the client and return this data to the client.</span></span> <span data-ttu-id="a39da-150">Идентификатор файла, полученный клиентом при открытии файла, включается в этот пакет, чтобы определить открытый файл, из которого сервер должен считывать данные.</span><span class="sxs-lookup"><span data-stu-id="a39da-150">The file ID that is obtained by the client when the file was opened is included in this packet in order to identify which opened file the server should read data from.</span></span><br/>                                                                                                                                                                                                                   |
| <span data-ttu-id="a39da-151">**Пакет 9: SMB \_ COM \_ Read \_ андкс**</span><span class="sxs-lookup"><span data-stu-id="a39da-151">**Packet 9:  SMB\_COM\_READ\_ANDX**</span></span><br/> <span data-ttu-id="a39da-152">**Направление:** От сервера к клиенту</span><span class="sxs-lookup"><span data-stu-id="a39da-152">**Direction:** Server to client</span></span><br/> <span data-ttu-id="a39da-153">**Описание:** Сервер возвращает запрошенные данные файла в этом пакете.</span><span class="sxs-lookup"><span data-stu-id="a39da-153">**Description:** The server returns the requested file data in this packet.</span></span> <span data-ttu-id="a39da-154">Здесь возникает ошибка, которая вряд ли предоставила доступ к серверу, общей папке и файлу.</span><span class="sxs-lookup"><span data-stu-id="a39da-154">An error here is unlikely given that access to the server, share, and file has been granted.</span></span> <span data-ttu-id="a39da-155">Однако это может произойти в некоторых ситуациях. Например, если доступ к общей папке изменяется с момента открытия файла и с момента его считывания.</span><span class="sxs-lookup"><span data-stu-id="a39da-155">It can happen in some situations, however: for example, if access to a share is changed between the time the file is opened and the time it is read from.</span></span><br/>                                                                                                                                                                                                      |



 

> [!Note]  
> <span data-ttu-id="a39da-156">Если вы реализуете CIFS, который не поддерживает уведомления об изменениях, Windows не может поддерживать необработанный обработчик в файловой системе, а подключение SMB может исчезнуть без уведомления.</span><span class="sxs-lookup"><span data-stu-id="a39da-156">If you implement a CIFS that does not support change notifications, Windows cannot keep an outstanding handle to the file system, and the SMB connection can go away without notice.</span></span>

 

 

 




