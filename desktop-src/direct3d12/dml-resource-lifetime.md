---
title: Время существования и синхронизация ресурсов
description: Чтобы избежать неопределенного поведения, приложение Директмл должно правильно управлять временем существования объектов и синхронизацией между ЦП и GPU.
ms.custom: Windows 10 May 2019 Update
ms.localizationpriority: high
ms.topic: article
ms.date: 04/19/2019
ms.openlocfilehash: 6e8ab30c5c87c135ef3bdac0c1bc2a3d64040787
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "74104339"
---
# <a name="resource-lifetime-and-synchronization"></a><span data-ttu-id="b24eb-103">Время существования и синхронизация ресурсов</span><span class="sxs-lookup"><span data-stu-id="b24eb-103">Resource lifetime and synchronization</span></span>

<span data-ttu-id="b24eb-104">Как и в Direct3D 12, приложение Директмл должно обеспечить правильное управление временем существования объектов и синхронизацией между ЦП и ГРАФИЧЕСКИм процессором (чтобы избежать неопределенного поведения).</span><span class="sxs-lookup"><span data-stu-id="b24eb-104">Just as with Direct3D 12, your DirectML application must (in order to avoid undefined behavior) correctly manage object lifetimes and synchronization between the CPU and the GPU.</span></span> <span data-ttu-id="b24eb-105">Директмл использует идентичную модель времени существования ресурсов для Direct3D 12.</span><span class="sxs-lookup"><span data-stu-id="b24eb-105">DirectML follows an identical resource lifetime model to that of Direct3D 12.</span></span>

- <span data-ttu-id="b24eb-106">Зависимости времени существования между двумя объектами ЦП обслуживаются Директмл с помощью строгих счетчиков ссылок.</span><span class="sxs-lookup"><span data-stu-id="b24eb-106">Lifetime dependencies between two CPU objects are maintained by DirectML using strong reference counts.</span></span> <span data-ttu-id="b24eb-107">Ваше приложение не вручную управлять зависимостями времени существования ЦП.</span><span class="sxs-lookup"><span data-stu-id="b24eb-107">Your application needn't manually manage CPU lifetime dependencies.</span></span> <span data-ttu-id="b24eb-108">Например, все дочерние устройства содержат строгую ссылку на родительское устройство.</span><span class="sxs-lookup"><span data-stu-id="b24eb-108">For example, every device child holds a strong reference to its parent device.</span></span>
- <span data-ttu-id="b24eb-109">Зависимости времени существования между объектами GPU &mdash; или зависимостями, охватывающими ЦП и GPU, &mdash; не управляются автоматически.</span><span class="sxs-lookup"><span data-stu-id="b24eb-109">Lifetime dependencies between GPU objects&mdash;or dependencies that span across CPU and GPU&mdash;aren't automatically managed.</span></span> <span data-ttu-id="b24eb-110">Ответственность за то, чтобы ресурсы GPU работали как минимум до тех пор, пока вся работа, использующая этот ресурс, не завершится выполнением на GPU.</span><span class="sxs-lookup"><span data-stu-id="b24eb-110">It's your application's responsibility to ensure that GPU resources live at least until all work using that resource has completed execution on the GPU.</span></span>

## <a name="directml-devices"></a><span data-ttu-id="b24eb-111">Устройства Директмл</span><span class="sxs-lookup"><span data-stu-id="b24eb-111">DirectML devices</span></span>

<span data-ttu-id="b24eb-112">Устройство Директмл является потокобезопасным объектом фабрики без отслеживания состояния.</span><span class="sxs-lookup"><span data-stu-id="b24eb-112">The DirectML device is a thread-safe stateless factory object.</span></span> <span data-ttu-id="b24eb-113">Каждое дочернее устройство (см. [**идмлдевицечилд**](/windows/desktop/api/directml/nn-directml-idmldevicechild)) содержит строгую ссылку на родительское устройство директмл (см. [**идмлдевице**](/windows/desktop/api/directml/nn-directml-idmldevice)).</span><span class="sxs-lookup"><span data-stu-id="b24eb-113">Every device child (see [**IDMLDeviceChild**](/windows/desktop/api/directml/nn-directml-idmldevicechild)) holds a strong reference to its parent DirectML device (see [**IDMLDevice**](/windows/desktop/api/directml/nn-directml-idmldevice)).</span></span> <span data-ttu-id="b24eb-114">Это означает, что вы всегда можете получить родительский интерфейс устройства из любого дочернего интерфейса устройства.</span><span class="sxs-lookup"><span data-stu-id="b24eb-114">That means that you can always retrieve the parent device interface from any device child interface.</span></span>

<span data-ttu-id="b24eb-115">Устройство Директмл, в свою очередь, содержит строгую ссылку на устройство Direct3D 12, которое использовалось для его создания (см. раздел [**ID3D12Device**](/windows/desktop/api/d3d12/nn-d3d12-id3d12device)и производные интерфейсы).</span><span class="sxs-lookup"><span data-stu-id="b24eb-115">A DirectML device in turn holds a strong reference to the Direct3D 12 device that was used to create it (see [**ID3D12Device**](/windows/desktop/api/d3d12/nn-d3d12-id3d12device), and derived interfaces).</span></span>

<span data-ttu-id="b24eb-116">Так как устройство Директмл не имеет состояния, оно является неявно потокобезопасным.</span><span class="sxs-lookup"><span data-stu-id="b24eb-116">Because the DirectML device is stateless, it's implicitly thread-safe.</span></span> <span data-ttu-id="b24eb-117">Вы можете вызывать методы на устройстве Директмл из нескольких потоков одновременно, не требуя внешней синхронизации.</span><span class="sxs-lookup"><span data-stu-id="b24eb-117">You may call methods on the DirectML device from multiple threads simultaneously without the need for external synchronization.</span></span>

<span data-ttu-id="b24eb-118">Однако, в отличие от устройства Direct3D 12, устройство Директмл не является одноэлементным объектом.</span><span class="sxs-lookup"><span data-stu-id="b24eb-118">However, unlike the Direct3D 12 device, the DirectML device is not a singleton object.</span></span> <span data-ttu-id="b24eb-119">Вы можете бесплатно создавать столько Директмл устройств.</span><span class="sxs-lookup"><span data-stu-id="b24eb-119">You're free to create as many DirectML devices as you wish.</span></span> <span data-ttu-id="b24eb-120">Однако вы не можете смешивать и сопоставлять дочерние устройства, принадлежащие разным устройствам.</span><span class="sxs-lookup"><span data-stu-id="b24eb-120">However, you may not mix and match device children that belong to different devices.</span></span> <span data-ttu-id="b24eb-121">Например, [**идмлбиндингтабле**](/windows/desktop/api/directml/nn-directml-idmlbindingtable) и [**идмлкомпиледоператор**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) — это два типа дочерних элементов устройства (оба интерфейса прямо или косвенно наследуются от **идмлдевицечилд**).</span><span class="sxs-lookup"><span data-stu-id="b24eb-121">For example, [**IDMLBindingTable**](/windows/desktop/api/directml/nn-directml-idmlbindingtable) and [**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) are two kinds of device children (both interfaces derive directly or indirectly from **IDMLDeviceChild**).</span></span> <span data-ttu-id="b24eb-122">И вы не можете использовать таблицу привязки (**идмлбиндингтабле**) для привязки оператора (**идмлкомпиледоператор**), если оператор и таблица привязки относятся к разным экземплярам устройства директмл.</span><span class="sxs-lookup"><span data-stu-id="b24eb-122">And you may not use a binding table (**IDMLBindingTable**) to bind for an operator (**IDMLCompiledOperator**) if the operator and the binding table belong to different DirectML device instances.</span></span>

<span data-ttu-id="b24eb-123">Так как устройство Директмл не является singleton, удаление устройства происходит отдельно для каждого устройства, а не как событие на уровне процесса, как для устройства Direct3D 12.</span><span class="sxs-lookup"><span data-stu-id="b24eb-123">Because the DirectML device is not a singleton, device removal occurs on a per-device basis, rather than being a process-wide event as it is for a Direct3D 12 device.</span></span> <span data-ttu-id="b24eb-124">Дополнительные сведения см. [в разделе Обработка ошибок и удаление устройств в директмл](dml-errors.md).</span><span class="sxs-lookup"><span data-stu-id="b24eb-124">For more information, see [Handling errors and device removal in DirectML](dml-errors.md).</span></span>

## <a name="lifetime-requirements-of-gpu-resources"></a><span data-ttu-id="b24eb-125">Требования к времени существования ресурсов GPU</span><span class="sxs-lookup"><span data-stu-id="b24eb-125">Lifetime requirements of GPU resources</span></span>

<span data-ttu-id="b24eb-126">Как и Direct3D 12, Директмл не выполняет автоматическую синхронизацию между ЦП и GPU; Кроме того, не будет автоматически поддерживать ресурсы, пока они используются графическим процессором.</span><span class="sxs-lookup"><span data-stu-id="b24eb-126">Like Direct3D 12, DirectML doesn't automatically synchronize between the CPU and GPU; nor does it automatically keep resources alive while they're in use by the GPU.</span></span> <span data-ttu-id="b24eb-127">Вместо этого они являются обязанностями вашего приложения.</span><span class="sxs-lookup"><span data-stu-id="b24eb-127">Instead, these are responsibilities of your application.</span></span>

<span data-ttu-id="b24eb-128">При выполнении списка команд, содержащего диспетчеризации Директмл, приложение должно обеспечить активность ресурсов GPU до тех пор, пока вся работа, использующая эти ресурсы, не завершится выполнением на GPU.</span><span class="sxs-lookup"><span data-stu-id="b24eb-128">When executing a command list that contains DirectML dispatches, your application must ensure that GPU resources are kept alive until all work using those resources has completed execution on the GPU.</span></span>

<span data-ttu-id="b24eb-129">В случае с [**идмлкоммандрекордер:: рекорддиспатч**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) для оператора директмл, который включает следующие объекты:</span><span class="sxs-lookup"><span data-stu-id="b24eb-129">In the case of [**IDMLCommandRecorder::RecordDispatch**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) for a DirectML operator, that includes the following objects.</span></span>

- <span data-ttu-id="b24eb-130">[**Идмлкомпиледоператор**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) выполняется (или [**идмлоператоринитиализер**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer) , если выполняется инициализация оператора).</span><span class="sxs-lookup"><span data-stu-id="b24eb-130">The [**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) being executed (or [**IDMLOperatorInitializer**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer) instead, if performing operator initialization).</span></span>
- <span data-ttu-id="b24eb-131">**Идмлкомпиледоператор** , который используется для привязки оператора к таблице привязки.</span><span class="sxs-lookup"><span data-stu-id="b24eb-131">The **IDMLCompiledOperator** backing the binding table being used to bind the operator.</span></span>
- <span data-ttu-id="b24eb-132">Объекты [**ID3D12Resource**](/windows/desktop/api/d3d12/nn-d3d12-id3d12resource) , привязанные как входные и выходные данные оператора.</span><span class="sxs-lookup"><span data-stu-id="b24eb-132">The [**ID3D12Resource**](/windows/desktop/api/d3d12/nn-d3d12-id3d12resource) objects bound as the inputs/outputs of the operator.</span></span>
- <span data-ttu-id="b24eb-133">Объекты **ID3D12Resource** , привязанные как постоянные и временные ресурсы, если это применимо.</span><span class="sxs-lookup"><span data-stu-id="b24eb-133">The **ID3D12Resource** objects bound as persistent and temporary resources, if applicable.</span></span>
- <span data-ttu-id="b24eb-134">[**ID3D12CommandAllocator**](/windows/desktop/api/d3d12/nn-d3d12-id3d12commandallocator) создает резервную копию списка команд.</span><span class="sxs-lookup"><span data-stu-id="b24eb-134">The [**ID3D12CommandAllocator**](/windows/desktop/api/d3d12/nn-d3d12-id3d12commandallocator) backing the command list itself.</span></span>

<span data-ttu-id="b24eb-135">Не все интерфейсы Директмл представляют ресурсы GPU.</span><span class="sxs-lookup"><span data-stu-id="b24eb-135">Not all DirectML interfaces represent GPU resources.</span></span> <span data-ttu-id="b24eb-136">Например, таблицу привязки не нужно хранить в активном состоянии, пока все диспетчеризации, использующие ее, *не* завершили выполнение на GPU.</span><span class="sxs-lookup"><span data-stu-id="b24eb-136">For example, a binding table does *not* need to be kept alive until all dispatches using it have completed execution on the GPU.</span></span> <span data-ttu-id="b24eb-137">Это обусловлено тем, что сама таблица привязки не владеет ресурсами GPU.</span><span class="sxs-lookup"><span data-stu-id="b24eb-137">That's because the binding table itself doesn't own any GPU resources.</span></span> <span data-ttu-id="b24eb-138">Напротив, куча дескрипторов делает.</span><span class="sxs-lookup"><span data-stu-id="b24eb-138">Rather, the descriptor heap does.</span></span> <span data-ttu-id="b24eb-139">Таким образом, базовая *куча дескрипторов* — это объект, который должен оставаться активным до завершения выполнения, а не саму таблицу привязки.</span><span class="sxs-lookup"><span data-stu-id="b24eb-139">Therefore, the underlying *descriptor heap* is the object that must be kept alive until execution completes, and not the binding table itself.</span></span>

<span data-ttu-id="b24eb-140">Аналогичная концепция существует в Direct3D 12.</span><span class="sxs-lookup"><span data-stu-id="b24eb-140">A similar concept exists in Direct3D 12.</span></span> <span data-ttu-id="b24eb-141">*Распределитель* команд должен оставаться активным до тех пор, пока все выполнения, использующие его, не будут завершены на GPU. так как он владеет памятью GPU.</span><span class="sxs-lookup"><span data-stu-id="b24eb-141">A command *allocator* must be kept alive until all executions using it have completed on the GPU; since it owns GPU memory.</span></span> <span data-ttu-id="b24eb-142">Однако *список* команд не владеет памятью GPU, поэтому его можно сбросить или освободить сразу же после отправки для выполнения.</span><span class="sxs-lookup"><span data-stu-id="b24eb-142">But, a command *list* doesn't own GPU memory, so it can therefore be reset or released as soon as it's been submitted for execution.</span></span>

<span data-ttu-id="b24eb-143">В Директмл скомпилированные операторы ([**идмлкомпиледоператор**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator)) и инициализаторы операторов ([**идмлоператоринитиализер**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer)) напрямую являются ресурсами GPU, поэтому они должны оставаться в активном состоянии до тех пор, пока все диспетчеризации, использующие их, не завершат выполнение на GPU.</span><span class="sxs-lookup"><span data-stu-id="b24eb-143">In DirectML, compiled operators ([**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator)) and operator initializers ([**IDMLOperatorInitializer**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer)) both own GPU resources directly, so they must be kept alive until all dispatches using them have completed execution on the GPU.</span></span> <span data-ttu-id="b24eb-144">Кроме того, все используемые ресурсы Direct3D 12 (распределителя команд, кучи дескрипторов, буферы и т. д.) также должны храниться в активном приложении.</span><span class="sxs-lookup"><span data-stu-id="b24eb-144">In addition, any Direct3D 12 resource being used (command allocators, descriptor heaps, buffers, as examples) must similarly be kept alive by your application.</span></span>

<span data-ttu-id="b24eb-145">Если вы преждевременно выпустили объект, когда он по-прежнему используется GPU, результат является неопределенным поведением, что может вызвать удаление устройства или другие ошибки.</span><span class="sxs-lookup"><span data-stu-id="b24eb-145">If you prematurely release an object while it's still in use by the GPU, the result is undefined behavior, which has the potential to cause device removal or other errors.</span></span>

## <a name="cpu-and-gpu-synchronization"></a><span data-ttu-id="b24eb-146">Синхронизация ЦП и GPU</span><span class="sxs-lookup"><span data-stu-id="b24eb-146">CPU and GPU synchronization</span></span>

<span data-ttu-id="b24eb-147">Директмл сам по себе не отправляет никаких операций для выполнения на GPU.</span><span class="sxs-lookup"><span data-stu-id="b24eb-147">DirectML doesn't itself submit any work for execution on the GPU.</span></span> <span data-ttu-id="b24eb-148">Вместо этого метод [ **идмлкоммандрекордер:: рекорддиспатч**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) *записывает* данные об отправке этой работы в список команд для последующего выполнения.</span><span class="sxs-lookup"><span data-stu-id="b24eb-148">Instead, the [**IDMLCommandRecorder::RecordDispatch** method](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) *records* the dispatch of that work into a command list for later execution.</span></span> <span data-ttu-id="b24eb-149">Приложение должно закрыться и отправить список команд для выполнения, вызвав [**ID3D12CommandQueue:: ексекутекоммандлистс**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-executecommandlists), как и любой список команд Direct3D 12.</span><span class="sxs-lookup"><span data-stu-id="b24eb-149">Your application must then close and submit its command list for execution by calling [**ID3D12CommandQueue::ExecuteCommandLists**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-executecommandlists), as with any Direct3D 12 command list.</span></span>

<span data-ttu-id="b24eb-150">Поскольку Директмл сам по себе не отправляет никаких операций на выполнение на GPU, он также не создает никаких ограждений и не выполняет синхронизацию ЦП и GPU от вашего имени.</span><span class="sxs-lookup"><span data-stu-id="b24eb-150">Because DirectML doesn't itself submit any work for execution on the GPU, it also doesn't create any fences, nor perform any form of CPU/GPU synchronization on your behalf.</span></span> <span data-ttu-id="b24eb-151">Приложение обязано использовать соответствующие примитивы Direct3D 12 для ожидания выполнения отправленной работы на GPU, если это необходимо.</span><span class="sxs-lookup"><span data-stu-id="b24eb-151">It is the responsibility of your application to use the appropriate Direct3D 12 primitives to wait for submitted work to complete execution on the GPU, if necessary.</span></span> <span data-ttu-id="b24eb-152">Дополнительные сведения см. в разделе [**ID3D12Fence**](/windows/desktop/api/d3d12/nn-d3d12-id3d12fence) and [**ID3D12CommandQueue:: Signal**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-signal).</span><span class="sxs-lookup"><span data-stu-id="b24eb-152">For more info, see [**ID3D12Fence**](/windows/desktop/api/d3d12/nn-d3d12-id3d12fence) and [**ID3D12CommandQueue::Signal**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-signal).</span></span>

## <a name="see-also"></a><span data-ttu-id="b24eb-153">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="b24eb-153">See also</span></span>

* [<span data-ttu-id="b24eb-154">Исполнение и синхронизация списков команд</span><span class="sxs-lookup"><span data-stu-id="b24eb-154">Executing and synchronizing command lists</span></span>](/windows/desktop/direct3d12/executing-and-synchronizing-command-lists)
* [<span data-ttu-id="b24eb-155">Обработка ошибок и удаление устройств в Директмл</span><span class="sxs-lookup"><span data-stu-id="b24eb-155">Handling errors and device removal in DirectML</span></span>](dml-errors.md)