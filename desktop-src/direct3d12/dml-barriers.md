---
title: UAV барьеры и барьеры состояния ресурсов в Директмл
description: Описываются преимущества барьеров и способы работы с ними в Директмл.
ms.custom: Windows 10 May 2019 Update
ms.localizationpriority: high
ms.topic: article
ms.date: 04/19/2019
ms.openlocfilehash: 9bfc93d4fb28cff5d7d196287c6573e3e494d1d5
ms.sourcegitcommit: cba7f424a292fd7f3a8518947b9466439b455419
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/23/2019
ms.locfileid: "104548975"
---
# <a name="uav-barriers-and-resource-state-barriers-in-directml"></a><span data-ttu-id="310db-103">UAV барьеры и барьеры состояния ресурсов в Директмл</span><span class="sxs-lookup"><span data-stu-id="310db-103">UAV barriers and resource state barriers in DirectML</span></span>

## <a name="unordered-access-view-uav-barrier-requirements"></a><span data-ttu-id="310db-104">Требования к барьеру неупорядоченного представления доступа (UAV)</span><span class="sxs-lookup"><span data-stu-id="310db-104">Unordered Access View (UAV) barrier requirements</span></span>

### <a name="uav-barriers-in-direct3d-12"></a><span data-ttu-id="310db-105">UAV барьеры в Direct3D 12</span><span class="sxs-lookup"><span data-stu-id="310db-105">UAV barriers in Direct3D 12</span></span>

<span data-ttu-id="310db-106">В Direct3D 12 смежные выходящие от вычислений шейдеры в одном и том же списке команд могут выполняться параллельно на GPU, если они не синхронизированы с промежуточным барьером неупорядоченного представления доступа (UAV).</span><span class="sxs-lookup"><span data-stu-id="310db-106">In Direct3D 12, adjacent compute shader dispatches within the same command list are permitted to execute in parallel on the GPU unless they're synchronized with an intervening unordered access view (UAV) barrier.</span></span> <span data-ttu-id="310db-107">Это может повысить производительность, увеличивая использование оборудования GPU.</span><span class="sxs-lookup"><span data-stu-id="310db-107">This can improve performance by increasing utilization of GPU hardware.</span></span> <span data-ttu-id="310db-108">Однако по умолчанию без UAV барьера параллельное выполнение двух смежных отправок может вызвать состояние гонки, если существует зависимость данных между двумя отправкой. или, если обе диспетчеризации выполняют UAV запись в одни и те же области памяти.</span><span class="sxs-lookup"><span data-stu-id="310db-108">However, by default, without the use of a UAV barrier, the parallel execution of two adjacent dispatches can cause a race condition if there exists a data dependency between the two dispatches; or if both dispatches perform UAV writes to the same regions of memory.</span></span>

<span data-ttu-id="310db-109">UAV барьер принудительно записывает все ранее отправленные диспетчеризации для завершения выполнение на GPU, прежде чем могут начаться последующие диспетчеризации.</span><span class="sxs-lookup"><span data-stu-id="310db-109">A UAV barrier forces all previously-submitted dispatches to complete exection on the GPU before subsequent dispatches may begin.</span></span> <span data-ttu-id="310db-110">UAV барьеры используются для синхронизации отправок в одном списке команд во избежание состязания данных.</span><span class="sxs-lookup"><span data-stu-id="310db-110">UAV barriers are used to synchronize between dispatches on the same command list to avoid data races.</span></span> <span data-ttu-id="310db-111">UAV барьер можно выдать с помощью [метода **ID3D12GraphicsCommandList:: ресаурцебарриер**](/windows/desktop/api/d3d12/nf-d3d12-id3d12graphicscommandlist-resourcebarrier).</span><span class="sxs-lookup"><span data-stu-id="310db-111">You can issue a UAV barrier by using the [**ID3D12GraphicsCommandList::ResourceBarrier** method](/windows/desktop/api/d3d12/nf-d3d12-id3d12graphicscommandlist-resourcebarrier).</span></span>

### <a name="uav-barriers-in-directml"></a><span data-ttu-id="310db-112">UAV барьеры в Директмл</span><span class="sxs-lookup"><span data-stu-id="310db-112">UAV barriers in DirectML</span></span>

<span data-ttu-id="310db-113">В Директмл операторы отправляются способом, похожим на способ отправки шейдеров вычислений в Direct3D 12.</span><span class="sxs-lookup"><span data-stu-id="310db-113">In DirectML, operators are dispatched in a way that's similar to the way compute shaders are dispatched in Direct3D 12.</span></span> <span data-ttu-id="310db-114">То есть смежные диспетчеризации операторов могут выполняться параллельно на GPU, если между ними не существует промежуточного барьера UAV.</span><span class="sxs-lookup"><span data-stu-id="310db-114">That is, adjacent dispatches of operators are permitted to execute in parallel on the GPU unless there exists an intervening UAV barrier between them.</span></span> <span data-ttu-id="310db-115">Типичная модель машинного обучения содержит зависимости данных между операторами. Например, выходные данные одного оператора поступают на вход другого.</span><span class="sxs-lookup"><span data-stu-id="310db-115">A typical machine learning model contains data dependencies between its operators; for instance, the output of one operator feeds into the input of another.</span></span> <span data-ttu-id="310db-116">Поэтому важно использовать UAV барьеры для правильной синхронизации диспетчеризации.</span><span class="sxs-lookup"><span data-stu-id="310db-116">It's therefore important to use UAV barriers to correctly synchronize dispatches.</span></span>

<span data-ttu-id="310db-117">Директмл гарантирует, что он будет только читать из входных десятков (и никогда не записывать в него).</span><span class="sxs-lookup"><span data-stu-id="310db-117">DirectML guarantees that it will only ever read from (and never write to) input tensors.</span></span> <span data-ttu-id="310db-118">Также гарантируется, что он никогда не будет производить запись в выходной тензорные вне диапазона тензорные элемента [**DML_BUFFER_TENSOR_DESC:: тоталтенсорсизеинбитес**](/windows/desktop/api/directml/ns-directml-dml_buffer_tensor_desc) .</span><span class="sxs-lookup"><span data-stu-id="310db-118">It also guarantees that it will never manufacture writes to an output tensor outside the range of the tensor's [**DML_BUFFER_TENSOR_DESC::TotalTensorSizeInBytes**](/windows/desktop/api/directml/ns-directml-dml_buffer_tensor_desc) member.</span></span> <span data-ttu-id="310db-119">Это означает, что зависимости данных между операторами в Директмл можно получить, изучив только входные и выходные привязки оператора.</span><span class="sxs-lookup"><span data-stu-id="310db-119">This means that data dependencies between operators in DirectML can be reasoned about by looking only at an operator's input and output bindings.</span></span>

<span data-ttu-id="310db-120">Например, эти гарантии позволяют отправлять два оператора, связывающих один и тот же регион ресурса в качестве входных данных, без необходимости выдавать промежуточный барьер UAV.</span><span class="sxs-lookup"><span data-stu-id="310db-120">For example, these guarantees allow you to dispatch two operators that bind the same region of a resource as an input, without having to issue an intervening UAV barrier.</span></span> <span data-ttu-id="310db-121">Это всегда является надежным, так как Директмл никогда не выполняет запись в десятки входных данных.</span><span class="sxs-lookup"><span data-stu-id="310db-121">This is always safe because DirectML never writes to input tensors.</span></span> <span data-ttu-id="310db-122">В качестве другого примера можно всегда привязывать выходные десятки двух параллельных операторов к одному и тому же ресурсу Direct3D 12 (если их десятки не пересекаются), так как Директмл никогда не выполняет запись вне границ тензорные (как определено в тензорные **DML_BUFFER_TENSOR_DESC:: тоталтенсорсизеинбитес**).</span><span class="sxs-lookup"><span data-stu-id="310db-122">As another example, it's always safe to bind the output tensors of two concurrent operator dispatches to the same Direct3D 12 resource (so long as their tensors don't overlap), because DirectML never writes outside the bounds of a tensor (as defined by the tensor's **DML_BUFFER_TENSOR_DESC::TotalTensorSizeInBytes**).</span></span>

<span data-ttu-id="310db-123">Так как UAV барьеры — это форма синхронизации, необязательное использование UAV барьеров может негативно сказаться на производительности.</span><span class="sxs-lookup"><span data-stu-id="310db-123">As UAV barriers are a form of synchronization, unnecessary use of UAV barriers might negatively impact performance.</span></span> <span data-ttu-id="310db-124">Поэтому лучше использовать минимальное количество UAV барьеров, необходимых для правильной синхронизации расотправлений в списке команд.</span><span class="sxs-lookup"><span data-stu-id="310db-124">Therefore, it's best for you to use the minimum number of UAV barriers necessary to correctly synchronize the dispatches within a command list.</span></span>

### <a name="example-1"></a><span data-ttu-id="310db-125">Пример 1</span><span class="sxs-lookup"><span data-stu-id="310db-125">Example 1</span></span>

<span data-ttu-id="310db-126">В следующем примере выходные данные оператора свертки поступают в Релуную активацию, за которой следует нормализация пакета.</span><span class="sxs-lookup"><span data-stu-id="310db-126">In the following example, a convolution operator's output is fed into a ReLU activation, followed by a batch normalization.</span></span>

```console
    CONVOLUTION (conv1)
         |
  ACTIVATION_RELU (relu1)
         |
BATCH_NORMALIZATION (batch1)
```

<span data-ttu-id="310db-127">Поскольку между всеми тремя операторами существует зависимость данных, вам потребуется UAV барьер между каждой последующей отправкой (см. [**идмлкоммандрекордер:: рекорддиспатч**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch)).</span><span class="sxs-lookup"><span data-stu-id="310db-127">Since a data dependency exists between all three operators, you'll need a UAV barrier between each successive dispatch (see [**IDMLCommandRecorder::RecordDispatch**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch)).</span></span>

1. <span data-ttu-id="310db-128">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**conv1**`)`</span><span class="sxs-lookup"><span data-stu-id="310db-128">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**conv1**`)`</span></span>
2. <span data-ttu-id="310db-129">`d3d12CommandList->ResourceBarrier(`**UAV барьер**`)`</span><span class="sxs-lookup"><span data-stu-id="310db-129">`d3d12CommandList->ResourceBarrier(`**UAV barrier**`)`</span></span>
3. <span data-ttu-id="310db-130">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**relu1**`)`</span><span class="sxs-lookup"><span data-stu-id="310db-130">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**relu1**`)`</span></span>
4. <span data-ttu-id="310db-131">`d3d12CommandList->ResourceBarrier(`**UAV барьер**`)`</span><span class="sxs-lookup"><span data-stu-id="310db-131">`d3d12CommandList->ResourceBarrier(`**UAV barrier**`)`</span></span>
5. <span data-ttu-id="310db-132">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**batch1**`)`</span><span class="sxs-lookup"><span data-stu-id="310db-132">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**batch1**`)`</span></span>

### <a name="example-2"></a><span data-ttu-id="310db-133">Пример 2</span><span class="sxs-lookup"><span data-stu-id="310db-133">Example 2</span></span>

```console
     MAX_POOLING (pool1)
        /    \
CONVOLUTION  CONVOLUTION
  (conv1)      (conv2)
        \    /
         JOIN (join1)
```

<span data-ttu-id="310db-134">Здесь выходные данные пула передаются в два свертки, выходные данные которых затем объединяются с помощью оператора JOIN.</span><span class="sxs-lookup"><span data-stu-id="310db-134">Here the output of pooling is fed into two convolutions, whose outputs are then concatenated together using the JOIN operator.</span></span> <span data-ttu-id="310db-135">Зависимость данных существует между `pool1` и `conv1` и, и `conv2` ;, а также между `conv1` и и `conv2` `join1` .</span><span class="sxs-lookup"><span data-stu-id="310db-135">A data dependency exists between `pool1` and both `conv1` and `conv2`; as well as between both `conv1` and `conv2` and `join1`.</span></span> <span data-ttu-id="310db-136">Вот один из допустимых способов выполнения этого графа.</span><span class="sxs-lookup"><span data-stu-id="310db-136">Here's one valid way to execute this graph.</span></span>

1. <span data-ttu-id="310db-137">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**pool1**`)`</span><span class="sxs-lookup"><span data-stu-id="310db-137">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**pool1**`)`</span></span>
2. <span data-ttu-id="310db-138">`d3d12CommandList->ResourceBarrier(`**UAV барьер**`)`</span><span class="sxs-lookup"><span data-stu-id="310db-138">`d3d12CommandList->ResourceBarrier(`**UAV barrier**`)`</span></span>
3. <span data-ttu-id="310db-139">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**conv1**`)`</span><span class="sxs-lookup"><span data-stu-id="310db-139">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**conv1**`)`</span></span>
4. <span data-ttu-id="310db-140">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**conv2**`)`</span><span class="sxs-lookup"><span data-stu-id="310db-140">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**conv2**`)`</span></span>
5. <span data-ttu-id="310db-141">`d3d12CommandList->ResourceBarrier(`**UAV барьер**`)`</span><span class="sxs-lookup"><span data-stu-id="310db-141">`d3d12CommandList->ResourceBarrier(`**UAV barrier**`)`</span></span>
6. <span data-ttu-id="310db-142">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**join1**`)`</span><span class="sxs-lookup"><span data-stu-id="310db-142">`dmlCommandRecorder->RecordDispatch(d3d12CommandList, `**join1**`)`</span></span>

<span data-ttu-id="310db-143">В этом случае `conv1` и `conv2` могут одновременно выполняться на GPU, что может повысить производительность.</span><span class="sxs-lookup"><span data-stu-id="310db-143">In this case, `conv1` and `conv2` are able to execute concurrently on the GPU, which may improve performance.</span></span>

## <a name="resource-barrier-state-requirements"></a><span data-ttu-id="310db-144">Требования к состоянию барьера ресурсов</span><span class="sxs-lookup"><span data-stu-id="310db-144">Resource barrier state requirements</span></span>

<span data-ttu-id="310db-145">Как вызывающий объект, вы обязаны убедиться, что все ресурсы Direct3D 12 находятся в правильном состоянии барьера ресурсов перед выполнением Директмл диспетчеризации на GPU.</span><span class="sxs-lookup"><span data-stu-id="310db-145">As the caller, it's your responsibility to ensure that all Direct3D 12 resources are in the correct resource barrier state prior to executing DirectML dispatches on the GPU.</span></span> <span data-ttu-id="310db-146">Директмл не выполняет никаких препятствий перехода от вашего имени.</span><span class="sxs-lookup"><span data-stu-id="310db-146">DirectML doesn't perform any transition barriers on your behalf.</span></span>

<span data-ttu-id="310db-147">Перед выполнением [**идмлкоммандрекордер:: рекорддиспатч**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) на GPU необходимо перевести все привязанные ресурсы в состояние **D3D12_RESOURCE_STATE_UNORDERED_ACCESS** или в состояние, неявное повышение до **D3D12_RESOURCE_STATE_UNORDERED_ACCESS**, например **D3D12_RESOURCE_STATE_COMMON**.</span><span class="sxs-lookup"><span data-stu-id="310db-147">Prior to execution of [**IDMLCommandRecorder::RecordDispatch**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) on the GPU, you must transition all bound resources to the **D3D12_RESOURCE_STATE_UNORDERED_ACCESS** state, or to a state implicitly promotable to **D3D12_RESOURCE_STATE_UNORDERED_ACCESS**, such as **D3D12_RESOURCE_STATE_COMMON**.</span></span> <span data-ttu-id="310db-148">После завершения этого вызова ресурсы остаются в состоянии **D3D12_RESOURCE_STATE_UNORDERED_ACCESS** .</span><span class="sxs-lookup"><span data-stu-id="310db-148">After this call completes, the resources remain in the **D3D12_RESOURCE_STATE_UNORDERED_ACCESS** state.</span></span> <span data-ttu-id="310db-149">Дополнительные сведения см. [в разделе Привязка в директмл](dml-binding.md).</span><span class="sxs-lookup"><span data-stu-id="310db-149">For more details, see [Binding in DirectML](dml-binding.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="310db-150">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="310db-150">See also</span></span>

* [<span data-ttu-id="310db-151">Использование барьеров ресурсов для синхронизации состояний ресурсов в Direct3D 12</span><span class="sxs-lookup"><span data-stu-id="310db-151">Using resource barriers to synchronize resource states in Direct3D 12</span></span>](/windows/desktop/direct3d12/using-resource-barriers-to-synchronize-resource-states-in-direct3d-12)
* [<span data-ttu-id="310db-152">Привязывание в DirectML</span><span class="sxs-lookup"><span data-stu-id="310db-152">Binding in DirectML</span></span>](dml-binding.md)
