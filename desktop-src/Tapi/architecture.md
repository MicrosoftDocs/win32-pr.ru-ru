---
description: На следующем рисунке показана общая архитектура поставщиков услуг телефонии и связанных с ними библиотек динамической компоновки пользовательского интерфейса (библиотеки DLL ПОЛЬЗОВАТЕЛЬСКОГО интерфейса).
ms.assetid: b5efe57a-19b8-49c5-810f-180633ed50d2
title: Архитектура (API телефонии)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 14423dba77af1ded38af4a6f2b896e76d28ca2cd
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105683425"
---
# <a name="architecture-telephony-api"></a><span data-ttu-id="aac1f-103">Архитектура (API телефонии)</span><span class="sxs-lookup"><span data-stu-id="aac1f-103">Architecture (Telephony API)</span></span>

<span data-ttu-id="aac1f-104">На следующем рисунке показана общая архитектура поставщиков услуг телефонии и связанных с ними библиотек динамической компоновки пользовательского интерфейса (библиотеки DLL ПОЛЬЗОВАТЕЛЬСКОГО интерфейса).</span><span class="sxs-lookup"><span data-stu-id="aac1f-104">The following illustration shows the general architecture of telephony service providers and their associated user interface dynamic-link libraries (UI DLLs).</span></span>

![специалистами и связанные библиотеки DLL пользовательского интерфейса](images/spuidl01.png)

<span data-ttu-id="aac1f-106">Поставщик услуг состоит из как минимум двух компонентов.</span><span class="sxs-lookup"><span data-stu-id="aac1f-106">The service provider consists of a minimum of two components.</span></span> <span data-ttu-id="aac1f-107">Библиотека DLL поставщика услуг (которая указана на рисунке как основная. TSP) выполняется в контексте процесса ТАПИСРВ и выполняет все задачи поставщика услуг, которые не связаны с элементами пользовательского интерфейса, связанными с использованием конкретного приложения устройства (скорее всего, в сочетании с компонентами более низкого уровня, не показанными на рисунке).</span><span class="sxs-lookup"><span data-stu-id="aac1f-107">The service provider DLL (designated in the illustration as MAIN.TSP) executes in the context of the TAPISRV process, and performs all of the tasks of the service provider that are not related to user interface elements associated with a particular application's use of the device (most likely, in conjunction with lower-level components not shown in the illustration).</span></span> <span data-ttu-id="aac1f-108">Но в отличие от предыдущих версий TAPI, в которых код пользовательского интерфейса был интегрирован в поставщик услуг (и выполняется из-за предыдущей архитектуры, в контексте приложения), поставщик услуг должен иметь отдельный компонент, реализующий элементы пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="aac1f-108">But unlike previous versions of TAPI in which the user interface code was integrated into the service provider (and executed, because of the previous architecture, within the context of the application), the service provider must now include a separate component that implements the user interface elements.</span></span>

<span data-ttu-id="aac1f-109">Библиотека DLL пользовательского интерфейса поставщика услуг должна экспортировать функции, вызываемые TAPI, когда приложение вызывает функции TAPI, генерирующие пользовательский интерфейс: [**туиспи \_ линеконфигдиалог**](/windows/win32/api/tspi/nf-tspi-tuispi_lineconfigdialog), [**туиспи \_ линеконфигдиаложедит**](/windows/win32/api/tspi/nf-tspi-tuispi_lineconfigdialogedit), [**туиспи \_ Фонеконфигдиалог**](/windows/win32/api/tspi/nf-tspi-tuispi_phoneconfigdialog), [**туиспи \_ providerConfig**](/windows/win32/api/tspi/nf-tspi-tuispi_providerconfig), [**TUISPI \_ providerInstall**](/windows/win32/api/tspi/nf-tspi-tuispi_providerinstall)и [**TUISPI \_ providerRemove**](/windows/win32/api/tspi/nf-tspi-tuispi_providerremove).</span><span class="sxs-lookup"><span data-stu-id="aac1f-109">The service provider UI DLL must export functions that are called by TAPI when the application calls TAPI functions that generate UI: [**TUISPI\_lineConfigDialog**](/windows/win32/api/tspi/nf-tspi-tuispi_lineconfigdialog), [**TUISPI\_lineConfigDialogEdit**](/windows/win32/api/tspi/nf-tspi-tuispi_lineconfigdialogedit), [**TUISPI\_phoneConfigDialog**](/windows/win32/api/tspi/nf-tspi-tuispi_phoneconfigdialog), [**TUISPI\_providerConfig**](/windows/win32/api/tspi/nf-tspi-tuispi_providerconfig), [**TUISPI\_providerInstall**](/windows/win32/api/tspi/nf-tspi-tuispi_providerinstall), and [**TUISPI\_providerRemove**](/windows/win32/api/tspi/nf-tspi-tuispi_providerremove).</span></span> <span data-ttu-id="aac1f-110">Каждая из этих функций включает в качестве параметра указатель на функцию обратного вызова в TAPI типа [**туиспидллкаллбакк**](/windows/win32/api/tspi/nc-tspi-tuispidllcallback), которую библиотека DLL пользовательского интерфейса может использовать для двунаправленной связи (как для отправки, так и для получения данных) с помощью библиотеки DLL поставщика услуг, которая выполняется в процессе таписрв.</span><span class="sxs-lookup"><span data-stu-id="aac1f-110">Each of these functions includes as a parameter a pointer to a callback function in TAPI, of type [**TUISPIDLLCALLBACK**](/windows/win32/api/tspi/nc-tspi-tuispidllcallback), which the UI DLL can use to communicate bidirectionally (both send and receive data) with the service provider DLL executing in the TAPISRV process.</span></span> <span data-ttu-id="aac1f-111">Если поставщик услуг создает некачественный пользовательский интерфейс, например диалоговое окно "Обмен **данными/разрывом** Unimodem", в сочетании с любой функцией тспи, для которой не ожидается пользовательский интерфейс (например, любая функция, не имеющая параметра *HWND* ), то библиотека DLL пользовательского интерфейса должна экспортировать [**туиспи \_ провидерженерикдиалог**](/windows/win32/api/tspi/nf-tspi-tuispi_providergenericdialog) и [**туиспи \_ провидерженерикдиалогдата**](/windows/win32/api/tspi/nf-tspi-tuispi_providergenericdialogdata).</span><span class="sxs-lookup"><span data-stu-id="aac1f-111">If the service provider ever generates spontaneous UI, such as the Unimodem **Talk/Hangup** dialog box, in conjunction with any TSPI function for which UI is not expected (for example, any function that does not have an *hwnd* parameter), then the UI DLL must export [**TUISPI\_providerGenericDialog**](/windows/win32/api/tspi/nf-tspi-tuispi_providergenericdialog) and [**TUISPI\_providerGenericDialogData**](/windows/win32/api/tspi/nf-tspi-tuispi_providergenericdialogdata).</span></span>

> [!Note]  
> <span data-ttu-id="aac1f-112">Первоначальные функции создания пользовательского интерфейса ТСПИ ( [**тспи \_ линеконфигдиалог**](/windows/win32/api/tspi/nf-tspi-tspi_lineconfigdialog), [**тспи \_ линеконфигдиаложедит**](/windows/win32/api/tspi/nf-tspi-tspi_lineconfigdialogedit), [**тспи \_ Фонеконфигдиалог**](/windows/win32/api/tspi/nf-tspi-tspi_phoneconfigdialog), [**тспи \_ провидерконфиг**](/windows/win32/api/tspi/nf-tspi-tspi_providerconfig), [**TSPI \_ providerInstall**](/windows/win32/api/tspi/nf-tspi-tspi_providerinstall)и [**TSPI \_ providerRemove**](/windows/win32/api/tspi/nf-tspi-tspi_providerremove)) являются устаревшими и никогда не вызываются TAPI.</span><span class="sxs-lookup"><span data-stu-id="aac1f-112">The original TSPI UI-generating functions ( [**TSPI\_lineConfigDialog**](/windows/win32/api/tspi/nf-tspi-tspi_lineconfigdialog), [**TSPI\_lineConfigDialogEdit**](/windows/win32/api/tspi/nf-tspi-tspi_lineconfigdialogedit), [**TSPI\_phoneConfigDialog**](/windows/win32/api/tspi/nf-tspi-tspi_phoneconfigdialog), [**TSPI\_providerConfig**](/windows/win32/api/tspi/nf-tspi-tspi_providerconfig), [**TSPI\_providerInstall**](/windows/win32/api/tspi/nf-tspi-tspi_providerinstall), and [**TSPI\_providerRemove**](/windows/win32/api/tspi/nf-tspi-tspi_providerremove)) are obsolete and never called by TAPI.</span></span> <span data-ttu-id="aac1f-113">Поэтому они не должны экспортироваться БИБЛИОТЕКой поставщика услуг.</span><span class="sxs-lookup"><span data-stu-id="aac1f-113">Therefore, these are not required to be exported by the service provider DLL.</span></span> <span data-ttu-id="aac1f-114">Однако, если поставщик услуг должен быть указан в списке, который можно добавить с помощью панели управления телефонии, служебная программа, предоставляемая с телефонией Windows в версии 1,4 и более ранних версиях, она должна экспортировать **тспи \_ провидеринсталл**; если на панели управления телефонии требуется включить кнопку [**Удалить**](/windows/win32/api/tapi3if/nn-tapi3if-itcollection2) , то необходимо экспортировать **Тспи \_ Провидерремове**; и если на панели управления телефонии требуется включить кнопку **установки** , то необходимо экспортировать **тспи \_ провидерконфиг**.</span><span class="sxs-lookup"><span data-stu-id="aac1f-114">However, if the service provider wants to be listed as one that can be added by the Telephony Control Panel, a utility supplied with Windows Telephony in versions 1.4 and earlier, it must export **TSPI\_providerInstall**; if it wants to have the [**Remove**](/windows/win32/api/tapi3if/nn-tapi3if-itcollection2) button enabled in the Telephony Control Panel when it is selected, it must export **TSPI\_providerRemove**; and if it wants the **Setup** button to be enabled in the Telephony Control Panel when it is selected, it must export **TSPI\_providerConfig**.</span></span> <span data-ttu-id="aac1f-115">Панель управления телефонии проверяет наличие этих функций в файле TSP поставщика услуг, чтобы настроить его пользовательский интерфейс, чтобы отразить, какие операции можно выполнить.</span><span class="sxs-lookup"><span data-stu-id="aac1f-115">The Telephony Control Panel checks for the presence of these functions in the service provider TSP file to adjust its user interface to reflect which operations can be performed.</span></span>

 

<span data-ttu-id="aac1f-116">Библиотека DLL поставщика услуг должна экспортировать функцию [**тспи \_ провидеруиидентифи**](/windows/win32/api/tspi/nf-tspi-tspi_provideruiidentify) , которую таписрв процесс использует для получения имени DLL пользовательского интерфейса для загрузки в процессе приложения.</span><span class="sxs-lookup"><span data-stu-id="aac1f-116">The service provider DLL must export the [**TSPI\_providerUIIdentify**](/windows/win32/api/tspi/nf-tspi-tspi_provideruiidentify) function that TAPISRV process uses to obtain the name of the UI DLL to load in the application process.</span></span> <span data-ttu-id="aac1f-117">Она должна экспортировать функцию [**тспи \_ провидерженерикдиалогдата**](/windows/win32/api/tspi/nf-tspi-tspi_providergenericdialogdata) для получения и реагирования на запросы из библиотеки DLL пользовательского интерфейса для отображения данных, и она должна экспортировать [**тспи \_ провидерфридиалогинстанце**](/windows/win32/api/tspi/nf-tspi-tspi_providerfreedialoginstance) для таписрв процесса, чтобы сообщить поставщику услуг, когда следует освободить ассоциацию, установленную для создания неограниченного пользовательского интерфейса в сочетании с функцией, которая не определена как пользовательская функция для представления пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="aac1f-117">It must export the [**TSPI\_providerGenericDialogData**](/windows/win32/api/tspi/nf-tspi-tspi_providergenericdialogdata) function to receive and respond to requests from the UI DLL for data to display, and it must export [**TSPI\_providerFreeDialogInstance**](/windows/win32/api/tspi/nf-tspi-tspi_providerfreedialoginstance) for TAPISRV process to tell the service provider when to release an association established for the purpose of generating spontaneous UI in conjunction with a function that is not defined as presenting UI to the user.</span></span> <span data-ttu-id="aac1f-118">Библиотека DLL поставщика услуг может отсылать данные в библиотеку DLL пользовательского интерфейса с помощью новой строки сообщения ТСПИ [**\_ сенддиалогинстанцедата**](line-senddialoginstancedata.md).</span><span class="sxs-lookup"><span data-stu-id="aac1f-118">The service provider DLL can unidirectionally send data to the UI DLL by using the new TSPI message [**LINE\_SENDDIALOGINSTANCEDATA**](line-senddialoginstancedata.md).</span></span>

<span data-ttu-id="aac1f-119">Так как имена функций ТСПИ и ТУИСПИ намеренно определены как разные, при необходимости библиотека DLL поставщика услуг и библиотека DLL пользовательского интерфейса могут иметь один и тот же файл DLL.</span><span class="sxs-lookup"><span data-stu-id="aac1f-119">Because the names of the TSPI and TUISPI functions are intentionally defined to be different, the service provider DLL and the UI DLL can be the same DLL file, if desired.</span></span> <span data-ttu-id="aac1f-120">При правильном сегментации это не обязательно приводит к ненужному использованию памяти в контексте приложения и может упростить процесс установки для поставщиков услуг, которые в настоящее время могут быть реализованы в одной библиотеке DLL.</span><span class="sxs-lookup"><span data-stu-id="aac1f-120">With proper segmentation, this does not necessarily result in any unnecessary usage of memory in the application context, and can simplify the installation process for service providers that can currently be implemented in a single DLL.</span></span> <span data-ttu-id="aac1f-121">TAPI вызывает только те функции, которые подходят для контекста, в котором используется библиотека DLL.</span><span class="sxs-lookup"><span data-stu-id="aac1f-121">TAPI calls only the functions that are appropriate for the context in which the DLL is being used.</span></span>

<span data-ttu-id="aac1f-122">Поставщик услуг телефонии и библиотека DLL пользовательского интерфейса должны быть спроектированы с учетом требований, поэтому функции пользовательского интерфейса могут вызываться одновременно из нескольких процессов приложения.</span><span class="sxs-lookup"><span data-stu-id="aac1f-122">The telephony service provider and the UI DLL must both be designed with the requirement in mind that the UI functions can be invoked from multiple application processes simultaneously.</span></span> <span data-ttu-id="aac1f-123">Кроме того, необходимо учитывать, что приложение и служба TAPI, в рамках которой выполняется поставщик услуг телефонии, могут находиться на разных компьютерах в локальной сети.</span><span class="sxs-lookup"><span data-stu-id="aac1f-123">They must also consider that the application and the TAPI service under which the telephony service provider is executing can be on separate computers on a LAN.</span></span>

 

 
