---
description: Следующая процедура описывает, как реализовать MSP с помощью ATL версии 2,1 или ATL версии 3,0 и базовых классов MSP.
ms.assetid: 7485c34a-3c8a-412f-9cb9-8eb895084292
title: Использование базовых классов MSP TAPI 3
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: eb8ad4fd160cf0fc4c7dd682a44f3a4ff0bcec25
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105684492"
---
# <a name="using-the-tapi-3-msp-base-classes"></a><span data-ttu-id="f0b6a-103">Использование базовых классов MSP TAPI 3</span><span class="sxs-lookup"><span data-stu-id="f0b6a-103">Using The TAPI 3 MSP Base Classes</span></span>

<span data-ttu-id="f0b6a-104">Следующая процедура описывает, как реализовать MSP с помощью ATL версии 2,1 или ATL версии 3,0 и базовых классов MSP.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-104">The following procedure describes how to implement an MSP using ATL version 2.1 or ATL version 3.0 and the MSP base classes.</span></span> <span data-ttu-id="f0b6a-105">Дополнительные сведения и список библиотек и заголовков см. в разделе [базовые классы MSP TAPI 3](tapi-3-msp-base-classes.md).</span><span class="sxs-lookup"><span data-stu-id="f0b6a-105">For more information and a list of libraries and headers, see [TAPI 3 MSP Base Classes](tapi-3-msp-base-classes.md).</span></span> <span data-ttu-id="f0b6a-106">Содержимое этого раздела предполагает, что у разработчика есть опыт работы с ATL и COM, а также реализована реализация DLL-библиотек COM с помощью ATL.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-106">The content contained in this topic assumes that the developer has a working understanding of ATL and COM, and has experience implementing COM DLLs using ATL.</span></span>

<span data-ttu-id="f0b6a-107">**Реализация и MSP с помощью ATL 2,1 или ATL 3,0**</span><span class="sxs-lookup"><span data-stu-id="f0b6a-107">**To implement and MSP using ATL 2.1 or ATL 3.0**</span></span>

1.  <span data-ttu-id="f0b6a-108">Создайте IDL-файл для MSP.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-108">Create an IDL file for your MSP.</span></span> <span data-ttu-id="f0b6a-109">Этот файл определяет идентификатор CLSID для MSP.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-109">This file defines a CLSID for your MSP.</span></span> <span data-ttu-id="f0b6a-110">Объявите свой MSP "coclass" как реализацию интерфейса [**итмспаддресс**](/windows/desktop/api/msp/nn-msp-itmspaddress) и объявите этот интерфейс как интерфейс по умолчанию для объекта класса.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-110">Declare your MSP "coclass" as implementing the [**ITMSPAddress**](/windows/desktop/api/msp/nn-msp-itmspaddress) interface, and declare this interface as the default interface on your class object.</span></span> <span data-ttu-id="f0b6a-111">Для определения **итмспаддресс** импортируйте файл "MSP. idl".</span><span class="sxs-lookup"><span data-stu-id="f0b6a-111">For the definition of **ITMSPAddress**, import the file "msp.idl".</span></span> <span data-ttu-id="f0b6a-112">Включите в библиотеку типов MSP "coclass" для MSP.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-112">Include your MSP "coclass" in a type library for your MSP.</span></span> <span data-ttu-id="f0b6a-113">Если ваш MSP поддерживает частные (пользовательские) интерфейсы, определите их здесь и включите в библиотеку типов.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-113">If your MSP supports private (custom) interfaces, define them here and include them in your type library.</span></span> <span data-ttu-id="f0b6a-114">В следующем примере кода показан IDL-файл, как описано выше, без пользовательских интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-114">The following code example is an IDL file as described above, without custom interfaces.</span></span>

    ``` syntax
    import "msp.idl";
    [
          uuid(4DDB6D35-3BC1-11d2-86F2-006008B0E5D2),
          version(2.0),
          helpstring("Wave MSP 2.0 Type Library")
    ]
    library WAVEMSPLib
    {
    importlib("stdole32.tlb");
    importlib("stdole2.tlb");

    [
    uuid(4DDB6D36-3BC1-11d2-86F2-006008B0E5D2),
    helpstring("Wave MSP Class")
    ]
    coclass WaveMSP
    {
    [default] interface ITMSPAddress;
    };
    };
    ```

2.  <span data-ttu-id="f0b6a-115">Измените TSP, чтобы объявить CLSID MSP, когда Tapi3.dll запрашивает его.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-115">Modify your TSP to advertise the CLSID of your MSP when Tapi3.dll requests it.</span></span> <span data-ttu-id="f0b6a-116">Убедитесь, что (1) ваш TSP может согласовать TAPI \_ VERSION3 \_ 0 или выше в функции тспи [**тспи \_ линенеготиатетспиверсион**](/windows/win32/api/tspi/nf-tspi-tspi_linenegotiatetspiversion), (2) в структуре TSP [**линедевкапс**](/windows/win32/api/tapi/ns-tapi-linedevcaps) \_ задан флаг Линедевкапфлагс MSP, установленный в члене **ДВДЕВКАПФЛАГС** , и (3) ваш TSP Возвращает CLSID MSP в тспи функции [**\_**](/windows/win32/api/tspi/nf-tspi-tspi_linemspidentify)TSPI lineMSPIdentify.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-116">Ensure that (1) your TSP can negotiate TAPI\_VERSION3\_0 or higher in the TSPI function [**TSPI\_lineNegotiateTSPIVersion**](/windows/win32/api/tspi/nf-tspi-tspi_linenegotiatetspiversion), (2) your TSP [**LINEDEVCAPS**](/windows/win32/api/tapi/ns-tapi-linedevcaps) structure has the LINEDEVCAPFLAGS\_MSP flag set in the **dwDevCapFlags** member, and (3) your TSP returns your MSP CLSID in the TSPI function [**TSPI\_lineMSPIdentify**](/windows/win32/api/tspi/nf-tspi-tspi_linemspidentify).</span></span> <span data-ttu-id="f0b6a-117">Это должен быть тот же CLSID, указанный в файле IDL; Например, вторая строка UUID в примере IDL-файла на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-117">This should be the same CLSID specified in your IDL file; for example, the second "uuid" line in the example IDL file in the previous step.</span></span>
3.  <span data-ttu-id="f0b6a-118">Скомпилируйте пример приложения Мспбасе, расположенный в пакете SDK для платформы, чтобы создать библиотеку Мспбасесампле. lib.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-118">Compile the MSPBase sample application, located in the Platform Software Development Kit (SDK), to create the MSPBaseSample.lib library.</span></span>
4.  <span data-ttu-id="f0b6a-119">Свяжите библиотеку DLL MSP с библиотекой Мспбасесампле. lib.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-119">Link your MSP DLL with the MSPBaseSample.lib library.</span></span>
5.  <span data-ttu-id="f0b6a-120">Включите Мспбасе. h из пакета SDK для определения базового класса MSP.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-120">Include Mspbase.h from the SDK for MSP base class definitions.</span></span>
6.  <span data-ttu-id="f0b6a-121">Реализуйте экспортируемые библиотеки DLL (например, DllMain).</span><span class="sxs-lookup"><span data-stu-id="f0b6a-121">Implement your DLL exports (for example, DllMain).</span></span> <span data-ttu-id="f0b6a-122">Microsoft Visual C++ создаст их.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-122">Microsoft Visual C++ will generate these for you.</span></span> <span data-ttu-id="f0b6a-123">В DllMain, при \_ подключении к ПРОЦЕССУ DLL \_ и \_ \_ отсоединении процесса DLL, соответственно, используйте макросы **мсплогрегистер** и **мсплогдерегистер** , чтобы включить функции ведения журнала для библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-123">In DllMain, on DLL\_PROCESS\_ATTACH and DLL\_PROCESS\_DETACH, respectively, use the **MSPLOGREGISTER** and **MSPLOGDEREGISTER** macros to enable up logging features for your DLL.</span></span> <span data-ttu-id="f0b6a-124">Укажите имя библиотеки DLL в вызове **мсплогдерегистер** .</span><span class="sxs-lookup"><span data-stu-id="f0b6a-124">Specify the name of your DLL in the **MSPLOGDEREGISTER** call.</span></span>
7.  <span data-ttu-id="f0b6a-125">Используйте макрос LOG, определенный в Мсплог. h, для вывода сообщений трассировки таким же образом, как базовые классы.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-125">Use the LOG macro, defined in Msplog.h, to output trace messages in the same fashion as the base classes.</span></span> <span data-ttu-id="f0b6a-126">Определите символ препроцессора МСПЛОГ, чтобы включить ведение журнала в библиотеку DLL. Оставьте его неопределенным, чтобы создать библиотеку DLL без ведения журнала.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-126">Define the MSPLOG preprocessor symbol to include logging in your DLL; leave it undefined to build a DLL that does not have logging.</span></span>
8.  <span data-ttu-id="f0b6a-127">Создайте класс, производный от Кмспаддресс, который реализует адреса для MSP.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-127">Derive a class from CMSPAddress that implements addresses for your MSP.</span></span> <span data-ttu-id="f0b6a-128">Объявите глобальную карту объектов ATL, которая указывает ATL создать экземпляр класса Address при запросе **сосоздания** для идентификатора CLSID, УКАЗАННОГО в IDL-файле.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-128">Declare a global ATL object map which instructs ATL to create an instance of your address class when asked to **CoCreate** on the CLSID you specified in your IDL file.</span></span> <span data-ttu-id="f0b6a-129">Кроме того, создайте класс адресов из шаблона **CCOMCOCLASS** ATL и включите \_ объявление RESOURCEID реестра для объявления \_ в своем классе Address.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-129">Also, derive your address class from the ATL **CComCoClass** template, and include a DECLARE\_REGISTRY\_RESOURCEID declaration in your address class.</span></span> <span data-ttu-id="f0b6a-130">Создайте соответствующий скрипт ресурсов и файл заголовка, как для любой другой библиотеки DLL ATL COM.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-130">Construct a corresponding resource script and header file, as for any other ATL COM DLL.</span></span>
9.  <span data-ttu-id="f0b6a-131">Реализуйте необходимые переопределения Кмспаддресс для класса Address.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-131">Implement the required CMSPAddress overrides for your address class.</span></span> <span data-ttu-id="f0b6a-132">Для [**мспаддрессаддреф**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-mspaddressaddref) и [**мспаддрессрелеасе**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-mspaddressrelease)вызовите предоставленные шаблоны вспомогательной функции.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-132">For [**MSPAddressAddRef**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-mspaddressaddref) and [**MSPAddressRelease**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-mspaddressrelease), call the provided helper function templates.</span></span> <span data-ttu-id="f0b6a-133">Для [**жеткаллмедиатипес**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-getcallmediatypes)просто верните точечный рисунок **DWORD** со всеми поддерживаемыми MSP тапимедиамодес ORed.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-133">For [**GetCallMediaTypes**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-getcallmediatypes), simply return a **DWORD** bitmap with all of your MSP-supported TAPIMEDIAMODEs ORed together.</span></span> <span data-ttu-id="f0b6a-134">В этом месте [**креатемспкалл**](/windows/desktop/api/msp/nf-msp-itmspaddress-createmspcall) и [**Шутдовнмспкалл**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdownmspcall)возвращают E \_ нотимпл и компилируются и связывают ваш MSP.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-134">For [**CreateMSPCall**](/windows/desktop/api/msp/nf-msp-itmspaddress-createmspcall) and [**ShutdownMSPCall**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdownmspcall), return E\_NOTIMPL and compile and link your MSP at this point.</span></span> <span data-ttu-id="f0b6a-135">Теперь убедитесь, что вы можете зарегистрировать и создать экземпляр MSP из приложений TAPI 3, но не удалось успешно создать вызовы.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-135">Now, verify that you can register and instantiate your MSP from TAPI 3 applications, but not successfully create calls.</span></span>
10. <span data-ttu-id="f0b6a-136">Создайте класс, производный от Кмспкаллмултиграф, для реализации объектов вызова MSP.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-136">Derive a class from CMSPCallMultiGraph to implement your MSP call objects.</span></span> <span data-ttu-id="f0b6a-137">Вы можете последовать от [**кмспкаллбасе**](/windows/desktop/api/Mspcall/nl-mspcall-cmspcallbase) вместо [**кмспкаллмултиграф**](/windows/desktop/api/Mspcall/nl-mspcall-cmspcallmultigraph) , если модель фильтра-Graph-for-Stream не соответствует вашим требованиям. Это увеличит сложность задачи (на момент написания этой статьи все MSP наследуют объекты вызова непосредственно из **кмспкаллмултиграф**).</span><span class="sxs-lookup"><span data-stu-id="f0b6a-137">You may want to derive from [**CMSPCallBase**](/windows/desktop/api/Mspcall/nl-mspcall-cmspcallbase) instead of [**CMSPCallMultiGraph**](/windows/desktop/api/Mspcall/nl-mspcall-cmspcallmultigraph) if the filter-graph-per-stream model does not fit your requirements; this will increase the complexity of the task (as of this writing, all MSPs derive call objects directly from **CMSPCallMultiGraph**).</span></span> <span data-ttu-id="f0b6a-138">В объекте Address реализуйте [**креатемспкалл**](/windows/desktop/api/msp/nf-msp-itmspaddress-createmspcall) и [**шутдовнмспкалл**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdownmspcall) для создания и завершения конкретного типа объекта Call с помощью предоставленных шаблонов вспомогательных функций.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-138">In your address object, implement [**CreateMSPCall**](/windows/desktop/api/msp/nf-msp-itmspaddress-createmspcall) and [**ShutdownMSPCall**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdownmspcall) to create and shut down your specific type of call object using the provided helper function templates.</span></span> <span data-ttu-id="f0b6a-139">В объекте Call Переопределите [**креатестреамобжект**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-createstreamobject) , чтобы возвращал E \_ нотимпл.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-139">In your call object, override [**CreateStreamObject**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-createstreamobject) to return E\_NOTIMPL.</span></span> <span data-ttu-id="f0b6a-140">Переопределяйте [**мспкалладдреф**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-mspcalladdref) и [**мспкаллрелеасе**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-mspcallrelease) способом, идентичным соответствующим методам адреса.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-140">Override [**MSPCallAddRef**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-mspcalladdref) and [**MSPCallRelease**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-mspcallrelease) in a manner identical to the corresponding address methods.</span></span> <span data-ttu-id="f0b6a-141">Опять же, вы сможете компилировать и связывать свой MSP; Теперь он должен иметь возможность создавать и завершать вызовы, но вызовы не будут выполнять никаких полезных потоков.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-141">Again, you should be able to compile and link your MSP; it should now be able to create and shut down calls, but the calls will not do any useful streaming.</span></span>
11. <span data-ttu-id="f0b6a-142">Создайте класс, производный от Кмспстреам, для реализации объектов потока MSP.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-142">Derive a class from CMSPStream to implement your MSP stream objects.</span></span> <span data-ttu-id="f0b6a-143">В объекте Call реализуйте [**креатестреамобжект**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-createstreamobject) для создания и инициализации объекта Stream (обычно путем вызова метода ATL **CreateInstance** , за которым следует **\_ интерналкуеринтерфаце** ATL для [**итстреам**](/windows/win32/api/tapi3if/nn-tapi3if-itstream) , после чего вызывается метод **init** для объекта потока).</span><span class="sxs-lookup"><span data-stu-id="f0b6a-143">In your call object, implement [**CreateStreamObject**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-createstreamobject) to create and initialize your stream object (typically by calling the ATL **CreateInstance** followed by the ATL **\_InternalQueryInterface** for [**ITStream**](/windows/win32/api/tapi3if/nn-tapi3if-itstream) followed by calling **Init** on your stream object).</span></span> <span data-ttu-id="f0b6a-144">Для поддержки фиксированного числа потоков (это распространено для MSP, которые не поддерживают изменение конфигураций потоков другими конечными точками в вызове), переопределите методы **init**, [**креатестреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstreamcontrol-createstream)и [**ремовестреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstreamcontrol-removestream) для объекта Call.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-144">To support a fixed number of streams (this is common for MSPs which do not support modification of stream configurations by other endpoints on the call), override **Init**, [**CreateStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstreamcontrol-createstream), and [**RemoveStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstreamcontrol-removestream) on your call object.</span></span> <span data-ttu-id="f0b6a-145">(Вызов **init** сначала создает все потоки, а **креатестреам** и **ремовестреам** возвращают соответствующие коды ошибок TAPI, чтобы приложение не создавало или не удаляя потоки).</span><span class="sxs-lookup"><span data-stu-id="f0b6a-145">(The call **Init** creates all of your streams initially, and **CreateStream** and **RemoveStream** return the appropriate TAPI error codes to prevent the application from creating or removing streams).</span></span> <span data-ttu-id="f0b6a-146">В противном случае Переопределите метод **init** вызова, чтобы создать начальную конфигурацию потоков по умолчанию с использованием типов носителей, запрошенных для вызова.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-146">Otherwise, override the call's **Init** method to create some initial default configuration of streams using the media types requested for the call.</span></span> <span data-ttu-id="f0b6a-147">При создании объектов потока по умолчанию в методе **init** вызова используйте вспомогательный метод [**интерналкреатестреам**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-internalcreatestream) .</span><span class="sxs-lookup"><span data-stu-id="f0b6a-147">When creating any default stream objects in your call's **Init** method, use the [**InternalCreateStream**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-internalcreatestream) helper method.</span></span>
12. <span data-ttu-id="f0b6a-148">Реализуйте объект Stream.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-148">Implement your stream object.</span></span> <span data-ttu-id="f0b6a-149">Единственным обязательным переопределением является метод [**Get \_ Name**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-get_name) , который просто возвращает понятное имя для потока.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-149">The only required override is the [**get\_Name**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-get_name) method, which simply returns a friendly name for the stream.</span></span> <span data-ttu-id="f0b6a-150">Кроме того, необходимо переопределить несколько других методов.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-150">In addition, you will need to override several other methods.</span></span> <span data-ttu-id="f0b6a-151">В точности, какие методы переопределяются, зависит от реализации и от принятия решения о выполнении различных задач, связанных с построением и деконструированием графа фильтра.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-151">Exactly which methods to override depends on your implementation and when you decide to perform the various tasks involved in constructing and deconstructing your filter graph.</span></span> <span data-ttu-id="f0b6a-152">Эти задачи включают создание соответствующих фильтров транспорта, кодеков и т. д., а также их вставку и удаление из графов фильтров в нужное время.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-152">These tasks include creating the appropriate "transport" filters, codecs, and so on, and inserting them and removing them from the filter graphs at the appropriate times.</span></span> <span data-ttu-id="f0b6a-153">Для подключения выбранных терминалов к потокам также потребуется использовать интерфейс [**иттерминалконтрол**](/windows/desktop/api/Termmgr/nn-termmgr-itterminalcontrol) в объектах терминала.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-153">You will also have to use the [**ITTerminalControl**](/windows/desktop/api/Termmgr/nn-termmgr-itterminalcontrol) interface on terminal objects to connect the selected terminals to your streams.</span></span> <span data-ttu-id="f0b6a-154">Может потребоваться переопределить [**селекттерминал**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal) и [**унселекттерминал**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) в объекте потока, чтобы ограничить конфигурации терминалов, которые будут приниматься потоками. ограничение каждого потока в одном терминале особенно упростит создание графов фильтров, но повлияет на функциональные возможности приложения, такие как предварительный просмотр видео.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-154">You may want to override [**SelectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal) and [**UnselectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) on your stream object to limit the terminal configurations that your streams will accept; limiting each stream to a single terminal will especially simplify construction of your filter graphs, but will sacrifice application functionality such as video preview.</span></span> <span data-ttu-id="f0b6a-155">В зависимости от реализации вы размещаете построение графа, деконструкцию и код подключения терминала в методах [**стартстреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-startstream), [**стопстреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-stopstream), [**паусестреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-pausestream), [**Initialize**](/windows/desktop/api/msp/nf-msp-itmspaddress-initialize), [**Shutdown**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdown), [**селекттерминал**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal)и [**унселекттерминал**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) или в своих собственных методах, основанных на соединении частного TSP.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-155">Depending on your implementation, you will place your graph construction, deconstruction, and terminal connection code in the [**StartStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-startstream), [**StopStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-stopstream), [**PauseStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-pausestream), [**Initialize**](/windows/desktop/api/msp/nf-msp-itmspaddress-initialize), [**Shutdown**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdown), [**SelectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal), and [**UnselectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) methods, or in your own methods based on private TSP communication.</span></span> <span data-ttu-id="f0b6a-156">Имейте в виду, что поток без выбранных терминалов должен относиться к нужному состоянию диаграммы. вызов **стартстреам** , за которым следует вызов **селекттерминал** в таком потоке, должен привести к потоку данных.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-156">Be aware that a stream with no terminals selected must track the desired graph state; a **StartStream** call followed by a **SelectTerminal** call on such a stream must result in a data stream.</span></span> <span data-ttu-id="f0b6a-157">Переопределите большинство из этих методов, чтобы убедиться в том, что в каждом из них возникает Правильная конструкция, деконструкция, соединение и отключение, в зависимости от состояния потока.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-157">Override most of these methods to ensure that the correct construction, deconstruction, connection, and disconnection happens in each case depending on the state of the stream.</span></span>
13. <span data-ttu-id="f0b6a-158">Реализуйте обмен данными по TSP.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-158">Implement your TSP communication.</span></span> <span data-ttu-id="f0b6a-159">Переопределите [**кмспаддресс:: рецеиветспаддрессдата**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-receivetspaddressdata) и/или [**Кмспкаллбасе:: рецеиветспкаллдата**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-receivetspcalldata)и (или), [**вызвав для**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-postevent) объекта Address, или [**хандлестреамевент**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-handlestreamevent) в объекте Call (из объектов вызова или потока).</span><span class="sxs-lookup"><span data-stu-id="f0b6a-159">Override [**CMSPAddress::ReceiveTSPAddressData**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-receivetspaddressdata) and/or [**CMSPCallBase::ReceiveTSPCallData**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-receivetspcalldata), and/or by calling [**PostEvent**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-postevent) on your address object, or [**HandleStreamEvent**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-handlestreamevent) on your call object (from either your call or stream objects).</span></span>
14. <span data-ttu-id="f0b6a-160">Используйте для объекта Address или Хандлестреамевент в объекте Call (из объектов Call или Stream), чтобы передавать события мультимедиа вызова приложению через Tapi3.dll.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-160">Use PostEvent on your address object, or HandleStreamEvent on your call object (from either your call or stream objects) to send call media events to the application via Tapi3.dll.</span></span> <span data-ttu-id="f0b6a-161">Обычно это делается для объекта Stream в переопределенных методах, включая методы [**процессграфевент**](/windows/desktop/api/Mspstrm/nf-mspstrm-cmspstream-processgraphevent), [**стопстреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-stopstream), [**стартстреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-startstream), [**паусестреам**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-pausestream), [**селекттерминал**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal)и [**унселекттерминал**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) , в зависимости от способа реализации потоков.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-161">You will typically do this on your stream object, in overridden methods including the [**ProcessGraphEvent**](/windows/desktop/api/Mspstrm/nf-mspstrm-cmspstream-processgraphevent), [**StopStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-stopstream), [**StartStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-startstream), [**PauseStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-pausestream), [**SelectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal), and [**UnselectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) methods, depending on how you implement your streams.</span></span>
15. <span data-ttu-id="f0b6a-162">Реализуйте все необходимые частные интерфейсы или подпотоки на существующих объектах (адрес, вызов и поток).</span><span class="sxs-lookup"><span data-stu-id="f0b6a-162">Implement any desired private interfaces or substreams on your existing objects (address, call, and stream).</span></span> <span data-ttu-id="f0b6a-163">Обычно нет.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-163">Usually there are none.</span></span> <span data-ttu-id="f0b6a-164">Имейте в виду, что при реализации частных интерфейсов укажите идентификатор LIBID библиотеки типов из IDL-файла.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-164">Be aware that when implementing your private interfaces, specify the LIBID of your type library from your IDL file.</span></span> <span data-ttu-id="f0b6a-165">То есть программисты приложения должны использовать библиотеку типов MSP при использовании пользовательских интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-165">That is, application programmers must use your MSP type library when using your custom interfaces.</span></span> <span data-ttu-id="f0b6a-166">Стандартные интерфейсы MSP, реализованные в базовых классах MSP, используют Tapi3.dll LIBID и поэтому доступны для всех приложений TAPI 3.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-166">The standard MSP interfaces, implemented in the MSP base classes, use the Tapi3.dll LIBID and are therefore accessible to all TAPI 3 applications.</span></span>
16. <span data-ttu-id="f0b6a-167">При реализации статического или динамического объекта терминала или замен для статических терминалов по умолчанию (не номинал) можно использовать предоставленные базовые классы терминала.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-167">If implementing MSP-specific static or dynamic terminal objects or replacements for the default static terminals (not typical), you can use the provided terminal base classes.</span></span> <span data-ttu-id="f0b6a-168">Вам придется переопределять различные методы объекта Address, чтобы предоставить альтернативные или дополнительные методы создания объектов Terminal.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-168">You will have to override various methods on your address object to provide alternative or additional methods of creating terminal objects.</span></span>
17. <span data-ttu-id="f0b6a-169">Реализуйте интерфейс Иобжектсафети в адресе, вызове, потоке и объектах терминала.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-169">Implement the IObjectSafety interface on your Address, Call, Stream, and Terminal objects.</span></span> <span data-ttu-id="f0b6a-170">Чтобы использовать [сопоставитель диспетчеризации](dispatch-mapper.md) для запроса интерфейсов в объектах MSP, пометьте объекты как надежные для создания сценариев на этих интерфейсах.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-170">To use [Dispatch Mapper](dispatch-mapper.md) to query for interfaces on your MSP objects, mark your objects as safe for scripting on these interfaces.</span></span> <span data-ttu-id="f0b6a-171">Для этого реализуйте интерфейс **иобжектсафети** для объекта.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-171">To do this, implement the **IObjectSafety** interface on your object.</span></span> <span data-ttu-id="f0b6a-172">Наследование от **кмспобжектсафетимпл** (вспомогательный класс, предоставленное в мспутилс. h) и добавление **ИОБЖЕКТСАФЕТИ** в карту COM ATL класса сделает \_ объекты надежными для сценариев на всех предоставляемых ими интерфейсах.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-172">Deriving from **CMSPObjectSafetyImpl** (a helper class provided in Msputils.h) and adding **IObjectSafety** to your class's ATL COM\_MAP will make your objects safe for scripting on all the interfaces they expose.</span></span> <span data-ttu-id="f0b6a-173">Имейте в виду, что использование сопоставителя диспетчеризации для объектов MSP может быть неявным.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-173">Be aware that using Dispatch Mapper on MSP objects could be implicit.</span></span> <span data-ttu-id="f0b6a-174">Адрес MSP и вызов MSP обрабатываются по адресу TAPI и объектам вызова TAPI.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-174">MSP Address and MSP Call are aggregated by TAPI Address and TAPI Call objects.</span></span> <span data-ttu-id="f0b6a-175">Если в объектах TAPI для запроса интерфейсов, предоставляемых агрегированными объектами MSP, используется сопоставитель диспетчеризации, то сводные объекты MSP будут запрашиваться для обеспечения безопасности запрошенных интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="f0b6a-175">If Dispatch Mapper is used on the TAPI objects to query for the interfaces exposed by the aggregated MSP objects, the aggregated MSP objects will be queried for safety of the requested interfaces.</span></span>

 

 
