---
description: Приложения должны выделить память для этих данных; TAPI и поставщик услуг предоставляют данные. Если операция является асинхронной, данные недоступны, пока асинхронное сообщение ответа не указывает на успешное выполнение.
ms.assetid: 61313fe3-74a1-4195-b5af-37463dad02c1
title: Выделение памяти
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f192e34fdc652293c480277631c3839ecd2435fc
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105682385"
---
# <a name="memory-allocation"></a><span data-ttu-id="ac631-104">Выделение памяти</span><span class="sxs-lookup"><span data-stu-id="ac631-104">Memory Allocation</span></span>

<span data-ttu-id="ac631-105">Приложения должны выделить память для этих данных; TAPI и поставщик услуг предоставляют данные.</span><span class="sxs-lookup"><span data-stu-id="ac631-105">Applications must allocate memory for this data; TAPI and the service provider provide the data.</span></span> <span data-ttu-id="ac631-106">Если операция является асинхронной, данные недоступны, пока асинхронное сообщение ответа не указывает на успешное выполнение.</span><span class="sxs-lookup"><span data-stu-id="ac631-106">If the operation is asynchronous, the data is not available until the asynchronous reply message indicates success.</span></span>

<span data-ttu-id="ac631-107">Все структуры данных, используемые для передачи данных между приложением и интерфейсом TAPI, являются *плоскими*.</span><span class="sxs-lookup"><span data-stu-id="ac631-107">All data structures used to pass data between the application and the TAPI are *flattened*.</span></span> <span data-ttu-id="ac631-108">То есть структуры данных не содержат указатели на подструктуры, содержащие компоненты данных вариабли размера.</span><span class="sxs-lookup"><span data-stu-id="ac631-108">That is, data structures do not contain pointers to substructures that contain variably sized data components.</span></span> <span data-ttu-id="ac631-109">Вместо этого структуры данных, используемые для передачи переменных объемов данных обратно в приложение, должны иметь следующие метаструктуре:</span><span class="sxs-lookup"><span data-stu-id="ac631-109">Instead, data structures used to pass variable amounts of data back to the application must have the following metastructure:</span></span>

``` syntax
  DWORD  dwTotalSize;
  DWORD  dwNeededSize;
  DWORD  dwUsedSize; 
    <fixed size fields> 
  DWORD  dw<VarSizeField1>Size;
  DWORD  dw<VarSizeField1>Offset; 
    <fixed size fields> 
  DWORD  dw<VarSizeField2>Size;
  DWORD  dw<VarSizeField2>Offset; 
    <common extensions> 
    <var sized field1> 
    <var sized field2>
```

<span data-ttu-id="ac631-110">Элемент **двтоталсизе** — это размер (в байтах), выделенный этой структуре данных.</span><span class="sxs-lookup"><span data-stu-id="ac631-110">The **dwTotalSize** member is the size, in bytes, allocated to this data structure.</span></span> <span data-ttu-id="ac631-111">Он отмечает конец структуры данных и задается приложением перед вызовом функции, которая использует эту структуру данных.</span><span class="sxs-lookup"><span data-stu-id="ac631-111">It marks the end of the data structure and is set by the application before it invokes the function that uses this data structure.</span></span> <span data-ttu-id="ac631-112">Функция не считывает или не выполняет запись сверх этого размера.</span><span class="sxs-lookup"><span data-stu-id="ac631-112">The function does not read or write beyond this size.</span></span> <span data-ttu-id="ac631-113">Приложение должно задать элемент **двтоталсизе** , чтобы указать общее число байтов, выделенных для TAPI для возврата содержимого структуры.</span><span class="sxs-lookup"><span data-stu-id="ac631-113">An application must set the **dwTotalSize** member to indicate the total number of bytes allocated for TAPI to return the contents of the structure.</span></span>

<span data-ttu-id="ac631-114">TAPI заполняет элемент **двнидедсизе** .</span><span class="sxs-lookup"><span data-stu-id="ac631-114">TAPI fills in the **dwNeededSize** member.</span></span> <span data-ttu-id="ac631-115">Указывает, сколько байтов требуется для возврата всех запрошенных данных.</span><span class="sxs-lookup"><span data-stu-id="ac631-115">It indicates how many bytes are required to return all the requested data.</span></span> <span data-ttu-id="ac631-116">Наличие полей размера вариабли часто делает приложение невозможным для оценки размера структуры данных, необходимой для выделения.</span><span class="sxs-lookup"><span data-stu-id="ac631-116">The existence of variably sized fields often makes it impossible for the application to estimate the data structure size required to allocate.</span></span> <span data-ttu-id="ac631-117">Это поле возвращает число байтов, фактически необходимых для данных.</span><span class="sxs-lookup"><span data-stu-id="ac631-117">This field returns the number of bytes actually required for the data.</span></span> <span data-ttu-id="ac631-118">Это число может быть меньше, равно или больше **двтоталсизе** и включает место для самого элемента **двтоталсизе** .</span><span class="sxs-lookup"><span data-stu-id="ac631-118">This number could be smaller than, equal to, or larger than **dwTotalSize**, and it includes space for the **dwTotalSize** member itself.</span></span> <span data-ttu-id="ac631-119">Если значение больше, возвращаемая структура заполняется только частично.</span><span class="sxs-lookup"><span data-stu-id="ac631-119">If larger, the returned structure is only partially filled.</span></span> <span data-ttu-id="ac631-120">Если поля, необходимые приложению, доступны в частичной структуре, ничего делать не нужно.</span><span class="sxs-lookup"><span data-stu-id="ac631-120">If the fields the application requires are available in the partial structure, nothing else must be done.</span></span> <span data-ttu-id="ac631-121">В противном случае приложение должно выделить структуру по крайней мере с размером **двнидедсизе** и вызвать функцию снова.</span><span class="sxs-lookup"><span data-stu-id="ac631-121">Otherwise, the application should allocate a structure at least the size of **dwNeededSize** and invoke the function again.</span></span> <span data-ttu-id="ac631-122">Как правило, на этот раз доступно достаточно места для возврата всей информации, хотя размер может увеличиться.</span><span class="sxs-lookup"><span data-stu-id="ac631-122">Usually, enough space is available this time to return all the information, although it is possible the size could have increased again.</span></span>

<span data-ttu-id="ac631-123">TAPI заполняет элемент **двуседсизе** , если он возвращает данные в приложение для указания фактического размера (в байтах) части структуры данных, содержащей полезные данные.</span><span class="sxs-lookup"><span data-stu-id="ac631-123">TAPI fills the **dwUsedSize** member if it returns data to the application to indicate the actual size, in bytes, of the portion of the data structure that contains useful data.</span></span> <span data-ttu-id="ac631-124">Если, например, выделенная структура была слишком мала, а обрезанное поле является полем размера вариабли, **двнидедсизе** больше, чем **двтоталсизе**, а обрезанное поле остается пустым.</span><span class="sxs-lookup"><span data-stu-id="ac631-124">If, for example, a structure that was allocated was too small and the truncated field is a variably sized field, **dwNeededSize** is larger than **dwTotalSize**, and the truncated field is left empty.</span></span> <span data-ttu-id="ac631-125">Таким образом, элемент **двуседсизе** может быть меньше **двтоталсизе**.</span><span class="sxs-lookup"><span data-stu-id="ac631-125">The **dwUsedSize** member could therefore be smaller than **dwTotalSize**.</span></span> <span data-ttu-id="ac631-126">Частичные значения полей не возвращаются.</span><span class="sxs-lookup"><span data-stu-id="ac631-126">Partial field values are not returned.</span></span>

<span data-ttu-id="ac631-127">Следующий заголовок является фиксированной частью структуры данных.</span><span class="sxs-lookup"><span data-stu-id="ac631-127">Following this header is the fixed part of the data structure.</span></span> <span data-ttu-id="ac631-128">Он содержит обычные поля и пары "размер-смещение", описывающие фактические поля размера вариабли.</span><span class="sxs-lookup"><span data-stu-id="ac631-128">It contains regular fields and size/offset pairs that describe the actual variably sized fields.</span></span> <span data-ttu-id="ac631-129">Поле Offset содержит смещение в байтах поля вариабли size с начала записи.</span><span class="sxs-lookup"><span data-stu-id="ac631-129">The offset field contains the offset in bytes of the variably sized field from the beginning of the record.</span></span> <span data-ttu-id="ac631-130">Поле Размер содержит размер в байтах поля вариабли size.</span><span class="sxs-lookup"><span data-stu-id="ac631-130">The size field contains the size in bytes of the variably sized field.</span></span> <span data-ttu-id="ac631-131">Если поле размера вариабли пустое, то поле Size равно нулю, а смещение устанавливается равным нулю.</span><span class="sxs-lookup"><span data-stu-id="ac631-131">If a variably sized field is empty, then the size field is zero and the offset is set to zero.</span></span> <span data-ttu-id="ac631-132">Вариабли размер полей, которые будут обрезаны, если общий размер структуры недостаточен, остается пустым.</span><span class="sxs-lookup"><span data-stu-id="ac631-132">Variably sized fields that would be truncated if the total structure size is insufficient are left empty.</span></span> <span data-ttu-id="ac631-133">Это значит, что для поля размера задано нулевое значение, а для смещения установлено нулевое значение.</span><span class="sxs-lookup"><span data-stu-id="ac631-133">That is, their size field is set to zero and the offset is set to zero.</span></span> <span data-ttu-id="ac631-134">Поля размера вариабли соответствуют полям с фиксированным размером.</span><span class="sxs-lookup"><span data-stu-id="ac631-134">The variably sized fields follow the fixed fields.</span></span>

<span data-ttu-id="ac631-135">Если поставщик услуг должен заполнить член переменной, TAPI инициализирует соответствующий размер и смещение равными нулю.</span><span class="sxs-lookup"><span data-stu-id="ac631-135">If the service provider must fill a variable member, TAPI initializes the corresponding size and offset members to zero.</span></span> <span data-ttu-id="ac631-136">Если поставщик услуг заполняет переменную член, он должен задать соответствующие значения в соответствующих элементах size и offset, включая **двуседсизе** и **двнидедсизе** , если он задает члены переменных.</span><span class="sxs-lookup"><span data-stu-id="ac631-136">If the service provider fills in the variable member, it must set the corresponding size and offset members to appropriate values, including **dwUsedSize** and **dwNeededSize** if it sets variable members.</span></span> <span data-ttu-id="ac631-137">Поставщик услуг не должен усекать член переменной, чтобы он поместился в доступное пространство.</span><span class="sxs-lookup"><span data-stu-id="ac631-137">The service provider must not truncate a variable member to make it fit into the available space.</span></span>

<span data-ttu-id="ac631-138">Поставщик услуг должен запускать переменные члены сразу после фиксированных членов структуры и оставлять все дополнительное пространство в конце выделенной памяти, чтобы TAPI мог использовать его для членов переменной длины.</span><span class="sxs-lookup"><span data-stu-id="ac631-138">The service provider must start variable members immediately after the fixed members of the structure, and leave any extra space at the end of the allocated memory so that TAPI can use it for the variable-length members.</span></span> <span data-ttu-id="ac631-139">Члены переменной могут размещаться в любом порядке, но элементы должны быть непрерывными.</span><span class="sxs-lookup"><span data-stu-id="ac631-139">It can place the variable members in any order, but the members must be contiguous.</span></span>

 

 



