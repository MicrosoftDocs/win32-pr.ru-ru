---
description: В этом разделе представлен общий обзор операций TSP.
ms.assetid: 8ee592ff-387e-449e-8e3f-4f6407166fe5
title: Жизненный цикл поставщика услуг телефонии
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 830bc16ca606bb5bd38c4bce7c1e6e39dadb65a6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104565163"
---
# <a name="life-cycle-of-a-telephony-service-provider"></a><span data-ttu-id="5a231-103">Жизненный цикл поставщика услуг телефонии</span><span class="sxs-lookup"><span data-stu-id="5a231-103">Life Cycle of a Telephony Service Provider</span></span>

<span data-ttu-id="5a231-104">В этом разделе представлен общий обзор операций TSP.</span><span class="sxs-lookup"><span data-stu-id="5a231-104">This topic provides a high-level review of TSP operations.</span></span>

<span data-ttu-id="5a231-105">Сеанс — это время, в течение которого определенная конфигурация остается допустимой и выполняется операция телефонной связи. Поставщик услуг может поддерживать много сеансов между моментом, когда он впервые загружается, и после его освобождения.</span><span class="sxs-lookup"><span data-stu-id="5a231-105">A session is the time during which a particular configuration remains valid and telephony operations are carried out. A service provider can support many sessions between the time it is first loaded and when it is finally freed.</span></span> <span data-ttu-id="5a231-106">Для каждого сеанса TAPI согласовывает версию интерфейса, запускает сеанс, выполняет операции и в конечном итоге завершает сеанс.</span><span class="sxs-lookup"><span data-stu-id="5a231-106">For each session, TAPI negotiates the version of the interface, starts the session, carries out operations, and eventually shuts down the session.</span></span> <span data-ttu-id="5a231-107">Поставщик услуг не должен хранить данные из одного сеанса в следующий.</span><span class="sxs-lookup"><span data-stu-id="5a231-107">The service provider must not retain information from one session to the next.</span></span>

<span data-ttu-id="5a231-108">После того как версия интерфейса известна, TAPI вызывает функцию [**тспи \_ провидеринит**](/windows/win32/api/tspi/nf-tspi-tspi_providerinit) для установки всех рабочих параметров.</span><span class="sxs-lookup"><span data-stu-id="5a231-108">After the interface version is known, TAPI calls the [**TSPI\_providerInit**](/windows/win32/api/tspi/nf-tspi-tspi_providerinit) function to set all operational parameters.</span></span> <span data-ttu-id="5a231-109">Поставщик услуг гарантирует, что вся информация о конфигурации в реестре будет стабильной при вызове функции **тспи \_ провидеринит** .</span><span class="sxs-lookup"><span data-stu-id="5a231-109">The service provider is ensured that all of the configuration information in the registry is stable when the **TSPI\_providerInit** function is called.</span></span> <span data-ttu-id="5a231-110">Большинство поставщиков служб в это время считывают все сведения о конфигурации.</span><span class="sxs-lookup"><span data-stu-id="5a231-110">Most service providers read all configuration information at that time.</span></span>

<span data-ttu-id="5a231-111">Нормальные операции могут выполняться в любом порядке после инициализации поставщика услуг.</span><span class="sxs-lookup"><span data-stu-id="5a231-111">Normal operations can proceed in any order, after the service provider is initialized.</span></span>

<span data-ttu-id="5a231-112">TAPI согласовывает сведения, относящиеся к устройству, для каждого устройства.</span><span class="sxs-lookup"><span data-stu-id="5a231-112">TAPI negotiates device-specific information on a per-device basis.</span></span> <span data-ttu-id="5a231-113">TAPI и поставщик услуг фиксируются в версии при открытии устройства.</span><span class="sxs-lookup"><span data-stu-id="5a231-113">TAPI and the service provider commit to a version when a device is opened.</span></span>

<span data-ttu-id="5a231-114">Поставщик услуг может принимать запросы на выбор и отмену версий расширений.</span><span class="sxs-lookup"><span data-stu-id="5a231-114">The service provider can receive requests to select and cancel extension versions.</span></span> <span data-ttu-id="5a231-115">Пока выбрана версия расширения, устройство работает строго в соответствии с версией модуля, относящегося к конкретному устройству.</span><span class="sxs-lookup"><span data-stu-id="5a231-115">While an extension version is selected, the device operates strictly according to that device-specific extension version.</span></span>

<span data-ttu-id="5a231-116">Согласование версии расширения для конкретного устройства может происходить несколько раз, до и после открытия устройства.</span><span class="sxs-lookup"><span data-stu-id="5a231-116">Negotiation of a device-specific extension version can happen multiple times, both before and after the device is opened.</span></span> <span data-ttu-id="5a231-117">TAPI передает диапазон версий, а поставщик услуг выбирает и возвращает значение из этого диапазона.</span><span class="sxs-lookup"><span data-stu-id="5a231-117">TAPI passes a version range, and the service provider chooses and returns a value from this range.</span></span> <span data-ttu-id="5a231-118">Как правило, у поставщика услуг отключены расширения для конкретных устройств.</span><span class="sxs-lookup"><span data-stu-id="5a231-118">Normally, the service provider has device-specific extensions disabled.</span></span>

<span data-ttu-id="5a231-119">Это зафиксирует как TAPI, так и поставщик службы для работы на этом уровне версии расширения до тех пор, пока выбор не будет отменен.</span><span class="sxs-lookup"><span data-stu-id="5a231-119">This commits both TAPI and the service provider to operating at that extension version level until the selection is canceled.</span></span> <span data-ttu-id="5a231-120">В течение времени, когда действует расширение для конкретного устройства, попытка согласовать уровень версии расширения должна разрешить только уровень версии, действующий в данный момент.</span><span class="sxs-lookup"><span data-stu-id="5a231-120">During the time that a device-specific extension is in effect, an attempt to negotiate an extension version level should allow only the version level that is currently in effect.</span></span> <span data-ttu-id="5a231-121">После отмены расширения для конкретного устройства можно согласовать и выбрать другую версию.</span><span class="sxs-lookup"><span data-stu-id="5a231-121">After the device-specific extension is canceled, a different version can be negotiated and selected.</span></span>

<span data-ttu-id="5a231-122">Операции с телефоном в паре **Open/Close** показаны на следующем рисунке.</span><span class="sxs-lookup"><span data-stu-id="5a231-122">Phone operations within the **Open/Close** pair are shown in the following illustration.</span></span> <span data-ttu-id="5a231-123">Некоторые из этих операций являются синхронными, а другие — асинхронными.</span><span class="sxs-lookup"><span data-stu-id="5a231-123">Some of these operations are synchronous, others are asynchronous.</span></span> <span data-ttu-id="5a231-124">Если операция завершается асинхронно, можно запросить другую операцию перед завершением первого отчета.</span><span class="sxs-lookup"><span data-stu-id="5a231-124">If an operation completes asynchronously, another operation can be requested before the first reports completion.</span></span> <span data-ttu-id="5a231-125">Таким образом, операции могут перекрываться любым способом.</span><span class="sxs-lookup"><span data-stu-id="5a231-125">Thus, operations can overlap in any way.</span></span> <span data-ttu-id="5a231-126">Поставщик услуг в конечном итоге должен сообщить о завершении для любой запрошенной асинхронной операции.</span><span class="sxs-lookup"><span data-stu-id="5a231-126">The service provider must eventually report completion for any asynchronous operation requested.</span></span> <span data-ttu-id="5a231-127">Закрытие телефона означает принудительное завершение невыполненных асинхронных операций (возможно, с указанием ошибки).</span><span class="sxs-lookup"><span data-stu-id="5a231-127">Closing a phone forces outstanding asynchronous operations to complete (possibly with a "failure" indication).</span></span>

<span data-ttu-id="5a231-128">Жизненный цикл линейных устройств аналогичен жизненному циклу для телефонов, за исключением того, что строки имеют собственные процедуры согласования, инициализации, открытия и закрытия.</span><span class="sxs-lookup"><span data-stu-id="5a231-128">The life cycle for line devices is similar to the life cycle for phones, except that lines have their own negotiation, initialization, open, and close procedures.</span></span> <span data-ttu-id="5a231-129">Операции с открытыми строками заключаются в скобки с помощью собственной пары **Open/Close** .</span><span class="sxs-lookup"><span data-stu-id="5a231-129">Operations on open lines are bracketed by their own **Open/Close** pair.</span></span> <span data-ttu-id="5a231-130">Эта пара заключается в скобки между той же парой **инициализации и завершения работы** , что и Телефон, **открытый или закрывающий**.</span><span class="sxs-lookup"><span data-stu-id="5a231-130">This pair is in turn bracketed between the same **Initialization/Shutdown** pair as the phone **Open/Close**.</span></span>

<span data-ttu-id="5a231-131">Жизненный цикл вызовов строго заключен в скобки между **открывающим или закрывающим** строкой, содержащей их.</span><span class="sxs-lookup"><span data-stu-id="5a231-131">The life cycles of calls are bracketed strictly between the **Open/Close** of the line that contains them.</span></span> <span data-ttu-id="5a231-132">Время существования вызовов может начинаться несколькими способами:</span><span class="sxs-lookup"><span data-stu-id="5a231-132">Lifetimes of calls can begin in several ways:</span></span>

-   <span data-ttu-id="5a231-133">Запрошено из TAPI с помощью таких функций, как [**линемакекалл**](/windows/win32/api/tapi/nf-tapi-linemakecall), [**линесетуптрансфер**](/windows/win32/api/tapi/nf-tapi-linesetuptransfer)или [**линесетупконференце**](/windows/win32/api/tapi/nf-tapi-linesetupconference).</span><span class="sxs-lookup"><span data-stu-id="5a231-133">Requested from TAPI through functions such as [**lineMakeCall**](/windows/win32/api/tapi/nf-tapi-linemakecall), [**lineSetupTransfer**](/windows/win32/api/tapi/nf-tapi-linesetuptransfer), or [**lineSetupConference**](/windows/win32/api/tapi/nf-tapi-linesetupconference).</span></span>
-   <span data-ttu-id="5a231-134">Злоумышленник поступил в поставщике услуг как новые входящие вызовы, инициированные пользователем вызовы на подключенной телефонной трубки или вызовы, созданные как побочные эффекты других операций, таких как помещение существующего вызова в удержание.</span><span class="sxs-lookup"><span data-stu-id="5a231-134">Spontaneously originated in the service provider as new incoming calls, user-initiated calls on an attached telephone handset, or calls generated as a side effect of other operations such as putting an existing call on hold.</span></span>

<span data-ttu-id="5a231-135">Время существования различных вызовов в одной строке может быть перекрываться любым способом.</span><span class="sxs-lookup"><span data-stu-id="5a231-135">The lifetimes of distinct calls within the same line can overlap each other in any way.</span></span> <span data-ttu-id="5a231-136">Все вызовы завершают свое время существования во время вызова функции ТСПИ, [**тспи \_ линеклосекалл**](/windows/win32/api/tspi/nf-tspi-tspi_lineclosecall) .</span><span class="sxs-lookup"><span data-stu-id="5a231-136">All calls end their lifetime at the time the TSPI function [**TSPI\_lineCloseCall**](/windows/win32/api/tspi/nf-tspi-tspi_lineclosecall) is invoked.</span></span> <span data-ttu-id="5a231-137">На следующем рисунке показан жизненный цикл нескольких вызовов.</span><span class="sxs-lookup"><span data-stu-id="5a231-137">The life cycle of several calls is shown in the following illustration.</span></span>

![жизненные циклы вызовов, перекрывающихся](images/modell.png)

<span data-ttu-id="5a231-139">Вызов может быть получен в TAPI, как показано в паре **MAKECALL/клосекалл** .</span><span class="sxs-lookup"><span data-stu-id="5a231-139">A call can originate in TAPI as shown with the **MakeCall/CloseCall** pair.</span></span> <span data-ttu-id="5a231-140">Вызов также может исходить от поставщика услуг.</span><span class="sxs-lookup"><span data-stu-id="5a231-140">A call can also originate in the service provider.</span></span> <span data-ttu-id="5a231-141">Поставщик услуг объявляет это с помощью [**строки \_ невкалл**](line-newcall.md) сообщения в процедуру обратного вызова, предоставляемую TAPI.</span><span class="sxs-lookup"><span data-stu-id="5a231-141">The service provider announces this with a [**LINE\_NEWCALL**](line-newcall.md) message to a TAPI-supplied callback procedure.</span></span> <span data-ttu-id="5a231-142">В этом случае TAPI возвращает свой идентификатор для вызова, который включается в последующие обратные вызовы, сообщающие о событиях, происходящих при вызове.</span><span class="sxs-lookup"><span data-stu-id="5a231-142">In such a case, TAPI returns its identifier for the call, which is included in subsequent callbacks reporting events occurring on the call.</span></span> <span data-ttu-id="5a231-143">В случае вызовов, время существования которых исходит от TAPI, этот идентификатор включается в операцию ТСПИ, которая создает вызов.</span><span class="sxs-lookup"><span data-stu-id="5a231-143">In the case of calls whose lifetime originates in TAPI, this identifier is included in the TSPI operation that creates the call.</span></span>

<span data-ttu-id="5a231-144">Все операции, которые начинают время существования вызова в TAPI и поставщике услуг, обмениваются идентификаторами для нового вызова.</span><span class="sxs-lookup"><span data-stu-id="5a231-144">All of the operations that start the lifetime of a call result in TAPI and service provider exchanging identifiers for the new call.</span></span> <span data-ttu-id="5a231-145">В случае порожденных вызовов TAPI TAPI передает свой идентификатор и получает идентификатор поставщика службы в качестве возвращаемого параметра.</span><span class="sxs-lookup"><span data-stu-id="5a231-145">In the case of TAPI originated calls, TAPI passes its identifier and receives the service provider's identifier as a return parameter.</span></span> <span data-ttu-id="5a231-146">В случае, когда вызов исходит от поставщика услуг, поставщик услуг передает свой идентификатор в TAPI и получает идентификатор TAPI в качестве возвращаемого параметра.</span><span class="sxs-lookup"><span data-stu-id="5a231-146">In the case where the call originates in the service provider, the service provider passes its identifier to TAPI and receives the TAPI identifier as a return parameter.</span></span>

<span data-ttu-id="5a231-147">На следующем рисунке представлено высокоуровневое представление установки, настройки и удаления поставщика услуг. последовательности жизненного цикла, охватывающие много сеансов.</span><span class="sxs-lookup"><span data-stu-id="5a231-147">The following illustration offers a very high-level view of service provider installation, configuration, and removal; life-cycle sequences that span many sessions.</span></span> <span data-ttu-id="5a231-148">Типичный жизненный цикл этих операций можно отобразить с помощью следующей временной шкалы.</span><span class="sxs-lookup"><span data-stu-id="5a231-148">The typical life-cycle for these operations can be shown with the following time line.</span></span>

![Установка, Настройка и удаление поставщика услуг](images/model2.png)

<span data-ttu-id="5a231-150">Показан стандартный жизненный цикл установки и удаления, охватывающий несколько сеансов.</span><span class="sxs-lookup"><span data-stu-id="5a231-150">The typical installation and removal life cycle is shown, spanning multiple sessions.</span></span> <span data-ttu-id="5a231-151">Вызовы процедур **установки** и [**удаления**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) строго парны и не перекрываются.</span><span class="sxs-lookup"><span data-stu-id="5a231-151">Calls to the **Install** and [**Remove**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) procedures are strictly paired and do not overlap.</span></span> <span data-ttu-id="5a231-152">Вызовы процедуры **настройки** могут происходить несколько раз в этой паре.</span><span class="sxs-lookup"><span data-stu-id="5a231-152">Calls to the **Config** procedure can happen multiple times within this pair.</span></span> <span data-ttu-id="5a231-153">Как правило, поставщик услуг выполняет процедуру **установки** в качестве внутреннего побочного действия для создания записей строк и телефонов.</span><span class="sxs-lookup"><span data-stu-id="5a231-153">One is typically done by the service provider as an internal side effect of the **Install** procedure to create line and phone entries.</span></span> <span data-ttu-id="5a231-154">Процедура **настройки** может быть вызвана в другое время для изменения существующей установки.</span><span class="sxs-lookup"><span data-stu-id="5a231-154">The **Config** procedure may be called at other times to alter an existing setup.</span></span> <span data-ttu-id="5a231-155">Процедура **установки** должна быть выполнена до того, как будет разрешена любая другая функция тспи.</span><span class="sxs-lookup"><span data-stu-id="5a231-155">The **Install** procedure must be done before any other TSPI function is permitted.</span></span> <span data-ttu-id="5a231-156">В идеальном случае все сеансы строго вкладываются в пару процедур **Install/Remove** .</span><span class="sxs-lookup"><span data-stu-id="5a231-156">In the ideal scenario, all sessions are strictly nested within the **Install/Remove** procedure pair.</span></span>

<span data-ttu-id="5a231-157">Функции [**тспи \_ провидеринсталл**](/windows/win32/api/tspi/nf-tspi-tspi_providerinstall), [**тспи \_ провидерконфиг**](/windows/win32/api/tspi/nf-tspi-tspi_providerconfig)и [**тспи \_ провидерремове**](/windows/win32/api/tspi/nf-tspi-tspi_providerremove) взаимодействуют с самим поставщиком услуг, а не с каким бы то ни было конкретным устройством.</span><span class="sxs-lookup"><span data-stu-id="5a231-157">The functions [**TSPI\_providerInstall**](/windows/win32/api/tspi/nf-tspi-tspi_providerinstall), [**TSPI\_providerConfig**](/windows/win32/api/tspi/nf-tspi-tspi_providerconfig), and [**TSPI\_providerRemove**](/windows/win32/api/tspi/nf-tspi-tspi_providerremove) interact with the service provider itself rather than with any specific device.</span></span> <span data-ttu-id="5a231-158">Они влияют на сведения о статической конфигурации, которые остаются в нескольких сеансах и должны присутствовать для продолжения любой другой операции.</span><span class="sxs-lookup"><span data-stu-id="5a231-158">They affect static configuration information that survives across multiple sessions and must be present for any other operation to proceed.</span></span> <span data-ttu-id="5a231-159">Таким же, все остальные операции вкладываются между вызовом **тспи \_ провидеринсталл** и завершением соответствующего **тспи \_ провидерремове**.</span><span class="sxs-lookup"><span data-stu-id="5a231-159">Thus, all other operations are nested between the invocation of **TSPI\_providerInstall** and the completion of its matching **TSPI\_providerRemove**.</span></span> <span data-ttu-id="5a231-160">Эти две операции обычно происходят очень далеко друг от друга, скорее всего, в другой нагрузке поставщика услуг или при другой загрузке компьютера.</span><span class="sxs-lookup"><span data-stu-id="5a231-160">These two operations typically happen very far apart, most likely in a different load of the service provider or a different boot of the machine.</span></span> <span data-ttu-id="5a231-161">Вызов функции **настройки** извне является необязательным, так как процедура **установки** необходима для включения поведения **конфигурации** в дополнение к собственным.</span><span class="sxs-lookup"><span data-stu-id="5a231-161">Calling the **Config** function externally is optional, because the **Install** procedure is required to include the **Config** behavior in addition to its own.</span></span> <span data-ttu-id="5a231-162">Как правило, причина его вызова извне заключается в изменении существующей конфигурации.</span><span class="sxs-lookup"><span data-stu-id="5a231-162">The usual reason for calling it externally is to modify an existing configuration.</span></span>

<span data-ttu-id="5a231-163">В концепцию завершения операции [**\_ провидерремове тспи**](/windows/win32/api/tspi/nf-tspi-tspi_providerremove) есть тонкость.</span><span class="sxs-lookup"><span data-stu-id="5a231-163">There is a subtlety embedded in the concept of the completion of a [**TSPI\_providerRemove**](/windows/win32/api/tspi/nf-tspi-tspi_providerremove) operation.</span></span> <span data-ttu-id="5a231-164">Желательно разрешить пользователю запускать служебную программу панели управления телефонии, предоставляемую вместе со службой телефонии, для изменения конфигураций поставщика услуг, даже если выполняются операции телефонии (сеансы).</span><span class="sxs-lookup"><span data-stu-id="5a231-164">It is desirable to allow the user to run the Telephony Control Panel utility supplied with the telephony service to alter service provider configurations, even when telephony operations (sessions) are in progress.</span></span> <span data-ttu-id="5a231-165">Следовательно, спецификации [**тспи \_ Провидерконфиг**](/windows/win32/api/tspi/nf-tspi-tspi_providerconfig) и **тспи \_ провидерремове** позволяют вызывать, пока не будет выполнен сеанс.</span><span class="sxs-lookup"><span data-stu-id="5a231-165">Consequently, both the [**TSPI\_providerConfig**](/windows/win32/api/tspi/nf-tspi-tspi_providerconfig) and **TSPI\_providerRemove** specifications allow for invocation while there is an outstanding session.</span></span> <span data-ttu-id="5a231-166">Однако все изменения в конфигурации должны быть отложены до тех пор, пока операции телефонии не будут выключены и перезапущены.</span><span class="sxs-lookup"><span data-stu-id="5a231-166">However, any changes to the configuration are required to be delayed until telephony operations are shut down and restarted.</span></span> <span data-ttu-id="5a231-167">Поэтому строго говоря, завершение любой операции **тспи \_ Провидерконфиг** или **тспи \_ провидерремове** происходит вне любого сеанса.</span><span class="sxs-lookup"><span data-stu-id="5a231-167">Thus, strictly speaking, the completion of any **TSPI\_providerConfig** or **TSPI\_providerRemove** operation happens outside any session.</span></span> <span data-ttu-id="5a231-168">Вложенность действий показана на рисунке, даже несмотря на то, что вызовы процедур могут выглядеть немного иначе.</span><span class="sxs-lookup"><span data-stu-id="5a231-168">The nesting of actions is as shown in the figure, even though the procedures calls may appear in a slightly different order.</span></span> <span data-ttu-id="5a231-169">Поставщик услуг может просто запретить **настройку config** или [**Удалить**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) во время выполнения операций, хотя пользователь должен получать уведомления с помощью диалогового окна.</span><span class="sxs-lookup"><span data-stu-id="5a231-169">It is permitted for a service provider to simply disallow **Config** or [**Remove**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) while operations are in progress, although the user should be notified with a dialog box.</span></span> <span data-ttu-id="5a231-170">Более удобная для пользователя реализация, которая позволяет использовать по крайней мере подмножество операций.</span><span class="sxs-lookup"><span data-stu-id="5a231-170">A more user-friendly implementation that allows at least a subset of operations is preferred.</span></span>

<span data-ttu-id="5a231-171">Эти операции **установки**, **настройки** и [**удаления**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) имеют побочный результат для всех работающих приложений телефонии, что в итоге приводит к выключению использования службы телефонии.</span><span class="sxs-lookup"><span data-stu-id="5a231-171">These **Install**, **Config**, and [**Remove**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) operations all have the side effect of signaling any running telephony applications, which eventually results in them shutting down their use of the telephony service.</span></span> <span data-ttu-id="5a231-172">Вместе это завершает все невыполненные сеансы для поставщиков услуг.</span><span class="sxs-lookup"><span data-stu-id="5a231-172">Together, this ends all outstanding sessions for service providers.</span></span> <span data-ttu-id="5a231-173">Это означает, что поставщики услуг должны читать новую конфигурацию реестра при начале новых сеансов.</span><span class="sxs-lookup"><span data-stu-id="5a231-173">This signifies to service providers that they must read the new registry configuration when new sessions begin.</span></span> <span data-ttu-id="5a231-174">Все изменения, которые были отложены из-за **настройки** или [**удаления**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) во время выполнения операций, вступают в силу.</span><span class="sxs-lookup"><span data-stu-id="5a231-174">Any changes that were pending due to a **Config** or [**Remove**](/windows/win32/api/tapi3if/nf-tapi3if-itcollection2-remove) while operations were in progress then take effect.</span></span>

 

 
