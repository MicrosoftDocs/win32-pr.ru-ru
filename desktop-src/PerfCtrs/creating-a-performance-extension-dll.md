---
description: Поставщик — это библиотека DLL производительности, которая предоставляет клиентам данные счетчиков.
ms.assetid: bbb777fe-b97e-4777-b797-ec8525065610
title: Создание библиотеки DLL расширения производительности
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d397f1581454aca1b25c447b35f250eefd215f57
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103909743"
---
# <a name="creating-a-performance-extension-dll"></a><span data-ttu-id="98d12-103">Создание библиотеки DLL расширения производительности</span><span class="sxs-lookup"><span data-stu-id="98d12-103">Creating a Performance Extension DLL</span></span>

> [!IMPORTANT]
> <span data-ttu-id="98d12-104">Из-за существенных ограничений производительности и надежности метод предоставления данных счетчиков производительности, описанных в этом разделе, может быть изменен или недоступен в будущем.</span><span class="sxs-lookup"><span data-stu-id="98d12-104">Due to significant performance and reliability limitations, the method for providing performance counter data that this topic describes may be altered or unavailable in the future.</span></span> <span data-ttu-id="98d12-105">Вместо этого корпорация Майкрософт рекомендует использовать метод, описанный в разделе [предоставление данных счетчиков с помощью версии 2,0](providing-counter-data-using-version-2-0.md) для создания новых счетчиков производительности и переноса существующих счетчиков производительности для использования этого метода.</span><span class="sxs-lookup"><span data-stu-id="98d12-105">Instead, Microsoft recommends that you use the method described in [Providing Counter Data Using Version 2.0](providing-counter-data-using-version-2-0.md) for creating new performance counters and that you migrate existing performance counters to use that method as well.</span></span>

<span data-ttu-id="98d12-106">[Поставщик v1](providing-counter-data.md) использует библиотеку DLL производительности, которая предоставляет клиентам данные счетчиков.</span><span class="sxs-lookup"><span data-stu-id="98d12-106">A [V1 provider](providing-counter-data.md) uses a performance DLL that provides counter data to consumers.</span></span> <span data-ttu-id="98d12-107">DLL-библиотека производительности должна экспортировать функции [**опенперформанцедата**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)), [**коллектперформанцедата**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc)и [**клосеперформанцедата**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) .</span><span class="sxs-lookup"><span data-stu-id="98d12-107">The performance DLL must export the [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)), [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc), and [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) functions.</span></span> <span data-ttu-id="98d12-108">Как правило, для экспорта функций из библиотеки DLL используется файл определения модуля (DEF).</span><span class="sxs-lookup"><span data-stu-id="98d12-108">Typically, you use a module definition (.def) file to export the functions from the DLL.</span></span> <span data-ttu-id="98d12-109">Система вызывает эти функции, когда потребитель запрашивает данные о производительности.</span><span class="sxs-lookup"><span data-stu-id="98d12-109">The system calls these functions when a consumer queries performance data.</span></span>

<span data-ttu-id="98d12-110">При первом вызове [**процедура RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa)потребителем или если потребитель использует функцию [**регопенкэй**](/windows/desktop/api/winreg/nf-winreg-regopenkeya) или [**регконнектрегистри**](/windows/desktop/api/winreg/nf-winreg-regconnectregistrya) для открытия `HKEY_PERFORMANCE_DATA` , система вызывает функцию [**опенперформанцедата**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) для каждого поставщика, [зарегистрированного](adding-performance-counters.md) на компьютере.</span><span class="sxs-lookup"><span data-stu-id="98d12-110">The first time a consumer calls [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa), or if the consumer uses the [**RegOpenKey**](/windows/desktop/api/winreg/nf-winreg-regopenkeya) or [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistrya) function to open `HKEY_PERFORMANCE_DATA`, the system calls the [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) function for each provider that is [registered](adding-performance-counters.md) on the computer.</span></span> <span data-ttu-id="98d12-111">Исключением является, если поставщик указывает список объектов, которые он поддерживает, в `[objects]` разделе. INI-файл.</span><span class="sxs-lookup"><span data-stu-id="98d12-111">The exception is if the provider specifies the list of objects that it supports in the `[objects]` section of the .INI file.</span></span> <span data-ttu-id="98d12-112">В этом случае система вызывает поставщик, только если один из запрашиваемых объектов соответствует объекту из списка.</span><span class="sxs-lookup"><span data-stu-id="98d12-112">In this case, the system calls the provider only if one of the queried objects matches an object from the list.</span></span>

<span data-ttu-id="98d12-113">Функция [**опенперформанцедата**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) предоставляет каждому поставщику возможность инициализировать свои структуры данных о производительности.</span><span class="sxs-lookup"><span data-stu-id="98d12-113">The [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) function gives each provider an opportunity to initialize its performance data structures.</span></span> <span data-ttu-id="98d12-114">Затем, если функция **опенперформанцедата** успешно возвращает значение, система вызывает функцию [**коллектперформанцедата**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc) поставщика.</span><span class="sxs-lookup"><span data-stu-id="98d12-114">Then, if the **OpenPerformanceData** function returns successfully, the system calls the provider's [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc) function.</span></span> <span data-ttu-id="98d12-115">Последующие вызовы [**процедура RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) приведут к тому, что система вызывает функцию **коллектперформанцедата** .</span><span class="sxs-lookup"><span data-stu-id="98d12-115">Subsequent calls to [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) cause the system to call the **CollectPerformanceData** function.</span></span>

<span data-ttu-id="98d12-116">Когда потребитель заканчивает сбор данных о производительности, он указывает при `HKEY_PERFORMANCE_DATA` вызове функции [**Ошибка RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) .</span><span class="sxs-lookup"><span data-stu-id="98d12-116">When the consumer finishes collecting performance data, it specifies `HKEY_PERFORMANCE_DATA` in a call to the [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) function.</span></span> <span data-ttu-id="98d12-117">Это приводит к тому, что система вызывает функцию [**клосеперформанцедата**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) для каждого поставщика.</span><span class="sxs-lookup"><span data-stu-id="98d12-117">This causes the system to call the [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) function for each provider.</span></span> <span data-ttu-id="98d12-118">Затем поставщики выгружаются.</span><span class="sxs-lookup"><span data-stu-id="98d12-118">The providers are then unloaded.</span></span>

<span data-ttu-id="98d12-119">Несколько потребителей могут одновременно выполнять накопление данных о производительности.</span><span class="sxs-lookup"><span data-stu-id="98d12-119">It is possible for multiple consumers to collect performance data at the same time.</span></span> <span data-ttu-id="98d12-120">Система вызывает функции [**опенперформанцедата**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) и [**клосеперформанцедата**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) только один раз при каждой загрузке или выгрузке библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="98d12-120">The system calls [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) and [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) functions only once each time the DLL is loaded or unloaded.</span></span>

> [!Note]
> <span data-ttu-id="98d12-121">Не забудьте включить в код C++ модификатор extern "C", чтобы компилятор не добавим украшения к именам функций. в противном случае система может не найти ваши функции.</span><span class="sxs-lookup"><span data-stu-id="98d12-121">Be sure to include extern "C" in your C++ code to prevent the compiler from adding decorations to your function names; otherwise, the system may fail to find your functions.</span></span>

> [!Note]
> <span data-ttu-id="98d12-122">При возникновении ошибки при загрузке библиотеки DLL производительности, поиске функций или вызове функций система отключит поставщик для последующих коллекций в рамках одного процесса.</span><span class="sxs-lookup"><span data-stu-id="98d12-122">If an error occurs while loading your performance DLL, finding your functions, or calling your functions, the system will disable the provider for subsequent collections within the same process.</span></span> <span data-ttu-id="98d12-123">Кроме того, если это происходит при выполнении в привилегированном процессе, система добавляет значение **счетчиков производительности "отключить** " для ключа **производительности** , чтобы предотвратить загрузку поставщика в будущем.</span><span class="sxs-lookup"><span data-stu-id="98d12-123">In addition, if this occurs while running in a privileged process, the system adds a **Disable Performance Counters** value to your **Performance** key to prevent the provider from being loaded in the future.</span></span>

<span data-ttu-id="98d12-124">Дополнительные сведения о создании библиотеки DLL производительности см. в следующих разделах:</span><span class="sxs-lookup"><span data-stu-id="98d12-124">For more information on writing a performance DLL, see the following topics:</span></span>

- [<span data-ttu-id="98d12-125">Реализация функции Опенперформанцедата</span><span class="sxs-lookup"><span data-stu-id="98d12-125">Implementing the OpenPerformanceData function</span></span>](implementing-openperformancedata.md)
- [<span data-ttu-id="98d12-126">Реализация функции Коллектперформанцедата</span><span class="sxs-lookup"><span data-stu-id="98d12-126">Implementing the CollectPerformanceData function</span></span>](implementing-collectperformancedata.md)
- [<span data-ttu-id="98d12-127">Обработка ошибок в библиотеке DLL</span><span class="sxs-lookup"><span data-stu-id="98d12-127">Error Handling in the DLL</span></span>](error-handling-in-the-dll.md)
- [<span data-ttu-id="98d12-128">Ограниченный доступ к библиотекам расширений производительности</span><span class="sxs-lookup"><span data-stu-id="98d12-128">Restricting Access to Performance Extension DLLs</span></span>](restricting-access-to-performance-extension--dlls.md)
- [<span data-ttu-id="98d12-129">Примеры библиотек DLL производительности</span><span class="sxs-lookup"><span data-stu-id="98d12-129">Performance DLL Samples</span></span>](performance-dll-samples.md)
