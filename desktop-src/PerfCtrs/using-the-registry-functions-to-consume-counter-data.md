---
description: Для получения данных о производительности можно использовать функции реестра.
ms.assetid: feac7b8d-1dee-462c-89dc-bec1ba045da2
title: Использование функций реестра для использования данных счетчика
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: ce2a4ba9992510cb296b037cfd98965410c48939
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105663143"
---
# <a name="using-the-registry-functions-to-consume-counter-data"></a><span data-ttu-id="dedff-103">Использование функций реестра для использования данных счетчика</span><span class="sxs-lookup"><span data-stu-id="dedff-103">Using the Registry Functions to Consume Counter Data</span></span>

<span data-ttu-id="dedff-104">Используйте [функции реестра](/windows/desktop/SysInfo/registry-functions) для получения данных о производительности из специального `HKEY_PERFORMANCE_DATA` раздела реестра.</span><span class="sxs-lookup"><span data-stu-id="dedff-104">Use the [registry functions](/windows/desktop/SysInfo/registry-functions) to collect performance data from the special `HKEY_PERFORMANCE_DATA` registry key.</span></span>

<span data-ttu-id="dedff-105">Данные о производительности фактически не хранятся в реестре.</span><span class="sxs-lookup"><span data-stu-id="dedff-105">Performance data is not actually stored in the registry.</span></span> <span data-ttu-id="dedff-106">Вызов функций реестра приводит к тому, что система собирается получить данные от соответствующего поставщика данных о производительности.</span><span class="sxs-lookup"><span data-stu-id="dedff-106">Calling the registry functions causes the system to collect the data from the appropriate performance data provider.</span></span>

> [!Note]
> <span data-ttu-id="dedff-107">Для использования данных счетчика обычно не следует использовать функции реестра.</span><span class="sxs-lookup"><span data-stu-id="dedff-107">You should not normally use the registry functions to consume counter data.</span></span> <span data-ttu-id="dedff-108">Вместо этого следует [использовать функции модуля поддержки данных производительности (PDH)](using-the-pdh-functions-to-consume-counter-data.md).</span><span class="sxs-lookup"><span data-stu-id="dedff-108">Instead, you should [use the Performance Data Helper (PDH) functions](using-the-pdh-functions-to-consume-counter-data.md).</span></span> <span data-ttu-id="dedff-109">Функции PDH проще в использовании и позволяют избежать многих проблем производительности и надежности, которые могут возникать при неправильном использовании функций реестра.</span><span class="sxs-lookup"><span data-stu-id="dedff-109">The PDH functions are easier to use and avoid many performance and reliability problems that can occur through incorrect use of the registry functions.</span></span>

> [!Note]
> <span data-ttu-id="dedff-110">При написании приложений OneCore Windows нельзя использовать функции реестра.</span><span class="sxs-lookup"><span data-stu-id="dedff-110">You cannot use the registry functions if you are writing Windows OneCore apps.</span></span> <span data-ttu-id="dedff-111">Вместо этого используйте [функции-потребители версии PerfLib v2](using-the-perflib-functions-to-consume-counter-data.md).</span><span class="sxs-lookup"><span data-stu-id="dedff-111">Instead, use [PerfLib V2 Consumer functions](using-the-perflib-functions-to-consume-counter-data.md).</span></span>

<span data-ttu-id="dedff-112">Функции реестра — это низкоуровневые API для сбора данных от **поставщиков v1**.</span><span class="sxs-lookup"><span data-stu-id="dedff-112">The registry functions are the low-level API for collecting data from **V1 providers**.</span></span> <span data-ttu-id="dedff-113">Функции реестра также поддерживают сбор данных от **поставщиков v2** через слой перевода, который вызывает [функции потребителя v2](using-the-perflib-functions-to-consume-counter-data.md).</span><span class="sxs-lookup"><span data-stu-id="dedff-113">The registry functions also support collecting data from **V2 providers** via a translation layer that calls into the [V2 Consumer functions](using-the-perflib-functions-to-consume-counter-data.md).</span></span>

<span data-ttu-id="dedff-114">Чтобы получить данные о производительности из локальной системы, вызовите функцию [**процедура RegQueryValueEx**](/windows/win32/api/winreg/nf-winreg-regqueryvalueexw) .</span><span class="sxs-lookup"><span data-stu-id="dedff-114">To obtain performance data from the local system, call the [**RegQueryValueEx**](/windows/win32/api/winreg/nf-winreg-regqueryvalueexw) function.</span></span> <span data-ttu-id="dedff-115">Используйте `HKEY_PERFORMANCE_DATA` в качестве ключа.</span><span class="sxs-lookup"><span data-stu-id="dedff-115">Use `HKEY_PERFORMANCE_DATA` as the key.</span></span> <span data-ttu-id="dedff-116">Первый вызов открывает ключ.</span><span class="sxs-lookup"><span data-stu-id="dedff-116">The first call opens the key.</span></span> <span data-ttu-id="dedff-117">Сначала не нужно открывать ключ явным образом.</span><span class="sxs-lookup"><span data-stu-id="dedff-117">You do not need to explicitly open the key first.</span></span>

<span data-ttu-id="dedff-118">Чтобы получить данные о производительности из удаленной системы, вызовите функцию [**регконнектрегистри**](/windows/desktop/api/winreg/nf-winreg-regconnectregistryw) .</span><span class="sxs-lookup"><span data-stu-id="dedff-118">To obtain performance data from a remote system, call the [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistryw) function.</span></span> <span data-ttu-id="dedff-119">Используйте имя компьютера удаленной системы и используйте `HKEY_PERFORMANCE_DATA` его в качестве ключа.</span><span class="sxs-lookup"><span data-stu-id="dedff-119">Use the computer name of the remote system and use `HKEY_PERFORMANCE_DATA` as the key.</span></span> <span data-ttu-id="dedff-120">Этот вызов извлекает ключ, представляющий данные о производительности для удаленной системы.</span><span class="sxs-lookup"><span data-stu-id="dedff-120">This call retrieves a key representing the performance data for the remote system.</span></span> <span data-ttu-id="dedff-121">Используйте этот ключ вместо `HKEY_PERFORMANCE_DATA` Key для получения данных.</span><span class="sxs-lookup"><span data-stu-id="dedff-121">Use this key rather than `HKEY_PERFORMANCE_DATA` key to retrieve the data.</span></span>

<span data-ttu-id="dedff-122">Не забудьте использовать функцию [**Ошибка RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) , чтобы закрыть маркер к ключу по завершении получения данных о производительности.</span><span class="sxs-lookup"><span data-stu-id="dedff-122">Be sure to use the [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) function to close the handle to the key when you are finished obtaining the performance data.</span></span> <span data-ttu-id="dedff-123">Это важно для локальных и удаленных вариантов:</span><span class="sxs-lookup"><span data-stu-id="dedff-123">This is important for both the local and remote cases:</span></span>

- <span data-ttu-id="dedff-124">`RegCloseKey(HKEY_PERFORMANCE_DATA)` фактически не закрывает обработчик реестра, но очищает все кэшированные данные и освобождает загруженные библиотеки DLL производительности.</span><span class="sxs-lookup"><span data-stu-id="dedff-124">`RegCloseKey(HKEY_PERFORMANCE_DATA)` does not actually close a registry handle, but it clears all cached data and frees the loaded performance DLLs.</span></span>
- <span data-ttu-id="dedff-125">`RegCloseKey(hkeyRemotePerformanceData)` закрывает обработчик в реестре удаленного компьютера.</span><span class="sxs-lookup"><span data-stu-id="dedff-125">`RegCloseKey(hkeyRemotePerformanceData)` closes the handle to the remote machine's registry.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="dedff-126">Не вызывайте `RegCloseKey(HKEY_PERFORMANCE_DATA)` во время `DLL_PROCESS_DETACH` .</span><span class="sxs-lookup"><span data-stu-id="dedff-126">Do not call `RegCloseKey(HKEY_PERFORMANCE_DATA)` during `DLL_PROCESS_DETACH`.</span></span>

<span data-ttu-id="dedff-127">`lpValueName`Для указания извлекаемой информации используется параметр функции [**процедура RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) .</span><span class="sxs-lookup"><span data-stu-id="dedff-127">You use the `lpValueName` parameter of the [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) function to indicate the information to retrieve.</span></span> <span data-ttu-id="dedff-128">В следующей таблице перечислены значения, которые можно указать для `lpValueName` .</span><span class="sxs-lookup"><span data-stu-id="dedff-128">The following table lists the values you can specify for `lpValueName`.</span></span> <span data-ttu-id="dedff-129">Обратите внимание, что строки значений не учитывают регистр.</span><span class="sxs-lookup"><span data-stu-id="dedff-129">Note that the value strings are not case-sensitive.</span></span>

|<span data-ttu-id="dedff-130">Значение</span><span class="sxs-lookup"><span data-stu-id="dedff-130">Value</span></span>|<span data-ttu-id="dedff-131">Описание</span><span class="sxs-lookup"><span data-stu-id="dedff-131">Description</span></span>
|-----|-----------
|`Global`| <span data-ttu-id="dedff-132">Получает данные о производительности для всех объектов производительности, зарегистрированных на компьютере, за исключением тех, которые включены в `Costly` категорию.</span><span class="sxs-lookup"><span data-stu-id="dedff-132">Retrieves performance data for all performance objects registered on the computer except for those included in the `Costly` category.</span></span>
|`OLD_Global`| <span data-ttu-id="dedff-133">**Windows Vista и более поздние версии:** Получает данные о производительности для всех объектов производительности **v1** , зарегистрированных на компьютере, за исключением тех, которые включены в `Costly` категорию.</span><span class="sxs-lookup"><span data-stu-id="dedff-133">**Windows Vista and later:** Retrieves performance data for all **V1** performance objects registered on the computer except for those included in the `Costly` category.</span></span> <span data-ttu-id="dedff-134">Используйте этот параметр вместо того, `Global` чтобы собирать ненужные данные поставщика v2, если известно, что интересующие данные поступают от поставщика v1.</span><span class="sxs-lookup"><span data-stu-id="dedff-134">Use this instead of `Global` to avoid collecting unnecessary V2 provider data when you know that the data of interest comes from a V1 provider.</span></span>
|`n1 n2 ...`| <span data-ttu-id="dedff-135">Получает данные производительности для одного или нескольких объектов производительности.</span><span class="sxs-lookup"><span data-stu-id="dedff-135">Retrieves performance data for one or more performance objects.</span></span> <span data-ttu-id="dedff-136">Укажите десятичный индекс, связанный с каждым объектом, который необходимо получить, в списке с разделителями-пробелами.</span><span class="sxs-lookup"><span data-stu-id="dedff-136">Specify the decimal index associated with each object that you want to retrieve in a space-separated list.</span></span> <span data-ttu-id="dedff-137">Например, если требуется получить объекты системы и памяти и определить, что индексы соответствующих строк имени — 2 и 4, укажите строку `"2 4"` .</span><span class="sxs-lookup"><span data-stu-id="dedff-137">For example, if you want to retrieve System and Memory objects and you have determined that the indexes of the corresponding name strings are 2 and 4, specify the string `"2 4"`.</span></span> <span data-ttu-id="dedff-138">Обратите внимание, что запрос может возвращать разное количество объектов, чем вы запрашивали.</span><span class="sxs-lookup"><span data-stu-id="dedff-138">Note that the query can return a different number of objects than you requested.</span></span> <span data-ttu-id="dedff-139">Это может произойти, если указанный объект недоступен, если указанный объект зависит от типа другого объекта или если поставщик иным образом возвращает данные, которые не были запрошены напрямую.</span><span class="sxs-lookup"><span data-stu-id="dedff-139">This can happen if the specified object is unavailable, if the specified object depends on another object type, or if a provider otherwise returns data that was not directly requested.</span></span> <span data-ttu-id="dedff-140">Например, потоки зависят от процессов, поэтому при запросе данных из `Thread` объекта результаты будут содержать данные из `Process` объекта.</span><span class="sxs-lookup"><span data-stu-id="dedff-140">For example, threads depend on processes, so if you request data from the `Thread` object, the results will include data from the `Process` object.</span></span>
|`Counter n`| <span data-ttu-id="dedff-141">Получает строки имен для указанного идентификатора языка, например "Английский для" `Counter 9` .</span><span class="sxs-lookup"><span data-stu-id="dedff-141">Retrieves name strings for the specified language identifier, e.g. English for `Counter 9`.</span></span> <span data-ttu-id="dedff-142">Используйте возвращенные строки имени, чтобы найти индекс, соответствующий заданному имени, или найти имя, соответствующее заданному индексу.</span><span class="sxs-lookup"><span data-stu-id="dedff-142">Use the returned name strings to find the index corresponding to a given name or to find the name corresponding to a given index.</span></span> <span data-ttu-id="dedff-143">Дополнительные сведения см. в разделе [Получение имен счетчиков и текста справки](retrieving-counter-names-and-help-text.md) .</span><span class="sxs-lookup"><span data-stu-id="dedff-143">See [Retrieving Counter Names and Help Text](retrieving-counter-names-and-help-text.md) for details.</span></span> <span data-ttu-id="dedff-144">Обратите внимание, что возвращаемый список содержит как имена объектов (CounterSet), так и имена счетчиков — нет простого способа определить, является ли имя именем объекта или именем счетчика.</span><span class="sxs-lookup"><span data-stu-id="dedff-144">Note that the returned list includes both object (counterset) names and counter names -- there is no simple way to determine whether a name is an object name or a counter name.</span></span>
|`Help n`| <span data-ttu-id="dedff-145">Извлекает строки справки для указанного идентификатора языка, например "Английский (для)" `Help 9` .</span><span class="sxs-lookup"><span data-stu-id="dedff-145">Retrieves help strings for the specified language identifier, e.g. English for `Help 9`.</span></span> <span data-ttu-id="dedff-146">Используйте возвращенные строки справки, чтобы найти описания, соответствующие объектам (CounterSet) или индексам справки по счетчикам.</span><span class="sxs-lookup"><span data-stu-id="dedff-146">Use the returned help strings to find descriptions corresponding to object (counterset) or counter help indexes.</span></span> <span data-ttu-id="dedff-147">Дополнительные сведения см. в разделе [Получение имен счетчиков и текста справки](retrieving-counter-names-and-help-text.md) .</span><span class="sxs-lookup"><span data-stu-id="dedff-147">See [Retrieving Counter Names and Help Text](retrieving-counter-names-and-help-text.md) for details.</span></span>
|`Costly`| <span data-ttu-id="dedff-148">Не **рекомендуется:** Получает данные о производительности для типов объектов, данные которых затратны для накопления с точки зрения процессорного времени или использования памяти.</span><span class="sxs-lookup"><span data-stu-id="dedff-148">**Deprecated:** Retrieves performance data for object types whose data is expensive to collect in terms of processor time or memory usage.</span></span> <span data-ttu-id="dedff-149">На сильно загруженном компьютере эта коллекция может занять несколько минут.</span><span class="sxs-lookup"><span data-stu-id="dedff-149">This collection may take several minutes on a heavily-loaded machine.</span></span> <span data-ttu-id="dedff-150">Коллекцию следует выполнять в рабочем потоке, если приложение должно отвечать пользователю во время сбора данных.</span><span class="sxs-lookup"><span data-stu-id="dedff-150">You should perform the collection on a worker thread if your application needs to respond to the user during this data collection.</span></span>

<span data-ttu-id="dedff-151">Дополнительные сведения о формате данных производительности, возвращаемых реестром, см. в разделе [Формат данных производительности](performance-data-format.md).</span><span class="sxs-lookup"><span data-stu-id="dedff-151">For details on the format of the performance data that the registry returns, see [Performance Data Format](performance-data-format.md).</span></span>

<span data-ttu-id="dedff-152">Пример получения имен и описаний зарегистрированных счетчиков на компьютере см. в разделе [Получение имен счетчиков и текста справки](retrieving-counter-names-and-help-text.md).</span><span class="sxs-lookup"><span data-stu-id="dedff-152">For an example that gets the names and descriptions of the registered counters on the computer, see [Retrieving Counter Names and Help Text](retrieving-counter-names-and-help-text.md).</span></span>

<span data-ttu-id="dedff-153">Пример, который обращается к компонентам данных производительности, см. в разделе [Отображение имен объектов, экземпляров и счетчиков](displaying-object-instance-and-counter-names.md).</span><span class="sxs-lookup"><span data-stu-id="dedff-153">For an example that accesses the components of the performance data, see [Displaying Object, Instance, and Counter Names](displaying-object-instance-and-counter-names.md).</span></span>

<span data-ttu-id="dedff-154">Пример, который извлекает, вычисляет и печатает значения счетчиков, см. в разделе [Получение данных счетчика](retrieving-counter-data.md) и [Вычисление значений счетчиков](calculating-counter-values.md).</span><span class="sxs-lookup"><span data-stu-id="dedff-154">For an example that retrieves, computes, and prints counter values, see [Retrieving Counter Data](retrieving-counter-data.md) and [Calculating Counter Values](calculating-counter-values.md).</span></span>
