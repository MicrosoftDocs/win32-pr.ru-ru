---
description: После создания запроса и добавления в него счетчиков вызовите функцию Пдхколлекткуеридата, чтобы получить текущие необработанные данные для всех счетчиков в запросе.
ms.assetid: 2534d387-a280-4716-9a9d-3e42f40e2f92
title: Сбор данных о производительности
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e99bd2c0e22553245e87d3844694051c88c57895
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104345522"
---
# <a name="collecting-performance-data"></a><span data-ttu-id="02d3c-103">Сбор данных о производительности</span><span class="sxs-lookup"><span data-stu-id="02d3c-103">Collecting Performance Data</span></span>

<span data-ttu-id="02d3c-104">После [создания запроса](creating-a-query.md) и добавления в него счетчиков вызовите функцию [**пдхколлекткуеридата**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) , чтобы получить текущие необработанные данные для всех счетчиков в запросе.</span><span class="sxs-lookup"><span data-stu-id="02d3c-104">After [creating a query](creating-a-query.md) and adding counters to it, call the [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) function to retrieve the current raw data for all counters in the query.</span></span>

<span data-ttu-id="02d3c-105">Многие счетчики, например счетчики скорости, занимают два образца данных для вычисления форматированного значения данных.</span><span class="sxs-lookup"><span data-stu-id="02d3c-105">Many counters, such as rate counters, require two data samples to calculate a formatted data value.</span></span> <span data-ttu-id="02d3c-106">PDH сохраняет данные для текущего примера и ранее собранного примера.</span><span class="sxs-lookup"><span data-stu-id="02d3c-106">PDH maintains data for the current sample and the previously collected sample.</span></span> <span data-ttu-id="02d3c-107">В следующей процедуре описывается сбор значений счетчиков, требующих двух выборок для вычисления отображаемого значения.</span><span class="sxs-lookup"><span data-stu-id="02d3c-107">The following procedure describes how to collect counter values that require two samples to calculate a displayable value.</span></span>

<span data-ttu-id="02d3c-108">**Сбор значений счетчика, требующих двух выборок для вычисления воспроизводимого значения**</span><span class="sxs-lookup"><span data-stu-id="02d3c-108">**To collect counter values that require two samples to calculate a displayable value**</span></span>

1.  <span data-ttu-id="02d3c-109">Вызовите [**пдхколлекткуеридата**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) , чтобы получить первый пример.</span><span class="sxs-lookup"><span data-stu-id="02d3c-109">Call [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) to collect the first sample.</span></span>
2.  <span data-ttu-id="02d3c-110">Вызовите функцию [**Sleep**](/windows/desktop/api/synchapi/nf-synchapi-sleep) , чтобы подождать минимум одну секунду между коллекциями.</span><span class="sxs-lookup"><span data-stu-id="02d3c-110">Call the [**Sleep**](/windows/desktop/api/synchapi/nf-synchapi-sleep) function to wait a minimum of one second between collections.</span></span>
3.  <span data-ttu-id="02d3c-111">Вызовите [**пдхколлекткуеридата**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) еще раз, чтобы получить второй пример.</span><span class="sxs-lookup"><span data-stu-id="02d3c-111">Call [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) again to collect the second sample.</span></span>
4.  <span data-ttu-id="02d3c-112">Вызовите функцию [**пдхжетформаттедкаунтервалуе**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue) , чтобы вычислить отображаемое значение.</span><span class="sxs-lookup"><span data-stu-id="02d3c-112">Call the [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue) function to calculate a displayable value.</span></span>
5.  <span data-ttu-id="02d3c-113">Повторите шаги с 2 по 4.</span><span class="sxs-lookup"><span data-stu-id="02d3c-113">Repeat steps 2 through 4.</span></span>

<span data-ttu-id="02d3c-114">В качестве альтернативы реализации периода ожидания можно вызвать функцию [**пдхколлекткуеридатаекс**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydataex) , которая создает поток времени, который ожидает заданный промежуток времени, собирает пример, а затем запускает определяемое приложением событие.</span><span class="sxs-lookup"><span data-stu-id="02d3c-114">As an alternative to implementing a wait period yourself, you can call the [**PdhCollectQueryDataEx**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydataex) function, which creates a timing thread that waits a specified amount of time, collects the sample, and then triggers an application-defined event.</span></span>

<span data-ttu-id="02d3c-115">Если требуется запросить данные о производительности из файла журнала, можно также определить диапазон времени.</span><span class="sxs-lookup"><span data-stu-id="02d3c-115">If you want to query performance data from a log file, you can also define a time range.</span></span> <span data-ttu-id="02d3c-116">Диапазон времени ограничивает запрос образцами, собранными в пределах диапазона времени (каждый пример содержит отметку времени для момента сбора данных).</span><span class="sxs-lookup"><span data-stu-id="02d3c-116">The time range limits the query to those samples that were collected within the time range (each sample contains a time stamp for when it was collected).</span></span> <span data-ttu-id="02d3c-117">Дополнительные сведения о том, как задать и получить диапазоны времени, см. в разделе [Задание диапазона времени для запроса](setting-a-time-range-for-a-query.md).</span><span class="sxs-lookup"><span data-stu-id="02d3c-117">For more information on how to set and retrieve time ranges, see [Setting a Time Range for a Query](setting-a-time-range-for-a-query.md).</span></span>

<span data-ttu-id="02d3c-118">Если вы хотите получить данные о производительности и записать их в файл журнала, вместо вызова [**пдхколлекткуеридата**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata)следует вызвать функцию [**пдхупдателог**](/windows/desktop/api/Pdh/nf-pdh-pdhupdateloga) .</span><span class="sxs-lookup"><span data-stu-id="02d3c-118">If you want to collect performance data and write it to a log file, you would call the [**PdhUpdateLog**](/windows/desktop/api/Pdh/nf-pdh-pdhupdateloga) function instead of calling [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata).</span></span> <span data-ttu-id="02d3c-119">Дополнительные сведения см. в разделе [Работа с файлами журналов](working-with-log-files.md) и [запись данных о производительности в файл журнала](writing-performance-data-to-a-log-file.md).</span><span class="sxs-lookup"><span data-stu-id="02d3c-119">For details, see [Working with Log Files](working-with-log-files.md) and [Writing Performance Data to a Log File](writing-performance-data-to-a-log-file.md).</span></span>

<span data-ttu-id="02d3c-120">Дополнительные сведения о вычислении отображаемого демонстрационного значения см. в разделе [Отображение данных о производительности](displaying-performance-data.md).</span><span class="sxs-lookup"><span data-stu-id="02d3c-120">For details on calculating a displayable sample value, see [Displaying Performance Data](displaying-performance-data.md).</span></span>

## <a name="understanding-multiple-processor-counters"></a><span data-ttu-id="02d3c-121">Основные сведения о нескольких счетчиках процессоров</span><span class="sxs-lookup"><span data-stu-id="02d3c-121">Understanding Multiple Processor Counters</span></span>

<span data-ttu-id="02d3c-122">Некоторые счетчики производительности были разработаны для однопроцессорных систем и могут быть неточными для многопроцессорных компьютеров.</span><span class="sxs-lookup"><span data-stu-id="02d3c-122">Some performance counters were designed for single processor systems and might not be accurate for multiprocessor computers.</span></span> <span data-ttu-id="02d3c-123">Например, процесс ограничен 100% от одного процессора; Однако его потоки могут использовать несколько процессоров, что позволяет суммировать более 100 процентов.</span><span class="sxs-lookup"><span data-stu-id="02d3c-123">For example, a process is limited to 100 percent of a single processor; however, its threads can use several processors, totaling more than 100 percent.</span></span>

<span data-ttu-id="02d3c-124">\\ \_ Значение счетчика "процессор (всего) \\ % загруженности процессора" представляет собой среднее использование всех процессоров.</span><span class="sxs-lookup"><span data-stu-id="02d3c-124">The "\\Processor(\_Total)\\% Processor Time" counter value is the average usage of all processors.</span></span> <span data-ttu-id="02d3c-125">Например, если у вас есть два процессора, по одному на 100 процентов, а второй — 0%, этот счетчик сообщит 50%.</span><span class="sxs-lookup"><span data-stu-id="02d3c-125">For example, if you have two processors, one at 100 percent and another at 0 percent, this counter will report 50 percent.</span></span> <span data-ttu-id="02d3c-126">Таким образом, диапазон составляет от 0 до 100.</span><span class="sxs-lookup"><span data-stu-id="02d3c-126">So the range is from 0 through 100.</span></span>

<span data-ttu-id="02d3c-127">\\Значение счетчика "процесс (X) \\ % времени процесса" — это сумма использования процессора всеми потоками процесса X. Например, на компьютере с двумя процессорами, если процесс состоит из двух потоков, один из которых занимает 75% ресурсов ЦП, а второй — 80 процентов другого ЦП, этот счетчик сообщит об 155%.</span><span class="sxs-lookup"><span data-stu-id="02d3c-127">The "\\Process(X)\\% Process Time" counter value is the sum of the processor usage by all threads of process X. For example, in a computer with two processors, if a process has two threads, one taking up 75 percent of a CPU and the other taking 80 percent of another CPU, this counter will report 155 percent.</span></span> <span data-ttu-id="02d3c-128">Диапазон для этого счетчика — от 0 до 100 \* ProcessorCount.</span><span class="sxs-lookup"><span data-stu-id="02d3c-128">The range for this counter is from 0 through 100 \* ProcessorCount.</span></span>

<span data-ttu-id="02d3c-129">\* \* Windows Server 2003 и Windows XP: \* \*</span><span class="sxs-lookup"><span data-stu-id="02d3c-129">\*\*Windows Server 2003 and Windows XP:  \*\*</span></span>

<span data-ttu-id="02d3c-130">Можно получить значения за пределами ожидаемого диапазона значений загрузки ЦП.</span><span class="sxs-lookup"><span data-stu-id="02d3c-130">You can receive values outside the expected range of values for CPU usage.</span></span> <span data-ttu-id="02d3c-131">Чтобы вычислить процент загрузки ЦП, для PDH требуется два образца (каждый с необработанным значением и отметка времени).</span><span class="sxs-lookup"><span data-stu-id="02d3c-131">To calculate the percentage of CPU usage, PDH needs two samples (each with a raw value and a time stamp).</span></span> <span data-ttu-id="02d3c-132">Так как PDH использует только имя экземпляра для сопоставления процессов, иногда может использоваться два образца из разных процессов.</span><span class="sxs-lookup"><span data-stu-id="02d3c-132">Because PDH uses only the instance name to match the processes, it can sometimes use two samples from different processes.</span></span> <span data-ttu-id="02d3c-133">Например, если выполняется выборка из трех процессов и один процесс завершается после третьего примера, другой процесс переместится в слот, освобожденный этим завершенным процессом.</span><span class="sxs-lookup"><span data-stu-id="02d3c-133">For example, if three processes are being sampled and one process is terminated after the third sample, another process will move to the slot vacated by that terminated process.</span></span> <span data-ttu-id="02d3c-134">В результате отформатированный счетчик предоставит неверное значение при форматировании четвертого примера, так как он использует третий пример из завершенного процесса и четвертый пример из процесса, который был перемещен в слот прерванного процесса.</span><span class="sxs-lookup"><span data-stu-id="02d3c-134">As a result, a formatted counter will provide an incorrect value when you format the fourth sample, because it’s using the third sample from the terminated process and the fourth sample from the process that moved into the terminated process's slot.</span></span>

<span data-ttu-id="02d3c-135">В следующей таблице показано, как это может произойти при завершении процесса сбора данных.</span><span class="sxs-lookup"><span data-stu-id="02d3c-135">The following table shows how this can occur if a process is terminated while data is being collected.</span></span> <span data-ttu-id="02d3c-136">В таблице показаны пять выборок значений счетчиков для трех экземпляров процесса X. Эти примеры собираются через одну секунду.</span><span class="sxs-lookup"><span data-stu-id="02d3c-136">The table shows five counter value samples for three instances of process X. The samples are collected in one second intervals.</span></span> <span data-ttu-id="02d3c-137">После сбора третьего примера процесс X в слоте 1 завершается.</span><span class="sxs-lookup"><span data-stu-id="02d3c-137">After the third sample is collected, process X in slot 1 is terminated.</span></span> <span data-ttu-id="02d3c-138">Когда процесс X в слоте 1 завершается, процесс X в слоте 2 перемещается в слот 1.</span><span class="sxs-lookup"><span data-stu-id="02d3c-138">When process X in slot 1 is terminated, process X in slot 2 moves to slot 1.</span></span> <span data-ttu-id="02d3c-139">Когда вы соберете четвертый пример для процесса X в слоте 2, первое значение теперь равно 20, а не 1 000, а второе значение — 1 500.</span><span class="sxs-lookup"><span data-stu-id="02d3c-139">When you collect the fourth sample for process X in slot 2, the first value is now 20 instead of 1,000, and the second value is 1,500.</span></span> <span data-ttu-id="02d3c-140">При форматировании значения счетчика выдается 1 480 миллисекунд вместо ожидаемого 500 миллисекунд.</span><span class="sxs-lookup"><span data-stu-id="02d3c-140">When you format the counter value, you get 1,480 milliseconds instead of the expected 500 milliseconds.</span></span> <span data-ttu-id="02d3c-141">При форматировании пятого значения выборки должно быть получено ожидаемое значение.</span><span class="sxs-lookup"><span data-stu-id="02d3c-141">When you format the fifth sample value, you should get the expected value.</span></span>

| <span data-ttu-id="02d3c-142">Образец</span><span class="sxs-lookup"><span data-stu-id="02d3c-142">Sample</span></span>   | <span data-ttu-id="02d3c-143">Слот 0 для процесса X</span><span class="sxs-lookup"><span data-stu-id="02d3c-143">Slot 0 for process X</span></span> | <span data-ttu-id="02d3c-144">Слот 1 для процесса X</span><span class="sxs-lookup"><span data-stu-id="02d3c-144">Slot 1 for process X</span></span>           | <span data-ttu-id="02d3c-145">Слот 2 для процесса X</span><span class="sxs-lookup"><span data-stu-id="02d3c-145">Slot 2 for process X</span></span>                     |
|----------|----------------------|--------------------------------|------------------------------------------|
| <span data-ttu-id="02d3c-146">Пример 1</span><span class="sxs-lookup"><span data-stu-id="02d3c-146">Sample 1</span></span> | <span data-ttu-id="02d3c-147">0</span><span class="sxs-lookup"><span data-stu-id="02d3c-147">0</span></span>                    | <span data-ttu-id="02d3c-148">0</span><span class="sxs-lookup"><span data-stu-id="02d3c-148">0</span></span>                              | <span data-ttu-id="02d3c-149">0</span><span class="sxs-lookup"><span data-stu-id="02d3c-149">0</span></span>                                        |
| <span data-ttu-id="02d3c-150">Пример 2</span><span class="sxs-lookup"><span data-stu-id="02d3c-150">Sample 2</span></span> | <span data-ttu-id="02d3c-151">20</span><span class="sxs-lookup"><span data-stu-id="02d3c-151">20</span></span>                   | <span data-ttu-id="02d3c-152">10</span><span class="sxs-lookup"><span data-stu-id="02d3c-152">10</span></span>                             | <span data-ttu-id="02d3c-153">500</span><span class="sxs-lookup"><span data-stu-id="02d3c-153">500</span></span>                                      |
| <span data-ttu-id="02d3c-154">Пример 3</span><span class="sxs-lookup"><span data-stu-id="02d3c-154">Sample 3</span></span> | <span data-ttu-id="02d3c-155">40</span><span class="sxs-lookup"><span data-stu-id="02d3c-155">40</span></span>                   | <span data-ttu-id="02d3c-156">20</span><span class="sxs-lookup"><span data-stu-id="02d3c-156">20</span></span>                             | <span data-ttu-id="02d3c-157">1000</span><span class="sxs-lookup"><span data-stu-id="02d3c-157">1,000</span></span>                                    |
| <span data-ttu-id="02d3c-158">Пример 4</span><span class="sxs-lookup"><span data-stu-id="02d3c-158">Sample 4</span></span> | <span data-ttu-id="02d3c-159">60</span><span class="sxs-lookup"><span data-stu-id="02d3c-159">60</span></span>                   | <span data-ttu-id="02d3c-160">1 500 (из первого слота 2)</span><span class="sxs-lookup"><span data-stu-id="02d3c-160">1,500 (from the former slot 2)</span></span> | <span data-ttu-id="02d3c-161">Не применяется</span><span class="sxs-lookup"><span data-stu-id="02d3c-161">Not applicable.</span></span> <span data-ttu-id="02d3c-162">Теперь собраны в слот 1.</span><span class="sxs-lookup"><span data-stu-id="02d3c-162">Now collected in slot 1.</span></span> |
| <span data-ttu-id="02d3c-163">Пример 5</span><span class="sxs-lookup"><span data-stu-id="02d3c-163">Sample 5</span></span> | <span data-ttu-id="02d3c-164">80</span><span class="sxs-lookup"><span data-stu-id="02d3c-164">80</span></span>                   | <span data-ttu-id="02d3c-165">2 000</span><span class="sxs-lookup"><span data-stu-id="02d3c-165">2,000</span></span>                          | <span data-ttu-id="02d3c-166">Не применяется</span><span class="sxs-lookup"><span data-stu-id="02d3c-166">Not applicable.</span></span> <span data-ttu-id="02d3c-167">Теперь собраны в слот 1.</span><span class="sxs-lookup"><span data-stu-id="02d3c-167">Now collected in slot 1.</span></span> |



 

 

 
