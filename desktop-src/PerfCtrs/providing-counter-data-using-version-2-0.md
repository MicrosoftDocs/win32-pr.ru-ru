---
description: В версии 2,0 счетчики производительности изменили архитектуру, чтобы упростить процесс предоставления данных счетчиков потребителям.
ms.assetid: 37f75b15-3f52-4259-a6d9-5a1a14f88379
title: Предоставление данных счетчиков с помощью версии 2,0
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: 67976c8a0b6c77582ed8c50c2e5cf753c77fcf6b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105663162"
---
# <a name="providing-counter-data-using-version-20"></a><span data-ttu-id="30487-103">Предоставление данных счетчиков с помощью версии 2,0</span><span class="sxs-lookup"><span data-stu-id="30487-103">Providing Counter Data Using Version 2.0</span></span>

<span data-ttu-id="30487-104">Современные поставщики данных производительности используют манифест для определения данных счетчиков и использования API поставщика счетчиков производительности для управления данными в контексте поставщика.</span><span class="sxs-lookup"><span data-stu-id="30487-104">Modern performance data providers use a manifest to define the counter data and use performance counter provider APIs to manage data within the context of the provider.</span></span> <span data-ttu-id="30487-105">Поставщики, реализованные с использованием манифеста и API поставщика счетчиков производительности, часто называются **поставщиками версии 2**.</span><span class="sxs-lookup"><span data-stu-id="30487-105">Providers implemented using a manifest and performance counter provider APIs are often called **V2 providers**.</span></span> <span data-ttu-id="30487-106">Windows поддерживает поставщики пользовательского режима v2 в Windows Vista или более поздних версиях и поставщики в режиме ядра v2 в Windows 7 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="30487-106">Windows supports user-mode V2 providers on Windows Vista or later and kernel-mode V2 providers on Windows 7 or later.</span></span>

<span data-ttu-id="30487-107">На этой странице описываются поставщики пользовательского режима v2.</span><span class="sxs-lookup"><span data-stu-id="30487-107">This page describes user-mode V2 providers.</span></span> <span data-ttu-id="30487-108">Дополнительные сведения о поставщиках в режиме ядра v2 см. в разделе [мониторинг производительности в режиме ядра](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).</span><span class="sxs-lookup"><span data-stu-id="30487-108">For information about kernel-mode V2 providers, see [Kernel Mode Performance Monitoring](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).</span></span>

<span data-ttu-id="30487-109">В среде выполнения поставщики версии 2 работают следующим образом:</span><span class="sxs-lookup"><span data-stu-id="30487-109">At runtime, V2 providers work as follows:</span></span>

- <span data-ttu-id="30487-110">Процесс поставщика регистрируется в системе счетчиков производительности Windows путем вызова Перфстартпровидер и Перфсеткаунтерсетинфо.</span><span class="sxs-lookup"><span data-stu-id="30487-110">The provider process registers itself with the Windows Performance Counter system by calling PerfStartProvider and PerfSetCounterSetInfo.</span></span> <span data-ttu-id="30487-111">Поставщик дополнительно предоставляет функцию обратного вызова, которая будет получать уведомления о запросах потребителей.</span><span class="sxs-lookup"><span data-stu-id="30487-111">The provider optionally provides a callback function that will be notified about consumer requests.</span></span>
- <span data-ttu-id="30487-112">Процесс поставщика добавляет или удаляет экземпляры соответствующим образом с помощью Перфкреатеинстанце и Перфделетеинстанце.</span><span class="sxs-lookup"><span data-stu-id="30487-112">The provider process adds or removes instances as appropriate using PerfCreateInstance and PerfDeleteInstance.</span></span> <span data-ttu-id="30487-113">Поставщик обновляет значения счетчиков при их изменении с помощью API-интерфейсов Perf.</span><span class="sxs-lookup"><span data-stu-id="30487-113">The provider updates counter values when they change using PerfSet\*\*_ APIs.</span></span>
- <span data-ttu-id="30487-114">Потребитель выполняет запрос данных из CounterSet.</span><span class="sxs-lookup"><span data-stu-id="30487-114">A consumer makes a request for data from a counterset.</span></span> <span data-ttu-id="30487-115">Система проверяет, имеет ли вызывающий объект разрешения на получение данных.</span><span class="sxs-lookup"><span data-stu-id="30487-115">The system verifies that the caller has permissions to collect the data.</span></span> <span data-ttu-id="30487-116">Затем система использует рабочий поток, выполняющийся в процессе поставщика, для обработки запроса, вызывая функцию обратного вызова поставщика, если это уместно.</span><span class="sxs-lookup"><span data-stu-id="30487-116">The system then uses a worker thread running in the provider process to handle the request, invoking the provider's callback function if appropriate.</span></span> <span data-ttu-id="30487-117">Рабочий поток копирует собранные данные в управляемый системой буфер, а затем система возвращает данные потребителю.</span><span class="sxs-lookup"><span data-stu-id="30487-117">The worker thread copies the collected data into a system-managed buffer, and the system then returns the data to the consumer.</span></span>

## <a name="steps-to-creating-a-provider"></a><span data-ttu-id="30487-118">Действия по созданию поставщика</span><span class="sxs-lookup"><span data-stu-id="30487-118">Steps to creating a provider</span></span>

1. <span data-ttu-id="30487-119">Напишите манифест, определяющий данные счетчика, которые предоставит поставщик.</span><span class="sxs-lookup"><span data-stu-id="30487-119">Write a manifest that defines the counter data that your provider will provide.</span></span> <span data-ttu-id="30487-120">Дополнительные сведения о создании манифеста см. в разделе [схема счетчиков производительности](performance-counters-schema.md).</span><span class="sxs-lookup"><span data-stu-id="30487-120">For details on writing the manifest, see [Performance Counters Schema](performance-counters-schema.md).</span></span>
2. <span data-ttu-id="30487-121">Используйте [КТРПП](ctrpp.md) для создания кода шаблона, который вы включаете в поставщик.</span><span class="sxs-lookup"><span data-stu-id="30487-121">Use [CTRPP](ctrpp.md) to generate the template code that you include in your provider.</span></span> <span data-ttu-id="30487-122">Код шаблона включает структуры, которые определяют наборы счетчиков, функции [_ *каунтеринитиализе* \*](counterinitialize.md) и [**каунтерклеануп**](countercleanup.md) и строки ресурсов.</span><span class="sxs-lookup"><span data-stu-id="30487-122">The template code includes the structures that define the counter sets, the [_ *CounterInitialize*\*](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions, and the resource strings.</span></span>

   <span data-ttu-id="30487-123">Поставщик должен вызывать функции [**каунтеринитиализе**](counterinitialize.md) и [**каунтерклеануп**](countercleanup.md) .</span><span class="sxs-lookup"><span data-stu-id="30487-123">Your provider must call the [**CounterInitialize**](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions.</span></span> <span data-ttu-id="30487-124">**Каунтеринитиализе** вызывает функцию [**перфстартпровидер**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) для регистрации поставщика, а также вызывает функцию [**перфсеткаунтерсетинфо**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) для инициализации набора счетчиков.</span><span class="sxs-lookup"><span data-stu-id="30487-124">The **CounterInitialize** calls the [**PerfStartProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) function to register the provider and also calls the [**PerfSetCounterSetInfo**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) function to initialize the counter set.</span></span> <span data-ttu-id="30487-125">**Каунтерклеануп** вызывает функцию [**перфстоппровидер**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) для удаления регистрации поставщика.</span><span class="sxs-lookup"><span data-stu-id="30487-125">The **CounterCleanup** calls the [**PerfStopProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) function to remove the provider's registration.</span></span>

3. <span data-ttu-id="30487-126">Включите код шаблона из предыдущего шага в проект и завершите работу поставщика.</span><span class="sxs-lookup"><span data-stu-id="30487-126">Include the template code from the previous step in your project and complete your provider.</span></span>

   <span data-ttu-id="30487-127">Чтобы завершить работу поставщика, необходимо вызвать функцию [**перфкреатеинстанце**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) для каждого заданного экземпляра набора счетчиков.</span><span class="sxs-lookup"><span data-stu-id="30487-127">To complete the provider, you need to call the [**PerfCreateInstance**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) function for each instance of the counter set that you provide.</span></span>

   <span data-ttu-id="30487-128">Чтобы задать значения счетчика, вызовите одну из следующих функций:</span><span class="sxs-lookup"><span data-stu-id="30487-128">To set the counter values, call one of the following functions:</span></span>

   - [<span data-ttu-id="30487-129">**перфсетулонгкаунтервалуе**</span><span class="sxs-lookup"><span data-stu-id="30487-129">**PerfSetULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulongcountervalue)
   - [<span data-ttu-id="30487-130">**перфсетулонглонгкаунтервалуе**</span><span class="sxs-lookup"><span data-stu-id="30487-130">**PerfSetULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulonglongcountervalue)
   - [<span data-ttu-id="30487-131">**перфсеткаунтеррефвалуе**</span><span class="sxs-lookup"><span data-stu-id="30487-131">**PerfSetCounterRefValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue)

   <span data-ttu-id="30487-132">Преимущество использования [**перфсеткаунтеррефвалуе**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) заключается в том, что нет необходимости выполнять вызов функции для установки или обновления значения счетчика, просто обновить переменную локального счетчика (переменную, на которую указывает ссылка), а счетчики производительности используют указатель для доступа к значению счетчика.</span><span class="sxs-lookup"><span data-stu-id="30487-132">The benefit of using [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) is that you do not have to make a function call to set or update the counter value, you simply update your local counter variable (the variable to which the reference points) and Performance Counters uses the pointer to access the counter value.</span></span>

   <span data-ttu-id="30487-133">Если вы не используете [**перфсеткаунтеррефвалуе**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue), можно использовать следующие функции для увеличения или уменьшения значения счетчика:</span><span class="sxs-lookup"><span data-stu-id="30487-133">If you do not use [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue), you can use the following functions to increment or decrement the counter value:</span></span>

   - [<span data-ttu-id="30487-134">**перфдекрементулонгкаунтервалуе**</span><span class="sxs-lookup"><span data-stu-id="30487-134">**PerfDecrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulongcountervalue)
   - [<span data-ttu-id="30487-135">**перфдекрементулонглонгкаунтервалуе**</span><span class="sxs-lookup"><span data-stu-id="30487-135">**PerfDecrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulonglongcountervalue)
   - [<span data-ttu-id="30487-136">**перфинкрементулонгкаунтервалуе**</span><span class="sxs-lookup"><span data-stu-id="30487-136">**PerfIncrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulongcountervalue)
   - [<span data-ttu-id="30487-137">**перфинкрементулонглонгкаунтервалуе**</span><span class="sxs-lookup"><span data-stu-id="30487-137">**PerfIncrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulonglongcountervalue)

   <span data-ttu-id="30487-138">Перед завершением работы поставщика необходимо вызвать [**перфделетеинстанце**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) для каждого созданного экземпляра набора счетчиков.</span><span class="sxs-lookup"><span data-stu-id="30487-138">Before the provider exits, it must call the [**PerfDeleteInstance**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) for each counter set instance that it created.</span></span>

   <span data-ttu-id="30487-139">Если вы указали атрибут **callback** в элементе [**provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) в манифесте или использовали аргумент **-нотификатионкаллбакк** при вызове [КТРПП](ctrpp.md), необходимо реализовать функцию обратного вызова [*контролкаллбакк*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) .</span><span class="sxs-lookup"><span data-stu-id="30487-139">If you specified the **callback** attribute in the [**provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) element in your manifest or used the **-NotificationCallback** argument when calling [CTRPP](ctrpp.md), you must implement the [*ControlCallback*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) callback function.</span></span> <span data-ttu-id="30487-140">Функция обратного вызова передается в [**каунтеринитиализе**](counterinitialize.md).</span><span class="sxs-lookup"><span data-stu-id="30487-140">You pass the callback function to [**CounterInitialize**](counterinitialize.md).</span></span>

   <span data-ttu-id="30487-141">Если при вызове [КТРПП](ctrpp.md)использовался параметр **-меморираутинес** , необходимо реализовать функции обратного вызова [*аллокатемемори*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) и [*FreeMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) .</span><span class="sxs-lookup"><span data-stu-id="30487-141">If you used the **-MemoryRoutines** when calling [CTRPP](ctrpp.md), you must implement the [*AllocateMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) and [*FreeMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) callback functions.</span></span> <span data-ttu-id="30487-142">Функции обратного вызова передаются в [**каунтеринитиализе**](counterinitialize.md).</span><span class="sxs-lookup"><span data-stu-id="30487-142">You pass the callback functions to [**CounterInitialize**](counterinitialize.md).</span></span>

4. <span data-ttu-id="30487-143">При установке поставщика используйте средство LodCtr для записи имени двоичного файла, содержащего локализованные строки ресурсов и идентификаторы ресурсов, в реестр.</span><span class="sxs-lookup"><span data-stu-id="30487-143">When installing your provider, use the LodCtr tool to write the name of the binary file that contains the localized resource strings and resource IDs to the registry.</span></span> <span data-ttu-id="30487-144">Дополнительные сведения об использовании LodCtr см. в разделе [схема счетчиков производительности](performance-counters-schema.md).</span><span class="sxs-lookup"><span data-stu-id="30487-144">For details on using LodCtr, see [Performance Counters Schema](performance-counters-schema.md).</span></span>

5. <span data-ttu-id="30487-145">При удалении поставщика используйте средство lodctr для удаления сведений о поставщике из реестра.</span><span class="sxs-lookup"><span data-stu-id="30487-145">When uninstalling your provider, use the UnlodCtr tool to remove your provider's information from the registry.</span></span>
