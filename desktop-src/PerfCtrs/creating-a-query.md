---
description: Чтобы создать новый запрос, собирающий данные о производительности из источника или файла журнала в режиме реального времени, вызовите функцию Пдхопенкуери. Функция возвращает маркер запроса, который используется в последующих вызовах функции PDH.
ms.assetid: 6fd4716e-b163-47a3-b0cb-5f9599f8681f
title: Создание запроса
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5a9d50ec52966529a3476a6d375606ba3d0b538b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104156527"
---
# <a name="creating-a-query"></a><span data-ttu-id="12625-104">Создание запроса</span><span class="sxs-lookup"><span data-stu-id="12625-104">Creating a Query</span></span>

<span data-ttu-id="12625-105">Чтобы создать новый запрос, собирающий данные о производительности из источника или файла журнала в режиме реального времени, вызовите функцию [**пдхопенкуери**](/windows/desktop/api/Pdh/nf-pdh-pdhopenquerya) .</span><span class="sxs-lookup"><span data-stu-id="12625-105">To create a new query that collects performance data from a real-time source or log file, call the [**PdhOpenQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhopenquerya) function.</span></span> <span data-ttu-id="12625-106">Функция возвращает маркер запроса, который используется в последующих вызовах функции PDH.</span><span class="sxs-lookup"><span data-stu-id="12625-106">The function returns a handle to the query that you use in subsequent PDH function calls.</span></span>

<span data-ttu-id="12625-107">После создания запроса вызовите функцию [**пдхаддкаунтер**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) для каждого счетчика, который необходимо добавить в запрос.</span><span class="sxs-lookup"><span data-stu-id="12625-107">After creating the query, call the [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) function for each counter that you want to add to the query.</span></span> <span data-ttu-id="12625-108">Для указания полного пути к счетчику можно использовать один из следующих методов.</span><span class="sxs-lookup"><span data-stu-id="12625-108">You can use one of the following methods to provide the fully qualified counter path.</span></span>

-   <span data-ttu-id="12625-109">Определите путь счетчика как статическую строку.</span><span class="sxs-lookup"><span data-stu-id="12625-109">Define the counter path as a static string.</span></span> <span data-ttu-id="12625-110">Используйте этот метод, если вы всегда отслеживаете один и тот же счетчик, и если вы знакомы с правильным синтаксисом пути счетчика.</span><span class="sxs-lookup"><span data-stu-id="12625-110">Use this method if you always monitor the same counter, and if you are familiar with the correct syntax of a counter path.</span></span> <span data-ttu-id="12625-111">Сведения о правильном синтаксисе, используемом для указания счетчика, см. в разделе [Указание пути счетчика](specifying-a-counter-path.md).</span><span class="sxs-lookup"><span data-stu-id="12625-111">For information on the correct syntax used to specify a counter, see [Specifying a Counter Path](specifying-a-counter-path.md).</span></span>
-   <span data-ttu-id="12625-112">Инициализируйте [**структуру \_ \_ \_ элементов пути счетчика PDH**](/windows/desktop/api/Pdh/ns-pdh-pdh_counter_path_elements_a) с именами компьютера, объекта, счетчика и экземпляра.</span><span class="sxs-lookup"><span data-stu-id="12625-112">Initialize a [**PDH\_COUNTER\_PATH\_ELEMENTS**](/windows/desktop/api/Pdh/ns-pdh-pdh_counter_path_elements_a) structure with the names of the computer, object, counter, and instance.</span></span> <span data-ttu-id="12625-113">Передайте эту структуру в [**пдхмакекаунтерпас**](/windows/desktop/api/Pdh/nf-pdh-pdhmakecounterpatha) , которая вернет путь счетчика для указанных элементов.</span><span class="sxs-lookup"><span data-stu-id="12625-113">Pass this structure to [**PdhMakeCounterPath**](/windows/desktop/api/Pdh/nf-pdh-pdhmakecounterpatha) which will return a counter path for the specified elements.</span></span>
-   <span data-ttu-id="12625-114">Укажите путь к счетчику, который содержит подстановочные знаки, и вызовите [**пдхекспандвилдкардпас**](/windows/desktop/api/Pdh/nf-pdh-pdhexpandwildcardpatha) , чтобы получить список имен счетчиков, соответствующих подстановочным знакам в пути.</span><span class="sxs-lookup"><span data-stu-id="12625-114">Specify a counter path that contains wildcard characters and call [**PdhExpandWildCardPath**](/windows/desktop/api/Pdh/nf-pdh-pdhexpandwildcardpatha) to get a list of counter names that match the wildcard characters in the path.</span></span> <span data-ttu-id="12625-115">Просмотрите список имен счетчиков и добавьте в запрос нужные счетчики из этого списка.</span><span class="sxs-lookup"><span data-stu-id="12625-115">Scan through the list of counter names and add to the query the counters that you want from this list.</span></span>
-   <span data-ttu-id="12625-116">Вызовите функцию [**пдхбровсекаунтерс**](/windows/desktop/api/Pdh/nf-pdh-pdhbrowsecountersa) для вывода диалогового окна, позволяющего пользователю просматривать и выбирать счетчики производительности.</span><span class="sxs-lookup"><span data-stu-id="12625-116">Call the [**PdhBrowseCounters**](/windows/desktop/api/Pdh/nf-pdh-pdhbrowsecountersa) function to display a dialog box that lets the user browse and select performance counters.</span></span> <span data-ttu-id="12625-117">Дополнительные сведения см. в разделе [Просмотр счетчиков](browsing-counters.md).</span><span class="sxs-lookup"><span data-stu-id="12625-117">For more information, see [Browsing Counters](browsing-counters.md).</span></span>

<span data-ttu-id="12625-118">Обратите внимание, что если экземпляр счетчика не существует, [**пдхаддкаунтер**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) не сообщает о состоянии ошибки.</span><span class="sxs-lookup"><span data-stu-id="12625-118">Note that if a counter instance is specified that does not exist, [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) does not report an error condition.</span></span> <span data-ttu-id="12625-119">Вместо этого он возвращает ошибку \_ Success.</span><span class="sxs-lookup"><span data-stu-id="12625-119">Instead, it returns ERROR\_SUCCESS.</span></span> <span data-ttu-id="12625-120">Причина такого поведения заключается в том, что неизвестно, существует ли несуществующий экземпляр счетчика или он будет существовать, но еще не был создан.</span><span class="sxs-lookup"><span data-stu-id="12625-120">The reason for this behavior is that it is not known if a nonexistent counter instance has been specified or one that will exist but has not yet been created.</span></span>

<span data-ttu-id="12625-121">Отсутствующий экземпляр счетчика будет сообщен как [**пдхколлекткуеридата**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata), [**пдхжетравкаунтервалуе**](/windows/desktop/api/Pdh/nf-pdh-pdhgetrawcountervalue)или [**пдхжетформаттедкаунтервалуе**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue).</span><span class="sxs-lookup"><span data-stu-id="12625-121">The missing counter instance will be reported by either [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata), [**PdhGetRawCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetrawcountervalue), or [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue).</span></span> <span data-ttu-id="12625-122">При вызове **пдхколлекткуеридата** только для одного экземпляра счетчика, и экземпляр счетчика по-прежнему не существует, предполагается, что экземпляр счетчика не существует и функция возвращает PDH \_ No \_ Data.</span><span class="sxs-lookup"><span data-stu-id="12625-122">When calling **PdhCollectQueryData** for one counter instance only, and the counter instance still does not exist, it is assumed that the counter instance will not exist and the function returns PDH\_NO\_DATA.</span></span> <span data-ttu-id="12625-123">Однако если запрашивается более одного счетчика, **пдхколлекткуеридата** может вернуть ошибку, \_ даже если один из экземпляров счетчиков еще не существует.</span><span class="sxs-lookup"><span data-stu-id="12625-123">However, if more than one counter is queried, **PdhCollectQueryData** may still return ERROR\_SUCCESS even if one of the counter instances does not yet exist.</span></span> <span data-ttu-id="12625-124">В этом случае вызовите **пдхжетравкаунтервалуе** или **пдхжетформаттедкаунтервалуе** для каждого из интересующих экземпляров счетчика.</span><span class="sxs-lookup"><span data-stu-id="12625-124">In this case, call **PdhGetRawCounterValue** or **PdhGetFormattedCounterValue** for each of the counter instances of interest.</span></span> <span data-ttu-id="12625-125">Если экземпляр не существует при вызове **пдхжетравкаунтервалуе**, функция возвращает ошибку \_ Success и устанавливает для элемента **Кстатус** в [**\_ \_ счетчике PDH RAW**](/windows/desktop/api/Pdh/ns-pdh-pdh_raw_counter) состояние PDH \_ \_ без \_ экземпляра.</span><span class="sxs-lookup"><span data-stu-id="12625-125">If the instance does not exist when calling **PdhGetRawCounterValue**, the function returns ERROR\_SUCCESS and sets the **CStatus** member of [**PDH\_RAW\_COUNTER**](/windows/desktop/api/Pdh/ns-pdh-pdh_raw_counter) to PDH\_STATUS\_NO\_INSTANCE.</span></span> <span data-ttu-id="12625-126">Если экземпляр не существует при вызове **пдхжетформаттедкаунтервалуе**, функция возвращает PDH \_ недопустимых \_ данных и устанавливает для элемента **кстатус** в [**PDH \_ FMT \_ COUNTERVALUE**](/windows/desktop/api/Pdh/ns-pdh-pdh_fmt_countervalue) значение PDH \_ кстатус \_ без \_ экземпляра.</span><span class="sxs-lookup"><span data-stu-id="12625-126">If the instance does not exist when calling **PdhGetFormattedCounterValue**, the function returns PDH\_INVALID\_DATA and sets the **CStatus** member of the [**PDH\_FMT\_COUNTERVALUE**](/windows/desktop/api/Pdh/ns-pdh-pdh_fmt_countervalue) to PDH\_CSTATUS\_NO\_INSTANCE.</span></span>

<span data-ttu-id="12625-127">Обратите внимание, что путь счетчика, указанный в функции [**пдхаддкаунтер**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) , должен быть локализован.</span><span class="sxs-lookup"><span data-stu-id="12625-127">Note that the counter path specified in the [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) function must be localized.</span></span> <span data-ttu-id="12625-128">Функция [**пдхадденглишкаунтер**](/windows/desktop/api/Pdh/nf-pdh-pdhaddenglishcountera) предоставляет независимый от локали способ добавления счетчиков производительности в запрос.</span><span class="sxs-lookup"><span data-stu-id="12625-128">The [**PdhAddEnglishCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddenglishcountera) function provides a locale-neutral way to add performance counters to the query.</span></span> <span data-ttu-id="12625-129">Эта функция является рекомендуемым способом добавления в запрос независимых от локалей счетчиков.</span><span class="sxs-lookup"><span data-stu-id="12625-129">This function is the recommended way to add locale-neutral counters to a query.</span></span>

<span data-ttu-id="12625-130">Чтобы удалить счетчик из запроса, вызовите функцию [**пдхремовекаунтер**](/windows/desktop/api/Pdh/nf-pdh-pdhremovecounter) .</span><span class="sxs-lookup"><span data-stu-id="12625-130">To remove a counter from a query, call the [**PdhRemoveCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhremovecounter) function.</span></span>

<span data-ttu-id="12625-131">После завершения сбора данных для запроса вызовите функцию [**пдхклосекуери**](/windows/desktop/api/Pdh/nf-pdh-pdhclosequery) , чтобы закрыть запрос и освободить все выделенные системные ресурсы.</span><span class="sxs-lookup"><span data-stu-id="12625-131">After you finish collecting data for a query, call the [**PdhCloseQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhclosequery) function to close the query and release all allocated system resources.</span></span> <span data-ttu-id="12625-132">**Пдхклосекуери** закрывает все дескрипторы счетчиков, связанные с запросом.</span><span class="sxs-lookup"><span data-stu-id="12625-132">**PdhCloseQuery** closes all counter handles associated with the query.</span></span>

 

 



