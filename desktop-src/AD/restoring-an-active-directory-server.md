---
title: Восстановление сервера Active Directory
description: Active Directory серверы должны быть восстановлены в автономном режиме.
ms.assetid: 91fbbdc1-0e84-4b89-8a38-4c8d0268992b
ms.tgt_platform: multiple
keywords:
- Восстановление Active Directory Active Directory
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 273d02fd50d6b3bd68a055a6a783566e4ebddcf7
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/17/2020
ms.locfileid: "103890375"
---
# <a name="restoring-an-active-directory-server"></a><span data-ttu-id="b8c94-104">Восстановление сервера Active Directory</span><span class="sxs-lookup"><span data-stu-id="b8c94-104">Restoring an Active Directory Server</span></span>

<span data-ttu-id="b8c94-105">Active Directory серверы должны быть восстановлены в автономном режиме.</span><span class="sxs-lookup"><span data-stu-id="b8c94-105">Active Directory servers must be restored offline.</span></span> <span data-ttu-id="b8c94-106">Необходимо перезапустить систему в режиме восстановления служб каталогов.</span><span class="sxs-lookup"><span data-stu-id="b8c94-106">The system must be restarted in Directory Services Restore mode.</span></span> <span data-ttu-id="b8c94-107">В этом режиме операционная система работает без служб домен Active Directory и все пользователи проверяются с помощью диспетчера учетных записей безопасности (SAM) в реестре.</span><span class="sxs-lookup"><span data-stu-id="b8c94-107">In this mode, the operating system is running without Active Directory Domain Services and all user validation occurs through the Security Accounts Manager (SAM) in the registry.</span></span> <span data-ttu-id="b8c94-108">Чтобы восстановить домен Active Directoryные службы, используйте учетные данные локального администратора на восстанавливаемом контроллере домена.</span><span class="sxs-lookup"><span data-stu-id="b8c94-108">To restore Active Directory Domain Services, use the credentials of a local administrator on the domain controller that is restored.</span></span>

<span data-ttu-id="b8c94-109">Вызывающий функции Restore должен иметь право доступа **SE \_ RESTORE \_ Name** .</span><span class="sxs-lookup"><span data-stu-id="b8c94-109">The caller of the restore functions must have the **SE\_RESTORE\_NAME** access privilege.</span></span> <span data-ttu-id="b8c94-110">Используйте функцию [**дссетаусидентити**](dssetauthidentity.md) , чтобы задать контекст безопасности, в котором вызываются функции резервного копирования и восстановления каталога.</span><span class="sxs-lookup"><span data-stu-id="b8c94-110">Use the [**DsSetAuthIdentity**](dssetauthidentity.md) function to set the security context under which the directory backup and restore functions are called.</span></span>

<span data-ttu-id="b8c94-111">Имейте в виду, что при восстановлении домен Active Directory служб необходимо также восстановить другие компоненты состояния системы.</span><span class="sxs-lookup"><span data-stu-id="b8c94-111">Be aware that when you restore Active Directory Domain Services, you must also restore the other system state components.</span></span>

<span data-ttu-id="b8c94-112">**Восстановление служб домен Active Directory Services**</span><span class="sxs-lookup"><span data-stu-id="b8c94-112">**To restore Active Directory Domain Services**</span></span>

1.  <span data-ttu-id="b8c94-113">Вызовите функцию [**дсиснтдсонлине**](dsisntdsonline.md) , чтобы определить, работают ли службы домен Active Directory.</span><span class="sxs-lookup"><span data-stu-id="b8c94-113">Call the [**DsIsNTDSOnline**](dsisntdsonline.md) function to determine if Active Directory Domain Services are running.</span></span>
2.  <span data-ttu-id="b8c94-114">Если службы домен Active Directory не выполняются, вызывается функция [**дсресторепрепаре**](dsrestoreprepare.md) для инициализации операции восстановления и получения маркера контекста резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="b8c94-114">If Active Directory Domain Services are not running, the [**DsRestorePrepare**](dsrestoreprepare.md) function is called to initialize the restore operation and obtain a backup context handle.</span></span> <span data-ttu-id="b8c94-115">Если службы домен Active Directory работают, восстановление невозможно, и приложение Restore должно завершить операцию восстановления.</span><span class="sxs-lookup"><span data-stu-id="b8c94-115">If Active Directory Domain Services are running, it cannot be restored and the restore application must fail the restore operation.</span></span> <span data-ttu-id="b8c94-116">Функция **дсресторепрепаре** требует, чтобы маркер срока действия был получен из функции [**дсбаккуппрепаре**](dsbackupprepare.md) во время операции резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="b8c94-116">The **DsRestorePrepare** function requires that the expiry token be obtained from the [**DsBackupPrepare**](dsbackupprepare.md) function during the backup operation.</span></span>
3.  <span data-ttu-id="b8c94-117">Вызовите функцию [**дсресторежетдатабаселокатионс**](dsrestoregetdatabaselocations.md) , чтобы определить каталоги, в которых будут восстанавливаться файлы.</span><span class="sxs-lookup"><span data-stu-id="b8c94-117">Call the [**DsRestoreGetDatabaseLocations**](dsrestoregetdatabaselocations.md) function to determine the directories where the files are to be restored.</span></span> <span data-ttu-id="b8c94-118">Если эта функция завершается сбоем, восстановите данные обратно в исходный каталог резервных копий. это каталог, из которого были скопированы данные.</span><span class="sxs-lookup"><span data-stu-id="b8c94-118">If this function fails, restore the data back to the original backup source directory; that is the directory from which the data was backed up.</span></span>
4.  <span data-ttu-id="b8c94-119">Вызовите функцию [**дсресторерегистер**](dsrestoreregister.md) , чтобы подготовить сервер Active Directory для операции восстановления и заблокировать каталоги восстановления.</span><span class="sxs-lookup"><span data-stu-id="b8c94-119">Call the [**DsRestoreRegister**](dsrestoreregister.md) function to prepare the Active Directory server for the restore operation and lock the restore directories.</span></span>
5.  <span data-ttu-id="b8c94-120">Используйте стандартные функции Win32 для восстановления файлов.</span><span class="sxs-lookup"><span data-stu-id="b8c94-120">Use standard Win32 functions to restore the files.</span></span> <span data-ttu-id="b8c94-121">Сначала удалите все файлы в целевом каталоге. затем скопируйте файлы резервных копий в каталог назначения.</span><span class="sxs-lookup"><span data-stu-id="b8c94-121">First, delete all files in the destination directory; then copy the backup files to the destination directory.</span></span>
6.  <span data-ttu-id="b8c94-122">Вызовите функцию [**дсресторерегистеркомплете**](dsrestoreregistercomplete.md) , чтобы указать, что восстановление завершено.</span><span class="sxs-lookup"><span data-stu-id="b8c94-122">Call the [**DsRestoreRegisterComplete**](dsrestoreregistercomplete.md) function to indicate that the restore has completed.</span></span>
7.  <span data-ttu-id="b8c94-123">Вызовите функцию [**дсресторинд**](dsrestoreend.md) , чтобы освободить все ресурсы, связанные с контекстом.</span><span class="sxs-lookup"><span data-stu-id="b8c94-123">Call the [**DsRestoreEnd**](dsrestoreend.md) function to release any resources associated with the context.</span></span>

<span data-ttu-id="b8c94-124">После восстановления в режиме восстановления служб каталогов необходимо перезапустить контроллер домена в обычном режиме.</span><span class="sxs-lookup"><span data-stu-id="b8c94-124">After a restore in Directory Services Restore mode, the domain controller should be restarted in normal mode.</span></span> <span data-ttu-id="b8c94-125">При запуске службы каталогов контроллер домена выполнит нормальную проверку согласованности, и восстановленный каталог будет подключен к сети.</span><span class="sxs-lookup"><span data-stu-id="b8c94-125">When the directory service starts, the domain controller will perform the normal consistency check and the restored directory will then be online.</span></span>

<span data-ttu-id="b8c94-126">Имейте в виду, что восстановление сервера Active Directory всегда состоит из двух частей.</span><span class="sxs-lookup"><span data-stu-id="b8c94-126">Be aware that restoring an Active Directory server is always a two-part operation.</span></span> <span data-ttu-id="b8c94-127">Сначала восстановите базу данных до момента создания резервной копии.</span><span class="sxs-lookup"><span data-stu-id="b8c94-127">First, restore the database to a time when the backup was taken.</span></span> <span data-ttu-id="b8c94-128">Во-вторых, выполните репликацию каталога, в котором только что восстановленный DSA реплицирует обновления после резервного копирования с других DSA в лесу домена и предприятия.</span><span class="sxs-lookup"><span data-stu-id="b8c94-128">Second, replicate the directory, where the newly restored DSA replicates post-backup updates from other DSAs in the domain and enterprise forest.</span></span>

<span data-ttu-id="b8c94-129">Компьютер, работающий под Windows 2000 или Windows Server 2003, который содержит реплику службы каталогов, является контроллером домена.</span><span class="sxs-lookup"><span data-stu-id="b8c94-129">A computer running on Windows 2000 or Windows Server 2003, that contains a replica of the directory service, is a domain controller.</span></span>

<span data-ttu-id="b8c94-130">Функция [**дсресторерегистер**](dsrestoreregister.md) добавляет данные в реестр, который должен сохранить работоспособность процесса восстановления реестра для правильной работы восстановления.</span><span class="sxs-lookup"><span data-stu-id="b8c94-130">The [**DsRestoreRegister**](dsrestoreregister.md) function adds data to the registry that must survive the registry restoration process for the restoration to work correctly.</span></span> <span data-ttu-id="b8c94-131">Чтобы убедиться, что данные реестра сохранены, восстановите домен Active Directory Services с помощью функций **дсресторе \*** перед перезагрузкой компьютера после вызова функции [**регреплацекэй**](/windows/desktop/api/winreg/nf-winreg-regreplacekeya) .</span><span class="sxs-lookup"><span data-stu-id="b8c94-131">To ensure this registry data is preserved, restore Active Directory Domain Services with the **DsRestore\*** functions prior to restarting the computer after the [**RegReplaceKey**](/windows/desktop/api/winreg/nf-winreg-regreplacekeya) function is called.</span></span> <span data-ttu-id="b8c94-132">Этот процесс работает потому, что **регреплацекэй** на самом деле не заменяет куст реестра, пока компьютер не будет перезагружен, а данные реестра, добавленные функцией **дсресторерегистер** , не будут заменены в результате операции восстановления реестра.</span><span class="sxs-lookup"><span data-stu-id="b8c94-132">This process works because **RegReplaceKey** does not actually replace the registry hive until the computer is restarted and the registry data added by the **DsRestoreRegister** function is specifically excluded from being replaced during a registry restore operation.</span></span>

 

 