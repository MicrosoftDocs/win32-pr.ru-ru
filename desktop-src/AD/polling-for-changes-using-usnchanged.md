---
title: Опрос изменений с помощью USNChanged
description: Изменения из Active Directory также могут быть получены путем запроса атрибута uSNChanged, что позволяет избежать ограничений, касающихся элемента управления DirSync.
ms.assetid: 83bda359-09e5-4abf-8f60-9c63bccfcdd1
ms.tgt_platform: multiple
keywords:
- Опрос изменений с помощью USNChanged AD
- USNChanged AD
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a8e062c84fae575f837f45d78be7c92e5e284c1e
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/17/2020
ms.locfileid: "103890396"
---
# <a name="polling-for-changes-using-usnchanged"></a><span data-ttu-id="54d9c-105">Опрос изменений с помощью USNChanged</span><span class="sxs-lookup"><span data-stu-id="54d9c-105">Polling for Changes Using USNChanged</span></span>

<span data-ttu-id="54d9c-106">Элемент управления DirSync является мощным и эффективным, но имеет два существенных ограничения:</span><span class="sxs-lookup"><span data-stu-id="54d9c-106">The DirSync control is powerful and efficient, but has two significant limitations:</span></span>

-   <span data-ttu-id="54d9c-107">Только для приложений с высоким уровнем привилегий. для использования элемента управления DirSync приложение должно запускаться под учетной записью с правами доступа к **\_ \_ \_ имени агента синхронизации SE** на контроллере домена.</span><span class="sxs-lookup"><span data-stu-id="54d9c-107">Only for highly privileged applications: To use the DirSync control, an application must run under an account that has the **SE\_SYNC\_AGENT\_NAME** privilege on the domain controller.</span></span> <span data-ttu-id="54d9c-108">Некоторые учетные записи имеют высокий уровень привилегий, поэтому приложение, использующее элемент управления DirSync, не может быть запущено обычными пользователями.</span><span class="sxs-lookup"><span data-stu-id="54d9c-108">Few accounts are so highly privileged, so an application that uses the DirSync control cannot be run by ordinary users.</span></span>
-   <span data-ttu-id="54d9c-109">Без поддерева области: элемент управления DirSync возвращает все изменения, которые происходят в контексте именования.</span><span class="sxs-lookup"><span data-stu-id="54d9c-109">No subtree scoping: The DirSync control returns all changes that occur within a naming context.</span></span> <span data-ttu-id="54d9c-110">Приложение, заинтересованное только в случае изменений, происходящих в небольшом поддереве контекста именования, должно Уэйд с помощью множества несущественных изменений, которые неэффективны как для приложения, так и для контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="54d9c-110">An application interested only in changes that occur in a small subtree of a naming context must wade through many irrelevant changes, which is inefficient both for the application and for the domain controller.</span></span>

<span data-ttu-id="54d9c-111">Изменения из Active Directory также могут быть получены путем запроса атрибута [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) , что позволяет избежать ограничений, касающихся элемента управления DirSync.</span><span class="sxs-lookup"><span data-stu-id="54d9c-111">Changes from Active Directory can also be obtained by querying the [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute, which avoids the limitations of the DirSync control.</span></span> <span data-ttu-id="54d9c-112">Этот вариант не лучше, чем элемент управления DirSync, так как он включает передачу всех атрибутов при изменении любого атрибута и требует больше работы от разработчика приложения, чтобы правильно обрабатывал определенные сценарии сбоя.</span><span class="sxs-lookup"><span data-stu-id="54d9c-112">This alternative is not better than the DirSync control in all respects because it involves transmitting all attributes when any attribute changes and it requires more work from the application developer to handle certain failure scenarios correctly.</span></span> <span data-ttu-id="54d9c-113">В настоящее время это лучший способ написания определенных приложений для отслеживания изменений.</span><span class="sxs-lookup"><span data-stu-id="54d9c-113">It is, currently, the best way to write certain change-tracking applications.</span></span>

<span data-ttu-id="54d9c-114">Когда контроллер домена изменяет объект, он устанавливает атрибут [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) этого объекта в значение, превышающее предыдущее значение атрибута **uSNChanged** для этого объекта, и больше текущего значения атрибута **uSNChanged** для всех остальных объектов, хранящихся на этом контроллере домена.</span><span class="sxs-lookup"><span data-stu-id="54d9c-114">When a domain controller modifies an object it sets that object's [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute to a value that is larger than the previous value of the **uSNChanged** attribute for that object, and larger than the current value of the **uSNChanged** attribute for all other objects held on that domain controller.</span></span> <span data-ttu-id="54d9c-115">Как следствие, приложение может найти недавно измененный объект на контроллере домена, находя объект с наибольшим значением **uSNChanged** .</span><span class="sxs-lookup"><span data-stu-id="54d9c-115">As a consequence, an application can find the most recently changed object on a domain controller by finding the object with the largest **uSNChanged** value.</span></span> <span data-ttu-id="54d9c-116">Во втором последнем измененном объекте на контроллере домена будет иметься второе наибольшее значение **uSNChanged** и т. д.</span><span class="sxs-lookup"><span data-stu-id="54d9c-116">The second most recently changed object on a domain controller will have the second largest **uSNChanged** value, and so on.</span></span>

<span data-ttu-id="54d9c-117">Атрибут [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) не реплицируется, поэтому считывание атрибута **uSNChanged** объекта на двух разных контроллерах домена обычно приводит к различным значениям.</span><span class="sxs-lookup"><span data-stu-id="54d9c-117">The [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute is not replicated, therefore reading an object's **uSNChanged** attribute at two different domain controllers will typically give different values.</span></span>

<span data-ttu-id="54d9c-118">Например, атрибут [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) можно использовать для наблюдения за изменениями в поддереве S. Во-первых, выполните полную синхронизацию поддерева. Предположим, что максимальное значение **uSNChanged** для любого объекта в S равно U. периодически запрашивает все объекты в поддеревьях, значение **USNChanged** которых больше U. Запрос возвратит все объекты, которые были изменены с момента полной синхронизации. Задайте для вас самый крупный **uSNChanged** из этих измененных объектов, и вы сможете снова опросить.</span><span class="sxs-lookup"><span data-stu-id="54d9c-118">For example, the [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute can be used to track changes in a subtree S. First, perform a "full sync" of the subtree S. Suppose the largest **uSNChanged** value for any object in S is U. Periodically query for all objects in subtree S whose **uSNChanged** value is greater than U. The query will return all objects that have changed since the full sync. Set U to the largest **uSNChanged** among these changed objects, and you are ready to poll again.</span></span>

<span data-ttu-id="54d9c-119">Ниже перечислены тонкости реализации приложения синхронизации [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) .</span><span class="sxs-lookup"><span data-stu-id="54d9c-119">The subtleties of implementing a [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) synchronization application include:</span></span>

-   <span data-ttu-id="54d9c-120">Используйте атрибут **Хигхесткоммиттедусн** RootDSE, чтобы привязать фильтры [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) .</span><span class="sxs-lookup"><span data-stu-id="54d9c-120">Use the **highestCommittedUSN** attribute of rootDSE to bound your [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) filters.</span></span> <span data-ttu-id="54d9c-121">Это значит, что перед началом полной синхронизации прочтите **хигхесткоммиттедусн** подключенного контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="54d9c-121">That is, before starting a full sync, read the **highestCommittedUSN** of your affiliated domain controller.</span></span> <span data-ttu-id="54d9c-122">Затем выполните запрос полной синхронизации (с использованием страничных результатов) для инициализации базы данных.</span><span class="sxs-lookup"><span data-stu-id="54d9c-122">Then, perform a full synchronization query (using paged results) to initialize the database.</span></span> <span data-ttu-id="54d9c-123">По завершении сохраните значение **хигхесткоммиттедусн** , считанное до полного запроса синхронизации. значение, чтобы использовать в качестве нижней границы атрибута **uSNChanged** для следующей синхронизации.</span><span class="sxs-lookup"><span data-stu-id="54d9c-123">When this is complete, store the **highestCommittedUSN** value read before the full sync query; to use as the lower bounds of the **uSNChanged** attribute for the next synchronization.</span></span> <span data-ttu-id="54d9c-124">Позже, чтобы выполнить добавочную синхронизацию, повторно считайте атрибут **хигхесткоммиттедусн** RootDSE.</span><span class="sxs-lookup"><span data-stu-id="54d9c-124">Later, to perform an incremental synchronization, reread the **highestCommittedUSN** rootDSE attribute.</span></span> <span data-ttu-id="54d9c-125">Затем запросите соответствующие объекты, используя страничные результаты, у которых **uSNChanged** больше нижних границ значения атрибута **uSNChanged** , сохраненного из предыдущей синхронизации.</span><span class="sxs-lookup"><span data-stu-id="54d9c-125">Then query for relevant objects, using paged results, whose **uSNChanged** is greater than the lower bounds of the **uSNChanged** attribute value saved from the previous synchronization.</span></span> <span data-ttu-id="54d9c-126">Обновите базу данных, используя эти сведения.</span><span class="sxs-lookup"><span data-stu-id="54d9c-126">Update the database using this information.</span></span> <span data-ttu-id="54d9c-127">По завершении обновите нижние границы атрибута **uSNChanged** из значения **хигхесткоммиттедусн** , считанного перед добавочным запросом синхронизации.</span><span class="sxs-lookup"><span data-stu-id="54d9c-127">When complete, update the lower bounds of the **uSNChanged** attribute from the **highestCommittedUSN** value read before the incremental synchronization query.</span></span> <span data-ttu-id="54d9c-128">Всегда храните нижние границы значения атрибута **uSNChanged** в том же хранилище, которое приложение синхронизирует с содержимым контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="54d9c-128">Always store the lower bounds of the **uSNChanged** attribute value in the same storage that the application is synchronizing with the domain controller content.</span></span>

    <span data-ttu-id="54d9c-129">При выполнении этой процедуры, а не на основе значений [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) в извлеченных объектах, не нужно, чтобы сервер повторно просматривает обновленные объекты, находящиеся за пределами набора, применимого к приложению.</span><span class="sxs-lookup"><span data-stu-id="54d9c-129">Following this procedure, rather than that based on [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) values on retrieved objects, avoids making the server reexamine updated objects that fall outside the set that is applicable to the application.</span></span>

-   <span data-ttu-id="54d9c-130">Так как [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) является нереплицируемым атрибутом, приложение должно быть привязано к тому же контроллеру домена при каждом его запуске.</span><span class="sxs-lookup"><span data-stu-id="54d9c-130">Because [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) is a non-replicated attribute, the application must bind to the same domain controller every time it runs.</span></span> <span data-ttu-id="54d9c-131">Если не удается выполнить привязку к этому контроллеру домена, он должен либо подождать, пока он не сможет это сделать, либо привязать его к новому контроллеру домена и выполнить полную синхронизацию с этим контроллером домена.</span><span class="sxs-lookup"><span data-stu-id="54d9c-131">If it cannot bind to that domain controller it must either wait until it can do so, or affiliate with some new domain controller and perform a full synchronization with that domain controller.</span></span> <span data-ttu-id="54d9c-132">Когда приложение будет находиться в аффилированной организации с контроллером домена, оно записывает DNS-имя этого контроллера домена в стабильное хранилище, которое является тем же хранилищем, которое оно согласуется с содержимым контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="54d9c-132">When the application affiliates with a domain controller it records the DNS name of that domain controller in stable storage, which is the same storage it is keeping consistent with the domain controller content.</span></span> <span data-ttu-id="54d9c-133">Затем он использует сохраненное имя DNS для привязки к тому же контроллеру домена для последующих синхронизаций.</span><span class="sxs-lookup"><span data-stu-id="54d9c-133">Then it uses the stored DNS name to bind to the same domain controller for subsequent synchronizations.</span></span>
-   <span data-ttu-id="54d9c-134">Приложение должно обнаружить, когда контроллер домена, с которым он связан в данный момент, был восстановлен из резервной копии, так как это может привести к несогласованности.</span><span class="sxs-lookup"><span data-stu-id="54d9c-134">The application must detect when the domain controller it is currently affiliated with has been restored from backup, because this can cause inconsistency.</span></span> <span data-ttu-id="54d9c-135">Если приложение имеет аффилированные лица с контроллером домена, он кэширует "идентификатор вызова" этого контроллера домена в стабильном хранилище, то есть то же хранилище, которое оно согласуется с содержимым контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="54d9c-135">When the application affiliates with a domain controller it caches the "invocation id" of that domain controller in stable storage, that is, the same storage it is keeping consistent with the domain controller content.</span></span> <span data-ttu-id="54d9c-136">"Идентификатор вызова" контроллера домена — это идентификатор GUID, хранящийся в атрибуте **invocationID** объекта службы контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="54d9c-136">The "invocation id" of a domain controller is a GUID stored in the **invocationID** attribute of the domain controller's service object.</span></span> <span data-ttu-id="54d9c-137">Чтобы получить различающееся имя объекта службы контроллера домена, прочитайте атрибут **дссервиценаме** для RootDSE.</span><span class="sxs-lookup"><span data-stu-id="54d9c-137">To get the distinguished name of a domain controller's service object, read the **dsServiceName** attribute of the rootDSE.</span></span>

    <span data-ttu-id="54d9c-138">Имейте в виду, что при восстановлении стабильного хранилища приложения из резервной копии проблемы с согласованностью не возникают, так как имя контроллера домена, идентификатор вызова и Нижняя граница значения атрибута [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) хранятся вместе с данными, синхронизированными с содержимым контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="54d9c-138">Be aware that when the application's stable storage is restored from backup there are no consistency problems because the domain controller name, invocation id, and lower bounds of the [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute value are stored with the data synchronized with the domain controller content.</span></span>

-   <span data-ttu-id="54d9c-139">Используйте разбиение по страницам при запросе к серверу как полной, так и добавочной синхронизации, чтобы избежать возможности одновременного извлечения больших результирующих наборов.</span><span class="sxs-lookup"><span data-stu-id="54d9c-139">Use paging when querying the server, both full and incremental synchronizations, to avoid the possibility of retrieving large result sets simultaneously.</span></span> <span data-ttu-id="54d9c-140">Дополнительные сведения см. в разделе [Указание других параметров поиска](specifying-other-search-options.md).</span><span class="sxs-lookup"><span data-stu-id="54d9c-140">For more information, see [Specifying Other Search Options](specifying-other-search-options.md).</span></span>
-   <span data-ttu-id="54d9c-141">Выполнение запросов на основе индекса во избежание принудительного хранения больших промежуточных результатов на сервере при использовании страничных результатов.</span><span class="sxs-lookup"><span data-stu-id="54d9c-141">Perform index-based queries to avoid forcing the server to store large intermediate results when using paged results.</span></span> <span data-ttu-id="54d9c-142">Дополнительные сведения см. в разделе [индексированные атрибуты](indexed-attributes.md).</span><span class="sxs-lookup"><span data-stu-id="54d9c-142">For more information, see [Indexed Attributes](indexed-attributes.md).</span></span>
-   <span data-ttu-id="54d9c-143">В общем случае не используйте сортировку результатов поиска на стороне сервера, что может привести к принудительному хранению и сортировке больших промежуточных результатов на сервере.</span><span class="sxs-lookup"><span data-stu-id="54d9c-143">In general, do not use server-side sorting of search results, which can force the server to store and sort large intermediate results.</span></span> <span data-ttu-id="54d9c-144">Это относится как к полной, так и к добавочной синхронизации.</span><span class="sxs-lookup"><span data-stu-id="54d9c-144">This applies to both full and incremental synchronizations.</span></span> <span data-ttu-id="54d9c-145">Дополнительные сведения см. в разделе [Указание других параметров поиска](specifying-other-search-options.md).</span><span class="sxs-lookup"><span data-stu-id="54d9c-145">For more information, see [Specifying Other Search Options](specifying-other-search-options.md).</span></span>
-   <span data-ttu-id="54d9c-146">Не обрабатывайте родительские условия надлежащим образом.</span><span class="sxs-lookup"><span data-stu-id="54d9c-146">Handle no parent conditions gracefully.</span></span> <span data-ttu-id="54d9c-147">Приложение может распознать объект до того, как он распознает его родительский элемент.</span><span class="sxs-lookup"><span data-stu-id="54d9c-147">The application may recognize an object before it has recognized its parent.</span></span> <span data-ttu-id="54d9c-148">В зависимости от приложения это может быть проблемой или не может быть.</span><span class="sxs-lookup"><span data-stu-id="54d9c-148">Depending upon the application, this may or may not be a problem.</span></span> <span data-ttu-id="54d9c-149">Приложение всегда может считывать текущее состояние родителя из каталога.</span><span class="sxs-lookup"><span data-stu-id="54d9c-149">The application can always read the current state of the parent from the directory.</span></span>
-   <span data-ttu-id="54d9c-150">Чтобы выполнить обработку перемещенных или удаленных объектов, сохраните атрибут [**objectGUID**](/windows/desktop/ADSchema/a-objectguid) каждого отслеживающего объекта.</span><span class="sxs-lookup"><span data-stu-id="54d9c-150">To handle moved or deleted objects, store the [**objectGUID**](/windows/desktop/ADSchema/a-objectguid) attribute of each tracked object.</span></span> <span data-ttu-id="54d9c-151">Атрибут **objectGUID** объекта остается неизменным независимо от того, где он перемещен в пределах леса.</span><span class="sxs-lookup"><span data-stu-id="54d9c-151">An object's **objectGUID** attribute remains unchanged regardless of where it is moved throughout the forest.</span></span>
-   <span data-ttu-id="54d9c-152">Чтобы выполнить обработку перемещенных объектов, выполните периодическую полную синхронизацию или увеличьте область поиска и отфильтровывайте неинтересные изменения на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="54d9c-152">To handle moved objects, either perform periodic full synchronizations or increase the search scope and filter out uninteresting changes at the client end.</span></span>
-   <span data-ttu-id="54d9c-153">Чтобы обрабатывал удаленные объекты, выполните периодическую полную синхронизацию или выполните отдельный Поиск удаленных объектов при выполнении добавочной синхронизации.</span><span class="sxs-lookup"><span data-stu-id="54d9c-153">To handle deleted objects, either perform periodic full synchronizations or perform a separate search for deleted objects when you perform an incremental synchronization.</span></span> <span data-ttu-id="54d9c-154">При запросе удаленных объектов Извлеките [**objectGUID**](/windows/desktop/ADSchema/a-objectguid) удаленных объектов, чтобы определить объекты, которые нужно удалить из базы данных.</span><span class="sxs-lookup"><span data-stu-id="54d9c-154">When you query for deleted objects, retrieve the [**objectGUID**](/windows/desktop/ADSchema/a-objectguid) of the deleted objects to determine the objects to delete from your database.</span></span> <span data-ttu-id="54d9c-155">Дополнительные сведения см. в разделе [получение удаленных объектов](retrieving-deleted-objects.md).</span><span class="sxs-lookup"><span data-stu-id="54d9c-155">For more information, see [Retrieving Deleted Objects](retrieving-deleted-objects.md).</span></span>
-   <span data-ttu-id="54d9c-156">Имейте в виду, что результаты поиска включают только те объекты и атрибуты, которые у вызывающего объекта есть разрешение на чтение (на основе дескрипторов безопасности и списков DACL для различных объектов).</span><span class="sxs-lookup"><span data-stu-id="54d9c-156">Be aware that the search results include only the objects and attributes that the caller has permission to read (based on the security descriptors and DACLs on the various objects).</span></span> <span data-ttu-id="54d9c-157">Дополнительные сведения см. [в разделе влияние безопасности на запросы](effects-of-security-on-queries.md).</span><span class="sxs-lookup"><span data-stu-id="54d9c-157">For more information, see [Effects of Security on Queries](effects-of-security-on-queries.md).</span></span>

<span data-ttu-id="54d9c-158">Дополнительные сведения и пример кода, демонстрирующий основные сведения о приложении синхронизации USNChanged, см. в разделе [пример кода для получения изменений с помощью USNChanged](example-code-to-retrieve-changes-using-usnchanged.md).</span><span class="sxs-lookup"><span data-stu-id="54d9c-158">For more information, and a code example that shows the basics of a USNChanged synchronization application, see [Example Code to Retrieve Changes Using USNChanged](example-code-to-retrieve-changes-using-usnchanged.md).</span></span>

 

 