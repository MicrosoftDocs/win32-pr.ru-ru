---
title: Использование Дсаддсидхистори
description: В этом разделе описывается использование функции Дсаддсидхистори.
ms.assetid: cbf4983c-551d-4771-870e-a192ed898eb7
ms.tgt_platform: multiple
keywords:
- Использование Дсаддсидхистори Active Directory
- Active Directory Active Directory, использование с помощью Дсаддсидхистори
- Дсаддсидхистори Active Directory, использование
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3d45792dbd8c7a2bfa2dd047111a3ed165a2011e
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "103773046"
---
# <a name="using-dsaddsidhistory"></a><span data-ttu-id="49382-106">Использование Дсаддсидхистори</span><span class="sxs-lookup"><span data-stu-id="49382-106">Using DsAddSidHistory</span></span>

<span data-ttu-id="49382-107">Функция [**дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) получает идентификатор безопасности основной учетной записи (SID) субъекта безопасности из одного домена (исходного домена) и добавляет его к атрибуту **SIDHistory** субъекта безопасности в другом (целевом) домене в другом лесу.</span><span class="sxs-lookup"><span data-stu-id="49382-107">The [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) function gets the primary account security identifier (SID) of a security principal from one domain (the source domain) and adds it to the **sIDHistory** attribute of a security principal in another (destination) domain in a different forest.</span></span> <span data-ttu-id="49382-108">Если исходный домен находится в основном режиме Windows 2000, эта функция также получает значения **SIDHistory** исходного участника и добавляет их в **SIDHistory** целевого участника.</span><span class="sxs-lookup"><span data-stu-id="49382-108">When the source domain is in Windows 2000 native mode, this function also retrieves the **sIDHistory** values of the source principal and adds them to the destination principal's **sIDHistory**.</span></span>

<span data-ttu-id="49382-109">Добавление SID в **SIDHistory** субъекта безопасности — это чувствительная к безопасности операция, которая фактически предоставляет основному участнику доступ ко всем ресурсам, доступным для исходного участника, при условии, что отношения доверия между применимыми доменами ресурсов и конечным доменом существуют.</span><span class="sxs-lookup"><span data-stu-id="49382-109">Adding SIDs to a security principal's **sIDHistory** is a security-sensitive operation that effectively grants to the destination principal access to all resources accessible to the source principal, provided that trusts exist from applicable resource domains to the destination domain.</span></span>

<span data-ttu-id="49382-110">В домене Windows 2000 в собственном режиме при входе пользователя в систему создается маркер доступа, содержащий идентификатор безопасности основной учетной записи пользователя и идентификатор безопасности группы, а также пользователь **SIDHistory** и **SIDHistory** групп, членом которых является пользователь.</span><span class="sxs-lookup"><span data-stu-id="49382-110">In a native mode Windows 2000 domain a user logon creates an access token that contains the user primary account SID and group SIDs, as well as the user **sIDHistory** and the **sIDHistory** of the groups of which the user is a member.</span></span> <span data-ttu-id="49382-111">Наличие этих прежних идентификаторов SID (**SIDHistory** ) в маркере пользователя предоставляет пользователю доступ к ресурсам, защищенным списками управления доступом (ACL), содержащими бывшие идентификаторы безопасности.</span><span class="sxs-lookup"><span data-stu-id="49382-111">Having these former SIDs (**sIDHistory** values) in the user's token grants the user access to resources protected by access-control lists (ACLs) containing the former SIDs.</span></span>

<span data-ttu-id="49382-112">Эта операция упрощает определенные сценарии развертывания Windows 2000.</span><span class="sxs-lookup"><span data-stu-id="49382-112">This operation facilitates certain Windows 2000 deployment scenarios.</span></span> <span data-ttu-id="49382-113">В частности, он поддерживает сценарий, в котором учетные записи в новом лесу Windows 2000 создаются для пользователей и групп, которые уже существуют в рабочей среде Windows NT 4,0.</span><span class="sxs-lookup"><span data-stu-id="49382-113">In particular, it supports a scenario in which accounts in a new Windows 2000 forest are created for users and groups that already exist in an Windows NT 4.0 production environment.</span></span> <span data-ttu-id="49382-114">Поместив SID учетной записи Windows NT 4,0 в учетную запись Windows 2000 **SIDHistory**, доступ к сетевым ресурсам сохраняется для пользователя, который входит в новую учетную запись Windows 2000.</span><span class="sxs-lookup"><span data-stu-id="49382-114">By placing the Windows NT 4.0 account SID in the Windows 2000 account **sIDHistory**, access to network resources is preserved for the user logging onto his new Windows 2000 account.</span></span>

<span data-ttu-id="49382-115">[**Дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) также поддерживает миграцию серверов ресурсов резервных контроллеров домена (BDC) Windows NT 4,0 (или контроллеров доменов и рядовых серверов в домене Windows 2000 в собственном режиме) в домен Windows 2000 в качестве рядовых серверов.</span><span class="sxs-lookup"><span data-stu-id="49382-115">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) also supports migration of Windows NT 4.0 backup domain controllers (BDCs) resource servers (or DCs and member servers in a native mode Windows 2000 domain) to a Windows 2000 domain as member servers.</span></span> <span data-ttu-id="49382-116">Эта миграция требует создания в целевом домене Windows 2000 локальных групп домена, содержащих, в **SIDHistory**, основных идентификаторов безопасности локальных групп, определенных в BDC (или локальных группах домена, указанных в списках ACL на серверах Windows 2000) в исходном домене.</span><span class="sxs-lookup"><span data-stu-id="49382-116">This migration requires the creation, in the destination Windows 2000 domain, of domain local groups that contain, in their **sIDHistory**, the primary SIDs of the local groups defined on the BDC (or domain local groups referenced in ACLs on the Windows 2000 servers) in the source domain.</span></span> <span data-ttu-id="49382-117">При создании целевой локальной группы, содержащей **SIDHistory** и все члены исходной локальной группы, доступ к перенесенным ресурсам сервера, защищенным списками управления доступом, ссылающимися на исходную локальную группу, сохраняется для всех элементов.</span><span class="sxs-lookup"><span data-stu-id="49382-117">By creating a destination local group containing the **sIDHistory** and all members of the source local group, access to the migrated server resources, protected by ACLs referencing the source local group, is maintained for all members.</span></span>

> [!Note]  
> <span data-ttu-id="49382-118">Использование [**дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) требует понимания его более широкого влияния на администрирование и безопасность в этих и других сценариях.</span><span class="sxs-lookup"><span data-stu-id="49382-118">Use of [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requires an understanding of its broader administrative and security implications in these and other scenarios.</span></span> <span data-ttu-id="49382-119">Дополнительные сведения см. в техническом документе "Планирование миграции с Windows NT на Microsoft Windows 2000", поставляемое в качестве Dommig.doc в средствах поддержки Windows 2000.</span><span class="sxs-lookup"><span data-stu-id="49382-119">For more information, see the white paper "Planning Migration from Windows NT to Microsoft Windows 2000", delivered as Dommig.doc in the Windows 2000 Support Tools.</span></span> <span data-ttu-id="49382-120">Эта документация также может быть найдена на компакт-диске продукта в разделе " \\ средства поддержки" \\ .</span><span class="sxs-lookup"><span data-stu-id="49382-120">This documentation may also be found on the product CD under \\support\\tools.</span></span>

 

## <a name="authorization-requirements"></a><span data-ttu-id="49382-121">Требования к авторизации</span><span class="sxs-lookup"><span data-stu-id="49382-121">Authorization Requirements</span></span>

<span data-ttu-id="49382-122">[**Дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) требуются права администратора в исходном и целевом доменах.</span><span class="sxs-lookup"><span data-stu-id="49382-122">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requires administrator privileges in the source and destination domains.</span></span> <span data-ttu-id="49382-123">В частности, вызывающий этот API должен быть членом группы администраторов домена в конечном домене.</span><span class="sxs-lookup"><span data-stu-id="49382-123">Specifically, the caller of this API must be a member of the Domain Administrators group in the destination domain.</span></span> <span data-ttu-id="49382-124">Выполняется жестко заданная проверка членства.</span><span class="sxs-lookup"><span data-stu-id="49382-124">A hard-coded check for this membership is performed.</span></span> <span data-ttu-id="49382-125">Кроме того, вызывающая сторона или учетная запись, указанная в параметре *сркдомаинкредс* , если она не **равна null**, должна быть членом группы администраторов или администраторов домена в исходном домене.</span><span class="sxs-lookup"><span data-stu-id="49382-125">Also, the caller or the account provided in the *SrcDomainCreds* parameter, if not **NULL**, must be a member of either the Administrators or Domain Administrators group in the source domain.</span></span>

## <a name="domain-and-trust-requirements"></a><span data-ttu-id="49382-126">Требования к домену и доверию</span><span class="sxs-lookup"><span data-stu-id="49382-126">Domain and Trust Requirements</span></span>

<span data-ttu-id="49382-127">Для [**дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) требуется, чтобы конечный домен был в основном режиме Windows 2000 или более поздней версии, поскольку только этот тип домена поддерживает атрибут **SIDHistory** .</span><span class="sxs-lookup"><span data-stu-id="49382-127">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requires that the destination domain be in Windows 2000 native mode or later, because only this domain type supports the **sIDHistory** attribute.</span></span> <span data-ttu-id="49382-128">Исходным доменом может быть либо Windows NT 4,0, либо Windows 2000, смешанный или основной режим.</span><span class="sxs-lookup"><span data-stu-id="49382-128">The source domain may be either Windows NT 4.0 or Windows 2000, mixed or native mode.</span></span> <span data-ttu-id="49382-129">Исходный и конечный домены не должны находиться в одном лесу.</span><span class="sxs-lookup"><span data-stu-id="49382-129">The source and destination domains must not be in the same forest.</span></span> <span data-ttu-id="49382-130">Домены Windows NT 4,0 являются определениями, которые не входят в лес.</span><span class="sxs-lookup"><span data-stu-id="49382-130">Windows NT 4.0 domains are by definition not in a forest.</span></span> <span data-ttu-id="49382-131">Это ограничение между лесами гарантирует, что дублированные идентификаторы SID, отображаемые как основные значения SID или **SIDHistory** , не будут создаваться в одном лесу.</span><span class="sxs-lookup"><span data-stu-id="49382-131">This inter-forest constraint ensures that duplicate SIDs, whether appearing as primary SIDs or **sIDHistory** values, are not created in the same forest.</span></span>

<span data-ttu-id="49382-132">[**Дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) требует наличия внешнего доверия от исходного домена к целевому домену в случаях, перечисленных в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="49382-132">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requires an external trust from the source domain to the destination domain in the cases listed in the following table.</span></span>



| <span data-ttu-id="49382-133">Случай</span><span class="sxs-lookup"><span data-stu-id="49382-133">Case</span></span>                                                                             | <span data-ttu-id="49382-134">Описание</span><span class="sxs-lookup"><span data-stu-id="49382-134">Description</span></span>                                                                                                                                                                                                                                                                 |
|----------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="49382-135">Исходный домен — Windows 2000.</span><span class="sxs-lookup"><span data-stu-id="49382-135">The source domain is Windows 2000.</span></span><br/>                                    | <span data-ttu-id="49382-136">Исходный атрибут **SIDHistory** , доступный только в исходных доменах Windows 2000, может быть прочитан только с помощью LDAP, что требует этого доверия для защиты целостности.</span><span class="sxs-lookup"><span data-stu-id="49382-136">The source **sIDHistory** attribute, available only in Windows 2000 source domains, may be read only using LDAP, which requires this trust for integrity protection.</span></span><br/>                                                                                             |
| <span data-ttu-id="49382-137">Исходный домен — Windows NT 4,0, а *сркдомаинкредс* — **null**.</span><span class="sxs-lookup"><span data-stu-id="49382-137">The source domain is Windows NT 4.0 and *SrcDomainCreds* is **NULL**.</span></span><br/> | <span data-ttu-id="49382-138">Олицетворение, необходимое для поддержки операций исходного домена с использованием учетных данных вызывающего объекта, зависит от этого доверия.</span><span class="sxs-lookup"><span data-stu-id="49382-138">The impersonation, required to support source domain operations using the caller's credentials, depends on this trust.</span></span> <span data-ttu-id="49382-139">Для олицетворения также требуется, чтобы конечный контроллер домена был включен по умолчанию "доверенный для делегирования" на контроллерах домена.</span><span class="sxs-lookup"><span data-stu-id="49382-139">Impersonation also requires that the destination domain controller has "Trusted for Delegation" enabled by default on domain controllers.</span></span><br/> |



 

<span data-ttu-id="49382-140">Однако нет необходимости в доверии между исходным и конечным доменами, если исходный домен — Windows NT 4,0, а *сркдомаинкредс* — не **null**.</span><span class="sxs-lookup"><span data-stu-id="49382-140">However, there is no trust required between the source and destination domains if the source domain is Windows NT 4.0 and *SrcDomainCreds* is not **NULL**.</span></span>

## <a name="source-domain-controller-requirements"></a><span data-ttu-id="49382-141">Требования к исходному контроллеру домена</span><span class="sxs-lookup"><span data-stu-id="49382-141">Source Domain Controller Requirements</span></span>

<span data-ttu-id="49382-142">Для [**дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) требуется, чтобы контроллер домена, выбранный в качестве целевого для операций в исходном домене, был PDC в доменах windows NT 4,0 или ЭМУЛЯТОРЕ основного контроллера домена в доменах Windows 2000.</span><span class="sxs-lookup"><span data-stu-id="49382-142">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) requires that the domain controller, selected as the target for operations in the source domain, be the PDC in Windows NT 4.0 domains or the PDC Emulator in Windows 2000 domains.</span></span> <span data-ttu-id="49382-143">Аудит исходного домена создается посредством операций записи, поэтому основной контроллер домена необходим в исходных доменах Windows NT 4,0, а ограничение только основного контроллера домена гарантирует, что аудит **дсаддсидхистори** будет создан на одном компьютере.</span><span class="sxs-lookup"><span data-stu-id="49382-143">Source domain auditing is generated by way of write operations, therefore, the PDC is required in Windows NT 4.0 source domains, and the PDC-only restriction ensures that **DsAddSidHistory** audits are generated on a single computer.</span></span> <span data-ttu-id="49382-144">Это уменьшает необходимость просматривать журналы аудита всех контроллеров домена, чтобы отслеживать использование этой операции.</span><span class="sxs-lookup"><span data-stu-id="49382-144">This reduces the need to review the audit logs of all DCs to monitor use of this operation.</span></span>

> [!Note]  
> <span data-ttu-id="49382-145">В исходных доменах Windows NT 4,0 основной контроллер домена (цель операций в исходном домене) должен работать под управлением с пакетом обновления 4 (SP4) и более поздней версии, чтобы обеспечить правильную поддержку аудита.</span><span class="sxs-lookup"><span data-stu-id="49382-145">In Windows NT 4.0 source domains, the PDC (target of operations in the source domain) must be running Service Pack 4 (SP4) and later to ensure proper auditing support.</span></span>

 

<span data-ttu-id="49382-146">Следующее значение реестра должно быть создано в качестве значения REG \_ DWORD и установлено в 1 на исходном контроллере домена как для Windows NT 4,0, так и для исходных DC windows 2000.</span><span class="sxs-lookup"><span data-stu-id="49382-146">The following registry value must be created as a REG\_DWORD value and set to 1 on the source domain controller for both Windows NT 4.0 and Windows 2000 source DCs.</span></span>

```
HKEY_LOCAL_MACHINE
   System
      CurrentControlSet
         Control
            Lsa
               TcpipClientSupport
```

<span data-ttu-id="49382-147">Установка этого значения включает вызовы RPC через транспорт TCP.</span><span class="sxs-lookup"><span data-stu-id="49382-147">Setting this value enables RPC calls over the TCP transport.</span></span> <span data-ttu-id="49382-148">Это необходимо, поскольку по умолчанию интерфейсы САМРПК поддерживают удаленное взаимодействие только по именованным каналам.</span><span class="sxs-lookup"><span data-stu-id="49382-148">This is required because, by default, SAMRPC interfaces are remotable only on named pipes.</span></span> <span data-ttu-id="49382-149">Использование именованных каналов приводит к созданию системы управления учетными данными, которая подходит для интерактивного входа пользователей, выполняющих вызовы в сети, но не является гибким для системного процесса, осуществляющего сетевые вызовы с учетными данными, предоставленными пользователем.</span><span class="sxs-lookup"><span data-stu-id="49382-149">Using named pipes results in a credential management system suitable for interactively logged-on users making networked calls, but is not flexible for a system process that makes network calls with user-supplied credentials.</span></span> <span data-ttu-id="49382-150">Для этой цели лучше подходит RPC через TCP.</span><span class="sxs-lookup"><span data-stu-id="49382-150">RPC over TCP is more suitable for that purpose.</span></span> <span data-ttu-id="49382-151">Установка этого значения не уменьшает безопасность системы.</span><span class="sxs-lookup"><span data-stu-id="49382-151">Setting this value does not diminish system security.</span></span> <span data-ttu-id="49382-152">Если это значение — "создано" или "изменено", необходимо перезапустить исходный контроллер домена, чтобы этот параметр вступил в силу.</span><span class="sxs-lookup"><span data-stu-id="49382-152">If this value is created or changed, the source domain controller must be restarted for this setting to take effect.</span></span>

<span data-ttu-id="49382-153"><SrcDomainName>В исходном домене для целей аудита необходимо создать новую локальную группу "$ $ $ $".</span><span class="sxs-lookup"><span data-stu-id="49382-153">A new local group, "<SrcDomainName>$$$", must be created in the source domain for auditing purposes.</span></span>

## <a name="auditing"></a><span data-ttu-id="49382-154">Аудит</span><span class="sxs-lookup"><span data-stu-id="49382-154">Auditing</span></span>

<span data-ttu-id="49382-155">[**Дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) операции аудита, чтобы убедиться, что администраторы исходного и конечного домена могут определить, когда была запущена эта функция.</span><span class="sxs-lookup"><span data-stu-id="49382-155">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) operations are audited to ensure that both source and destination domain administrators are able to detect when this function has been run.</span></span> <span data-ttu-id="49382-156">Аудит является обязательным в исходном и конечном доменах.</span><span class="sxs-lookup"><span data-stu-id="49382-156">Auditing is mandatory in both the source and destination domains.</span></span> <span data-ttu-id="49382-157">**Дсаддсидхистори** проверяет, что режим аудита включен в каждом домене и что аудит управления учетными записями событий успехов и отказов включен.</span><span class="sxs-lookup"><span data-stu-id="49382-157">**DsAddSidHistory** verifies that the Audit Mode is on in each domain and that Account Management auditing of Success/Failure events is on.</span></span> <span data-ttu-id="49382-158">В конечном домене для каждой успешной или неудачной операции **дсаддсидхистори** создается уникальное событие аудита "Добавление журнала идентификаторов безопасности".</span><span class="sxs-lookup"><span data-stu-id="49382-158">In the destination domain, a unique "Add Sid History" audit event is generated for each successful or failed **DsAddSidHistory** operation.</span></span>

<span data-ttu-id="49382-159">Уникальные события аудита "Добавление журнала SID" недоступны в системах Windows NT 4,0.</span><span class="sxs-lookup"><span data-stu-id="49382-159">Unique "Add Sid History" audit events are not available on Windows NT 4.0 systems.</span></span> <span data-ttu-id="49382-160">Чтобы создать события аудита, однозначно отражающие использование [**дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) с исходным доменом, он выполняет операции в специальной группе, имя которой является уникальным идентификатором в журнале аудита.</span><span class="sxs-lookup"><span data-stu-id="49382-160">To generate audit events that unambiguously reflect use of [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) against the source domain, it performs operations on a special group whose name is the unique identifier in the audit log.</span></span> <span data-ttu-id="49382-161">Локальная группа " <SrcDomainName> $ $ $", имя которой состоит из NetBIOS-имени исходного домена, к которому добавляется три знака доллара ($) (код ASCII = 0x24 и Юникод = U + 0024), необходимо создать на исходном контроллере домена перед вызовом **дсаддсидхистори**.</span><span class="sxs-lookup"><span data-stu-id="49382-161">A local group, "<SrcDomainName>$$$", whose name is composed of the source domain NetBIOS name appended with three dollar signs ($) (ASCII code = 0x24 and Unicode = U+0024), must be created on the source domain controller prior to calling **DsAddSidHistory**.</span></span> <span data-ttu-id="49382-162">Каждый исходный пользователь и Глобальная группа, которые являются целью этой операции, добавляются в, а затем удаляются из членства этой группы.</span><span class="sxs-lookup"><span data-stu-id="49382-162">Each source user and global group that is a target of this operation is added to and then removed from the membership of this group.</span></span> <span data-ttu-id="49382-163">При этом создаются события аудита добавления участников и удаления элементов в исходном домене, которые можно отслеживать, выполняя поиск событий, ссылающихся на имя группы.</span><span class="sxs-lookup"><span data-stu-id="49382-163">This generates Add Member and Delete Member audit events in the source domain, which can be monitored by searching for events that reference the group name.</span></span>

> [!Note]  
> <span data-ttu-id="49382-164">Не удается выполнить аудит операций [**дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) с локальными группами в исходном ДОМЕНЕ windows NT 4,0 или Windows 2000 в смешанном режиме, так как локальные группы нельзя сделать членами другой локальной группы, поэтому они не могут быть добавлены в специальную <SrcDomainName> локальную группу "$ $ $".</span><span class="sxs-lookup"><span data-stu-id="49382-164">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) operations on local groups in a Windows NT 4.0, or Windows 2000 mixed-mode source domain cannot be audited because local groups cannot be made members of another local group and therefore cannot be added to the special "<SrcDomainName>$$$" local group.</span></span> <span data-ttu-id="49382-165">Отсутствие аудита не представляет проблем безопасности в исходном домене, поскольку эта операция не влияет на доступ к ресурсам исходного домена.</span><span class="sxs-lookup"><span data-stu-id="49382-165">This lack of auditing does not present a security issue to the source domain, because source domain resource access is not affected by this operation.</span></span> <span data-ttu-id="49382-166">Добавление идентификатора безопасности исходной локальной группы в целевую локальную группу не предоставляет другим пользователям доступ к исходным ресурсам, защищенным этой локальной группой.</span><span class="sxs-lookup"><span data-stu-id="49382-166">Adding the SID of a source local group to a destination local group does not grant access to source resources, protected by that local group, to any additional users.</span></span> <span data-ttu-id="49382-167">Добавление членов в целевую локальную группу не предоставляет им доступ к исходным ресурсам.</span><span class="sxs-lookup"><span data-stu-id="49382-167">Adding members to the destination local group does not grant them access to source resources.</span></span> <span data-ttu-id="49382-168">Добавленным членам предоставляется доступ только к серверам в конечном домене, перенесенным из исходного домена, который может иметь ресурсы, защищенные идентификатором безопасности исходной локальной группы.</span><span class="sxs-lookup"><span data-stu-id="49382-168">Added members are granted access only to servers in the destination domain migrated from the source domain, which may have resources protected by the source local group SID.</span></span>

 

## <a name="data-transmission-security"></a><span data-ttu-id="49382-169">Безопасность передачи данных</span><span class="sxs-lookup"><span data-stu-id="49382-169">Data Transmission Security</span></span>

<span data-ttu-id="49382-170">[**Дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) применяет следующие меры безопасности:</span><span class="sxs-lookup"><span data-stu-id="49382-170">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) enforces the following security measures:</span></span>

-   <span data-ttu-id="49382-171">Учетные данные вызывающей стороны, вызываемые с рабочей станции Windows 2000, используются для проверки подлинности и конфиденциальности вызова RPC на целевом контроллере домена.</span><span class="sxs-lookup"><span data-stu-id="49382-171">Called from a Windows 2000 workstation, the caller's credentials are used to authenticate and privacy-protect the RPC call to the destination domain controller.</span></span> <span data-ttu-id="49382-172">Если *сркдомаинкредс* не равен **null**, то и Рабочая станция, и целевой контроллер домена должны поддерживать 128-разрядное шифрование для защиты учетных данных.</span><span class="sxs-lookup"><span data-stu-id="49382-172">If *SrcDomainCreds* is not **NULL**, both the workstation and the destination DC must support 128-bit encryption to privacy-protect the credentials.</span></span> <span data-ttu-id="49382-173">Если 128-разрядное шифрование недоступно и предоставлены *сркдомаинкредс* , то вызов необходимо выполнить на ЦЕЛЕВом контроллере домена.</span><span class="sxs-lookup"><span data-stu-id="49382-173">If 128-bit encryption is not available and *SrcDomainCreds* are provided, then the call must be made on the destination DC.</span></span>
-   <span data-ttu-id="49382-174">Конечный контроллер домена обменивается данными с исходным контроллером домена, используя либо *сркдомаинкредс* , либо учетные данные вызывающей стороны для взаимной проверки подлинности и целостности безопасности учетной записи-источника (с помощью поиска SAM) и **SIDHistory** (с использованием чтения LDAP).</span><span class="sxs-lookup"><span data-stu-id="49382-174">The destination domain controller communicates with the source domain controller using either *SrcDomainCreds* or the caller's credentials to mutually authenticate and integrity-protect the read of the source account SID (using a SAM lookup) and **sIDHistory** (using an LDAP read).</span></span>

## <a name="threat-models"></a><span data-ttu-id="49382-175">Модели угроз</span><span class="sxs-lookup"><span data-stu-id="49382-175">Threat Models</span></span>

<span data-ttu-id="49382-176">В следующей таблице перечислены потенциальные угрозы, связанные с вызовом [**дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) , и рассматриваются меры безопасности, относящиеся к конкретной угрозе.</span><span class="sxs-lookup"><span data-stu-id="49382-176">The following table lists the potential threats associated with the [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) call and addresses the security measures pertinent to the particular threat.</span></span>



<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th><span data-ttu-id="49382-177">Потенциальная угроза</span><span class="sxs-lookup"><span data-stu-id="49382-177">Potential threat</span></span></th>
<th><span data-ttu-id="49382-178">Мера безопасности</span><span class="sxs-lookup"><span data-stu-id="49382-178">Security measure</span></span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span data-ttu-id="49382-179">Мужчина в середине атаки</span><span class="sxs-lookup"><span data-stu-id="49382-179">Man in the Middle Attack</span></span><br/> <span data-ttu-id="49382-180">Неавторизованный пользователь перехватывает <em>идентификатор безопасности поиска</em> в возвращенном вызове исходного объекта, заменяя идентификатор безопасности исходного объекта ПРОИЗВОЛЬНЫм идентификатором SID для вставки в целевой объект SIDhistory.</span><span class="sxs-lookup"><span data-stu-id="49382-180">An unauthorized user intercepts the <em>lookup SID of source object</em> return call, replacing the source object SID with an arbitrary SID for insertion into a target object SIDhistory.</span></span><br/></td>
<td><span data-ttu-id="49382-181"><em>Идентификатор безопасности для поиска исходного объекта</em> — это RPC с проверкой подлинности, использующий учетные данные администратора вызывающей стороны с защитой сообщений целостности пакетов.</span><span class="sxs-lookup"><span data-stu-id="49382-181">The <em>lookup SID of source object</em> is an authenticated RPC, using the caller's administrator credentials, with packet integrity message protection.</span></span> <span data-ttu-id="49382-182">Это гарантирует, что вызов возврата невозможно будет изменить без обнаружения.</span><span class="sxs-lookup"><span data-stu-id="49382-182">This ensures that the return call cannot be modified without detection.</span></span> <span data-ttu-id="49382-183">Конечный контроллер домена создает уникальное &quot; событие добавления аудита журнала SID &quot; , которое отражает идентификатор SID, добавленный в учетную запись <strong>SIDHistory</strong>назначения.</span><span class="sxs-lookup"><span data-stu-id="49382-183">The destination domain controller creates a unique &quot;Add SID History&quot; audit event that reflects the SID added to the destination account <strong>sIDHistory</strong>.</span></span><br/></td>
</tr>
<tr class="even">
<td><span data-ttu-id="49382-184">Троян исходного домена</span><span class="sxs-lookup"><span data-stu-id="49382-184">Trojan Source Domain</span></span><br/> <span data-ttu-id="49382-185">Неавторизованный пользователь создает &quot; &quot; исходный домен троянского коня в частной сети с тем же идентификатором безопасности домена и теми же идентификаторами безопасности учетной записи, что и у допустимого исходного домена.</span><span class="sxs-lookup"><span data-stu-id="49382-185">An unauthorized user creates a &quot;Trojan Horse&quot; source domain on a private network that has the same domain SID and some of the same account SIDs as the legitimate source domain.</span></span> <span data-ttu-id="49382-186">Затем неавторизованный пользователь пытается запустить <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>дсаддсидхистори</strong></a> в конечном домене для получения идентификатора безопасности исходной учетной записи.</span><span class="sxs-lookup"><span data-stu-id="49382-186">The unauthorized user then attempts to run <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a> in a destination domain to obtain the SID of a source account.</span></span> <span data-ttu-id="49382-187">Это делается без необходимости в реальных учетных данных администратора исходного домена и не выходит за пределы журнала аудита в реальном исходном домене.</span><span class="sxs-lookup"><span data-stu-id="49382-187">This is done without the need for the real source Domain Administrator credentials and without leaving an audit trail in the real source domain.</span></span> <span data-ttu-id="49382-188">Неавторизованный пользователь для создания исходного домена троянского коня может быть одним из следующих:</span><span class="sxs-lookup"><span data-stu-id="49382-188">The unauthorized user's method for creating the Trojan Horse source domain could be one of the following:</span></span>
<ul>
<li><span data-ttu-id="49382-189">Получение копии (резервное копирование BDC) исходного домена SAM.</span><span class="sxs-lookup"><span data-stu-id="49382-189">Obtain a copy (BDC backup) of the source domain SAM.</span></span></li>
<li><span data-ttu-id="49382-190">Создайте новый домен, изменив идентификатор SID домена на диске в соответствии с действительным SID исходного домена, а затем создайте достаточное количество пользователей для создания экземпляра учетной записи с нужным идентификатором SID.</span><span class="sxs-lookup"><span data-stu-id="49382-190">Create a new domain, altering the domain SID on disk to match the legitimate source domain SID, then create enough users to instantiate an account with the desired SID.</span></span></li>
<li><span data-ttu-id="49382-191">Создайте реплику BDC.</span><span class="sxs-lookup"><span data-stu-id="49382-191">Create a BDC replica.</span></span> <span data-ttu-id="49382-192">Для этого требуются учетные данные администратора исходного домена.</span><span class="sxs-lookup"><span data-stu-id="49382-192">This requires source domain Administrator credentials.</span></span> <span data-ttu-id="49382-193">Затем неавторизованный пользователь принимает реплику в частной сети для реализации атаки.</span><span class="sxs-lookup"><span data-stu-id="49382-193">Then the unauthorized user takes the replica to a private network to implement the attack.</span></span></li>
</ul>
<br/></td>
<td><span data-ttu-id="49382-194">Несмотря на то, что неавторизованный пользователь может получить или создать нужный идентификатор безопасности исходного объекта, неавторизованный пользователь не сможет использовать его для обновления <strong>SIDHistory</strong> учетной записи, не являясь членом группы администраторов конечного домена.</span><span class="sxs-lookup"><span data-stu-id="49382-194">Although there are many ways for an unauthorized user to retrieve or create a desired source object SID, the unauthorized user cannot use it to update an account's <strong>sIDHistory</strong> without being a member of the destination Domain Administrators group.</span></span> <span data-ttu-id="49382-195">Поскольку проверка на целевом контроллере домена для членства в администраторе домена жестко запрограммирована, на целевом КОНТРОЛЛЕРе домена нет метода для изменения данных контроля доступа, защищающих эту функцию.</span><span class="sxs-lookup"><span data-stu-id="49382-195">Because the check, on the destination domain controller, for Domain Administrator membership is hard-coded, on the target DC, there is no method for doing a disk modification to change the access control data protecting this function.</span></span> <span data-ttu-id="49382-196">В конечном домене выполняется попытка клонирования исходной учетной записи троянского коня.</span><span class="sxs-lookup"><span data-stu-id="49382-196">An attempt to clone a Trojan Horse source account is audited in the destination domain.</span></span> <span data-ttu-id="49382-197">Эта атака уменьшается за счет резервирования членства в группе "Администраторы домена" только для пользователей с высоким уровнем доверия.</span><span class="sxs-lookup"><span data-stu-id="49382-197">This attack is mitigated by reserving membership in the Domain Administrators group for only highly trusted individuals.</span></span><br/></td>
</tr>
<tr class="odd">
<td><span data-ttu-id="49382-198">Изменение журнала SID на диске</span><span class="sxs-lookup"><span data-stu-id="49382-198">On-disk Modification of SID History</span></span><br/> <span data-ttu-id="49382-199">Сложный неавторизованный пользователь с учетными данными администратора домена и физическим доступом к КОНТРОЛЛЕРу домена в конечном домене может изменить значение <strong>SIDHistory</strong> учетной записи на диске.</span><span class="sxs-lookup"><span data-stu-id="49382-199">A sophisticated unauthorized user, with Domain Administrator credentials and with physical access to a DC in the destination domain, could modify an account <strong>sIDHistory</strong> value on disk.</span></span><br/></td>
<td><span data-ttu-id="49382-200">Эта попыток не включается с помощью <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>дсаддсидхистори</strong></a>.</span><span class="sxs-lookup"><span data-stu-id="49382-200">This attempt is not enabled by use of <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a>.</span></span> <span data-ttu-id="49382-201">Эта атака снижается благодаря предотвращению физического доступа к контроллерам домена ко всем, Кроме администраторов с высоким уровнем доверия.</span><span class="sxs-lookup"><span data-stu-id="49382-201">This attack is mitigated by preventing physical access to domain controllers to all except highly trusted administrators.</span></span><br/></td>
</tr>
<tr class="even">
<td><span data-ttu-id="49382-202">Мошеннический код, используемый для снятия защиты</span><span class="sxs-lookup"><span data-stu-id="49382-202">Rogue Code Used to Remove Protections</span></span><br/> <span data-ttu-id="49382-203">Неавторизованный пользователь или злонамеренный администратор с физическим доступом к коду службы каталогов может создать мошеннический код, который:</span><span class="sxs-lookup"><span data-stu-id="49382-203">An unauthorized user or rogue administrator with physical access to the Directory Service code could create rogue code that:</span></span>
<ol>
<li><span data-ttu-id="49382-204">Удаляет проверку членства в группе администраторов домена в коде.</span><span class="sxs-lookup"><span data-stu-id="49382-204">Removes the check for membership in the Domain Administrators group in the code.</span></span></li>
<li><span data-ttu-id="49382-205">Изменяет вызовы на исходном контроллере домена, который указывает SID, на Лукупсидфромнаме, для которого не выполняется аудит.</span><span class="sxs-lookup"><span data-stu-id="49382-205">Changes the calls on the source domain controller that points the SID to a LookupSidFromName that is not audited.</span></span></li>
<li><span data-ttu-id="49382-206">Удаляет вызовы журнала аудита.</span><span class="sxs-lookup"><span data-stu-id="49382-206">Removes audit log calls.</span></span></li>
</ol>
<br/></td>
<td><span data-ttu-id="49382-207">Пользователь с физическим доступом к коду DS и знания, достаточные для создания мошеннического кода, имеет возможность произвольно изменять атрибут <strong>SIDHistory</strong> учетной записи.</span><span class="sxs-lookup"><span data-stu-id="49382-207">Someone with physical access to the DS code and knowledgeable enough to create rogue code has the capability of arbitrarily modifying the <strong>sIDHistory</strong> attribute of an account.</span></span> <span data-ttu-id="49382-208">API <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>дсаддсидхистори</strong></a> не повышает эту угрозу безопасности.</span><span class="sxs-lookup"><span data-stu-id="49382-208">The <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a> API does not increase this security risk.</span></span><br/></td>
</tr>
<tr class="odd">
<td><span data-ttu-id="49382-209">Ресурсы, уязвимые для заимствованных идентификаторов безопасности</span><span class="sxs-lookup"><span data-stu-id="49382-209">Resources Vulnerable to Stolen SIDs</span></span><br/> <span data-ttu-id="49382-210">Если неавторизованный пользователь успешно использовал один из описанных здесь методов для изменения учетной записи <strong>SIDHistory</strong>, и если домены ресурсов, представляющие доверие, имеют несанкционированный домен учетных записей, то несанкционированный пользователь может получить несанкционированный доступ к ресурсам заимствованных SID, потенциально без учета журнала аудита в домене учетной записи, из которого был украден идентификатор безопасности.</span><span class="sxs-lookup"><span data-stu-id="49382-210">If an unauthorized user has succeeded in using one of the methods described here to modify an account <strong>sIDHistory</strong>, and if the resource domains of interest trust the unauthorized user account domain, then the unauthorized user can get unauthorized access to the stolen SID's resources, potentially without leaving an audit trail in the account domain from which the SID was stolen.</span></span><br/></td>
<td><span data-ttu-id="49382-211">Администраторы домена ресурсов защищают свои ресурсы, настроив только те отношения доверия, которые имеют смысл в перспективе безопасности.</span><span class="sxs-lookup"><span data-stu-id="49382-211">Resource domain administrators protect their resources by setting up only those trust relationships that make sense from a security perspective.</span></span> <span data-ttu-id="49382-212">Использование <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>дсаддсидхистори</strong></a> ограничено в доверенном целевом домене членами группы администраторов домена, у которых уже есть широкие разрешения в рамках их обязанностей.</span><span class="sxs-lookup"><span data-stu-id="49382-212">Use of <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a> is restricted, in the trusted target domain, to members of the Domain Administrators group who already have broad permissions within the scope of their responsibilities.</span></span><br/></td>
</tr>
<tr class="even">
<td><span data-ttu-id="49382-213">Фальшивый конечный домен</span><span class="sxs-lookup"><span data-stu-id="49382-213">Rogue Target Domain</span></span><br/> <span data-ttu-id="49382-214">Неавторизованный пользователь создает домен Windows 2000 с учетной записью, <strong>SIDHistory</strong> которой содержит идентификатор безопасности, украденный из исходного домена.</span><span class="sxs-lookup"><span data-stu-id="49382-214">An unauthorized user creates a Windows 2000 domain with an account whose <strong>sIDHistory</strong> contains a SID that has been stolen from a source domain.</span></span> <span data-ttu-id="49382-215">Неавторизованный пользователь использует эту учетную запись для несанкционированного доступа к ресурсам.</span><span class="sxs-lookup"><span data-stu-id="49382-215">The unauthorized user uses this account for unauthorized access to resources.</span></span><br/></td>
<td><span data-ttu-id="49382-216">Неавторизованный пользователь требует учетные данные администратора для исходного домена, чтобы использовать <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>дсаддсидхистори</strong></a>, и оставляет журнал аудита на исходном контроллере домена.</span><span class="sxs-lookup"><span data-stu-id="49382-216">The unauthorized user requires Administrator credentials for the source domain in order to use <a href="/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya"><strong>DsAddSidHistory</strong></a>, and leaves an audit trail on the source domain controller.</span></span> <span data-ttu-id="49382-217">Фальшивый конечный домен получает несанкционированный доступ только в других доменах, которые доверяют фальшивому домену, что требует прав администратора в этих доменах ресурсов.</span><span class="sxs-lookup"><span data-stu-id="49382-217">The rogue target domain gains unauthorized access only in other domains that trust the rogue domain, which requires Administrator privileges in those resource domains.</span></span><br/></td>
</tr>
</tbody>
</table>



 

## <a name="operational-constraints"></a><span data-ttu-id="49382-218">Операционные ограничения</span><span class="sxs-lookup"><span data-stu-id="49382-218">Operational Constraints</span></span>

<span data-ttu-id="49382-219">В этом разделе описываются эксплуатационные ограничения использования функции [**дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) .</span><span class="sxs-lookup"><span data-stu-id="49382-219">This section describes the operational constraints of using the [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) function.</span></span>

<span data-ttu-id="49382-220">Идентификатор безопасности *сркпринЦипал* не должен существовать в целевом лесу как идентификатор безопасности первичной учетной записи или в **SIDHistory** учетной записи.</span><span class="sxs-lookup"><span data-stu-id="49382-220">The SID of *SrcPrincipal* must not already exist in the destination forest, either as a primary account SID or in the **sIDHistory** of an account.</span></span> <span data-ttu-id="49382-221">Исключением является то, что [**дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) не создает ошибку при попытке добавить идентификатор безопасности в **SIDHistory** , который содержит идентичный идентификатор безопасности.</span><span class="sxs-lookup"><span data-stu-id="49382-221">The exception is that [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) does not generate an error when attempting to add a SID to a **sIDHistory** that contains an identical SID.</span></span> <span data-ttu-id="49382-222">Такое поведение позволяет запускать **дсаддсидхистори** несколько раз с идентичными входными данными, что приводит к успешному завершению и противоречивому состоянию, для простоты использования разработчиком инструментов.</span><span class="sxs-lookup"><span data-stu-id="49382-222">This behavior enables **DsAddSidHistory** to be run multiple times with identical input, resulting in success and a consistent end state, for tool developer ease-of-use.</span></span>

> [!Note]  
> <span data-ttu-id="49382-223">Задержка репликации глобального каталога может предоставить окно, в течение которого могут быть созданы дублирующиеся идентификаторы SID.</span><span class="sxs-lookup"><span data-stu-id="49382-223">Global Catalog replication latency may provide a window during which duplicate SIDs may be created.</span></span> <span data-ttu-id="49382-224">Однако администратор может легко удалить дублирующиеся идентификаторы SID.</span><span class="sxs-lookup"><span data-stu-id="49382-224">However, duplicate SIDs can be easily deleted by an administrator.</span></span>

 

<span data-ttu-id="49382-225">*СркпринЦипал* и *дстпринЦипал* должны иметь один из следующих типов:</span><span class="sxs-lookup"><span data-stu-id="49382-225">*SrcPrincipal* and *DstPrincipal* must be one of the following types:</span></span>

-   <span data-ttu-id="49382-226">Пользователь</span><span class="sxs-lookup"><span data-stu-id="49382-226">User</span></span>
-   <span data-ttu-id="49382-227">Группа с включенной безопасностью, включая:</span><span class="sxs-lookup"><span data-stu-id="49382-227">Security Enabled Group, including:</span></span>

    <dl> <span data-ttu-id="49382-228">Локальная группа</span><span class="sxs-lookup"><span data-stu-id="49382-228">Local group</span></span>  
    <span data-ttu-id="49382-229">Глобальная группа</span><span class="sxs-lookup"><span data-stu-id="49382-229">Global group</span></span>  
    <span data-ttu-id="49382-230">Локальная группа домена (только в основном режиме Windows 2000)</span><span class="sxs-lookup"><span data-stu-id="49382-230">Domain local group (Windows 2000 native mode only)</span></span>  
    <span data-ttu-id="49382-231">Универсальная группа (только в основном режиме Windows 2000)</span><span class="sxs-lookup"><span data-stu-id="49382-231">Universal group (Windows 2000 native mode only)</span></span>  
    </dl>

<span data-ttu-id="49382-232">Типы объектов *сркпринЦипал* и *дстпринЦипал* должны совпадать.</span><span class="sxs-lookup"><span data-stu-id="49382-232">The object types of *SrcPrincipal* and *DstPrincipal* must match.</span></span>

-   <span data-ttu-id="49382-233">Если *сркпринЦипал* является пользователем, *ДстпринЦипал* должен быть пользователем.</span><span class="sxs-lookup"><span data-stu-id="49382-233">If *SrcPrincipal* is a User, *DstPrincipal* must be a User.</span></span>
-   <span data-ttu-id="49382-234">Если *сркпринЦипал* является локальной или локальной группой домена, *ДстпринЦипал* должен быть локальной группой домена.</span><span class="sxs-lookup"><span data-stu-id="49382-234">If *SrcPrincipal* is a Local or Domain Local Group, *DstPrincipal* must be a Domain Local Group.</span></span>
-   <span data-ttu-id="49382-235">Если *сркпринЦипал* является глобальной или универсальной группой, *ДстпринЦипал* должен быть глобальной или универсальной группой.</span><span class="sxs-lookup"><span data-stu-id="49382-235">If *SrcPrincipal* is a Global or Universal Group, *DstPrincipal* must be a Global or Universal Group.</span></span>

<span data-ttu-id="49382-236">*СркпринЦипал* и *дстпринЦипал* не могут быть одного из следующих типов: (в этих случаях [**дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) завершается с ошибкой)</span><span class="sxs-lookup"><span data-stu-id="49382-236">*SrcPrincipal* and *DstPrincipal* cannot be one of the following types: ([**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) fails with an error in these cases)</span></span>

-   <span data-ttu-id="49382-237">Компьютер (Рабочая станция или контроллер домена)</span><span class="sxs-lookup"><span data-stu-id="49382-237">Computer (workstation or domain controller)</span></span>
-   <span data-ttu-id="49382-238">Доверительные отношения между доменами</span><span class="sxs-lookup"><span data-stu-id="49382-238">Inter-domain trust</span></span>
-   <span data-ttu-id="49382-239">Временная повторяющаяся учетная запись (виртуальная неиспользуемая функция, устаревшая версия LANman)</span><span class="sxs-lookup"><span data-stu-id="49382-239">Temporary duplicate account (virtually unused feature, a legacy of LANman)</span></span>
-   <span data-ttu-id="49382-240">Учетные записи с хорошо известными идентификаторами безопасности.</span><span class="sxs-lookup"><span data-stu-id="49382-240">Accounts with Well Known SIDs.</span></span> <span data-ttu-id="49382-241">Хорошо известные идентификаторы безопасности идентичны в каждом домене; Таким образом, добавление их в **SIDHistory** нарушает требования уникальности SID леса Windows 2000.</span><span class="sxs-lookup"><span data-stu-id="49382-241">Well Known SIDs are identical in every domain; thus adding them to a **sIDHistory** would violate the SID uniqueness requirement of a Windows 2000 forest.</span></span> <span data-ttu-id="49382-242">Учетные записи с хорошо известными идентификаторами безопасности включают следующие локальные группы:</span><span class="sxs-lookup"><span data-stu-id="49382-242">Accounts with Well Known SIDs include the following local groups:</span></span>

    <dl> <span data-ttu-id="49382-243">Операторы учетных записей</span><span class="sxs-lookup"><span data-stu-id="49382-243">Account operators</span></span>  
    <span data-ttu-id="49382-244">Администраторы</span><span class="sxs-lookup"><span data-stu-id="49382-244">Administrators</span></span>  
    <span data-ttu-id="49382-245">Операторы резервного копирования</span><span class="sxs-lookup"><span data-stu-id="49382-245">Backup operators</span></span>  
    <span data-ttu-id="49382-246">Гости</span><span class="sxs-lookup"><span data-stu-id="49382-246">Guests</span></span>  
    <span data-ttu-id="49382-247">Операторы печати</span><span class="sxs-lookup"><span data-stu-id="49382-247">Print operators</span></span>  
    <span data-ttu-id="49382-248">Репликатор</span><span class="sxs-lookup"><span data-stu-id="49382-248">Replicator</span></span>  
    <span data-ttu-id="49382-249">Операторы сервера</span><span class="sxs-lookup"><span data-stu-id="49382-249">Server operators</span></span>  
    <span data-ttu-id="49382-250">Пользователи</span><span class="sxs-lookup"><span data-stu-id="49382-250">Users</span></span>  
    </dl>

<span data-ttu-id="49382-251">Если *сркпринЦипал* имеет хорошо известный относительный идентификатор (RID) и префикс, соответствующий домену, то есть администраторы домена, пользователи домена и компьютеры домена, то *дстпринЦипал* должен обладать тем же известным RID, чтобы [**дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) успешно.</span><span class="sxs-lookup"><span data-stu-id="49382-251">If *SrcPrincipal* has a well-known relative identifier (RID) and a domain specific prefix, that is, Domain Administrators, Domain Users, and Domain Computers, then *DstPrincipal* must possess the same well-known RID in order for [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) to succeed.</span></span> <span data-ttu-id="49382-252">Учетные записи с хорошо известными идентификаторами RID включают следующие пользователи и глобальные группы:</span><span class="sxs-lookup"><span data-stu-id="49382-252">Accounts with well-known RIDs include the following users and global groups:</span></span>

-   <span data-ttu-id="49382-253">Администратор</span><span class="sxs-lookup"><span data-stu-id="49382-253">Administrator</span></span>
-   <span data-ttu-id="49382-254">Гость</span><span class="sxs-lookup"><span data-stu-id="49382-254">Guest</span></span>
-   <span data-ttu-id="49382-255">Администраторы домена</span><span class="sxs-lookup"><span data-stu-id="49382-255">Domain administrators</span></span>
-   <span data-ttu-id="49382-256">Гости домена</span><span class="sxs-lookup"><span data-stu-id="49382-256">Domain guests</span></span>
-   <span data-ttu-id="49382-257">пользователи домена;</span><span class="sxs-lookup"><span data-stu-id="49382-257">Domain users</span></span>

## <a name="setting-the-registry-value"></a><span data-ttu-id="49382-258">Установка значения реестра</span><span class="sxs-lookup"><span data-stu-id="49382-258">Setting the Registry Value</span></span>

<span data-ttu-id="49382-259">В следующей процедуре показано, как задать значение реестра Ткпипклиентсуппорт.</span><span class="sxs-lookup"><span data-stu-id="49382-259">The following procedure shows how to set the TcpipClientSupport registry value.</span></span>

<span data-ttu-id="49382-260">**Установка значения реестра Ткпипклиентсуппорт**</span><span class="sxs-lookup"><span data-stu-id="49382-260">**To Set the TcpipClientSupport Registry Value**</span></span>

1.  <span data-ttu-id="49382-261">Создайте следующий параметр реестра в качестве значения REG \_ DWORD на исходном контроллере домена и присвойте ему значение 1.</span><span class="sxs-lookup"><span data-stu-id="49382-261">Create the following registry value as a REG\_DWORD value on the source domain controller and set its value to 1.</span></span>

    <span data-ttu-id="49382-262">**HKEY \_ локальный \_ компьютер \\ система \\ CurrentControlSet \\ Управление \\ LSA \\ ткпипклиентсуппорт**</span><span class="sxs-lookup"><span data-stu-id="49382-262">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\TcpipClientSupport**</span></span>

2.  <span data-ttu-id="49382-263">Затем перезапустите исходный контроллер домена.</span><span class="sxs-lookup"><span data-stu-id="49382-263">Then, restart the source domain controller.</span></span> <span data-ttu-id="49382-264">Это значение реестра заставляет SAM прослушивать TCP/IP.</span><span class="sxs-lookup"><span data-stu-id="49382-264">This registry value causes the SAM to listen on TCP/IP.</span></span> <span data-ttu-id="49382-265">[**Дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) завершится ошибкой, если это значение не задано на исходном контроллере домена.</span><span class="sxs-lookup"><span data-stu-id="49382-265">[**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) will fail if this value is not set on the source domain controller.</span></span>

## <a name="enabling-auditing-of-usergroup-management-events"></a><span data-ttu-id="49382-266">Включение аудита событий управления пользователями и группами</span><span class="sxs-lookup"><span data-stu-id="49382-266">Enabling Auditing of User/Group Management Events</span></span>

<span data-ttu-id="49382-267">В следующей процедуре показано, как включить аудит событий управления пользователями и группами в исходном или конечном домене Windows 2000 или Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="49382-267">The following procedure shows how to enable auditing of User/Group management events in a Windows 2000 or Windows Server 2003 source or destination domain.</span></span>

<span data-ttu-id="49382-268">**Включение аудита событий управления пользователями и группами в исходном или конечном домене Windows 2000 или Windows Server 2003**</span><span class="sxs-lookup"><span data-stu-id="49382-268">**To enable auditing of User/Group management events in a Windows 2000 or Windows Server 2003 source or destination domain**</span></span>

1.  <span data-ttu-id="49382-269">В оснастке MMC Active Directory пользователи и компьютеры выберите контейнер Контроллеры домена назначения.</span><span class="sxs-lookup"><span data-stu-id="49382-269">In the Active Directory Users and Computers MMC Snap-in, select the destination domain Domain Controllers container.</span></span>
2.  <span data-ttu-id="49382-270">Щелкните правой кнопкой мыши элемент **контроллеры домена** и выберите пункт **свойства**.</span><span class="sxs-lookup"><span data-stu-id="49382-270">Right-click **Domain Controllers** and choose **Properties**.</span></span>
3.  <span data-ttu-id="49382-271">Перейдите на вкладку **Групповая политика** .</span><span class="sxs-lookup"><span data-stu-id="49382-271">Click the **Group Policy** tab.</span></span>
4.  <span data-ttu-id="49382-272">Выберите **политику контроллеров домена по умолчанию** и нажмите кнопку **изменить**.</span><span class="sxs-lookup"><span data-stu-id="49382-272">Select the **Default Domain Controllers Policy** and click **Edit**.</span></span>
5.  <span data-ttu-id="49382-273">В разделе **Конфигурация компьютера Настройка \\ Windows параметры \\ безопасности \\ \\ политики аудита локальные политики** дважды щелкните элемент **Аудит Управление учетными записями**.</span><span class="sxs-lookup"><span data-stu-id="49382-273">Under **Computer Configuration\\Windows Settings\\Security Settings\\Local Policies\\Audit Policy**, double-click **Audit Account Management**.</span></span>
6.  <span data-ttu-id="49382-274">В окне **Аудит управления учетной записью** выберите аудит **успехов** и **сбоев** .</span><span class="sxs-lookup"><span data-stu-id="49382-274">In the **Audit Account Management** window, select both **Success** and **Failure** auditing.</span></span> <span data-ttu-id="49382-275">Обновления политики вступают в силу после перезапуска или после обновления.</span><span class="sxs-lookup"><span data-stu-id="49382-275">Policy updates take effect after a restart or after a refresh occurs.</span></span>
7.  <span data-ttu-id="49382-276">Убедитесь, что аудит включен, просмотрев действующую политику аудита в оснастке групповая политика MMC.</span><span class="sxs-lookup"><span data-stu-id="49382-276">Verify that auditing is enabled by viewing the effective audit policy in the Group Policy MMC Snap-in.</span></span>

<span data-ttu-id="49382-277">В следующей процедуре показано, как включить аудит событий управления пользователями и группами в домене Windows NT 4,0.</span><span class="sxs-lookup"><span data-stu-id="49382-277">The following procedure shows how to enable auditing of User/Group management events in a Windows NT 4.0 domain.</span></span>

<span data-ttu-id="49382-278">**Включение аудита событий управления пользователями и группами в домене Windows NT 4,0**</span><span class="sxs-lookup"><span data-stu-id="49382-278">**To enable auditing of User/Group management events in a Windows NT 4.0 domain**</span></span>

1.  <span data-ttu-id="49382-279">В **диспетчере пользователей для доменов** откройте меню **политики** и выберите пункт **Аудит**.</span><span class="sxs-lookup"><span data-stu-id="49382-279">In **User Manager for Domains**, click the **Policies** menu and select **Audit**.</span></span>
2.  <span data-ttu-id="49382-280">Выберите **аудит этих событий**.</span><span class="sxs-lookup"><span data-stu-id="49382-280">Select **Audit These Events**.</span></span>
3.  <span data-ttu-id="49382-281">Для **управления пользователями и группами** проверьте **успешность и сбой**.</span><span class="sxs-lookup"><span data-stu-id="49382-281">For **User and Group Management**, check **Success and Failure**.</span></span>

<span data-ttu-id="49382-282">В следующей процедуре показано, как включить аудит событий управления пользователями и группами в исходном домене Windows NT 4,0, Windows 2000 или Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="49382-282">The following procedure shows how to enable auditing of User/Group management events in a Windows NT 4.0, Windows 2000, or Windows Server 2003 source domain.</span></span>

<span data-ttu-id="49382-283">**Включение аудита событий управления пользователями и группами в исходном домене Windows NT 4,0, Windows 2000 или Windows Server 2003**</span><span class="sxs-lookup"><span data-stu-id="49382-283">**To enable auditing of User/Group management events in a Windows NT 4.0, Windows 2000, or Windows Server 2003 source domain**</span></span>

1.  <span data-ttu-id="49382-284">В **диспетчере пользователей для доменов** щелкните меню **пользователь** и выберите **создать локальную группу**.</span><span class="sxs-lookup"><span data-stu-id="49382-284">In **User Manager for Domains**, click the **User** menu and select **New Local Group**.</span></span>
2.  <span data-ttu-id="49382-285">Введите имя группы, состоящее из NetBIOS-имени исходного домена, к которому добавлено три знака доллара ($), например FABRIKAM $ $ $.</span><span class="sxs-lookup"><span data-stu-id="49382-285">Enter a group name composed of the source domain NetBIOS name appended with three dollar signs ($), for example, FABRIKAM$$$.</span></span> <span data-ttu-id="49382-286">В поле Описание должно быть указано, что эта группа используется для аудита использования [**дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) или клонирования операций.</span><span class="sxs-lookup"><span data-stu-id="49382-286">The description field should indicate that this group is used to audit use of [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) or cloning operations.</span></span> <span data-ttu-id="49382-287">Убедитесь, что в группе нет элементов.</span><span class="sxs-lookup"><span data-stu-id="49382-287">Ensure there are no members in the group.</span></span> <span data-ttu-id="49382-288">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="49382-288">Click **OK**.</span></span>

<span data-ttu-id="49382-289">Операция [**дсаддсидхистори**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) завершается ошибкой, если аудит источника и назначения не включен, как описано здесь.</span><span class="sxs-lookup"><span data-stu-id="49382-289">The [**DsAddSidHistory**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsaddsidhistorya) operation fails if source and destination auditing are not enabled as described here.</span></span>

## <a name="set-up-trust-if-required"></a><span data-ttu-id="49382-290">Настройка доверия при необходимости</span><span class="sxs-lookup"><span data-stu-id="49382-290">Set up Trust if Required</span></span>

<span data-ttu-id="49382-291">Если одно из следующих условий истинно, необходимо установить отношение доверия между исходным доменом и конечным доменом (это должно происходить в другом лесу):</span><span class="sxs-lookup"><span data-stu-id="49382-291">If one of the following is true, a trust must be established from the source domain to the destination domain (this must occur in a different forest):</span></span>

-   <span data-ttu-id="49382-292">Исходный домен — Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="49382-292">The source domain is Windows Server 2003.</span></span>
-   <span data-ttu-id="49382-293">Исходный домен — Windows NT 4,0, а *сркдомаинкредс* — **null**.</span><span class="sxs-lookup"><span data-stu-id="49382-293">The source domain is Windows NT 4.0 and *SrcDomainCreds* is **NULL**.</span></span>

 

 





