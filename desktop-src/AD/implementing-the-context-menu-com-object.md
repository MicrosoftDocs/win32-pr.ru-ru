---
title: Реализация COM-объекта контекстного меню
description: Расширение контекстного меню — это COM-объект, реализованный как внутрипроцессный сервер.
ms.assetid: 362dd8e5-1518-4bf4-ac53-115263cd6c62
ms.tgt_platform: multiple
keywords:
- контекстное меню COM-объекта в Active Directory
- контекстное меню COM-объекта в Active Directory, реализация
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a34d6b487d130327b379ed845f2d0157f2b28056
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/17/2020
ms.locfileid: "105654288"
---
# <a name="implementing-the-context-menu-com-object"></a><span data-ttu-id="8c934-105">Реализация COM-объекта контекстного меню</span><span class="sxs-lookup"><span data-stu-id="8c934-105">Implementing the Context Menu COM Object</span></span>

<span data-ttu-id="8c934-106">Расширение контекстного меню — это COM-объект, реализованный как внутрипроцессный сервер.</span><span class="sxs-lookup"><span data-stu-id="8c934-106">A context menu extension is a COM object implemented as an in-proc server.</span></span> <span data-ttu-id="8c934-107">Расширение контекстного меню должно реализовывать интерфейсы [**ишеллекстинит**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit) и [**IContextMenu**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-icontextmenu) .</span><span class="sxs-lookup"><span data-stu-id="8c934-107">The context menu extension must implement the [**IShellExtInit**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit) and [**IContextMenu**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-icontextmenu) interfaces.</span></span> <span data-ttu-id="8c934-108">При отображении контекстного меню для объекта класса, для которого зарегистрировано расширение контекстного меню, создается экземпляр расширения контекстного меню.</span><span class="sxs-lookup"><span data-stu-id="8c934-108">A context menu extension is instantiated when the user displays the context menu for an object of a class for which the context menu extension has been registered.</span></span>

## <a name="implementing-ishellextinit"></a><span data-ttu-id="8c934-109">Реализация Ишеллекстинит</span><span class="sxs-lookup"><span data-stu-id="8c934-109">Implementing IShellExtInit</span></span>

<span data-ttu-id="8c934-110">После создания экземпляра COM-объекта расширения контекстного меню вызывается метод [**ишеллекстинит:: Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) .</span><span class="sxs-lookup"><span data-stu-id="8c934-110">After the context menu extension COM object is instantiated, the [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) method is called.</span></span> <span data-ttu-id="8c934-111">**Ишеллекстинит:: Initialize** предоставляет расширение контекстного меню с объектом [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) , который содержит данные, относящиеся к объекту каталога, к которому применяется контекстное меню.</span><span class="sxs-lookup"><span data-stu-id="8c934-111">**IShellExtInit::Initialize** supplies the context menu extension with an [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) object that contains data pertinent to the directory object that the context menu applies to.</span></span>

<span data-ttu-id="8c934-112">[**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) содержит данные в формате [**кфстр \_ дсобжектнамес**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format) .</span><span class="sxs-lookup"><span data-stu-id="8c934-112">The [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) contains data in the [**CFSTR\_DSOBJECTNAMES**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format) format.</span></span> <span data-ttu-id="8c934-113">Формат данных **кфстр \_ дсобжектнамес** — это **Хглобал** , содержащий структуру [**дсобжектнамес**](/windows/desktop/api/Dsclient/ns-dsclient-dsobjectnames) .</span><span class="sxs-lookup"><span data-stu-id="8c934-113">The **CFSTR\_DSOBJECTNAMES** data format is an **HGLOBAL** that contains a [**DSOBJECTNAMES**](/windows/desktop/api/Dsclient/ns-dsclient-dsobjectnames) structure.</span></span> <span data-ttu-id="8c934-114">Структура **дсобжектнамес** содержит данные о объекте каталога, к которому применяется расширение страницы свойств.</span><span class="sxs-lookup"><span data-stu-id="8c934-114">The **DSOBJECTNAMES** structure contains data about the directory object that the property sheet extension applies to.</span></span>

<span data-ttu-id="8c934-115">[**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) также содержит данные в формате [**\_ \_ \_ \_ параметров отображаемой спецификации кфстр DS**](cfstr-ds-display-spec-options.md) .</span><span class="sxs-lookup"><span data-stu-id="8c934-115">The [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) also contains data in the [**CFSTR\_DS\_DISPLAY\_SPEC\_OPTIONS**](cfstr-ds-display-spec-options.md) format.</span></span> <span data-ttu-id="8c934-116">Формат **данных \_ \_ \_ \_ параметров отображаемой спецификации кфстр DS** — это **хглобал** , содержащий структуру [**дсдисплайспекоптионс**](/windows/desktop/api/Dsclient/ns-dsclient-dsdisplayspecoptions) .</span><span class="sxs-lookup"><span data-stu-id="8c934-116">The **CFSTR\_DS\_DISPLAY\_SPEC\_OPTIONS** data format is an **HGLOBAL** that contains a [**DSDISPLAYSPECOPTIONS**](/windows/desktop/api/Dsclient/ns-dsclient-dsdisplayspecoptions) structure.</span></span> <span data-ttu-id="8c934-117">**Дсдисплайспекоптионс** содержит данные конфигурации для использования расширением.</span><span class="sxs-lookup"><span data-stu-id="8c934-117">The **DSDISPLAYSPECOPTIONS** contains configuration data for use by the extension.</span></span>

<span data-ttu-id="8c934-118">Если в [**ишеллекстинит:: Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize)возвращается любое значение, отличное от **S \_ OK** , то расширение контекстного меню не будет использоваться.</span><span class="sxs-lookup"><span data-stu-id="8c934-118">If any value other than **S\_OK** is returned from [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize), the context menu extension will not be used.</span></span>

<span data-ttu-id="8c934-119">Параметры *пидлфолдер* и *хкэйпрогид* метода [**ишеллекстинит:: Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) не используются.</span><span class="sxs-lookup"><span data-stu-id="8c934-119">The *pidlFolder* and *hkeyProgID* parameters of the [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) method are not used.</span></span>

## <a name="implementing-icontextmenu"></a><span data-ttu-id="8c934-120">Реализация IContextMenu</span><span class="sxs-lookup"><span data-stu-id="8c934-120">Implementing IContextMenu</span></span>

<span data-ttu-id="8c934-121">После возврата [**ишеллекстинит:: Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) вызывается метод [**IContextMenu:: куериконтекстмену**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-icontextmenu-querycontextmenu) для получения пункта меню или элементов, которые будет добавлять расширение контекстного меню.</span><span class="sxs-lookup"><span data-stu-id="8c934-121">After [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) returns, the [**IContextMenu::QueryContextMenu**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-icontextmenu-querycontextmenu) method is called to obtain the menu item or items that the context menu extension will add.</span></span> <span data-ttu-id="8c934-122">Реализация **куериконтекстмену** довольно проста.</span><span class="sxs-lookup"><span data-stu-id="8c934-122">The **QueryContextMenu** implementation is fairly straightforward.</span></span> <span data-ttu-id="8c934-123">Расширение контекстного меню добавляет элементы меню с помощью [**инсертменуитем**](/windows/win32/api/winuser/nf-winuser-insertmenuitema) или аналогичной функции.</span><span class="sxs-lookup"><span data-stu-id="8c934-123">The context menu extension adds its menu items using the [**InsertMenuItem**](/windows/win32/api/winuser/nf-winuser-insertmenuitema) or similar function.</span></span> <span data-ttu-id="8c934-124">Идентификаторы команд меню должны быть больше или равны *идкмдфирст* и должны быть меньше *идкмдласт*.</span><span class="sxs-lookup"><span data-stu-id="8c934-124">The menu command identifiers must be greater than or equal to *idCmdFirst* and must be less than *idCmdLast*.</span></span> <span data-ttu-id="8c934-125">**Куериконтекстмену** должен возвращать наибольший числовой идентификатор, добавленный в меню, и один из них.</span><span class="sxs-lookup"><span data-stu-id="8c934-125">**QueryContextMenu** must return the greatest numeric identifier added to the menu plus one.</span></span> <span data-ttu-id="8c934-126">Лучший способ назначения идентификаторов команд меню — начать с нуля и последовательно работать.</span><span class="sxs-lookup"><span data-stu-id="8c934-126">The best way to assign menu command identifiers is to start at zero and work up in sequence.</span></span> <span data-ttu-id="8c934-127">Если расширение контекстного меню не нуждается ни в одном из пунктов меню, оно должно просто не добавлять элементы в меню и возвращать ноль из **куериконтекстмену**.</span><span class="sxs-lookup"><span data-stu-id="8c934-127">If the context menu extension does not need to any menu items, it should simply not add any items to the menu and return zero from **QueryContextMenu**.</span></span>

<span data-ttu-id="8c934-128">[**IContextMenu:: жеткоммандстринг**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-icontextmenu-getcommandstring) вызывается для получения текстовых данных для пункта меню, например текста справки, отображаемого для данного пункта меню.</span><span class="sxs-lookup"><span data-stu-id="8c934-128">[**IContextMenu::GetCommandString**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-icontextmenu-getcommandstring) is called to retrieve textual data for the menu item, such as help text to be displayed for the menu item.</span></span> <span data-ttu-id="8c934-129">Возможно, что узел контекстного меню будет использовать строки в Юникоде, а расширение использует строки ANSI.</span><span class="sxs-lookup"><span data-stu-id="8c934-129">It is possible that the context menu host will use Unicode strings while the extension uses ANSI strings.</span></span> <span data-ttu-id="8c934-130">По этой причине **глобальные \_ хелптекста**, **GC \_ Хелптекств**, **GC \_ verb** и **GC \_ вербв** должны обрабатываться по отдельности.</span><span class="sxs-lookup"><span data-stu-id="8c934-130">Because of this, the **GCS\_HELPTEXTA**, **GCS\_HELPTEXTW**, **GCS\_VERBA** and **GCS\_VERBW** cases must be handled individually.</span></span> <span data-ttu-id="8c934-131">Реализация этого метода является необязательной.</span><span class="sxs-lookup"><span data-stu-id="8c934-131">Implementation of this method is optional.</span></span>

<span data-ttu-id="8c934-132">[**IContextMenu:: инвокекомманд**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-icontextmenu-invokecommand) вызывается, когда выбран один из пунктов меню, устанавливаемых расширением контекстного меню.</span><span class="sxs-lookup"><span data-stu-id="8c934-132">[**IContextMenu::InvokeCommand**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-icontextmenu-invokecommand) is called when one of the menu items installed by the context menu extension is selected.</span></span> <span data-ttu-id="8c934-133">Контекстное меню выполняет или инициирует нужные действия в ответ на этот метод.</span><span class="sxs-lookup"><span data-stu-id="8c934-133">The context menu performs or initiates the desired actions in response to this method.</span></span>

 

 