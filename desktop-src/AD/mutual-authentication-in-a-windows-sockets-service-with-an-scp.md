---
title: Взаимная проверка подлинности в службе сокетов Windows с SCP
description: В подразделах этого раздела приведены примеры кода, демонстрирующие выполнение взаимной проверки подлинности со службой, которая публикует себя с помощью точки подключения службы (SCP).
ms.assetid: f730464c-95ac-4285-960c-18862f6f7852
ms.tgt_platform: multiple
keywords:
- Взаимная проверка подлинности в службе сокетов Windows с SCP AD
- Active Directory, использование, взаимная проверка подлинности, служба сокетов Windows с SCP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 527715c4a35dc15cd67f5820e6fa891b56452399
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/17/2020
ms.locfileid: "103890408"
---
# <a name="mutual-authentication-in-a-windows-sockets-service-with-scp"></a><span data-ttu-id="9ffad-105">Взаимная проверка подлинности в службе сокетов Windows с SCP</span><span class="sxs-lookup"><span data-stu-id="9ffad-105">Mutual Authentication in a Windows Sockets Service with SCP</span></span>

<span data-ttu-id="9ffad-106">В подразделах этого раздела приведены примеры кода, демонстрирующие выполнение взаимной проверки подлинности со службой, которая публикует себя с помощью точки подключения службы (SCP).</span><span class="sxs-lookup"><span data-stu-id="9ffad-106">The topics in this section include code examples that show how to perform mutual authentication with a service that publishes itself using a service connection point (SCP).</span></span> <span data-ttu-id="9ffad-107">Примеры основаны на службе сокетов Microsoft Windows, которая использует пакет SSPI для выполнения согласования взаимной проверки подлинности между клиентом и службой.</span><span class="sxs-lookup"><span data-stu-id="9ffad-107">The examples are based on a Microsoft Windows Sockets service that uses an SSPI package to handle the mutual authentication negotiation between a client and the service.</span></span> <span data-ttu-id="9ffad-108">Используйте следующие процедуры для реализации взаимной проверки подлинности в этом сценарии.</span><span class="sxs-lookup"><span data-stu-id="9ffad-108">Use the following procedures to implement mutual authentication within this scenario.</span></span>

<span data-ttu-id="9ffad-109">**Регистрация имен участников-служб в каталоге при установке службы**</span><span class="sxs-lookup"><span data-stu-id="9ffad-109">**To register SPNs in a directory when a service is installed**</span></span>

1.  <span data-ttu-id="9ffad-110">Вызовите функцию [**дсжетспн**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsgetspna) , чтобы создать имена субъектов-служб (SPN) для службы.</span><span class="sxs-lookup"><span data-stu-id="9ffad-110">Call the [**DsGetSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsgetspna) function to compose service principal names (SPNs) for the service.</span></span>
2.  <span data-ttu-id="9ffad-111">Вызовите функцию [**дсвритеаккаунтспн**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dswriteaccountspna) , чтобы зарегистрировать имена участников-служб в учетной записи службы или компьютера, в контексте которой будет выполняться служба.</span><span class="sxs-lookup"><span data-stu-id="9ffad-111">Call the [**DsWriteAccountSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dswriteaccountspna) function to register the SPNs on the service account or computer account in whose context the service will run.</span></span> <span data-ttu-id="9ffad-112">Этот шаг должен выполняться администратором домена. исключением является то, что служба, работающая под учетной записью LocalSystem, может зарегистрировать свое имя участника-службы в форме " <service class> / <host> " в учетной записи компьютера узла службы.</span><span class="sxs-lookup"><span data-stu-id="9ffad-112">This step must be performed by a domain administrator; an exception is that a service running under the LocalSystem account can register its SPN in the form "<service class>/<host>" on the computer account of the service host.</span></span>

<span data-ttu-id="9ffad-113">**Проверка конфигурации при запуске службы**</span><span class="sxs-lookup"><span data-stu-id="9ffad-113">**To verify configuration at service startup**</span></span>

-   <span data-ttu-id="9ffad-114">Убедитесь, что соответствующие имена участников-служб зарегистрированы в учетной записи, от имени которой запущена служба.</span><span class="sxs-lookup"><span data-stu-id="9ffad-114">Verify that the appropriate SPNs are registered on the account under which the service is running.</span></span> <span data-ttu-id="9ffad-115">Дополнительные сведения см. в разделе [задачи обслуживания учетной записи входа](logon-account-maintenance-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="9ffad-115">For more information, see [Logon Account Maintenance Tasks](logon-account-maintenance-tasks.md).</span></span>

<span data-ttu-id="9ffad-116">**Проверка подлинности службы при запуске клиента**</span><span class="sxs-lookup"><span data-stu-id="9ffad-116">**To authenticate the service at client startup**</span></span>

1.  <span data-ttu-id="9ffad-117">Получение данных подключения из точки подключения службы службы.</span><span class="sxs-lookup"><span data-stu-id="9ffad-117">Retrieve connection data from the service's service connection point.</span></span>
2.  <span data-ttu-id="9ffad-118">Установите соединение со службой.</span><span class="sxs-lookup"><span data-stu-id="9ffad-118">Establish a connection to the service.</span></span>
3.  <span data-ttu-id="9ffad-119">Вызовите функцию [**дсмакеспн**](/windows/desktop/api/Dsparse/nf-dsparse-dsmakespna) , чтобы составить имя субъекта-службы.</span><span class="sxs-lookup"><span data-stu-id="9ffad-119">Call the [**DsMakeSpn**](/windows/desktop/api/Dsparse/nf-dsparse-dsmakespna) function to compose an SPN for the service.</span></span> <span data-ttu-id="9ffad-120">Составьте имя субъекта-службы из известной строки класса службы и данные, полученные из точки подключения службы.</span><span class="sxs-lookup"><span data-stu-id="9ffad-120">Compose the SPN from the known service class string, and the data retrieved from the service connection point.</span></span> <span data-ttu-id="9ffad-121">Эти данные включают имя узла сервера, на котором запущена служба.</span><span class="sxs-lookup"><span data-stu-id="9ffad-121">This data includes the host name of the server on which the service is running.</span></span> <span data-ttu-id="9ffad-122">Имейте в виду, что имя узла должно быть DNS-именем.</span><span class="sxs-lookup"><span data-stu-id="9ffad-122">Be aware that the host name must be a DNS name.</span></span>
4.  <span data-ttu-id="9ffad-123">Используйте пакет безопасности SSPI для выполнения проверки подлинности:</span><span class="sxs-lookup"><span data-stu-id="9ffad-123">Use an SSPI security package to perform the authentication:</span></span>
    1.  <span data-ttu-id="9ffad-124">Вызовите функцию [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) , чтобы получить учетные данные клиента.</span><span class="sxs-lookup"><span data-stu-id="9ffad-124">Call the [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) function to acquire the client's credentials.</span></span>
    2.  <span data-ttu-id="9ffad-125">Передайте учетные данные клиента и имя участника-службы в функцию [**InitializeSecurityContext**](../SecAuthN/initializesecuritycontext--general.md) , чтобы создать большой двоичный объект безопасности для отправки в службу для проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="9ffad-125">Pass the client credentials and the SPN to the [**InitializeSecurityContext**](../SecAuthN/initializesecuritycontext--general.md) function to generate a security blob to send to the service for authentication.</span></span> <span data-ttu-id="9ffad-126">Установите флаг **\_ \_ взаимной проверки \_ подлинности ISC** , чтобы запросить взаимную проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="9ffad-126">Set the **ISC\_REQ\_MUTUAL\_AUTH** flag to request mutual authentication.</span></span>
    3.  <span data-ttu-id="9ffad-127">Обмен большими двоичными объектами Exchange с помощью службы до завершения проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="9ffad-127">Exchange blobs with the service until the authentication is complete.</span></span>
5.  <span data-ttu-id="9ffad-128">Проверьте возвращенную маску возможностей для флага **\_ \_ взаимной проверки \_ подлинности ISC** , чтобы убедиться, что была выполнена взаимная проверка подлинности.</span><span class="sxs-lookup"><span data-stu-id="9ffad-128">Verify the returned capabilities mask for the **ISC\_REQ\_MUTUAL\_AUTH** flag to verify that mutual authentication was performed.</span></span>
6.  <span data-ttu-id="9ffad-129">Если проверка подлинности прошла успешно, необходимо обмениваться данными с аутентифицированной службой.</span><span class="sxs-lookup"><span data-stu-id="9ffad-129">If the authentication was successful, exchange traffic with the authenticated service.</span></span> <span data-ttu-id="9ffad-130">Используйте цифровое подписывание, чтобы гарантировать, что сообщения между клиентом и службой не были изменены.</span><span class="sxs-lookup"><span data-stu-id="9ffad-130">Use digital signing to ensure that messages between client and service have not been tampered with.</span></span> <span data-ttu-id="9ffad-131">Если требования к производительности не являются серьезными, используйте шифрование.</span><span class="sxs-lookup"><span data-stu-id="9ffad-131">Unless performance requirements are severe, use encryption.</span></span> <span data-ttu-id="9ffad-132">Дополнительные сведения и пример кода, демонстрирующий использование функций [**макесигнатуре**](/windows/desktop/api/sspi/nf-sspi-makesignature), [**VerifySignature**](/windows/desktop/api/sspi/nf-sspi-verifysignature), [**ЕНКРИПТМЕССАЖЕ**](../SecAuthN/encryptmessage--general.md)и [**декриптмессаже**](../SecAuthN/decryptmessage--general.md) в пакете SSPI, см. в разделе [обеспечение целостности связи во время обмена сообщениями](/windows/desktop/SecAuthN/ensuring-communication-integrity-during-message-exchange).</span><span class="sxs-lookup"><span data-stu-id="9ffad-132">For more information and a code example that shows how to use the [**MakeSignature**](/windows/desktop/api/sspi/nf-sspi-makesignature), [**VerifySignature**](/windows/desktop/api/sspi/nf-sspi-verifysignature), [**EncryptMessage**](../SecAuthN/encryptmessage--general.md), and [**DecryptMessage**](../SecAuthN/decryptmessage--general.md) functions in an SSPI package, see [Ensuring Communication Integrity During Message Exchange](/windows/desktop/SecAuthN/ensuring-communication-integrity-during-message-exchange).</span></span>

<span data-ttu-id="9ffad-133">**Проверка подлинности клиента службой при подключении клиента**</span><span class="sxs-lookup"><span data-stu-id="9ffad-133">**To authenticate the client by the service when a client connects**</span></span>

1.  <span data-ttu-id="9ffad-134">Загрузите пакет безопасности SSPI, поддерживающий взаимную проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="9ffad-134">Load an SSPI security package that supports mutual authentication.</span></span>
2.  <span data-ttu-id="9ffad-135">При подключении клиента используйте пакет безопасности для выполнения проверки подлинности:</span><span class="sxs-lookup"><span data-stu-id="9ffad-135">When a client connects, use the security package to perform the authentication:</span></span>
    1.  <span data-ttu-id="9ffad-136">Вызовите функцию [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) , чтобы получить учетные данные службы.</span><span class="sxs-lookup"><span data-stu-id="9ffad-136">Call the [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) function to acquire the service credentials.</span></span>
    2.  <span data-ttu-id="9ffad-137">Передайте учетные данные службы и большой двоичный объект, полученный от клиента, в функцию [**AcceptSecurityContext**](../SecAuthN/acceptsecuritycontext--general.md) , чтобы создать большой двоичный объект безопасности для отправки обратно клиенту.</span><span class="sxs-lookup"><span data-stu-id="9ffad-137">Pass the service credentials and the security blob received from the client to the [**AcceptSecurityContext**](../SecAuthN/acceptsecuritycontext--general.md) function to generate a security blob to send back to the client.</span></span>
    3.  <span data-ttu-id="9ffad-138">Обмен большими двоичными объектами Exchange с клиентом до завершения проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="9ffad-138">Exchange blobs with the client until the authentication is complete.</span></span>
3.  <span data-ttu-id="9ffad-139">Проверьте возвращенную маску возможностей для флага **\_ \_ взаимной проверки \_ подлинности ASC RET** , чтобы убедиться, что была выполнена взаимная проверка подлинности.</span><span class="sxs-lookup"><span data-stu-id="9ffad-139">Check the returned capabilities mask for the **ASC\_RET\_MUTUAL\_AUTH** flag to verify that mutual authentication was performed.</span></span>
4.  <span data-ttu-id="9ffad-140">Если проверка подлинности прошла успешно, то обмен данными с аутентифицированным клиентом проходит.</span><span class="sxs-lookup"><span data-stu-id="9ffad-140">If the authentication was successful, exchange traffic with the authenticated client.</span></span> <span data-ttu-id="9ffad-141">Используйте цифровые подписи и шифрование, если нет проблем с производительностью.</span><span class="sxs-lookup"><span data-stu-id="9ffad-141">Use digital signing and encryption unless performance is an issue.</span></span>

<span data-ttu-id="9ffad-142">Дополнительные сведения и пример кода для этого сценария взаимной проверки подлинности см. в следующих статьях:</span><span class="sxs-lookup"><span data-stu-id="9ffad-142">For more information and a code example for this mutual authentication scenario, see:</span></span>

-   [<span data-ttu-id="9ffad-143">Проверка подлинности клиента службы сокетов Windows на основе SCP</span><span class="sxs-lookup"><span data-stu-id="9ffad-143">How a Client Authenticates an SCP-based Windows Sockets Service</span></span>](how-a-client-authenticates-an-scp-based-windows-sockets-service.md)
-   [<span data-ttu-id="9ffad-144">Составление и регистрация имен участников-служб для службы сокетов Windows на основе SCP</span><span class="sxs-lookup"><span data-stu-id="9ffad-144">Composing and Registering SPNs for an SCP-based Windows Sockets Service</span></span>](composing-and-registering-spns-for-an-scp-based-windows-sockets-service.md)
-   [<span data-ttu-id="9ffad-145">Проверка подлинности клиента службой сокетов Windows</span><span class="sxs-lookup"><span data-stu-id="9ffad-145">How a Windows Sockets Service Authenticates a Client</span></span>](how-a-windows-sockets-service-authenticates-a-client.md)

<span data-ttu-id="9ffad-146">Дополнительные сведения можно найти в разделе</span><span class="sxs-lookup"><span data-stu-id="9ffad-146">For more information, see:</span></span>

-   [<span data-ttu-id="9ffad-147">Публикация с точками подключения службы</span><span class="sxs-lookup"><span data-stu-id="9ffad-147">Publishing with service connection points</span></span>](publishing-with-service-connection-points.md)
-   [<span data-ttu-id="9ffad-148">Документация по SSPI</span><span class="sxs-lookup"><span data-stu-id="9ffad-148">SSPI documentation</span></span>](/windows/desktop/SecAuthN/sspi)
-   [<span data-ttu-id="9ffad-149">Документация по сокетам Windows</span><span class="sxs-lookup"><span data-stu-id="9ffad-149">Windows Sockets documentation</span></span>](/windows/desktop/WinSock/windows-sockets-start-page-2)

 

 