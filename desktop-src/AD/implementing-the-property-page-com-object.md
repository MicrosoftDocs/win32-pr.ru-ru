---
title: Реализация COM-объекта страницы свойств
description: Расширение страницы свойств — это COM-объект, реализованный как внутрипроцессный сервер.
ms.assetid: 77a71086-1949-4828-801e-073ea5a6838b
ms.tgt_platform: multiple
keywords:
- Реализация COM-объекта страницы свойств
- COM-объект страницы свойств, реализация
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 55962002ca059ad6e9c137925d1ba21ba9adc513
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/17/2020
ms.locfileid: "103890419"
---
# <a name="implementing-the-property-page-com-object"></a><span data-ttu-id="c0460-105">Реализация COM-объекта страницы свойств</span><span class="sxs-lookup"><span data-stu-id="c0460-105">Implementing the Property Page COM Object</span></span>

<span data-ttu-id="c0460-106">Расширение страницы свойств — это COM-объект, реализованный как внутрипроцессный сервер.</span><span class="sxs-lookup"><span data-stu-id="c0460-106">A property sheet extension is a COM object implemented as an in-proc server.</span></span> <span data-ttu-id="c0460-107">Расширение страницы свойств должно реализовывать интерфейсы [**ишеллекстинит**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit) и [**ишеллпропшитекст**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellpropsheetext) .</span><span class="sxs-lookup"><span data-stu-id="c0460-107">The property sheet extension must implement the [**IShellExtInit**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellextinit) and [**IShellPropSheetExt**](/windows/win32/api/shobjidl_core/nn-shobjidl_core-ishellpropsheetext) interfaces.</span></span> <span data-ttu-id="c0460-108">При отображении страницы свойств для объекта класса, для которого было зарегистрировано расширение страницы свойств, в спецификаторе отображения класса создается экземпляр расширения страницы свойств.</span><span class="sxs-lookup"><span data-stu-id="c0460-108">A property sheet extension is instantiated when the user displays the property sheet for an object of a class for which the property sheet extension has been registered in the display specifier of the class.</span></span>

-   [<span data-ttu-id="c0460-109">Реализация Ишеллекстинит</span><span class="sxs-lookup"><span data-stu-id="c0460-109">Implementing IShellExtInit</span></span>](#implementing-ishellextinit)
-   [<span data-ttu-id="c0460-110">Реализация Ишеллпропшитекст</span><span class="sxs-lookup"><span data-stu-id="c0460-110">Implementing IShellPropSheetExt</span></span>](#implementing-ishellpropsheetext)
-   [<span data-ttu-id="c0460-111">Передача объекта расширения на страницу свойств</span><span class="sxs-lookup"><span data-stu-id="c0460-111">Passing the Extension Object to the Property Page</span></span>](#passing-the-extension-object-to-the-property-page)
-   [<span data-ttu-id="c0460-112">Работа с объектом уведомления</span><span class="sxs-lookup"><span data-stu-id="c0460-112">Working With the Notification Object</span></span>](#working-with-the-notification-object)
-   [<span data-ttu-id="c0460-113">Прочее</span><span class="sxs-lookup"><span data-stu-id="c0460-113">Miscellaneous</span></span>](#miscellaneous)
-   [<span data-ttu-id="c0460-114">Вкладки свойств с множественным выбором</span><span class="sxs-lookup"><span data-stu-id="c0460-114">Multiple-Selection Property Sheets</span></span>](#multiple-selection-property-sheets)
-   [<span data-ttu-id="c0460-115">Новые с Windows Server 2003</span><span class="sxs-lookup"><span data-stu-id="c0460-115">New with Windows Server 2003</span></span>](#new-with-windows-server-2003)
-   [<span data-ttu-id="c0460-116">См. также</span><span class="sxs-lookup"><span data-stu-id="c0460-116">Related topics</span></span>](#related-topics)

## <a name="implementing-ishellextinit"></a><span data-ttu-id="c0460-117">Реализация Ишеллекстинит</span><span class="sxs-lookup"><span data-stu-id="c0460-117">Implementing IShellExtInit</span></span>

<span data-ttu-id="c0460-118">После создания экземпляра COM-объекта расширения страницы свойств вызывается метод [**ишеллекстинит:: Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) .</span><span class="sxs-lookup"><span data-stu-id="c0460-118">After the property sheet extension COM object is instantiated, the [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) method is called.</span></span> <span data-ttu-id="c0460-119">**Ишеллекстинит:: Initialize** предоставляет расширение страницы свойств с объектом [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) , который содержит данные, относящиеся к объекту каталога, к которому применяется страница свойств.</span><span class="sxs-lookup"><span data-stu-id="c0460-119">**IShellExtInit::Initialize** supplies the property sheet extension with an [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) object that contains data that pertains to the directory object that the property sheet applies.</span></span>

<span data-ttu-id="c0460-120">[**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) содержит данные в формате [**кфстр \_ дсобжектнамес**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format) .</span><span class="sxs-lookup"><span data-stu-id="c0460-120">The [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) contains data in the [**CFSTR\_DSOBJECTNAMES**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format) format.</span></span> <span data-ttu-id="c0460-121">Формат данных **кфстр \_ дсобжектнамес** — это **Хглобал** , содержащий структуру [**дсобжектнамес**](/windows/desktop/api/Dsclient/ns-dsclient-dsobjectnames) .</span><span class="sxs-lookup"><span data-stu-id="c0460-121">The **CFSTR\_DSOBJECTNAMES** data format is an **HGLOBAL** that contains a [**DSOBJECTNAMES**](/windows/desktop/api/Dsclient/ns-dsclient-dsobjectnames) structure.</span></span> <span data-ttu-id="c0460-122">Структура **дсобжектнамес** содержит данные объектов каталога, к которым применяется расширение страницы свойств.</span><span class="sxs-lookup"><span data-stu-id="c0460-122">The **DSOBJECTNAMES** structure contains directory object data that the property sheet extension applies.</span></span>

<span data-ttu-id="c0460-123">[**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) также содержит данные в формате [**\_ \_ \_ \_ параметров отображаемой спецификации кфстр DS**](cfstr-ds-display-spec-options.md) .</span><span class="sxs-lookup"><span data-stu-id="c0460-123">The [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) also contains data in the [**CFSTR\_DS\_DISPLAY\_SPEC\_OPTIONS**](cfstr-ds-display-spec-options.md) format.</span></span> <span data-ttu-id="c0460-124">Формат **данных \_ \_ \_ \_ параметров отображаемой спецификации кфстр DS** — это **хглобал** , содержащий структуру [**дсдисплайспекоптионс**](/windows/desktop/api/Dsclient/ns-dsclient-dsdisplayspecoptions) .</span><span class="sxs-lookup"><span data-stu-id="c0460-124">The **CFSTR\_DS\_DISPLAY\_SPEC\_OPTIONS** data format is an **HGLOBAL** that contains a [**DSDISPLAYSPECOPTIONS**](/windows/desktop/api/Dsclient/ns-dsclient-dsdisplayspecoptions) structure.</span></span> <span data-ttu-id="c0460-125">**Дсдисплайспекоптионс** содержит данные конфигурации для использования расширением.</span><span class="sxs-lookup"><span data-stu-id="c0460-125">The **DSDISPLAYSPECOPTIONS** contains configuration data for use by the extension.</span></span>

<span data-ttu-id="c0460-126">Если в [**ишеллекстинит:: Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize)возвращается любое значение, отличное от **S \_ OK** , страница свойств не отображается.</span><span class="sxs-lookup"><span data-stu-id="c0460-126">If any value other than **S\_OK** is returned from [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize), the property sheet is not displayed.</span></span>

<span data-ttu-id="c0460-127">Параметры *пидлфолдер* и *хкэйпрогид* метода [**ишеллекстинит:: Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) не используются.</span><span class="sxs-lookup"><span data-stu-id="c0460-127">The *pidlFolder* and *hkeyProgID* parameters of the [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) method are not used.</span></span>

<span data-ttu-id="c0460-128">Указатель [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) может быть сохранен расширением путем увеличения счетчика ссылок **IDataObject**.</span><span class="sxs-lookup"><span data-stu-id="c0460-128">The [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) pointer can be saved by the extension by incrementing the reference count of the **IDataObject**.</span></span> <span data-ttu-id="c0460-129">Этот интерфейс должен быть освобожден, если он больше не требуется.</span><span class="sxs-lookup"><span data-stu-id="c0460-129">This interface must be released when no longer required.</span></span>

## <a name="implementing-ishellpropsheetext"></a><span data-ttu-id="c0460-130">Реализация Ишеллпропшитекст</span><span class="sxs-lookup"><span data-stu-id="c0460-130">Implementing IShellPropSheetExt</span></span>

<span data-ttu-id="c0460-131">После возврата [**ишеллекстинит:: Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) вызывается метод [**Ишеллпропшитекст:: аддпажес**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages) .</span><span class="sxs-lookup"><span data-stu-id="c0460-131">After [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) returns, the [**IShellPropSheetExt::AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages) method is called.</span></span> <span data-ttu-id="c0460-132">Расширение страницы свойств должно добавить страницу или страницы во время этого метода.</span><span class="sxs-lookup"><span data-stu-id="c0460-132">The property sheet extension must add the page or pages during this method.</span></span> <span data-ttu-id="c0460-133">Страница свойств создается путем заполнения структуры [**пропшитпаже**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2) и последующей передачи этой структуры в функцию [**креатепропертишитпаже**](/windows/win32/api/prsht/nf-prsht-createpropertysheetpagea) .</span><span class="sxs-lookup"><span data-stu-id="c0460-133">A property page is created by filling a [**PROPSHEETPAGE**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2) structure and then passing this structure to the [**CreatePropertySheetPage**](/windows/win32/api/prsht/nf-prsht-createpropertysheetpagea) function.</span></span> <span data-ttu-id="c0460-134">Затем страница свойств добавляется на вкладку свойств путем вызова функции обратного вызова, передаваемой в **ишеллпропшитекст:: аддпажес** в параметре *лпфнаддпаже* .</span><span class="sxs-lookup"><span data-stu-id="c0460-134">The property page is then added to the property sheet by calling the callback function passed to **IShellPropSheetExt::AddPages** in the *lpfnAddPage* parameter.</span></span>

<span data-ttu-id="c0460-135">Если в [**ишеллпропшитекст:: аддпажес**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages)возвращается любое значение, отличное от **S \_ OK** , страница свойств не отображается.</span><span class="sxs-lookup"><span data-stu-id="c0460-135">If any value other than **S\_OK** is returned from [**IShellPropSheetExt::AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages), the property sheet is not displayed.</span></span>

<span data-ttu-id="c0460-136">Если расширение таблицы свойств не требуется для добавления каких-либо страниц на страницу свойств, оно не должно вызывать функцию обратного вызова, переданную в [**ишеллпропшитекст:: аддпажес**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages) в параметре *лпфнаддпаже* .</span><span class="sxs-lookup"><span data-stu-id="c0460-136">If the property sheet extension is not required to add any pages to the property sheet, it should not call the callback function passed to [**IShellPropSheetExt::AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages) in the *lpfnAddPage* parameter.</span></span>

<span data-ttu-id="c0460-137">Метод [**ишеллпропшитекст:: реплацепаже**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-replacepage) не используется.</span><span class="sxs-lookup"><span data-stu-id="c0460-137">The [**IShellPropSheetExt::ReplacePage**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-replacepage) method is not used.</span></span>

## <a name="passing-the-extension-object-to-the-property-page"></a><span data-ttu-id="c0460-138">Передача объекта расширения на страницу свойств</span><span class="sxs-lookup"><span data-stu-id="c0460-138">Passing the Extension Object to the Property Page</span></span>

<span data-ttu-id="c0460-139">Объект расширения страницы свойств независим от страницы свойств.</span><span class="sxs-lookup"><span data-stu-id="c0460-139">The property sheet extension object is independent from the property page.</span></span> <span data-ttu-id="c0460-140">Во многих случаях желательно иметь возможность использовать объект расширения или какой-либо другой объект на странице свойств.</span><span class="sxs-lookup"><span data-stu-id="c0460-140">In many cases, it is desirable to be able to use the extension object, or some other object, from the property page.</span></span> <span data-ttu-id="c0460-141">Для этого задайте для члена **lParam** структуры [**пропшитпаже**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2) указатель на объект.</span><span class="sxs-lookup"><span data-stu-id="c0460-141">To do this, set the **lParam** member of [**PROPSHEETPAGE**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2) structure to the object pointer.</span></span> <span data-ttu-id="c0460-142">После этого страница свойств может получить это значение при обработке сообщения [**WM \_ инитдиалог**](../dlgbox/wm-initdialog.md) .</span><span class="sxs-lookup"><span data-stu-id="c0460-142">The property page can then retrieve this value when it processes the [**WM\_INITDIALOG**](../dlgbox/wm-initdialog.md) message.</span></span> <span data-ttu-id="c0460-143">Для страницы свойств параметр *lParam* сообщения **WM \_ инитдиалог** является указателем на структуру **пропшитпаже** .</span><span class="sxs-lookup"><span data-stu-id="c0460-143">For a property page, the *lParam* parameter of the **WM\_INITDIALOG** message is a pointer to the **PROPSHEETPAGE** structure.</span></span> <span data-ttu-id="c0460-144">Получите указатель объекта путем приведения *lParam* сообщения **WM \_ Инитдиалог** к указателю **Пропшитпаже** , а затем извлечения члена **lParam** структуры **пропшитпаже** .</span><span class="sxs-lookup"><span data-stu-id="c0460-144">Retrieve the object pointer by casting the *lParam* of the **WM\_INITDIALOG** message to a **PROPSHEETPAGE** pointer and then retrieving the **lParam** member of the **PROPSHEETPAGE** structure.</span></span>

<span data-ttu-id="c0460-145">В следующем примере кода C++ показано, как передать объект на страницу свойств.</span><span class="sxs-lookup"><span data-stu-id="c0460-145">The following C++ code example shows how to pass an object to a property page.</span></span>


```C++
case WM_INITDIALOG:
    {
        LPPROPSHEETPAGE pPage = (LPPROPSHEETPAGE)lParam;

        if(NULL != pPage)
        {
            CPropSheetExt *pPropSheetExt;
            pPropSheetExt = (CPropSheetExt*)pPage->lParam;

            if(pPropSheetExt)
            {
                return pPropSheetExt>OnInitDialog(wParam, lParam);
            }
        }
    }
    break;
```



<span data-ttu-id="c0460-146">Имейте в виду, что после вызова [**ишеллпропшитекст:: аддпажес**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages) страница свойств освободит объект расширения страницы свойств и никогда не будет использовать его повторно.</span><span class="sxs-lookup"><span data-stu-id="c0460-146">Be aware that after [**IShellPropSheetExt::AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages) is called, the property sheet will release the property sheet extension object and never use it again.</span></span> <span data-ttu-id="c0460-147">Это означает, что объект расширения будет удален до отображения страницы свойств.</span><span class="sxs-lookup"><span data-stu-id="c0460-147">This means that the extension object would be deleted before the property page is displayed.</span></span> <span data-ttu-id="c0460-148">Когда страница пытается получить доступ к указателю объекта, память будет освобождена и указатель будет недопустимым.</span><span class="sxs-lookup"><span data-stu-id="c0460-148">When the page attempts to access the object pointer, the memory will have been freed and the pointer will not be valid.</span></span> <span data-ttu-id="c0460-149">Чтобы исправить это, увеличьте счетчик ссылок для объекта расширения при добавлении страницы и отпустите объект при уничтожении диалогового окна страницы свойств.</span><span class="sxs-lookup"><span data-stu-id="c0460-149">To correct this, increment the reference count for the extension object when the page is added and then release the object when the property page dialog is destroyed.</span></span> <span data-ttu-id="c0460-150">Это создает еще одну ошибку, поскольку диалоговое окно страницы свойств не создается до тех пор, пока страница не будет отображена в первый раз.</span><span class="sxs-lookup"><span data-stu-id="c0460-150">This creates another issue because the property page dialog box is not created until the first time the page is displayed.</span></span> <span data-ttu-id="c0460-151">Если пользователь никогда не выбирает страницу расширения, страница никогда не создается и уничтожается.</span><span class="sxs-lookup"><span data-stu-id="c0460-151">If the user never selects the extension page, the page never gets created and destroyed.</span></span> <span data-ttu-id="c0460-152">В результате объект расширения никогда не будет освобожден, поэтому происходит утечка памяти.</span><span class="sxs-lookup"><span data-stu-id="c0460-152">This results in the extension object never getting released, so a memory leak occurs.</span></span> <span data-ttu-id="c0460-153">Чтобы избежать этого, реализуйте функцию обратного вызова страницы свойств.</span><span class="sxs-lookup"><span data-stu-id="c0460-153">To avoid this, implement a property page callback function.</span></span> <span data-ttu-id="c0460-154">Для этого добавьте флаг **PSP \_ усекаллбакк** в элемент **dwFlags** структуры [**Пропшитпаже**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2) и присвойте элементу **пфнкаллбакк** структуры **пропшитпаже** адрес реализованной функции [**пропшитпажепрок**](/windows/win32/api/prsht/nc-prsht-lpfnpspcallbacka) .</span><span class="sxs-lookup"><span data-stu-id="c0460-154">To do this, add the **PSP\_USECALLBACK** flag to the **dwFlags** member of the [**PROPSHEETPAGE**](/windows/win32/api/prsht/ns-prsht-propsheetpagea_v2) structure and set the **pfnCallback** member of the **PROPSHEETPAGE** structure to the address of the [**PropSheetPageProc**](/windows/win32/api/prsht/nc-prsht-lpfnpspcallbacka) function implemented.</span></span> <span data-ttu-id="c0460-155">Когда функция **пропшитпажепрок** получает уведомление о **\_ выпуске пспкб** , параметр *ППСП* объекта **пропшитпажепрок** содержит указатель на структуру **пропшитпаже** .</span><span class="sxs-lookup"><span data-stu-id="c0460-155">When the **PropSheetPageProc** function receives the **PSPCB\_RELEASE** notification, the *ppsp* parameter of the **PropSheetPageProc** contains a pointer to the **PROPSHEETPAGE** structure.</span></span> <span data-ttu-id="c0460-156">Член **lParam** структуры **пропшитпаже** содержит указатель расширения, который можно использовать для освобождения объекта.</span><span class="sxs-lookup"><span data-stu-id="c0460-156">The **lParam** member of the **PROPSHEETPAGE** structure contains the extension pointer which can be used to release the object.</span></span>

<span data-ttu-id="c0460-157">В следующем примере кода C++ показано, как освободить объект расширения.</span><span class="sxs-lookup"><span data-stu-id="c0460-157">The following C++ code example shows how to release an extension object.</span></span>


```C++
UINT CALLBACK CPropSheetExt::PageCallbackProc(  HWND hWnd,
                                                UINT uMsg,
                                                LPPROPSHEETPAGE ppsp)
{
    switch(uMsg)
    {
    case PSPCB_CREATE:
        // Must return TRUE to enable the page to be created.
        return TRUE;

    case PSPCB_RELEASE:
        {
            /*
            Release the object. This is called even if the page dialog box was 
            never actually created.
            */
            CPropSheetExt *pPropSheetExt = (CPropSheetExt*)ppsp->lParam;

            if(pPropSheetExt)
            {
                pPropSheetExt->Release();
            }
        }
        break;
    }

    return FALSE;
}
```



## <a name="working-with-the-notification-object"></a><span data-ttu-id="c0460-158">Работа с объектом уведомления</span><span class="sxs-lookup"><span data-stu-id="c0460-158">Working With the Notification Object</span></span>

<span data-ttu-id="c0460-159">Так как страницы расширения таблицы свойств отображаются на странице свойств, созданной компонентом, неизвестным для расширения, необходимо использовать "Manager" для обработки обмена данными между страницами расширения и страницей свойств.</span><span class="sxs-lookup"><span data-stu-id="c0460-159">Because the property sheet extension pages are displayed within a property sheet created by a component unknown to the extension, it is necessary to use a "manager" to handle the data transfer between the extension pages and the property sheet.</span></span> <span data-ttu-id="c0460-160">Этот диспетчер называется объектом уведомления.</span><span class="sxs-lookup"><span data-stu-id="c0460-160">This "manager" is called the notification object.</span></span> <span data-ttu-id="c0460-161">Объект уведомления функционирует как ведущий между отдельными страницами и страницей свойств.</span><span class="sxs-lookup"><span data-stu-id="c0460-161">The notification object operates as a moderator between the individual pages and the property sheet.</span></span>

<span data-ttu-id="c0460-162">Когда инициализируется объект расширения страницы свойств, расширение должно создать объект уведомления путем вызова [**адспропкреатенотифйобж**](/windows/desktop/api/Adsprop/nf-adsprop-adspropcreatenotifyobj)и передачи [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) , полученного из [**ишеллекстинит:: Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) , и имени объекта каталога.</span><span class="sxs-lookup"><span data-stu-id="c0460-162">When the property sheet extension object is initialized, the extension must create a notification object by calling [**ADsPropCreateNotifyObj**](/windows/desktop/api/Adsprop/nf-adsprop-adspropcreatenotifyobj), passing the [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) obtained from [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) and the directory object name.</span></span> <span data-ttu-id="c0460-163">Нет необходимости увеличивать значение счетчика ссылок интерфейса **IDataObject** , поскольку это будет сделано объектом уведомления, созданным функцией **адспропкреатенотифйобж** .</span><span class="sxs-lookup"><span data-stu-id="c0460-163">It is not necessary to increment the reference count of the **IDataObject** interface, because the notification object created by **ADsPropCreateNotifyObj** function will do this.</span></span> <span data-ttu-id="c0460-164">Обработчик объекта уведомления, предоставленный **адспропкреатенотифйобж** , должен быть сохранен для последующего использования.</span><span class="sxs-lookup"><span data-stu-id="c0460-164">The notification object handle provided by **ADsPropCreateNotifyObj** should be saved for later use.</span></span> <span data-ttu-id="c0460-165">**Адспропкреатенотифйобж** можно вызывать во время **Ишеллекстинит:: Initialize** или [**ишеллпропшитекст:: аддпажес**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages).</span><span class="sxs-lookup"><span data-stu-id="c0460-165">**ADsPropCreateNotifyObj** can be either called during **IShellExtInit::Initialize** or [**IShellPropSheetExt::AddPages**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellpropsheetext-addpages).</span></span> <span data-ttu-id="c0460-166">Когда расширение страницы свойств завершит работу, оно должно отправить в объект уведомления [**сообщение \_ \_ о \_ выходе адспроп**](wm-adsprop-notify-exit.md) .</span><span class="sxs-lookup"><span data-stu-id="c0460-166">When the property sheet extension is shut down, it must send a [**WM\_ADSPROP\_NOTIFY\_EXIT**](wm-adsprop-notify-exit.md) message to the notification object.</span></span> <span data-ttu-id="c0460-167">Это приводит к уничтожению объекта уведомления.</span><span class="sxs-lookup"><span data-stu-id="c0460-167">This causes the notification object to destroy itself.</span></span> <span data-ttu-id="c0460-168">Это лучше выполнить, когда функция [**пропшитпажепрок**](/windows/win32/api/prsht/nc-prsht-lpfnpspcallbacka) получает уведомление о **\_ выпуске пспкб** .</span><span class="sxs-lookup"><span data-stu-id="c0460-168">This is best done when the [**PropSheetPageProc**](/windows/win32/api/prsht/nc-prsht-lpfnpspcallbacka) function receives the **PSPCB\_RELEASE** notification.</span></span>

<span data-ttu-id="c0460-169">Расширение страницы свойств может получать данные в дополнение к, которое предоставляется в формате буфера обмена [**кфстр \_ дсобжектнамес**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format) путем вызова [**адспропжетинитинфо**](/windows/desktop/api/Adsprop/nf-adsprop-adspropgetinitinfo).</span><span class="sxs-lookup"><span data-stu-id="c0460-169">The property sheet extension can obtain data in addition to that provided by the [**CFSTR\_DSOBJECTNAMES**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format) clipboard format by calling [**ADsPropGetInitInfo**](/windows/desktop/api/Adsprop/nf-adsprop-adspropgetinitinfo).</span></span> <span data-ttu-id="c0460-170">Одним из преимуществ использования **адспропжетинитинфо** является то, что он предоставляет объект [**идиректорйобжект**](/windows/desktop/api/iads/nn-iads-idirectoryobject) , используемый для программной работы с объектом каталога.</span><span class="sxs-lookup"><span data-stu-id="c0460-170">One of the advantages of using **ADsPropGetInitInfo** is that it provides an [**IDirectoryObject**](/windows/desktop/api/iads/nn-iads-idirectoryobject) object used to programmatically work with the directory object.</span></span>

> [!Note]  
> <span data-ttu-id="c0460-171">В отличие от большинства методов и функций COM, [**адспропжетинитинфо**](/windows/desktop/api/Adsprop/nf-adsprop-adspropgetinitinfo) не увеличивает счетчик ссылок для объекта [**идиректорйобжект**](/windows/desktop/api/iads/nn-iads-idirectoryobject) .</span><span class="sxs-lookup"><span data-stu-id="c0460-171">Unlike most COM methods and functions, [**ADsPropGetInitInfo**](/windows/desktop/api/Adsprop/nf-adsprop-adspropgetinitinfo) does not increment the reference count for the [**IDirectoryObject**](/windows/desktop/api/iads/nn-iads-idirectoryobject) object.</span></span> <span data-ttu-id="c0460-172">**Идиректорйобжект** не должно освобождаться, пока число ссылок не будет увеличиваться вручную.</span><span class="sxs-lookup"><span data-stu-id="c0460-172">The **IDirectoryObject** must not be released unless the reference count is manually incremented first.</span></span>

 

<span data-ttu-id="c0460-173">При первом создании страницы свойств расширение должно зарегистрировать страницу с объектом уведомления, вызвав [**адспропсесвнд**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsethwnd) с маркером окна страницы.</span><span class="sxs-lookup"><span data-stu-id="c0460-173">When the property page is first created, the extension should register the page with the notification object by calling [**ADsPropSetHwnd**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsethwnd) with the window handle of the page.</span></span>

<span data-ttu-id="c0460-174">[**Адспропчеккифвритабле**](/windows/desktop/api/Adsprop/nf-adsprop-adspropcheckifwritable) — это служебная функция, которую расширение страницы свойств может использовать для определения возможности написания свойства.</span><span class="sxs-lookup"><span data-stu-id="c0460-174">[**ADsPropCheckIfWritable**](/windows/desktop/api/Adsprop/nf-adsprop-adspropcheckifwritable) is a utility function that the property sheet extension can use to determine if a property can be written.</span></span>

## <a name="miscellaneous"></a><span data-ttu-id="c0460-175">Разное</span><span class="sxs-lookup"><span data-stu-id="c0460-175">Miscellaneous</span></span>

<span data-ttu-id="c0460-176">Маркер страницы свойств передается в процедуру диалогового окна страницы.</span><span class="sxs-lookup"><span data-stu-id="c0460-176">The handle of the property page is passed to the page dialog box procedure.</span></span> <span data-ttu-id="c0460-177">Страница свойств является прямым родителем страницы свойств, поэтому ее можно получить, вызвав функцию- [**родитель**](/windows/win32/api/winuser/nf-winuser-getparent) с помощью маркера страницы свойств.</span><span class="sxs-lookup"><span data-stu-id="c0460-177">The property sheet is the direct parent of the property page, so the handle of the property sheet can be obtained by calling the [**GetParent**](/windows/win32/api/winuser/nf-winuser-getparent) function with the property page handle.</span></span>

<span data-ttu-id="c0460-178">При изменении содержимого страницы расширения расширение должно использовать макрос [**пропшит \_ Changed**](/windows/win32/api/prsht/nf-prsht-propsheet_changed) для уведомления страницы свойств об изменениях.</span><span class="sxs-lookup"><span data-stu-id="c0460-178">When the contents of the extension page changes, the extension should use the [**PropSheet\_Changed**](/windows/win32/api/prsht/nf-prsht-propsheet_changed) macro to notify the property sheet of changes.</span></span> <span data-ttu-id="c0460-179">После этого на странице свойств будет включена кнопка Применить.</span><span class="sxs-lookup"><span data-stu-id="c0460-179">The property sheet will then enable the Apply button.</span></span>

## <a name="multiple-selection-property-sheets"></a><span data-ttu-id="c0460-180">Страницы свойств Multiple-Selection</span><span class="sxs-lookup"><span data-stu-id="c0460-180">Multiple-Selection Property Sheets</span></span>

<span data-ttu-id="c0460-181">В операционных системах Windows Server 2003 и более поздних версий оснастки администрирования консоли управления Active Directory поддерживают расширения для нескольких объектов каталога.</span><span class="sxs-lookup"><span data-stu-id="c0460-181">With Windows Server 2003 and later operating systems, the Active Directory administrative MMC snap-ins support property sheet extensions for multiple directory objects.</span></span> <span data-ttu-id="c0460-182">Эти страницы свойств отображаются, когда свойства просматриваются более чем по одному элементу за раз.</span><span class="sxs-lookup"><span data-stu-id="c0460-182">These property sheets are displayed when the properties are viewed for more than one item at a time.</span></span> <span data-ttu-id="c0460-183">Основное различие между расширением таблицы свойств с одним выбором и расширением таблицы свойств с множественным выбором заключается в том, что структура [**дсобжектнамес**](/windows/desktop/api/Dsclient/ns-dsclient-dsobjectnames) , предоставляемая форматом буфера обмена [**Кфстр \_ дсобжектнамес**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format) в [**ишеллекстинит:: Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) , будет содержать более одной структуры [**дсобжект**](/windows/desktop/api/Dsclient/ns-dsclient-dsobject) .</span><span class="sxs-lookup"><span data-stu-id="c0460-183">The primary difference between a single-selection property sheet extension and a multiple-selection property sheet extension is that the [**DSOBJECTNAMES**](/windows/desktop/api/Dsclient/ns-dsclient-dsobjectnames) structure supplied by the [**CFSTR\_DSOBJECTNAMES**](/previous-versions/windows/desktop/mmc/cfstr-dsobjectnames-clipboard-format) clipboard format in [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize) will contain more than one [**DSOBJECT**](/windows/desktop/api/Dsclient/ns-dsclient-dsobject) structure.</span></span>

<span data-ttu-id="c0460-184">При создании объекта уведомления расширение таблицы свойств с множественным выбором должно передавать уникальное имя, предоставленное оснасткой, а не имя, созданное расширением.</span><span class="sxs-lookup"><span data-stu-id="c0460-184">When the notification object is created, a multi-selection property sheet extension must pass a unique name that is provided by the snap-in rather than a name created by the extension.</span></span> <span data-ttu-id="c0460-185">Чтобы получить уникальное имя, запросите формат буфера обмена [**кфстр \_ DS \_ мултиселектпроппаже**](cfstr-ds-multiselectproppage.md) из [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) , полученного из [**ишеллекстинит:: Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize).</span><span class="sxs-lookup"><span data-stu-id="c0460-185">To obtain the unique name, request the [**CFSTR\_DS\_MULTISELECTPROPPAGE**](cfstr-ds-multiselectproppage.md) clipboard format from the [**IDataObject**](/windows/win32/api/objidl/nn-objidl-idataobject) obtained from [**IShellExtInit::Initialize**](/windows/win32/api/shobjidl_core/nf-shobjidl_core-ishellextinit-initialize).</span></span> <span data-ttu-id="c0460-186">Эти данные являются **хглобал** , содержащим строку в Юникоде, завершающуюся нулем, которая является уникальным именем.</span><span class="sxs-lookup"><span data-stu-id="c0460-186">This data is an **HGLOBAL** that contains a null-terminated Unicode string that is the unique name.</span></span> <span data-ttu-id="c0460-187">Это уникальное имя затем передается функции [**адспропкреатенотифйобж**](/windows/desktop/api/Adsprop/nf-adsprop-adspropcreatenotifyobj) для создания объекта уведомления.</span><span class="sxs-lookup"><span data-stu-id="c0460-187">This unique name is then passed to the [**ADsPropCreateNotifyObj**](/windows/desktop/api/Adsprop/nf-adsprop-adspropcreatenotifyobj) function to create the notification object.</span></span> <span data-ttu-id="c0460-188">Пример функции **креатеадснотификатионобжект** в [примере кода для реализации com-объекта страницы свойств](example-code-for-implementation-of-the-property-sheet-com-object.md) демонстрирует, как это сделать правильно, а также обеспечить совместимость с более ранними версиями оснастки, которые не поддерживают вкладки свойств с множественным выбором.</span><span class="sxs-lookup"><span data-stu-id="c0460-188">The **CreateADsNotificationObject** example function in [Example Code for Implementation of the Property Sheet COM Object](example-code-for-implementation-of-the-property-sheet-com-object.md) demonstrates how to do this correctly, as well as being compatible with earlier versions of the snap-in that do not support multi-selection property sheets.</span></span>

<span data-ttu-id="c0460-189">Для страниц свойств с множественным выбором система привязывается только к первому объекту в массиве [**дсобжект**](/windows/desktop/api/Dsclient/ns-dsclient-dsobject) .</span><span class="sxs-lookup"><span data-stu-id="c0460-189">For multiple-selection property sheets, the system only binds to the first object in the [**DSOBJECT**](/windows/desktop/api/Dsclient/ns-dsclient-dsobject) array.</span></span> <span data-ttu-id="c0460-190">Из-за этого [**адспропжетинитинфо**](/windows/desktop/api/Adsprop/nf-adsprop-adspropgetinitinfo) предоставляет только атрибуты [**идиректорйобжект**](/windows/desktop/api/iads/nn-iads-idirectoryobject) и Write для первого объекта в массиве.</span><span class="sxs-lookup"><span data-stu-id="c0460-190">Because of this, [**ADsPropGetInitInfo**](/windows/desktop/api/Adsprop/nf-adsprop-adspropgetinitinfo) only supplies the [**IDirectoryObject**](/windows/desktop/api/iads/nn-iads-idirectoryobject) and write-able attributes for the first object in the array.</span></span> <span data-ttu-id="c0460-191">Другие объекты в массиве не привязаны к.</span><span class="sxs-lookup"><span data-stu-id="c0460-191">The other objects in the array are not bound to.</span></span>

<span data-ttu-id="c0460-192">Расширение вкладки свойств с множественным выбором регистрируется в атрибуте [**админмултиселектпропертипажес**](/windows/desktop/ADSchema/a-adminmultiselectpropertypages) .</span><span class="sxs-lookup"><span data-stu-id="c0460-192">A multiple-selection property sheet extension is registered under the [**adminMultiselectPropertyPages**](/windows/desktop/ADSchema/a-adminmultiselectpropertypages) attribute.</span></span>

## <a name="new-with-windows-server-2003"></a><span data-ttu-id="c0460-193">Новые с Windows Server 2003</span><span class="sxs-lookup"><span data-stu-id="c0460-193">New with Windows Server 2003</span></span>

<span data-ttu-id="c0460-194">Ниже перечислены новые возможности Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="c0460-194">The following features are new with Windows Server 2003.</span></span>

<span data-ttu-id="c0460-195">Если на странице свойств обнаружена ошибка, [**адспропсендеррормессаже**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsenderrormessage) можно вызвать с соответствующими данными об ошибке.</span><span class="sxs-lookup"><span data-stu-id="c0460-195">If the property page encounters an error, [**ADsPropSendErrorMessage**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsenderrormessage) can be called with the appropriate error data.</span></span> <span data-ttu-id="c0460-196">**Адспропсендеррормессаже** будет хранить все сообщения об ошибках в очереди.</span><span class="sxs-lookup"><span data-stu-id="c0460-196">**ADsPropSendErrorMessage** will store all error messages in a queue.</span></span> <span data-ttu-id="c0460-197">Эти сообщения будут отображаться при следующем вызове [**адспропшоверрордиалог**](/windows/desktop/api/Adsprop/nf-adsprop-adspropshowerrordialog) .</span><span class="sxs-lookup"><span data-stu-id="c0460-197">These messages will be displayed the next time [**ADsPropShowErrorDialog**](/windows/desktop/api/Adsprop/nf-adsprop-adspropshowerrordialog) is called.</span></span> <span data-ttu-id="c0460-198">Когда **адспропшоверрордиалог** возвращает, сообщения в очереди удаляются.</span><span class="sxs-lookup"><span data-stu-id="c0460-198">When **ADsPropShowErrorDialog** returns, the queued messages are deleted.</span></span>

<span data-ttu-id="c0460-199">В Windows Server 2003 введена функция [**адспропсесвндвиститле**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsethwndwithtitle) .</span><span class="sxs-lookup"><span data-stu-id="c0460-199">Windows Server 2003 introduces the [**ADsPropSetHwndWithTitle**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsethwndwithtitle) function.</span></span> <span data-ttu-id="c0460-200">Эта функция похожа на [**адспропсесвнд**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsethwnd), но включает заголовок страницы.</span><span class="sxs-lookup"><span data-stu-id="c0460-200">This function is similar to [**ADsPropSetHwnd**](/windows/desktop/api/Adsprop/nf-adsprop-adspropsethwnd), but includes the page title.</span></span> <span data-ttu-id="c0460-201">Это позволяет диалоговое окно ошибки, отображаемое [**адспропшоверрордиалог**](/windows/desktop/api/Adsprop/nf-adsprop-adspropshowerrordialog) , позволяет пользователю получить более полезные данные.</span><span class="sxs-lookup"><span data-stu-id="c0460-201">This enables the error dialog box displayed by [**ADsPropShowErrorDialog**](/windows/desktop/api/Adsprop/nf-adsprop-adspropshowerrordialog) to provide more useful data to the user.</span></span> <span data-ttu-id="c0460-202">Если расширение страницы свойств использует функцию **адспропшоверрордиалог** , то расширение должно использовать **адспропсесвндвиститле** , а не **адспропсесвнд**.</span><span class="sxs-lookup"><span data-stu-id="c0460-202">If the property sheet extension uses the **ADsPropShowErrorDialog** function, the extension should use **ADsPropSetHwndWithTitle** rather than **ADsPropSetHwnd**.</span></span>

## <a name="related-topics"></a><span data-ttu-id="c0460-203">См. также</span><span class="sxs-lookup"><span data-stu-id="c0460-203">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="c0460-204">Пример кода для реализации COM-объекта страницы свойств</span><span class="sxs-lookup"><span data-stu-id="c0460-204">Example Code for Implementation of the Property Sheet COM Object</span></span>](example-code-for-implementation-of-the-property-sheet-com-object.md)
</dt> </dl>

 

 