---
title: Реализация Имедиаобжект Аллокатестреамингресаурцес
description: Реализация Имедиаобжект Аллокатестреамингресаурцес
ms.assetid: 630550fe-2cca-4bfa-a824-a355f7fc5e02
keywords:
- Подключаемые модули проигрывателя Windows Media, эхо-образцы ресурсов потоковой передачи
- подключаемые модули, эхо-образцы ресурсов
- подключаемые модули обработки цифровых сигналов, образцы эхо-потоков
- Подключаемые модули DSP, потоковая передача образцов ресурсов
- Пример подключаемого модуля "Echo DSP", потоковая передача ресурсов
- Пример подключаемого модуля Echo DSP, буфер задержки
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5f1e347e35eaabbcbcc00a586e4cba0d8ad31cc6
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "104411079"
---
# <a name="implementing-imediaobjectallocatestreamingresources"></a>Реализация Имедиаобжект:: Аллокатестреамингресаурцес

В образце Echo метод **аллокатестреамингресаурцес** создает буфер задержки. Для этого выполняются следующие действия.

1.  Вычисление размера буфера, соответствующего указанному времени задержки для заданного типа носителя.
2.  Либо выделяйте новую память, либо Перераспределите размер буфера, если он уже существует.
3.  Вызов метода, который заполняет буфер значениями, представляющими тишину.

Значение тишины различается в зависимости от глубины бита. Для 8-разрядного звукового сигнала тишина представлено шестнадцатеричным значением 80; для 16-разрядного звукового сигнала тишина представляется нулем.

## <a name="calculating-the-delay-buffer-size"></a>Вычисление размера буфера задержки

Чтобы вычислить требуемый размер буфера задержки, сначала необходимо получить структуру **вавеформатекс** , содержащую сведения о звуковых данных. В следующем примере извлекается указатель на эту структуру из входной структуры **\_ \_ типа мультимедиа DMO** :


```
// Get a pointer to the WAVEFORMATEX structure.
WAVEFORMATEX *pWave = ( WAVEFORMATEX * ) m_mtInput.pbFormat;
if (NULL == pWave)
{
    return E_FAIL;
}
```



После сохранения указателя на соответствующую структуру **вавеформатекс** можно проверить ее элементы и использовать их для вычисления требуемого размера буфера. Это показано в следующем примере кода:


```
// Get the size of the buffer required.
m_cbDelayBuffer = (m_dwDelayTime * pWave->nSamplesPerSec * pWave->nBlockAlign) / 1000;
```



Этот алгоритм вычисляет размер буфера, умножая время задержки (в миллисекундах) на число выборок в миллисекунду, затем умножая результат на число каналов, а затем умножая результат на число байтов на выборку. Количество каналов и количество байт на выборку не очевидны. они кодируются в члене Нблоккалигн. Деление на 1000 сокращает значение Нсамплесперсек до выборки в миллисекундах; миллисекунда является требуемой единицей, так как время задержки выражается в миллисекундах.

## <a name="allocating-the-delay-buffer-memory"></a>Выделение памяти буфера задержки

После вычисления требований к памяти можно выделить буфер. Буфер может потребоваться удалить, если он существует, например, когда пользователь вызывает страницу свойств для изменения значения времени задержки. Следующий код демонстрирует выделение буфера задержки:


```
// Test whether a buffer exists.
if (m_pbDelayBuffer)
{
    // A buffer already exists.
    // Delete the delay buffer.
    delete m_pbDelayBuffer;
    m_pbDelayBuffer = NULL;
}

// Allocate the buffer.
m_pbDelayBuffer = new BYTE[m_cbDelayBuffer];

if (!m_pbDelayBuffer)
    return E_OUTOFMEMORY;
```



Если буфер успешно выделен, переместите перемещаемый указатель на заголовок буфера, как показано в следующем примере:


```
// Move the echo pointer to the head of the delay buffer.
m_pbDelayPointer = m_pbDelayBuffer;
```



## <a name="filling-the-delay-buffer-with-silence"></a>Заполнение буфера задержки с помощью тишины

Удобно написать метод для заполнения буфера задержки значениями, представляющими тишину. Метод должен получить указатель на допустимую структуру ВАВЕФОРМАТЕКС, а затем проверить элемент Вбитсперсампле, чтобы определить, является ли звук 8-разрядным или более высоким. В следующем примере буфер задержки заполняется правильным значением тишины:


```
void CEcho::FillBufferWithSilence(WAVEFORMATEX *pWfex)
{
    if (8 == pWfex->wBitsPerSample)
    {
    ::FillMemory(m_pbDelayBuffer, m_cbDelayBuffer, 0x80);
    }
    else
    ::ZeroMemory(m_pbDelayBuffer, m_cbDelayBuffer);
}
```



Не забудьте добавить прямую декларацию для функции в файл заголовка Echo. h в частном разделе:


```
void FillBufferWithSilence(WAVEFORMATEX *pWfex);
```



Необходимо добавить код в конце Аллокатестреамингресаурцес для вызова этого метода каждый раз при создании или изменении размера буфера задержки. В следующем примере кода в новый метод передается указатель ВАВЕФОРМАТЕКС с именем Пваве:


```
// Fill the buffer with values representing silence.
FillBufferWithSilence(pWave);
```



## <a name="reallocating-the-delay-buffer-memory"></a>Перераспределение памяти буфера задержки

Когда пользователь изменяет время задержки с помощью страницы свойств, размер буфера задержки также должен измениться. Вы уже добавили код в Аллокатестреамингресаурцес для изменения размера буфера, но вам нужно добавить строку кода в Цечо::p UT \_ delay, чтобы вызвать метод выделения ресурсов при каждом изменении значения свойства. Ниже приведен код:


```
// Reallocate the delay buffer.
AllocateStreamingResources();
```



## <a name="related-topics"></a>См. также

<dl> <dt>

[**Работа с потоковой передачей ресурсов**](working-with-streaming-resources.md)
</dt> </dl>

 

 




