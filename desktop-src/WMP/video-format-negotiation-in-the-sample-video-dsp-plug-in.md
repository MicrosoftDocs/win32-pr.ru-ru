---
title: Согласование формата видео в примере подключаемого модуля DSP видео
description: Согласование формата видео в примере подключаемого модуля DSP видео
ms.assetid: 3e92ce10-2b9b-4689-a181-f56c33472fea
keywords:
- Подключаемые модули проигрывателя Windows Media, DSP видео
- подключаемые модули, DSP видео
- подключаемые модули обработки цифровых сигналов, согласование формата видео
- Подключаемые модули DSP, согласование формата видео
- подключаемые модули DSP видео, форматирование согласования
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c287a38fbfcf11f1b9d74087a91c5825b22f1243
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "104330248"
---
# <a name="video-format-negotiation-in-the-sample-video-dsp-plug-in"></a><span data-ttu-id="93c9d-108">Согласование формата видео в примере подключаемого модуля DSP видео</span><span class="sxs-lookup"><span data-stu-id="93c9d-108">Video Format Negotiation in the Sample Video DSP Plug-in</span></span>

<span data-ttu-id="93c9d-109">До того, как проигрыватель Windows Media вставит подключаемый модуль DSP видео в цепочку сигналов, игрок должен определить, может ли подключаемый модуль обрабатывать воспроизводимое видео.</span><span class="sxs-lookup"><span data-stu-id="93c9d-109">Before Windows Media Player inserts a video DSP plug-in into the signal chain, the Player must determine whether the plug-in can process the video being played.</span></span> <span data-ttu-id="93c9d-110">Процесс, с помощью которого подключаемый модуль и проигрыватель обмениваются данными с поддерживаемыми форматами видео, называется согласованием формата.</span><span class="sxs-lookup"><span data-stu-id="93c9d-110">The process by which the plug-in and the Player communicate about supported video formats is called format negotiation.</span></span>

## <a name="providing-the-supported-input-and-output-types"></a><span data-ttu-id="93c9d-111">Предоставление поддерживаемых типов входных и выходных данных</span><span class="sxs-lookup"><span data-stu-id="93c9d-111">Providing the Supported Input and Output Types</span></span>

<span data-ttu-id="93c9d-112">Если подключаемый модуль DSP выступает в качестве объекта мультимедиа DirectX (DMO), проигрыватель запрашивает у подключаемого модуля сведения о поддерживаемых форматах, выполняя последовательность вызовов **имедиаобжект:: жетинпуттипе** и **Имедиаобжект:: жетаутпуттипе**.</span><span class="sxs-lookup"><span data-stu-id="93c9d-112">If the DSP plug-in is acting as a DirectX Media Object (DMO), the Player queries the plug-in about its supported formats by making a sequence of calls to **IMediaObject::GetInputType** and **IMediaObject::GetOutputType**.</span></span>

<span data-ttu-id="93c9d-113">Если подключаемый модуль DSP выступает в качестве Media Foundation преобразования (MFT), проигрыватель запрашивает у подключаемого модуля сведения о поддерживаемых форматах, выполняя последовательность вызовов **имфтрансформ:: жетинпутаваилаблетипе** и **Имфтрансформ:: жетаутпутаваилаблетипе**.</span><span class="sxs-lookup"><span data-stu-id="93c9d-113">If the DSP plug-in is acting as a Media Foundation Transform (MFT), the Player queries the plug-in about its supported formats by making a sequence of calls to **IMFTransform::GetInputAvailableType** and **IMFTransform::GetOutputAvailableType**.</span></span>

<span data-ttu-id="93c9d-114">Подключаемый модуль примера видео, созданный мастером подключаемых модулей проигрывателя Windows Media, сохраняет список поддерживаемых видеоформатов в виде массива идентификаторов GUID.</span><span class="sxs-lookup"><span data-stu-id="93c9d-114">The sample video plug-in generated by the Windows Media Player Plug-in Wizard stores the list of supported video formats as an array of GUIDs.</span></span> <span data-ttu-id="93c9d-115">Следующий код находится в файле main. cpp:</span><span class="sxs-lookup"><span data-stu-id="93c9d-115">The following code is from the main .cpp file:</span></span>


```C++
static const GUID*    k_guidValidSubtypes[] = {
    &MEDIASUBTYPE_NV12,
    &MEDIASUBTYPE_YV12,
    &MEDIASUBTYPE_YUY2,
    &MEDIASUBTYPE_UYVY,
    &MEDIASUBTYPE_RGB32,
    &MEDIASUBTYPE_RGB24,
    &MEDIASUBTYPE RGB555,
    &MEDIASUBTYPE RGB565
};

```



<span data-ttu-id="93c9d-116">Проигрыватель может вызывать **имедиаобжект:: жетинпуттипе** и **Имедиаобжект:: жетаутпуттипе** в любом порядке, поэтому код подключаемого модуля должен предвидеть это.</span><span class="sxs-lookup"><span data-stu-id="93c9d-116">The Player can call **IMediaObject::GetInputType** and **IMediaObject::GetOutputType** in any order, so the plug-in code must anticipate this.</span></span> <span data-ttu-id="93c9d-117">Аналогично, проигрыватель может вызывать **имфтрансформ:: жетинпутаваилаблетипе** и **Имфтрансформ:: жетаутпутаваилаблетипе** в любом порядке.</span><span class="sxs-lookup"><span data-stu-id="93c9d-117">Similary, the Player can call **IMFTransform::GetInputAvailableType** and **IMFTransform::GetOutputAvailableType** in any order.</span></span> <span data-ttu-id="93c9d-118">Примеры реализаций **жетаутпуттипе** и **жетаутпутаваилаблетипе** тестируют, был ли уже определен тип входных данных.</span><span class="sxs-lookup"><span data-stu-id="93c9d-118">The sample implementations of **GetOutputType** and **GetOutputAvailableType** test whether the input type has already been defined.</span></span> <span data-ttu-id="93c9d-119">Если он есть, подключаемый модуль реагирует, что он поддерживает только этот тип.</span><span class="sxs-lookup"><span data-stu-id="93c9d-119">If it has, the plug-in responds that it supports only that type.</span></span> <span data-ttu-id="93c9d-120">В противном случае подключаемый модуль возвращает тип, соответствующий заданному индексу, как показано в следующем коде:</span><span class="sxs-lookup"><span data-stu-id="93c9d-120">Otherwise, the plug-in returns the type that corresponds to the supplied index, as the following code demonstrates:</span></span>


```C++
// If input type has been defined, then use that as output type.
if (GUID_NULL != m_mtInput.majortype)
{
    hr = ::MoCopyMediaType( pmt, &m_mtInput );
}
else // Otherwise use default for this plug-in.
{
    ::ZeroMemory( pmt, sizeof( DMO_MEDIA_TYPE ) );
    pmt->majortype = MEDIATYPE_Video;
    pmt->subtype = *k_guidValidSubtypes[dwTypeIndex];     
}

```



## <a name="setting-the-input-and-output-types"></a><span data-ttu-id="93c9d-121">Настройка типов входных и выходных данных</span><span class="sxs-lookup"><span data-stu-id="93c9d-121">Setting the Input and Output Types</span></span>

<span data-ttu-id="93c9d-122">Если подключаемый модуль DSP выступает в роли DMO, проигрыватель Windows Media устанавливает тип мультимедиа, вызывая **имедиаобжект:: сетинпуттипе** и **Имедиаобжект:: сетаутпуттипе**, передавая каждой функции указатель на структуру **\_ \_ типа мультимедиа DMO** , представляющую запрошенный тип мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="93c9d-122">If the DSP plug-in is acting as a DMO, Windows Media Player sets the media type by calling **IMediaObject::SetInputType** and **IMediaObject::SetOutputType**, passing to each function a pointer to a **DMO\_MEDIA\_TYPE** structure that represents the requested media type.</span></span>

<span data-ttu-id="93c9d-123">Если подключаемый модуль DSP выступает в качестве MFT, проигрыватель Windows Media устанавливает тип мультимедиа, вызывая **имфтрансформ:: сетинпуттипе** и **Имфтрансформ:: сетаутпуттипе**, передавая каждой функции указатель на интерфейс **имфмедиатипе** , представляющий запрошенный тип мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="93c9d-123">If the DSP plug-in is acting as an MFT, Windows Media Player sets the media type by calling **IMFTransform::SetInputType** and **IMFTransform::SetOutputType**, passing to each function a pointer to an **IMFMediaType** interface that represents the requested media type.</span></span>

<span data-ttu-id="93c9d-124">Нет никакой гарантии, что проигрыватель будет вызывать методы согласования формата в каком-то конкретном порядке, поэтому код подключаемого модуля должен работать в любом случае.</span><span class="sxs-lookup"><span data-stu-id="93c9d-124">There is no guarantee that the Player will call format negotiation methods in any particular order, so plug-in code must handle any case.</span></span> <span data-ttu-id="93c9d-125">Например, если игрок вызывает **сетаутпуттипе** перед вызовом **сетинпуттипе**, он является допустимым образом действия для подключаемого модуля, чтобы отклонить предложенный тип выходного носителя.</span><span class="sxs-lookup"><span data-stu-id="93c9d-125">For instance, if the Player calls **SetOutputType** before calling **SetInputType**, it is a valid course of action for the plug-in to reject the proposed output media type.</span></span> <span data-ttu-id="93c9d-126">Следующий код из примера реализации **имедиаобжект:: сетаутпуттипе** демонстрирует это:</span><span class="sxs-lookup"><span data-stu-id="93c9d-126">The following code from the sample implementation of **IMediaObject::SetOutputType** demonstrates this:</span></span>


```C++
if( GUID_NULL != m_mtInput.majortype )
{
    // Validate that the output media type matches our requirements 
    // and matches our input type (if set).
    hr = ValidateMediaType(pmt, &m_mtInput);
}
else
{
    hr = DMO_E_TYPE_NOT_ACCEPTED;
}

```



<span data-ttu-id="93c9d-127">В примерах реализаций подключаемых модулей **сетинпуттипе** и **сетаутпуттипе** вызывается пользовательская функция с именем **валидатемедиатипе**.</span><span class="sxs-lookup"><span data-stu-id="93c9d-127">The sample plug-in implementations of **SetInputType** and **SetOutputType** call the custom function named **ValidateMediaType**.</span></span> <span data-ttu-id="93c9d-128">Эта подключаемая функция выполняет ряд тестов по предложенному типу мультимедиа, предназначенному для обеспечения правильного формата типа мультимедиа и поддержки его в подключаемом модуле.</span><span class="sxs-lookup"><span data-stu-id="93c9d-128">This plug-in function performs a series of tests on the proposed media type designed to ensure that the media type is well-formed and supported by the plug-in.</span></span> <span data-ttu-id="93c9d-129">**Валидатемедиатипе** выполняет следующие тесты:</span><span class="sxs-lookup"><span data-stu-id="93c9d-129">**ValidateMediaType** performs the following tests:</span></span>

-   <span data-ttu-id="93c9d-130">Проверяет, что члены **мажортипе** и **форматтипе** содержат правильные значения.</span><span class="sxs-lookup"><span data-stu-id="93c9d-130">Verifies that the **majortype** and **formattype** members contain the correct values.</span></span>
-   <span data-ttu-id="93c9d-131">Проверяет, соответствует ли элемент **подтипа** одному из поддерживаемых форматов.</span><span class="sxs-lookup"><span data-stu-id="93c9d-131">Verifies that the **subtype** member matches one of the supported formats.</span></span>
-   <span data-ttu-id="93c9d-132">Проверяет, содержат ли сведения в структурах **битмапинфохеадер** и **видеоинфохеадер** или **VIDEOINFOHEADER2** допустимые значения.</span><span class="sxs-lookup"><span data-stu-id="93c9d-132">Verifies that the information in the **BITMAPINFOHEADER** and **VIDEOINFOHEADER** or **VIDEOINFOHEADER2** structures contain valid values.</span></span>
-   <span data-ttu-id="93c9d-133">Проверяет совпадение типов входных и выходных носителей, так как подключаемый модуль не преобразует форматы входных данных в выходные данные.</span><span class="sxs-lookup"><span data-stu-id="93c9d-133">Tests whether the input and output media types match because the plug-in does not convert formats from input to output.</span></span>

<span data-ttu-id="93c9d-134">Если предложенный тип мультимедиа передает проверочные тесты, он хранится в переменной-члене: **m \_ мтинпут** для входного типа носителя, **m \_ мтаутпут** для выходного типа мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="93c9d-134">If the proposed media type passes the validation tests, it is stored in a member variable: **m\_mtInput** for the input media type, **m\_mtOutput** for the output media type.</span></span>

## <a name="related-topics"></a><span data-ttu-id="93c9d-135">См. также</span><span class="sxs-lookup"><span data-stu-id="93c9d-135">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="93c9d-136">**Реализация подключаемого модуля DSP видео**</span><span class="sxs-lookup"><span data-stu-id="93c9d-136">**Implementing a Video DSP Plug-in**</span></span>](implementing-a-video-dsp-plug-in.md)
</dt> </dl>

 

 




