---
description: Планирование пользовательского режима (UMS) — это упрощенный механизм, с помощью которого приложения могут планировать собственные потоки.
ms.assetid: f9dd92fe-6d7a-452c-893e-e6df1757e377
title: Планирование User-Mode
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f3ceea3c4d4e40d73f48414d074bcb5b4f6e911d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105673890"
---
# <a name="user-mode-scheduling"></a><span data-ttu-id="8e915-103">Планирование User-Mode</span><span class="sxs-lookup"><span data-stu-id="8e915-103">User-Mode Scheduling</span></span>

<span data-ttu-id="8e915-104">Планирование пользовательского режима (UMS) — это упрощенный механизм, с помощью которого приложения могут планировать собственные потоки.</span><span class="sxs-lookup"><span data-stu-id="8e915-104">User-mode scheduling (UMS) is a lightweight mechanism that applications can use to schedule their own threads.</span></span> <span data-ttu-id="8e915-105">Приложение может переключаться между UMS-потоками в пользовательском режиме без использования [планировщика системы](scheduling.md) и повторного получения управления процессором, если поток UMS блокируется в ядре.</span><span class="sxs-lookup"><span data-stu-id="8e915-105">An application can switch between UMS threads in user mode without involving the [system scheduler](scheduling.md) and regain control of the processor if a UMS thread blocks in the kernel.</span></span> <span data-ttu-id="8e915-106">UMS-потоки отличаются от [волокон](fibers.md) тем, что каждый поток UMS имеет собственный контекст потока вместо того, чтобы совместно использовать контекст потока одного потока.</span><span class="sxs-lookup"><span data-stu-id="8e915-106">UMS threads differ from [fibers](fibers.md) in that each UMS thread has its own thread context instead of sharing the thread context of a single thread.</span></span> <span data-ttu-id="8e915-107">Возможность переключения между потоками в пользовательском режиме делает UMS более эффективным, чем [Пулы потоков](thread-pools.md) для управления большим количеством рабочих элементов кратковременной продолжительности, требующих нескольких системных вызовов.</span><span class="sxs-lookup"><span data-stu-id="8e915-107">The ability to switch between threads in user mode makes UMS more efficient than [thread pools](thread-pools.md) for managing large numbers of short-duration work items that require few system calls.</span></span>

<span data-ttu-id="8e915-108">UMS рекомендуется для приложений с высокими требованиями к производительности, которые должны эффективно работать с несколькими потоками одновременно в многопроцессорных или многоядерных системах.</span><span class="sxs-lookup"><span data-stu-id="8e915-108">UMS is recommended for applications with high performance requirements that need to efficiently run many threads concurrently on multiprocessor or multicore systems.</span></span> <span data-ttu-id="8e915-109">Чтобы воспользоваться преимуществами UMS, приложение должно реализовать компонент планировщика, который управляет потоками UMS приложения и определяет, когда они должны выполняться.</span><span class="sxs-lookup"><span data-stu-id="8e915-109">To take advantage of UMS, an application must implement a scheduler component that manages the application's UMS threads and determines when they should run.</span></span> <span data-ttu-id="8e915-110">Разработчикам следует учитывать, должны ли требования к производительности приложений выровнять работу, связанную с разработкой такого компонента.</span><span class="sxs-lookup"><span data-stu-id="8e915-110">Developers should consider whether their application performance requirements justify the work involved in developing such a component.</span></span> <span data-ttu-id="8e915-111">Приложения с умеренными требованиями к производительности могут быть лучше обслуживаться, позволяя планировщику системы планировать свои потоки.</span><span class="sxs-lookup"><span data-stu-id="8e915-111">Applications with moderate performance requirements might be better served by allowing the system scheduler to schedule their threads.</span></span>

<span data-ttu-id="8e915-112">UMS доступен для 64-разрядных приложений, работающих в 64-разрядных версиях Windows 7 и Windows Server 2008 R2 или более поздних версиях, 64-разрядные версии Windows.</span><span class="sxs-lookup"><span data-stu-id="8e915-112">UMS is available for 64-bit applications running on 64-bit versions of Windows 7 and Windows Server 2008 R2 or later 64-bit versions of Windows.</span></span> <span data-ttu-id="8e915-113">Эта функция недоступна в 32-разрядных версиях Windows.</span><span class="sxs-lookup"><span data-stu-id="8e915-113">This feature is not available on 32-bit versions of Windows.</span></span>

<span data-ttu-id="8e915-114">Дополнительные сведения см. в следующих разделах:</span><span class="sxs-lookup"><span data-stu-id="8e915-114">For details, see the following sections:</span></span>

-   [<span data-ttu-id="8e915-115">Планировщик UMS</span><span class="sxs-lookup"><span data-stu-id="8e915-115">UMS Scheduler</span></span>](#ums-scheduler)
-   [<span data-ttu-id="8e915-116">Поток планировщика UMS</span><span class="sxs-lookup"><span data-stu-id="8e915-116">UMS Scheduler Thread</span></span>](#ums-scheduler-thread)
-   [<span data-ttu-id="8e915-117">Рабочие потоки UMS, контексты потоков и списки завершения</span><span class="sxs-lookup"><span data-stu-id="8e915-117">UMS Worker Threads, Thread Contexts, and Completion Lists</span></span>](#ums-worker-threads-thread-contexts-and-completion-lists)
-   [<span data-ttu-id="8e915-118">Функция точки входа в планировщике UMS</span><span class="sxs-lookup"><span data-stu-id="8e915-118">UMS Scheduler Entry Point Function</span></span>](#ums-scheduler-entry-point-function)
-   [<span data-ttu-id="8e915-119">Выполнение потока UMS</span><span class="sxs-lookup"><span data-stu-id="8e915-119">UMS Thread Execution</span></span>](#ums-thread-execution)
-   [<span data-ttu-id="8e915-120">Практические рекомендации по UMS</span><span class="sxs-lookup"><span data-stu-id="8e915-120">UMS Best Practices</span></span>](#ums-best-practices)

## <a name="ums-scheduler"></a><span data-ttu-id="8e915-121">Планировщик UMS</span><span class="sxs-lookup"><span data-stu-id="8e915-121">UMS Scheduler</span></span>

<span data-ttu-id="8e915-122">Планировщик UMS приложения отвечает за создание, управление и удаление потоков UMS и определение того, какой поток UMS следует запустить.</span><span class="sxs-lookup"><span data-stu-id="8e915-122">An application's UMS scheduler is responsible for creating, managing, and deleting UMS threads and determining which UMS thread to run.</span></span> <span data-ttu-id="8e915-123">Планировщик приложения выполняет следующие задачи:</span><span class="sxs-lookup"><span data-stu-id="8e915-123">An application's scheduler performs the following tasks:</span></span>

-   <span data-ttu-id="8e915-124">Создает один поток планировщика UMS для каждого процессора, в котором приложение будет запускать потоки UMS Worker.</span><span class="sxs-lookup"><span data-stu-id="8e915-124">Creates one UMS scheduler thread for each processor on which the application will run UMS worker threads.</span></span>
-   <span data-ttu-id="8e915-125">Создает рабочие потоки UMS для выполнения работы приложения.</span><span class="sxs-lookup"><span data-stu-id="8e915-125">Creates UMS worker threads to perform the work of the application.</span></span>
-   <span data-ttu-id="8e915-126">Поддерживает собственную очередь готовности потока рабочих потоков, готовых к выполнению, и выбирает потоки для запуска на основе политик планирования приложения.</span><span class="sxs-lookup"><span data-stu-id="8e915-126">Maintains its own ready-thread queue of worker threads that are ready to run, and selects threads to run based on the application's scheduling policies.</span></span>
-   <span data-ttu-id="8e915-127">Создает и отслеживает один или несколько списков завершения, в которых система помещает потоки в очередь после завершения обработки в ядре.</span><span class="sxs-lookup"><span data-stu-id="8e915-127">Creates and monitors one or more completion lists where the system queues threads after they finish processing in the kernel.</span></span> <span data-ttu-id="8e915-128">К ним относятся только что созданные рабочие потоки и потоки, заблокированные ранее в системном вызове, который стал разблокирован.</span><span class="sxs-lookup"><span data-stu-id="8e915-128">These include newly created worker threads and threads previously blocked on a system call that become unblocked.</span></span>
-   <span data-ttu-id="8e915-129">Предоставляет функцию точки входа планировщика для обработки уведомлений из системы.</span><span class="sxs-lookup"><span data-stu-id="8e915-129">Provides a scheduler entry point function to handles notifications from the system.</span></span> <span data-ttu-id="8e915-130">Система вызывает функцию точки входа при создании потока планировщика, когда рабочий поток блокируется в системном вызове, или когда рабочий поток явно передает управление.</span><span class="sxs-lookup"><span data-stu-id="8e915-130">The system calls the entry point function when a scheduler thread is created, when a worker thread blocks on a system call, or when a worker thread explicitly yields control.</span></span>
-   <span data-ttu-id="8e915-131">Выполняет задачи очистки для рабочих потоков, завершенных с выполнением.</span><span class="sxs-lookup"><span data-stu-id="8e915-131">Performs cleanup tasks for worker threads that have finished running.</span></span>
-   <span data-ttu-id="8e915-132">Выполняет упорядоченное завершение работы планировщика по запросу приложения.</span><span class="sxs-lookup"><span data-stu-id="8e915-132">Performs an orderly shutdown of the scheduler when requested by the application.</span></span>

## <a name="ums-scheduler-thread"></a><span data-ttu-id="8e915-133">Поток планировщика UMS</span><span class="sxs-lookup"><span data-stu-id="8e915-133">UMS Scheduler Thread</span></span>

<span data-ttu-id="8e915-134">Поток планировщика UMS — это обычный поток, который преобразует себя в UMS путем вызова функции [**ентерумссчедулингмоде**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) .</span><span class="sxs-lookup"><span data-stu-id="8e915-134">A UMS scheduler thread is an ordinary thread that has converted itself to UMS by calling the [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) function.</span></span> <span data-ttu-id="8e915-135">Системный планировщик определяет, когда выполняется поток планировщика UMS в зависимости от его приоритета относительно других готовых потоков.</span><span class="sxs-lookup"><span data-stu-id="8e915-135">The system scheduler determines when the UMS scheduler thread runs based on its priority relative to other ready threads.</span></span> <span data-ttu-id="8e915-136">Процессор, на котором выполняется поток планировщика, зависит от сходства потока, то же, что и для потоков, не являющихся UMS.</span><span class="sxs-lookup"><span data-stu-id="8e915-136">The processor on which the scheduler thread runs is influenced by the thread's affinity, same as for non-UMS threads.</span></span>

<span data-ttu-id="8e915-137">Вызывающий объект [**ентерумссчедулингмоде**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) указывает список завершения и функцию точки входа [*умссчедулерпрок*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) , связываемую с потоком планировщика UMS.</span><span class="sxs-lookup"><span data-stu-id="8e915-137">The caller of [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode) specifies a completion list and a [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) entry point function to associate with the UMS scheduler thread.</span></span> <span data-ttu-id="8e915-138">Система вызывает указанную функцию точки входа по завершении преобразования вызывающего потока в UMS.</span><span class="sxs-lookup"><span data-stu-id="8e915-138">The system calls the specified entry point function when it is finished converting the calling thread to UMS.</span></span> <span data-ttu-id="8e915-139">Функция точки входа планировщика отвечает за определение соответствующего следующего действия для указанного потока.</span><span class="sxs-lookup"><span data-stu-id="8e915-139">The scheduler entry point function is responsible for determining the appropriate next action for the specified thread.</span></span> <span data-ttu-id="8e915-140">Дополнительные сведения см. в подразделе [функция "точка входа" планировщика UMS](#ums-scheduler-entry-point-function) далее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="8e915-140">For more information, see [UMS Scheduler Entry Point Function](#ums-scheduler-entry-point-function) later in this topic.</span></span>

<span data-ttu-id="8e915-141">Приложение может создать один поток планировщика UMS для каждого процессора, который будет использоваться для выполнения потоков UMS.</span><span class="sxs-lookup"><span data-stu-id="8e915-141">An application might create one UMS scheduler thread for each processor that will be used to run UMS threads.</span></span> <span data-ttu-id="8e915-142">Приложение может также задавать сходство каждого потока планировщика UMS для определенного логического процессора, что, как правило, исключает от выполнения на этом процессоре несвязанные потоки, эффективно сохраняя его для этого потока планировщика.</span><span class="sxs-lookup"><span data-stu-id="8e915-142">The application might also set the affinity of each UMS scheduler thread for a specific logical processor, which tends to exclude unrelated threads from running on that processor, effectively reserving it for that scheduler thread.</span></span> <span data-ttu-id="8e915-143">Имейте в виду, что установка сходства потоков таким образом может повлиять на общую производительность системы за счет нехватки других процессов, которые могут выполняться в системе.</span><span class="sxs-lookup"><span data-stu-id="8e915-143">Be aware that setting thread affinity in this way can affect overall system performance by starving other processes that may be running on the system.</span></span> <span data-ttu-id="8e915-144">Дополнительные сведения о сходстве потоков см. в разделе [несколько процессоров](multiple-processors.md).</span><span class="sxs-lookup"><span data-stu-id="8e915-144">For more information about thread affinity, see [Multiple Processors](multiple-processors.md).</span></span>

## <a name="ums-worker-threads-thread-contexts-and-completion-lists"></a><span data-ttu-id="8e915-145">Рабочие потоки UMS, контексты потоков и списки завершения</span><span class="sxs-lookup"><span data-stu-id="8e915-145">UMS Worker Threads, Thread Contexts, and Completion Lists</span></span>

<span data-ttu-id="8e915-146">Рабочий поток UMS создается путем вызова [**креатеремотесреадекс**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethreadex) с \_ \_ атрибутом потока UMS атрибута Thread \_ \_ и указания контекста потока UMS и списка завершения.</span><span class="sxs-lookup"><span data-stu-id="8e915-146">A UMS worker thread is created by calling [**CreateRemoteThreadEx**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethreadex) with the PROC\_THREAD\_ATTRIBUTE\_UMS\_THREAD attribute and specifying a UMS thread context and a completion list.</span></span>

<span data-ttu-id="8e915-147">Контекст потока UMS представляет состояние потока UMS рабочего потока и используется для обнаружения рабочего потока в вызовах UMS-функции.</span><span class="sxs-lookup"><span data-stu-id="8e915-147">A UMS thread context represents the UMS thread state of a worker thread and is used to identify the worker thread in UMS function calls.</span></span> <span data-ttu-id="8e915-148">Он создается путем вызова [**креатеумссреадконтекст**](/windows/desktop/api/WinBase/nf-winbase-createumsthreadcontext).</span><span class="sxs-lookup"><span data-stu-id="8e915-148">It is created by calling [**CreateUmsThreadContext**](/windows/desktop/api/WinBase/nf-winbase-createumsthreadcontext).</span></span>

<span data-ttu-id="8e915-149">Список завершения создается путем вызова функции [**креатеумскомплетионлист**](/windows/desktop/api/WinBase/nf-winbase-createumscompletionlist) .</span><span class="sxs-lookup"><span data-stu-id="8e915-149">A completion list is created by calling the [**CreateUmsCompletionList**](/windows/desktop/api/WinBase/nf-winbase-createumscompletionlist) function.</span></span> <span data-ttu-id="8e915-150">Список завершения получает UMS-рабочие потоки, которые завершили выполнение в ядре и готовы к запуску в пользовательском режиме.</span><span class="sxs-lookup"><span data-stu-id="8e915-150">A completion list receives UMS worker threads that have completed execution in the kernel and are ready to run in user mode.</span></span> <span data-ttu-id="8e915-151">Только система может поставить рабочие потоки в очередь в список завершения.</span><span class="sxs-lookup"><span data-stu-id="8e915-151">Only the system can queue worker threads to a completion list.</span></span> <span data-ttu-id="8e915-152">Новые рабочие потоки UMS автоматически помещаются в очередь в список завершения, указанный при создании потоков.</span><span class="sxs-lookup"><span data-stu-id="8e915-152">New UMS worker threads are automatically queued to the completion list specified when the threads were created.</span></span> <span data-ttu-id="8e915-153">Ранее заблокированные рабочие потоки также ставятся в очередь в список завершения, когда они больше не блокируются.</span><span class="sxs-lookup"><span data-stu-id="8e915-153">Previously blocked worker threads are also queued to the completion list when they are no longer blocked.</span></span>

<span data-ttu-id="8e915-154">Каждый поток планировщика UMS связан с одним списком завершения.</span><span class="sxs-lookup"><span data-stu-id="8e915-154">Each UMS scheduler thread is associated with a single completion list.</span></span> <span data-ttu-id="8e915-155">Однако один и тот же список завершения может быть связан с любым количеством потоков планировщика UMS, и поток планировщика может извлекать UMS-контексты из любого списка завершения, для которого у него есть указатель.</span><span class="sxs-lookup"><span data-stu-id="8e915-155">However, the same completion list can be associated with any number of UMS scheduler threads, and a scheduler thread can retrieve UMS contexts from any completion list for which it has a pointer.</span></span>

<span data-ttu-id="8e915-156">Каждый список завершения имеет связанное событие, о котором сообщает система при постановке в очередь одного или нескольких рабочих потоков в пустой список.</span><span class="sxs-lookup"><span data-stu-id="8e915-156">Each completion list has an associated event that is signaled by the system when it queues one or more worker threads to an empty list.</span></span> <span data-ttu-id="8e915-157">Функция [**жетумскомплетионлистевент**](/windows/desktop/api/WinBase/nf-winbase-getumscompletionlistevent) Извлекает маркер события для указанного списка завершения.</span><span class="sxs-lookup"><span data-stu-id="8e915-157">The [**GetUmsCompletionListEvent**](/windows/desktop/api/WinBase/nf-winbase-getumscompletionlistevent) function retrieves a handle to the event for a specified completion list.</span></span> <span data-ttu-id="8e915-158">Приложение может ожидать более одного события списка завершения вместе с другими событиями, которые имеют смысл для приложения.</span><span class="sxs-lookup"><span data-stu-id="8e915-158">An application can wait on more than one completion list event along with other events that make sense for the application.</span></span>

## <a name="ums-scheduler-entry-point-function"></a><span data-ttu-id="8e915-159">Функция точки входа в планировщике UMS</span><span class="sxs-lookup"><span data-stu-id="8e915-159">UMS Scheduler Entry Point Function</span></span>

<span data-ttu-id="8e915-160">Функция точки входа планировщика приложения реализуется как функция [*умссчедулерпрок*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) .</span><span class="sxs-lookup"><span data-stu-id="8e915-160">An application's scheduler entry point function is implemented as a [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) function.</span></span> <span data-ttu-id="8e915-161">Система вызывает функцию точки входа планировщика приложения в следующее время:</span><span class="sxs-lookup"><span data-stu-id="8e915-161">The system calls the application's scheduler entry point function at the following times:</span></span>

-   <span data-ttu-id="8e915-162">Когда поток, не относящийся к UMS, преобразуется в поток планировщика UMS путем вызова [**ентерумссчедулингмоде**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span><span class="sxs-lookup"><span data-stu-id="8e915-162">When a non-UMS thread is converted to a UMS scheduler thread by calling [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span></span>
-   <span data-ttu-id="8e915-163">Когда рабочий поток UMS вызывает [**умссреадиелд**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span><span class="sxs-lookup"><span data-stu-id="8e915-163">When a UMS worker thread calls [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span></span>
-   <span data-ttu-id="8e915-164">Когда рабочий поток UMS блокируется в системной службе, например в системном вызове или при сбое страницы.</span><span class="sxs-lookup"><span data-stu-id="8e915-164">When a UMS worker thread blocks on a system service such as a system call or a page fault.</span></span>

<span data-ttu-id="8e915-165">Параметр *Reason* функции [*умссчедулерпрок*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) указывает причину, по которой была вызвана функция точки входа.</span><span class="sxs-lookup"><span data-stu-id="8e915-165">The *Reason* parameter of the [*UmsSchedulerProc*](/windows/desktop/api/WinNT/nc-winnt-rtl_ums_scheduler_entry_point) function specifies the reason that the entry point function was called.</span></span> <span data-ttu-id="8e915-166">Если функция точки входа была вызвана из-за создания нового потока планировщика UMS, параметр *счедулерпарам* содержит данные, указанные вызывающей стороной [**ентерумссчедулингмоде**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span><span class="sxs-lookup"><span data-stu-id="8e915-166">If the entry point function was called because a new UMS scheduler thread was created, the *SchedulerParam* parameter contains data specified by the caller of [**EnterUmsSchedulingMode**](/windows/desktop/api/WinBase/nf-winbase-enterumsschedulingmode).</span></span> <span data-ttu-id="8e915-167">Если функция точки входа была вызвана из-за подоходного рабочего потока UMS, параметр *счедулерпарам* содержит данные, указанные вызывающей стороной [**умссреадиелд**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span><span class="sxs-lookup"><span data-stu-id="8e915-167">If the entry point function was called because a UMS worker thread yielded, the *SchedulerParam* parameter contains data specified by the caller of [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield).</span></span> <span data-ttu-id="8e915-168">Если функция точки входа была вызвана, так как в ядре был заблокирован рабочий поток UMS, параметр *счедулерпарам* имеет значение null.</span><span class="sxs-lookup"><span data-stu-id="8e915-168">If the entry point function was called because a UMS worker thread blocked in the kernel, the *SchedulerParam* parameter is NULL.</span></span>

<span data-ttu-id="8e915-169">Функция точки входа планировщика отвечает за определение соответствующего следующего действия для указанного потока.</span><span class="sxs-lookup"><span data-stu-id="8e915-169">The scheduler entry point function is responsible for determining the appropriate next action for the specified thread.</span></span> <span data-ttu-id="8e915-170">Например, если рабочий поток заблокирован, функция точки входа планировщика может запустить следующий доступный рабочий поток, готовый к работе.</span><span class="sxs-lookup"><span data-stu-id="8e915-170">For example, if a worker thread is blocked, the scheduler entry point function might run the next available ready UMS worker thread.</span></span>

<span data-ttu-id="8e915-171">Когда вызывается функция точки входа планировщика, планировщик приложения должен попытаться получить все элементы в связанном списке завершения, вызвав функцию [**декуеуеумскомплетионлиститемс**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) .</span><span class="sxs-lookup"><span data-stu-id="8e915-171">When the scheduler entry point function is called, the application's scheduler should attempt to retrieve all of the items in its associated completion list by calling the [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) function.</span></span> <span data-ttu-id="8e915-172">Эта функция получает список контекстов потоков UMS, которые завершили обработку в ядре и готовы к выполнению в пользовательском режиме.</span><span class="sxs-lookup"><span data-stu-id="8e915-172">This function retrieves a list of UMS thread contexts that have finished processing in the kernel and are ready to run in user mode.</span></span> <span data-ttu-id="8e915-173">Планировщик приложения не должен запускать UMS-потоки непосредственно из этого списка, так как это может привести к непредсказуемому поведению в приложении.</span><span class="sxs-lookup"><span data-stu-id="8e915-173">The application's scheduler should not run UMS threads directly from this list because this can cause unpredictable behavior in the application.</span></span> <span data-ttu-id="8e915-174">Вместо этого планировщик должен извлекать все потоки UMS, вызывая функцию [**жетнекстумслиститем**](/windows/desktop/api/WinBase/nf-winbase-getnextumslistitem) один раз для каждого контекста, вставлять контексты потоков UMS в очередь готового потока планировщика, а затем запускать UMS потоков из очереди готового потока.</span><span class="sxs-lookup"><span data-stu-id="8e915-174">Instead, the scheduler should retrieve all UMS thread contexts by calling the [**GetNextUmsListItem**](/windows/desktop/api/WinBase/nf-winbase-getnextumslistitem) function once for each context, insert the UMS thread contexts in the scheduler’s ready thread queue, and only then run UMS threads from the ready thread queue.</span></span>

<span data-ttu-id="8e915-175">Если планировщику не нужно ждать нескольких событий, он должен вызвать [**декуеуеумскомплетионлиститемс**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) с ненулевым параметром времени ожидания, чтобы функция ждет события со списком завершения перед возвратом.</span><span class="sxs-lookup"><span data-stu-id="8e915-175">If the scheduler does not need to wait on multiple events, it should call [**DequeueUmsCompletionListItems**](/windows/desktop/api/WinBase/nf-winbase-dequeueumscompletionlistitems) with a nonzero timeout parameter so the function waits on the completion list event before returning.</span></span> <span data-ttu-id="8e915-176">Если планировщику необходимо подождать несколько событий списка завершения, он должен вызвать **декуеуеумскомплетионлиститемс** с нулевым параметром времени ожидания, чтобы функция возвращалась немедленно, даже если список завершения пуст.</span><span class="sxs-lookup"><span data-stu-id="8e915-176">If the scheduler does need to wait on multiple completion list events, it should call **DequeueUmsCompletionListItems** with a timeout parameter of zero so the function returns immediately, even if the completion list is empty.</span></span> <span data-ttu-id="8e915-177">В этом случае планировщик может ожидать явное выполнение событий списка завершения, например с помощью [**WaitForMultipleObjects**](/windows/win32/api/synchapi/nf-synchapi-waitformultipleobjects).</span><span class="sxs-lookup"><span data-stu-id="8e915-177">In this case, the scheduler can wait explicitly on completion list events, for example, by using [**WaitForMultipleObjects**](/windows/win32/api/synchapi/nf-synchapi-waitformultipleobjects).</span></span>

## <a name="ums-thread-execution"></a><span data-ttu-id="8e915-178">Выполнение потока UMS</span><span class="sxs-lookup"><span data-stu-id="8e915-178">UMS Thread Execution</span></span>

<span data-ttu-id="8e915-179">Вновь созданный рабочий поток UMS помещается в очередь к указанному списку завершения и не начинает выполняться до тех пор, пока планировщик UMS не выберет его для запуска.</span><span class="sxs-lookup"><span data-stu-id="8e915-179">A newly created UMS worker thread is queued to the specified completion list and does not begin running until the application's UMS scheduler selects it to run.</span></span> <span data-ttu-id="8e915-180">Это отличается от потоков, не являющихся потоками, которые системный планировщик автоматически планирует запускать, если только вызывающий объект явно не создаст поток, приостановленный.</span><span class="sxs-lookup"><span data-stu-id="8e915-180">This differs from non-UMS threads, which the system scheduler automatically schedules to run unless the caller explicitly creates the thread suspended.</span></span>

<span data-ttu-id="8e915-181">Планировщик запускает рабочий поток, вызывая [**ексекутеумссреад**](/windows/desktop/api/WinBase/nf-winbase-executeumsthread) с контекстом UMS рабочего потока.</span><span class="sxs-lookup"><span data-stu-id="8e915-181">The scheduler runs a worker thread by calling [**ExecuteUmsThread**](/windows/desktop/api/WinBase/nf-winbase-executeumsthread) with the worker thread's UMS context.</span></span> <span data-ttu-id="8e915-182">Рабочий поток UMS выполняется до тех пор, пока он не выдает вызов функции [**умссреадиелд**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield) , блокирует или завершает работу.</span><span class="sxs-lookup"><span data-stu-id="8e915-182">A UMS worker thread runs until it yields by calling the [**UmsThreadYield**](/windows/desktop/api/WinBase/nf-winbase-umsthreadyield) function, blocks, or terminates.</span></span>

## <a name="ums-best-practices"></a><span data-ttu-id="8e915-183">Практические рекомендации по UMS</span><span class="sxs-lookup"><span data-stu-id="8e915-183">UMS Best Practices</span></span>

<span data-ttu-id="8e915-184">Приложения, которые реализуют UMS, должны следовать этим рекомендациям:</span><span class="sxs-lookup"><span data-stu-id="8e915-184">Applications that implement UMS should follow these best practices:</span></span>

-   <span data-ttu-id="8e915-185">Базовые структуры для контекстов потоков UMS управляются системой и не должны изменяться напрямую.</span><span class="sxs-lookup"><span data-stu-id="8e915-185">The underlying structures for UMS thread contexts are managed by the system and should not be modified directly.</span></span> <span data-ttu-id="8e915-186">Вместо этого используйте [**куерюмссреадинформатион**](/windows/desktop/api/WinBase/nf-winbase-queryumsthreadinformation) и [**сетумссреадинформатион**](/windows/desktop/api/WinBase/nf-winbase-setumsthreadinformation) для получения и установки сведений о рабочем потоке UMS.</span><span class="sxs-lookup"><span data-stu-id="8e915-186">Instead, use [**QueryUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-queryumsthreadinformation) and [**SetUmsThreadInformation**](/windows/desktop/api/WinBase/nf-winbase-setumsthreadinformation) to retrieve and set information about a UMS worker thread.</span></span>
-   <span data-ttu-id="8e915-187">Чтобы предотвратить взаимоблокировки, поток планировщика UMS не должен совместно использовать блокировки с рабочими потоками UMS.</span><span class="sxs-lookup"><span data-stu-id="8e915-187">To help prevent deadlocks, the UMS scheduler thread should not share locks with UMS worker threads.</span></span> <span data-ttu-id="8e915-188">Сюда входят блокировки, созданные приложением, и системные блокировки, которые косвенно получают такие операции, как выделение из кучи или загрузка библиотек DLL.</span><span class="sxs-lookup"><span data-stu-id="8e915-188">This includes both application-created locks and system locks that are acquired indirectly by operations such as allocating from the heap or loading DLLs.</span></span> <span data-ttu-id="8e915-189">Например, предположим, что планировщик выполняет рабочий поток UMS, загружающий библиотеку DLL.</span><span class="sxs-lookup"><span data-stu-id="8e915-189">For example, suppose the scheduler runs a UMS worker thread that loads a DLL.</span></span> <span data-ttu-id="8e915-190">Рабочий поток получает блокировку и блоки загрузчика.</span><span class="sxs-lookup"><span data-stu-id="8e915-190">The worker thread acquires the loader lock and blocks.</span></span> <span data-ttu-id="8e915-191">Система вызывает функцию точки входа планировщика, которая затем загружает библиотеку DLL.</span><span class="sxs-lookup"><span data-stu-id="8e915-191">The system calls the scheduler entry point function, which then loads a DLL.</span></span> <span data-ttu-id="8e915-192">Это вызывает взаимоблокировку, так как блокировка загрузчика уже удерживается и не может быть освобождена до тех пор, пока первый поток не блокируется.</span><span class="sxs-lookup"><span data-stu-id="8e915-192">This causes a deadlock, because the loader lock is already held and cannot be released until the first thread unblocks.</span></span> <span data-ttu-id="8e915-193">Чтобы избежать этой проблемы, делегируйте работу, которая может совместно использовать блокировки с рабочими потоками UMS, в выделенный рабочий поток UMS или поток, не являющийся UMS.</span><span class="sxs-lookup"><span data-stu-id="8e915-193">To help avoid this problem, delegate work that might share locks with UMS worker threads to a dedicated UMS worker thread or a non-UMS thread.</span></span>
-   <span data-ttu-id="8e915-194">UMS наиболее эффективен, когда выполняется большая часть обработки в пользовательском режиме.</span><span class="sxs-lookup"><span data-stu-id="8e915-194">UMS is most efficient when most processing is done in user mode.</span></span> <span data-ttu-id="8e915-195">По возможности избегайте выполнения системных вызовов в потоках UMS Worker.</span><span class="sxs-lookup"><span data-stu-id="8e915-195">Whenever possible, avoid making system calls in UMS worker threads.</span></span>
-   <span data-ttu-id="8e915-196">Рабочие потоки UMS не должны рассчитывать на использование планировщика системы.</span><span class="sxs-lookup"><span data-stu-id="8e915-196">UMS worker threads should not assume the system scheduler is being used.</span></span> <span data-ttu-id="8e915-197">Это предположение может иметь незначительные последствия; Например, если поток в неизвестном коде задает приоритет или сходство потоков, планировщик UMS может по-прежнему переопределять его.</span><span class="sxs-lookup"><span data-stu-id="8e915-197">This assumption can have subtle effects; for example, if a thread in the unknown code sets a thread priority or affinity, the UMS scheduler might still override it.</span></span> <span data-ttu-id="8e915-198">Код, который предполагает использование планировщика системы, может работать не так, как ожидалось, и может нарушить работу при вызове UMS-потоком.</span><span class="sxs-lookup"><span data-stu-id="8e915-198">Code that assumes the system scheduler is being used may not behave as expected and may break when called by a UMS thread.</span></span>
-   <span data-ttu-id="8e915-199">Системе может потребоваться заблокировать контекст потока потока UMS.</span><span class="sxs-lookup"><span data-stu-id="8e915-199">The system may need to lock the thread context of a UMS worker thread.</span></span> <span data-ttu-id="8e915-200">Например, асинхронный вызов процедур (APC) в режиме ядра может изменить контекст потока UMS, поэтому контекст потока должен быть заблокирован.</span><span class="sxs-lookup"><span data-stu-id="8e915-200">For example, a kernel-mode asynchronous procedure call (APC) might change the context of the UMS thread, so the thread context must be locked.</span></span> <span data-ttu-id="8e915-201">Если планировщик пытается выполнить контекст потока UMS, пока он заблокирован, вызов завершится ошибкой.</span><span class="sxs-lookup"><span data-stu-id="8e915-201">If the scheduler tries to execute the UMS thread context while it is locked, the call will fail.</span></span> <span data-ttu-id="8e915-202">Это поведение является конструкцией, и планировщик должен быть разработан для повторного доступа к контексту потока UMS.</span><span class="sxs-lookup"><span data-stu-id="8e915-202">This behavior is by design, and the scheduler should be designed to retry access to the UMS thread context.</span></span>

 

 
