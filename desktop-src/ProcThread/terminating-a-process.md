---
description: 'Завершение процесса приводит к следующим результатам: все оставшиеся потоки в процессе отмечаются для завершения. Освобождаются все ресурсы, выделенные процессом. Все объекты ядра закрыты. Код процесса удаляется из памяти. Код завершения процесса задан. Объект процесса получает сигнал.'
ms.assetid: af24d157-2719-4052-8029-1eb8010047cc
title: Завершение процесса
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 2010f1d4332a575c8ee94cf1b0f196e00ba7fb9f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105673733"
---
# <a name="terminating-a-process"></a><span data-ttu-id="16f68-103">Завершение процесса</span><span class="sxs-lookup"><span data-stu-id="16f68-103">Terminating a Process</span></span>

<span data-ttu-id="16f68-104">Завершение процесса приводит к следующим результатам.</span><span class="sxs-lookup"><span data-stu-id="16f68-104">Terminating a process has the following results:</span></span>

-   <span data-ttu-id="16f68-105">Все оставшиеся потоки в процессе помечаются для завершения.</span><span class="sxs-lookup"><span data-stu-id="16f68-105">Any remaining threads in the process are marked for termination.</span></span>
-   <span data-ttu-id="16f68-106">Освобождаются все ресурсы, выделенные процессом.</span><span class="sxs-lookup"><span data-stu-id="16f68-106">Any resources allocated by the process are freed.</span></span>
-   <span data-ttu-id="16f68-107">Все объекты ядра закрыты.</span><span class="sxs-lookup"><span data-stu-id="16f68-107">All kernel objects are closed.</span></span>
-   <span data-ttu-id="16f68-108">Код процесса удаляется из памяти.</span><span class="sxs-lookup"><span data-stu-id="16f68-108">The process code is removed from memory.</span></span>
-   <span data-ttu-id="16f68-109">Код завершения процесса задан.</span><span class="sxs-lookup"><span data-stu-id="16f68-109">The process exit code is set.</span></span>
-   <span data-ttu-id="16f68-110">Объект процесса получает сигнал.</span><span class="sxs-lookup"><span data-stu-id="16f68-110">The process object is signaled.</span></span>

<span data-ttu-id="16f68-111">Хотя открытые дескрипторы для объектов ядра закрываются автоматически при завершении процесса, сами объекты существуют до тех пор, пока не будут закрыты все открытые дескрипторы.</span><span class="sxs-lookup"><span data-stu-id="16f68-111">While open handles to kernel objects are closed automatically when a process terminates, the objects themselves exist until all open handles to them are closed.</span></span> <span data-ttu-id="16f68-112">Таким образом, объект останется действительным после завершения процесса, который его использует, если другой процесс имеет открытый для него маркер.</span><span class="sxs-lookup"><span data-stu-id="16f68-112">Therefore, an object will remain valid after a process that is using it terminates if another process has an open handle to it.</span></span>

<span data-ttu-id="16f68-113">Функция [**жетекситкодепроцесс**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getexitcodeprocess) возвращает состояние завершения процесса.</span><span class="sxs-lookup"><span data-stu-id="16f68-113">The [**GetExitCodeProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getexitcodeprocess) function returns the termination status of a process.</span></span> <span data-ttu-id="16f68-114">Во время выполнения процесса его состояние завершения остается \_ активным.</span><span class="sxs-lookup"><span data-stu-id="16f68-114">While a process is executing, its termination status is STILL\_ACTIVE.</span></span> <span data-ttu-id="16f68-115">Когда процесс завершается, его состояние завершения меняется с \_ активного на код выхода процесса.</span><span class="sxs-lookup"><span data-stu-id="16f68-115">When a process terminates, its termination status changes from STILL\_ACTIVE to the exit code of the process.</span></span>

<span data-ttu-id="16f68-116">Когда процесс завершается, состояние объекта процесса получает значение "сигнал", освобождая потоки, ожидающие завершения процесса.</span><span class="sxs-lookup"><span data-stu-id="16f68-116">When a process terminates, the state of the process object becomes signaled, releasing any threads that had been waiting for the process to terminate.</span></span> <span data-ttu-id="16f68-117">Дополнительные сведения о синхронизации см. в разделе [Синхронизация выполнения нескольких потоков](synchronizing-execution-of-multiple-threads.md).</span><span class="sxs-lookup"><span data-stu-id="16f68-117">For more about synchronization, see [Synchronizing Execution of Multiple Threads](synchronizing-execution-of-multiple-threads.md).</span></span>

<span data-ttu-id="16f68-118">Когда система завершает процесс, она не завершает никакие дочерние процессы, созданные процессом.</span><span class="sxs-lookup"><span data-stu-id="16f68-118">When the system is terminating a process, it does not terminate any child processes that the process has created.</span></span> <span data-ttu-id="16f68-119">При завершении процесса не создаются уведомления, которые представляют собой \_ процедуры-обработчики CBT.</span><span class="sxs-lookup"><span data-stu-id="16f68-119">Terminating a process does not generate notifications for WH\_CBT hook procedures.</span></span>

<span data-ttu-id="16f68-120">Используйте функцию [**сетпроцессшутдовнпараметерс**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) , чтобы указать определенные аспекты завершения процесса при завершении работы системы, например, когда процесс должен завершаться относительно других процессов в системе.</span><span class="sxs-lookup"><span data-stu-id="16f68-120">Use the [**SetProcessShutdownParameters**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) function to specify certain aspects of the process termination at system shutdown, such as when a process should terminate relative to the other processes in the system.</span></span>

## <a name="how-processes-are-terminated"></a><span data-ttu-id="16f68-121">Как прерываются процессы</span><span class="sxs-lookup"><span data-stu-id="16f68-121">How Processes are Terminated</span></span>

<span data-ttu-id="16f68-122">Процесс выполняется до тех пор, пока не произойдет одно из следующих событий:</span><span class="sxs-lookup"><span data-stu-id="16f68-122">A process executes until one of the following events occurs:</span></span>

-   <span data-ttu-id="16f68-123">Любой поток процесса вызывает функцию [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) .</span><span class="sxs-lookup"><span data-stu-id="16f68-123">Any thread of the process calls the [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) function.</span></span> <span data-ttu-id="16f68-124">Обратите внимание, что некоторые реализации библиотеки времени выполнения C (CRT) вызывают **ExitProcess** , если основной поток процесса возвращает.</span><span class="sxs-lookup"><span data-stu-id="16f68-124">Note that some implementation of the C run-time library (CRT) call **ExitProcess** if the primary thread of the process returns.</span></span>
-   <span data-ttu-id="16f68-125">Последний поток процесса завершается.</span><span class="sxs-lookup"><span data-stu-id="16f68-125">The last thread of the process terminates.</span></span>
-   <span data-ttu-id="16f68-126">Любой поток вызывает функцию [**терминатепроцесс**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess) с помощью обработчика для процесса.</span><span class="sxs-lookup"><span data-stu-id="16f68-126">Any thread calls the [**TerminateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess) function with a handle to the process.</span></span>
-   <span data-ttu-id="16f68-127">Для процессов консоли [обработчик управления консоли](/windows/console/console-control-handlers) по умолчанию вызывает [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) , когда консоль получает сигналы CTRL + C или Ctrl + Break.</span><span class="sxs-lookup"><span data-stu-id="16f68-127">For console processes, the default [console control handler](/windows/console/console-control-handlers) calls [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) when the console receives a CTRL+C or CTRL+BREAK signal.</span></span>
-   <span data-ttu-id="16f68-128">Пользователь завершает работу системы или выходит из нее.</span><span class="sxs-lookup"><span data-stu-id="16f68-128">The user shuts down the system or logs off.</span></span>

<span data-ttu-id="16f68-129">Не завершайте процесс, если его потоки не находятся в известных состояниях.</span><span class="sxs-lookup"><span data-stu-id="16f68-129">Do not terminate a process unless its threads are in known states.</span></span> <span data-ttu-id="16f68-130">Если поток ожидает объект ядра, он не будет завершен до завершения ожидания.</span><span class="sxs-lookup"><span data-stu-id="16f68-130">If a thread is waiting on a kernel object, it will not be terminated until the wait has completed.</span></span> <span data-ttu-id="16f68-131">Это может привести к тому, что приложение перестает отвечать на запросы.</span><span class="sxs-lookup"><span data-stu-id="16f68-131">This can cause the application to stop responding.</span></span>

<span data-ttu-id="16f68-132">Основной поток может избежать завершения других потоков, направляя их для вызова [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) перед завершением процесса (Дополнительные сведения см. в разделе [завершение потока](terminating-a-thread.md)).</span><span class="sxs-lookup"><span data-stu-id="16f68-132">The primary thread can avoid terminating other threads by directing them to call [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) before causing the process to terminate (for more information, see [Terminating a Thread](terminating-a-thread.md)).</span></span> <span data-ttu-id="16f68-133">Основной поток по-прежнему может вызвать [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) , чтобы убедиться, что все потоки завершаются.</span><span class="sxs-lookup"><span data-stu-id="16f68-133">The primary thread can still call [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) afterwards to ensure that all threads are terminated.</span></span>

<span data-ttu-id="16f68-134">Код выхода для процесса — это либо значение, указанное в вызове [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) или [**терминатепроцесс**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess), либо значение, возвращаемое функцией Main или [**WinMain**](/windows/win32/api/winbase/nf-winbase-winmain) процесса.</span><span class="sxs-lookup"><span data-stu-id="16f68-134">The exit code for a process is either the value specified in the call to [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) or [**TerminateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess), or the value returned by the main or [**WinMain**](/windows/win32/api/winbase/nf-winbase-winmain) function of the process.</span></span> <span data-ttu-id="16f68-135">Если процесс завершается из-за неустранимого исключения, код выхода — это значение исключения, вызвавшего завершение.</span><span class="sxs-lookup"><span data-stu-id="16f68-135">If a process is terminated due to a fatal exception, the exit code is the value of the exception that caused the termination.</span></span> <span data-ttu-id="16f68-136">Кроме того, это значение используется в качестве кода выхода для всех потоков, которые выполнялись в момент возникновения исключения.</span><span class="sxs-lookup"><span data-stu-id="16f68-136">In addition, this value is used as the exit code for all the threads that were executing when the exception occurred.</span></span>

<span data-ttu-id="16f68-137">Если процесс завершается с помощью [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess), система вызывает функцию точки входа каждой ПРИСОЕДИНЕННОЙ библиотеки DLL со значением, указывающим, что процесс отсоединяется от библиотеки DLL.</span><span class="sxs-lookup"><span data-stu-id="16f68-137">If a process is terminated by [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess), the system calls the entry-point function of each attached DLL with a value indicating that the process is detaching from the DLL.</span></span> <span data-ttu-id="16f68-138">Библиотеки DLL не уведомляются, когда процесс завершается [**терминатепроцесс**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess).</span><span class="sxs-lookup"><span data-stu-id="16f68-138">DLLs are not notified when a process is terminated by [**TerminateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess).</span></span> <span data-ttu-id="16f68-139">Дополнительные сведения о библиотеках DLL см. в разделе [библиотеки динамической компоновки](../dlls/dynamic-link-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="16f68-139">For more information about DLLs, see [Dynamic-Link Libraries](../dlls/dynamic-link-libraries.md).</span></span>

<span data-ttu-id="16f68-140">Если процесс завершается [**терминатепроцесс**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess), все потоки процесса немедленно завершаются без возможности запуска дополнительного кода.</span><span class="sxs-lookup"><span data-stu-id="16f68-140">If a process is terminated by [**TerminateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess), all threads of the process are terminated immediately with no chance to run additional code.</span></span> <span data-ttu-id="16f68-141">Это означает, что поток не выполняет код в блоках обработчика завершения.</span><span class="sxs-lookup"><span data-stu-id="16f68-141">This means that the thread does not execute code in termination handler blocks.</span></span> <span data-ttu-id="16f68-142">Кроме того, подключенные библиотеки DLL не уведомляются о том, что процесс отсоединяется.</span><span class="sxs-lookup"><span data-stu-id="16f68-142">In addition, no attached DLLs are notified that the process is detaching.</span></span> <span data-ttu-id="16f68-143">Если требуется, чтобы один процесс завершил другой процесс, выполните следующие шаги, чтобы получить лучшее решение:</span><span class="sxs-lookup"><span data-stu-id="16f68-143">If you need to have one process terminate another process, the following steps provide a better solution:</span></span>

-   <span data-ttu-id="16f68-144">Оба процесса вызывают функцию [**регистервиндовмессаже**](/windows/win32/api/winuser/nf-winuser-registerwindowmessagea) для создания частного сообщения.</span><span class="sxs-lookup"><span data-stu-id="16f68-144">Have both processes call the [**RegisterWindowMessage**](/windows/win32/api/winuser/nf-winuser-registerwindowmessagea) function to create a private message.</span></span>
-   <span data-ttu-id="16f68-145">Один процесс может завершить другой процесс, выполнив широковещательную передачу частного сообщения с помощью функции [**броадкастсистеммессаже**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessage) следующим образом:</span><span class="sxs-lookup"><span data-stu-id="16f68-145">One process can terminate the other process by broadcasting a private message using the [**BroadcastSystemMessage**](/windows/win32/api/winuser/nf-winuser-broadcastsystemmessage) function as follows:</span></span>

    ``` syntax
     DWORD dwRecipients = BSM_APPLICATIONS;
        UINT uMessage = PM_MYMSG;
        WPARAM wParam = 0;
        LPARAM lParam = 0;

        BroadcastSystemMessage( 
            BSF_IGNORECURRENTTASK, // do not send message to this process
            &dwRecipients,         // broadcast only to applications
            uMessage,              // registered private message
            wParam,                // message-specific value
            lParam );              // message-specific value
    ```

-   <span data-ttu-id="16f68-146">Процесс, получающий закрытое сообщение, вызывает [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) для завершения выполнения.</span><span class="sxs-lookup"><span data-stu-id="16f68-146">The process receiving the private message calls [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) to terminate its execution.</span></span>

<span data-ttu-id="16f68-147">Выполнение функций [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess), [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread), [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread), [**креатеремотесреад**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread)и [**CreateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa) сериализуется в адресном пространстве.</span><span class="sxs-lookup"><span data-stu-id="16f68-147">The execution of the [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess), [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread), [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread), [**CreateRemoteThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread), and [**CreateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa) functions is serialized within an address space.</span></span> <span data-ttu-id="16f68-148">Применяются следующие ограничения:</span><span class="sxs-lookup"><span data-stu-id="16f68-148">The following restrictions apply:</span></span>

-   <span data-ttu-id="16f68-149">Во время запуска процесса и подпрограмм инициализации DLL новые потоки могут быть созданы, но они не начинают выполнение до тех пор, пока инициализация DLL не будет завершена для процесса.</span><span class="sxs-lookup"><span data-stu-id="16f68-149">During process startup and DLL initialization routines, new threads can be created, but they do not begin execution until DLL initialization is finished for the process.</span></span>
-   <span data-ttu-id="16f68-150">Только один поток за раз может находиться в подпрограммых инициализации или отсоединения DLL.</span><span class="sxs-lookup"><span data-stu-id="16f68-150">Only one thread at a time can be in a DLL initialization or detach routine.</span></span>
-   <span data-ttu-id="16f68-151">Функция [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) не возвращает значение, пока в подпрограммы инициализации или отсоединения DLL нет потоков.</span><span class="sxs-lookup"><span data-stu-id="16f68-151">The [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) function does not return until there are no threads are in their DLL initialization or detach routines.</span></span>

 

 
