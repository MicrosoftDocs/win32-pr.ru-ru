---
description: Приложение может использовать вложенные задания для управления подмножествами процессов. Вложенные задания также позволяют приложению, использующему задания, размещать другие приложения, которые также используют задания.
ms.assetid: FA22493B-CD29-49A7-BDAC-349FA96B8C9E
title: Вложенные задания
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: abf105c70ec8e83b395fcce56c6274d4838358bc
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104567627"
---
# <a name="nested-jobs"></a><span data-ttu-id="b0e4c-104">Вложенные задания</span><span class="sxs-lookup"><span data-stu-id="b0e4c-104">Nested Jobs</span></span>

<span data-ttu-id="b0e4c-105">Приложение может использовать вложенные задания для управления подмножествами процессов.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-105">An application can use nested jobs to manage subsets of processes.</span></span> <span data-ttu-id="b0e4c-106">Вложенные задания также позволяют приложению, использующему задания, размещать другие приложения, которые также используют задания.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-106">Nested jobs also enable an application that uses jobs to host other applications that also use jobs.</span></span>

<span data-ttu-id="b0e4c-107">**Windows 7, Windows server 2008 R2, Windows XP с пакетом обновления 3 (SP3), Windows server 2008, Windows Vista и Windows server 2003:** Процесс может быть связан только с одним заданием.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-107">**Windows 7, Windows Server 2008 R2, Windows XP with SP3, Windows Server 2008, Windows Vista and Windows Server 2003:** A process can be associated with only a single job.</span></span> <span data-ttu-id="b0e4c-108">Вложенные задания были введены в Windows 8 и Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-108">Nested jobs were introduced in Windows 8 and Windows Server 2012.</span></span>

<span data-ttu-id="b0e4c-109">В этом разделе приводятся общие сведения о вложенности заданий и поведении вложенных заданий.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-109">This topic provides an overview of job nesting and behavior of nested jobs:</span></span>

-   [<span data-ttu-id="b0e4c-110">Вложенные иерархии заданий</span><span class="sxs-lookup"><span data-stu-id="b0e4c-110">Nested Job Hierarchies</span></span>](#nested-job-hierarchies)
-   [<span data-ttu-id="b0e4c-111">Создание вложенной иерархии заданий</span><span class="sxs-lookup"><span data-stu-id="b0e4c-111">Creating a Nested Job Hierarchy</span></span>](#creating-a-nested-job-hierarchy)
-   [<span data-ttu-id="b0e4c-112">Ограничения заданий и уведомления для вложенных заданий</span><span class="sxs-lookup"><span data-stu-id="b0e4c-112">Job Limits and Notifications for Nested Jobs</span></span>](#job-limits-and-notifications-for-nested-jobs)
-   [<span data-ttu-id="b0e4c-113">Учет ресурсов для вложенных заданий</span><span class="sxs-lookup"><span data-stu-id="b0e4c-113">Resource Accounting for Nested Jobs</span></span>](#resource-accounting-for-nested-jobs)
-   [<span data-ttu-id="b0e4c-114">Завершение вложенных заданий</span><span class="sxs-lookup"><span data-stu-id="b0e4c-114">Termination of Nested Jobs</span></span>](#termination-of-nested-jobs)

<span data-ttu-id="b0e4c-115">Общие сведения о заданиях и объектах заданий см. в разделе [объекты задания](job-objects.md).</span><span class="sxs-lookup"><span data-stu-id="b0e4c-115">For general information about jobs and job objects, see [Job Objects](job-objects.md).</span></span>

## <a name="nested-job-hierarchies"></a><span data-ttu-id="b0e4c-116">Вложенные иерархии заданий</span><span class="sxs-lookup"><span data-stu-id="b0e4c-116">Nested Job Hierarchies</span></span>

<span data-ttu-id="b0e4c-117">Вложенные задания имеют связь типа «родители-потомки», в которой каждое дочернее задание содержит подмножество процессов в родительском задании.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-117">Nested jobs have a parent-child relationship in which each child job contains a subset of the processes in its parent job.</span></span> <span data-ttu-id="b0e4c-118">Если процесс, уже находящийся в задании, добавляется в другое задание, задания вкладываются по умолчанию, если система может сформировать допустимую иерархию заданий и не имеет ограничений пользовательского интерфейса для наборов заданий ([**сетинформатионжобобжект**](/windows/win32/api/jobapi2/nf-jobapi2-setinformationjobobject) с **жобобжектбасикуирестриктионс**).</span><span class="sxs-lookup"><span data-stu-id="b0e4c-118">If a process that is already in a job is added to another job, the jobs are nested by default if the system can form a valid job hierarchy and neither job sets UI limits ([**SetInformationJobObject**](/windows/win32/api/jobapi2/nf-jobapi2-setinformationjobobject) with **JobObjectBasicUIRestrictions**).</span></span>

<span data-ttu-id="b0e4c-119">На рис. 1 показана иерархия заданий, содержащая дерево процессов с приоритетом от P0 до P7.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-119">Figure 1 shows a job hierarchy that contains a tree of processes labeled P0 through P7.</span></span> <span data-ttu-id="b0e4c-120">Задание 1 — это *родительское задание* задания 2 и задания 4, которое является *предком* задания 3.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-120">Job 1 is the *parent job* of Job 2 and Job 4, and it is an *ancestor* of Job 3.</span></span> <span data-ttu-id="b0e4c-121">Задание 2 является *прямым родителем* задания 3; Задание 3 является *непосредственным дочерним* элементом задания 2.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-121">Job 2 is the *immediate parent* of Job 3; Job 3 is the *immediate child* of Job 2.</span></span> <span data-ttu-id="b0e4c-122">Задания 1, 2 и 3 формируют *цепочку заданий* , в которой задания 1 и 2 являются *родительской цепочкой заданий* в задании 3.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-122">Jobs 1, 2, and 3 form a *job chain* in which Jobs 1 and 2 are the *parent job chain* of Job 3.</span></span> <span data-ttu-id="b0e4c-123">Конечное задание в цепочке заданий — это *Немедленное задание* процессов в этом задании.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-123">The end job in a job chain is the *immediate job* of the processes in that job.</span></span> <span data-ttu-id="b0e4c-124">На рис. 1 Задание 3 — это немедленное задание процессов P2, P3 и P4.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-124">In Figure 1, Job 3 is the immediate job of processes P2, P3, and P4.</span></span>

![рис. 1.](images/nested-jobs-a.png)

<span data-ttu-id="b0e4c-127">Вложенные задания можно также использовать для управления группами одноранговых процессов.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-127">Nested jobs can also be used to manage groups of peer processes.</span></span> <span data-ttu-id="b0e4c-128">В иерархии заданий, показанной на рис. 2, задание 1 является родительским заданием задания 2.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-128">In the job hierarchy shown in Figure 2, Job 1 is the parent job of Job 2.</span></span> <span data-ttu-id="b0e4c-129">Обратите внимание, что иерархия заданий может содержать только часть дерева процессов.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-129">Note that a job hierarchy might contain only part of a process tree.</span></span> <span data-ttu-id="b0e4c-130">На рис. 2 P0 не находится в иерархии, но ее дочерние процессы P1 – P5.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-130">In Figure 2, P0 is not in the hierarchy, but its child processes P1 through P5 are.</span></span>

![рис. 2.](images/nested-jobs-b.png)

## <a name="creating-a-nested-job-hierarchy"></a><span data-ttu-id="b0e4c-133">Создание вложенной иерархии заданий</span><span class="sxs-lookup"><span data-stu-id="b0e4c-133">Creating a Nested Job Hierarchy</span></span>

<span data-ttu-id="b0e4c-134">Процессы в иерархии заданий явно связаны с объектом задания с помощью функции [**ассигнпроцесстожобобжект**](/windows/win32/api/jobapi2/nf-jobapi2-assignprocesstojobobject) или неявно связаны во время создания процесса, то же, что и для автономных заданий.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-134">Processes in a job hierarchy are either explicitly associated with a job object using the [**AssignProcessToJobObject**](/windows/win32/api/jobapi2/nf-jobapi2-assignprocesstojobobject) function or implicitly associated during process creation, same as for standalone jobs.</span></span> <span data-ttu-id="b0e4c-135">Порядок, в котором создаются задания и назначаются процессы, определяет, можно ли создать иерархию.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-135">The order in which jobs are created and processes are assigned determines whether a hierarchy can be created.</span></span>

<span data-ttu-id="b0e4c-136">Чтобы создать иерархию заданий с помощью явной ассоциации, все объекты заданий должны быть созданы с помощью [**креатежобобжект**](/windows/desktop/api/WinBase/nf-winbase-createjobobjecta), затем [**ассигнпроцесстожобобжект**](/windows/win32/api/jobapi2/nf-jobapi2-assignprocesstojobobject) должен вызываться несколько раз, чтобы каждый процесс свяжет процесс с каждым заданием, которому он должен принадлежать.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-136">To build a job hierarchy using explicit association, all job objects must be created using [**CreateJobObject**](/windows/desktop/api/WinBase/nf-winbase-createjobobjecta), then [**AssignProcessToJobObject**](/windows/win32/api/jobapi2/nf-jobapi2-assignprocesstojobobject) must be called multiple times for each process to associate the process with each job it should belong to.</span></span> <span data-ttu-id="b0e4c-137">Чтобы убедиться в допустимости иерархии заданий, сначала назначьте всем процессам задание в корне иерархии, а затем назначьте подмножество процессов для непосредственного дочернего объекта задания и т. д.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-137">To ensure that the job hierarchy is valid, first assign all processes to the job at the root of the hierarchy, then assign a subset of processes to the immediate child job object, and so on.</span></span> <span data-ttu-id="b0e4c-138">Если процессы назначены заданиям в этом порядке, дочернее задание всегда будет иметь подмножество процессов в родительском задании во время создания иерархии, которая необходима для вложенности.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-138">If processes are assigned to jobs in this order, a child job will always have a subset of processes in its parent job while the hierarchy is being created, which is required for nesting.</span></span> <span data-ttu-id="b0e4c-139">Если процессы назначены заданиям в случайном порядке, в некоторый момент дочернее задание будет содержать процессы, которые не находятся в родительском задании.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-139">If processes are assigned to jobs in random order, at some point a child job will have processes that are not in its parent job.</span></span> <span data-ttu-id="b0e4c-140">Это запрещено вложением, и это приведет к сбою **ассигнпроцесстожобобжект** .</span><span class="sxs-lookup"><span data-stu-id="b0e4c-140">This is not allowed by nesting and it will cause **AssignProcessToJobObject** to fail.</span></span>

<span data-ttu-id="b0e4c-141">Когда процессы неявно связаны с заданием во время создания процесса, дочерний процесс связывается с каждым заданием в цепочке заданий родительского процесса.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-141">When processes are implicitly associated with a job during process creation, a child process is associated with every job in the job chain of its parent process.</span></span> <span data-ttu-id="b0e4c-142">Если объект немедленного задания разрешает бреакавай, дочерний процесс выходит из объекта немедленного задания и из каждого задания в родительской цепочке заданий, перемещая иерархию до тех пор, пока не будет достигнуто задание, которое не допускает бреакавай.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-142">If the immediate job object allows breakaway, the child process breaks away from the immediate job object and from each job in the parent job chain, moving up the hierarchy until it reaches a job that does not permit breakaway.</span></span> <span data-ttu-id="b0e4c-143">Если объект немедленного задания не допускает бреакавай, дочерний процесс не нарушается, даже если задания в его родительской цепочке заданий разрешены.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-143">If the immediate job object does not allow breakaway, the child process does not break away even if jobs in its parent job chain allow it.</span></span>

## <a name="job-limits-and-notifications-for-nested-jobs"></a><span data-ttu-id="b0e4c-144">Ограничения заданий и уведомления для вложенных заданий</span><span class="sxs-lookup"><span data-stu-id="b0e4c-144">Job Limits and Notifications for Nested Jobs</span></span>

<span data-ttu-id="b0e4c-145">Для определенных ограничений ресурсов ограничение, заданное для заданий в родительской цепочке заданий, определяет *действующие ограничения* , которые применяются для дочернего задания.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-145">For certain resource limits, the limit set for jobs in a parent job chain determine the *effective limit* that is enforced for a child job.</span></span> <span data-ttu-id="b0e4c-146">Эффективный предел для дочернего задания может быть более ограничивающим, чем ограничение его родителя, но не может быть менее ограничивающим.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-146">The effective limit for child job can be more restrictive than the limit of its parent, but it cannot be less restrictive.</span></span> <span data-ttu-id="b0e4c-147">Например, если класс приоритета дочернего задания находится выше \_ \_ класса с нормальным приоритетом, \_ а его родительский класс приоритетного задания является нормальным \_ \_ , то эффективный предел для процессов в дочернем задании — это класс с нормальным \_ приоритетом \_ .</span><span class="sxs-lookup"><span data-stu-id="b0e4c-147">For example, if a child job's priority class is ABOVE\_NORMAL\_PRIORITY\_CLASS and its parent job's priority class is NORMAL\_PRIORITY\_CLASS, the effective limit for processes in the child job is NORMAL\_PRIORITY\_CLASS.</span></span> <span data-ttu-id="b0e4c-148">Тем не менее, если класс приоритета дочернего задания находится ниже класса приоритетов \_ \_ \_ , эффективный предел для процессов в дочернем задании находится ниже \_ \_ класса приоритета "нормальный" \_ .</span><span class="sxs-lookup"><span data-stu-id="b0e4c-148">However, if the child job's priority class is BELOW\_NORMAL\_PRIORITY\_CLASS, the effective limit for processes in the child job is BELOW\_NORMAL\_PRIORITY\_CLASS.</span></span> <span data-ttu-id="b0e4c-149">Действующие ограничения применяются для класса приоритета, сходства, оплаты за фиксацию, предельного времени выполнения процесса, ограничения класса планирования и минимального и максимального рабочего набора.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-149">Effective limits are enforced for priority class, affinity, commit charge, per-process execution time limit, scheduling class limit, and working set minimum and maximum.</span></span> <span data-ttu-id="b0e4c-150">Дополнительные сведения об ограничениях конкретных ресурсов см. в разделе [ **сетинформатионжобобжект.**](/windows/win32/api/jobapi2/nf-jobapi2-setinformationjobobject)</span><span class="sxs-lookup"><span data-stu-id="b0e4c-150">For more information about specific resource limits, see [**SetInformationJobObject.**](/windows/win32/api/jobapi2/nf-jobapi2-setinformationjobobject)</span></span>

<span data-ttu-id="b0e4c-151">При возникновении определенных событий, таких как создание нового процесса или нарушение ограничения ресурсов, в порт завершения ввода-вывода, связанный с заданием, отправляется сообщение.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-151">When certain events occur, such as new process creation or resource limit violation, a message is sent to the I/O completion port associated with a job.</span></span> <span data-ttu-id="b0e4c-152">Задание также может регистрироваться для получения уведомлений при превышении определенных ограничений.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-152">A job can also register to receive notifications when certain limits are exceeded.</span></span> <span data-ttu-id="b0e4c-153">Для невложенного задания сообщение отправляется на порт завершения ввода-вывода, связанный с заданием.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-153">For a non-nested job, the message is sent to the I/O completion port associated with the job.</span></span> <span data-ttu-id="b0e4c-154">Для вложенного задания сообщение отправляется каждому порту завершения ввода-вывода, связанному с любым заданием в родительской цепочке заданий, вызвавшей сообщение.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-154">For a nested job, the message is sent to every I/O completion port associated with any job in the parent job chain of the job that triggered the message.</span></span> <span data-ttu-id="b0e4c-155">Дочернему заданию не требуется связанный порт завершения ввода-вывода для сообщений, которые он инициирует для отправки на порты завершения ввода-вывода родительских заданий, находящиеся выше в цепочке заданий.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-155">A child job does not need to have an associated I/O completion port for messages it triggers to be sent to the I/O completion ports of parent jobs higher in the job chain.</span></span> <span data-ttu-id="b0e4c-156">Дополнительные сведения о конкретных сообщениях см. в разделе [**жобобжект, \_ связанный с \_ \_ портом завершения**](/windows/desktop/api/WinNT/ns-winnt-jobobject_associate_completion_port).</span><span class="sxs-lookup"><span data-stu-id="b0e4c-156">For more information about specific messages, see [**JOBOBJECT\_ASSOCIATE\_COMPLETION\_PORT**](/windows/desktop/api/WinNT/ns-winnt-jobobject_associate_completion_port).</span></span>

## <a name="resource-accounting-for-nested-jobs"></a><span data-ttu-id="b0e4c-157">Учет ресурсов для вложенных заданий</span><span class="sxs-lookup"><span data-stu-id="b0e4c-157">Resource Accounting for Nested Jobs</span></span>

<span data-ttu-id="b0e4c-158">Сведения о учете ресурсов для вложенного задания описывают использование каждого процесса, связанного с этим заданием, включая процессы в дочерних заданиях.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-158">Resource accounting information for a nested job describes the usage of every process associated with that job, including processes in child jobs.</span></span> <span data-ttu-id="b0e4c-159">Поэтому каждое задание в цепочке заданий представляет сводные ресурсы, используемые собственными процессами, а также процессы каждого дочернего задания, расположенные ниже в цепочке заданий.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-159">Each job in a job chain therefore represents the aggregated resources used by its own processes and the processes of every child job below it in the job chain.</span></span>

## <a name="termination-of-nested-jobs"></a><span data-ttu-id="b0e4c-160">Завершение вложенных заданий</span><span class="sxs-lookup"><span data-stu-id="b0e4c-160">Termination of Nested Jobs</span></span>

<span data-ttu-id="b0e4c-161">При завершении задания в иерархии заданий система завершает процессы в этом задании и все его дочерние задания, начиная с дочернего задания в нижней части иерархии.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-161">When a job in a job hierarchy is terminated, the system terminates processes in that job and all of its child jobs, starting with the child job at the bottom of the hierarchy.</span></span> <span data-ttu-id="b0e4c-162">Необработанные ресурсы, используемые каждым прерванным процессом, направляются в родительское задание.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-162">Outstanding resources used by each terminated process are charged to the parent job.</span></span>

<span data-ttu-id="b0e4c-163">Для обработчика заданий должен быть \_ \_ завершен доступ к объекту задания, как и для автономных заданий.</span><span class="sxs-lookup"><span data-stu-id="b0e4c-163">The job handle must have the JOB\_OBJECT\_TERMINATE access right, same as for standalone jobs.</span></span>

 

 
