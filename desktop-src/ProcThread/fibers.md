---
description: Волокно — это единица выполнения, которая должна быть запланирована приложением вручную.
ms.assetid: 6283f56b-23ae-4840-abd0-2478a50c670c
title: Виде
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4ea0383e6d207a77c621f00f358c72bb8873ecb5
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103813769"
---
# <a name="fibers"></a><span data-ttu-id="bb3ff-103">Виде</span><span class="sxs-lookup"><span data-stu-id="bb3ff-103">Fibers</span></span>

<span data-ttu-id="bb3ff-104">*Волокно* — это единица выполнения, которая должна быть запланирована приложением вручную.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-104">A *fiber* is a unit of execution that must be manually scheduled by the application.</span></span> <span data-ttu-id="bb3ff-105">Волокна выполняются в контексте потоков, планирующих их.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-105">Fibers run in the context of the threads that schedule them.</span></span> <span data-ttu-id="bb3ff-106">Каждый поток может запланировать несколько волокон.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-106">Each thread can schedule multiple fibers.</span></span> <span data-ttu-id="bb3ff-107">Как правило, волокна не предоставляют преимуществ по сравнению с хорошо спроектированным многопоточным приложением.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-107">In general, fibers do not provide advantages over a well-designed multithreaded application.</span></span> <span data-ttu-id="bb3ff-108">Однако использование волокон может упростить перенос приложений, разработанных для планирования собственных потоков.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-108">However, using fibers can make it easier to port applications that were designed to schedule their own threads.</span></span>

<span data-ttu-id="bb3ff-109">С точки зрения системы, волокно предполагает идентификацию потока, который его выполняет.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-109">From a system standpoint, a fiber assumes the identity of the thread that runs it.</span></span> <span data-ttu-id="bb3ff-110">Например, если волокно обращается к [локальному хранилищу потока](thread-local-storage.md) (TLS), он обращается к локальному хранилищу потока, в котором он работает.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-110">For example, if a fiber accesses [thread local storage](thread-local-storage.md) (TLS), it is accessing the thread local storage of the thread that is running it.</span></span> <span data-ttu-id="bb3ff-111">Кроме того, если волокно вызывает функцию [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) , поток, выполняющий его, завершает работу.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-111">In addition, if a fiber calls the [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) function, the thread that is running it exits.</span></span> <span data-ttu-id="bb3ff-112">Однако волокно не имеет всех связанных с ним сведений о состоянии, как это было связано с потоком.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-112">However, a fiber does not have all the same state information associated with it as that associated with a thread.</span></span> <span data-ttu-id="bb3ff-113">Единственной информацией о состоянии, хранящейся для волокон, является его стек, подмножество его регистров и данные волокон, предоставляемые во время создания волокон.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-113">The only state information maintained for a fiber is its stack, a subset of its registers, and the fiber data provided during fiber creation.</span></span> <span data-ttu-id="bb3ff-114">Сохраненные регистры — это набор регистров, обычно сохраняемых в вызове функции.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-114">The saved registers are the set of registers typically preserved across a function call.</span></span>

<span data-ttu-id="bb3ff-115">Многоприоритетное выполнение волокон не запланировано.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-115">Fibers are not preemptively scheduled.</span></span> <span data-ttu-id="bb3ff-116">Чтобы запланировать волокно, переключитесь на него с другого волокна.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-116">You schedule a fiber by switching to it from another fiber.</span></span> <span data-ttu-id="bb3ff-117">Система по-прежнему планирует выполнение потоков.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-117">The system still schedules threads to run.</span></span> <span data-ttu-id="bb3ff-118">Когда поток, использующий волокна, заменяется, его текущее работающее волокно заменяется, но остается выбранным.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-118">When a thread running fibers is preempted, its currently running fiber is preempted but remains selected.</span></span> <span data-ttu-id="bb3ff-119">Выбранный волокон выполняется при выполнении потока.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-119">The selected fiber runs when its thread runs.</span></span>

<span data-ttu-id="bb3ff-120">Прежде чем планировать первое волокно, вызовите функцию [**конвертсреадтофибер**](/windows/desktop/api/WinBase/nf-winbase-convertthreadtofiber) , чтобы создать область, в которой нужно сохранить сведения о состоянии волокон.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-120">Before scheduling the first fiber, call the [**ConvertThreadToFiber**](/windows/desktop/api/WinBase/nf-winbase-convertthreadtofiber) function to create an area in which to save fiber state information.</span></span> <span data-ttu-id="bb3ff-121">Вызывающий поток теперь является выполняемым в настоящее время волокно.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-121">The calling thread is now the currently executing fiber.</span></span> <span data-ttu-id="bb3ff-122">Сведения о сохраненном состоянии для этого волокна включают данные волокон, передаваемые в качестве аргумента в **конвертсреадтофибер**.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-122">The stored state information for this fiber includes the fiber data passed as an argument to **ConvertThreadToFiber**.</span></span>

<span data-ttu-id="bb3ff-123">Функция [**креатефибер**](/windows/desktop/api/WinBase/nf-winbase-createfiber) используется для создания нового волокна из существующего волокна; для вызова требуется размер стека, начальный адрес и данные волокон.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-123">The [**CreateFiber**](/windows/desktop/api/WinBase/nf-winbase-createfiber) function is used to create a new fiber from an existing fiber; the call requires the stack size, the starting address, and the fiber data.</span></span> <span data-ttu-id="bb3ff-124">Начальный адрес обычно представляет собой определяемую пользователем функцию, называемую функцией волокон, которая принимает один параметр (оптоволоконные данные) и не возвращает значение.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-124">The starting address is typically a user-supplied function, called the fiber function, that takes one parameter (the fiber data) and does not return a value.</span></span> <span data-ttu-id="bb3ff-125">Если функция Fiber возвращает, то поток, выполняющий волоконный выход, завершается.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-125">If your fiber function returns, the thread running the fiber exits.</span></span> <span data-ttu-id="bb3ff-126">Чтобы выполнить любое волокное, созданное с помощью **креатефибер**, вызовите функцию [**свитчтофибер**](/windows/desktop/api/WinBase/nf-winbase-switchtofiber) .</span><span class="sxs-lookup"><span data-stu-id="bb3ff-126">To execute any fiber created with **CreateFiber**, call the [**SwitchToFiber**](/windows/desktop/api/WinBase/nf-winbase-switchtofiber) function.</span></span> <span data-ttu-id="bb3ff-127">Вы можете вызвать **свитчтофибер** с адресом волокон, созданным другим потоком.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-127">You can call **SwitchToFiber** with the address of a fiber created by a different thread.</span></span> <span data-ttu-id="bb3ff-128">Для этого необходимо, чтобы адрес возвращался в другой поток, когда он называется **креатефибер** , и необходимо использовать правильную синхронизацию.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-128">To do this, you must have the address returned to the other thread when it called **CreateFiber** and you must use proper synchronization.</span></span>

<span data-ttu-id="bb3ff-129">Волокно может получить данные волокон, вызвав макрос [**жетфибердата**](/windows/win32/api/winnt/nf-winnt-getfiberdata) .</span><span class="sxs-lookup"><span data-stu-id="bb3ff-129">A fiber can retrieve the fiber data by calling the [**GetFiberData**](/windows/win32/api/winnt/nf-winnt-getfiberdata) macro.</span></span> <span data-ttu-id="bb3ff-130">Волокно может получить адрес волокон в любое время, вызвав макрос [**жеткуррентфибер**](/windows/win32/api/winnt/nf-winnt-getcurrentfiber) .</span><span class="sxs-lookup"><span data-stu-id="bb3ff-130">A fiber can retrieve the fiber address at any time by calling the [**GetCurrentFiber**](/windows/win32/api/winnt/nf-winnt-getcurrentfiber) macro.</span></span>

## <a name="fiber-local-storage"></a><span data-ttu-id="bb3ff-131">Локальное хранилище Fiber</span><span class="sxs-lookup"><span data-stu-id="bb3ff-131">Fiber Local Storage</span></span>

<span data-ttu-id="bb3ff-132">Волокно может использовать *Локальное хранилище волокон* (ФЛС), чтобы создать уникальную копию переменной для каждого волокна.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-132">A fiber can use *fiber local storage* (FLS) to create a unique copy of a variable for each fiber.</span></span> <span data-ttu-id="bb3ff-133">Если переключение волокон не выполняется, ФЛС действует точно так же, как и [Локальное хранилище потока](thread-local-storage.md).</span><span class="sxs-lookup"><span data-stu-id="bb3ff-133">If no fiber switching occurs, FLS acts exactly the same as [thread local storage](thread-local-storage.md).</span></span> <span data-ttu-id="bb3ff-134">Функции ФЛС ([**флсаллок**](/windows/win32/api/fibersapi/nf-fibersapi-flsalloc), [**флсфри**](/windows/win32/api/fibersapi/nf-fibersapi-flsfree), [**ФЛСЖЕТВАЛУЕ**](/windows/win32/api/fibersapi/nf-fibersapi-flsgetvalue)и [**флссетвалуе**](/windows/win32/api/fibersapi/nf-fibersapi-flssetvalue)) управляют ФЛС, связанным с текущим потоком.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-134">The FLS functions ([**FlsAlloc**](/windows/win32/api/fibersapi/nf-fibersapi-flsalloc), [**FlsFree**](/windows/win32/api/fibersapi/nf-fibersapi-flsfree), [**FlsGetValue**](/windows/win32/api/fibersapi/nf-fibersapi-flsgetvalue), and [**FlsSetValue**](/windows/win32/api/fibersapi/nf-fibersapi-flssetvalue)) manipulate the FLS associated with the current thread.</span></span> <span data-ttu-id="bb3ff-135">Если поток исполняет волокно, а волокно переключается, ФЛС также переключается.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-135">If the thread is executing a fiber and the fiber is switched, the FLS is also switched.</span></span>

<span data-ttu-id="bb3ff-136">Чтобы очистить данные, связанные с волокно, вызовите функцию [**делетефибер**](/windows/desktop/api/WinBase/nf-winbase-deletefiber) .</span><span class="sxs-lookup"><span data-stu-id="bb3ff-136">To clean up the data associated with a fiber, call the [**DeleteFiber**](/windows/desktop/api/WinBase/nf-winbase-deletefiber) function.</span></span> <span data-ttu-id="bb3ff-137">Эти данные включают стек, подмножество регистров и данные волокон.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-137">This data includes the stack, a subset of the registers, and the fiber data.</span></span> <span data-ttu-id="bb3ff-138">Если выполняемый в данный момент волокон вызывает **делетефибер**, его поток вызывает [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) и завершает работу.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-138">If the currently running fiber calls **DeleteFiber**, its thread calls [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) and terminates.</span></span> <span data-ttu-id="bb3ff-139">Однако если выбранное волокно удалено с помощью волоконно-оптического потока в другом потоке, поток с удаленным волоком, скорее всего, завершится аварийно, так как стек волокон был освобожден.</span><span class="sxs-lookup"><span data-stu-id="bb3ff-139">However, if the selected fiber of a thread is deleted by a fiber running in another thread, the thread with the deleted fiber is likely to terminate abnormally because the fiber stack has been freed.</span></span>

## <a name="related-topics"></a><span data-ttu-id="bb3ff-140">См. также</span><span class="sxs-lookup"><span data-stu-id="bb3ff-140">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="bb3ff-141">Использование волокон</span><span class="sxs-lookup"><span data-stu-id="bb3ff-141">Using Fibers</span></span>](using-fibers.md)
</dt> </dl>

 

 
