---
description: 'Завершение потока приводит к следующим результатам: все ресурсы, принадлежащие потоку, например окна и перехватчики, освобождаются. Код завершения потока задан. Объект потока получает сигнал. Если поток является единственным активным потоком в процессе, процесс завершается. Дополнительные сведения см. в разделе Завершение процесса.'
ms.assetid: 633e5d0c-e9d8-4f9a-9411-17cbe9e2e6e4
title: "  Завершение потока"
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ada421356666316072aabff8281787cc140ad114
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105673732"
---
# <a name="terminating-a-thread"></a><span data-ttu-id="40d69-104">  Завершение потока</span><span class="sxs-lookup"><span data-stu-id="40d69-104">Terminating a Thread</span></span>

<span data-ttu-id="40d69-105">Завершение потока приводит к следующим результатам.</span><span class="sxs-lookup"><span data-stu-id="40d69-105">Terminating a thread has the following results:</span></span>

-   <span data-ttu-id="40d69-106">Все ресурсы, принадлежащие потоку, например Windows и перехватчики, освобождаются.</span><span class="sxs-lookup"><span data-stu-id="40d69-106">Any resources owned by the thread, such as windows and hooks, are freed.</span></span>
-   <span data-ttu-id="40d69-107">Код завершения потока задан.</span><span class="sxs-lookup"><span data-stu-id="40d69-107">The thread exit code is set.</span></span>
-   <span data-ttu-id="40d69-108">Объект потока получает сигнал.</span><span class="sxs-lookup"><span data-stu-id="40d69-108">The thread object is signaled.</span></span>
-   <span data-ttu-id="40d69-109">Если поток является единственным активным потоком в процессе, процесс завершается.</span><span class="sxs-lookup"><span data-stu-id="40d69-109">If the thread is the only active thread in the process, the process is terminated.</span></span> <span data-ttu-id="40d69-110">Дополнительные сведения см. в разделе [Завершение процесса](terminating-a-process.md).</span><span class="sxs-lookup"><span data-stu-id="40d69-110">For more information, see [Terminating a Process](terminating-a-process.md).</span></span>

<span data-ttu-id="40d69-111">Функция [**жетекситкодесреад**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getexitcodethread) возвращает состояние завершения потока.</span><span class="sxs-lookup"><span data-stu-id="40d69-111">The [**GetExitCodeThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getexitcodethread) function returns the termination status of a thread.</span></span> <span data-ttu-id="40d69-112">Во время выполнения потока его состояние завершения остается \_ активным.</span><span class="sxs-lookup"><span data-stu-id="40d69-112">While a thread is executing, its termination status is STILL\_ACTIVE.</span></span> <span data-ttu-id="40d69-113">Когда поток завершается, его состояние завершения изменяется с по-прежнему \_ активным на код выхода потока.</span><span class="sxs-lookup"><span data-stu-id="40d69-113">When a thread terminates, its termination status changes from STILL\_ACTIVE to the exit code of the thread.</span></span>

<span data-ttu-id="40d69-114">Когда поток завершается, состояние объекта потока изменяется на сигнальное, освобождая все потоки, ожидающие завершения потока.</span><span class="sxs-lookup"><span data-stu-id="40d69-114">When a thread terminates, the state of the thread object changes to signaled, releasing any other threads that had been waiting for the thread to terminate.</span></span> <span data-ttu-id="40d69-115">Дополнительные сведения о синхронизации см. в разделе [Синхронизация выполнения нескольких потоков](synchronizing-execution-of-multiple-threads.md).</span><span class="sxs-lookup"><span data-stu-id="40d69-115">For more about synchronization, see [Synchronizing Execution of Multiple Threads](synchronizing-execution-of-multiple-threads.md).</span></span>

<span data-ttu-id="40d69-116">Когда поток завершается, его объект потока не освобождается, пока все открытые дескрипторы потока не будут закрыты.</span><span class="sxs-lookup"><span data-stu-id="40d69-116">When a thread terminates, its thread object is not freed until all open handles to the thread are closed.</span></span>

## <a name="how-threads-are-terminated"></a><span data-ttu-id="40d69-117">Завершение потоков</span><span class="sxs-lookup"><span data-stu-id="40d69-117">How Threads are Terminated</span></span>

<span data-ttu-id="40d69-118">Поток выполняется до тех пор, пока не произойдет одно из следующих событий:</span><span class="sxs-lookup"><span data-stu-id="40d69-118">A thread executes until one of the following events occurs:</span></span>

-   <span data-ttu-id="40d69-119">Поток вызывает функцию [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) .</span><span class="sxs-lookup"><span data-stu-id="40d69-119">The thread calls the [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) function.</span></span>
-   <span data-ttu-id="40d69-120">Любой поток процесса вызывает функцию [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) .</span><span class="sxs-lookup"><span data-stu-id="40d69-120">Any thread of the process calls the [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess) function.</span></span>
-   <span data-ttu-id="40d69-121">Функция потока возвращает.</span><span class="sxs-lookup"><span data-stu-id="40d69-121">The thread function returns.</span></span>
-   <span data-ttu-id="40d69-122">Любой поток вызывает функцию [**TerminateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread) с помощью обработчика потока.</span><span class="sxs-lookup"><span data-stu-id="40d69-122">Any thread calls the [**TerminateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread) function with a handle to the thread.</span></span>
-   <span data-ttu-id="40d69-123">Любой поток вызывает функцию [**терминатепроцесс**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess) с помощью обработчика для процесса.</span><span class="sxs-lookup"><span data-stu-id="40d69-123">Any thread calls the [**TerminateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess) function with a handle to the process.</span></span>

<span data-ttu-id="40d69-124">Кодом выхода для потока является либо значение, указанное в вызове [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread), [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess), [**TerminateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread)или [**терминатепроцесс**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess), либо значение, возвращаемое функцией потока.</span><span class="sxs-lookup"><span data-stu-id="40d69-124">The exit code for a thread is either the value specified in the call to [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread), [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess), [**TerminateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread), or [**TerminateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess), or the value returned by the thread function.</span></span>

<span data-ttu-id="40d69-125">Если поток завершается с помощью [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread), система вызывает функцию точки входа каждой ПРИСОЕДИНЕННОЙ библиотеки DLL со значением, указывающим, что поток отсоединяется от библиотеки DLL (если только не вызвана функция [**дисаблесреадлибрарикаллс**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) ).</span><span class="sxs-lookup"><span data-stu-id="40d69-125">If a thread is terminated by [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread), the system calls the entry-point function of each attached DLL with a value indicating that the thread is detaching from the DLL (unless you call the [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) function).</span></span> <span data-ttu-id="40d69-126">Если поток завершается с помощью [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess), функции точки входа библиотеки DLL вызываются один раз, чтобы указать, что процесс отсоединяется.</span><span class="sxs-lookup"><span data-stu-id="40d69-126">If a thread is terminated by [**ExitProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess), the DLL entry-point functions are invoked once, to indicate that the process is detaching.</span></span> <span data-ttu-id="40d69-127">Библиотеки DLL не получают уведомления при завершении потока с помощью [**TerminateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread) или [**терминатепроцесс**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess).</span><span class="sxs-lookup"><span data-stu-id="40d69-127">DLLs are not notified when a thread is terminated by [**TerminateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread) or [**TerminateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess).</span></span> <span data-ttu-id="40d69-128">Дополнительные сведения о библиотеках DLL см. в разделе [библиотеки динамической компоновки](../dlls/dynamic-link-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="40d69-128">For more information about DLLs, see [Dynamic-Link Libraries](../dlls/dynamic-link-libraries.md).</span></span>

<span data-ttu-id="40d69-129">Функции [**TerminateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread) и [**терминатепроцесс**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess) следует использовать только в экстремальных обстоятельствах, так как они не допускают очистки потоков, не уведомляют подключенные библиотеки DLL и не освобождают начальный стек.</span><span class="sxs-lookup"><span data-stu-id="40d69-129">The [**TerminateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread) and [**TerminateProcess**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess) functions should be used only in extreme circumstances, since they do not allow threads to clean up, do not notify attached DLLs, and do not free the initial stack.</span></span> <span data-ttu-id="40d69-130">Кроме того, дескрипторы объектов, принадлежащих потоку, не закрываются до завершения процесса.</span><span class="sxs-lookup"><span data-stu-id="40d69-130">In addition, handles to objects owned by the thread are not closed until the process terminates.</span></span> <span data-ttu-id="40d69-131">Следующие шаги обеспечивают лучшее решение:</span><span class="sxs-lookup"><span data-stu-id="40d69-131">The following steps provide a better solution:</span></span>

-   <span data-ttu-id="40d69-132">Создайте объект события с помощью функции [**CreateEvent**](/windows/win32/api/synchapi/nf-synchapi-createeventa) .</span><span class="sxs-lookup"><span data-stu-id="40d69-132">Create an event object using the [**CreateEvent**](/windows/win32/api/synchapi/nf-synchapi-createeventa) function.</span></span>
-   <span data-ttu-id="40d69-133">Создайте потоки.</span><span class="sxs-lookup"><span data-stu-id="40d69-133">Create the threads.</span></span>
-   <span data-ttu-id="40d69-134">Каждый поток отслеживает состояние события, вызывая функцию [**WaitForSingleObject**](/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject) .</span><span class="sxs-lookup"><span data-stu-id="40d69-134">Each thread monitors the event state by calling the [**WaitForSingleObject**](/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject) function.</span></span> <span data-ttu-id="40d69-135">Используйте нулевой интервал времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="40d69-135">Use a wait time-out interval of zero.</span></span>
-   <span data-ttu-id="40d69-136">Каждый поток завершает свое собственное выполнение, если событие установлено в сигнальное состояние ([**WaitForSingleObject**](/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject) ВОЗВРАЩАЕТ \_ объект ожидания \_ 0).</span><span class="sxs-lookup"><span data-stu-id="40d69-136">Each thread terminates its own execution when the event is set to the signaled state ([**WaitForSingleObject**](/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject) returns WAIT\_OBJECT\_0).</span></span>

 

 
