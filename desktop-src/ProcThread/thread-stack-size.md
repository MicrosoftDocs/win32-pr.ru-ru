---
description: Каждый новый поток или волокон получает собственное пространство стека, состоящее из зарезервированных и первоначальных выделенных памяти.
ms.assetid: abb2d5c1-040b-4c36-aae5-3517b6a8c540
title: Размер стека потока
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f4204e0bffa13fb43b6ea9520b60c0505372bad6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103998683"
---
# <a name="thread-stack-size"></a><span data-ttu-id="1f8ed-103">Размер стека потока</span><span class="sxs-lookup"><span data-stu-id="1f8ed-103">Thread Stack Size</span></span>

<span data-ttu-id="1f8ed-104">Каждый новый поток или волокон получает собственное пространство стека, состоящее из зарезервированных и первоначальных выделенных памяти.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-104">Each new thread or fiber receives its own stack space consisting of both reserved and initially committed memory.</span></span> <span data-ttu-id="1f8ed-105">Зарезервированный объем памяти представляет общее выделение стека в виртуальной памяти.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-105">The reserved memory size represents the total stack allocation in virtual memory.</span></span> <span data-ttu-id="1f8ed-106">Таким образом, зарезервированный размер ограничен диапазоном виртуальных адресов.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-106">As such, the reserved size is limited to the virtual address range.</span></span> <span data-ttu-id="1f8ed-107">Изначально зафиксированные страницы не используют физическую память, пока не будет создана ссылка; Однако они удаляют страницы из общего количества фиксаций системы, то есть размера файла подкачки и размера физической памяти.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-107">The initially committed pages do not utilize physical memory until they are referenced; however, they do remove pages from the system total commit limit, which is the size of the page file plus the size of the physical memory.</span></span> <span data-ttu-id="1f8ed-108">Система фиксирует дополнительные страницы из зарезервированной памяти стека по мере необходимости, пока стек не достигнет зарезервированного размера минус одну страницу (которая используется в качестве охранной страницы для предотвращения переполнения стека), или системе не хватает памяти, чтобы выполнить операцию не удалось.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-108">The system commits additional pages from the reserved stack memory as they are needed, until either the stack reaches the reserved size minus one page (which is used as a guard page to prevent stack overflow) or the system is so low on memory that the operation fails.</span></span>

<span data-ttu-id="1f8ed-109">Лучше всего выбрать как можно меньше размер стека и зафиксировать стек, необходимый для надежной работы потока или волокон.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-109">It is best to choose as small a stack size as possible and commit the stack that is needed for the thread or fiber to run reliably.</span></span> <span data-ttu-id="1f8ed-110">Каждая страница, зарезервированная для стека, не может использоваться для других целей.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-110">Every page that is reserved for the stack cannot be used for any other purpose.</span></span>

<span data-ttu-id="1f8ed-111">Стек освобождается при выходе его потока.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-111">A stack is freed when its thread exits.</span></span> <span data-ttu-id="1f8ed-112">Он не освобождается, если поток завершается другим потоком.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-112">It is not freed if the thread is terminated by another thread.</span></span>

<span data-ttu-id="1f8ed-113">Размер по умолчанию для зарезервированного и первоначально зафиксированной памяти стека указывается в заголовке исполняемого файла.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-113">The default size for the reserved and initially committed stack memory is specified in the executable file header.</span></span> <span data-ttu-id="1f8ed-114">Создание потока или волокон завершается сбоем, если недостаточно памяти для резервирования или фиксации запрошенного количества байтов.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-114">Thread or fiber creation fails if there is not enough memory to reserve or commit the number of bytes requested.</span></span> <span data-ttu-id="1f8ed-115">Размер резервирования стека по умолчанию, используемый компоновщиком, составляет 1 МБ.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-115">The default stack reservation size used by the linker is 1 MB.</span></span> <span data-ttu-id="1f8ed-116">Чтобы указать другой размер резервирования стека по умолчанию для всех потоков и волокон, используйте инструкцию STACKSIZE в файле определения модуля (DEF).</span><span class="sxs-lookup"><span data-stu-id="1f8ed-116">To specify a different default stack reservation size for all threads and fibers, use the STACKSIZE statement in the module definition (.def) file.</span></span> <span data-ttu-id="1f8ed-117">Операционная система округляет указанный размер до ближайшего числа, кратного степени гранулярности распределения системы (обычно 64 КБ).</span><span class="sxs-lookup"><span data-stu-id="1f8ed-117">The operating system rounds up the specified size to the nearest multiple of the system's allocation granularity (typically 64 KB).</span></span> <span data-ttu-id="1f8ed-118">Чтобы получить гранулярность выделения текущей системы, используйте функцию [**жетсистеминфо**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsysteminfo) .</span><span class="sxs-lookup"><span data-stu-id="1f8ed-118">To retrieve the allocation granularity of the current system, use the [**GetSystemInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsysteminfo) function.</span></span>

<span data-ttu-id="1f8ed-119">Чтобы изменить первоначально зафиксированное пространство стека, используйте параметр *двстакксизе* функции [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread), [**креатеремотесреад**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread)или [**креатефибер**](/windows/desktop/api/WinBase/nf-winbase-createfiber) .</span><span class="sxs-lookup"><span data-stu-id="1f8ed-119">To change the initially committed stack space, use the *dwStackSize* parameter of the [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread), [**CreateRemoteThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread), or [**CreateFiber**](/windows/desktop/api/WinBase/nf-winbase-createfiber) function.</span></span> <span data-ttu-id="1f8ed-120">Это значение округляется до ближайшей страницы.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-120">This value is rounded up to the nearest page.</span></span> <span data-ttu-id="1f8ed-121">Как правило, резервный размер является резервным размером по умолчанию, указанным в заголовке исполняемого файла.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-121">Generally, the reserve size is the default reserve size specified in the executable header.</span></span> <span data-ttu-id="1f8ed-122">Однако если первоначально зафиксированный размер, заданный параметром *двстакксизе* , больше или равен размеру резерва по умолчанию, то резервный размер равен этому новому размеру фиксации, округленному до ближайшего числа, кратного 1 МБ.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-122">However, if the initially committed size specified by *dwStackSize* is larger than or equal to the default reserve size, the reserve size is this new commit size rounded up to the nearest multiple of 1 MB.</span></span>

<span data-ttu-id="1f8ed-123">Чтобы изменить зарезервированный размер стека, установите параметр *двкреатионфлагс* для [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread) или [**креатеремотесреад**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread) в качестве значения параметра размера стека \_ \_ \_ — \_ \_ резервирование и используйте параметр *двстакксизе* .</span><span class="sxs-lookup"><span data-stu-id="1f8ed-123">To change the reserved stack size, set the *dwCreationFlags* parameter of [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread) or [**CreateRemoteThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread) to STACK\_SIZE\_PARAM\_IS\_A\_RESERVATION and use the *dwStackSize* parameter.</span></span> <span data-ttu-id="1f8ed-124">В этом случае исходный зафиксированный размер является размером по умолчанию, указанным в заголовке исполняемого файла.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-124">In this case, the initially committed size is the default size specified in the executable header.</span></span> <span data-ttu-id="1f8ed-125">Для волокон используйте параметр *двстаккресервесизе* объекта [**креатефиберекс**](/windows/desktop/api/WinBase/nf-winbase-createfiberex).</span><span class="sxs-lookup"><span data-stu-id="1f8ed-125">For fibers, use the *dwStackReserveSize* parameter of [**CreateFiberEx**](/windows/desktop/api/WinBase/nf-winbase-createfiberex).</span></span> <span data-ttu-id="1f8ed-126">Зафиксированный размер указывается в параметре *двстакккоммитсизе* .</span><span class="sxs-lookup"><span data-stu-id="1f8ed-126">The committed size is specified in the *dwStackCommitSize* parameter.</span></span>

<span data-ttu-id="1f8ed-127">Функция [**сетсреадстаккгуаранти**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadstackguarantee) устанавливает минимальный размер стека, связанного с вызывающим потоком или волокно, который будет доступен во время любых исключений переполнения стека.</span><span class="sxs-lookup"><span data-stu-id="1f8ed-127">The [**SetThreadStackGuarantee**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadstackguarantee) function sets the minimum size of the stack associated with the calling thread or fiber that will be available during any stack overflow exceptions.</span></span>

 

 
