---
description: Существует множество приложений, которые создают потоки, которые тратят много времени в спящем режиме, ожидая возникновения события.
ms.assetid: a5e52080-35d4-47f5-9050-90889e3bf2f8
title: Группировка потоков в пул
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: bcf3565401dc57b077e333043861d42b683e810c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103909667"
---
# <a name="thread-pooling"></a>Группировка потоков в пул

Существует множество приложений, которые создают потоки, которые тратят много времени в спящем режиме, ожидая возникновения события. Другие потоки могут войти в спящее состояние только для периодического опроса на наличие изменений или сведений о состоянии обновления. *Пул потоков* позволяет более эффективно использовать потоки, предоставляя приложению пул рабочих потоков, управляемых системой. По крайней мере один поток отслеживает состояние всех операций ожидания, поставленных в очередь пула потоков. По завершении операции ожидания рабочий поток из пула потоков выполняет соответствующую функцию обратного вызова.

В этом разделе описывается исходный API пула потоков. API пула потоков, появившийся в Windows Vista, более простой, более надежный, имеет лучшую производительность и обеспечивает большую гибкость для разработчиков. Сведения о текущем API пула потоков см. в разделе [Пулы потоков](thread-pools.md).

Кроме того, можно ставить в очередь рабочие элементы, не связанные с операцией ожидания, в пул потоков. Чтобы запросить обработку рабочего элемента потоком в пуле потоков, вызовите функцию [**QueueUserWorkItem**](/windows/win32/api/threadpoollegacyapiset/nf-threadpoollegacyapiset-queueuserworkitem) . Эта функция принимает в функцию параметр, который будет вызываться потоком, выбранным из пула потоков. Невозможно отменить рабочий элемент после его постановки в очередь.

Таймеры [очереди](../sync/timer-queues.md) и [зарегистрированные операции ожидания](../sync/wait-functions.md) также используют пул потоков. Функции обратного вызова помещаются в очередь пула потоков. Можно также использовать функцию [**BindIoCompletionCallback**](/windows/desktop/api/WinBase/nf-winbase-bindiocompletioncallback) для выполнения операций асинхронного ввода-вывода. По завершении операции ввода-вывода обратный вызов выполняется потоком пула потоков.

Пул потоков создается при первом вызове метода [**QueueUserWorkItem**](/windows/win32/api/threadpoollegacyapiset/nf-threadpoollegacyapiset-queueuserworkitem) или [**BindIoCompletionCallback**](/windows/desktop/api/WinBase/nf-winbase-bindiocompletioncallback), а также когда таймер очереди таймера или зарегистрированная операция ожидания помещает функцию обратного вызова в очередь. По умолчанию число потоков, которые могут быть созданы в пуле потоков, составляет примерно 500. Каждый поток использует размер стека по умолчанию и выполняется с приоритетом по умолчанию.

В пуле потоков существует два типа рабочих потоков: операции ввода-вывода и неоперации ввода-вывода. *Рабочий поток ввода-вывода* — это поток, который ожидает состояния ожидания с оповещением. Рабочие элементы помещаются в очередь рабочих потоков ввода-вывода в виде асинхронных вызовов процедур (APC). Необходимо поместить рабочий элемент в очередь в рабочий поток ввода-вывода, если он должен выполняться в потоке, который ожидает оповещения в состоянии.

*Рабочий поток, не связанный с вводом-выводом* , ожидает порты завершения ввода-вывода. Использование рабочих потоков, не связанных с вводом-выводом, является более эффективным, чем использование рабочих потоков ввода-вывода. Поэтому, когда это возможно, следует использовать рабочие потоки, не являющиеся операциями ввода-вывода. Рабочие потоки ввода-вывода и не-O не завершают работу, если ожидаются асинхронные запросы ввода-вывода. Оба типа потоков могут использоваться рабочими элементами, которые инициируют асинхронные запросы на завершение операций ввода-вывода. Однако следует избегать выполнения асинхронных запросов на завершение операций ввода-вывода в рабочих потоках, не относящихся к операции ввода-вывода, если это может занять много времени.

Для использования пула потоков рабочие элементы и все функции, которые они вызывают, должны быть надежными в пуле потоков. В защищенной функции не предполагается, что поток, выполняющий эту функцию, является выделенным или постоянным потоком. Как правило, следует избегать использования [локального хранилища потока](thread-local-storage.md) или асинхронного вызова, требующего постоянного потока, например функции [**регнотифичанжекэйвалуе**](/windows/win32/api/winreg/nf-winreg-regnotifychangekeyvalue) . Однако такие функции могут вызываться для выделенного потока (созданного приложением) или помещены в очередь постоянного рабочего потока (с помощью [**QueueUserWorkItem**](/windows/win32/api/threadpoollegacyapiset/nf-threadpoollegacyapiset-queueuserworkitem) с \_ параметром WT ексекутеинперсистентсреад).

## <a name="related-topics"></a>См. также

<dl> <dt>

[Ввод-вывод с оповещением](../fileio/alertable-i-o.md)
</dt> <dt>

[Асинхронные вызовы процедур](../sync/asynchronous-procedure-calls.md)
</dt> <dt>

[Порты завершения ввода-вывода](../fileio/i-o-completion-ports.md)
</dt> <dt>

[Пулы потоков](thread-pools.md)
</dt> </dl>

 

 
