---
description: Каждый процесс имеет кучу по умолчанию, предоставляемую системой. Приложения, которые часто выделяют из кучи, могут повысить производительность с помощью частных куч.
ms.assetid: cfb683fa-4f46-48b5-9a28-f4625a9cb8cd
title: Функции кучи
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d0e591c1e349ed6806cbebe00a178a99e63bb412
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103909479"
---
# <a name="heap-functions"></a><span data-ttu-id="78b7c-104">Функции кучи</span><span class="sxs-lookup"><span data-stu-id="78b7c-104">Heap Functions</span></span>

<span data-ttu-id="78b7c-105">Каждый процесс имеет кучу по умолчанию, предоставляемую системой.</span><span class="sxs-lookup"><span data-stu-id="78b7c-105">Each process has a default heap provided by the system.</span></span> <span data-ttu-id="78b7c-106">Приложения, которые часто выделяют из кучи, могут повысить производительность с помощью частных куч.</span><span class="sxs-lookup"><span data-stu-id="78b7c-106">Applications that make frequent allocations from the heap can improve performance by using private heaps.</span></span>

<span data-ttu-id="78b7c-107">Частная куча — это блок из одной или нескольких страниц в адресном пространстве вызывающего процесса.</span><span class="sxs-lookup"><span data-stu-id="78b7c-107">A private heap is a block of one or more pages in the address space of the calling process.</span></span> <span data-ttu-id="78b7c-108">После создания закрытой кучи процесс использует такие функции, как [**хеапаллок**](/windows/desktop/api/HeapApi/nf-heapapi-heapalloc) и [**хеапфри**](/windows/desktop/api/HeapApi/nf-heapapi-heapfree) , для управления памятью в этой куче.</span><span class="sxs-lookup"><span data-stu-id="78b7c-108">After creating the private heap, the process uses functions such as [**HeapAlloc**](/windows/desktop/api/HeapApi/nf-heapapi-heapalloc) and [**HeapFree**](/windows/desktop/api/HeapApi/nf-heapapi-heapfree) to manage the memory in that heap.</span></span>

<span data-ttu-id="78b7c-109">Функции кучи также можно использовать для управления памятью в куче процесса по умолчанию с помощью маркера, возвращаемого функцией [**жетпроцесшеап**](/windows/desktop/api/HeapApi/nf-heapapi-getprocessheap) .</span><span class="sxs-lookup"><span data-stu-id="78b7c-109">The heap functions can also be used to manage memory in the process's default heap, using the handle returned by the [**GetProcessHeap**](/windows/desktop/api/HeapApi/nf-heapapi-getprocessheap) function.</span></span> <span data-ttu-id="78b7c-110">Для этой цели новые приложения должны использовать функции кучи вместо [глобальных и локальных функций](global-and-local-functions.md) .</span><span class="sxs-lookup"><span data-stu-id="78b7c-110">New applications should use the heap functions instead of the [global and local functions](global-and-local-functions.md) for this purpose.</span></span>

<span data-ttu-id="78b7c-111">Между памятью, выделенной из закрытой кучи и выделенной с помощью других функций выделения памяти, нет различий.</span><span class="sxs-lookup"><span data-stu-id="78b7c-111">There is no difference between memory allocated from a private heap and that allocated by using the other memory allocation functions.</span></span> <span data-ttu-id="78b7c-112">Полный список функций см. в таблице [функции управления памятью](memory-management-functions.md).</span><span class="sxs-lookup"><span data-stu-id="78b7c-112">For a complete list of functions, see the table in [Memory Management Functions](memory-management-functions.md).</span></span>

> [!Note]  
> <span data-ttu-id="78b7c-113">Поток должен вызывать функции кучи только для кучи процесса по умолчанию и закрытых куч, которые создает и управляет потоком, используя дескрипторы, возвращаемые функцией [**жетпроцесшеап**](/windows/desktop/api/HeapApi/nf-heapapi-getprocessheap) или [**хеапкреате**](/windows/desktop/api/HeapApi/nf-heapapi-heapcreate) .</span><span class="sxs-lookup"><span data-stu-id="78b7c-113">A thread should call heap functions only for the process's default heap and private heaps that the thread creates and manages, using handles returned by the [**GetProcessHeap**](/windows/desktop/api/HeapApi/nf-heapapi-getprocessheap) or [**HeapCreate**](/windows/desktop/api/HeapApi/nf-heapapi-heapcreate) function.</span></span>

 

<span data-ttu-id="78b7c-114">Функция [**хеапкреате**](/windows/desktop/api/HeapApi/nf-heapapi-heapcreate) создает объект закрытой кучи, из которого вызывающий процесс может выделить блоки памяти с помощью функции [**хеапаллок**](/windows/desktop/api/HeapApi/nf-heapapi-heapalloc) .</span><span class="sxs-lookup"><span data-stu-id="78b7c-114">The [**HeapCreate**](/windows/desktop/api/HeapApi/nf-heapapi-heapcreate) function creates a private heap object from which the calling process can allocate memory blocks by using the [**HeapAlloc**](/windows/desktop/api/HeapApi/nf-heapapi-heapalloc) function.</span></span> <span data-ttu-id="78b7c-115">**Хеапкреате** задает исходный и максимальный размеры кучи.</span><span class="sxs-lookup"><span data-stu-id="78b7c-115">**HeapCreate** specifies both an initial size and a maximum size for the heap.</span></span> <span data-ttu-id="78b7c-116">Начальный размер определяет количество зафиксированных, прочитанных и записываемых страниц, изначально выделенных для кучи.</span><span class="sxs-lookup"><span data-stu-id="78b7c-116">The initial size determines the number of committed, read/write pages initially allocated for the heap.</span></span> <span data-ttu-id="78b7c-117">Максимальный размер определяет общее число зарезервированных страниц.</span><span class="sxs-lookup"><span data-stu-id="78b7c-117">The maximum size determines the total number of reserved pages.</span></span> <span data-ttu-id="78b7c-118">Эти страницы создают непрерывный блок в виртуальном адресном пространстве процесса, в котором может расти куча.</span><span class="sxs-lookup"><span data-stu-id="78b7c-118">These pages create a contiguous block in the virtual address space of a process into which the heap can grow.</span></span> <span data-ttu-id="78b7c-119">Дополнительные страницы автоматически фиксируются из этого зарезервированного пространства, если запросы по **хеапаллок** превышают текущий размер зафиксированных страниц, предполагая, что физическое хранилище для него доступно.</span><span class="sxs-lookup"><span data-stu-id="78b7c-119">Additional pages are automatically committed from this reserved space if requests by **HeapAlloc** exceed the current size of committed pages, assuming that the physical storage for it is available.</span></span> <span data-ttu-id="78b7c-120">После фиксации страницы не будут выделены до завершения процесса или до уничтожения кучи путем вызова функции [**хеапдестрой**](/windows/desktop/api/HeapApi/nf-heapapi-heapdestroy) .</span><span class="sxs-lookup"><span data-stu-id="78b7c-120">Once the pages are committed, they are not decommitted until the process is terminated or until the heap is destroyed by calling the [**HeapDestroy**](/windows/desktop/api/HeapApi/nf-heapapi-heapdestroy) function.</span></span>

<span data-ttu-id="78b7c-121">Память объекта закрытой кучи доступна только создавшему его процессу.</span><span class="sxs-lookup"><span data-stu-id="78b7c-121">The memory of a private heap object is accessible only to the process that created it.</span></span> <span data-ttu-id="78b7c-122">Если библиотека динамической компоновки (DLL) создает частную кучу, она делает это в адресном пространстве процесса, вызвавшего библиотеку DLL.</span><span class="sxs-lookup"><span data-stu-id="78b7c-122">If a dynamic-link library (DLL) creates a private heap, it does so in the address space of the process that called the DLL.</span></span> <span data-ttu-id="78b7c-123">Он доступен только для этого процесса.</span><span class="sxs-lookup"><span data-stu-id="78b7c-123">It is accessible only to that process.</span></span>

<span data-ttu-id="78b7c-124">Функция [**хеапаллок**](/windows/desktop/api/HeapApi/nf-heapapi-heapalloc) выделяет указанное число байтов из закрытой кучи и возвращает указатель на выделенный блок.</span><span class="sxs-lookup"><span data-stu-id="78b7c-124">The [**HeapAlloc**](/windows/desktop/api/HeapApi/nf-heapapi-heapalloc) function allocates a specified number of bytes from a private heap and returns a pointer to the allocated block.</span></span> <span data-ttu-id="78b7c-125">Этот указатель можно использовать в функциях [**хеапфри**](/windows/desktop/api/HeapApi/nf-heapapi-heapfree), [**хеапреаллок**](/windows/desktop/api/HeapApi/nf-heapapi-heaprealloc), [**хеапсизе**](/windows/desktop/api/HeapApi/nf-heapapi-heapsize)и [**хеапвалидате**](/windows/desktop/api/HeapApi/nf-heapapi-heapvalidate) .</span><span class="sxs-lookup"><span data-stu-id="78b7c-125">This pointer can be used in the [**HeapFree**](/windows/desktop/api/HeapApi/nf-heapapi-heapfree), [**HeapReAlloc**](/windows/desktop/api/HeapApi/nf-heapapi-heaprealloc), [**HeapSize**](/windows/desktop/api/HeapApi/nf-heapapi-heapsize), and [**HeapValidate**](/windows/desktop/api/HeapApi/nf-heapapi-heapvalidate) functions.</span></span>

<span data-ttu-id="78b7c-126">Память, выделенная [**хеапаллок**](/windows/desktop/api/HeapApi/nf-heapapi-heapalloc) , не может быть перемещена.</span><span class="sxs-lookup"><span data-stu-id="78b7c-126">Memory allocated by [**HeapAlloc**](/windows/desktop/api/HeapApi/nf-heapapi-heapalloc) is not movable.</span></span> <span data-ttu-id="78b7c-127">Адрес, возвращаемый функцией **хеапаллок** , действителен до освобождения или повторного выделения блока памяти; блок памяти не обязательно должен быть заблокирован.</span><span class="sxs-lookup"><span data-stu-id="78b7c-127">The address returned by **HeapAlloc** is valid until the memory block is freed or reallocated; the memory block does not need to be locked.</span></span>

<span data-ttu-id="78b7c-128">Поскольку система не может сжать частную кучу, она может стать фрагментированной.</span><span class="sxs-lookup"><span data-stu-id="78b7c-128">Because the system cannot compact a private heap, it can become fragmented.</span></span> <span data-ttu-id="78b7c-129">Приложения, которые выделяют большие объемы памяти в различных размерах выделения, могут использовать [кучу с низкой фрагментацией](low-fragmentation-heap.md) для уменьшения фрагментации кучи.</span><span class="sxs-lookup"><span data-stu-id="78b7c-129">Applications that allocate large amounts of memory in various allocation sizes can use the [low-fragmentation heap](low-fragmentation-heap.md) to reduce heap fragmentation.</span></span>

<span data-ttu-id="78b7c-130">Можно использовать функции кучи, чтобы создать частную кучу при запуске процесса, указав начальный размер, достаточный для удовлетворения требований к памяти процесса.</span><span class="sxs-lookup"><span data-stu-id="78b7c-130">A possible use for the heap functions is to create a private heap when a process starts up, specifying an initial size sufficient to satisfy the memory requirements of the process.</span></span> <span data-ttu-id="78b7c-131">Если вызов функции [**хеапкреате**](/windows/desktop/api/HeapApi/nf-heapapi-heapcreate) завершается с ошибкой, процесс может прервать или уведомить пользователя о нехватке памяти; Тем не менее, если она выполняется, процесс может быть уверен в наличии памяти.</span><span class="sxs-lookup"><span data-stu-id="78b7c-131">If the call to the [**HeapCreate**](/windows/desktop/api/HeapApi/nf-heapapi-heapcreate) function fails, the process can terminate or notify the user of the memory shortage; if it succeeds, however, the process is assured of having the memory it needs.</span></span>

<span data-ttu-id="78b7c-132">Память, запрошенная [**хеапкреате**](/windows/desktop/api/HeapApi/nf-heapapi-heapcreate) , может быть или не быть непрерывной.</span><span class="sxs-lookup"><span data-stu-id="78b7c-132">Memory requested by [**HeapCreate**](/windows/desktop/api/HeapApi/nf-heapapi-heapcreate) may or may not be contiguous.</span></span> <span data-ttu-id="78b7c-133">Память, выделенная в куче [**хеапаллок**](/windows/desktop/api/HeapApi/nf-heapapi-heapalloc) , является непрерывной.</span><span class="sxs-lookup"><span data-stu-id="78b7c-133">Memory allocated within a heap by [**HeapAlloc**](/windows/desktop/api/HeapApi/nf-heapapi-heapalloc) is contiguous.</span></span> <span data-ttu-id="78b7c-134">Не следует выполнять запись или чтение из памяти в куче, за исключением того, что выделяется **хеапаллок**, а также не следует рассчитывать отношения между двумя областями памяти, выделенными **хеапаллок**.</span><span class="sxs-lookup"><span data-stu-id="78b7c-134">You should not write to or read from memory in a heap except that allocated by **HeapAlloc**, nor should you assume any relationship between two areas of memory allocated by **HeapAlloc**.</span></span>

<span data-ttu-id="78b7c-135">Не следует ссылаться ни на один из способов памяти, освобожденных [**хеапфри**](/windows/desktop/api/HeapApi/nf-heapapi-heapfree).</span><span class="sxs-lookup"><span data-stu-id="78b7c-135">You should not refer in any way to memory that has been freed by [**HeapFree**](/windows/desktop/api/HeapApi/nf-heapapi-heapfree).</span></span> <span data-ttu-id="78b7c-136">После высвобождения памяти все данные, которые могли быть в ней, исчезнут.</span><span class="sxs-lookup"><span data-stu-id="78b7c-136">After the memory is freed, any information that may have been in it is gone forever.</span></span> <span data-ttu-id="78b7c-137">Если требуются сведения, не освобождайте память, содержащую сведения.</span><span class="sxs-lookup"><span data-stu-id="78b7c-137">If you require information, do not free memory containing the information.</span></span> <span data-ttu-id="78b7c-138">Вызовы функций, возвращающие сведения о памяти (например, [**хеапсизе**](/windows/desktop/api/HeapApi/nf-heapapi-heapsize)), могут не использоваться с освобожденной памятью, так как они могут возвращать фиктивные данные.</span><span class="sxs-lookup"><span data-stu-id="78b7c-138">Function calls that return information about memory (such as [**HeapSize**](/windows/desktop/api/HeapApi/nf-heapapi-heapsize)) may not be used with freed memory, as they may return bogus data.</span></span>

<span data-ttu-id="78b7c-139">Функция [**хеапдестрой**](/windows/desktop/api/HeapApi/nf-heapapi-heapdestroy) уничтожает объект закрытой кучи.</span><span class="sxs-lookup"><span data-stu-id="78b7c-139">The [**HeapDestroy**](/windows/desktop/api/HeapApi/nf-heapapi-heapdestroy) function destroys a private heap object.</span></span> <span data-ttu-id="78b7c-140">Он отменяет фиксацию и освобождает все страницы объекта heap и делает дескриптор кучи недействительным.</span><span class="sxs-lookup"><span data-stu-id="78b7c-140">It decommits and releases all the pages of the heap object, and it invalidates the handle to the heap.</span></span>

## <a name="related-topics"></a><span data-ttu-id="78b7c-141">См. также</span><span class="sxs-lookup"><span data-stu-id="78b7c-141">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="78b7c-142">Сравнение методов выделения памяти</span><span class="sxs-lookup"><span data-stu-id="78b7c-142">Comparing Memory Allocation Methods</span></span>](comparing-memory-allocation-methods.md)
</dt> </dl>

 

 



