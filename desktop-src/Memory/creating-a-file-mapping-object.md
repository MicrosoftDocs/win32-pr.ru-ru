---
description: Первым шагом при сопоставлении файла является открытие файла путем вызова функции CreateFile.
ms.assetid: e00d8742-b717-419c-902c-9a286d75d8aa
title: Создание объекта сопоставления файлов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c54e32f62be48f2957e2f3d6f12a3da91b49793e
ms.sourcegitcommit: 5f0167ce703bc477a11c3b58db04df99c8fd5000
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/07/2021
ms.locfileid: "111563220"
---
# <a name="creating-a-file-mapping-object"></a><span data-ttu-id="c8bb5-103">Создание объекта сопоставления файлов</span><span class="sxs-lookup"><span data-stu-id="c8bb5-103">Creating a File Mapping Object</span></span>

<span data-ttu-id="c8bb5-104">Первым шагом при сопоставлении файла является открытие файла путем вызова функции [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea) .</span><span class="sxs-lookup"><span data-stu-id="c8bb5-104">The first step in mapping a file is to open the file by calling the [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea) function.</span></span> <span data-ttu-id="c8bb5-105">Чтобы другие процессы не могут выполнять запись в часть сопоставленного файла, следует открыть файл с монопольным доступом.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-105">To ensure that other processes cannot write to the portion of the file that is mapped, you should open the file with exclusive access.</span></span> <span data-ttu-id="c8bb5-106">Кроме того, этот обработчик файлов должен оставаться открытым до тех пор, пока процессу больше не требуется объект сопоставления файлов.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-106">In addition, the file handle should remain open until the process no longer needs the file mapping object.</span></span> <span data-ttu-id="c8bb5-107">Простой способ получить эксклюзивный доступ — указать ноль в параметре *Фдвшаремоде* **CreateFile**.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-107">An easy way to obtain exclusive access is to specify zero in the *fdwShareMode* parameter of **CreateFile**.</span></span> <span data-ttu-id="c8bb5-108">Маркер, возвращаемый **CreateFile** , используется функцией [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) для создания объекта сопоставления файлов.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-108">The handle returned by **CreateFile** is used by the [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) function to create a file mapping object.</span></span>

<span data-ttu-id="c8bb5-109">Функция [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) возвращает маркер объекта сопоставления файлов.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-109">The [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) function returns a handle to the file mapping object.</span></span> <span data-ttu-id="c8bb5-110">Этот маркер будет использоваться при [создании представления файлов](creating-a-file-view.md) для доступа к общей памяти.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-110">This handle will be used when [creating a file view](creating-a-file-view.md) so that you can access the shared memory.</span></span> <span data-ttu-id="c8bb5-111">При вызове **CreateFileMapping** указывается имя объекта, число байтов, которое должно быть сопоставлено из файла, а также разрешение на чтение и запись для сопоставленной памяти.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-111">When you call **CreateFileMapping**, you specify an object name, the number of bytes to be mapped from the file, and the read/write permission for the mapped memory.</span></span> <span data-ttu-id="c8bb5-112">Первый процесс, вызывающий **CreateFileMapping** , создает объект сопоставления файлов.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-112">The first process that calls **CreateFileMapping** creates the file mapping object.</span></span> <span data-ttu-id="c8bb5-113">Процессы, вызывающие **CreateFileMapping** для существующего объекта, получают маркер существующего объекта.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-113">Processes calling **CreateFileMapping** for an existing object receive a handle to the existing object.</span></span> <span data-ttu-id="c8bb5-114">Вы можете определить, был ли успешно вызван в **CreateFileMapping** создание или открытие объекта сопоставления файлов путем вызова функции [**GetLastError**](/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror) .</span><span class="sxs-lookup"><span data-stu-id="c8bb5-114">You can tell whether or not a successful call to **CreateFileMapping** created or opened the file mapping object by calling the [**GetLastError**](/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror) function.</span></span> <span data-ttu-id="c8bb5-115">**GetLastError** **не возвращает \_ ошибку** в процесс создания, и **Ошибка \_ уже \_ существует** для последующих процессов.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-115">**GetLastError** returns **NO\_ERROR** to the creating process and **ERROR\_ALREADY\_EXISTS** to subsequent processes.</span></span>

<span data-ttu-id="c8bb5-116">Функция [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) завершается ошибкой, если флаги доступа конфликтуют с указанными при открытии файла функцией [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea) .</span><span class="sxs-lookup"><span data-stu-id="c8bb5-116">The [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) function fails if the access flags conflict with those specified when the [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea) function opened the file.</span></span> <span data-ttu-id="c8bb5-117">Например, для чтения и записи в файл:</span><span class="sxs-lookup"><span data-stu-id="c8bb5-117">For example, to read and write to the file:</span></span>

-   <span data-ttu-id="c8bb5-118">Укажите **универсальные значения \_ чтения** и **универсальные \_ записи** в параметре *фдвакцесс* [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea).</span><span class="sxs-lookup"><span data-stu-id="c8bb5-118">Specify the **GENERIC\_READ** and **GENERIC\_WRITE** values in the *fdwAccess* parameter of [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea).</span></span>
-   <span data-ttu-id="c8bb5-119">Укажите значение **\_ ReadWrite для страницы** в параметре *фдвпротект* объекта [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga).</span><span class="sxs-lookup"><span data-stu-id="c8bb5-119">Specify the **PAGE\_READWRITE** value in the *fdwProtect* parameter of [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga).</span></span>

<span data-ttu-id="c8bb5-120">Создание объекта сопоставления файлов не фиксирует физическую память, а только резервирует его.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-120">Creating a file mapping object does not commit physical memory, it only reserves it.</span></span>

## <a name="file-mapping-size"></a><span data-ttu-id="c8bb5-121">Размер сопоставления файлов</span><span class="sxs-lookup"><span data-stu-id="c8bb5-121">File Mapping Size</span></span>

<span data-ttu-id="c8bb5-122">Размер объекта сопоставления файлов не зависит от размера сопоставляемого файла.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-122">The size of the file mapping object is independent of the size of the file being mapped.</span></span> <span data-ttu-id="c8bb5-123">Однако если объект сопоставления файлов больше, чем файл, система расширяет файл до возврата [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) .</span><span class="sxs-lookup"><span data-stu-id="c8bb5-123">However, if the file mapping object is larger than the file, the system expands the file before [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) returns.</span></span> <span data-ttu-id="c8bb5-124">Если объект сопоставления файлов меньше, чем файл, система сопоставляется только с указанным числом байтов из файла.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-124">If the file mapping object is smaller than the file, the system maps only the specified number of bytes from the file.</span></span>

<span data-ttu-id="c8bb5-125">Параметры *двмаксимумсизехигх* и *двмаксимумсизелов* [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) позволяют указать число байтов, которое должно быть сопоставлено с файлом:</span><span class="sxs-lookup"><span data-stu-id="c8bb5-125">The *dwMaximumSizeHigh* and *dwMaximumSizeLow* parameters of [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) allow you to specify the number of bytes to be mapped from the file:</span></span>

-   <span data-ttu-id="c8bb5-126">Если размер файла не должен изменяться (например, при сопоставлении файлов, предназначенных только для чтения), вызовите [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) и укажите ноль для *двмаксимумсизехигх* и *двмаксимумсизелов*.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-126">When you do not want the size of the file to change (for example, when mapping read-only files), call [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) and specify zero for both *dwMaximumSizeHigh* and *dwMaximumSizeLow*.</span></span> <span data-ttu-id="c8bb5-127">При этом создается объект сопоставления файлов, размер которого совпадает с размером файла.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-127">Doing this creates a file mapping object that is exactly the same size as the file.</span></span> <span data-ttu-id="c8bb5-128">В противном случае необходимо вычислить или оценить размер готового файла, так как объекты сопоставления файлов являются статическими в размере. После создания их размер не может быть увеличен или уменьшен.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-128">Otherwise, you must calculate or estimate the size of the finished file because file mapping objects are static in size; once created, their size cannot be increased or decreased.</span></span> <span data-ttu-id="c8bb5-129">Попытка выполнить прикарту файла с нулевой длиной таким образом завершается ошибкой с кодом ошибки, **\_ \_ недопустимым в файле**.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-129">An attempt to map a file with a length of zero in this manner fails with an error code of **ERROR\_FILE\_INVALID**.</span></span> <span data-ttu-id="c8bb5-130">Программы должны проверять файлы с нулевой длиной и отклонять такие файлы.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-130">Programs should test for files with a length of zero and reject such files.</span></span>

-   <span data-ttu-id="c8bb5-131">Размер объекта сопоставления файлов, поддерживаемого именованным файлом, ограничен дисковым пространством.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-131">The size of a file mapping object that is backed by a named file is limited by disk space.</span></span> <span data-ttu-id="c8bb5-132">Размер представления файлов ограничен самым большим доступным непрерывным блоком незарезервированной виртуальной памяти.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-132">The size of a file view is limited to the largest available contiguous block of unreserved virtual memory.</span></span> <span data-ttu-id="c8bb5-133">Это не более 2 ГБ виртуальной памяти, уже зарезервированной процессом.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-133">This is at most 2 GB minus the virtual memory already reserved by the process.</span></span>

<span data-ttu-id="c8bb5-134">Размер объекта сопоставления файлов, который вы выбрали, определяет, насколько далеко в файле можно просмотреть сведения о сопоставлении памяти.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-134">The size of the file mapping object that you select controls how far into the file you can "see" with memory mapping.</span></span> <span data-ttu-id="c8bb5-135">Если вы создаете объект сопоставления файлов размером 500 КБ, у вас есть доступ только к первой 500 КБ файла, независимо от размера файла.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-135">If you create a file mapping object that is 500 Kb in size, you have access only to the first 500 Kb of the file, regardless of the size of the file.</span></span> <span data-ttu-id="c8bb5-136">Так как это не требует каких-либо системных ресурсов создавать объект сопоставления файлов большего размера, создайте объект сопоставления файлов, который является размером файла (задайте параметры *двмаксимумсизехигх* и *двмаксимумсизелов* [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) как ноль), даже если вы не планируете просматривать файл целиком.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-136">Since it does not cost you any system resources to create a larger file mapping object, create a file mapping object that is the size of the file (set the *dwMaximumSizeHigh* and *dwMaximumSizeLow* parameters of [**CreateFileMapping**](/windows/desktop/api/WinBase/nf-winbase-createfilemappinga) both to zero) even if you do not expect to view the entire file.</span></span> <span data-ttu-id="c8bb5-137">Стоимость системных ресурсов состоит в создании представлений и доступе к ним.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-137">The cost in system resources comes in creating the views and accessing them.</span></span>

<span data-ttu-id="c8bb5-138">Можно просмотреть часть файла, которая не начинается с начала файла.</span><span class="sxs-lookup"><span data-stu-id="c8bb5-138">You can view a portion of the file that does not start at the beginning of the file.</span></span> <span data-ttu-id="c8bb5-139">Дополнительные сведения см. в разделе [Создание представления в файле](creating-a-view-within-a-file.md).</span><span class="sxs-lookup"><span data-stu-id="c8bb5-139">For more information, see [Creating a View Within a File](creating-a-view-within-a-file.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="c8bb5-140">Связанные темы</span><span class="sxs-lookup"><span data-stu-id="c8bb5-140">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="c8bb5-141">Создание представления файлов</span><span class="sxs-lookup"><span data-stu-id="c8bb5-141">Creating a File View</span></span>](creating-a-file-view.md)
</dt> <dt>

[<span data-ttu-id="c8bb5-142">Создание представления в файле</span><span class="sxs-lookup"><span data-stu-id="c8bb5-142">Creating a View Within a File</span></span>](creating-a-view-within-a-file.md)
</dt> </dl>


 
