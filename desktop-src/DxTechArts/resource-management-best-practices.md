---
title: Рекомендации по управлению ресурсами
description: В этой статье рассматриваются рекомендации по работе с ресурсами, как правило, поведение управляемых и неуправляемых ресурсов, а также подробное описание того, как ресурсы обычно обрабатываются средой выполнения и драйверами.
ms.assetid: 265ae0b2-f268-a4a4-551e-9d3dae886517
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 27cdadb8cee3cb57f4208657054784937ecd1ea2
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "104338436"
---
# <a name="resource-management-best-practices"></a><span data-ttu-id="29d00-103">Рекомендации по управлению ресурсами</span><span class="sxs-lookup"><span data-stu-id="29d00-103">Resource Management Best Practices</span></span>

<span data-ttu-id="29d00-104">Управляемые текстуры, также известные как автоматическое управление текстурами, были доступны в DirectX с версии 6 с несколькими редакциями и улучшениями, внесенными в последующих выпусках.</span><span class="sxs-lookup"><span data-stu-id="29d00-104">Managed textures, also known as automatic texture management, have been available in DirectX since version 6, with several revisions and enhancements made in subsequent releases.</span></span> <span data-ttu-id="29d00-105">Начиная с версии API Direct3D 9, автоматическое управление ресурсами включает поддержку текстур, буферов вершин и буферов индексов с единообразным общим интерфейсом.</span><span class="sxs-lookup"><span data-stu-id="29d00-105">As of the release of the Direct3D 9 API, the automatic resource management includes support for textures, vertex buffers, and index buffers, all with a consistent shared interface.</span></span> <span data-ttu-id="29d00-106">С помощью диспетчера ресурсов Direct3D приложения могут значительно упростить обработку ситуаций, связанных с потерями устройств, и могут полагаться на систему для обработки разумного объема избыточных ресурсов памяти видео.</span><span class="sxs-lookup"><span data-stu-id="29d00-106">By using the Direct3D resource manager, applications can greatly simplify the handling of lost-device situations and can rely on the system to handle a reasonable amount of over-commitment of video memory resources.</span></span>

<span data-ttu-id="29d00-107">Разработчики иногда могут столкнуться с проблемами, используя управляемые ресурсы, частично из-за абстрактной природы системы.</span><span class="sxs-lookup"><span data-stu-id="29d00-107">Developers sometimes have difficulties using managed resources, in part due to the abstract nature of the system.</span></span> <span data-ttu-id="29d00-108">Хотя многие распространенные сценарии для ресурсов хорошо подходят для управляемых ресурсов, некоторые из них лучше использовать при использовании неуправляемых ресурсов.</span><span class="sxs-lookup"><span data-stu-id="29d00-108">While many common scenarios for resources are a good fit for managed resources, some cases perform better when using unmanaged resources.</span></span> <span data-ttu-id="29d00-109">В этой статье рассматриваются рекомендации по работе с ресурсами, как правило, поведение управляемых и неуправляемых ресурсов, а также подробное описание того, как ресурсы обычно обрабатываются средой выполнения и драйверами.</span><span class="sxs-lookup"><span data-stu-id="29d00-109">This article discusses best practices for dealing with resources generally, how managed and unmanaged resources behave, and provides some detail on how resources are typically handled by the runtime and drivers.</span></span>

<span data-ttu-id="29d00-110">В этой статье рассматриваются следующие понятия:</span><span class="sxs-lookup"><span data-stu-id="29d00-110">This article covers these concepts:</span></span>

-   [<span data-ttu-id="29d00-111">Видеопамять</span><span class="sxs-lookup"><span data-stu-id="29d00-111">Video Memory</span></span>](#video-memory)
-   [<span data-ttu-id="29d00-112">Управляемые ресурсы</span><span class="sxs-lookup"><span data-stu-id="29d00-112">Managed Resources</span></span>](#managed-resources)
-   [<span data-ttu-id="29d00-113">Ресурсы, управляемые драйвером</span><span class="sxs-lookup"><span data-stu-id="29d00-113">Driver-Managed Resources</span></span>](#driver-managed-resources)
-   [<span data-ttu-id="29d00-114">Ресурсы по умолчанию</span><span class="sxs-lookup"><span data-stu-id="29d00-114">Default Resources</span></span>](#default-resources)
    -   [<span data-ttu-id="29d00-115">Использование управляемых и ресурсов по умолчанию</span><span class="sxs-lookup"><span data-stu-id="29d00-115">Using Both Managed and Default Resources</span></span>](#using-both-managed-and-default-resources)
    -   [<span data-ttu-id="29d00-116">Динамические ресурсы по умолчанию</span><span class="sxs-lookup"><span data-stu-id="29d00-116">Dynamic Default Resources</span></span>](#dynamic-default-resources)
-   [<span data-ttu-id="29d00-117">Ресурсы системной памяти</span><span class="sxs-lookup"><span data-stu-id="29d00-117">System Memory Resources</span></span>](#system-memory-resources)
-   [<span data-ttu-id="29d00-118">Общие рекомендации</span><span class="sxs-lookup"><span data-stu-id="29d00-118">General Recommendations</span></span>](#general-recommendations)
-   [<span data-ttu-id="29d00-119">См. также</span><span class="sxs-lookup"><span data-stu-id="29d00-119">Related topics</span></span>](#related-topics)

## <a name="video-memory"></a><span data-ttu-id="29d00-120">Видеопамять</span><span class="sxs-lookup"><span data-stu-id="29d00-120">Video Memory</span></span>

<span data-ttu-id="29d00-121">Чтобы система видео использовала ресурс, она должна находиться в памяти, доступной для GPU.</span><span class="sxs-lookup"><span data-stu-id="29d00-121">For the video system to make use of a resource, it must be located in memory that is accessible to the GPU.</span></span> <span data-ttu-id="29d00-122">Локальная видеопамять обеспечивает наилучшую производительность GPU, а определенные ресурсы (например, целевые объекты отрисовки и буферы глубины и трафаретов) должны находиться в локальной видеопамяти.</span><span class="sxs-lookup"><span data-stu-id="29d00-122">Local video memory provides the best performance for the GPU, and certain resources (such as render targets and depth/stencil buffers) must be located in local video memory.</span></span> <span data-ttu-id="29d00-123">С появлением AGP графический процессор также может получить доступ к части системной памяти напрямую.</span><span class="sxs-lookup"><span data-stu-id="29d00-123">With the advent of AGP, the GPU can also access a portion of the system memory directly.</span></span> <span data-ttu-id="29d00-124">Эта область памяти, известная как Апертура AGP, называется нелокальной видеопамятью и недоступна для других целей.</span><span class="sxs-lookup"><span data-stu-id="29d00-124">This memory area, known as the AGP aperture, is referred to as non-local video memory and is not available for other purposes.</span></span> <span data-ttu-id="29d00-125">Нелокальная видеопамять может считываться и записываться ЦП, что обычно не имеет высокопроизводительного доступа к локальной видеопамяти, и поэтому идеально подходит для использования в качестве ресурса общей памяти.</span><span class="sxs-lookup"><span data-stu-id="29d00-125">Non-local video memory can be read from and written to by the CPU, which typically has no high-performance access to local video memory, and is thus ideal for use as a shared memory resource.</span></span> <span data-ttu-id="29d00-126">Важно помнить о том, что память AGP, как и локальная видеопамять, становится недействительной в ситуациях потерянных устройств, а постоянные ресурсы, расположенные там, должны быть восстановлены.</span><span class="sxs-lookup"><span data-stu-id="29d00-126">A key thing to remember about AGP memory is that it, like local video memory, is invalidated in lost-device situations, and persistent assets located there must be restored.</span></span>

<span data-ttu-id="29d00-127">**Рис. 1. Отношение GPU, ЦП, видеопамяти и ОЗУ системы**</span><span class="sxs-lookup"><span data-stu-id="29d00-127">**Figure 1. Relationship of the GPU, CPU, video RAM, and system RAM**</span></span>

![отношение GPU, ЦП, видеопамяти и ОЗУ системы](images/managingresources1.gif)

<span data-ttu-id="29d00-129">В некоторых интегрированных видеороликах используется унифицированная архитектура памяти, где основная память может быть адресациа всеми компонентами систем.</span><span class="sxs-lookup"><span data-stu-id="29d00-129">Some integrated video solutions make use of a unified memory architecture (UMA), where main memory is addressable by all components of the systems.</span></span> <span data-ttu-id="29d00-130">Direct3D поддерживает установку без внесения каких либо изменений в приложение, используя те же советы, что и для конфигураций локальной видеопамяти.</span><span class="sxs-lookup"><span data-stu-id="29d00-130">Direct3D supports UMA without requiring any change to the application, utilizing the same hints as for local video memory configurations.</span></span> <span data-ttu-id="29d00-131">В таких системах ресурсы всегда находятся в системной памяти, и драйвер отвечает за то, чтобы ресурсы работали примерно так же, как в более традиционной архитектуре, в то же время используя свойства самой части и любое конкретное поведение аппаратной реализации.</span><span class="sxs-lookup"><span data-stu-id="29d00-131">For such systems, resources are always located in system memory, and the driver is responsible for ensuring that resources work much like they do in a more traditional architecture while taking advantage of UMA's properties and any specific behavior of the hardware implementation.</span></span>

<span data-ttu-id="29d00-132">**Рис. 2. GPU и ЦП имеют равный доступ к системной памяти в архитектуре единой памяти**</span><span class="sxs-lookup"><span data-stu-id="29d00-132">**Figure 2. GPU and CPU have equal access to system RAM in a unified memory architecture**</span></span>

![GPU и ЦП имеют равный доступ к системной памяти в архитектуре единой памяти](images/managingresources2.gif)

## <a name="managed-resources"></a><span data-ttu-id="29d00-134">Управляемые ресурсы</span><span class="sxs-lookup"><span data-stu-id="29d00-134">Managed Resources</span></span>

<span data-ttu-id="29d00-135">Большая часть ресурсов должна быть создана как управляемые ресурсы в \_ управляемом пуле.</span><span class="sxs-lookup"><span data-stu-id="29d00-135">The majority of your resources should be created as managed resources in POOL\_MANAGED.</span></span> <span data-ttu-id="29d00-136">Все ресурсы будут созданы в системной памяти и скопированы в видеопамяти по мере необходимости.</span><span class="sxs-lookup"><span data-stu-id="29d00-136">All your resources will be created in system memory and then copied as needed into video memory.</span></span> <span data-ttu-id="29d00-137">Потерянные устройства будут автоматически обрабатываться из копии системной памяти.</span><span class="sxs-lookup"><span data-stu-id="29d00-137">Lost-device situations will be handled automatically from the system memory copy.</span></span> <span data-ttu-id="29d00-138">Так как не все управляемые ресурсы должны помещаться в видеопамять, можно чрезмерно зафиксировать память, в которой для отображения в любом кадре достаточно меньше рабочего набора ресурсов видеопамяти.</span><span class="sxs-lookup"><span data-stu-id="29d00-138">Since not all managed resources are required to fit into video memory all at once, you can over-commit memory where a smaller video memory working set of resources is all that is required to render in any given frame.</span></span> <span data-ttu-id="29d00-139">Обратите внимание, что большая часть этого резервного копирования системной памяти будет выдаваться на диск с течением времени, поэтому выполнение операции сброса может оказаться слишком длительным из-за необходимости вернуть эти данные для восстановления потерянной видеопамяти.</span><span class="sxs-lookup"><span data-stu-id="29d00-139">Note that it is likely that the majority of this backing-store system memory will be paged out to disk over time, which is why the Reset operation can be slow due to the need to page this data back in to restore the lost video memory.</span></span>

<span data-ttu-id="29d00-140">Среда выполнения сохраняет метку времени для последнего использования ресурса, и при сбое выделения видеопамяти для загрузки необходимого управляемого ресурса он будет освобождать ресурсы на основе этой метки времени LRU.</span><span class="sxs-lookup"><span data-stu-id="29d00-140">The runtime keeps a timestamp for the last time a resource is used, and when a video memory allocation fails for loading a needed managed resource, it will release resources based on this timestamp in a LRU fashion.</span></span> <span data-ttu-id="29d00-141">Использование [**SetPriority**](/windows/desktop/api/d3d9helper/nf-d3d9helper-idirect3dresource9-setpriority) имеет приоритет над отметкой времени, поэтому для более часто используемых ресурсов должно быть задано более высокое значение приоритета.</span><span class="sxs-lookup"><span data-stu-id="29d00-141">Usage of [**SetPriority**](/windows/desktop/api/d3d9helper/nf-d3d9helper-idirect3dresource9-setpriority) takes precedence over the timestamp, so more commonly used resources should be set to a higher priority value.</span></span> <span data-ttu-id="29d00-142">Direct3D 9,0 имеет ограниченную информацию о видеопамяти, управляемой драйвером, поэтому среде выполнения может потребоваться исключить несколько ресурсов, чтобы создать достаточно большой регион для выполнения выделения.</span><span class="sxs-lookup"><span data-stu-id="29d00-142">Direct3D 9.0 has limited information about the video memory managed by the driver, so the runtime may need to evict several resources to create a large enough region for the allocation to succeed.</span></span> <span data-ttu-id="29d00-143">Правильные приоритеты могут помочь в устранении ситуаций, когда что-то будет вытеснено, а затем снова потребуется в ближайшее время.</span><span class="sxs-lookup"><span data-stu-id="29d00-143">Proper priorities can help eliminate situations where something gets evicted and then is required again shortly thereafter.</span></span> <span data-ttu-id="29d00-144">Приложение также может вызвать [**евиктманажедресаурцес**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-evictmanagedresources) , чтобы принудительно удалить все управляемые ресурсы.</span><span class="sxs-lookup"><span data-stu-id="29d00-144">The application can also call [**EvictManagedResources**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-evictmanagedresources) to force all the managed resources to be removed.</span></span> <span data-ttu-id="29d00-145">Опять же, это может быть трудоемкой операцией для повторной загрузки всех ресурсов, необходимых для следующего кадра, но она очень полезна для переходов на уровне, где рабочий набор значительно меняется, а также для удаления фрагментации видеопамяти.</span><span class="sxs-lookup"><span data-stu-id="29d00-145">Again, this can be a time-consuming operation to reload all the resources required for the next frame, but is very useful for level transitions where the working set changes significantly and for removing video memory fragmentation.</span></span>

<span data-ttu-id="29d00-146">Число кадров также сохраняется, чтобы среда выполнения определяла, использовался ли ресурс, который был выбран для исключения, в начале текущего кадра, что подразумевает пробуксовка ситуацию, когда больше ресурсов используется в одном кадре, чем помещается в видеопамять.</span><span class="sxs-lookup"><span data-stu-id="29d00-146">A frame count is also kept to allow the runtime to detect if the resource it just chose to evict was used early the current frame, which implies a thrashing situation where more resources are in use in a single frame than will fit into video memory.</span></span> <span data-ttu-id="29d00-147">Это активирует политику замены, чтобы переключиться на MRU, а не LRU для оставшейся части кадра, так как это, как правило, выполняется немного лучше при таких условиях.</span><span class="sxs-lookup"><span data-stu-id="29d00-147">This triggers the replacement policy to switch to a MRU fashion rather than LRU for the remainder of the frame as this tends to perform slightly better under such conditions.</span></span> <span data-ttu-id="29d00-148">Такое поведение пробуксовка существенно влияет на производительность отрисовки.</span><span class="sxs-lookup"><span data-stu-id="29d00-148">Such thrashing behavior will significantly impact the rendering performance.</span></span> <span data-ttu-id="29d00-149">Обратите внимание, что понятие текущего кадра привязано к [**ендсцене**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-endscene), поэтому любое приложение, использующее управляемые ресурсы, должно выполнять регулярные вызовы этого метода.</span><span class="sxs-lookup"><span data-stu-id="29d00-149">Note that the notion of current frame is tied to [**EndScene**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-endscene), so any application making use of managed resources needs to make regular calls to this method.</span></span>

<span data-ttu-id="29d00-150">Разработчики, стремящиеся найти дополнительные сведения о том, как управляемые ресурсы работают в своем приложении, могут использовать запрос события RESOURCEMANAGER через интерфейс [**IDirect3DQuery9**](/windows/desktop/api/d3d9helper/nn-d3d9helper-idirect3dquery9) .</span><span class="sxs-lookup"><span data-stu-id="29d00-150">Developers looking to find more information about how managed resources are behaving in their application can make use of the RESOURCEMANAGER event query via the [**IDirect3DQuery9**](/windows/desktop/api/d3d9helper/nn-d3d9helper-idirect3dquery9) interface.</span></span> <span data-ttu-id="29d00-151">Это работает только при использовании сред выполнения отладки, поэтому эти сведения не могут зависеть от приложения, но предоставляют подробную информацию о ресурсах, управляемых средой выполнения.</span><span class="sxs-lookup"><span data-stu-id="29d00-151">This only works when using the debug runtimes, so this information cannot be depended upon by the application, but it provides deep detail on the resources managed by the runtime.</span></span>

<span data-ttu-id="29d00-152">Понимание того, как работает диспетчер ресурсов, может помочь при настройке и отладке приложений, важно не привязывать приложение слишком тесно к деталям реализации текущей среды выполнения или драйверов.</span><span class="sxs-lookup"><span data-stu-id="29d00-152">While understanding how the resource manager works can help when tuning and debugging your applications, it is important to not tie your application too tightly to the implementation details of the current runtime or drivers.</span></span> <span data-ttu-id="29d00-153">Редакции драйвера или изменения оборудования могут значительно изменить поведение, а будущие версии Direct3D будут значительно улучшены и сложнее управлять ресурсами.</span><span class="sxs-lookup"><span data-stu-id="29d00-153">Revisions of the driver or changes in hardware can significantly change the behavior, and future versions of Direct3D will have significantly improved and sophisticated resource management.</span></span>

## <a name="driver-managed-resources"></a><span data-ttu-id="29d00-154">Ресурсы Driver-Managed</span><span class="sxs-lookup"><span data-stu-id="29d00-154">Driver-Managed Resources</span></span>

<span data-ttu-id="29d00-155">Драйверы Direct3D можно использовать для реализации функции управления текстурами, управляемой драйвером, которая определяется D3DCAPS2 \_ канманажересаурце, что позволяет драйверу управлять ресурсами вместо среды выполнения.</span><span class="sxs-lookup"><span data-stu-id="29d00-155">Direct3D drivers are free to implement the driver managed textures capability, indicated by D3DCAPS2\_CANMANAGERESOURCE, which allows the driver to handle the resource management instead of the runtime.</span></span> <span data-ttu-id="29d00-156">Для драйвера (редких), который реализует эту функцию, точное поведение диспетчера ресурсов драйвера может сильно различаться, и вы должны обратиться к поставщику драйвера за сведениями о том, как это работает для своей реализации.</span><span class="sxs-lookup"><span data-stu-id="29d00-156">For the (rare) driver that implements this feature, the exact behavior of the driver's resource manager can vary widely, and you should contact the driver's vendor for details on how this works for their implementation.</span></span> <span data-ttu-id="29d00-157">Кроме того, можно гарантировать, что диспетчер среды выполнения всегда используется, указав D3DCREATE \_ Отключить \_ Управление драйверами \_ при создании устройства.</span><span class="sxs-lookup"><span data-stu-id="29d00-157">Alternatively, you can ensure that the runtime manager is always used instead by specifying D3DCREATE\_DISABLE\_DRIVER\_MANAGEMENT when creating the device.</span></span>

## <a name="default-resources"></a><span data-ttu-id="29d00-158">Ресурсы по умолчанию</span><span class="sxs-lookup"><span data-stu-id="29d00-158">Default Resources</span></span>

<span data-ttu-id="29d00-159">Хотя управляемые ресурсы просты, эффективны и просты в использовании, бывают случаи, когда использование видеопамяти является предпочтительным или даже обязательным.</span><span class="sxs-lookup"><span data-stu-id="29d00-159">While managed resources are simple, efficient, and easy to use, there are times when using video memory directly is preferred or even required.</span></span> <span data-ttu-id="29d00-160">Такие ресурсы создаются в \_ категории пула по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="29d00-160">Such resources are created in the POOL\_DEFAULT category.</span></span> <span data-ttu-id="29d00-161">Использование таких ресурсов приводит к дополнительным осложнениям приложения.</span><span class="sxs-lookup"><span data-stu-id="29d00-161">Making use of such resources does cause additional complications for your application.</span></span> <span data-ttu-id="29d00-162">Код необходим для работы с ситуацией потерянных устройств для всех \_ ресурсов пула по умолчанию, и при копировании в них данных необходимо учитывать вопросы производительности.</span><span class="sxs-lookup"><span data-stu-id="29d00-162">Code is required to cope with the lost-device situation for all the POOL\_DEFAULT resources, and performance considerations must be taken into account when copying data into them.</span></span> <span data-ttu-id="29d00-163">Невозможность указания использования \_ WRITEONLY или назначение блокируемого целевого объекта прорисовки также может накладывать серьезные штрафы в производительности.</span><span class="sxs-lookup"><span data-stu-id="29d00-163">Failure to specify USAGE\_WRITEONLY or making a render target lockable can also impose serious performance penalties.</span></span>

<span data-ttu-id="29d00-164">Вызов **блокировки** по \_ умолчанию для ресурса пула, скорее всего, приведет к остановке GPU, чем при работе с \_ ресурсом, управляемым пулом, если не использовать определенные флаги подсказок.</span><span class="sxs-lookup"><span data-stu-id="29d00-164">Calling **Lock** on a POOL\_DEFAULT resource is more likely to cause the GPU to stall than working with a POOL\_MANAGED resource, unless using certain hint flags.</span></span> <span data-ttu-id="29d00-165">В зависимости от расположения ресурса возвращаемый указатель может быть временным буфером системной памяти или указателем непосредственно в память AGP.</span><span class="sxs-lookup"><span data-stu-id="29d00-165">Depending on the location of the resource, the pointer returned could be to a temporary system memory buffer, or it can be a pointer directly into AGP memory.</span></span> <span data-ttu-id="29d00-166">Если это временный буфер системной памяти, данные потребуется передать в видеопамять после вызова **Unlock** .</span><span class="sxs-lookup"><span data-stu-id="29d00-166">If it is a temporary system memory buffer, data will need to be transferred to the video memory after the **Unlock** call.</span></span> <span data-ttu-id="29d00-167">Если видеоресурс не предназначен только для записи, данные необходимо передать во временный буфер во время **блокировки**.</span><span class="sxs-lookup"><span data-stu-id="29d00-167">If the video resource is not write-only, data will have to be transferred into the temporary buffer during the **Lock**.</span></span> <span data-ttu-id="29d00-168">Если это область памяти AGP, временные копии исключаются, но требуемое поведение кэша может привести к снижению производительности.</span><span class="sxs-lookup"><span data-stu-id="29d00-168">If it is an AGP memory area, temporary copies are avoided but the cache behavior required can result in slow performance.</span></span>

<span data-ttu-id="29d00-169">Следует уделить внимание написанию полной строки кэша данных в любом указателе на память апертуры AGP, чтобы избежать снижения числа операций, приводящих к объединению с возможностью чтения и записи, а также последовательного доступа к области памяти.</span><span class="sxs-lookup"><span data-stu-id="29d00-169">Care should be taken to write a full cache line of data into any pointer to AGP aperture memory to avoid the penalty of write-combing, which induces a read-write cycle, and sequential access of the memory area is preferred.</span></span> <span data-ttu-id="29d00-170">Если приложению необходимо сделать произвольный доступ к данным во время создания и вы не хотите использовать управляемый ресурс для буфера, следует работать с копией системной памяти.</span><span class="sxs-lookup"><span data-stu-id="29d00-170">If your application needs to make random access to data during creation, and you do not wish to make use of a managed resource for the buffer, you should work with a system memory copy instead.</span></span> <span data-ttu-id="29d00-171">После создания данных можно выполнить потоковую передачу результата в память заблокированных ресурсов, чтобы не платить большую штраф за операцию объединения в кэш.</span><span class="sxs-lookup"><span data-stu-id="29d00-171">Once the data has been created, you can then stream the result into the locked resource memory to avoid paying a high penalty for the cache write-combining operation.</span></span>

<span data-ttu-id="29d00-172">Флаг LOCK \_ нуверврите можно использовать для эффективного добавления данных для некоторых ресурсов, но в идеале можно избежать нескольких вызовов **блокировки** и **разблокировки** одного и того же ресурса.</span><span class="sxs-lookup"><span data-stu-id="29d00-172">The LOCK\_NOOVERWRITE flag can be used to append data in an efficient manner for some resources, but ideally, multiple **Lock** and **Unlock** calls to the same resource can be avoided.</span></span> <span data-ttu-id="29d00-173">Правильная работа различных флагов блокировки важна для оптимальной производительности, как при использовании шаблона доступа к данным с поддержкой кэша при переполнении памяти.</span><span class="sxs-lookup"><span data-stu-id="29d00-173">Making proper use of the various lock flags is important to optimal performance, as is using a cache-friendly pattern of data access when filling locked memory.</span></span>

### <a name="using-both-managed-and-default-resources"></a><span data-ttu-id="29d00-174">Использование управляемых и ресурсов по умолчанию</span><span class="sxs-lookup"><span data-stu-id="29d00-174">Using Both Managed and Default Resources</span></span>

<span data-ttu-id="29d00-175">Смешивание распределения \_ ресурсов по умолчанию управляемых и пулов может привести к фрагментации видеопамяти и путать представление видеопамяти, доступной для управляемых ресурсов, в среде выполнения.</span><span class="sxs-lookup"><span data-stu-id="29d00-175">Mixing allocations of managed and POOL\_DEFAULT resources can cause video memory fragmentation and confuse the runtime's view of the video memory available for managed resources.</span></span> <span data-ttu-id="29d00-176">В идеале следует создать все \_ ресурсы пула по умолчанию, прежде чем использовать \_ управляемые ресурсы пула или использовать вызов [**евиктманажедресаурцес**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-evictmanagedresources) перед выделением неуправляемых ресурсов.</span><span class="sxs-lookup"><span data-stu-id="29d00-176">Ideally, you should create all POOL\_DEFAULT resources before making use of POOL\_MANAGED resources or make use of the [**EvictManagedResources**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-evictmanagedresources) call before allocating unmanaged resources.</span></span> <span data-ttu-id="29d00-177">Помните, что все выделения, сделанные из пула \_ по умолчанию, которые находятся в видеопамяти, занимают память в течение жизненного цикла ресурса, недоступного для использования диспетчером ресурсов или в других целях.</span><span class="sxs-lookup"><span data-stu-id="29d00-177">Remember that all allocations made from POOL\_DEFAULT that reside in video memory tie up memory for the life that resource that is unavailable for use by the resource manager or for any other purpose.</span></span>

<span data-ttu-id="29d00-178">Обратите внимание, что, в отличие от предыдущих версий Direct3D, среда выполнения версии 9 автоматически удаляет некоторые управляемые ресурсы, прежде чем выдавать неудачное выделение неуправляемого ресурса для нехватки видеопамяти, но это может привести к созданию дополнительной фрагментации и даже принудительной перезаписи ресурса в неоптимальное расположение (например, наличие статической текстуры в нелокальной видеопамяти).</span><span class="sxs-lookup"><span data-stu-id="29d00-178">Note that unlike previous versions of Direct3D, the version 9 runtime automatically evicts some managed resources before giving up on a failed unmanaged resource allocation for a lack of video memory, but this can potentially create additional fragmentation and even force a resource into a sub-optimal location (for example, having a static texture in non-local video memory).</span></span> <span data-ttu-id="29d00-179">Опять же, лучше всего выделить все необходимые неуправляемые ресурсы перед использованием любых управляемых ресурсов.</span><span class="sxs-lookup"><span data-stu-id="29d00-179">Again, it is best to allocate all required unmanaged resources up front and before using any managed resources.</span></span>

### <a name="dynamic-default-resources"></a><span data-ttu-id="29d00-180">Динамические ресурсы по умолчанию</span><span class="sxs-lookup"><span data-stu-id="29d00-180">Dynamic Default Resources</span></span>

<span data-ttu-id="29d00-181">Данные, формируемые и обновленные с высокой частотой, не нуждаются в резервном хранилище, так как при восстановлении устройства все данные будут созданы повторно.</span><span class="sxs-lookup"><span data-stu-id="29d00-181">Data that is generated and updated at a high frequency has no need for the backing-store since all the information will be re-created when restoring the device.</span></span> <span data-ttu-id="29d00-182">Такие данные, как правило, лучше всего создавать в пуле \_ по умолчанию, указывая \_ динамическое указание Usage, чтобы драйвер мог принимать решения по оптимизации при помещении ресурса, зная, что он будет обновляться часто.</span><span class="sxs-lookup"><span data-stu-id="29d00-182">Such data is typically best created in POOL\_DEFAULT, specifying the USAGE\_DYNAMIC hint, so that the driver can make optimization decisions when placing the resource, knowing that it will be updated often.</span></span> <span data-ttu-id="29d00-183">Как правило, это означает помещение ресурса в нелокальную видеопамять и, следовательно, очень медленный доступ к GPU, чем к локальной видеопамяти.</span><span class="sxs-lookup"><span data-stu-id="29d00-183">This typically means putting the resource into non-local video memory, and thus, it is usually much slower for the GPU to access than local video memory.</span></span> <span data-ttu-id="29d00-184">Для архитектуры с областью размещения драйвер может выбрать конкретное размещение динамических ресурсов для оптимизации доступа на запись ЦП.</span><span class="sxs-lookup"><span data-stu-id="29d00-184">For UMA architectures, the driver might choose a particular placement for dynamic resources to optimize for CPU write access.</span></span>

<span data-ttu-id="29d00-185">Такое использование является типичным для решений с обложками программного обеспечения и примитивов на основе ЦП, заполняющих буферы вершин и индексов, и флаг блокировки снимается \_ , чтобы остановки не создавались в случаях, когда ресурс по-прежнему используется из предыдущего кадра.</span><span class="sxs-lookup"><span data-stu-id="29d00-185">This usage is typical for software skinning solutions and CPU-based particle systems filling out vertex/index buffers, and the LOCK\_DISCARD flag will ensure that stalls are not created in cases where the resource is still in use from the previous frame.</span></span> <span data-ttu-id="29d00-186">При использовании управляемого ресурса в этом случае будет обновлен буфер системной памяти, который затем будет скопирован в видеопамять, а затем использован только для кадра или двух символов перед заменой.</span><span class="sxs-lookup"><span data-stu-id="29d00-186">Using a managed resource in this case would update a system memory buffer, which would then be copied to video memory, and then used for only a frame or two before being replaced.</span></span> <span data-ttu-id="29d00-187">Для систем с нелокальной видеопамятью лишние копии устраняются при правильном использовании этого динамического шаблона.</span><span class="sxs-lookup"><span data-stu-id="29d00-187">For systems with non-local video memory, the extra copy is eliminated by proper use of this dynamic pattern.</span></span>

<span data-ttu-id="29d00-188">Стандартные текстуры не могут быть заблокированы и могут быть обновлены только через [**упдатесурфаце**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatesurface) или [**упдатетекстуре**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatetexture).</span><span class="sxs-lookup"><span data-stu-id="29d00-188">Standard textures cannot be locked, and can only be updated via [**UpdateSurface**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatesurface) or [**UpdateTexture**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatetexture).</span></span> <span data-ttu-id="29d00-189">Некоторые системы поддерживают динамические текстуры, которые могут быть заблокированы, и используют шаблон запрета блокировки \_ , но \_ перед использованием таких ресурсов необходимо проверить бит (D3DCAPS2 динамиктекстурес).</span><span class="sxs-lookup"><span data-stu-id="29d00-189">Some systems support dynamic textures, which can be locked, and use the LOCK\_DISCARD pattern, but a capabilities bit (D3DCAPS2\_DYNAMICTEXTURES) must be checked before making use of such resources.</span></span> <span data-ttu-id="29d00-190">Для высокодинамических текстур (видео или процедур) приложение может создать соответствующие ресурсы пула \_ по умолчанию и \_ системмем пула и управлять обновлениями видео-памяти с помощью **упдатетекстуре**.</span><span class="sxs-lookup"><span data-stu-id="29d00-190">For highly dynamic textures (video or procedural), your application could create matching POOL\_DEFAULT and POOL\_SYSTEMMEM resources and handle video-memory updates by using **UpdateTexture**.</span></span> <span data-ttu-id="29d00-191">Для наиболее частых и частичных обновлений **упдатетекстуре** парадигма, скорее всего, является лучшим выбором.</span><span class="sxs-lookup"><span data-stu-id="29d00-191">For highly frequent and partial updates, the **UpdateTexture** paradigm is likely the better choice.</span></span>

<span data-ttu-id="29d00-192">При проектировании систем, которые сильно полагаются на динамическую отправку, удобно использовать динамические ресурсы.</span><span class="sxs-lookup"><span data-stu-id="29d00-192">As useful as dynamic resources can be, be careful when designing systems that rely heavily on dynamic submission.</span></span> <span data-ttu-id="29d00-193">Статические ресурсы должны быть помещены в пул \_ под управлением, чтобы обеспечить оптимальное использование локальной видеопамяти и более эффективно использовать ограниченную шину и основную пропускную способность памяти.</span><span class="sxs-lookup"><span data-stu-id="29d00-193">Static resources should be placed into POOL\_MANAGED to ensure both good utilization of local video memory, and to make more efficient use of limited bus and main memory bandwidth.</span></span> <span data-ttu-id="29d00-194">Для ресурсов, которые являются частично статическими, может оказаться, что затраты на отправку в локальную видеопамять гораздо меньше, чем порожденный трафик постоянной шины, что делает их динамическими.</span><span class="sxs-lookup"><span data-stu-id="29d00-194">For resources that are semi-static, you may find that the cost of an occasional upload to local video memory is much less than the constant bus traffic generated by making them dynamic.</span></span>

## <a name="system-memory-resources"></a><span data-ttu-id="29d00-195">Ресурсы системной памяти</span><span class="sxs-lookup"><span data-stu-id="29d00-195">System Memory Resources</span></span>

<span data-ttu-id="29d00-196">Ресурсы также можно создать в пуле \_ системмем.</span><span class="sxs-lookup"><span data-stu-id="29d00-196">Resources can also be created in POOL\_SYSTEMMEM.</span></span> <span data-ttu-id="29d00-197">Хотя графический конвейер не может использовать их, их можно использовать в качестве источников для обновления \_ ресурсов пула по умолчанию с помощью [**Упдатесурфаце**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatesurface) или [**упдатетекстуре**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatetexture).</span><span class="sxs-lookup"><span data-stu-id="29d00-197">While they cannot be used by the graphics pipeline, they can be used as sources for updating POOL\_DEFAULT resources by using [**UpdateSurface**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatesurface) or [**UpdateTexture**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatetexture).</span></span> <span data-ttu-id="29d00-198">Их режим блокировки прост, хотя ожидание может произойти, если они используются одним из упомянутых выше методов.</span><span class="sxs-lookup"><span data-stu-id="29d00-198">Their locking behavior is simple, although stalls might occur if they are in use by one of the previously mentioned methods.</span></span>

<span data-ttu-id="29d00-199">Несмотря на то что они находятся в системной памяти, \_ ресурсы пула системмем ограничены теми же форматами и возможностями (например, максимальный размер), которые поддерживаются драйвером устройства.</span><span class="sxs-lookup"><span data-stu-id="29d00-199">Though they reside in system memory, POOL\_SYSTEMMEM resources are limited to the same formats and capabilities (such as maximum size) supported by the device driver.</span></span> <span data-ttu-id="29d00-200">\_Тип временных ресурсов пула — это другая форма ресурса системной памяти, которая может использовать все форматы и возможности, поддерживаемые средой выполнения, но не доступ к ним.</span><span class="sxs-lookup"><span data-stu-id="29d00-200">The POOL\_SCRATCH resource type is another form of system memory resource that can utilize all formats and capabilities supported by the runtime, but cannot be accessed by the device.</span></span> <span data-ttu-id="29d00-201">Ресурсы временных ресурсов предназначены главным образом для использования средствами содержимого.</span><span class="sxs-lookup"><span data-stu-id="29d00-201">Scratch resources are intended primarily for use by content tools.</span></span>

<span data-ttu-id="29d00-202">**Рис. 3. Ресурсы памяти в видеопамяти, апертуре AGP и ОЗУ системы**</span><span class="sxs-lookup"><span data-stu-id="29d00-202">**Figure 3. Memory resources in video RAM, AGP aperture, and system RAM**</span></span>

![ресурсы памяти в видеопамяти, апертуре AGP и ОЗУ системы](images/managingresources3.gif)

## <a name="general-recommendations"></a><span data-ttu-id="29d00-204">Основные рекомендации</span><span class="sxs-lookup"><span data-stu-id="29d00-204">General Recommendations</span></span>

<span data-ttu-id="29d00-205">Получение сведений о технических реализациях для управления ресурсами будет длительным способом достижения целей производительности для вашего приложения.</span><span class="sxs-lookup"><span data-stu-id="29d00-205">Getting the technical implementation details of resource management correct will go a long way toward achieving your performance goals for your application.</span></span> <span data-ttu-id="29d00-206">Планирование того, как ресурсы представлены для Direct3D, а архитектурный проект, позволяющий своевременно загружать данные, является более сложной задачей.</span><span class="sxs-lookup"><span data-stu-id="29d00-206">Planning how the resources are presented to Direct3D and the architectural design around getting the data loaded in a timely fashion is a more complicated task.</span></span> <span data-ttu-id="29d00-207">Мы рекомендуем использовать ряд рекомендаций при принятии решений для вашего приложения:</span><span class="sxs-lookup"><span data-stu-id="29d00-207">We recommend a number of best practices when making these decisions for your application:</span></span>

-   <span data-ttu-id="29d00-208">Предварительно обработайте все ресурсы.</span><span class="sxs-lookup"><span data-stu-id="29d00-208">Pre-process all your resources.</span></span> <span data-ttu-id="29d00-209">В процессе разработки удобнее выполнять преобразование и оптимизацию ресурсов во время загрузки, но это обеспечивает высокую производительность на компьютерах пользователей.</span><span class="sxs-lookup"><span data-stu-id="29d00-209">Relying on expensive load-time conversion and optimization for your resources is convenient during development, but doing so puts a great performance burden on your users' computers.</span></span> <span data-ttu-id="29d00-210">Предварительно обработанные ресурсы быстрее загружаются, быстрее используются и предоставляют возможность выполнять сложные автономные работы.</span><span class="sxs-lookup"><span data-stu-id="29d00-210">Pre-processed resources are faster to load, faster to use, and give you the option of doing sophisticated off-line work.</span></span>
-   <span data-ttu-id="29d00-211">Избегайте создания большого количества ресурсов на кадр.</span><span class="sxs-lookup"><span data-stu-id="29d00-211">Avoid creating many resources per frame.</span></span> <span data-ttu-id="29d00-212">Взаимодействие с драйверами позволяет сериализовать ЦП и GPU, а задействованные операции имеют высокую плотность, так как они часто требуют перехода ядра.</span><span class="sxs-lookup"><span data-stu-id="29d00-212">The driver interactions required can serialize the CPU and GPU, and the operations involved are heavy-weight, as they often require kernel transitions.</span></span> <span data-ttu-id="29d00-213">Разраспределите создание по нескольким кадрам или повторно используйте ресурсы без их создания или освобождения.</span><span class="sxs-lookup"><span data-stu-id="29d00-213">Spread out creation over several frames or reuse resources without creating/releasing them.</span></span> <span data-ttu-id="29d00-214">В идеале следует ожидать несколько кадров перед блокировкой или освобождением ресурсов, которые были недавно использованы для подготовки к просмотру.</span><span class="sxs-lookup"><span data-stu-id="29d00-214">Ideally, you should wait several frames before locking or releasing resources that were recently used to render.</span></span>
-   <span data-ttu-id="29d00-215">В конце кадра не забудьте отменить привязку всех каналов ресурсов (то есть источников потоков, стадий текстуры и текущих индексов).</span><span class="sxs-lookup"><span data-stu-id="29d00-215">At the end of the frame, be sure to unbind all resource channels (that is, stream sources, texture stages, and current indices).</span></span> <span data-ttu-id="29d00-216">Это гарантирует, что висячие ссылки на ресурсы будут удалены, прежде чем они приведут к тому, что диспетчер ресурсов будет поддерживать резидентные ресурсы, которые больше не используются.</span><span class="sxs-lookup"><span data-stu-id="29d00-216">Doing so will ensure that dangling references to resources are removed before they cause the resource manager to keep resources resident that are actually no longer in use.</span></span>
-   <span data-ttu-id="29d00-217">Для текстур используйте сжатые форматы (например, Дкстн) с MIP-Maps и рассмотрите возможность использования текстуры Atlas.</span><span class="sxs-lookup"><span data-stu-id="29d00-217">For textures, use compressed formats (for example, DXTn) with mip-maps, and consider making use of a texture atlas.</span></span> <span data-ttu-id="29d00-218">Это значительно сокращает требования к пропускной способности и позволяет уменьшить общий размер ресурсов, что делает их более эффективными.</span><span class="sxs-lookup"><span data-stu-id="29d00-218">These greatly reduce bandwidth requirements, and they can reduce the overall size of the resources, thus making them more efficient.</span></span>
-   <span data-ttu-id="29d00-219">Для геометрии используйте индексированную геометрию, так как это помогает сжимать ресурсы буфера вершин, а современное видеооборудование сильно оптимизируется при повторном использовании вершин.</span><span class="sxs-lookup"><span data-stu-id="29d00-219">For geometry, make use of indexed geometry as this helps compress vertex buffer resources, and modern video hardware is heavily optimized around reuse of vertices.</span></span> <span data-ttu-id="29d00-220">Используя программируемые шейдеры вершин, можно сжимать сведения о вершинах и расширять их во время обработки вершин.</span><span class="sxs-lookup"><span data-stu-id="29d00-220">By making use of programmable vertex shaders, you can compress the vertex information and expand it during the vertex processing.</span></span> <span data-ttu-id="29d00-221">Опять же, это позволяет сократить требования к пропускной способности и сделать ресурсы буфера вершин более эффективными.</span><span class="sxs-lookup"><span data-stu-id="29d00-221">Again, this helps reduce bandwidth requirements and makes vertex buffer resources more efficient.</span></span>
-   <span data-ttu-id="29d00-222">Избегайте чрезмерного оптимизации управления ресурсами.</span><span class="sxs-lookup"><span data-stu-id="29d00-222">Avoid over-optimizing your resource management.</span></span> <span data-ttu-id="29d00-223">Будущие редакции драйверов, оборудования и операционной системы могут вызвать проблемы совместимости, если приложение слишком сильно настраивается для определенного сочетания.</span><span class="sxs-lookup"><span data-stu-id="29d00-223">Future revisions of drivers, hardware, and the operating system can potentially cause compatibility problems if the application is tuned too heavily to a particularly combination.</span></span> <span data-ttu-id="29d00-224">Так как большинство приложений привязаны к ЦП, дорогостоящее управление на основе ЦП обычно вызывает больше проблем с производительностью, чем устраняется.</span><span class="sxs-lookup"><span data-stu-id="29d00-224">Since most applications are CPU-bound, expensive CPU-based management generally causes more performance issues than it solves.</span></span>

## <a name="related-topics"></a><span data-ttu-id="29d00-225">См. также</span><span class="sxs-lookup"><span data-stu-id="29d00-225">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="29d00-226">Управление ресурсами</span><span class="sxs-lookup"><span data-stu-id="29d00-226">Managing Resources</span></span>](/windows/desktop/direct3d9/managing-resources)
</dt> <dt>

[<span data-ttu-id="29d00-227">Потерянные устройства</span><span class="sxs-lookup"><span data-stu-id="29d00-227">Lost Devices</span></span>](/windows/desktop/direct3d9/lost-devices)
</dt> <dt>

[<span data-ttu-id="29d00-228">Оптимизация производительности</span><span class="sxs-lookup"><span data-stu-id="29d00-228">Performance Optimizations</span></span>](/windows/desktop/direct3d9/performance-optimizations)
</dt> <dt>

[<span data-ttu-id="29d00-229">Сжатые ресурсы текстуры</span><span class="sxs-lookup"><span data-stu-id="29d00-229">Compressed Texture Resources</span></span>](/windows/desktop/direct3d9/compressed-texture-resources)
</dt> <dt>

[<span data-ttu-id="29d00-230">Запросы</span><span class="sxs-lookup"><span data-stu-id="29d00-230">Queries</span></span>](/windows/desktop/direct3d9/queries)
</dt> <dt>

[<span data-ttu-id="29d00-231">**D3DUSAGE**</span><span class="sxs-lookup"><span data-stu-id="29d00-231">**D3DUSAGE**</span></span>](/windows/desktop/direct3d9/d3dusage)
</dt> <dt>

[<span data-ttu-id="29d00-232">**D3DPOOL**</span><span class="sxs-lookup"><span data-stu-id="29d00-232">**D3DPOOL**</span></span>](/windows/desktop/direct3d9/d3dpool)
</dt> <dt>

[<span data-ttu-id="29d00-233">D3DCREATE</span><span class="sxs-lookup"><span data-stu-id="29d00-233">D3DCREATE</span></span>](/windows/desktop/direct3d9/d3dcreate)
</dt> </dl>

 

 