---
title: Распространенные методики по улучшению карт глубины теней
description: В этой технической статье представлен обзор некоторых распространенных алгоритмов карты глубины тени и общих артефактов, а также объясняется несколько приемов — от базовых до промежуточных, которые можно использовать для повышения качества стандартных теневых карт.
ms.assetid: bf994838-a261-0379-9301-eb9b250d216c
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c8b25507d7f6b8608d4dacf5fab620bc8a3294c7
ms.sourcegitcommit: 218b1ff779402c3ebe1786679e1aa80a5c0d6c95
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/01/2020
ms.locfileid: "103794184"
---
# <a name="common-techniques-to-improve-shadow-depth-maps"></a><span data-ttu-id="f4820-103">Распространенные методики по улучшению карт глубины теней</span><span class="sxs-lookup"><span data-stu-id="f4820-103">Common Techniques to Improve Shadow Depth Maps</span></span>

<span data-ttu-id="f4820-104">Теневые карты, впервые представленные в 1978, являются распространенной методикой для добавления темных участков в игры.</span><span class="sxs-lookup"><span data-stu-id="f4820-104">Shadow maps, first introduced in 1978, are a common technique for adding shadows to games.</span></span> <span data-ttu-id="f4820-105">Спустя три десятка лет, несмотря на развитие оборудования и программного обеспечения, теневые артефакты — Шиммеринг края, псевдонимы перспектив и другие проблемы с точностью — сохраняются.</span><span class="sxs-lookup"><span data-stu-id="f4820-105">Three decades later, despite advances in hardware and software, shadowing artifacts—namely shimmering edges, perspective aliasing, and other precision issues—persist.</span></span>

<span data-ttu-id="f4820-106">В этой технической статье представлен обзор некоторых распространенных алгоритмов карты глубины тени и общих артефактов, а также объясняется несколько приемов — от базовых до промежуточных, которые можно использовать для повышения качества стандартных теневых карт.</span><span class="sxs-lookup"><span data-stu-id="f4820-106">This technical article provides an overview of some common shadow depth map algorithms and common artifacts, and explains several techniques—ranging in difficulty from basic to intermediate—that can be used to increase the quality of standard shadow maps.</span></span> <span data-ttu-id="f4820-107">Добавление базовых теневых карт к названию обычно является простым, но понимание нюансов теневых артефактов может быть непростой задачей.</span><span class="sxs-lookup"><span data-stu-id="f4820-107">Adding basic shadow maps to a title typically is straightforward, but understanding the nuances of shadow artifacts can be challenging.</span></span> <span data-ttu-id="f4820-108">Эта Техническая статья написана для разработчиков промежуточных графических объектов, которые реализуют тени, но не полностью понимают, почему появляются конкретные артефакты и не уверены, как их обойти.</span><span class="sxs-lookup"><span data-stu-id="f4820-108">This technical article is written for the intermediate graphics developer who has implemented shadows, but does not fully understand why specific artifacts appear and is not sure how to work around them.</span></span>

<span data-ttu-id="f4820-109">Выбор правильных методик для устранения конкретных артефактов является нетривиальной задачей.</span><span class="sxs-lookup"><span data-stu-id="f4820-109">Selecting the correct techniques to mitigate specific artifacts is nontrivial.</span></span> <span data-ttu-id="f4820-110">При устранении недостатков теневой схемы можно вычислить разницу в качества (рис. 1).</span><span class="sxs-lookup"><span data-stu-id="f4820-110">When shadow map shortcomings are addressed, the difference in quality can be impressive (Figure 1).</span></span> <span data-ttu-id="f4820-111">Правильное внедрение этих методов радикально улучшает стандартные тени.</span><span class="sxs-lookup"><span data-stu-id="f4820-111">Correctly implementing these techniques drastically improves standard shadows.</span></span> <span data-ttu-id="f4820-112">Методы, описанные в этой статье, реализованы в примере CascadedShadowMaps11 в пакете SDK DirectX.</span><span class="sxs-lookup"><span data-stu-id="f4820-112">The techniques explained in this article are implemented in the sample CascadedShadowMaps11 in the DirectX SDK.</span></span>

<span data-ttu-id="f4820-113">**Рис. 1. Тени с серьезными артефактами (слева) и тенями после реализации методик, описанных в этой статье (справа)**</span><span class="sxs-lookup"><span data-stu-id="f4820-113">**Figure 1. Shadows with severe artifacts (left), and shadows after implementing the techniques described in this article (right)**</span></span>

![тени с серьезными артефактами (слева) и тенями после реализации методик, описанных в этой статье (справа)](images/shadows-before-and-after.jpg)

## <a name="shadow-depth-maps-review"></a><span data-ttu-id="f4820-115">Проверка карт с глубиной тени</span><span class="sxs-lookup"><span data-stu-id="f4820-115">Shadow Depth Maps Review</span></span>

<span data-ttu-id="f4820-116">Алгоритм карты глубины тени — это алгоритм с двумя проходами.</span><span class="sxs-lookup"><span data-stu-id="f4820-116">The shadow depth map algorithm is a two-pass algorithm.</span></span> <span data-ttu-id="f4820-117">Первый проход создает карту глубины в пространстве.</span><span class="sxs-lookup"><span data-stu-id="f4820-117">The first pass generates a depth map in light space.</span></span> <span data-ttu-id="f4820-118">На втором этапе эта схема используется для сравнения глубины каждого пикселя в области освещения с соответствующей глубиной на карте глубины освещения.</span><span class="sxs-lookup"><span data-stu-id="f4820-118">In the second pass, this map is used to compare each pixel's depth in light space against its corresponding depth in the light space depth map.</span></span>

<span data-ttu-id="f4820-119">**Рис. 2. Ключевые части теневой сцены**</span><span class="sxs-lookup"><span data-stu-id="f4820-119">**Figure 2. Key parts of a shadow scene**</span></span>

![Ключевые части теневой сцены](images/key-parts-of-shadow-scene.jpg)

### <a name="pass-1"></a><span data-ttu-id="f4820-121">1 проход</span><span class="sxs-lookup"><span data-stu-id="f4820-121">Pass 1</span></span>

<span data-ttu-id="f4820-122">Сцена показана на рис. 2.</span><span class="sxs-lookup"><span data-stu-id="f4820-122">The scene is shown in Figure 2.</span></span> <span data-ttu-id="f4820-123">На первом этапе (рис. 3) геометрия отображается в буфере глубины с точки зрения освещения.</span><span class="sxs-lookup"><span data-stu-id="f4820-123">In the first pass (Figure 3), the geometry is rendered into a depth buffer from the point of view of the light.</span></span> <span data-ttu-id="f4820-124">В частности, шейдер вершин преобразует геометрию в пространство с небольшими представлениями.</span><span class="sxs-lookup"><span data-stu-id="f4820-124">More specifically, the vertex shader transforms the geometry into light-view space.</span></span>

<span data-ttu-id="f4820-125">Конечным результатом первого прохода является буфер глубины, содержащий сведения о глубине сцены с точки зрения освещения.</span><span class="sxs-lookup"><span data-stu-id="f4820-125">The end result of this first pass is a depth buffer containing the scene's depth information from the point of view of the light.</span></span> <span data-ttu-id="f4820-126">Теперь это можно использовать на этапе 2, чтобы определить, какие пиксели перекрыто от светлого.</span><span class="sxs-lookup"><span data-stu-id="f4820-126">This now can be used in pass 2 to determine which pixels are occluded from the light.</span></span>

<span data-ttu-id="f4820-127">**Рис. 3. Первый проход базовой теневой карты**</span><span class="sxs-lookup"><span data-stu-id="f4820-127">**Figure 3. First pass of basic shadow mapping**</span></span>

![первый проход базовой теневой карты](images/first-pass-of-basic-hadow-mapping.png)

### <a name="pass-2"></a><span data-ttu-id="f4820-129">2 прохода</span><span class="sxs-lookup"><span data-stu-id="f4820-129">Pass 2</span></span>

<span data-ttu-id="f4820-130">На втором этапе (рис. 4) шейдер вершин преобразует каждую вершину дважды.</span><span class="sxs-lookup"><span data-stu-id="f4820-130">In the second pass (Figure 4), the vertex shader transforms each vertex twice.</span></span> <span data-ttu-id="f4820-131">Каждая вершина преобразуется в пространство просмотра камеры и передается шейдеру пикселей в качестве расположения.</span><span class="sxs-lookup"><span data-stu-id="f4820-131">Each vertex is transformed into the camera's view space and passed to the pixel shader as the position.</span></span> <span data-ttu-id="f4820-132">Каждая вершина также преобразуется в матрицу «вид-проекция-текстура» источника и передается шейдеру пикселей в виде координаты текстуры.</span><span class="sxs-lookup"><span data-stu-id="f4820-132">Each vertex is also transformed by the light's view-projection-texture matrix and passed to the pixel shader as a texture coordinate.</span></span> <span data-ttu-id="f4820-133">Матрица View-проекция-текстура — это та же матрица, которая используется для отрисовки сцены в проходе 1 с одним дополнительным преобразованием.</span><span class="sxs-lookup"><span data-stu-id="f4820-133">The view-projection-texture matrix is the same matrix used to render the scene in pass 1 with one additional transform.</span></span> <span data-ttu-id="f4820-134">Это преобразование, которое масштабирует и преобразует точки из пространства просмотра (от – 1 до 1 в X и Y) в пространство текстуры (от 0 до 1 в X и 1 до 0 в Y).</span><span class="sxs-lookup"><span data-stu-id="f4820-134">It's a transformation that scales and translates the points from view space (–1 to 1 in X and Y) to texture space (0 to 1 in X and 1 to 0 in Y).</span></span>

<span data-ttu-id="f4820-135">Построитель текстуры получает в виде интерполяции и интерполяции координаты текстуры.</span><span class="sxs-lookup"><span data-stu-id="f4820-135">The pixel shader receives the interpolated position and the interpolated texture coordinates.</span></span> <span data-ttu-id="f4820-136">Все, что необходимо для выполнения теста глубины, теперь находится в этой координате текстуры.</span><span class="sxs-lookup"><span data-stu-id="f4820-136">Everything needed to perform the depth test is now in this texture coordinate.</span></span> <span data-ttu-id="f4820-137">Теперь можно выполнить тест глубины, выполнив индексирование буфера глубины с первого прохода с координатами текстуры X и Y и сравнив полученное значение глубины с координатой Z-текстуры.</span><span class="sxs-lookup"><span data-stu-id="f4820-137">The depth test can now be performed by indexing the depth buffer from the first pass with the X and Y texture coordinates and comparing the resulting depth value against the Z-texture coordinate.</span></span>

<span data-ttu-id="f4820-138">**Рис. 4. Второй этап базового сопоставления**</span><span class="sxs-lookup"><span data-stu-id="f4820-138">**Figure 4. Second pass of basic shadow mapping**</span></span>

![второй этап базового сопоставления](images/second-pass-of-basic-shadow-mapping.png)

## <a name="shadow-map-artifacts"></a><span data-ttu-id="f4820-140">Артефакты теневой схемы</span><span class="sxs-lookup"><span data-stu-id="f4820-140">Shadow Map Artifacts</span></span>

<span data-ttu-id="f4820-141">Алгоритм теневой схемы глубины тени является наиболее широко используемым алгоритмом теневого отображения в реальном времени, но по-прежнему создает несколько артефактов, которые требуют устранения.</span><span class="sxs-lookup"><span data-stu-id="f4820-141">The shadow depth map algorithm is the most widely used real-time shadowing algorithm, but still produces several artifacts requiring mitigation.</span></span> <span data-ttu-id="f4820-142">Ниже перечислены типы артефактов, которые могут быть выполнены.</span><span class="sxs-lookup"><span data-stu-id="f4820-142">The types of artifacts that can occur are summarized next.</span></span>

### <a name="perspective-aliasing"></a><span data-ttu-id="f4820-143">Присвоение псевдонимов перспективам</span><span class="sxs-lookup"><span data-stu-id="f4820-143">Perspective Aliasing</span></span>

<span data-ttu-id="f4820-144">Псевдоним перспективы, общий артефакт, показан на рис. 5.</span><span class="sxs-lookup"><span data-stu-id="f4820-144">Perspective aliasing, a common artifact, is shown in Figure 5.</span></span> <span data-ttu-id="f4820-145">Это происходит, когда сопоставление пикселей в области просмотра для пикселей текстуры в теневой карте не является отношением «один к одному».</span><span class="sxs-lookup"><span data-stu-id="f4820-145">It occurs when the mapping of pixels in view space to texels in the shadow map is not a one-to-one ratio.</span></span> <span data-ttu-id="f4820-146">Это связано с тем, что пикселы близко к ближайшему плоскости расположены ближе друг к другу и нуждаются в более высоком разрешении теневой карте.</span><span class="sxs-lookup"><span data-stu-id="f4820-146">This is because pixels close to the near plane are closer together and require a higher shadow map resolution.</span></span>

<span data-ttu-id="f4820-147">На рис. 6 показана теневая схема и представление фрустум.</span><span class="sxs-lookup"><span data-stu-id="f4820-147">Figure 6 shows a shadow map and a view frustum.</span></span> <span data-ttu-id="f4820-148">Рядом с глазом Пиксели расположены ближе друг к другу, и многие Пиксели сопоставляются с одним и тем же теневым пикселей текстуры.</span><span class="sxs-lookup"><span data-stu-id="f4820-148">Near the eye, the pixels are closer together, and many pixels map to the same shadow texels.</span></span> <span data-ttu-id="f4820-149">Пиксели, находящиеся на дальней плоскости, распределяются, тем самым уменьшая псевдонимы перспективы.</span><span class="sxs-lookup"><span data-stu-id="f4820-149">The pixels by the far plane are spread out, thereby reducing perspective aliasing.</span></span>

<span data-ttu-id="f4820-150">**Рис. 5. Сглаживание с высоким уровнем перспективы (слева) и с низкими перспективами (справа)**</span><span class="sxs-lookup"><span data-stu-id="f4820-150">**Figure 5. High-perspective aliasing (left) vs. low-perspective aliasing (right)**</span></span>

![сглаживание с высоким уровнем перспективы (слева) и с низкими перспективами (справа)](images/high-perspective-aliasing-vs-low-perspective-aliasing.jpg)

<span data-ttu-id="f4820-152">Для изображения слева псевдоним перспективы имеет больший приоритет; слишком много пробельных пикселей сопоставляются с одним и тем же пикселей текстуры теневой схемы.</span><span class="sxs-lookup"><span data-stu-id="f4820-152">For the image at left, perspective aliasing is higher; too many eye-space pixels map to the same shadow-map texels.</span></span> <span data-ttu-id="f4820-153">На изображении справа в качестве псевдонима перспективы мало, так как имеется 1:1 сопоставление между пикселями глаза и пикселей текстуры теневой карты.</span><span class="sxs-lookup"><span data-stu-id="f4820-153">In the image at right, perspective aliasing is low because there is a 1:1 mapping between the eye-space pixels and shadow-map texels.</span></span>

<span data-ttu-id="f4820-154">**Рис. 6. Просмотр фрустум с теневой картой**</span><span class="sxs-lookup"><span data-stu-id="f4820-154">**Figure 6. View frustum with shadow map**</span></span>

![Просмотр фрустум с теневой картой](images/view-frustum-with-shadow-map.jpg)

<span data-ttu-id="f4820-156">Светлое пикселы в дальней плоскости представляют собой псевдонимы с низкой перспективой, а темные пиксели в ближней плоскости — псевдонимы с высокой перспективой.</span><span class="sxs-lookup"><span data-stu-id="f4820-156">Light pixels in the far plane represent low-perspective aliasing, and dark pixels in the near plane represent high-perspective aliasing.</span></span>

<span data-ttu-id="f4820-157">Разрешение теневой гиперкарты также может быть слишком высоким.</span><span class="sxs-lookup"><span data-stu-id="f4820-157">Shadow map resolution can also be too high.</span></span> <span data-ttu-id="f4820-158">Хотя более заметное разрешение менее заметно, это может привести к тому, что небольшие объекты, например телефонные провода, не приводят к теням.</span><span class="sxs-lookup"><span data-stu-id="f4820-158">Although a higher resolution is less noticeable, it nevertheless can result in small objects, such as telephone wires, not casting shadows.</span></span> <span data-ttu-id="f4820-159">Кроме того, слишком высокое разрешение может вызвать серьезные проблемы с производительностью из-за схем доступа к текстурам.</span><span class="sxs-lookup"><span data-stu-id="f4820-159">Also, having too high of a resolution can cause severe performance issues because of texture access patterns.</span></span>

<span data-ttu-id="f4820-160">Теневые карты перспективы (ПСМС) и точки с пониженным расстоянием (Лспсмс) пытаются попытаться подать псевдонимы перспективам путем наклона матрицы-проекций освещения, чтобы разместить больше пикселей текстуры рядом с тем, где они нужны.</span><span class="sxs-lookup"><span data-stu-id="f4820-160">Perspective shadow maps (PSMs) and light space perspective shadow maps (LSPSMs) attempt to address perspective aliasing by skewing the light's projection matrix in order to place more texels near the eye where they are needed.</span></span> <span data-ttu-id="f4820-161">К сожалению, ни один из этих методов не способен решать псевдонимы перспективы.</span><span class="sxs-lookup"><span data-stu-id="f4820-161">Unfortunately, neither technique is able to solve the perspective aliasing.</span></span> <span data-ttu-id="f4820-162">Параметризация преобразования, необходимого для отображения пикселей пропикселей текстуры в теневой карте, не может быть привязана с помощью линейной наклона.</span><span class="sxs-lookup"><span data-stu-id="f4820-162">The parameterization of the transform required to map eye-space pixels to texels in the shadow map cannot be bound by a linear skew.</span></span> <span data-ttu-id="f4820-163">Требуется логарифмическая параметризация.</span><span class="sxs-lookup"><span data-stu-id="f4820-163">A logarithmic parameterization is required.</span></span> <span data-ttu-id="f4820-164">ПСМС слишком много близко к глазу, в результате чего отдаленные тени имеют низкую степень качества или даже исчезают.</span><span class="sxs-lookup"><span data-stu-id="f4820-164">PSMs put too much detail near the eye, causing distant shadows to be of low quality or to even disappear.</span></span> <span data-ttu-id="f4820-165">Лспсмс лучше нахождение средней земли между увеличением разрешения рядом с глазом и появление достаточной информации для объектов.</span><span class="sxs-lookup"><span data-stu-id="f4820-165">LSPSMs do a better job of finding a middle ground between increasing resolution near the eye, and leaving enough detail for objects far away.</span></span> <span data-ttu-id="f4820-166">Оба метода деформируют ортогональные тени в некоторых конфигурациях сцены.</span><span class="sxs-lookup"><span data-stu-id="f4820-166">Both techniques degenerate to orthographic shadows in some scene configurations.</span></span> <span data-ttu-id="f4820-167">Эта дегенерация может быть отделена путем визуализации отдельной теневой схемы для каждой грани представления фрустум, хотя это дорого.</span><span class="sxs-lookup"><span data-stu-id="f4820-167">This degeneration can be counteracted by rendering a separate shadow map for each face of the view frustum, although this is expensive.</span></span> <span data-ttu-id="f4820-168">С помощью теневых карт с логарифмической шкалой (Логпсмс) также отображается отдельная карта для каждого лица представления фрустум.</span><span class="sxs-lookup"><span data-stu-id="f4820-168">Logarithmic perspective shadow maps (LogPSMs) also render a separate map per face of the view frustum.</span></span> <span data-ttu-id="f4820-169">Этот метод использует нелинейную растрирование, чтобы увеличить пикселей текстуры.</span><span class="sxs-lookup"><span data-stu-id="f4820-169">This technique uses nonlinear rasterization to place more texels near the eye.</span></span> <span data-ttu-id="f4820-170">Оборудование класса D3D10 и D3D11 не поддерживает нелинейную растрирование.</span><span class="sxs-lookup"><span data-stu-id="f4820-170">D3D10 and D3D11-class hardware do not support nonlinear rasterization.</span></span> <span data-ttu-id="f4820-171">Дополнительные сведения об этих методах и алгоритмах см. в разделе "ссылки".</span><span class="sxs-lookup"><span data-stu-id="f4820-171">For more information about these techniques and algorithms, see the References section.</span></span>

<span data-ttu-id="f4820-172">Каскадные теневые карты (Ксмс) — это самая популярная методика для работы с псевдонимами перспективы.</span><span class="sxs-lookup"><span data-stu-id="f4820-172">Cascaded shadow maps (CSMs) are the most popular technique for dealing with perspective aliasing.</span></span> <span data-ttu-id="f4820-173">Хотя Ксмс можно сочетать с ПСМС и Лспсмс, он не нужен.</span><span class="sxs-lookup"><span data-stu-id="f4820-173">Although CSMs can be combined with PSMs and LSPSMs, it's unnecessary.</span></span> <span data-ttu-id="f4820-174">Использование Ксмс для устранения ошибок псевдонимов перспективы приводится в сопровождающей статье с [каскадными теневыми картами](/windows/desktop/DxTechArts/cascaded-shadow-maps).</span><span class="sxs-lookup"><span data-stu-id="f4820-174">Using CSMs to fix perspective aliasing errors is addressed in the companion article, [Cascaded Shadow Maps](/windows/desktop/DxTechArts/cascaded-shadow-maps).</span></span>

### <a name="projective-aliasing"></a><span data-ttu-id="f4820-175">Проецирование псевдонимов</span><span class="sxs-lookup"><span data-stu-id="f4820-175">Projective Aliasing</span></span>

<span data-ttu-id="f4820-176">Проецированные псевдонимы сложнее показывать, чем псевдонимы перспективы.</span><span class="sxs-lookup"><span data-stu-id="f4820-176">Projective aliasing is harder to show than perspective aliasing.</span></span> <span data-ttu-id="f4820-177">Затененные тени, выделенные на рис. 7, демонстрируют ошибки при проецировании псевдонимов.</span><span class="sxs-lookup"><span data-stu-id="f4820-177">The distended shadows highlighted in Figure 7 demonstrate projective aliasing errors.</span></span> <span data-ttu-id="f4820-178">Постановка псевдонимов происходит, когда сопоставление между пикселей текстуры в пространстве камеры и пикселей текстуры в светлом пространстве не является отношением "один к одному". Это обусловлено ориентацией геометрии по отношению к светлой камере.</span><span class="sxs-lookup"><span data-stu-id="f4820-178">Projective aliasing occurs when the mapping between texels in camera space to texels in light space is not a one-to-one ratio; this is because of the orientation of the geometry with respect to the light camera.</span></span> <span data-ttu-id="f4820-179">При проецировании в геометрическую плоскость геометрии начинает параллельно с лампочками.</span><span class="sxs-lookup"><span data-stu-id="f4820-179">Projective aliasing occurs as the tangent plane of the geometry becomes parallel to the light rays.</span></span>

<span data-ttu-id="f4820-180">**Рис. 7. Высокий-проектный псевдоним по сравнению с низким-проецированным псевдонимом**</span><span class="sxs-lookup"><span data-stu-id="f4820-180">**Figure 7. High-projective aliasing vs. low-projective aliasing**</span></span>

![высокий-проектный псевдоним по сравнению с низким-проецированным псевдонимом](images/high-projective-aliasing-vs-low%20projective-aliasing.jpg)

<span data-ttu-id="f4820-182">Методы, используемые для смягчения ошибок при назначении псевдонимов, также снижают опасность при использовании попроектного псевдонима.</span><span class="sxs-lookup"><span data-stu-id="f4820-182">Techniques used to alleviate perspective aliasing errors also mitigate projective aliasing.</span></span> <span data-ttu-id="f4820-183">Поэлементное Присвоение псевдонимов происходит, когда нормальная поверхность поверхности является ортогональной; Эти поверхности должны получать меньше света на основе уравнений рассеянного освещения.</span><span class="sxs-lookup"><span data-stu-id="f4820-183">Projective aliasing occurs when the surface normal is orthogonal to the light; these surfaces should be receiving less light based on diffuse lighting equations.</span></span>

### <a name="shadow-acne-and-erroneous-self-shadowing"></a><span data-ttu-id="f4820-184">Теневые акне и ошибочные Self-Shadowing</span><span class="sxs-lookup"><span data-stu-id="f4820-184">Shadow Acne and Erroneous Self-Shadowing</span></span>

<span data-ttu-id="f4820-185">Теневая акне (рис. 8) — термин, сопоставляемый с неправильной тенью, происходит, когда теневая схема куантизес глубину для всего шаг текселя.</span><span class="sxs-lookup"><span data-stu-id="f4820-185">Shadow acne (Figure 8), a term synonymous with erroneous self-shadowing, occurs when the shadow map quantizes the depth over an entire texel.</span></span> <span data-ttu-id="f4820-186">Когда шейдер сравнивает фактическую глубину с этим значением, он, скорее всего, будет самозатенен, так как он должен быть скрыт.</span><span class="sxs-lookup"><span data-stu-id="f4820-186">When the shader compares an actual depth against this value, it is as likely to be self-shadowed as it is to be unshadowed.</span></span>

<span data-ttu-id="f4820-187">Еще одна причина для теневого акне заключается в том, что шаг текселя в светлом пространстве настолько близко к глубине соответствующего шаг текселя в карте глубины, что ошибки точности приводят к ошибочному выполнению теста глубины.</span><span class="sxs-lookup"><span data-stu-id="f4820-187">Another reason for shadow acne is that the texel in light space is so close to the depth of the corresponding texel in the depth map that precision errors cause the depth test to erroneously fail.</span></span> <span data-ttu-id="f4820-188">Одна из причин этой точности заключается в том, что схема глубины вычисляется аппаратным обеспечением для растрирования с фиксированной функцией, а глубина, сравниваемой с помощью, вычисляется шейдером.</span><span class="sxs-lookup"><span data-stu-id="f4820-188">One reason for this precision difference is that the depth map was calculated by the fixed-function rasterization hardware, while the depth being compared was computed by the shader.</span></span> <span data-ttu-id="f4820-189">При проецировании псевдонимов также может возникнуть теневая акне.</span><span class="sxs-lookup"><span data-stu-id="f4820-189">Projective aliasing can also cause shadow acne.</span></span>

<span data-ttu-id="f4820-190">**Рис. 8. Теневой акне артефакт**</span><span class="sxs-lookup"><span data-stu-id="f4820-190">**Figure 8. Shadow acne artifact**</span></span>

![теневой акне артефакт](images/shadow-acne-artifact.jpg)

<span data-ttu-id="f4820-192">Как показано на рисунке слева, некоторые Пиксели не прошли тестирование глубины и создали спекклед артефакты и шаблоны моирé.</span><span class="sxs-lookup"><span data-stu-id="f4820-192">As shown in the left image, some of pixels failed the depth test and created speckled artifacts and moiré patterns.</span></span> <span data-ttu-id="f4820-193">Чтобы уменьшить ошибочное затенение, границы ближней плоскости и дальней плоскости для представления освещения фрустум должны быть как можно точными.</span><span class="sxs-lookup"><span data-stu-id="f4820-193">In order to reduce erroneous self-shadowing, the bounds on the near plane and the far plane for the light space view frustum should be calculated as tightly as possible.</span></span> <span data-ttu-id="f4820-194">Смещение глубины на основе шкалы наклона и другие типы сдвига — это другие решения, используемые для смягчения акне теневой копии.</span><span class="sxs-lookup"><span data-stu-id="f4820-194">The slope scale-based depth bias and other types of bias are other solutions used to mitigate shadow acne.</span></span>

### <a name="peter-panning"></a><span data-ttu-id="f4820-195">Питер панорамирование</span><span class="sxs-lookup"><span data-stu-id="f4820-195">Peter Panning</span></span>

<span data-ttu-id="f4820-196">Термин *Питер панорамирование* извлекает свое имя из символа книги ребенка, тень которого стала отсоединена и кто может посвятить его.</span><span class="sxs-lookup"><span data-stu-id="f4820-196">The term *Peter Panning* derives its name from a children's book character whose shadow became detached and who could fly.</span></span> <span data-ttu-id="f4820-197">Этот артефакт делает так, чтобы объекты с отсутствующими темными тенями отсоединились от и перемещаются над поверхностью (рис. 9).</span><span class="sxs-lookup"><span data-stu-id="f4820-197">This artifact makes objects with missing shadows appear to be detached from and to float above the surface (Figure 9).</span></span>

<span data-ttu-id="f4820-198">**Рис. 9. Артефакт панорамирования Питер**</span><span class="sxs-lookup"><span data-stu-id="f4820-198">**Figure 9. Peter Panning artifact**</span></span>

![артефакт панорамирования Питер](images/peter-panning-artifact.jpg)

<span data-ttu-id="f4820-200">На изображении слева тень отсоединяется от объекта, создавая плавающий эффект.</span><span class="sxs-lookup"><span data-stu-id="f4820-200">In the image at left, the shadow is detached from the object, creating a floating effect.</span></span>

<span data-ttu-id="f4820-201">Одним из способов удаления Surface акне является добавление некоторого значения в пиксельную точку в пространстве. Это называется добавлением смещения глубины.</span><span class="sxs-lookup"><span data-stu-id="f4820-201">One technique for removing surface acne is to add some value to pixel position in light space; this is called adding a depth offset.</span></span> <span data-ttu-id="f4820-202">Питер выдает результаты панорамирования, если используется слишком большое смещение глубины.</span><span class="sxs-lookup"><span data-stu-id="f4820-202">Peter Panning results when the depth offset used is too large.</span></span> <span data-ttu-id="f4820-203">В этом случае смещение глубины приводит к ошибочному выполнению теста глубины.</span><span class="sxs-lookup"><span data-stu-id="f4820-203">In this case the depth offset causes the depth test to erroneously pass.</span></span> <span data-ttu-id="f4820-204">Как и в случае с теневым акне, Питер Панорамировани — усугубляться, когда в буфере глубины недостаточно точности.</span><span class="sxs-lookup"><span data-stu-id="f4820-204">Like shadow acne, Peter Panning is aggravated when there is insufficient precision in the depth buffer.</span></span> <span data-ttu-id="f4820-205">Вычисление тесных близких плоскостей и дальней плоскости также помогает избежать панорамирования Питер.</span><span class="sxs-lookup"><span data-stu-id="f4820-205">Calculating tight near planes and far planes also helps avoid Peter Panning.</span></span>

## <a name="techniques-to-improve-shadow-maps"></a><span data-ttu-id="f4820-206">Методы улучшения теневых карт</span><span class="sxs-lookup"><span data-stu-id="f4820-206">Techniques to Improve Shadow Maps</span></span>

<span data-ttu-id="f4820-207">Добавление теней к заголовку — это процесс.</span><span class="sxs-lookup"><span data-stu-id="f4820-207">Adding shadows to a title is a process.</span></span> <span data-ttu-id="f4820-208">Первым шагом является работа с базовыми теневыми картами.</span><span class="sxs-lookup"><span data-stu-id="f4820-208">The first step is to get basic shadow maps working.</span></span> <span data-ttu-id="f4820-209">Второй способ — обеспечить оптимальную работу всех базовых вычислений: Фруста по ширине, близко к дальнему, почти или далеко масштабируется жестко, используется наклонный сдвиг и т. д.</span><span class="sxs-lookup"><span data-stu-id="f4820-209">The second is to ensure all basic calculations are done optimally: frusta fit as tightly as possible, near/far planes fit tightly, slope-scaled bias is used, and so on.</span></span> <span data-ttu-id="f4820-210">После того как основные тени включены, разработчик имеет более точное представление о том, какие алгоритмы необходимы для получения достаточной точности.</span><span class="sxs-lookup"><span data-stu-id="f4820-210">Once basic shadows are enabled, and look as good as possible, the developer has a better idea of what algorithms are needed to get the shadows to sufficient fidelity.</span></span> <span data-ttu-id="f4820-211">Ниже приведены основные советы, которые могут потребоваться для получения базовых теневых карт.</span><span class="sxs-lookup"><span data-stu-id="f4820-211">Basic tips that may be needed to get basic shadow maps looking at their best are given in this section.</span></span>

### <a name="slope-scale-depth-bias"></a><span data-ttu-id="f4820-212">Slope-Scale смещение глубины</span><span class="sxs-lookup"><span data-stu-id="f4820-212">Slope-Scale Depth Bias</span></span>

<span data-ttu-id="f4820-213">Как уже упоминалось, Самозатенение может привести к теневому акне.</span><span class="sxs-lookup"><span data-stu-id="f4820-213">As previously mentioned, self-shadowing can lead to shadow acne.</span></span> <span data-ttu-id="f4820-214">Добавление слишком большого смещения может привести к сдвигу Питер.</span><span class="sxs-lookup"><span data-stu-id="f4820-214">Adding too much bias can result in Peter Panning.</span></span> <span data-ttu-id="f4820-215">Кроме того, многоугольники с интенсивным наклоненной (относительно светлой) значительно отличаются от составных псевдонимов, чем многоугольники с поверхностными наклоненнойами (относительно освещения).</span><span class="sxs-lookup"><span data-stu-id="f4820-215">Additionally, polygons with steep slopes (relative to the light) suffer more from projective aliasing than polygons with shallow slopes (relative to the light).</span></span> <span data-ttu-id="f4820-216">По этой причине для каждого значения карт глубины может потребоваться другое смещение в зависимости от наклона многоугольника относительно освещения.</span><span class="sxs-lookup"><span data-stu-id="f4820-216">Because of this, each depth map value may need a different offset depending on the polygon's slope relative to the light.</span></span>

<span data-ttu-id="f4820-217">Аппаратное обеспечение Direct3D 10 позволяет заменять многоугольник на основе его наклона относительно направления представления.</span><span class="sxs-lookup"><span data-stu-id="f4820-217">Direct3D 10 hardware has the ability to bias a polygon based on its slope with respect to the view direction.</span></span> <span data-ttu-id="f4820-218">Это влияет на применение большого смещения к многоугольнику, который просматривает ребро, в направлении освещения, но не применяет сдвиг к многоугольнику, направленному на свет напрямую.</span><span class="sxs-lookup"><span data-stu-id="f4820-218">This has the effect of applying a large bias to a polygon that is viewed edge-on to the light direction, but not applying any bias to a polygon facing the light directly.</span></span> <span data-ttu-id="f4820-219">На рис. 10 показано, как два соседних пикселя могут переобъявляться между собой при тестировании по той же несмещенной наклонной линии.</span><span class="sxs-lookup"><span data-stu-id="f4820-219">Figure 10 illustrates how two neighboring pixels can alternate between shadowed and unshadowed when testing against the same unbiased slope.</span></span>

<span data-ttu-id="f4820-220">**Рис. 10. Наклонное масштабирование — смещение по сравнению со смещением несмещенной глубины**</span><span class="sxs-lookup"><span data-stu-id="f4820-220">**Figure 10. Slope scaled depth-bias compared to unbiased depth**</span></span>

![Наклонное масштабирование — смещение по сравнению со смещением несмещенной глубины](images/slope-scaled-depth-bias-compared-to-unbiased-depth.png)

### <a name="calculating-a-tight-projection"></a><span data-ttu-id="f4820-222">Вычисление плотной проекции</span><span class="sxs-lookup"><span data-stu-id="f4820-222">Calculating a Tight Projection</span></span>

<span data-ttu-id="f4820-223">Тесная подгонка проекции освещения на представление фрустум увеличивает покрытие теневой схемы.</span><span class="sxs-lookup"><span data-stu-id="f4820-223">Tightly fitting the light's projection to the view frustum increases the shadow map coverage.</span></span> <span data-ttu-id="f4820-224">На рис. 11 показано, что использование произвольной проекции или размещение проекции в границах сцены приводит к увеличению псевдонима перспективы.</span><span class="sxs-lookup"><span data-stu-id="f4820-224">Figure 11 illustrates that using an arbitrary projection, or fitting the projection to the scene bounds, results in higher perspective aliasing.</span></span>

<span data-ttu-id="f4820-225">**Рис. 11. Произвольные теневые фрустум и тень фрустум по размеру сцены**</span><span class="sxs-lookup"><span data-stu-id="f4820-225">**Figure 11. Arbitrary shadow frustum and shadow frustum fit to scene**</span></span>

![произвольные теневые фрустум и тень фрустум по размеру сцены](images/arbitrary-shadow-frustum-and-shadow-frustum-fit-to-scene.jpg)

<span data-ttu-id="f4820-227">Представление находится с точки зрения освещения.</span><span class="sxs-lookup"><span data-stu-id="f4820-227">The view is from the point of view of the light.</span></span> <span data-ttu-id="f4820-228">Трапеция представляет фрустум в представлении камеры.</span><span class="sxs-lookup"><span data-stu-id="f4820-228">The trapezoid represents the view camera's frustum.</span></span> <span data-ttu-id="f4820-229">Сетка, нарисованная на изображении, представляет собой теневую карту.</span><span class="sxs-lookup"><span data-stu-id="f4820-229">The grid drawn over the image represents the shadow map.</span></span> <span data-ttu-id="f4820-230">На изображении справа показано, что та же теневая схема разрешения создает более шаг текселя покрытие, если оно более тесно соответствует сцене.</span><span class="sxs-lookup"><span data-stu-id="f4820-230">The image on the right shows that the same resolution shadow map creates more texel coverage when it is fit more tightly to the scene.</span></span>

<span data-ttu-id="f4820-231">На рис. 12 показаны фрустумс, которые правильно подходят.</span><span class="sxs-lookup"><span data-stu-id="f4820-231">Figure 12 illustrates frustums that are correctly fit.</span></span> <span data-ttu-id="f4820-232">Чтобы вычислить проекцию, восемь точек, составляющих представление фрустум, преобразуются в область освещения.</span><span class="sxs-lookup"><span data-stu-id="f4820-232">To calculate the projection, the eight points that make up the view frustum are transformed into light space.</span></span> <span data-ttu-id="f4820-233">Далее будут найдены минимальное и максимальное значения X и Y.</span><span class="sxs-lookup"><span data-stu-id="f4820-233">Next, the minimum and maximum values in X and Y are found.</span></span> <span data-ttu-id="f4820-234">Эти значения составляют границы ортогональной проекции.</span><span class="sxs-lookup"><span data-stu-id="f4820-234">These values make up the bounds for an orthographic projection.</span></span>

<span data-ttu-id="f4820-235">**Рис. 12. Теневая проекция по размеру представления фрустум**</span><span class="sxs-lookup"><span data-stu-id="f4820-235">**Figure 12. Shadow projection fit to view frustum**</span></span>

![Теневая проекция по размеру представления фрустум](images/shadow-projection-fit-to-view-frustum.jpg)

<span data-ttu-id="f4820-237">Можно также обрезать фрустум в сцене ААББ, чтобы получить более тесную привязку.</span><span class="sxs-lookup"><span data-stu-id="f4820-237">It is also possible to clip the frustum to the scene AABB to get a tighter bound.</span></span> <span data-ttu-id="f4820-238">Это не рекомендуется во всех случаях, так как это может изменить размер проекции лампочки с Frame на кадр.</span><span class="sxs-lookup"><span data-stu-id="f4820-238">This is not advised in all cases because this can change the size of the light camera's projection from frame to frame.</span></span> <span data-ttu-id="f4820-239">Многие методы, например, описанные в разделе, в котором перемещается освещение Texel-Sized увеличиваются, дают лучшие результаты, когда размер проекции освещения остается постоянным в каждом кадре.</span><span class="sxs-lookup"><span data-stu-id="f4820-239">Many techniques, such as those described in the section Moving the Light Texel-Sized Increments, give better results when the size of the light's projection remains constant in every frame.</span></span>

### <a name="calculating-the-near-plane-and-far-plane"></a><span data-ttu-id="f4820-240">Вычисление ближней плоскости и дальней плоскости</span><span class="sxs-lookup"><span data-stu-id="f4820-240">Calculating the Near Plane and Far Plane</span></span>

<span data-ttu-id="f4820-241">Near плоскость и FAR — это конечные части, необходимые для вычисления матрицы проекции.</span><span class="sxs-lookup"><span data-stu-id="f4820-241">The near plane and far plane are the final pieces required to calculate the projection matrix.</span></span> <span data-ttu-id="f4820-242">Чем ближе объединяется плоскости, тем точнее значения в буфере глубины.</span><span class="sxs-lookup"><span data-stu-id="f4820-242">The more closely together the planes are, the more precise the values in the depth buffer.</span></span>

<span data-ttu-id="f4820-243">Буфер глубины может быть 16-битным, 24-битным или 32-битным, со значениями от 0 до 1.</span><span class="sxs-lookup"><span data-stu-id="f4820-243">The depth buffer can be 16-bit, 24-bit, or 32-bit, with values between 0 and 1.</span></span> <span data-ttu-id="f4820-244">Как правило, буферы глубины являются фиксированными, а значения вблизи ближней плоскости группируются ближе друг к другу, чем значения, близкие к дальней плоскости.</span><span class="sxs-lookup"><span data-stu-id="f4820-244">Generally, depth buffers are fixed point, with the values close to the near plane grouped more closely together than the values close to the far plane.</span></span> <span data-ttu-id="f4820-245">Степень точности, доступная для буфера глубины, определяется отношением ближней плоскости к дальней плоскости.</span><span class="sxs-lookup"><span data-stu-id="f4820-245">The degree of precision available to the depth buffer is determined by the ratio of the near plane to the far plane.</span></span> <span data-ttu-id="f4820-246">Использование максимально близкой к дальней плоскости может позволить использовать 16-разрядный буфер глубины.</span><span class="sxs-lookup"><span data-stu-id="f4820-246">Using the tightest possible near/far plane could allow use of a 16-bit depth buffer.</span></span> <span data-ttu-id="f4820-247">16-разрядный буфер глубины может уменьшить использование памяти при увеличении скорости обработки.</span><span class="sxs-lookup"><span data-stu-id="f4820-247">A 16-bit depth buffer could reduce the use of memory while increasing processing speed.</span></span>

### <a name="aabb-based-near-plane-and-far-plane"></a><span data-ttu-id="f4820-248">AABB-Based вблизи плоскости и дальней плоскости</span><span class="sxs-lookup"><span data-stu-id="f4820-248">AABB-Based Near Plane and Far Plane</span></span>

<span data-ttu-id="f4820-249">Простой и упрощенный способ вычисления ближней плоскости и дальней плоскости заключается в преобразовании ограничивающего тома сцены в область освещения.</span><span class="sxs-lookup"><span data-stu-id="f4820-249">An easy and naive way to calculate the near plane and far plane is to transform the scene's bounding volume into light space.</span></span> <span data-ttu-id="f4820-250">Наименьшее значение координаты Z — это ближайшая плоскость, а самая крупная координата Z — это далеко плоскость.</span><span class="sxs-lookup"><span data-stu-id="f4820-250">The smallest Z-coordinate value is the near plane and the largest Z-coordinate value is the far plane.</span></span> <span data-ttu-id="f4820-251">Для многих конфигураций сцены и освещения этот подход достаточно.</span><span class="sxs-lookup"><span data-stu-id="f4820-251">For many configurations of the scene and light, this approach is sufficient.</span></span> <span data-ttu-id="f4820-252">Однако наихудший случай может привести к значительной утрате точности в буфере глубины. На рис. 13 показан такой сценарий.</span><span class="sxs-lookup"><span data-stu-id="f4820-252">The worst case scenario, however, can result in a significant loss of precision in the depth buffer; Figure 13 shows such a scenario.</span></span> <span data-ttu-id="f4820-253">Здесь диапазон ближней плоскости до дальней плоскости составляет четыре раза больше, чем требуется.</span><span class="sxs-lookup"><span data-stu-id="f4820-253">Here the range of the near plane to the far plane is four times larger than necessary.</span></span>

<span data-ttu-id="f4820-254">Представление фрустум на рис. 13 было выбрано небольшим.</span><span class="sxs-lookup"><span data-stu-id="f4820-254">The view frustum in Figure 13 was purposely chosen to be small.</span></span> <span data-ttu-id="f4820-255">Небольшое представление фрустум отображается в очень большой сцене, состоящей из идей, которые выходят за пределы представления камеры.</span><span class="sxs-lookup"><span data-stu-id="f4820-255">A small view frustum is shown in a very large scene consisting of pillars extending out from the view camera.</span></span> <span data-ttu-id="f4820-256">Использование сцены ААББ для ближайших и дальнеих плоскостей не является оптимальным.</span><span class="sxs-lookup"><span data-stu-id="f4820-256">Using the Scene AABB for the near and far planes is not optimal.</span></span> <span data-ttu-id="f4820-257">Алгоритм CSM, описанный в техническом руководстве по [каскадным картам](/windows/desktop/DxTechArts/cascaded-shadow-maps) , должен вычислять почти и далеко плоскости для очень мелких фрустумс.</span><span class="sxs-lookup"><span data-stu-id="f4820-257">The CSM algorithm described in the [Cascaded Shadow Maps](/windows/desktop/DxTechArts/cascaded-shadow-maps) technical article must calculate near and far planes for very small frustums.</span></span>

<span data-ttu-id="f4820-258">**Рис. 13. Близкие и далекое плоскости на основе сцены ААББ**</span><span class="sxs-lookup"><span data-stu-id="f4820-258">**Figure 13. Near and far planes based on Scene AABB**</span></span>

![близкие и далекое плоскости на основе сцены ААББ](images/near-far-%20planes-based-on-scene-aabb.jpg)

### <a name="frustum-based-near-plane-and-far-plane"></a><span data-ttu-id="f4820-260">Frustum-Based вблизи плоскости и дальней плоскости</span><span class="sxs-lookup"><span data-stu-id="f4820-260">Frustum-Based Near Plane and Far Plane</span></span>

<span data-ttu-id="f4820-261">Другой способ вычисления ближайших и дальнего плоскостей заключается в преобразовании фрустум в пустое пространство и использовании минимальных и максимальных значений в Z в качестве ближайших и дальнеих плоскостей соответственно.</span><span class="sxs-lookup"><span data-stu-id="f4820-261">Another technique for calculating the near and far planes is to transform the frustum into light space and use the minimal and maximal values in Z as the near and the far planes, respectively.</span></span> <span data-ttu-id="f4820-262">На рис. 14 показаны две проблемы, связанные с этим подходом.</span><span class="sxs-lookup"><span data-stu-id="f4820-262">Figure 14 illustrates the two issues with this approach.</span></span> <span data-ttu-id="f4820-263">Во-первых, вычисление слишком консервативно, как показано, когда фрустум выходит за пределы сцены.</span><span class="sxs-lookup"><span data-stu-id="f4820-263">First, the calculation is too conservative, as shown when the frustum extends beyond the scene's geometry.</span></span> <span data-ttu-id="f4820-264">Во-вторых, ближнее плоскость может быть слишком тесной, что приводит к обрезанию теней.</span><span class="sxs-lookup"><span data-stu-id="f4820-264">Second, the near plane could be too tight, causing shadow casters to be cropped.</span></span>

<span data-ttu-id="f4820-265">**Рис. 14. Почти и Far плоскости основаны исключительно на представлении фрустум**</span><span class="sxs-lookup"><span data-stu-id="f4820-265">**Figure 14. Near and far planes based solely on view frustum**</span></span>

![почти и Far плоскости основаны исключительно на представлении фрустум](images/near-far-planes-based-solely-on-view-frustum.jpg)

### <a name="light-frustum-intersected-with-scene-to-calculate-near-and-far-planes"></a><span data-ttu-id="f4820-267">Светло Фрустум, пересекающийся с сценами для вычисления ближайших и Далекных плоскостей</span><span class="sxs-lookup"><span data-stu-id="f4820-267">Light Frustum Intersected with Scene to Calculate Near and Far Planes</span></span>

<span data-ttu-id="f4820-268">Правильный способ вычисления ближайших и дальнеих плоскостей показан на рис. 15.</span><span class="sxs-lookup"><span data-stu-id="f4820-268">The proper way to calculate the near and far planes is shown in Figure 15.</span></span> <span data-ttu-id="f4820-269">Четыре из плоскостей ортогонального освещения фрустум были рассчитаны с использованием минимального и максимального значений координат X и Y представления фрустум в области освещения.</span><span class="sxs-lookup"><span data-stu-id="f4820-269">Four of the planes of the orthographic light frustum were calculated using the minimum and maximum of the X and Y coordinates of the view frustum in light space.</span></span> <span data-ttu-id="f4820-270">Последние две плоскости ортогонального представления фрустумются вблизи и дальней плоскости.</span><span class="sxs-lookup"><span data-stu-id="f4820-270">The last two planes of the orthogonal view frustum are the near and the far planes.</span></span> <span data-ttu-id="f4820-271">Чтобы найти эти плоскости, границы сцены обрезаются по четырем известным голубым фрустум плоскости.</span><span class="sxs-lookup"><span data-stu-id="f4820-271">To find these planes, the scene's bounds are clipped against the four known light frustum planes.</span></span> <span data-ttu-id="f4820-272">Наименьшее и самое большое значение Z от вновь обрезанной границы представляет собой близкую плоскость и большую плоскость соответственно.</span><span class="sxs-lookup"><span data-stu-id="f4820-272">The smallest and largest Z-values from the newly clipped boundary represent the near plane and far plane, respectively.</span></span>

<span data-ttu-id="f4820-273">Код, выполняющий эту операцию, находится в примере CascadedShadowMaps11.</span><span class="sxs-lookup"><span data-stu-id="f4820-273">The code that performs this operation is located in the CascadedShadowMaps11 sample.</span></span> <span data-ttu-id="f4820-274">Восемь точек, из которых состоит ААББ мира, преобразуются в световую область.</span><span class="sxs-lookup"><span data-stu-id="f4820-274">The eight points that make up the world's AABB are transformed into light space.</span></span> <span data-ttu-id="f4820-275">Преобразование точек в область освещения упрощает тест обрезки.</span><span class="sxs-lookup"><span data-stu-id="f4820-275">Transforming the points into light space simplifies the clipping tests.</span></span> <span data-ttu-id="f4820-276">Четыре известные плоскости светлого фрустум теперь можно представить в виде строк.</span><span class="sxs-lookup"><span data-stu-id="f4820-276">The four known planes of the light frustum can now be represented as lines.</span></span> <span data-ttu-id="f4820-277">Ограничивающий том сцены в области освещения можно представить как шесть куадрилатералс.</span><span class="sxs-lookup"><span data-stu-id="f4820-277">The scenes bounding volume in light space can be represented as six quadrilaterals.</span></span> <span data-ttu-id="f4820-278">Эти 6 куадрилатералс могут быть включены в 12 треугольников для усечения на основе треугольника.</span><span class="sxs-lookup"><span data-stu-id="f4820-278">These 6 quadrilaterals can then be turned into 12 triangles for triangle-based clipping.</span></span> <span data-ttu-id="f4820-279">Треугольники обрезаются относительно известных плоскостей представления фрустум (это горизонтальные и вертикальные линии в X и Y в пространстве).</span><span class="sxs-lookup"><span data-stu-id="f4820-279">The triangles are clipped against the known planes of the view frustum (these are horizontal and vertical lines in X and Y in light space).</span></span> <span data-ttu-id="f4820-280">При обнаружении точки пересечения в X и Y трехмерный треугольник обрезается в этой точке.</span><span class="sxs-lookup"><span data-stu-id="f4820-280">When an intersection point is found in X and Y, the 3D triangle is clipped at that point.</span></span> <span data-ttu-id="f4820-281">Минимальное и максимальное значения Z всех обрезанных треугольников — это близкая плоскость и дальнее расстояние.</span><span class="sxs-lookup"><span data-stu-id="f4820-281">The minimum and maximum Z-values of all the clipped triangles are the near plane and far plane.</span></span> <span data-ttu-id="f4820-282">В примере CascadedShadowMaps11 показано, как выполнить эту обрезку в функции **компутенеарандфар** .</span><span class="sxs-lookup"><span data-stu-id="f4820-282">The CascadedShadowMaps11 sample shows how to perform this clipping in the **ComputeNearAndFar** function.</span></span>

<span data-ttu-id="f4820-283">Существует еще две методики, которые можно использовать для вычисления тесно возможных ближайших плоскостей.</span><span class="sxs-lookup"><span data-stu-id="f4820-283">There are two more techniques that could be used to calculate the tightest possible near and far planes.</span></span> <span data-ttu-id="f4820-284">Эти методы не показаны в примере Каскадедшадовмапс.</span><span class="sxs-lookup"><span data-stu-id="f4820-284">These techniques are not shown in the CascadedShadowMaps sample.</span></span>

-   <span data-ttu-id="f4820-285">Равномерное приближение и далекое плоскости можно вычислить путем пересечения иерархии сцены или отдельных объектов сцены с светлой фрустум.</span><span class="sxs-lookup"><span data-stu-id="f4820-285">Even tighter near and far planes could be calculated by intersecting a hierarchy of a scene or individual objects in a scene against the light frustum.</span></span> <span data-ttu-id="f4820-286">Это было бы более сложным.</span><span class="sxs-lookup"><span data-stu-id="f4820-286">This would be computationally more complex.</span></span> <span data-ttu-id="f4820-287">Хотя это и не показано в примере CascadedShadowMaps11, это может быть допустимым методом для некоторых плиток.</span><span class="sxs-lookup"><span data-stu-id="f4820-287">While not illustrated in the CascadedShadowMaps11 sample, this could be a valid technique for some tiles.</span></span>
-   <span data-ttu-id="f4820-288">На дальней плоскости можно рассчитать, выполнив минимум:</span><span class="sxs-lookup"><span data-stu-id="f4820-288">The far plane could be calculated by taking the minimum of:</span></span>

    -   <span data-ttu-id="f4820-289">Самая большая глубина представления, фрустум в виде светлого пространства.</span><span class="sxs-lookup"><span data-stu-id="f4820-289">The largest depth of the view frustum in light space.</span></span>
    -   <span data-ttu-id="f4820-290">Самая большая глубина пересечения представления фрустум и сцены ААББ.</span><span class="sxs-lookup"><span data-stu-id="f4820-290">The largest depth of the intersection of the view frustum and the scene AABB.</span></span>

<span data-ttu-id="f4820-291">Этот подход может быть проблематичным при использовании с каскадными теневыми картами, где можно индексировать за пределами представления фрустум.</span><span class="sxs-lookup"><span data-stu-id="f4820-291">This approach can be problematic when used with cascaded shadow maps where it is possible to index outside of a view frustum.</span></span> <span data-ttu-id="f4820-292">В этом случае на теневой карте может отсутствовать геометрия.</span><span class="sxs-lookup"><span data-stu-id="f4820-292">In this case, the shadow map might be missing geometry.</span></span>

<span data-ttu-id="f4820-293">**Рис. 15. Близко и далекое плоскости основаны на пересечении четырех вычисляемых плоскостей светлой фрустум и ограничивающей геометрии сцены.**</span><span class="sxs-lookup"><span data-stu-id="f4820-293">**Figure 15. Near and far planes based on the intersection of the four calculated planes of the light frustum and the scene's bounding geometry**</span></span>

![близко и далекое плоскости основаны на пересечении четырех вычисляемых плоскостей светлой фрустум и ограничивающей геометрии сцены.](images/near-far-plane-based-on-intersection-of-four.jpg)

### <a name="moving-the-light-in-texel-sized-increments"></a><span data-ttu-id="f4820-295">Перемещение освещения с шагом Texel-Sized</span><span class="sxs-lookup"><span data-stu-id="f4820-295">Moving the Light in Texel-Sized Increments</span></span>

<span data-ttu-id="f4820-296">Распространенным артефактом в теневом сопоставлении является эффект Шиммеринг ребра.</span><span class="sxs-lookup"><span data-stu-id="f4820-296">A common artifact in shadow maps is the shimmering edge effect.</span></span> <span data-ttu-id="f4820-297">При перемещении камеры пикселы на краях темнее и темнее.</span><span class="sxs-lookup"><span data-stu-id="f4820-297">As the camera moves, the pixels along the shadows' edges brighten and darken.</span></span> <span data-ttu-id="f4820-298">Это не видно в изображениях, но оно очень заметно и неудобно в режиме реального времени.</span><span class="sxs-lookup"><span data-stu-id="f4820-298">This cannot be seen in still images, but it is very noticeable and distracting in real time.</span></span> <span data-ttu-id="f4820-299">На рис. 16 выделяется эта проблема, а на рис. 17 показано, как должны выглядеть тени.</span><span class="sxs-lookup"><span data-stu-id="f4820-299">Figure 16 highlights this problem and Figure 17 shows how the shadow edges should look.</span></span>

<span data-ttu-id="f4820-300">Ошибка Шиммеринг ребра возникает из-за того, что матрица низкой проекции пересчитывается каждый раз при перемещении камеры.</span><span class="sxs-lookup"><span data-stu-id="f4820-300">The shimmering edge error occurs because the light projection matrix is being recalculated every time the camera moves.</span></span> <span data-ttu-id="f4820-301">Это создает небольшие различия в созданных теневых картах.</span><span class="sxs-lookup"><span data-stu-id="f4820-301">This creates subtle differences in the generated shadow maps.</span></span> <span data-ttu-id="f4820-302">На матрицу, созданную для привязки сцены, могут влиять все следующие факторы.</span><span class="sxs-lookup"><span data-stu-id="f4820-302">All of the following factors can influence the matrix created to bound the scene.</span></span>

-   <span data-ttu-id="f4820-303">Размер представления фрустум</span><span class="sxs-lookup"><span data-stu-id="f4820-303">Size of the view frustum</span></span>
-   <span data-ttu-id="f4820-304">Ориентация представления фрустум</span><span class="sxs-lookup"><span data-stu-id="f4820-304">Orientation of the view frustum</span></span>
-   <span data-ttu-id="f4820-305">Расположение источника освещения</span><span class="sxs-lookup"><span data-stu-id="f4820-305">Location of the light</span></span>
-   <span data-ttu-id="f4820-306">Расположение камеры</span><span class="sxs-lookup"><span data-stu-id="f4820-306">Location of the camera</span></span>

<span data-ttu-id="f4820-307">При каждом изменении матрицы границы тени могут измениться.</span><span class="sxs-lookup"><span data-stu-id="f4820-307">Every time this matrix changes, the shadows edges could change.</span></span>

<span data-ttu-id="f4820-308">**Рис. 16. Шиммеринг тени**</span><span class="sxs-lookup"><span data-stu-id="f4820-308">**Figure 16. Shimmering shadow edges**</span></span>

![Шиммеринг тени](images/shimmering-shadow-edges.jpg)

<span data-ttu-id="f4820-310">Пиксели, расположенные вдоль границы тени, появляются и выходят из тени, так как камера перемещается слева направо.</span><span class="sxs-lookup"><span data-stu-id="f4820-310">The pixels along the border of the shadow come in and out of shadow as the camera moves from left to right.</span></span>

<span data-ttu-id="f4820-311">**Рис. 17. Тени, не Шиммеринг края**</span><span class="sxs-lookup"><span data-stu-id="f4820-311">**Figure 17. Shadows without shimmering edges**</span></span>

![тени, не Шиммеринг края](images/shadows-without-shimmering-edges.jpg)

<span data-ttu-id="f4820-313">Границы тени остаются постоянными, так как камера перемещается слева направо.</span><span class="sxs-lookup"><span data-stu-id="f4820-313">The shadow edges stay constant as the camera moves from left to right.</span></span>

<span data-ttu-id="f4820-314">Для направленного освещения решение этой проблемы заключается в округлении минимального и максимального значений в X и Y (которые составляют границы ортогональной проекции) к увеличению размера пикселя.</span><span class="sxs-lookup"><span data-stu-id="f4820-314">For directional lights, the solution to this problem is to round the minimum/maximum value in X and Y (that make up the orthographic projection bounds) to pixel size increments.</span></span> <span data-ttu-id="f4820-315">Это можно сделать с помощью операции деления, операции этажа и умножения.</span><span class="sxs-lookup"><span data-stu-id="f4820-315">This can be done with a divide operation, a floor operation, and a multiply.</span></span>


```C++
        vLightCameraOrthographicMin /= vWorldUnitsPerTexel;
        vLightCameraOrthographicMin = XMVectorFloor( vLightCameraOrthographicMin );
        vLightCameraOrthographicMin *= vWorldUnitsPerTexel;
        vLightCameraOrthographicMax /= vWorldUnitsPerTexel;
        vLightCameraOrthographicMax = XMVectorFloor( vLightCameraOrthographicMax );
        vLightCameraOrthographicMax *= vWorldUnitsPerTexel;
```



<span data-ttu-id="f4820-316">Значение Вворлдунитспертексел вычисляется путем взятия границы представления фрустум и деления на размер буфера.</span><span class="sxs-lookup"><span data-stu-id="f4820-316">The vWorldUnitsPerTexel value is calculated by taking a bound of the view frustum, and dividing by the buffer size.</span></span>


```C++
        FLOAT fWorldUnitsPerTexel = fCascadeBound /
        (float)m_CopyOfCascadeConfig.m_iBufferSize;
        vWorldUnitsPerTexel = XMVectorSet( fWorldUnitsPerTexel, fWorldUnitsPerTexel,                            0.0f, 0.0f );
```



<span data-ttu-id="f4820-317">Ограничение максимального размера представления фрустум приводит к отслабому размеру ортогональной проекции.</span><span class="sxs-lookup"><span data-stu-id="f4820-317">Bounding the maximum size of the view frustum results in a looser fit for the orthographic projection.</span></span>

<span data-ttu-id="f4820-318">Важно отметить, что при использовании этого метода текстура размером в 1 пиксель больше по ширине и высоте.</span><span class="sxs-lookup"><span data-stu-id="f4820-318">It is important to note that the texture is 1 pixel larger in width and height when using this technique.</span></span> <span data-ttu-id="f4820-319">Это позволяет сохранять координаты теневой копии за пределами теневой схемы.</span><span class="sxs-lookup"><span data-stu-id="f4820-319">This keeps shadow coordinates from indexing outside of the shadow map.</span></span>

### <a name="back-face-and-front-face"></a><span data-ttu-id="f4820-320">Задняя поверхность и передняя сторона</span><span class="sxs-lookup"><span data-stu-id="f4820-320">Back Face and Front Face</span></span>

<span data-ttu-id="f4820-321">Теневые карты должны быть подготовлены к просмотру со стандартным отбором фоновых лиц, процессом, который пропускает растрирование объектов, которые средство просмотра не может видеть, и ускоряет рендеринг сцены.</span><span class="sxs-lookup"><span data-stu-id="f4820-321">Shadow maps should be rendered with standard back-face culling, a process that skips rasterization of objects that the viewer cannot see, and speeds up rendering of the scene.</span></span> <span data-ttu-id="f4820-322">Другой распространенный вариант — отображение теневых карт с включенным отбором внешних лицевых сторон, что означает, что объекты, расположенные в средстве просмотра, исключаются.</span><span class="sxs-lookup"><span data-stu-id="f4820-322">Another common option is to render shadow maps with front-face culling enabled, which means that objects facing the viewer are eliminated.</span></span> <span data-ttu-id="f4820-323">Аргумент для этого заключается в том, что он помогает при самотеневой работе, так как геометрией объектов, составляющих обратную передачу, немного смещены.</span><span class="sxs-lookup"><span data-stu-id="f4820-323">The argument for this is that it helps with self-shadowing as the geometry making up the back of objects is slightly offset.</span></span> <span data-ttu-id="f4820-324">У этой идеи есть две проблемы.</span><span class="sxs-lookup"><span data-stu-id="f4820-324">There are two problems with this idea.</span></span>

-   <span data-ttu-id="f4820-325">Любой объект с неправильной геометрией или фигурой заднего плана вызывает артефакты на теневой карте.</span><span class="sxs-lookup"><span data-stu-id="f4820-325">Any object with improper front-face or back-face geometry causes artifacts in the shadow map.</span></span> <span data-ttu-id="f4820-326">Тем не менее, наличие неправильной геометрии или геометрического объекта приведет к возникновению других проблем, поэтому может быть уверенным, что поверхность внешнего лица и фоновая геометрия выполняются правильно.</span><span class="sxs-lookup"><span data-stu-id="f4820-326">However, having incorrect front-face or back-face geometry will cause other problems, so it may be safe to assume front-face and back-face geometry is done correctly.</span></span> <span data-ttu-id="f4820-327">Создание задних граней на основе спрайта, например фолиаже, может оказаться нецелесообразным.</span><span class="sxs-lookup"><span data-stu-id="f4820-327">It may be impractical to create back faces for sprite-based geometry such as foliage.</span></span>
-   <span data-ttu-id="f4820-328">Питер прокрутка и тени на основе таких объектов, как стенки, скорее всего, будут возникать из-за того, что невелика степень четности глубины тени.</span><span class="sxs-lookup"><span data-stu-id="f4820-328">Peter Panning and shadow gaps near the base of objects such as walls are more likely to occur because the shadow depth disparity is too small.</span></span>

### <a name="shadow-mapfriendly-geometry"></a><span data-ttu-id="f4820-329">Теневая схема — удобная геометрия</span><span class="sxs-lookup"><span data-stu-id="f4820-329">Shadow Map–Friendly Geometry</span></span>

<span data-ttu-id="f4820-330">Создание геометрии, хорошо работающей в теневых картах, обеспечивает большую гибкость при борьбе с артефактами, такими как Питер панорамирование и Shadow акне.</span><span class="sxs-lookup"><span data-stu-id="f4820-330">Creating geometry that works well in shadow maps allows for more flexibility when combating artifacts like Peter Panning and shadow acne.</span></span>

<span data-ttu-id="f4820-331">При самоскрытии на жестких краях возникают проблемы.</span><span class="sxs-lookup"><span data-stu-id="f4820-331">Hard edges are problematic for self-shadowing.</span></span> <span data-ttu-id="f4820-332">Несоответствие глубины по отношению к кончику ребра очень мало.</span><span class="sxs-lookup"><span data-stu-id="f4820-332">The depth disparity near the tip of the edge is very small.</span></span> <span data-ttu-id="f4820-333">Даже небольшое смещение может привести к потере теней объектов (рис. 18).</span><span class="sxs-lookup"><span data-stu-id="f4820-333">Even a small offset can cause objects to lose their shadows (Figure 18).</span></span>

<span data-ttu-id="f4820-334">**Рис. 18. Резкие края приводят к корню артефактов от низкого уровня без четности с использованием смещений.**</span><span class="sxs-lookup"><span data-stu-id="f4820-334">**Figure 18. Sharp edges cause artifacts stemming from low-depth disparity with offsets**</span></span>

![резкие края приводят к корню артефактов от низкого уровня без четности с использованием смещений.](images/sharp-edges-cause%20artifacts.jpg)

<span data-ttu-id="f4820-336">Узкие объекты, такие как стены, должны иметь обратную передачу, даже если они никогда не видны.</span><span class="sxs-lookup"><span data-stu-id="f4820-336">Narrow objects such as walls should have backs even if they are never visible.</span></span> <span data-ttu-id="f4820-337">Это увеличит несоответствие глубины.</span><span class="sxs-lookup"><span data-stu-id="f4820-337">This will increase the depth disparity.</span></span>

<span data-ttu-id="f4820-338">Также важно убедиться в правильности направления геометрии. то есть за пределами объекта должен быть обратен, а внутри объекта — внешним.</span><span class="sxs-lookup"><span data-stu-id="f4820-338">It's also important to make sure that the direction the geometry is facing is correct; that is, the outside of an object should be back facing and the inside of an object should be front facing.</span></span> <span data-ttu-id="f4820-339">Это важно для подготовки к просмотру с включенным отбором обратных лиц, а также для борьбы с эффектами смещения глубины.</span><span class="sxs-lookup"><span data-stu-id="f4820-339">This is important for rendering with back-face culling enabled, as well as for combating the effects of depth bias.</span></span>

## <a name="summary"></a><span data-ttu-id="f4820-340">Сводка</span><span class="sxs-lookup"><span data-stu-id="f4820-340">Summary</span></span>

<span data-ttu-id="f4820-341">Методы, описанные в этой статье, можно использовать для повышения качества стандартных теневых карт.</span><span class="sxs-lookup"><span data-stu-id="f4820-341">The techniques described in this article can be used to increase the quality of standard shadow maps.</span></span> <span data-ttu-id="f4820-342">Следующим шагом является рассмотрение методов, которые могут хорошо работать со стандартными теневыми картами.</span><span class="sxs-lookup"><span data-stu-id="f4820-342">The next step is to look at techniques that can work well with standard shadow maps.</span></span> <span data-ttu-id="f4820-343">Ксмс рекомендуется использовать в качестве старших методик для борьбы с псевдонимами перспективы.</span><span class="sxs-lookup"><span data-stu-id="f4820-343">CSMs are recommended as a superior technique to combat perspective aliasing.</span></span> <span data-ttu-id="f4820-344">В процентах более тесная фильтрация или теневые карты отклонений можно использовать для смягчения границ тени.</span><span class="sxs-lookup"><span data-stu-id="f4820-344">Percentage closer filtering or variance shadow maps can be used to soften shadow edges.</span></span> <span data-ttu-id="f4820-345">Дополнительные сведения см. в технической статье с [каскадными картами теневых карт](/windows/desktop/DxTechArts/cascaded-shadow-maps) .</span><span class="sxs-lookup"><span data-stu-id="f4820-345">See the [Cascaded Shadow Maps](/windows/desktop/DxTechArts/cascaded-shadow-maps) technical article for more information.</span></span>

<span data-ttu-id="f4820-346">Доннелли, W. и Лауритзен — [теневые карты с дисперсией](https://portal.acm.org/citation.cfm?doid=1111411.1111440).</span><span class="sxs-lookup"><span data-stu-id="f4820-346">Donnelly, W., and Lauritzen, A. [Variance Shadow Maps](https://portal.acm.org/citation.cfm?doid=1111411.1111440).</span></span> <span data-ttu-id="f4820-347">Symposium на интерактивной трехмерной графике, материалы 2006 Symposium в интерактивной трехмерной графике и играх.</span><span class="sxs-lookup"><span data-stu-id="f4820-347">Symposium on Interactive 3D Graphics, Proceedings of the 2006 Symposium on Interactive 3D Graphics and Games.</span></span> <span data-ttu-id="f4820-348">2006, PP. 161 – 165.</span><span class="sxs-lookup"><span data-stu-id="f4820-348">2006, pp. 161–165.</span></span>

<span data-ttu-id="f4820-349">Енжел, Вофлганг F. раздел 4.</span><span class="sxs-lookup"><span data-stu-id="f4820-349">Engel, Woflgang F. Section 4.</span></span> <span data-ttu-id="f4820-350">Каскадные теневые карты.</span><span class="sxs-lookup"><span data-stu-id="f4820-350">Cascaded Shadow Maps.</span></span> <span data-ttu-id="f4820-351">ShaderX5, *Дополнительные методы отрисовки*, Волфганг F. Енжел, ED.</span><span class="sxs-lookup"><span data-stu-id="f4820-351">ShaderX5, *Advanced Rendering Techniques*, Wolfgang F. Engel, Ed.</span></span> <span data-ttu-id="f4820-352">Чарльз River Media, Бостон, Массачусетс.</span><span class="sxs-lookup"><span data-stu-id="f4820-352">Charles River Media, Boston, Massachusetts.</span></span> <span data-ttu-id="f4820-353">2006.</span><span class="sxs-lookup"><span data-stu-id="f4820-353">2006.</span></span> <span data-ttu-id="f4820-354">PP. 197 – 206.</span><span class="sxs-lookup"><span data-stu-id="f4820-354">pp. 197–206.</span></span>

<span data-ttu-id="f4820-355">Стамминжер, (Marc и Дреттакис, Георгия.</span><span class="sxs-lookup"><span data-stu-id="f4820-355">Stamminger, Marc, and Drettakis, George.</span></span> <span data-ttu-id="f4820-356">[Теневые карты перспективы](https://portal.acm.org/citation.cfm?id=566616).</span><span class="sxs-lookup"><span data-stu-id="f4820-356">[Perspective Shadow Maps](https://portal.acm.org/citation.cfm?id=566616).</span></span> <span data-ttu-id="f4820-357">Международная конференция по компьютерной графике и интерактивным технологиям, *материалы на 29 ежегодных конференциях по компьютерной графике и интерактивным технологиям*.</span><span class="sxs-lookup"><span data-stu-id="f4820-357">International Conference on Computer Graphics and Interactive Techniques, *Proceedings of the 29th Annual Conference on Computer Graphics and Interactive Techniques*.</span></span> <span data-ttu-id="f4820-358">2002, PP 557 — 562.</span><span class="sxs-lookup"><span data-stu-id="f4820-358">2002, pp 557–562.</span></span>

<span data-ttu-id="f4820-359">Виммер, M., Счерзер, D. и Пургасофер, W. [область с точки зрения теневой карты](https://www.cg.tuwien.ac.at/research/vr/lispsm/shadows_egsr2004_revised.pdf).</span><span class="sxs-lookup"><span data-stu-id="f4820-359">Wimmer, M., Scherzer, D., and Purgathofer, W. [Light Space Perspective Shadow Maps](https://www.cg.tuwien.ac.at/research/vr/lispsm/shadows_egsr2004_revised.pdf).</span></span> <span data-ttu-id="f4820-360">Еурографикс Symposium при подготовке к просмотру.</span><span class="sxs-lookup"><span data-stu-id="f4820-360">Eurographics Symposium on Rendering.</span></span> <span data-ttu-id="f4820-361">2004.</span><span class="sxs-lookup"><span data-stu-id="f4820-361">2004.</span></span> <span data-ttu-id="f4820-362">Пересмотрено 10 июня 2005 г.</span><span class="sxs-lookup"><span data-stu-id="f4820-362">Revised June 10, 2005.</span></span> <span data-ttu-id="f4820-363">[Течнисче Университäт Виен](https://www.cg.tuwien.ac.at/research/vr/lispsm/).</span><span class="sxs-lookup"><span data-stu-id="f4820-363">[Technische Universität Wien](https://www.cg.tuwien.ac.at/research/vr/lispsm/).</span></span>

 

 
