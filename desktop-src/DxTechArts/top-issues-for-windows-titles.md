---
title: Основные проблемы с заголовками Windows
description: В этой статье описываются многие из распространенных проблем, которые мы видели в компьютерных играх, посвященных поколениям.
ms.assetid: 89b83473-1aa9-9a2d-8778-15cfb91cdea4
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 547c977f7d8e4895ef73ba229a9012854a7c6d27
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "105661767"
---
# <a name="top-issues-for-windows-titles"></a><span data-ttu-id="b39a7-103">Основные проблемы с заголовками Windows</span><span class="sxs-lookup"><span data-stu-id="b39a7-103">Top Issues for Windows Titles</span></span>

<span data-ttu-id="b39a7-104">Группа "связи для разработчиков игровых и графических технологий Microsoft Windows" выполняет анализ производительности для многих игр Windows каждый год.</span><span class="sxs-lookup"><span data-stu-id="b39a7-104">The Microsoft Windows Gaming and Graphics Technologies Developer Relations group performs performance analysis for many Windows games each year.</span></span> <span data-ttu-id="b39a7-105">Во время этих сеансов мы получаем практический опыт в отношении отзывов разработчиков и запросов, которые мы получаем ежедневно.</span><span class="sxs-lookup"><span data-stu-id="b39a7-105">During these sessions, we get hands-on experience to tie into the developer feedback and queries we receive daily.</span></span> <span data-ttu-id="b39a7-106">Иногда мы можем отmysterious сбой или другую проблему в названии, что дает нам дополнительные сведения о проблемах, возникающих у разработчиков.</span><span class="sxs-lookup"><span data-stu-id="b39a7-106">Occasionally we help track down a mysterious crash or other problem in a title, which gives us further insight into problems that developers are encountering.</span></span>

<span data-ttu-id="b39a7-107">В этой статье описываются многие из распространенных проблем, которые мы видели в компьютерных играх, посвященных поколениям.</span><span class="sxs-lookup"><span data-stu-id="b39a7-107">This article highlights many of the common issues we've seen in current-generation PC games.</span></span>

-   [<span data-ttu-id="b39a7-108">Производительность, ограниченная ЦП</span><span class="sxs-lookup"><span data-stu-id="b39a7-108">CPU-Limited Performance</span></span>](#cpu-limited-performance)
-   [<span data-ttu-id="b39a7-109">Плохое управление пакетами</span><span class="sxs-lookup"><span data-stu-id="b39a7-109">Poor Batch Management</span></span>](#poor-batch-management)
-   [<span data-ttu-id="b39a7-110">Чрезмерное копирование памяти</span><span class="sxs-lookup"><span data-stu-id="b39a7-110">Excessive Memory Copying</span></span>](#excessive-memory-copying)
-   [<span data-ttu-id="b39a7-111">Чрезмерное использование динамической отправки Draw</span><span class="sxs-lookup"><span data-stu-id="b39a7-111">Excessive Use of Dynamic Draw Submission</span></span>](#excessive-use-of-dynamic-draw-submission)
-   [<span data-ttu-id="b39a7-112">Большие издержки при обработке файлов</span><span class="sxs-lookup"><span data-stu-id="b39a7-112">High Overhead in File Processing</span></span>](#high-overhead-in-file-processing)
-   [<span data-ttu-id="b39a7-113">Снижение производительности и неприятной установки</span><span class="sxs-lookup"><span data-stu-id="b39a7-113">Slow and Frustrating Installation</span></span>](#slow-and-frustrating-installation)
-   [<span data-ttu-id="b39a7-114">Отсутствие внимания физической памяти</span><span class="sxs-lookup"><span data-stu-id="b39a7-114">Lack of Consideration of Physical Memory</span></span>](#lack-of-consideration-of-physical-memory)
-   [<span data-ttu-id="b39a7-115">Чрезмерная зависимость от Real-Time преобразование частоты дискретизации образца звука</span><span class="sxs-lookup"><span data-stu-id="b39a7-115">Over-Reliance on Real-Time Audio Sample Rate Conversion</span></span>](#over-reliance-on-real-time-audio-sample-rate-conversion)
-   [<span data-ttu-id="b39a7-116">Фрагментация виртуальной памяти</span><span class="sxs-lookup"><span data-stu-id="b39a7-116">Fragmention of Virtual Memory</span></span>](#fragmention-of-virtual-memory)
-   [<span data-ttu-id="b39a7-117">Управление Floating-Pointным словом</span><span class="sxs-lookup"><span data-stu-id="b39a7-117">Manipulation of the Floating-Point Control Word</span></span>](#manipulation-of-the-floating-point-control-word)
-   [<span data-ttu-id="b39a7-118">Необязательная установка среды выполнения DirectX</span><span class="sxs-lookup"><span data-stu-id="b39a7-118">Optional Installation of the DirectX Runtime</span></span>](#optional-installation-of-the-directx-runtime)
-   [<span data-ttu-id="b39a7-119">Чрезмерное использование синхронизации потоков</span><span class="sxs-lookup"><span data-stu-id="b39a7-119">Excessive Use of Thread Synchronization</span></span>](#excessive-use-of-thread-synchronization)
-   [<span data-ttu-id="b39a7-120">Использование RDTSC</span><span class="sxs-lookup"><span data-stu-id="b39a7-120">Use of RDTSC</span></span>](#use-of-rdtsc)

## <a name="cpu-limited-performance"></a><span data-ttu-id="b39a7-121">Производительность CPU-Limited</span><span class="sxs-lookup"><span data-stu-id="b39a7-121">CPU-Limited Performance</span></span>

<span data-ttu-id="b39a7-122">Подавляющее большинство игр ограничивается производительностью ЦП в системах с высокопроизводительными графическими процессорами (GPU).</span><span class="sxs-lookup"><span data-stu-id="b39a7-122">The vast majority of games are limited by CPU performance on systems with high-performance graphics processing units (GPUs).</span></span> <span data-ttu-id="b39a7-123">Иногда это обусловлено плохим использованием пакетной обработки для прорисовки отправок, но, как правило, это обусловлено тем, что другие игровые системы потребляют большую часть доступных циклов ЦП.</span><span class="sxs-lookup"><span data-stu-id="b39a7-123">This is sometimes due to poor use of batching for draw submissions, but more typically, this is due to other game systems consuming a large portion of the available CPU cycles.</span></span> <span data-ttu-id="b39a7-124">В некоторых случаях, в которых мы видели GPU как ограничение, причина в том, что это очень высокая скорость заполнения или потребность шейдера пикселей, в параметрах с высоким разрешением или с низкой производительностью вершинного шейдера видеоадаптером.</span><span class="sxs-lookup"><span data-stu-id="b39a7-124">In the few cases in which we have seen the GPU as the limitation, the cause is very high fill rates or pixel shader demand, in high-resolution settings, or low vertex-shader performance by a video card.</span></span>

<span data-ttu-id="b39a7-125">Так как большинство заголовков заключаются в ограниченном объеме ЦП, крупнейший уровень производительности, полученный в результате оптимизации игровых компьютерных систем.</span><span class="sxs-lookup"><span data-stu-id="b39a7-125">Because most titles are CPU-limited, the biggest performance wins come from optimizing CPU-intensive game systems.</span></span> <span data-ttu-id="b39a7-126">Как правило, ИСКУССТВЕНные и физические системы, а также связанная логика обнаружения конфликтов являются основными потребителями циклов ЦП в хорошо работающих приложениях Microsoft Direct3D.</span><span class="sxs-lookup"><span data-stu-id="b39a7-126">Typically, the AI or physics systems and the associated collision-detection logic are the primary consumers of CPU cycles in well-behaving Microsoft Direct3D applications.</span></span> <span data-ttu-id="b39a7-127">Любая работа по улучшению этих систем может повысить общую производительность игры.</span><span class="sxs-lookup"><span data-stu-id="b39a7-127">Any work to improve these systems can improve the overall performance of the game.</span></span>

## <a name="poor-batch-management"></a><span data-ttu-id="b39a7-128">Плохое управление пакетами</span><span class="sxs-lookup"><span data-stu-id="b39a7-128">Poor Batch Management</span></span>

<span data-ttu-id="b39a7-129">Для достижения хорошего параллелизма при использовании GPU необходимо, чтобы пакеты Draw содержали достаточное геометрическую форму, а шейдеры имеют правильную сложность — для того, чтобы видеокарта была занята, в то время как не используется настолько много пакетов, что буфер команд будет переполнен.</span><span class="sxs-lookup"><span data-stu-id="b39a7-129">Achieving good parallelism with the GPU requires that draw batches contain enough geometry — and the shaders have the right complexity — to keep the video card busy, while not using so many batches that the command buffer is flooded.</span></span> <span data-ttu-id="b39a7-130">На оборудовании с текущим поколением рекомендуется приблизительно 300 или меньшее количество отправок пакетов на кадр (меньшее количество на ЦП с более низким уровнем производительности), чтобы предотвратить обработку драйвера буфером командной строки из-за узкого места в производительности.</span><span class="sxs-lookup"><span data-stu-id="b39a7-130">On current-generation hardware, we recommend approximately 300 or fewer draw-batch submissions per frame (fewer on lower-performance CPUs) to prevent the driver's processing of the command-buffer from becoming a performance bottleneck.</span></span> <span data-ttu-id="b39a7-131">Некоторые другие вызовы состояния API и сочетания драйверов могут привести к дорогостоящей обработке ЦП (например, компиляции драйвера шейдеров), поэтому мы настоятельно рекомендуем выполнять регулярный анализ производительности.</span><span class="sxs-lookup"><span data-stu-id="b39a7-131">Some other API state calls and driver combinations can result in costly CPU processing (driver compiling of shaders, for example), so we highly recommend routine performance analysis.</span></span>

## <a name="excessive-memory-copying"></a><span data-ttu-id="b39a7-132">Чрезмерное копирование памяти</span><span class="sxs-lookup"><span data-stu-id="b39a7-132">Excessive Memory Copying</span></span>

<span data-ttu-id="b39a7-133">Во время разработки большинства заголовков компьютеров разработчики используют удобные структуры данных и строки для управления содержимым.</span><span class="sxs-lookup"><span data-stu-id="b39a7-133">During the development of most PC titles, developers use convenient data structures and strings for content management.</span></span> <span data-ttu-id="b39a7-134">Работа ЦП, необходимая для сравнения строк, копирования и других манипуляций, часто имеет измеряемую нагрузку, особенно при отсчете результатов производительности, связанных с кэшем и подсистемой памяти.</span><span class="sxs-lookup"><span data-stu-id="b39a7-134">The CPU work required for string comparison, copying, and other manipulations often has a measurable overhead, particularly when taking into account the performance hits associated with the cache and memory subsystem.</span></span> <span data-ttu-id="b39a7-135">Планы следует создавать при разработке этих систем для удаления или минимизации зависимости от обработки строк после того, как продукт переходит на основной этап тестирования и выпуска.</span><span class="sxs-lookup"><span data-stu-id="b39a7-135">Plans should be made when developing these systems for removing or minimizing the reliance on string processing once the product enters into the primary testing and release phases.</span></span>

## <a name="excessive-use-of-dynamic-draw-submission"></a><span data-ttu-id="b39a7-136">Чрезмерное использование динамической отправки Draw</span><span class="sxs-lookup"><span data-stu-id="b39a7-136">Excessive Use of Dynamic Draw Submission</span></span>

<span data-ttu-id="b39a7-137">Современное видеооборудование хорошо работает при работе со статическими данными.</span><span class="sxs-lookup"><span data-stu-id="b39a7-137">Modern video hardware performs well when dealing with static data.</span></span> <span data-ttu-id="b39a7-138">Высокопроизводительные адаптеры часто имеют очень большой объем видеопамяти, но эта память не может эффективно использоваться динамическими данными.</span><span class="sxs-lookup"><span data-stu-id="b39a7-138">High-end adapters often have a very large amount of video memory, but this memory cannot be effectively utilized by dynamic data.</span></span>

<span data-ttu-id="b39a7-139">Хотя для динамического содержимого можно реализовать достаточно эффективное использование динамических буферов вершин и буферов индексов, многие заголовки изменяют эту идиому для того, что в противном случае является статическим содержимым.</span><span class="sxs-lookup"><span data-stu-id="b39a7-139">While reasonably efficient usage patterns of dynamic vertex buffers/index buffers can be implemented for dynamic content, many titles overuse this idiom for what is otherwise static content.</span></span> <span data-ttu-id="b39a7-140">Мы чаще всего увидим это с помощью двоичных деревьев секционирования (BSP) и систем на портале, которые хранят геометрию в структуре данных, которая не сопоставлена с оборудованием и должна обрабатываться в буферах для каждого кадра.</span><span class="sxs-lookup"><span data-stu-id="b39a7-140">We most often see this with binary space partitioning (BSP) trees and portal-based systems that store geometry in a data structure that does not map to the hardware and must be processed into buffers for every frame.</span></span> <span data-ttu-id="b39a7-141">Помещение как можно большого содержимого в статические ресурсы может значительно снизить затраты на пропускную способность передачи данных на видеоадаптер, улучшить использование встроенного видеоконтроллера и снизить нагрузку на ЦП и кэш, связанные с обработкой этого содержимого.</span><span class="sxs-lookup"><span data-stu-id="b39a7-141">Putting as much content into static resources as possible can greatly reduce the bandwidth overhead of transferring data to the video card, make better use of on-board VRAM, and reduce the CPU/cache overhead involved in processing this content.</span></span>

## <a name="high-overhead-in-file-processing"></a><span data-ttu-id="b39a7-142">Большие издержки при обработке файлов</span><span class="sxs-lookup"><span data-stu-id="b39a7-142">High Overhead in File Processing</span></span>

<span data-ttu-id="b39a7-143">Компьютерные игры получили репутацию для длительных загрузок, особенно при сравнении с названиями консолей с строгими требованиями к времени загрузки.</span><span class="sxs-lookup"><span data-stu-id="b39a7-143">PC games have gotten a reputation for long loading times, particular when compared with console titles with strict loading-time requirements.</span></span> <span data-ttu-id="b39a7-144">Наш анализ того, как многие заголовки используют файловую систему, показывает некоторые распространенные проблемы.</span><span class="sxs-lookup"><span data-stu-id="b39a7-144">Our analysis of the way that many titles make use of the file subsystem reveals some common issues.</span></span>

<span data-ttu-id="b39a7-145">Затраты на открытие файла обычно значительно выше, чем у разработчиков.</span><span class="sxs-lookup"><span data-stu-id="b39a7-145">The overhead of opening a file is usually much higher than developers expect.</span></span> <span data-ttu-id="b39a7-146">При использовании антивирусных сканеров по запросу, а также дополнительных функциональных возможностей NTFS открытие файла является довольно дорогостоящей операцией.</span><span class="sxs-lookup"><span data-stu-id="b39a7-146">With on-demand virus scanners in widespread use, and the additional functionality of NTFS, opening a file is a fairly expensive operation.</span></span> <span data-ttu-id="b39a7-147">Одновременное открытие нескольких файлов или открытие и закрытие одного и того же файла является неудачным методом работы с управлением файлами.</span><span class="sxs-lookup"><span data-stu-id="b39a7-147">Opening many files at once or opening and closing the same file repeatedly is therefore a poor method of dealing with file management.</span></span> <span data-ttu-id="b39a7-148">Некоторые игры предпринимали попытку снизить затраты на производительность, проверяя наличие файла перед его открытием.</span><span class="sxs-lookup"><span data-stu-id="b39a7-148">Some games have attempted to mitigate this performance cost by testing for the existence of a file before opening it.</span></span> <span data-ttu-id="b39a7-149">В реальности тестирование существования файла в файловой системе NTFS требует открытия файла, поэтому тестирование перед открытием приведет к оплате стоимости дважды.</span><span class="sxs-lookup"><span data-stu-id="b39a7-149">The reality is that testing for the existence of a file on NTFS requires opening the file, so testing before opening results in paying the cost twice.</span></span>

<span data-ttu-id="b39a7-150">Игры, которые позволяют вносить изменения в надстройки или МОДС или которые по-прежнему включают в себя формирование шаблонов разработки для проверки файлов данных переопределения, могут иметь значительные задержки при загрузке игры из-за проверки этих файлов, даже если эти файлы отсутствуют.</span><span class="sxs-lookup"><span data-stu-id="b39a7-150">Games that allow add-on modifications, or mods, or that still include development scaffolding to check for override data files, can have significant delays in loading the game because of checking for these files, even when those files are not present.</span></span> <span data-ttu-id="b39a7-151">Рекомендуется проверять наличие этих файлов только при запуске с помощью специального параметра командной строки или другого индикатора режима, чтобы только те пользователи, которые используют эту функцию, фактически платят за производительность этих (часто обширных) проверок.</span><span class="sxs-lookup"><span data-stu-id="b39a7-151">We recommend that games only check for these files when run with a special command-line switch, or other mode indicator, so that only those users who make use of this functionality actually pay the performance cost of these (often extensive) checks.</span></span>

<span data-ttu-id="b39a7-152">Дополнительные показатели производительности можно получить в файловой системе следующим образом:</span><span class="sxs-lookup"><span data-stu-id="b39a7-152">Additional performance can be obtained from the file system by the following:</span></span>

-   <span data-ttu-id="b39a7-153">Правильное использование флага файла подсказок в файловой системе для \_ \_ \_ \_ последовательного доступа и флага файла \_ последовательный \_ Просмотр</span><span class="sxs-lookup"><span data-stu-id="b39a7-153">Appropriate use of the file system hints FILE\_FLAG\_RANDOM\_ACCESS and FILE\_FLAG\_SEQUENTIAL\_SCAN</span></span>
-   <span data-ttu-id="b39a7-154">Изменение размера буферов во избежание большого количества вызовов API-интерфейсов чтения и записи операционной системы</span><span class="sxs-lookup"><span data-stu-id="b39a7-154">Sizing buffers to avoid a large quantity of calls to the read/write APIs of the OS</span></span>
-   <span data-ttu-id="b39a7-155">Асинхронный доступ к файлам</span><span class="sxs-lookup"><span data-stu-id="b39a7-155">Accessing files asynchronously</span></span>
-   <span data-ttu-id="b39a7-156">Загрузка потоков в фоновом режиме</span><span class="sxs-lookup"><span data-stu-id="b39a7-156">Loading threads in the background</span></span>

<span data-ttu-id="b39a7-157">Мы также настоятельно рекомендуем преобразовать данные в автономном режиме (во время сборки или установки) вместо того, чтобы полагаться на преобразование при первом запуске игры, так как это накладывает значительный налог на производительность для каждого пользователя.</span><span class="sxs-lookup"><span data-stu-id="b39a7-157">We also strongly recommend converting data offline (at build or installation time) rather than relying on conversion when the game is first run, as doing so imposes a significant performance tax for every user.</span></span>

## <a name="slow-and-frustrating-installation"></a><span data-ttu-id="b39a7-158">Снижение производительности и неприятной установки</span><span class="sxs-lookup"><span data-stu-id="b39a7-158">Slow and Frustrating Installation</span></span>

<span data-ttu-id="b39a7-159">Другой распространенной проблемой, которую мы видели, является очень длительное время установки, необходимое для многих современных компьютерных игр.</span><span class="sxs-lookup"><span data-stu-id="b39a7-159">Another common issue we've seen is very long installation times required for many modern PC games.</span></span> <span data-ttu-id="b39a7-160">Установщики запрашивают пользователя много раз, иногда просто сообщают пользователю, например «вам не нужно устанавливать DirectX».</span><span class="sxs-lookup"><span data-stu-id="b39a7-160">The installers prompt the user many times, sometimes simply to tell the user, for example, "You do not need DirectX installed."</span></span> <span data-ttu-id="b39a7-161">Как правило, для этих установщиков требуется, чтобы пользователь выберет " **Далее** " или " **ОК** " несколько раз перед началом установки игры.</span><span class="sxs-lookup"><span data-stu-id="b39a7-161">Generally, these offending installers require the user to select **Next** or **OK** many times before installation of the game actually begins.</span></span> <span data-ttu-id="b39a7-162">После этого мы видели, что некоторые заголовки занимают от часа до того, как пользователь получит возможность играть в игру.</span><span class="sxs-lookup"><span data-stu-id="b39a7-162">Once it does begin, we've seen some titles take an hour or more before the user gets the opportunity to play the game.</span></span> <span data-ttu-id="b39a7-163">Мы настоятельно рекомендуем, чтобы первый час воспроизведения игры не был установлен.</span><span class="sxs-lookup"><span data-stu-id="b39a7-163">We feel strongly that the first hour of game play experience should not be the installation.</span></span>

<span data-ttu-id="b39a7-164">Мы рекомендуем использовать ряд подходов к работе с установкой.</span><span class="sxs-lookup"><span data-stu-id="b39a7-164">We recommend a number of approaches for dealing with installation.</span></span> <span data-ttu-id="b39a7-165">Во-первых, необходимо, чтобы запросы были простыми и минимальными.</span><span class="sxs-lookup"><span data-stu-id="b39a7-165">First, keep the prompts simple and to a minimum.</span></span> <span data-ttu-id="b39a7-166">Во-вторых, разработайте данные игры, чтобы некоторые или все файлы данных можно было использовать непосредственно с установочного диска, где это возможно — современные диски DVD имеют очень высокую пропускную способность.</span><span class="sxs-lookup"><span data-stu-id="b39a7-166">Second, architect your game data such that some or all the data files can be used directly from the distribution disk where possible — modern DVD drives have very high bandwidth.</span></span> <span data-ttu-id="b39a7-167">В-третьих, рекомендуется реализовать в ваших заголовках установку по запросу, чтобы сократить или исключить процесс установки и позволить пользователям быстро перейти в игру как можно быстрее.</span><span class="sxs-lookup"><span data-stu-id="b39a7-167">Third, consider implementing install-on-demand in your titles to reduce or eliminate the installation process and allow users to get into the game as quickly as possible.</span></span> <span data-ttu-id="b39a7-168">(Дополнительные сведения об установке по запросу см. [в статье Установка по запросу для игр](/windows/desktop/DxTechArts/install-on-demand-for-games).)</span><span class="sxs-lookup"><span data-stu-id="b39a7-168">(For more information about installing on demand, see [Install-on-Demand for Games](/windows/desktop/DxTechArts/install-on-demand-for-games).)</span></span>

<span data-ttu-id="b39a7-169">Дополнительные рекомендации по установке игр см. в разделе [Упрощение установки игр](/windows/desktop/DxTechArts/simplifying-game-installation).</span><span class="sxs-lookup"><span data-stu-id="b39a7-169">For more recommendations about game installation, see [Simplifying Game Installation](/windows/desktop/DxTechArts/simplifying-game-installation).</span></span>

## <a name="lack-of-consideration-of-physical-memory"></a><span data-ttu-id="b39a7-170">Отсутствие внимания физической памяти</span><span class="sxs-lookup"><span data-stu-id="b39a7-170">Lack of Consideration of Physical Memory</span></span>

<span data-ttu-id="b39a7-171">Из-за широкой вариативности оборудования ПК на рынке заголовки обычно используют нерегламентированные тесты конфигурации для выбора параметров по умолчанию для уровня графических деталей.</span><span class="sxs-lookup"><span data-stu-id="b39a7-171">Because of the wide variability of PC hardware in the market, titles typically make use of ad hoc configuration tests to select default settings for the level of graphical detail.</span></span> <span data-ttu-id="b39a7-172">Некоторые из названий, которые мы видели, используют размер памяти видео в этих тестах, но при этом не удается сопоставить это с объемом физической памяти.</span><span class="sxs-lookup"><span data-stu-id="b39a7-172">Some of the titles we've seen are using video memory size in these tests, but failing to correlate this with physical memory size.</span></span> <span data-ttu-id="b39a7-173">Для работы с потерянными устройствами большая часть видеопамяти (как местного, так и нелокального апертуры памяти AGP) должна поддерживаться физической памятью либо с помощью управляемых ресурсов, либо из пользовательских структур данных.</span><span class="sxs-lookup"><span data-stu-id="b39a7-173">In order to handle lost-device situations, the majority of the video memory (both local VRAM on the card and the non-local AGP memory aperture) must be backed by physical memory, either through the use of managed resources or custom data structures.</span></span> <span data-ttu-id="b39a7-174">Некоторые высококачественные видеоадаптеры имеют размеры видеопамяти, которые приводят к размеру процессора низкого уровня.</span><span class="sxs-lookup"><span data-stu-id="b39a7-174">Some high-end video cards have VRAM sizes rivaling the size of low-end CPU memories.</span></span> <span data-ttu-id="b39a7-175">В ситуациях, когда в системе ограничена физическая память по сравнению с видеоадаптером, большая часть этой видеопамяти не может эффективно использоваться, а также должны быть настроены более низкие параметры.</span><span class="sxs-lookup"><span data-stu-id="b39a7-175">In situations where the system has limited physical memory compared to the video card, most of that VRAM cannot be effectively utilized, and lower detail settings should be configured.</span></span>

## <a name="over-reliance-on-real-time-audio-sample-rate-conversion"></a><span data-ttu-id="b39a7-176">Over-Reliance преобразования частоты дискретизации Real-Time Audio</span><span class="sxs-lookup"><span data-stu-id="b39a7-176">Over-Reliance on Real-Time Audio Sample Rate Conversion</span></span>

<span data-ttu-id="b39a7-177">Другой распространенный источник цикла ЦП, который мы наблюдали, возникает, когда для преобразования скорости воспроизведения во время смешивания в аппаратном буфере требуется звуковая система.</span><span class="sxs-lookup"><span data-stu-id="b39a7-177">Another common source of CPU cycle burn we've seen occurs when the audio system is required to convert the playback rate during mix into the hardware buffer.</span></span> <span data-ttu-id="b39a7-178">При использовании драйверов WDM (WDM) формат буфера оборудования не находится под прямым управлением приложениями, так как это ресурс уровня ядра. Вместо этого формат выбирается на основе формата наивысшего качества всех источников и возможностей оборудования.</span><span class="sxs-lookup"><span data-stu-id="b39a7-178">With Windows Driver Model (WDM) drivers, the hardware buffer format is not under direct application control, because it is a kernel-level resource; instead, the format is selected based on the highest-quality format of all sources and the capabilities of the hardware.</span></span> <span data-ttu-id="b39a7-179">По умолчанию в Windows XP используется высококачественное преобразование частоты дискретизации для этого процесса, и если для большинства примеров звука требуется преобразование курсов, будет потреблена значительная часть циклов ЦП.</span><span class="sxs-lookup"><span data-stu-id="b39a7-179">By default, Windows XP uses a high-quality sample rate conversion for this process, and if the majority of the audio samples require a rate conversion, a significant portion of the CPU cycles will be consumed.</span></span>

<span data-ttu-id="b39a7-180">Рекомендуется создавать все буферы DirectSound с одинаковой частотой выборки.</span><span class="sxs-lookup"><span data-stu-id="b39a7-180">We recommend creating all of your DirectSound buffers with the same sample rate.</span></span> <span data-ttu-id="b39a7-181">Если вы используете функции **звуковых** функций Microsoft Win32, вы также должны использовать одинаковую частоту выборки.</span><span class="sxs-lookup"><span data-stu-id="b39a7-181">If you make any use of Microsoft Win32 **waveOut** functions, you should use a consistent sample rate with these, too.</span></span> <span data-ttu-id="b39a7-182">При использовании драйверов WDM все буферы будут смешиваться ядром, и если в некоторых из них используется более высокая частота дискретизации, то частота дискретизации всех остальных элементов будет преобразована в соответствие.</span><span class="sxs-lookup"><span data-stu-id="b39a7-182">With WDM drivers, the buffers will all be mixed by the kernel, and if you use a higher sampling rate on some of them, the sample rates of all of the rest will be converted to match.</span></span> <span data-ttu-id="b39a7-183">Обратите внимание, что это подразумевает использование одинакового темпа воспроизведения для всех образцов звука, включая любые буферы потокового сжатия звука.</span><span class="sxs-lookup"><span data-stu-id="b39a7-183">Note that this implies using the same playback rate for all your audio samples, including any streaming audio decompression buffers.</span></span> <span data-ttu-id="b39a7-184">Настройка основной буферной ставки не действует, если вы не используете Windows 98 или Windows Millennium Edition.</span><span class="sxs-lookup"><span data-stu-id="b39a7-184">Setting the primary buffer rate has no effect unless you are targeting either Windows 98 or Windows Millennium Edition.</span></span>

> [!Note]  
> <span data-ttu-id="b39a7-185">В Windows Vista и более поздних версиях операционной системы DirectSound и **звуковые** данные используют [API-интерфейс Windows Audio (васапи)](/windows/desktop/CoreAudio/wasapi) для всех выходных данных звука.</span><span class="sxs-lookup"><span data-stu-id="b39a7-185">On Windows Vista and later versions of the operating system, DirectSound and **waveOut** use the [Windows Audio Session API (WASAPI)](/windows/desktop/CoreAudio/wasapi) for all audio output.</span></span>

 

## <a name="fragmention-of-virtual-memory"></a><span data-ttu-id="b39a7-186">Фрагментация виртуальной памяти</span><span class="sxs-lookup"><span data-stu-id="b39a7-186">Fragmention of Virtual Memory</span></span>

<span data-ttu-id="b39a7-187">Мы рассмотрели ряд последних проблем, связанных с 32-разрядным ограничением на объем памяти процесса.</span><span class="sxs-lookup"><span data-stu-id="b39a7-187">We've seen a number of recent issues related to the 32-bit limit on process memory space.</span></span> <span data-ttu-id="b39a7-188">Несмотря на то, что 2 ГБ виртуального адресного пространства для процессов пользовательского режима были более точными, увеличение использования больших размещенных в памяти файлов, пользовательских распределительов памяти и увеличения размера видеопамяти (который должен быть сопоставлен с пространством процесса) приступило к ситуациям, когда выделение пространства виртуальной памяти завершается неудачей.</span><span class="sxs-lookup"><span data-stu-id="b39a7-188">While 2 GB of virtual address space for user-mode processes has been more than adequate historically, the increased use of large memory-mapped files, custom memory allocators, and increasing VRAM size (which must be mapped into process space) has started to cause situations where allocations of virtual memory space are failing.</span></span> <span data-ttu-id="b39a7-189">Некоторые библиотеки DLL сторонних производителей используют расположения с фиксированным запуском в середине виртуального адресного пространства, что вызывает фрагментацию, приводящую к неудачному выделению.</span><span class="sxs-lookup"><span data-stu-id="b39a7-189">Some non-Microsoft DLLs are using fixed-start locations in the middle of the virtual address space, which is causing fragmentation that results in failed allocations.</span></span>

<span data-ttu-id="b39a7-190">Чаще всего эти проблемы возникают, когда игра использует пользовательскую схему выделения памяти, которая пытается выделить большой непрерывный блок виртуальной памяти.</span><span class="sxs-lookup"><span data-stu-id="b39a7-190">These problems most often appear when the game makes use of a custom memory allocation scheme that attempts to allocate a large continuous chunk of virtual memory space.</span></span> <span data-ttu-id="b39a7-191">Наша рекомендация заключается в написании распределительов таким образом, что они запрашивают более разумное количество частей виртуального адресного пространства по мере необходимости.</span><span class="sxs-lookup"><span data-stu-id="b39a7-191">Our recommendation is to write allocators such that they request more reasonably sized portions of the virtual address space as needed.</span></span> <span data-ttu-id="b39a7-192">Например, запрашивает 64 или 256 МБ за раз, но не 1 ГБ.</span><span class="sxs-lookup"><span data-stu-id="b39a7-192">For example, requesting 64 or 256 MB at a time, but not 1 GB.</span></span> <span data-ttu-id="b39a7-193">Однако следует соблюдать осторожность, чтобы не приводилось к дальнейшей фрагментации.</span><span class="sxs-lookup"><span data-stu-id="b39a7-193">However, care should be taken to not cause further fragmentation.</span></span> <span data-ttu-id="b39a7-194">Появление 64-разрядных операционных систем и оборудования значительно поможет устранить эти проблемы в будущем, но необходимо соблюдать осторожность при работе с 32-разрядными системами текущего поколения.</span><span class="sxs-lookup"><span data-stu-id="b39a7-194">The advent of 64-bit operating systems and hardware will greatly help these issues in the future, but care must be taken on current-generation 32-bit systems.</span></span>

## <a name="manipulation-of-the-floating-point-control-word"></a><span data-ttu-id="b39a7-195">Управление Floating-Pointным словом</span><span class="sxs-lookup"><span data-stu-id="b39a7-195">Manipulation of the Floating-Point Control Word</span></span>

<span data-ttu-id="b39a7-196">В качестве вспомогательного средства отладки некоторые разработчики могли включить исключения в блоке с плавающей запятой (FPU), используя манипуляции с управляющим словом с плавающей запятой.</span><span class="sxs-lookup"><span data-stu-id="b39a7-196">As a debugging aid, some developers have been enabling exceptions on the floating-point unit (FPU) via manipulations of the floating-point control word.</span></span> <span data-ttu-id="b39a7-197">Это очень проблематично и, скорее всего, приведет к сбою процесса.</span><span class="sxs-lookup"><span data-stu-id="b39a7-197">Doing this is highly problematic and will likely cause the process to crash.</span></span> <span data-ttu-id="b39a7-198">Так же, как и в соглашении о вызовах, необходимо сохранить регистр EBX, большинство из них предполагает, что FPU находится в состоянии по умолчанию, выдаст разумные результаты и не создаст исключения.</span><span class="sxs-lookup"><span data-stu-id="b39a7-198">Just like the calling convention requires that the ebx register be preserved, the majority of the system assumes that the FPU is in a default state, will give reasonable results, and won't generate exceptions.</span></span> <span data-ttu-id="b39a7-199">Драйверы и другие системные компоненты часто вычисляют результаты на основе предположения о том, что стандартные значения ошибок будут отображаться в регистрах для неверных условий, но если исключения включены, они будут необработанными и приведут к сбоям.</span><span class="sxs-lookup"><span data-stu-id="b39a7-199">Drivers and other system components will often compute results based on the assumption that standard error values will appear in the registers for bad conditions, but if exceptions are enabled, these will go unhandled and result in crashes.</span></span>

<span data-ttu-id="b39a7-200">При инициализации вызывающего потока Direct3D задаст единицу с плавающей запятой с одинарной точностью и округлением до ближайшего значения, если не \_ \_ используется флаг D3DCREATE FPU PRESERVE, в этом случае управляющее слово с плавающей запятой не затрагивается.</span><span class="sxs-lookup"><span data-stu-id="b39a7-200">Direct3D will set the floating-point unit to single-precision, round-to-nearest as part of initialization for the calling thread, unless the D3DCREATE\_FPU\_PRESERVE flag is used, in which case, the floating-point control word is untouched.</span></span> <span data-ttu-id="b39a7-201">Так как управляющее слово — это параметр для каждого потока, гарантируя, что все потоки приложения будут иметь режим одиночной точности, может оптимизировать производительность.</span><span class="sxs-lookup"><span data-stu-id="b39a7-201">Since the control word is a per-thread setting, ensuring that all of your application threads are set to single-precision mode may optimize performance.</span></span> <span data-ttu-id="b39a7-202">Помните, что вызов [**\_ control87**](https://msdn.microsoft.com/library/e9b52ceh(v=VS.71).aspx) не является допустимым для кодирования машинного кода x64, который использует исключительно хранимую функцию SSE. это чрезвычайно дорого в архитектуре на основе PowerPC для ЦП Xbox 360.</span><span class="sxs-lookup"><span data-stu-id="b39a7-202">Remember that calling [**\_control87**](https://msdn.microsoft.com/library/e9b52ceh(v=VS.71).aspx) is not valid for x64-native coding, which uses SSE exclusively instead, and it is extremely expensive on the PowerPC-based architecture of the Xbox 360 CPU.</span></span>

> [!Note]  
> <span data-ttu-id="b39a7-203">При изменении управляющего слова используйте [**\_ контролфп \_ s**](https://msdn.microsoft.com/library/c9676k6h(v=VS.80).aspx) и имейте в виду, что для платформ x64 невозможно изменить точность с плавающей запятой с помощью управляющего слова.</span><span class="sxs-lookup"><span data-stu-id="b39a7-203">If you modify the control word, use [**\_controlfp\_s**](https://msdn.microsoft.com/library/c9676k6h(v=VS.80).aspx) and be aware that for x64 platforms you can't change the floating-point precision via the control word.</span></span>

 

<span data-ttu-id="b39a7-204">В любых библиотеках, где нам нужны различные правила округления или другое поведение (например, работа с шейдерами или компиляцией вершин программного обеспечения), мы сохраняем и восстанавливаем управляющее слово.</span><span class="sxs-lookup"><span data-stu-id="b39a7-204">In any libraries where we need to have different rounding rules or other behavior — such as dealing with software vertex shaders or compilation — we save and restore the control word.</span></span> <span data-ttu-id="b39a7-205">Если в игре необходимо использовать нестандартные исключения округления или FPU, он должен сохранить и восстановить управляющее слово с плавающей запятой, и следует убедиться, что он не вызывает какой-либо внешний код, который не был проверен на наличие защиты от этих проблем, включая системные API.</span><span class="sxs-lookup"><span data-stu-id="b39a7-205">If a game needs to make use of non-standard rounding or FPU exceptions, it should save and restore the floating-point control word, and you should be sure that it does not call any external code that has not been proven to be safe from these problems, including system APIs.</span></span>

## <a name="optional-installation-of-the-directx-runtime"></a><span data-ttu-id="b39a7-206">Необязательная установка среды выполнения DirectX</span><span class="sxs-lookup"><span data-stu-id="b39a7-206">Optional Installation of the DirectX Runtime</span></span>

<span data-ttu-id="b39a7-207">Несколько игр запрашивают у пользователя, следует ли устанавливать DirectX.</span><span class="sxs-lookup"><span data-stu-id="b39a7-207">A number of games ask the user whether to install DirectX.</span></span> <span data-ttu-id="b39a7-208">Это может вызвать проблемы, если пользователь предполагает, что в системе установлен последний распространяемый пакет DirectX, и пропустит установку, и установка продолжится успешно.</span><span class="sxs-lookup"><span data-stu-id="b39a7-208">This can cause problems if the user assumes that the system has the latest DirectX redistributable installed and skips installation, and subsequently, the installation continues successfully.</span></span> <span data-ttu-id="b39a7-209">Если для игры требуется определенная версия D3DX или другие обновленные функции, которые не были установлены, то игра не будет работать, и пользователь будет очень разочарован.</span><span class="sxs-lookup"><span data-stu-id="b39a7-209">If the game requires a specific version of D3DX, or other updated functionality that was not installed, then the game won't work, and the user will get very frustrated.</span></span>

<span data-ttu-id="b39a7-210">Настоятельно рекомендуется, чтобы установщик игры автоматически устанавливал распространяемый пакет DirectX, для которого была создана игра.</span><span class="sxs-lookup"><span data-stu-id="b39a7-210">It is strongly recommended that the game's installer silently install the DirectX redistributable that the game was built against.</span></span> <span data-ttu-id="b39a7-211">Процесс установки DirectX разработан таким образом, что он проверяет, нужно ли обновлять и быстро возвращать, если это не так.</span><span class="sxs-lookup"><span data-stu-id="b39a7-211">The DirectX installation process is designed so that it verifies whether anything needs to be updated and quickly returns if it doesn't.</span></span> <span data-ttu-id="b39a7-212">Поэтому нет необходимости спрашивать пользователя об установке DirectX.</span><span class="sxs-lookup"><span data-stu-id="b39a7-212">So, there is no need to ask the user about installing DirectX.</span></span>

<span data-ttu-id="b39a7-213">Автоматическая установка DirectX можно выполнить, выполнив следующую команду из установочного пакета: **dxsetup.exe/Silent**</span><span class="sxs-lookup"><span data-stu-id="b39a7-213">A silent installation of DirectX can be done by running this command from your installation package: **dxsetup.exe /silent**</span></span>

<span data-ttu-id="b39a7-214">Кроме того, фактический размер повторно распространяемой папки можно настроить так, чтобы она включала только те CAB-файлы (CAB), которые действительно необходимы для целевых платформ и использования игр.</span><span class="sxs-lookup"><span data-stu-id="b39a7-214">Furthermore, the actual size of the redistributable folder can be configured to include only those cabinet files (.cab) that are actually needed for the game's target platforms and usage.</span></span>

> [!Note]  
> <span data-ttu-id="b39a7-215">Прежде чем использовать **дкссетуп**, прочтите эту [прямую установку](https://walbourn.github.io/).</span><span class="sxs-lookup"><span data-stu-id="b39a7-215">Before you use **dxsetup**, read [Not So Direct Setup](https://walbourn.github.io/).</span></span>

 

## <a name="excessive-use-of-thread-synchronization"></a><span data-ttu-id="b39a7-216">Чрезмерное использование синхронизации потоков</span><span class="sxs-lookup"><span data-stu-id="b39a7-216">Excessive Use of Thread Synchronization</span></span>

<span data-ttu-id="b39a7-217">При профилировании игр часто обнаруживаются основные точки доступа, которые связаны с вводом и отнесением критических разделов.</span><span class="sxs-lookup"><span data-stu-id="b39a7-217">When profiling games, the top hotspots are often found to be related to entering and leaving critical sections.</span></span> <span data-ttu-id="b39a7-218">Благодаря распространению многоядерных ЦП использование многопоточности в играх значительно увеличилось, и многие реализации используют интенсивное использование синхронизации потоков.</span><span class="sxs-lookup"><span data-stu-id="b39a7-218">With the prevalence of multi-core CPUs, the use of multithreading in games has increased dramatically, and many implementations rely on heavy use of thread synchronization.</span></span> <span data-ttu-id="b39a7-219">Время ЦП для получения критической секции даже без конкуренции весьма существенным, и все остальные формы синхронизации потоков еще более дороги.</span><span class="sxs-lookup"><span data-stu-id="b39a7-219">The CPU time to take a critical section even without any contention is quite significant, and all other forms of thread synchronization are even more expensive.</span></span> <span data-ttu-id="b39a7-220">Поэтому необходимо соблюдать осторожность, чтобы не использовать эти примитивы.</span><span class="sxs-lookup"><span data-stu-id="b39a7-220">So, care must be taken to minimize the use of these primitives.</span></span>

<span data-ttu-id="b39a7-221">Распространенным источником чрезмерной синхронизации в играх является использование [D3DCREATE \_ многопоточности](/windows/desktop/direct3d9/d3dcreate).</span><span class="sxs-lookup"><span data-stu-id="b39a7-221">A common source of excessive synchronization in games is the use of [D3DCREATE\_MULTITHREADED](/windows/desktop/direct3d9/d3dcreate).</span></span> <span data-ttu-id="b39a7-222">Этот флаг, в то же время обеспечивая потокобезопасность Direct3D для отрисовки из нескольких потоков, принимает очень консервативный подход, что приводит к высокой нагрузке на синхронизацию.</span><span class="sxs-lookup"><span data-stu-id="b39a7-222">This flag, while making Direct3D thread-safe for rendering from multiple threads, takes a very conservative approach, resulting in high synchronization overhead.</span></span> <span data-ttu-id="b39a7-223">Игры не следует использовать этот флаг.</span><span class="sxs-lookup"><span data-stu-id="b39a7-223">Games should avoid this flag.</span></span> <span data-ttu-id="b39a7-224">Вместо этого необходимо спроектировать ядро так, чтобы все взаимодействие с Direct3D выполнялось из одного потока и обмен данными между потоками осуществляется напрямую.</span><span class="sxs-lookup"><span data-stu-id="b39a7-224">Instead, architect the engine so that all communication with Direct3D is from a single thread and any communication between threads is handled directly.</span></span> <span data-ttu-id="b39a7-225">Дополнительные сведения о проектировании многопоточных игр см. в статье [написание кода для нескольких ядер на Xbox 360 и Microsoft Windows](/windows/desktop/DxTechArts/coding-for-multiple-cores).</span><span class="sxs-lookup"><span data-stu-id="b39a7-225">For more information about designing multi-threaded games, see the article [Coding For Multiple Cores on Xbox 360 and Microsoft Windows](/windows/desktop/DxTechArts/coding-for-multiple-cores).</span></span>

## <a name="use-of-rdtsc"></a><span data-ttu-id="b39a7-226">Использование RDTSC</span><span class="sxs-lookup"><span data-stu-id="b39a7-226">Use of RDTSC</span></span>

<span data-ttu-id="b39a7-227">Использование инструкции x86 **RDTSC** не рекомендуется.</span><span class="sxs-lookup"><span data-stu-id="b39a7-227">Use of the x86 instruction **RDTSC** is not recommended.</span></span> <span data-ttu-id="b39a7-228">**RDTSC** не может правильно вычислить время для некоторых схем управления питанием, которые изменяют частоту ЦП динамически и на многих многоядерных ЦП, для которых счетчик циклов не синхронизируется между ядрами.</span><span class="sxs-lookup"><span data-stu-id="b39a7-228">**RDTSC** fails to correctly compute timing on some power management schemes that change the CPU frequency dynamically and on many multi-core CPUs for which the cycle counter is not synchronized between cores.</span></span> <span data-ttu-id="b39a7-229">Вместо этого в играх следует использовать API [**QueryPerformanceCounter**](/windows/desktop/api/profileapi/nf-profileapi-queryperformancecounter) .</span><span class="sxs-lookup"><span data-stu-id="b39a7-229">Games should instead use the [**QueryPerformanceCounter**](/windows/desktop/api/profileapi/nf-profileapi-queryperformancecounter) API.</span></span> <span data-ttu-id="b39a7-230">Дополнительные сведения о проблемах с **RDTSC** и реализации времени высокого разрешения с помощью **QueryPerformanceCounter** см. в статье [время игры и многоядерные процессоры](/windows/desktop/DxTechArts/game-timing-and-multicore-processors).</span><span class="sxs-lookup"><span data-stu-id="b39a7-230">For more information about issues with **RDTSC** and implementing high-resolution timing with **QueryPerformanceCounter**, see the article [Game Timing and Multicore Processors](/windows/desktop/DxTechArts/game-timing-and-multicore-processors).</span></span>

 

 