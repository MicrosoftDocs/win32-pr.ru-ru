---
title: Расписание игры и многоядерный процессор
description: В этой статье предлагается более точное и надежное решение для получения времени ЦП с высоким разрешением с помощью интерфейсов API Windows QueryPerformanceCounter и Куериперформанцефрекуенци.
ms.assetid: 1512324d-dffa-3681-be3f-f63a3b8f11db
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9c5c511f558b59e94945e63c44db225f34ac2583
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "105681658"
---
# <a name="game-timing-and-multicore-processors"></a><span data-ttu-id="60fc0-103">Расписание игры и многоядерный процессор</span><span class="sxs-lookup"><span data-stu-id="60fc0-103">Game Timing and Multicore Processors</span></span>

<span data-ttu-id="60fc0-104">Благодаря тому, что технологии управления питанием становятся более распространенными на современных компьютерах, часто используемый метод для получения времени ЦП с высоким разрешением, инструкция RDTSC может перестать работать должным образом.</span><span class="sxs-lookup"><span data-stu-id="60fc0-104">With power management technologies becoming more commonplace in today's computers, a commonly-used method to obtain high-resolution CPU timings, the RDTSC instruction, may no longer work as expected.</span></span> <span data-ttu-id="60fc0-105">В этой статье предлагается более точное и надежное решение для получения времени ЦП с высоким разрешением с помощью интерфейсов API Windows [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) и [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span><span class="sxs-lookup"><span data-stu-id="60fc0-105">This article suggests a more accurate, reliable solution to obtain high-resolution CPU timings by using the Windows APIs [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

-   [<span data-ttu-id="60fc0-106">Фон</span><span class="sxs-lookup"><span data-stu-id="60fc0-106">Background</span></span>](#background)
-   [<span data-ttu-id="60fc0-107">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="60fc0-107">Recommendations</span></span>](#recommendations)
-   [<span data-ttu-id="60fc0-108">Совместимость приложений</span><span class="sxs-lookup"><span data-stu-id="60fc0-108">Application Compatibility</span></span>](#application-compatibility)

## <a name="background"></a><span data-ttu-id="60fc0-109">Историческая справка</span><span class="sxs-lookup"><span data-stu-id="60fc0-109">Background</span></span>

<span data-ttu-id="60fc0-110">С момента появления набора инструкций x86 P5 многие разработчики игр использовали счетчик меток времени чтения, инструкцию RDTSC для выполнения высокого разрешения времени.</span><span class="sxs-lookup"><span data-stu-id="60fc0-110">Since the introduction of the x86 P5 instruction set, many game developers have made use of read time stamp counter, the RDTSC instruction, to perform high-resolution timing.</span></span> <span data-ttu-id="60fc0-111">Таймеры мультимедиа Windows достаточно точны для обработки звука и видео, но с продолжением кадров со временем до десятка миллисекунд они не имеют достаточного разрешения для предоставления сведений о Дельта-времени.</span><span class="sxs-lookup"><span data-stu-id="60fc0-111">The Windows multimedia timers are precise enough for sound and video processing, but with frame times of a dozen milliseconds or less, they don't have enough resolution to provide delta-time information.</span></span> <span data-ttu-id="60fc0-112">Многие игры по-прежнему используют таймер мультимедиа при запуске, чтобы установить частоту ЦП, и используют это значение частоты для масштабирования результатов из RDTSC, чтобы получить точное время.</span><span class="sxs-lookup"><span data-stu-id="60fc0-112">Many games still use a multimedia timer at start-up to establish the frequency of the CPU, and they use that frequency value to scale results from RDTSC to get accurate time.</span></span> <span data-ttu-id="60fc0-113">Из-за ограничений RDTSC API Windows предоставляет более правильный способ доступа к этим функциям с помощью подпрограмм [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) и [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span><span class="sxs-lookup"><span data-stu-id="60fc0-113">Due to the limitations of RDTSC, the Windows API exposes the more correct way to access this functionality through the routines of [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

<span data-ttu-id="60fc0-114">Такое использование RDTSC в отношении времени снижается из следующих фундаментальных проблем:</span><span class="sxs-lookup"><span data-stu-id="60fc0-114">This use of RDTSC for timing suffers from these fundamental issues:</span></span>

-   <span data-ttu-id="60fc0-115">Ненепрерывные значения.</span><span class="sxs-lookup"><span data-stu-id="60fc0-115">Discontinuous values.</span></span> <span data-ttu-id="60fc0-116">Использование RDTSC напрямую предполагает, что поток всегда работает на том же процессоре.</span><span class="sxs-lookup"><span data-stu-id="60fc0-116">Using RDTSC directly assumes that the thread is always running on the same processor.</span></span> <span data-ttu-id="60fc0-117">Многопроцессорные и двухъядерные системы не гарантируют синхронизацию их счетчиков циклов между ядрами.</span><span class="sxs-lookup"><span data-stu-id="60fc0-117">Multiprocessor and dual-core systems do not guarantee synchronization of their cycle counters between cores.</span></span> <span data-ttu-id="60fc0-118">Это усугубятся в сочетании с современными технологиями управления питанием, которые бездействуют и восстанавливают различные ядра в разное время, что приводит к несинхронизированности ядер.</span><span class="sxs-lookup"><span data-stu-id="60fc0-118">This is exacerbated when combined with modern power management technologies that idle and restore various cores at different times, which results in the cores typically being out of synchronization.</span></span> <span data-ttu-id="60fc0-119">Для приложения это, как правило, приводит к возникновению сбоев или к сбоям при переходе потока между процессорами и получением значений времени, которые приводят к большим различиям, отрицательным разности или времени остановки.</span><span class="sxs-lookup"><span data-stu-id="60fc0-119">For an application, this generally results in glitches or in potential crashes as the thread jumps between the processors and gets timing values that result in large deltas, negative deltas, or halted timing.</span></span>
-   <span data-ttu-id="60fc0-120">Доступность выделенного оборудования.</span><span class="sxs-lookup"><span data-stu-id="60fc0-120">Availability of dedicated hardware.</span></span> <span data-ttu-id="60fc0-121">RDTSC блокирует сведения о времени, которые приложение запрашивает в счетчике цикла процессора.</span><span class="sxs-lookup"><span data-stu-id="60fc0-121">RDTSC locks the timing information that the application requests to the processor's cycle counter.</span></span> <span data-ttu-id="60fc0-122">В течение многих лет это был лучший способ получения сведений о времени высокой точности, но новые системные платы теперь включают выделенные временные устройства, которые предоставляют сведения о времени высокого разрешения без недостатков RDTSC.</span><span class="sxs-lookup"><span data-stu-id="60fc0-122">For many years this was the best way to get high-precision timing information, but newer motherboards are now including dedicated timing devices which provide high-resolution timing information without the drawbacks of RDTSC.</span></span>
-   <span data-ttu-id="60fc0-123">Вариативность частоты ЦП.</span><span class="sxs-lookup"><span data-stu-id="60fc0-123">Variability of the CPU's frequency.</span></span> <span data-ttu-id="60fc0-124">Предполагается, что частота ЦП фиксирована в течение жизненного цикла программы.</span><span class="sxs-lookup"><span data-stu-id="60fc0-124">The assumption is often made that the frequency of the CPU is fixed for the life of the program.</span></span> <span data-ttu-id="60fc0-125">Однако благодаря современным технологиям управления питанием это неверное предположение.</span><span class="sxs-lookup"><span data-stu-id="60fc0-125">However, with modern power management technologies, this is an incorrect assumption.</span></span> <span data-ttu-id="60fc0-126">В то время как изначально ограничены переносными компьютерами и другими мобильными устройствами, технология, которая изменяет частоту ЦП, используется во многих настольных ПК. Отключение своей функции для поддержания постоянной частоты обычно неприемлемо для пользователей.</span><span class="sxs-lookup"><span data-stu-id="60fc0-126">While initially limited to laptop computers and other mobile devices, technology that changes the frequency of the CPU is in use in many high-end desktop PCs; disabling its function to maintain a consistent frequency is generally not acceptable to users.</span></span>

## <a name="recommendations"></a><span data-ttu-id="60fc0-127">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="60fc0-127">Recommendations</span></span>

<span data-ttu-id="60fc0-128">Играм требуются точные сведения о времени, но также необходимо реализовать код времени, чтобы избежать проблем, связанных с использованием RDTSC.</span><span class="sxs-lookup"><span data-stu-id="60fc0-128">Games need accurate timing information, but you also need to implement timing code in a way that avoids the problems associated with using RDTSC.</span></span> <span data-ttu-id="60fc0-129">При реализации синхронизации с высоким разрешением выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="60fc0-129">When you implement high-resolution timing, take the following steps:</span></span>

1.  <span data-ttu-id="60fc0-130">Используйте [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) и [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) вместо RDTSC.</span><span class="sxs-lookup"><span data-stu-id="60fc0-130">Use [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) instead of RDTSC.</span></span> <span data-ttu-id="60fc0-131">Эти API-интерфейсы могут использовать RDTSC, но вместо этого могут использовать устройства управления временем на материнской плате или другие системные службы, предоставляющие высококачественные сведения о времени высокого разрешения.</span><span class="sxs-lookup"><span data-stu-id="60fc0-131">These APIs may make use of RDTSC, but might instead make use of a timing devices on the motherboard or some other system services that provide high-quality high-resolution timing information.</span></span> <span data-ttu-id="60fc0-132">Хотя RDTSC работает гораздо быстрее, чем **QueryPerformanceCounter**, поскольку последний является вызовом API, он представляет собой API, который может вызываться несколько сотен раз на кадр без заметного воздействия.</span><span class="sxs-lookup"><span data-stu-id="60fc0-132">While RDTSC is much faster than **QueryPerformanceCounter**, since the latter is an API call, it is an API that can be called several hundred times per frame without any noticeable impact.</span></span> <span data-ttu-id="60fc0-133">(Тем не менее, разработчики должны попытаться вызвать **QueryPerformanceCounter** как можно меньше, чтобы избежать снижения производительности.)</span><span class="sxs-lookup"><span data-stu-id="60fc0-133">(Nevertheless, developers should attempt to have their games call **QueryPerformanceCounter** as little as possible to avoid any performance penalty.)</span></span>
2.  <span data-ttu-id="60fc0-134">При вычислении разностей значения должны быть отрезкими, чтобы гарантировать, что ошибки в значениях времени не приводят к сбоям или нестабильным вычислениям, связанным со временем.</span><span class="sxs-lookup"><span data-stu-id="60fc0-134">When computing deltas, the values should be clamped to ensure that any bugs in the timing values do not cause crashes or unstable time-related computations.</span></span> <span data-ttu-id="60fc0-135">Диапазон срезов должен быть от 0 (чтобы предотвратить отрицательные разностные значения) на какое-либо разумное значение в зависимости от наименьшей ожидаемой частоты кадров.</span><span class="sxs-lookup"><span data-stu-id="60fc0-135">The clamp range should be from 0 (to prevent negative delta values) to some reasonable value based on your lowest expected framerate.</span></span> <span data-ttu-id="60fc0-136">Фиксация может оказаться полезной при отладке приложения, но следует помнить, что при анализе производительности или запуске игры в неоптимизированном режиме.</span><span class="sxs-lookup"><span data-stu-id="60fc0-136">Clamping is likely to be useful in any debugging of your application, but be sure to keep it in mind if doing performance analysis or running the game in some unoptimized mode.</span></span>
3.  <span data-ttu-id="60fc0-137">Вычисление всего времени в одном потоке.</span><span class="sxs-lookup"><span data-stu-id="60fc0-137">Compute all timing on a single thread.</span></span> <span data-ttu-id="60fc0-138">Вычисление времени для нескольких потоков — например, при каждом потоке, связанном с конкретным процессором, значительно сокращает производительность многоядерных систем.</span><span class="sxs-lookup"><span data-stu-id="60fc0-138">Computation of timing on multiple threads — for example, with each thread associated with a specific processor — greatly reduces performance of multi-core systems.</span></span>
4.  <span data-ttu-id="60fc0-139">Укажите, что один поток должен оставаться на одном процессоре с помощью интерфейса API Windows [**сетсреадаффинитимаск**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask).</span><span class="sxs-lookup"><span data-stu-id="60fc0-139">Set that single thread to remain on a single processor by using the Windows API [**SetThreadAffinityMask**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask).</span></span> <span data-ttu-id="60fc0-140">Как правило, это основной игровой поток.</span><span class="sxs-lookup"><span data-stu-id="60fc0-140">Typically, this is the main game thread.</span></span> <span data-ttu-id="60fc0-141">Хотя [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) и [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) обычно корректируются для нескольких процессоров, ошибки в BIOS или драйверах могут привести к тому, что эти подпрограммы возвращают различные значения, так как поток перемещается с одного процессора на другой.</span><span class="sxs-lookup"><span data-stu-id="60fc0-141">While [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) typically adjust for multiple processors, bugs in the BIOS or drivers may result in these routines returning different values as the thread moves from one processor to another.</span></span> <span data-ttu-id="60fc0-142">Поэтому лучше разместить поток на одном процессоре.</span><span class="sxs-lookup"><span data-stu-id="60fc0-142">So, it's best to keep the thread on a single processor.</span></span>

    <span data-ttu-id="60fc0-143">Все остальные потоки должны действовать без сбора собственных данных таймера.</span><span class="sxs-lookup"><span data-stu-id="60fc0-143">All other threads should operate without gathering their own timer data.</span></span> <span data-ttu-id="60fc0-144">Не рекомендуется использовать рабочий поток для расчета времени, так как это станет узким местом синхронизации.</span><span class="sxs-lookup"><span data-stu-id="60fc0-144">We do not recommend using a worker thread to compute timing, as this will become a synchronization bottleneck.</span></span> <span data-ttu-id="60fc0-145">Вместо этого рабочие потоки должны считывать метки времени из основного потока, а поскольку рабочие потоки только считывают метки времени, нет необходимости использовать критические разделы.</span><span class="sxs-lookup"><span data-stu-id="60fc0-145">Instead, worker threads should read timestamps from the main thread, and because the worker threads only read timestamps, there is no need to use critical sections.</span></span>

5.  <span data-ttu-id="60fc0-146">Вызовите [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) только один раз, так как частота не изменится во время работы системы.</span><span class="sxs-lookup"><span data-stu-id="60fc0-146">Call [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) only once, because the frequency will not change while the system is running.</span></span>

## <a name="application-compatibility"></a><span data-ttu-id="60fc0-147">Совместимость приложений</span><span class="sxs-lookup"><span data-stu-id="60fc0-147">Application Compatibility</span></span>

<span data-ttu-id="60fc0-148">Многие разработчики внесли предположения о поведении RDTSC в течение многих лет, поэтому вполне вероятно, что некоторые существующие приложения будут столкнуться с проблемами при запуске в системе с несколькими процессорами или ядрами из-за реализации времени.</span><span class="sxs-lookup"><span data-stu-id="60fc0-148">Many developers have made assumptions about the behavior of RDTSC over many years, so it is quite likely that some existing applications will exhibit problems when run on a system with multiple processors or cores due to the timing implementation.</span></span> <span data-ttu-id="60fc0-149">Как правило, эти проблемы могут быть переработаны как сбойные или медленное движение.</span><span class="sxs-lookup"><span data-stu-id="60fc0-149">These problems will usually manifest as glitching or slow-motion movement.</span></span> <span data-ttu-id="60fc0-150">Не существует простого решения для приложений, которые не знают об управлении питанием, однако существует существующая оболочка, позволяющая принудительно запускать приложение на одном процессоре в многопроцессорной системе.</span><span class="sxs-lookup"><span data-stu-id="60fc0-150">There is no easy remedy for applications that are not aware of power management, but there is an existing shim for forcing an application to always run on a single processor in a multiprocessor system.</span></span>

<span data-ttu-id="60fc0-151">Чтобы создать эту оболочку совместимости, Скачайте набор средств для обеспечения совместимости приложений Microsoft на основе [совместимости приложений Windows](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10).</span><span class="sxs-lookup"><span data-stu-id="60fc0-151">To create this shim, download the Microsoft Application Compatibility Toolkit from [Windows Application Compatibility](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10).</span></span>

<span data-ttu-id="60fc0-152">Используя администратор совместимости, часть набора средств, создайте базу данных приложения и соответствующие исправления.</span><span class="sxs-lookup"><span data-stu-id="60fc0-152">Using the Compatibility Administrator, part of the toolkit, create a database of your application and associated fixes.</span></span> <span data-ttu-id="60fc0-153">Создайте новый режим совместимости для этой базы данных и выберите исправление совместимости **синглепрокаффинити** , чтобы принудительно запустить все потоки приложения на одном процессоре или в ядре.</span><span class="sxs-lookup"><span data-stu-id="60fc0-153">Create a new compatibility mode for this database and select the compatibility fix **SingleProcAffinity** to force all of the threads of the application to run on a single processor/core.</span></span> <span data-ttu-id="60fc0-154">С помощью программы командной строки Fixpack.exe (также является частью набора средств) можно преобразовать эту базу данных в устанавливаемый пакет для установки, тестирования и распространения.</span><span class="sxs-lookup"><span data-stu-id="60fc0-154">By using the command-line tool Fixpack.exe (also part of the toolkit), you can convert this database into an installable package for installation, testing, and distribution.</span></span>

<span data-ttu-id="60fc0-155">Инструкции по использованию администратора совместимости см. в документации по набору средств.</span><span class="sxs-lookup"><span data-stu-id="60fc0-155">For instruction on using Compatibility Administrator, see the toolkit's documentation.</span></span> <span data-ttu-id="60fc0-156">Синтаксис и примеры использования Fixpack.exe см. в справке командной строки.</span><span class="sxs-lookup"><span data-stu-id="60fc0-156">For syntax for and examples of using Fixpack.exe, see its command-line help.</span></span>

<span data-ttu-id="60fc0-157">Сведения, ориентированные на клиентов, см. в следующих статьях базы знаний Майкрософт:</span><span class="sxs-lookup"><span data-stu-id="60fc0-157">For customer-oriented information, see the following knowledge base articles from Microsoft Help and Support:</span></span>

-   <span data-ttu-id="60fc0-158">[Программы, с которыми пользователь может плохо работать в Windows Server 2003 и Windows XP](https://support.microsoft.com/kb/895980) (статья 895980)</span><span class="sxs-lookup"><span data-stu-id="60fc0-158">[Programs that user the QueryPerformanceCounter function may perform poorly in Windows Server 2003 and in Windows XP](https://support.microsoft.com/kb/895980) (article 895980)</span></span>
-   <span data-ttu-id="60fc0-159">[На компьютере под управлением Windows XP, на котором используется Двухъядерный процессор (статья 909944), производительность игры может быть низкой](https://support.microsoft.com/kb/909944) .</span><span class="sxs-lookup"><span data-stu-id="60fc0-159">[Game performance may be poor on a Windows XP-based computer that is using a dual-core processor](https://support.microsoft.com/kb/909944) (article 909944)</span></span>

 

 