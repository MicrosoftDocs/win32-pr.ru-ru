---
title: Взаимодействие протокола точки доступа и проверки подлинности во время проверки подлинности
description: Функция Расеапмакемессаже управляет большей частью взаимодействия между протоколом проверки подлинности и точкой доступа (AP).
ms.assetid: edc128e0-3104-4df9-80f4-b2aebcfe1087
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0e486e3a10e323f28bc2f6fef4c131acfc095b48
ms.sourcegitcommit: ebd3ce6908ff865f1ef66f2fc96769be0aad82e1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2020
ms.locfileid: "104069844"
---
# <a name="access-point-and-authentication-protocol-interaction-during-authentication"></a><span data-ttu-id="56106-103">Взаимодействие протокола точки доступа и проверки подлинности во время проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="56106-103">Access Point and Authentication Protocol Interaction During Authentication</span></span>

<span data-ttu-id="56106-104">Функция [**расеапмакемессаже**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) управляет большей частью взаимодействия между протоколом проверки подлинности и точкой доступа (AP).</span><span class="sxs-lookup"><span data-stu-id="56106-104">The [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) function controls the majority of the interaction between the authentication protocol and the Access Point (AP).</span></span> <span data-ttu-id="56106-105">**Расеапмакемессаже** обрабатывает входящие пакеты EAP и создает пакеты EAP для передачи удаленному одноранговому узлу.</span><span class="sxs-lookup"><span data-stu-id="56106-105">**RasEapMakeMessage** processes incoming EAP packets and creates EAP packets for transmission to the remote peer.</span></span> <span data-ttu-id="56106-106">Он также обрабатывает события, такие как время ожидания и завершение проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="56106-106">It also processes events such as time outs and authentication completion.</span></span>

<span data-ttu-id="56106-107">Если сообщение получено от удаленного узла, то служба проверки подлинности AP вызывает [**расеапмакемессаже**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)), передавая указатель на полученное сообщение в параметре *прецеивепаккет* .</span><span class="sxs-lookup"><span data-stu-id="56106-107">If a message is received from the remote peer, the AP authentication service calls [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)), passing a pointer to the received message in the *pReceivePacket* parameter.</span></span>

<span data-ttu-id="56106-108">Если служба вызывает [**расеапмакемессаже**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) с параметром *прецеивепаккет* , для которого задано **значение NULL**, то AP либо запускает диалоговое окно с помощью протокола проверки подлинности, либо запрашивает, что протокол повторно отправляет последний пакет.</span><span class="sxs-lookup"><span data-stu-id="56106-108">If the service calls [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) with *pReceivePacket* set to **NULL**, the AP is either initiating the dialog with the authentication protocol, or requesting that the protocol resend the last packet.</span></span> <span data-ttu-id="56106-109">Протокол проверки подлинности должен определять, какое действие служба принимает в зависимости от состояния и контекста сообщения.</span><span class="sxs-lookup"><span data-stu-id="56106-109">The authentication protocol should determine which action the service is taking based on its state and from the message context.</span></span>

<span data-ttu-id="56106-110">При возврате из [**расеапмакемессаже**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85))значение члена **Action** в структуре [**\_ \_ вывода PPP EAP**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output) показывает, какое действие использует служба проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="56106-110">On return from [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)), the value of the **Action** member of the [**PPP\_EAP\_OUTPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output) structure indicates what action, if any, the authentication service takes.</span></span> <span data-ttu-id="56106-111">Член **действия** принимает значения из перечислимого [**типа \_ \_ действия PPP EAP**](/windows/desktop/api/Raseapif/ne-raseapif-ppp_eap_action) .</span><span class="sxs-lookup"><span data-stu-id="56106-111">The **Action** member takes values from the [**PPP\_EAP\_ACTION**](/windows/desktop/api/Raseapif/ne-raseapif-ppp_eap_action) enumerated type.</span></span>

<span data-ttu-id="56106-112">Если **Action** имеет **значение еапактион \_ Send**, **Еапактион \_ сенданддоне**, **еапактион \_ сендвистимеаут** или **еапактион \_ сендвистимеаутинтерактиве**, служба передает пакет, на который указывает параметр *pSendPacket* , удаленному одноранговому узлу.</span><span class="sxs-lookup"><span data-stu-id="56106-112">If **Action** is **EAPACTION\_Send**, **EAPACTION\_SendAndDone**, **EAPACTION\_SendWithTimeout**, or **EAPACTION\_SendWithTimeoutInteractive**, the service transmits the packet that is pointed to by the *pSendPacket* parameter to the remote peer.</span></span>

<span data-ttu-id="56106-113">Значение **еапактион \_ сендвистимеаут** обеспечивает время ожидания, после которого служба проверки подлинности считает, что ссылка была потеряна, и отключает сеанс.</span><span class="sxs-lookup"><span data-stu-id="56106-113">The **EAPACTION\_SendWithTimeout** value allows for a time out, after which time the authentication service assumes the link was lost, and disconnects the session.</span></span>

<span data-ttu-id="56106-114">Значение **еапактион \_ сендвистимеаутинтерактиве** допускает неограниченное время ожидания.</span><span class="sxs-lookup"><span data-stu-id="56106-114">The **EAPACTION\_SendWithTimeoutInteractive** value allows an infinite amount of time out to occur.</span></span> <span data-ttu-id="56106-115">Средство проверки подлинности должно использовать это значение при ожидании ввода пользователем данных на клиенте.</span><span class="sxs-lookup"><span data-stu-id="56106-115">The authenticator should use this value when expecting user input on the client.</span></span> <span data-ttu-id="56106-116">Это время ожидания позволяет пользователю неопределенный промежуток времени для выполнения требуемых входных данных.</span><span class="sxs-lookup"><span data-stu-id="56106-116">This time out allows the user an unspecified amount of time to complete the required input.</span></span>

<span data-ttu-id="56106-117">Если **Action** имеет **значение \_ еапактион сендвистимеаут** или **еапактион \_ сендвистимеаутинтерактиве**, протокол проверки подлинности должен установить в качестве значения параметра **двидекспектед** в структуре [**\_ \_ вывода PPP EAP**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output) идентификатор следующего пакета, ожидаемого от удаленного узла.</span><span class="sxs-lookup"><span data-stu-id="56106-117">If **Action** is **EAPACTION\_SendWithTimeout** or **EAPACTION\_SendWithTimeoutInteractive**, the authentication protocol should set the **dwIdExpected** member of the [**PPP\_EAP\_OUTPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output) structure to the identifier of the next packet that is expected from the remote peer.</span></span> <span data-ttu-id="56106-118">Независимо от того, соответствует ли следующий пакет, полученный от узла, этому значению, служба проверки подлинности передает пакет протоколу проверки подлинности в последующем вызове [**расеапмакемессаже**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="56106-118">Regardless of whether the next packet received from the peer matches this value, the authentication service passes the packet to the authentication protocol in a subsequent call to [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)).</span></span> <span data-ttu-id="56106-119">Протокол проверки подлинности может отбросить пакет автоматически, просто возвращая **ошибку \_ PPP \_ Недопустимый \_ пакет**.</span><span class="sxs-lookup"><span data-stu-id="56106-119">The authentication protocol may silently discard the packet by simply returning **ERROR\_PPP\_INVALID\_PACKET**.</span></span> <span data-ttu-id="56106-120">Если пакет с ожидаемым идентификатором не получен в течение заданного периода ожидания, служба проверки подлинности по-прежнему вызывает **расеапмакемессаже**.</span><span class="sxs-lookup"><span data-stu-id="56106-120">If a packet with the expected identifier is not received within the configured time-out period, the authentication service still calls **RasEapMakeMessage**.</span></span> <span data-ttu-id="56106-121">В этом случае вызов выполняется с параметром *прецеивепаккет* , установленным в **значение NULL**, чтобы указать, что предыдущий пакет необходимо отправить повторно.</span><span class="sxs-lookup"><span data-stu-id="56106-121">In this case, the call is made with the *pReceivePacket* parameter set to **NULL**, to indicate that the previous packet needs to be sent again.</span></span>

<span data-ttu-id="56106-122">Если участник **Action** — **Еапактион \_ done** или **еапактион \_ сенданддоне**, служба проверки подлинности просматривает член **дваусресулткоде** [**вывода PPP \_ EAP \_**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output).</span><span class="sxs-lookup"><span data-stu-id="56106-122">If the **Action** member is **EAPACTION\_Done** or **EAPACTION\_SendAndDone**, the authentication service examines the **dwAuthResultCode** member of [**PPP\_EAP\_OUTPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output).</span></span> <span data-ttu-id="56106-123">Если **дваусресулткоде** не является \_ ошибкой, проверка подлинности прошла удачно.</span><span class="sxs-lookup"><span data-stu-id="56106-123">If **dwAuthResultCode** is NO\_ERROR, the authentication succeeded.</span></span> <span data-ttu-id="56106-124">Если **дваусресулткоде** не является значением, отличным от \_ ошибки, проверка подлинности не удалась.</span><span class="sxs-lookup"><span data-stu-id="56106-124">If **dwAuthResultCode** is a value other than NO\_ERROR, the authentication failed.</span></span> <span data-ttu-id="56106-125">Код ошибки, возвращенный для случая сбоя, должен поступать из Расеррор. h, Мпреррор. h или Winerror. h.</span><span class="sxs-lookup"><span data-stu-id="56106-125">The error code returned for the failure case should come from Raserror.h, Mprerror.h, or Winerror.h.</span></span> <span data-ttu-id="56106-126">Возможные коды возврата включают, но не ограничиваются следующим:</span><span class="sxs-lookup"><span data-stu-id="56106-126">Possible return codes include, but are not limited to, the following:</span></span>

-   <span data-ttu-id="56106-127">Ошибка \_ без \_ разрешения на подключение \_</span><span class="sxs-lookup"><span data-stu-id="56106-127">ERROR\_NO\_DIALIN\_PERMISSION</span></span>
-   <span data-ttu-id="56106-128">Ошибка \_ паролей с \_ истекшим сроком действия</span><span class="sxs-lookup"><span data-stu-id="56106-128">ERROR\_PASSWD\_EXPIRED</span></span>
-   <span data-ttu-id="56106-129">Ошибка \_ acct \_ отключена</span><span class="sxs-lookup"><span data-stu-id="56106-129">ERROR\_ACCT\_DISABLED</span></span>
-   <span data-ttu-id="56106-130">ОШИБКА с \_ ограниченным \_ \_ временем входа</span><span class="sxs-lookup"><span data-stu-id="56106-130">ERROR\_RESTRICTED\_LOGON\_HOURS</span></span>
-   <span data-ttu-id="56106-131">\_Внутренняя ошибка проверки подлинности \_</span><span class="sxs-lookup"><span data-stu-id="56106-131">ERROR\_AUTH\_INTERNAL</span></span>

<span data-ttu-id="56106-132">В случае, когда **действие** **Еапактион \_ Готово** или **еапактион \_ сенданддоне**, элемент **пусераттрибутес** должен указывать на атрибуты, переопределяющие атрибуты того же типа, которые были переданы серверу при вызове [**расеапбегин**](/previous-versions/windows/desktop/legacy/aa363520(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="56106-132">In the case where **Action** is **EAPACTION\_Done** or **EAPACTION\_SendAndDone**, the **pUserAttributes** member should point to attributes that override attributes of the same type that were passed to the server in the call to [**RasEapBegin**](/previous-versions/windows/desktop/legacy/aa363520(v=vs.85)).</span></span>

<span data-ttu-id="56106-133">Протокол проверки подлинности на сервере может запрашивать, что служба проверки подлинности вызывает текущий поставщик проверки подлинности, возвращая **еапактион \_ Authenticate** в элементе **Action** в [**\_ \_ выходных данных PPP EAP**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output).</span><span class="sxs-lookup"><span data-stu-id="56106-133">The authentication protocol on the server can request that the authentication service invoke the current authentication provider by returning **EAPACTION\_Authenticate** in the **Action** member in [**PPP\_EAP\_OUTPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output).</span></span> <span data-ttu-id="56106-134">В этом случае указатель **пусераттрибутес** в **\_ \_ выходных данных PPP EAP** будет иметь только те атрибуты, которые были созданы протоколом проверки подлинности на сервере.</span><span class="sxs-lookup"><span data-stu-id="56106-134">In this case, the **pUserAttributes** pointer in **PPP\_EAP\_OUTPUT** points only to attributes that were generated by the authentication protocol on the server.</span></span> <span data-ttu-id="56106-135">Он не включает атрибуты, которые были переданы на сервер при вызове [**расеапбегин**](/previous-versions/windows/desktop/legacy/aa363520(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="56106-135">It does not include any of the attributes that were passed to the server in the call to [**RasEapBegin**](/previous-versions/windows/desktop/legacy/aa363520(v=vs.85)).</span></span> <span data-ttu-id="56106-136">Поставщик проверки подлинности не требует этих исходных атрибутов, так как учетные данные для проверки подлинности находятся в самом сообщении EAP, а не в отдельном атрибуте RADIUS.</span><span class="sxs-lookup"><span data-stu-id="56106-136">The authentication provider does not require these initial attributes because the authentication credentials are inside the EAP message itself, not in a separate RADIUS attribute.</span></span> <span data-ttu-id="56106-137">Когда служба проверки подлинности реагирует на **действие \_ проверки** подлинности еапактион, **пусераттрибутес** в [**\_ \_ входе PPP EAP**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_input), указывает на все атрибуты, созданные во время проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="56106-137">When the authentication service responds to the **EAPACTION\_Authenticate** action, **pUserAttributes** in [**PPP\_EAP\_INPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_input), points to all attributes generated during authentication.</span></span> <span data-ttu-id="56106-138">Эти атрибуты возвращаются в протокол проверки подлинности на клиенте.</span><span class="sxs-lookup"><span data-stu-id="56106-138">These attributes are returned to the authentication protocol on the client.</span></span>

<span data-ttu-id="56106-139">Если протокол проверки подлинности использует **\_ проверку** подлинности еапактион, то поставщик проверки подлинности ВЫПОЛНЯЕТ PAP или MD5-CHAP.</span><span class="sxs-lookup"><span data-stu-id="56106-139">If the authentication protocol uses **EAPACTION\_Authenticate**, the authentication provider performs either PAP or MD5-CHAP.</span></span> <span data-ttu-id="56106-140">Этот метод проверки подлинности можно использовать только с клиентами Windows.</span><span class="sxs-lookup"><span data-stu-id="56106-140">This authentication method can be used only with Windows clients.</span></span>

<span data-ttu-id="56106-141">Если протокол проверки подлинности выполняет проверку подлинности пользователя без использования поставщика проверки подлинности, то не требуется, чтобы протокол задавал **действие** в **еапактион \_ Authenticate**.</span><span class="sxs-lookup"><span data-stu-id="56106-141">If the authentication protocol authenticates the user without relying on an authentication provider, there is no need for the protocol to ever set **Action** to **EAPACTION\_Authenticate**.</span></span> <span data-ttu-id="56106-142">Примером такого случая является EAP-Transport безопасность уровня (TLS).</span><span class="sxs-lookup"><span data-stu-id="56106-142">An example of this case is EAP-Transport Layer Security (TLS).</span></span>

<span data-ttu-id="56106-143">Пакет EAP Success — это неподтвержденный пакет.</span><span class="sxs-lookup"><span data-stu-id="56106-143">The EAP success packet is a non-acknowledged packet.</span></span> <span data-ttu-id="56106-144">Таким образом, сервер может быть потерян и не передаваться на него.</span><span class="sxs-lookup"><span data-stu-id="56106-144">Therefore, it can be lost and not resent by the server.</span></span> <span data-ttu-id="56106-145">Если служба проверки подлинности на клиенте получает пакет протокола управления сетями (NCP), то служба проверки подлинности на стороне сервера продолжает работу, как будто проверка подлинности прошла успешно.</span><span class="sxs-lookup"><span data-stu-id="56106-145">If the authentication service on the client receives a Network Control Protocol (NCP) packet, the server-side authentication service proceeds as though the authentication was successful.</span></span> <span data-ttu-id="56106-146">Это происходит потому, что сервер перешел на фазу NCP протокола РРР.</span><span class="sxs-lookup"><span data-stu-id="56106-146">This is because the server has moved on to the NCP phase of PPP.</span></span> <span data-ttu-id="56106-147">Соответственно, служба проверки подлинности вызывает [**расеапмакемессаже**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) с членом **Фсукцесспаккетрецеивед** структуры [**\_ \_ ввода PPP EAP**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_input) , установленным в **значение true**.</span><span class="sxs-lookup"><span data-stu-id="56106-147">Accordingly, the authentication service calls [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) with the **fSuccessPacketReceived** member of the [**PPP\_EAP\_INPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_input) structure set to **TRUE**.</span></span>

<span data-ttu-id="56106-148">В ходе сеанса проверки подлинности протоколу проверки подлинности может потребоваться взаимодействие непосредственно с пользователем на клиенте.</span><span class="sxs-lookup"><span data-stu-id="56106-148">During the course of the authentication session, the authentication protocol may require interaction directly with the user on the client.</span></span> <span data-ttu-id="56106-149">Поставщик протокола проверки подлинности может предоставить интерактивный пользовательский интерфейс для этой цели.</span><span class="sxs-lookup"><span data-stu-id="56106-149">The authentication protocol vendor can provide an interactive user interface for this purpose.</span></span> <span data-ttu-id="56106-150">Протокол проверки подлинности может запросить отображение интерактивного пользовательского интерфейса для службы, задав элементы **финвокеинтерактивеуи**, **пуиконтекстдата** и **двсизеофуиконтекстдата** в [**выходной структуре \_ PPP \_ EAP**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output) .</span><span class="sxs-lookup"><span data-stu-id="56106-150">The authentication protocol can request that the service display the interactive UI by setting the **fInvokeInteractiveUI**, **pUIContextData**, and **dwSizeOfUIContextData** members in the [**PPP\_EAP\_OUTPUT**](/windows/desktop/api/Raseapif/ns-raseapif-ppp_eap_output) structure.</span></span> <span data-ttu-id="56106-151">Дополнительные сведения об использовании интерактивного пользовательского интерфейса см. в разделе [интерактивный пользовательский интерфейс](interactive-user-interface.md).</span><span class="sxs-lookup"><span data-stu-id="56106-151">For more information on using an interactive UI, see [Interactive User Interface](interactive-user-interface.md).</span></span>

<span data-ttu-id="56106-152">Протокол проверки подлинности должен отображать пользовательский интерфейс только через механизм, описанный в разделе [интерактивный пользовательский интерфейс](interactive-user-interface.md).</span><span class="sxs-lookup"><span data-stu-id="56106-152">The authentication protocol should display a user interface only through the mechanism described under [Interactive User Interface](interactive-user-interface.md).</span></span> <span data-ttu-id="56106-153">Если протокол проверки подлинности отображает пользовательский интерфейс, то поток PPP блокируется до закрытия пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="56106-153">If the authentication protocol itself displays the user interface, the PPP thread blocks until the user interface is dismissed.</span></span>

<span data-ttu-id="56106-154">Если во время процесса проверки подлинности [**расеапмакемессаже**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) возвращает любое значение, отличное от " **нет \_ ошибок** " или " **Ошибка \_ PPP \_ Недопустимый \_ пакет**", сеанс отключается, а ошибка заносится в журнал (на сервере) или отображается пользователю (на клиенте).</span><span class="sxs-lookup"><span data-stu-id="56106-154">If during the authentication process, [**RasEapMakeMessage**](/previous-versions/windows/desktop/legacy/aa363532(v=vs.85)) returns any value other than **NO\_ERROR** or **ERROR\_PPP\_INVALID\_PACKET**, the session is disconnected and the error is logged (on the server) or displayed to the user (on the client).</span></span>

 

 