---
description: Центр сертификации Майкрософт (ЦС) можно настроить для архивации и восстановления закрытого ключа, связанного с открытым ключом, отправленным в запросе на сертификат.
ms.assetid: c6535dbf-c3fe-4f70-9a70-02805253a651
title: Сервер восстановления ключей
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b4e9fd60b7ee6596b98953d382978be64695c035
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103909647"
---
# <a name="key-recovery-server"></a><span data-ttu-id="bd7ae-103">Сервер восстановления ключей</span><span class="sxs-lookup"><span data-stu-id="bd7ae-103">Key Recovery Server</span></span>

<span data-ttu-id="bd7ae-104">Центр сертификации Майкрософт (ЦС) можно настроить для архивации и восстановления закрытого ключа, связанного с открытым ключом, отправленным в запросе на сертификат.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-104">A Microsoft certification authority (CA) can be configured to archive and recover the private key associated with the public key submitted in the certificate request.</span></span> <span data-ttu-id="bd7ae-105">Восстановление полезно в случае утери ключа.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-105">Recovery is useful if a key is lost.</span></span> <span data-ttu-id="bd7ae-106">По умолчанию архивировать можно только ключи шифрования.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-106">By default, only encryption keys can be archived.</span></span> <span data-ttu-id="bd7ae-107">Нет необходимости архивировать ключи, предназначенные только для подписания, поскольку при потере закрытого ключа подписывания требуется только открытый ключ для проверки подписи.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-107">It is not necessary to archive keys intended only for signing because only the public key is needed to verify a signature if the private signing key is lost.</span></span>

<span data-ttu-id="bd7ae-108">Чтобы заархивировать ключ, ЦС должен быть настроен на выдачу сертификатов агента восстановления ключей (KRA) и уже выдавал по крайней мере один.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-108">To archive a key, the CA must be configured to issue key recovery agent (KRA) certificates and to have already issued at least one.</span></span> <span data-ttu-id="bd7ae-109">Агент восстановления ключей — это администратор, который разрешает организациям расшифровывать закрытые ключи.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-109">A key recovery agent is an administrator authorized by an organization to decrypt private keys.</span></span> <span data-ttu-id="bd7ae-110">Для повышения безопасности рекомендуется назначать агент восстановления ключей и роли диспетчера сертификатов разным пользователям, которому диспетчеру сертификатов разрешено получать, но не расшифровывать архивированные ключи, а агенту восстановления ключей разрешено расшифровывать ключи, но не извлекать их.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-110">To enhance security, we recommend that the key recovery agent and the certificate manager roles be assigned to different individuals, that the certificate manager be permitted to retrieve but not decrypt archived keys, and that the key recovery agent be permitted to decrypt keys but not retrieve them.</span></span>

## <a name="key-archival"></a><span data-ttu-id="bd7ae-111">Архивирование ключей</span><span class="sxs-lookup"><span data-stu-id="bd7ae-111">Key Archival</span></span>

<span data-ttu-id="bd7ae-112">Клиент обычно запрашивает сертификат с помощью шаблона.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-112">A client typically requests a certificate by using a template.</span></span> <span data-ttu-id="bd7ae-113">Если шаблон требует архивирования закрытого ключа, клиент и центр сертификации выполняют следующие шаги:</span><span class="sxs-lookup"><span data-stu-id="bd7ae-113">If the template requires that the private key be archived, the following steps are performed by the client and the CA:</span></span>

1.  <span data-ttu-id="bd7ae-114">Клиент получает и проверяет сертификат Exchange ЦС, чтобы определить, подписан ли он с помощью того же ключа, который использовался для подписания сертификата для подписи ЦС.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-114">The client retrieves and validates the CA exchange certificate to determine whether it has been signed by the same key that was used to sign the CA signing certificate.</span></span> <span data-ttu-id="bd7ae-115">Это гарантирует, что единственный ЦС, который может расшифровать закрытый ключ, — это центр сертификации, из которого запрашивается сертификат.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-115">This ensures that the only CA that can decrypt the private key is the CA from which a certificate is being requested.</span></span>
2.  <span data-ttu-id="bd7ae-116">Открытый ключ в сертификате ЦС Exchange используется для шифрования закрытого ключа, связанного с запросом на сертификат, и отправки запроса в ЦС.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-116">The public key in the CA exchange certificate is used to encrypt the private key associated with the certificate request, and the request is sent to the CA.</span></span>
3.  <span data-ttu-id="bd7ae-117">ЦС использует закрытый ключ, связанный с сертификатом Exchange, для расшифровки закрытого ключа, отправленного клиентом, и проверяет, связаны ли открытые и закрытые ключи в запросе.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-117">The CA uses the private key associated with its exchange certificate to decrypt the private key sent by the client and verifies that the public and private keys in the request are related.</span></span>
4.  <span data-ttu-id="bd7ae-118">ЦС шифрует закрытый ключ с помощью открытого ключа в сертификате KRA.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-118">The CA encrypts the private key by using the public key in the KRA certificate.</span></span> <span data-ttu-id="bd7ae-119">Если ЦС выпустил несколько KRA-сертификатов, закрытый ключ шифруется один раз с каждым доступным открытым ключом, чтобы любой Полномочный агент восстановления ключей мог восстановить ключ.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-119">If the CA has issued multiple KRA certificates, it encrypts the private key once with each available public key so that any authorized key recovery agent can recover a key.</span></span> <span data-ttu-id="bd7ae-120">Зашифрованные закрытые ключи хранятся в базе данных сертификатов.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-120">The encrypted private keys are stored in the certificate database.</span></span>
5.  <span data-ttu-id="bd7ae-121">Центр сертификации освобождает все ссылки на закрытый ключ и обеспечивает безопасное освобождение и обнуление всей памяти, содержащей ключ.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-121">The CA releases all references to the private key and securely frees and zeros all memory that contained the key.</span></span> <span data-ttu-id="bd7ae-122">Это гарантирует, что ЦС не будет иметь доступ к ключу в формате открытого текста.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-122">This ensures that the CA has no further access to the key in clear text format.</span></span>

> [!Note]  
> <span data-ttu-id="bd7ae-123">Для архивации ключей можно использовать только запрос CMC.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-123">Only a CMC request can be used for key archival.</span></span> <span data-ttu-id="bd7ae-124">Запросы CMC представлены интерфейсом [**IX509CertificateRequestCmc**](/windows/desktop/api/CertEnroll/nn-certenroll-ix509certificaterequestcmc) .</span><span class="sxs-lookup"><span data-stu-id="bd7ae-124">CMC requests are represented by the [**IX509CertificateRequestCmc**](/windows/desktop/api/CertEnroll/nn-certenroll-ix509certificaterequestcmc) interface.</span></span>

 

## <a name="key-recovery"></a><span data-ttu-id="bd7ae-125">Восстановление ключей</span><span class="sxs-lookup"><span data-stu-id="bd7ae-125">Key Recovery</span></span>

<span data-ttu-id="bd7ae-126">Восстановление ключей не поддерживается напрямую службами Active Directory сертификатов или API регистрации сертификатов.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-126">Key recovery is not directly supported by Active Directory Certificate Services or the Certificate Enrollment API.</span></span> <span data-ttu-id="bd7ae-127">Однако корпорация Майкрософт предоставляет следующие приложения для упрощения процесса:</span><span class="sxs-lookup"><span data-stu-id="bd7ae-127">Microsoft does, however, provide the following applications to help with the process:</span></span>

-   <span data-ttu-id="bd7ae-128">Certutil.exe — это программа командной строки, которая может использоваться для получения сведений о конфигурации ЦС, проверки сертификатов, пар ключей и цепочек сертификатов, а также резервного копирования и восстановления ключей.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-128">Certutil.exe is a command line program that can be used to retrieve CA configuration information, verify certificates, key pairs, and certificate chains, and back up and restore keys.</span></span> <span data-ttu-id="bd7ae-129">Он входит в состав серверных операционных систем, начиная с Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-129">It is included in server operating systems beginning with Windows Server 2003.</span></span>
-   <span data-ttu-id="bd7ae-130">Krecover.exe — это программа на основе диалоговых окон, которая обеспечивает восстановление ключей.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-130">Krecover.exe is a dialog box–based program that enables key recovery.</span></span> <span data-ttu-id="bd7ae-131">Он входит в состав набора ресурсов, начиная с Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-131">It is included with the Resource Kit beginning with Windows Server 2003.</span></span>

<span data-ttu-id="bd7ae-132">Для восстановления закрытого ключа выполняются следующие действия.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-132">The following steps are performed to recover a private key:</span></span>

1.  <span data-ttu-id="bd7ae-133">Диспетчер сертификатов находит потенциальные кандидаты для восстановления ключей в базе данных сертификатов, используя имя сертификата, инициатора запроса или пользователя.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-133">The certificate manager locates potential candidates for key recovery in the certificate database by using the name of the certificate, requester, or user.</span></span> <span data-ttu-id="bd7ae-134">Для этой цели можно использовать команду **certutil** **-GetKey** .</span><span class="sxs-lookup"><span data-stu-id="bd7ae-134">The **Certutil** **-getkey** command can be used for this purpose.</span></span>
2.  <span data-ttu-id="bd7ae-135">После того как диспетчер сертификатов выдает список сертификатов, команда **-GetKey** вызывается снова с конкретным серийным номером или бегунком печати для получения \# файла PKCS 7, содержащего KRA-сертификат, цепочку сертификатов пользователей и закрытый ключ, который был зашифрован во время архивации с помощью открытого ключа KRA.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-135">Once the certificate manager has a list of certificates, the **-getkey** command is called again with a specific certificate serial number or thumb print to retrieve a PKCS \#7 file that contains the KRA certificate, user certificate chain, and the private key that was encrypted during archival by using the KRA public key.</span></span>
3.  <span data-ttu-id="bd7ae-136">Диспетчер сертификатов передает управление процессом агенту восстановления ключей, закрытый ключ которого соответствует открытому ключу, содержащемуся в сертификате KRA.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-136">The certificate manager passes control of the process to the key recovery agent whose private key matches the public key contained in the KRA certificate.</span></span>
4.  <span data-ttu-id="bd7ae-137">Агент восстановления ключей расшифровывает заархивированный закрытый ключ, возвращенный в файле PKCS \# 7, с помощью закрытого ключа KRA.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-137">The key recovery agent decrypts the archived private key returned in the PKCS \#7 file by using the KRA private key.</span></span> <span data-ttu-id="bd7ae-138">Это можно сделать с помощью команды **certutil** **-рековеркэй** , которая помещает ключ в защищенный паролем файл PKCS \# 12.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-138">This can be done by using the **Certutil** **-recoverkey** command which places the key in a password-protected PKCS \#12 file.</span></span> <span data-ttu-id="bd7ae-139">Клиенту должен быть предоставлен пароль с помощью безопасного аппаратного механизма.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-139">The client must be given the password through a secure out-of-band mechanism.</span></span>
5.  <span data-ttu-id="bd7ae-140">Клиент импортирует \# файл PKCS 12 и использует пароль для получения ключа.</span><span class="sxs-lookup"><span data-stu-id="bd7ae-140">The client imports the PKCS \#12 file and uses the password to retrieve the key.</span></span>

## <a name="related-topics"></a><span data-ttu-id="bd7ae-141">См. также</span><span class="sxs-lookup"><span data-stu-id="bd7ae-141">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="bd7ae-142">Элементы PKI</span><span class="sxs-lookup"><span data-stu-id="bd7ae-142">PKI Elements</span></span>](about-pki-components.md)
</dt> </dl>

 

 



