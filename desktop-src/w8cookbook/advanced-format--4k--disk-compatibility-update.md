---
title: Обновление совместимости диска в расширенном формате (4 КБ)
description: Обновление совместимости диска в расширенном формате (4 КБ)
ms.assetid: 2C9EB0CF-D27B-457A-8FE6-24824BCC084C
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fbad505575c4479bd750f09ccd83bc4da4c39667
ms.sourcegitcommit: 78b64f3865e64768b5319d4f010032ee68924a98
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/13/2021
ms.locfileid: "107314977"
---
# <a name="advanced-format-4k-disk-compatibility-update"></a><span data-ttu-id="a2894-103">Обновление совместимости диска в расширенном формате (4 КБ)</span><span class="sxs-lookup"><span data-stu-id="a2894-103">Advanced format (4K) disk compatibility update</span></span>

## <a name="platforms"></a><span data-ttu-id="a2894-104">Платформы</span><span class="sxs-lookup"><span data-stu-id="a2894-104">Platforms</span></span>

<span data-ttu-id="a2894-105">**Клиенты**   Windows XP, Windows Vista, Windows 7, Windows 7 SP1, Windows 8</span><span class="sxs-lookup"><span data-stu-id="a2894-105">**Clients**   Windows XP, Windows Vista, Windows 7, Windows 7 SP1, Windows 8</span></span>  
<span data-ttu-id="a2894-106">**Серверы**   Windows Server 2003, Windows Server 2008, Windows Server 2008 R2, Windows Server 2008 R2 с пакетом обновления 1 (SP1), Windows Server 2012, Windows Server 2012 R2, Windows Server 2016</span><span class="sxs-lookup"><span data-stu-id="a2894-106">**Servers**   Windows Server 2003, Windows Server 2008, Windows Server 2008 R2, Windows Server 2008 R2 SP1, Windows Server 2012, Windows Server 2012 R2, Windows Server 2016</span></span>  


## <a name="description"></a><span data-ttu-id="a2894-107">Описание</span><span class="sxs-lookup"><span data-stu-id="a2894-107">Description</span></span>

<span data-ttu-id="a2894-108">В этой статье приведена обновленная версия статьи с пакетом обновления 512e (512-Byte Emulator), выпущенной для Windows 7 SP1 и Windows Server 2008 R2 с пакетом обновления 1 (SP1).</span><span class="sxs-lookup"><span data-stu-id="a2894-108">This article is an updated version of the article titled  512-byte Emulation (512e) Disk Compatibility Update  which was released for Windows 7 SP1 and Windows Server 2008 R2 SP1.</span></span> <span data-ttu-id="a2894-109">Это обновление содержит много новых сведений, некоторые из которых применимы только к Windows 8 и Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="a2894-109">This update contains much new info, some of which is applicable only to Windows 8 and Windows Server 2012.</span></span>

<span data-ttu-id="a2894-110">Плотность с областями увеличивается ежегодно, и с недавним появлением дисков объемом 3 ТБ механизмы исправления ошибок, используемые для работы с пониженным соотношением сигнала и шума (СНР), становятся неэффективными. то есть для обеспечения пригодности носителя требуется увеличенный объем издержек.</span><span class="sxs-lookup"><span data-stu-id="a2894-110">Areal densities are increasing yearly, and with the recent advent of 3 TB disks, the error correction mechanisms used to deal with the decreasing signal-to-noise-ratio (SNR) are becoming space inefficient; that is, an increased amount of overhead is required to ensure the media is usable.</span></span> <span data-ttu-id="a2894-111">Одно из отраслевых решений для улучшения этого механизма исправления ошибок состоит в том, чтобы ввести другой формат физического носителя, который включает в себя большой размер физического сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-111">One of the storage industry solutions for improving this error correction mechanism is to introduce a different physical media format that includes a larger physical sector size.</span></span> <span data-ttu-id="a2894-112">Этот новый формат физического носителя называется расширенным форматом.</span><span class="sxs-lookup"><span data-stu-id="a2894-112">This new physical media format is called Advanced Format.</span></span> <span data-ttu-id="a2894-113">Таким образом, больше не рекомендуется делать никаких предположений относительно размера сектора современных запоминающих устройств, и разработчикам необходимо изучить допущения, лежащие в основе кода, чтобы определить, есть ли последствия.</span><span class="sxs-lookup"><span data-stu-id="a2894-113">Therefore, it is no longer safe to make any assumptions regarding the sector size of modern storage devices, and developers will need to study the assumptions underlying their code to determine if there is an impact.</span></span>

<span data-ttu-id="a2894-114">В этом разделе описывается воздействие расширенного формата устройств хранения на программное обеспечение, обсуждаются приложения, которые могут помочь в поддержке такого типа мультимедиа, а также обсуждается инфраструктура, появившаяся корпорацией Майкрософт в Windows Vista, Windows 7 и Windows 8, позволяющая разработчикам поддерживать такие типы устройств.</span><span class="sxs-lookup"><span data-stu-id="a2894-114">This topic introduces the effect of Advanced Format storage devices on software, discusses what apps can do to help support this type of media, and discusses the infrastructure that Microsoft introduced with Windows Vista, Windows 7, and Windows 8 to enable developers to support these types of devices.</span></span> <span data-ttu-id="a2894-115">Хотя материал, представленный в этом разделе, содержит рекомендации по улучшению совместимости с дополнительными дисками формата, информация обычно применяется ко всем системам с дополнительными дисками форматирования под управлением Windows Vista, Windows 7 и Windows 8.</span><span class="sxs-lookup"><span data-stu-id="a2894-115">While the material presented in this topic provides guidelines for improving compatibility with Advanced Format disks, the info applies generally to all systems with Advanced Format disks running Windows Vista, Windows 7, and Windows 8.</span></span>

<span data-ttu-id="a2894-116">**Общие сведения о новых возможностях, связанных с большими секторами**</span><span class="sxs-lookup"><span data-stu-id="a2894-116">**Summary of new large sector related features**</span></span>

<span data-ttu-id="a2894-117">В приведенном ниже списке перечислены новые функции, поставляемые в составе Windows 8 и Windows Server 2012, которые помогут улучшить работу клиентов и разработчиков с большими секторами дисков.</span><span class="sxs-lookup"><span data-stu-id="a2894-117">The below list summarizes the new features delivered as part of Windows 8 and Windows Server 2012 to help improve customer and developer experience with large sector disks.</span></span> <span data-ttu-id="a2894-118">Подробное описание каждого элемента приведено ниже.</span><span class="sxs-lookup"><span data-stu-id="a2894-118">More detailed description for each item follow.</span></span>

-   <span data-ttu-id="a2894-119">Основана на поддержке Windows 7 с пакетом обновления 1 (SP1) для 4-килобайтных дисков с эмуляцией (512e) и предоставляет полную поддержку входящих дисков с размером 4 КБ, без эмуляции (в 4-разрядной версии).</span><span class="sxs-lookup"><span data-stu-id="a2894-119">Builds upon the Windows 7 SP1 support for 4K disks with emulation (512e), and provides full inbox support for disks with 4K sector size without emulation (4K Native).</span></span> <span data-ttu-id="a2894-120">Ниже перечислены некоторые поддерживаемые приложения и сценарии.</span><span class="sxs-lookup"><span data-stu-id="a2894-120">Some supported apps and scenarios include:</span></span>
    -   <span data-ttu-id="a2894-121">Возможность установки Windows и загрузки с диска 4 КБ без эмуляции (собственный диск 4 КБ)</span><span class="sxs-lookup"><span data-stu-id="a2894-121">Ability to install Windows to and boot from a 4K sector disk without emulation (4K Native Disk)</span></span>
    -   <span data-ttu-id="a2894-122">VHD и новый формат VHDX-файлов</span><span class="sxs-lookup"><span data-stu-id="a2894-122">VHD and new VHDX file format</span></span>
    -   <span data-ttu-id="a2894-123">Полная поддержка HyperV</span><span class="sxs-lookup"><span data-stu-id="a2894-123">Full HyperV support</span></span>
    -   <span data-ttu-id="a2894-124">Архивация Windows</span><span class="sxs-lookup"><span data-stu-id="a2894-124">Windows backup</span></span>
    -   <span data-ttu-id="a2894-125">Полная поддержка в файловой системе Windows (NTFS)</span><span class="sxs-lookup"><span data-stu-id="a2894-125">Full support in the NT file system (NTFS)</span></span>
    -   <span data-ttu-id="a2894-126">Полная поддержка с новыми дисковыми пространствами и пулами (SSP)</span><span class="sxs-lookup"><span data-stu-id="a2894-126">Full support with new Storage Spaces and Pools (SSP)</span></span>
    -   <span data-ttu-id="a2894-127">Полная поддержка с защитником Windows</span><span class="sxs-lookup"><span data-stu-id="a2894-127">Full support with Windows Defender</span></span>
-   <span data-ttu-id="a2894-128">Предоставляет новый API для запроса размера физического сектора (Филефссекторсизеинформатион):</span><span class="sxs-lookup"><span data-stu-id="a2894-128">Provides a new API to query for physical sector size (FileFsSectorSizeInformation):</span></span>
    -   <span data-ttu-id="a2894-129">Доступно для сетевых томов</span><span class="sxs-lookup"><span data-stu-id="a2894-129">Available for network volumes</span></span>
    -   <span data-ttu-id="a2894-130">Может выдаваться любому маркеру файла</span><span class="sxs-lookup"><span data-stu-id="a2894-130">Can be issued to any file handle</span></span>
    -   <span data-ttu-id="a2894-131">Доступно для непривилегированных приложений</span><span class="sxs-lookup"><span data-stu-id="a2894-131">Available for unprivileged apps</span></span>
    -   <span data-ttu-id="a2894-132">Более понятная модель использования</span><span class="sxs-lookup"><span data-stu-id="a2894-132">Friendlier usage model</span></span>
-   <span data-ttu-id="a2894-133">Включает расширенную программу командной строки FSUtil для запроса логического и физического размера сектора тома со сведениями о выравнивании (базовая версия служебной программы без сведений о выравнивании доступна для Windows 7 с Microsoft KB 982018 и Windows Server 2008 R2 с Microsoft KB 982018).</span><span class="sxs-lookup"><span data-stu-id="a2894-133">Includes enhanced  fsutil  command line utility to query for logical and physical sector size of volume with alignment info (basic version of utility without alignment info is available for Windows 7 with Microsoft KB 982018 and Windows Server 2008 R2 with Microsoft KB 982018)</span></span>

<span data-ttu-id="a2894-134">**Введение в расширенный формат (4 КБ) дисков**</span><span class="sxs-lookup"><span data-stu-id="a2894-134">**Introduction to advanced format (4K) disks**</span></span>

<span data-ttu-id="a2894-135">Одной из проблем, связанных с внесением такого изменения в формат мультимедиа, является возможность устранения проблем совместимости с существующим программным обеспечением и оборудованием.</span><span class="sxs-lookup"><span data-stu-id="a2894-135">One of the problems of introducing this change in the media format is the potential for introducing compatibility issues with existing software and hardware.</span></span> <span data-ttu-id="a2894-136">Как временное решение для обеспечения совместимости, отрасль хранения изначально представляет диски, которые имитируют обычный 512-байтовый сектор, но делают доступными сведения о истинном размере сектора с помощью стандартных команд ATA и SCSI.</span><span class="sxs-lookup"><span data-stu-id="a2894-136">As a temporary compatibility solution, the storage industry is initially introducing disks that emulate a regular 512-byte sector disk, but make available info about the true sector size through standard ATA and SCSI commands.</span></span> <span data-ttu-id="a2894-137">В результате этой эмуляции, по сути, два размера сектора:</span><span class="sxs-lookup"><span data-stu-id="a2894-137">As a result of this emulation, there are, in essence, two sector sizes:</span></span>

<span data-ttu-id="a2894-138">**Логический сектор:** Единица, используемая для адресации логических блоков носителя.</span><span class="sxs-lookup"><span data-stu-id="a2894-138">**Logical sector:** The unit that is used for logical block addressing for the media.</span></span> <span data-ttu-id="a2894-139">Мы также можем рассматривать его как наименьшую единицу записи, которую может принимать хранилище.</span><span class="sxs-lookup"><span data-stu-id="a2894-139">We can also think of it as the smallest unit of write that the storage can accept.</span></span> <span data-ttu-id="a2894-140">Это эмуляция.</span><span class="sxs-lookup"><span data-stu-id="a2894-140">This is the  emulation.</span></span>   
<span data-ttu-id="a2894-141">**Физический сектор:** Единица, для которой операции чтения и записи на устройстве выполняются за одну операцию.</span><span class="sxs-lookup"><span data-stu-id="a2894-141">**Physical sector:** The unit for which read and write operations to the device are completed in a single operation.</span></span> <span data-ttu-id="a2894-142">Это единица атомарной записи.</span><span class="sxs-lookup"><span data-stu-id="a2894-142">This is the unit of atomic write.</span></span>  
 <span data-ttu-id="a2894-143">Большинство текущих интерфейсов API Windows, таких как IOCTL \_ диска \_ Get \_ Drive \_ Geometry, возвращают размер логического сектора, но размер физического сектора можно получить с помощью управляющего кода <a href="/windows-hardware/drivers/ddi/content/ntddstor/ni-ntddstor-ioctl_storage_query_property"> \_ \_ \_ Свойства запроса на хранение</a> , с соответствующими сведениями, содержащимися в поле битесперфисикалсектор структуры <a href="/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor"> \_ \_ \_ дескриптора выравнивания доступа к хранилищу</a> .</span><span class="sxs-lookup"><span data-stu-id="a2894-143">Most current Windows APIs, such as IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY will return the logical sector size, but the physical sector size can be retrieved through the <a href="/windows-hardware/drivers/ddi/content/ntddstor/ni-ntddstor-ioctl_storage_query_property">IOCTL\_STORAGE\_QUERY\_PROPERTY</a> control code, with the relevant info contained in the BytesPerPhysicalSector field in the <a href="/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor">STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR</a> structure.</span></span> <span data-ttu-id="a2894-144">Это рассматривается более подробно далее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="a2894-144">This is discussed in more detail later in the article.</span></span>

<span data-ttu-id="a2894-145">**Начальные типы носителей больших секторов**</span><span class="sxs-lookup"><span data-stu-id="a2894-145">**Initial types of large sector media**</span></span>

<span data-ttu-id="a2894-146">Отрасли хранилища быстро избегают усилий по переходу к новому расширенному формату хранилища для носителя с физическим сектором размером 4 КБ.</span><span class="sxs-lookup"><span data-stu-id="a2894-146">The storage industry is quickly ramping up efforts to transition to this new Advanced Format type of storage for media having a 4 KB physical sector size.</span></span> <span data-ttu-id="a2894-147">На рынке будет выпущено два типа носителей:</span><span class="sxs-lookup"><span data-stu-id="a2894-147">Two types of media will be released to the market:</span></span>

<span data-ttu-id="a2894-148">**4 КБ машинный код:** Этот носитель не имеет слоя эмуляции и напрямую предоставляет 4 КБ в качестве логического и физического размера сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-148">**4 KB native:** This media has no emulation layer and directly exposes 4 KB as its logical and physical sector size.</span></span> <span data-ttu-id="a2894-149">Общая проблема с этим новым типом носителя состоит в том, что большинство приложений и операционных систем не запрашивают и не выводят запрос на размер физического сектора, что может привести к непредвиденному выполнению операций ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="a2894-149">The overall issue with this new type of media is that the majority of apps and operating systems do not query for and align I/Os to the physical sector size, which can result in unexpected failed I/Os.</span></span>  
<span data-ttu-id="a2894-150">**512-байтовая эмуляция (512e):** Этот носитель имеет слой эмуляции, как обсуждалось в предыдущем разделе, и предоставляет 512-байты в качестве логического размера (аналогично обычному диску), но предоставляет доступ к сведениям о размере физического сектора (4 КБ).</span><span class="sxs-lookup"><span data-stu-id="a2894-150">**512-byte emulation (512e):** This media has an emulation layer as discussed in the previous section and exposes 512-bytes as its logical sector size (similar to a regular disk today), but makes its physical sector size info (4 KB) available.</span></span> <span data-ttu-id="a2894-151">Общая проблема с этим новым типом носителя состоит в том, что большинство приложений и операционных систем не понимают существование физического размера сектора, что может привести к ряду проблем, которые будут рассмотрены ниже.</span><span class="sxs-lookup"><span data-stu-id="a2894-151">The overall issue with this new type of media is that the majority of app and operating systems do not understand the existence of the physical sector size, which can result in a number of issues as will be discussed below.</span></span>  
<span data-ttu-id="a2894-152">**Общая поддержка Windows для носителей больших секторов**</span><span class="sxs-lookup"><span data-stu-id="a2894-152">**Overall Windows support for large sector media**</span></span>

<span data-ttu-id="a2894-153">В этой таблице документируется официальная политика поддержки Майкрософт для различных носителей и полученных в них данных о размере секторов.</span><span class="sxs-lookup"><span data-stu-id="a2894-153">This table documents the official Microsoft support policy for various media and their resulting reported sector sizes.</span></span> <span data-ttu-id="a2894-154">Дополнительные сведения см. в этой [статье базы знаний](https://support.microsoft.com/kb/2510009) .</span><span class="sxs-lookup"><span data-stu-id="a2894-154">See this [KB article](https://support.microsoft.com/kb/2510009) for details.</span></span>



| <span data-ttu-id="a2894-155">Общие имена</span><span class="sxs-lookup"><span data-stu-id="a2894-155">Common Names</span></span>                                  | <span data-ttu-id="a2894-156">Сообщаемый размер логического сектора</span><span class="sxs-lookup"><span data-stu-id="a2894-156">Reported Logical Sector Size</span></span> | <span data-ttu-id="a2894-157">Сообщаемый размер физического сектора</span><span class="sxs-lookup"><span data-stu-id="a2894-157">Reported Physical Sector Size</span></span> | <span data-ttu-id="a2894-158">Версия Windows с поддержкой</span><span class="sxs-lookup"><span data-stu-id="a2894-158">Windows Version with Support</span></span>                                                                                                                                                                                                                                                                             |
|-----------------------------------------------|------------------------------|-------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="a2894-159">512-байт машинного кода, 512N</span><span class="sxs-lookup"><span data-stu-id="a2894-159">512-byte Native, 512n</span></span>                         | <span data-ttu-id="a2894-160">512 байт</span><span class="sxs-lookup"><span data-stu-id="a2894-160">512 bytes</span></span>                    | <span data-ttu-id="a2894-161">512 байт</span><span class="sxs-lookup"><span data-stu-id="a2894-161">512 bytes</span></span>                     | <span data-ttu-id="a2894-162">Все версии Windows</span><span class="sxs-lookup"><span data-stu-id="a2894-162">All Windows versions</span></span>                                                                                                                                                                                                                                                                                     |
| <span data-ttu-id="a2894-163">Расширенный формат, 512e, AF, 512-байтовая Эмуляция</span><span class="sxs-lookup"><span data-stu-id="a2894-163">Advanced Format, 512e, AF, 512-byte Emulation</span></span> | <span data-ttu-id="a2894-164">512 байт</span><span class="sxs-lookup"><span data-stu-id="a2894-164">512 bytes</span></span>                    | <span data-ttu-id="a2894-165">4 КБ</span><span class="sxs-lookup"><span data-stu-id="a2894-165">4 KB</span></span>                          | <span data-ttu-id="a2894-166">Windows Vista w/MS KB 2553708</span><span class="sxs-lookup"><span data-stu-id="a2894-166">Windows Vista w/ MS KB 2553708</span></span> <br/> <span data-ttu-id="a2894-167">Windows Server 2008 \* w/MS KB 2553708</span><span class="sxs-lookup"><span data-stu-id="a2894-167">Windows Server 2008\* w/ MS KB 2553708</span></span> <br/> <span data-ttu-id="a2894-168">Windows 7 w/MS KB 982018</span><span class="sxs-lookup"><span data-stu-id="a2894-168">Windows 7 w/ MS KB 982018</span></span> <br/> <span data-ttu-id="a2894-169">Windows Server 2008 R2 \* w/MS KB 982018</span><span class="sxs-lookup"><span data-stu-id="a2894-169">Windows Server 2008 R2\* w/ MS KB 982018</span></span> <br/> <span data-ttu-id="a2894-170">Все версии Windows с Windows 7 SP1 и более поздних версий.</span><span class="sxs-lookup"><span data-stu-id="a2894-170">All Windows versions from Windows 7 SP1 and beyond.</span></span> <br/> <span data-ttu-id="a2894-171">Все серверные версии 2008 R2 с пакетом обновления 1 (SP1) и более поздних версий.</span><span class="sxs-lookup"><span data-stu-id="a2894-171">All Server versions from Server 2008 R2 SP1 and beyond.</span></span> <br/> <br/> <span data-ttu-id="a2894-172">\*За исключением Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="a2894-172">\*Except for Hyper-V.</span></span> <span data-ttu-id="a2894-173">См. раздел ["требования к поддержке приложений для дисков больших секторов"](https://support.microsoft.com/help/2510009/microsoft-support-policy-for-4k-sector-hard-drives-in-windows) .</span><span class="sxs-lookup"><span data-stu-id="a2894-173">See the ["Application support requirements for large-sector drives"](https://support.microsoft.com/help/2510009/microsoft-support-policy-for-4k-sector-hard-drives-in-windows) section.</span></span> |
| <span data-ttu-id="a2894-174">Предварительный формат, AF, 4 КБ Native, 4Kn</span><span class="sxs-lookup"><span data-stu-id="a2894-174">Advance Format, AF, 4K Native, 4Kn</span></span>            | <span data-ttu-id="a2894-175">4 КБ</span><span class="sxs-lookup"><span data-stu-id="a2894-175">4 KB</span></span>                         | <span data-ttu-id="a2894-176">4 КБ</span><span class="sxs-lookup"><span data-stu-id="a2894-176">4 KB</span></span>                          | <span data-ttu-id="a2894-177">Все версии Windows от Windows 8 и более поздних версий</span><span class="sxs-lookup"><span data-stu-id="a2894-177">All Windows versions from Windows 8 and beyond</span></span> <br/> <span data-ttu-id="a2894-178">Все версии сервера с Windows Server 2012 и более поздних версий</span><span class="sxs-lookup"><span data-stu-id="a2894-178">All Server versions from Windows Server 2012 and beyond</span></span> <br/>                                                                                                                                                                                                                                                      |
| <span data-ttu-id="a2894-179">Другое</span><span class="sxs-lookup"><span data-stu-id="a2894-179">Other</span></span>                                         | <span data-ttu-id="a2894-180">Не более 4 КБ или 512 байт</span><span class="sxs-lookup"><span data-stu-id="a2894-180">Not 4 KB or 512 bytes</span></span>        | <span data-ttu-id="a2894-181">Не более 4 КБ или 512 байт</span><span class="sxs-lookup"><span data-stu-id="a2894-181">Not 4 KB or 512 bytes</span></span>         | <span data-ttu-id="a2894-182">Не поддерживается</span><span class="sxs-lookup"><span data-stu-id="a2894-182">Not supported</span></span>                                                                                                                                                                                                                                                                                            |



 

> [!Note]  
> <span data-ttu-id="a2894-183">Хотя в предыдущей таблице не превышено значение «ненапряженность», Windows XP, Windows Server 2003 и Windows Server 2003 R2 не поддерживают носители 512e или 4Kn.</span><span class="sxs-lookup"><span data-stu-id="a2894-183">While not stressed in the preceding table, Windows XP, Windows Server 2003, and Windows Server 2003 R2 do not support 512e or 4Kn media.</span></span> <span data-ttu-id="a2894-184">Хотя система может загружаться и работать с минимальными возможностями, возможны неизвестные ситуации, связанные с функциональностью, потерей данных или неоптимальной производительностью.</span><span class="sxs-lookup"><span data-stu-id="a2894-184">While the system may boot up and be able to operate minimally, there may be unknown scenarios of functionality issues, data loss, or sub-optimal performance.</span></span> <span data-ttu-id="a2894-185">Таким образом, корпорация Майкрософт имеет строгие меры предосторожности при использовании 512e Media с Windows XP или другими продуктами, основанными на базе кода Windows XP (например, Windows Home Server 1,0, Windows Server 2003, Windows Server 2003 R2, Windows XP 64-разрядный выпуск, Windows XP Embedded, Windows Small Business Server 2003 и Windows Small Business Server 2003 R2).</span><span class="sxs-lookup"><span data-stu-id="a2894-185">Thus, Microsoft strongly cautions against using 512e media with Windows XP or other products based on the Windows XP codebase (such as Windows Home Server 1.0, Windows Server 2003, Windows Server 2003 R2, Windows XP 64-bit Edition, Windows XP Embedded, Windows Small Business Server 2003, and Windows Small Business Server 2003 R2).</span></span>

 

## <a name="how-emulation-works-read-modify-write-rmw"></a><span data-ttu-id="a2894-186">Как работает эмуляция: чтение и изменение — запись (РМВ)</span><span class="sxs-lookup"><span data-stu-id="a2894-186">How emulation works: read-modify-write (RMW)</span></span>

<span data-ttu-id="a2894-187">Среда хранения содержит определенную единицу, в которой можно изменить физический носитель.</span><span class="sxs-lookup"><span data-stu-id="a2894-187">A storage medium has a certain unit within which the physical medium can be modified.</span></span> <span data-ttu-id="a2894-188">Это значит, что носитель может быть записан или переписан только в единицах физического размера сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-188">That is, the media can only be written, or rewritten, in units of the physical sector size.</span></span> <span data-ttu-id="a2894-189">Таким образом, операции записи, которые не выполняются на этом уровне единиц, потребуют дополнительных действий, которые мы рассмотрим в примере ниже.</span><span class="sxs-lookup"><span data-stu-id="a2894-189">Thus, writes that are not performed at this unit level would require additional steps, which we will walk through the example below.</span></span>

<span data-ttu-id="a2894-190">В этом сценарии приложению необходимо обновить содержимое записи Датастор, расположенной в 512-байтном логическом секторе.</span><span class="sxs-lookup"><span data-stu-id="a2894-190">In this scenario, an app needs to update the contents of a Datastor record located within a 512-byte logical sector.</span></span> <span data-ttu-id="a2894-191">На этой схеме показаны действия, необходимые для завершения записи на устройстве хранения.</span><span class="sxs-lookup"><span data-stu-id="a2894-191">This diagram illustrates the steps necessary for the storage device to complete the write:</span></span>

![действия, необходимые для завершения записи на устройстве хранения](images/512ermwsteps.png)

<span data-ttu-id="a2894-193">Как показано выше, этот процесс подразумевает некоторую работу устройства хранения, которое может привести к снижению производительности.</span><span class="sxs-lookup"><span data-stu-id="a2894-193">As illustrated above, this process involves some work by the storage device that can result in a performance loss.</span></span> <span data-ttu-id="a2894-194">Чтобы избежать этой дополнительной работы, приложения должны быть обновлены до:</span><span class="sxs-lookup"><span data-stu-id="a2894-194">To avoid this additional work, apps must be updated to:</span></span>

-   <span data-ttu-id="a2894-195">Запрос размера физического сектора</span><span class="sxs-lookup"><span data-stu-id="a2894-195">Query for the physical sector size</span></span>
-   <span data-ttu-id="a2894-196">Гарантировать, что операции записи будут выводиться в соответствии с заданным размером физического сектора</span><span class="sxs-lookup"><span data-stu-id="a2894-196">Ensure writes are aligned to that reported physical sector size</span></span>

<span data-ttu-id="a2894-197">Хотя это может показаться только проблемой с производительностью, может возникнуть более серьезная проблема.</span><span class="sxs-lookup"><span data-stu-id="a2894-197">While this may initially appear to be only a performance issue, there can be more serious issue.</span></span> <span data-ttu-id="a2894-198">Давайте обсудим это в следующем разделе.</span><span class="sxs-lookup"><span data-stu-id="a2894-198">Let s discuss this in the next section.</span></span>

<span data-ttu-id="a2894-199">**Устойчивость: скрытые затраты на чтение и изменение — запись**</span><span class="sxs-lookup"><span data-stu-id="a2894-199">**Resiliency: the hidden cost of read-modify-write**</span></span>

<span data-ttu-id="a2894-200">Устойчивость говорит о возможности восстановления состояния приложения между сеансами.</span><span class="sxs-lookup"><span data-stu-id="a2894-200">Resiliency speaks of the ability of an app to recover state between sessions.</span></span> <span data-ttu-id="a2894-201">Мы увидели, что необходимо для устройства хранения 512e для выполнения 512-байтового сектора и записи цикла чтения-изменения и записи.</span><span class="sxs-lookup"><span data-stu-id="a2894-201">We have seen what is necessary for a 512e storage device to perform a 512-byte sector write   the Read-Modify-Write cycle.</span></span> <span data-ttu-id="a2894-202">Давайте посмотрим, что произойдет, если процесс перезаписи предыдущего физического сектора на носителе был прерван.</span><span class="sxs-lookup"><span data-stu-id="a2894-202">Let s look at what would happen if the process of overwriting the previous physical sector on the media was interrupted.</span></span> <span data-ttu-id="a2894-203">Каковы последствия?</span><span class="sxs-lookup"><span data-stu-id="a2894-203">What would be the consequences?</span></span>

-   <span data-ttu-id="a2894-204">Поскольку большинство жестких дисков обновляются на месте, физический сектор, то есть часть носителя, на котором размещен физический сектор, могла быть повреждена с неполными сведениями из-за частичной перезаписи.</span><span class="sxs-lookup"><span data-stu-id="a2894-204">Because most hard disk drives update in place, the physical sector   that is, the portion of the media where the physical sector was located   could have been corrupted with incomplete info due to a partial overwrite.</span></span> <span data-ttu-id="a2894-205">Другими словами, вы можете считать, что это может привести к потере всех 8 логических секторов (которые логически содержат физический сектор).</span><span class="sxs-lookup"><span data-stu-id="a2894-205">Put another way, you can think of it as potentially having lost all 8 logical sectors (which the physical sector logically contains).</span></span>
-   <span data-ttu-id="a2894-206">Хотя большинство приложений с хранилищем данных спроектировано с возможностью восстановления после ошибок носителя, потери восьми секторов или размещения другого способа, потери восьми записей фиксации потенциально могут привести к невозможности корректного восстановления хранилища данных.</span><span class="sxs-lookup"><span data-stu-id="a2894-206">While most apps with a data store are designed with the capability to recover from media errors, the loss of eight sectors, or put another way, the loss of eight commit records, can potentially make it impossible for the data store to recover gracefully.</span></span> <span data-ttu-id="a2894-207">Администратору может потребоваться ручное восстановление базы данных из резервной копии или даже необходимость выполнения длительного перестроения.</span><span class="sxs-lookup"><span data-stu-id="a2894-207">An administrator may need to manually restore the database from a backup or may even need to perform a lengthy rebuild.</span></span>
-   <span data-ttu-id="a2894-208">Еще одно важное влияние заключается в том, что работа другого приложения, вызывающего цикл чтения-изменения и записи, потенциально может привести к потере данных, даже если приложение не запущено.</span><span class="sxs-lookup"><span data-stu-id="a2894-208">One more important impact is that the act of another app causing a Read-Modify-Write cycle can potentially cause your data to be lost   even if your app is not running!</span></span> <span data-ttu-id="a2894-209">Это просто потому, что ваши данные и другие данные приложения могут находиться в одном физическом секторе.</span><span class="sxs-lookup"><span data-stu-id="a2894-209">This is simply because your data and the other app s data could be located within the same physical sector.</span></span>

<span data-ttu-id="a2894-210">С учетом этого важно, чтобы программное обеспечение приложения пересмотрело все предположения, принятые в коде, и было известно о различии логического физического размера сектора, а также о некоторых интересных сценариях клиентов, обсуждаемых далее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="a2894-210">With this in mind, it is important that app software reevaluate any assumptions taken in the code, and be aware of the logical-physical sector size distinction, along with some interesting customer scenarios discussed later in this article.</span></span>

<span data-ttu-id="a2894-211">**Выполнение нужного действия (предотвращение чтения-изменения — запись)**</span><span class="sxs-lookup"><span data-stu-id="a2894-211">**Doing the right thing (avoiding read-modify-write)**</span></span>

<span data-ttu-id="a2894-212">Хотя некоторые поставщики хранилища могут представлять некоторые уровни устранения рисков в определенных устройствах хранения 512e, чтобы попытаться упростить производительность и устойчивость цикла чтения-изменения и записи, существует лишь то, что в плане рабочей нагрузки может обрабатываться лишь множество мер по устранению проблем.</span><span class="sxs-lookup"><span data-stu-id="a2894-212">While some storage vendors may be introducing some levels of mitigation within certain 512e storage devices to try to ease the performance and resiliency issues of the Read-Modify-Write cycle, there is only so much any mitigation can handle in terms of workload.</span></span> <span data-ttu-id="a2894-213">Таким образом, приложения не должны полагаться на эту опасность как долгосрочное решение.</span><span class="sxs-lookup"><span data-stu-id="a2894-213">As such, apps should not rely on this mitigation as a long-term solution.</span></span> <span data-ttu-id="a2894-214">Кроме того, нет никакой гарантии, что все классы дисков будут иметь такое устранение рисков, а также не гарантирует, что устранение рисков будет хорошо спроектировано.</span><span class="sxs-lookup"><span data-stu-id="a2894-214">Moreover, there is no guarantee that all classes of disks will have this mitigation in place, nor is there a guarantee that the mitigation is well-designed.</span></span>

<span data-ttu-id="a2894-215">Это решение не предназначено для устранения проблем, но для разработки приложений с целью обеспечения поддержки такого типа мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="a2894-215">The solution to this is not in-drive mitigation, but to design apps to do the right set of things to help support this type of media.</span></span> <span data-ttu-id="a2894-216">В этом разделе обсуждаются распространенные сценарии, в которых приложения могут столкнуться с проблемами с большими секторами, и предлагаются способы проведения расследования по устранению неполадок.</span><span class="sxs-lookup"><span data-stu-id="a2894-216">This section discusses common scenarios where apps may have issues with large sector disks, and suggests an avenue of investigation to try and resolve each issue.</span></span>

<span data-ttu-id="a2894-217">**Выпуск 1. Секция не согласована с границей физического сектора.**</span><span class="sxs-lookup"><span data-stu-id="a2894-217">**Issue 1: the partition is not aligned to a physical sector boundary**</span></span>

<span data-ttu-id="a2894-218">Когда администратор или пользователь разделяет разделы диска, первый раздел может не быть создан на границе.</span><span class="sxs-lookup"><span data-stu-id="a2894-218">When the administrator/user partitions the disk, the first partition may not have been created on an aligned boundary.</span></span> <span data-ttu-id="a2894-219">Это может привести к тому, что все последующие операции записи не будут выровнены по границам физического сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-219">This may cause all subsequent writes to become unaligned to physical sector boundaries.</span></span> <span data-ttu-id="a2894-220">Начиная с Windows Vista с пакетом обновления 1 (SP1) и Windows Server 2008, первый раздел помещается в первую 1024 КБ диска (для дисков размером 4 ГБ или больше, в противном случае — значение, равное 64 КБ), которое выровнено с границей физического сектора 4 КБ.</span><span class="sxs-lookup"><span data-stu-id="a2894-220">As of Windows Vista SP1 and Windows Server 2008, the first partition is placed at the first 1024 KB of the disk (for disks 4GB or larger, otherwise the alignment is 64 KB) that is aligned to a 4 KB physical sector boundary.</span></span> <span data-ttu-id="a2894-221">Однако при наличии секционирования по умолчанию в Windows XP, служебная программа секционирования сторонних разработчиков или неправильное использование API-интерфейсов Windows созданные секции могут не быть согласованы с границей физического сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-221">However, given the default partitioning in Windows XP, a 3rd party partitioning utility or incorrect usage of Windows APIs, created partitions may not be aligned to a physical sector boundary.</span></span> <span data-ttu-id="a2894-222">Чтобы обеспечить выравнивание, разработчикам необходимо обеспечить использование правильных API-интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="a2894-222">Developers will need to ensure that the correct APIs are used to help ensure alignment.</span></span> <span data-ttu-id="a2894-223">Рекомендуемые API-интерфейсы, помогающие обеспечить выравнивание разделов, описаны ниже.</span><span class="sxs-lookup"><span data-stu-id="a2894-223">The recommended APIs to help ensure partition alignment are outlined below.</span></span>

<span data-ttu-id="a2894-224">API Ивдспакк:: Креатеволуме и IVdsPack2:: CreateVolume2 не используют указанный параметр выравнивания при создании нового тома, но вместо этого использует значение выравнивания по умолчанию для операционной системы (до Windows Vista с пакетом обновления 1 (SP1) будет использовать 63 байт, а после установки пакета обновления 1 (SP1) для Windows Vista будут использоваться значения по умолчанию, указанные выше).</span><span class="sxs-lookup"><span data-stu-id="a2894-224">The IVdsPack::CreateVolume and IVdsPack2::CreateVolume2 APIs do not use the specified alignment parameter when a new volume is created, but rather use the alignment value default for the operating system (Pre-Windows Vista SP1 will use 63 bytes, and post Windows Vista SP1 will use the defaults stated above).</span></span> <span data-ttu-id="a2894-225">Вместо этого используйте API Ивдскреатепартитионекс:: Креатепартитионекс или Ивдсадванцеддиск:: сбой метода CreatePartition, которые используют указанный параметр выравнивания для приложений, которым необходимо создавать секции.</span><span class="sxs-lookup"><span data-stu-id="a2894-225">Instead, use the IVdsCreatePartitionEx::CreatePartitionEx or IVdsAdvancedDisk::CreatePartition APIs that use the specified alignment parameter for those apps that need to create partitions.</span></span>

<span data-ttu-id="a2894-226">Лучший способ обеспечить правильное выравнивание — это сделать это прямо при первоначальном создании секции.</span><span class="sxs-lookup"><span data-stu-id="a2894-226">The best way to help ensure that alignment is correct is to do it right when initially creating the partition.</span></span> <span data-ttu-id="a2894-227">В противном случае приложению потребуется выполнить выравнивание при выполнении операций записи или инициализации, что может быть очень сложным процессом.</span><span class="sxs-lookup"><span data-stu-id="a2894-227">Otherwise your app will need to take alignment into account when performing writes or at initialization   which can be a very complex process.</span></span>

<span data-ttu-id="a2894-228">**Выпуск 2. небуферизованные операции записи, не согласованные с физическим размером сектора**</span><span class="sxs-lookup"><span data-stu-id="a2894-228">**Issue 2: unbuffered writes not aligned to physical sector size**</span></span>

<span data-ttu-id="a2894-229">Самая простая причина заключается в том, что операции записи без буферизации не будут согласованы с зарегистрированным размером физического сектора носителя.</span><span class="sxs-lookup"><span data-stu-id="a2894-229">The simplest issue is that unbuffered writes are not aligned to the reported physical sector size of the storage media.</span></span> <span data-ttu-id="a2894-230">Буферизованные записи, с другой стороны, согласовываются с размером страницы 4 КБ, что, в свою очередь, является физическим размером сектора первого поколения носителя большого сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-230">Buffered writes, on the other hand, are aligned to the page size   4 KB   which coincidently is the physical sector size of the first generation of large sector media.</span></span> <span data-ttu-id="a2894-231">Однако большинство приложений с хранилищем данных выполняют операции записи без буферизации, и поэтому необходимо обеспечить выполнение этих операций записи в единицах физического размера сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-231">However, most apps with a data store perform unbuffered writes, and thus will need to ensure these writes are performed in units of the physical sector size.</span></span>

<span data-ttu-id="a2894-232">Некоторые примеры сценариев, в которых операции ввода-вывода в результирующем приложении не совпадают:</span><span class="sxs-lookup"><span data-stu-id="a2894-232">Some examples of scenarios where the resulting app I/O is unaligned:</span></span>

<span data-ttu-id="a2894-233">**Записи фиксации дополняются до 512 байт:** Приложения с хранилищем данных обычно имеют некоторую форму записи фиксации, которая либо хранит сведения об изменениях метаданных, либо поддерживает структуру хранилища данных.</span><span class="sxs-lookup"><span data-stu-id="a2894-233">**Commit records are padded to 512-byte sectors:** Apps with a data store typically have some form of commit record that either maintains info about metadata changes or maintains the structure of the data store.</span></span> <span data-ttu-id="a2894-234">Чтобы гарантировать, что потери сектора не влияют на несколько записей, эта запись фиксации обычно заполняется размером сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-234">In order to ensure that the loss of a sector does not affect multiple records, this commit record is typically padded out to a sector size.</span></span> <span data-ttu-id="a2894-235">При использовании диска с большим размером физического сектора приложение должно запросить физический размер сектора, как показано в предыдущем разделе, и убедиться, что каждая запись фиксации заполнена этим размером.</span><span class="sxs-lookup"><span data-stu-id="a2894-235">With a disk with a larger physical sector size, the app will need to query for the physical sector size as shown in the prior section, and ensure each commit record is padded to that size.</span></span> <span data-ttu-id="a2894-236">С диском размером 4 КБ это гарантирует, что операции ввода-вывода не завершаются.</span><span class="sxs-lookup"><span data-stu-id="a2894-236">With a 4K disk, this ensures I/Os do not fail.</span></span> <span data-ttu-id="a2894-237">При использовании диска 512e не только это позволяет избежать цикла чтения и изменения. Это гарантирует, что при потере физического сектора будет потеряна только одна запись фиксации.</span><span class="sxs-lookup"><span data-stu-id="a2894-237">With a 512e disk, not only does this avoid the Read-Modify-Write cycle, it helps ensure that if a physical sector was lost, only one Commit Record would be lost.</span></span>  
<span data-ttu-id="a2894-238">**Файлы журнала записываются в несогласованные фрагменты:** Операции ввода-вывода без буферизации обычно используются при обновлении или добавлении файла журнала.</span><span class="sxs-lookup"><span data-stu-id="a2894-238">**Log files are written to in unaligned chunks:** Unbuffered I/O is typically used when updating or appending to a log file.</span></span> <span data-ttu-id="a2894-239">Приложения могут переключиться на буферизованный ввод-вывод или внутренне буферизацию обновлений журнала до единиц физического размера сектора, чтобы избежать неудачных операций ввода-вывода или запуска операции чтения-изменения и записи.</span><span class="sxs-lookup"><span data-stu-id="a2894-239">Apps can either switch to buffered I/O, or internally buffer the log updates to units of the physical sector size to avoid failed I/Os or triggering a Read-Modify-Write.</span></span>  
 <span data-ttu-id="a2894-240">Чтобы определить, выдает ли приложение небуферизованные операции ввода-вывода, убедитесь, что \_ \_ \_ при вызове функции CreateFile не установлен флаг буферизации в параметре *двфлагсандаттрибутес* .</span><span class="sxs-lookup"><span data-stu-id="a2894-240">To help determine if your app issues unbuffered I/O, make sure to include the FILE\_FLAG\_NO\_BUFFERING flag in the *dwFlagsAndAttributes* parameter when you are call the CreateFile function.</span></span>

<span data-ttu-id="a2894-241">Более того, если в настоящее время выполняется согласование операций записи с размером сектора, то этот размер сектора, скорее всего, будет просто логическим размером, так как большинство существующих API, которые запрашивают размер сектора, просто запрашивают единицу адресации, то есть логический размер сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-241">Moreover, if you are currently aligning the writes to the sector size, this sector size is most likely just the logical sector size, as most existing APIs that query for the sector size of the media just query the unit of addressing   that is, the logical sector size.</span></span> <span data-ttu-id="a2894-242">Размер сектора здесь — это физический размер сектора, который является реальной единицей атомарности.</span><span class="sxs-lookup"><span data-stu-id="a2894-242">The sector size of interest here is the physical sector size, which is the real unit of atomicity.</span></span> <span data-ttu-id="a2894-243">Ниже приведены некоторые примеры интерфейсов API, которые получают размер логического сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-243">Some examples of APIs that retrieve the logical sector size are:</span></span>

-   <span data-ttu-id="a2894-244">Жетдискфриспаце, Жетдискфриспацеекс</span><span class="sxs-lookup"><span data-stu-id="a2894-244">GetDiskFreeSpace, GetDiskFreeSpaceEx</span></span>
-   <span data-ttu-id="a2894-245">филефсволумеинформатион</span><span class="sxs-lookup"><span data-stu-id="a2894-245">FileFsVolumeInformation</span></span>
-   <span data-ttu-id="a2894-246">IOCTL \_ Disk \_ Получение \_ \_ геометрии диска, ioctl \_ диск \_ получить \_ диск \_ Geometry \_ ex</span><span class="sxs-lookup"><span data-stu-id="a2894-246">IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY, IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY\_EX</span></span>
-   <span data-ttu-id="a2894-247">Ивдсдиск:: Properties, IVdsDisk3:: GetProperties2</span><span class="sxs-lookup"><span data-stu-id="a2894-247">IVdsDisk::GetProperties, IVdsDisk3::GetProperties2</span></span>

<span data-ttu-id="a2894-248">Вот как можно запросить физический размер сектора:</span><span class="sxs-lookup"><span data-stu-id="a2894-248">Here s how you can query for the physical sector size:</span></span>

<span data-ttu-id="a2894-249">**Предпочтительный метод для Windows 8**</span><span class="sxs-lookup"><span data-stu-id="a2894-249">**Preferred method for Windows 8**</span></span>

<span data-ttu-id="a2894-250">В Windows 8 корпорация Майкрософт представила новый интерфейс API, позволяющий разработчикам легко интегрировать 4-килобайтную поддержку в свои приложения.</span><span class="sxs-lookup"><span data-stu-id="a2894-250">With Windows 8, Microsoft has introduced a new API that enables developers to easily integrate 4K support within their apps.</span></span> <span data-ttu-id="a2894-251">Этот новый API поддерживает даже большее количество сценариев, чем устаревший метод для Windows Vista и Windows 7, описанных ниже.</span><span class="sxs-lookup"><span data-stu-id="a2894-251">This new API supports even greater numbers of scenarios than the legacy method for Windows Vista and Windows 7 discussed below.</span></span> <span data-ttu-id="a2894-252">Этот API включает следующие сценарии вызова:</span><span class="sxs-lookup"><span data-stu-id="a2894-252">This API enables these calling scenarios:</span></span>

-   <span data-ttu-id="a2894-253">Вызов из непривилегированного приложения</span><span class="sxs-lookup"><span data-stu-id="a2894-253">Calling from an unprivileged app</span></span>
-   <span data-ttu-id="a2894-254">Вызов любого допустимого маркера файла</span><span class="sxs-lookup"><span data-stu-id="a2894-254">Calling to any valid file handle</span></span>
-   <span data-ttu-id="a2894-255">Вызов обработчика файлов на удаленном томе через SMB2</span><span class="sxs-lookup"><span data-stu-id="a2894-255">Calling to a file handle on a remote volume over SMB2</span></span>
-   <span data-ttu-id="a2894-256">Упрощенная модель программирования</span><span class="sxs-lookup"><span data-stu-id="a2894-256">Simplified programming model</span></span>

<span data-ttu-id="a2894-257">API-интерфейс представлен в виде нового информационного класса Филефссекторсизеинформатион со связанным файлом структуры файл \_ \_ \_ данных о размере сектора \_ , определенный следующим образом:</span><span class="sxs-lookup"><span data-stu-id="a2894-257">The API is in the form of a new info class, FileFsSectorSizeInformation, with associated structure FILE\_FS\_SECTOR\_SIZE\_INFORMATION, defined as follows:</span></span>


```
typedef struct _FILE_FS_SECTOR_SIZE_INFORMATION {  
    ULONG LogicalBytesPerSector;  
    ULONG PhysicalBytesPerSectorForAtomicity;  
    ULONG PhysicalBytesPerSectorForPerformance;  
    ULONG FileSystemEffectivePhysicalBytesPerSectorForAtomicity;  
    ULONG Flags;  
    ULONG ByteOffsetForSectorAlignment;  
    ULONG ByteOffsetForPartitionAlignment;  
} FILE_FS_SECTOR_SIZE_INFORMATION, *PFILE_FS_SECTOR_SIZE_INFORMATION;
```



<span data-ttu-id="a2894-258">**Устаревший метод для Windows 7 и Windows Vista**</span><span class="sxs-lookup"><span data-stu-id="a2894-258">**Legacy method for Windows 7 and Windows Vista**</span></span>

<span data-ttu-id="a2894-259">В Windows Vista и Windows Server 2008 появились API-интерфейсы для запроса физического размера сектора подключенного устройства хранения для контроллеров хранения на базе AHCI.</span><span class="sxs-lookup"><span data-stu-id="a2894-259">Windows Vista and Windows Server 2008 introduced APIs to query for the physical sector size of the attached storage device for AHCI-based storage controllers.</span></span> <span data-ttu-id="a2894-260">В Windows 7 и Windows Server 2008 R2, начиная с SP1 (или в базе знаний Майкрософт 982018), эта поддержка распространяется на контроллеры хранилища на основе Storport.</span><span class="sxs-lookup"><span data-stu-id="a2894-260">With Windows 7 and Windows Server 2008 R2, as of SP1 (or Microsoft Knowledge Base 982018), this support is extended to Storport-based storage controllers.</span></span> <span data-ttu-id="a2894-261">Корпорация Майкрософт предоставила [пример кода](/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor) на сайте MSDN, в котором подробно описано, как приложение может запрашивать физический размер сектора тома.</span><span class="sxs-lookup"><span data-stu-id="a2894-261">Microsoft has provided a [code sample](/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor) on MSDN detailing how an app can query for the physical sector size of the volume.</span></span>

<span data-ttu-id="a2894-262">Хотя приведенный выше пример кода позволяет получить физический размер сектора тома, перед его использованием следует выполнить некоторые базовые работоспособности проверки полученного физического сектора, так как он наблюдал, что некоторые драйверы могут не возвращать данные в правильном формате:</span><span class="sxs-lookup"><span data-stu-id="a2894-262">While the code sample above allows you to get the physical sector size of the volume, you should do some basic sanity checking of the reported physical sector size before using it, as it has been observed that some drivers may not return correctly formatted data:</span></span>

-   <span data-ttu-id="a2894-263">Убедитесь, что сообщаемый размер физического сектора >= сообщаемый размер логического сектора. Если это не так, приложение должно использовать физический размер сектора, равный сообщенному размеру логического сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-263">Make sure that the reported physical sector size is >= the reported logical sector size; if it is not, your app should use a physical sector size equal to the reported logical sector size</span></span>
-   <span data-ttu-id="a2894-264">Убедитесь, что сообщаемый размер физического сектора равен степени 2; Если это не так, приложение должно использовать физический размер сектора, равный сообщенному размеру логического сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-264">Make sure that the reported physical sector size is a power of two; if it is not, your app should use a physical sector size equal to the reported logical sector size</span></span>
-   <span data-ttu-id="a2894-265">Если размер физического сектора составляет два значения в диапазоне от 512 до 4 КБ, следует использовать физический размер сектора, округленный к сообщенному размеру логического сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-265">If the physical sector size is a power-of-two value between 512-bytes and 4 KB, you should consider using a physical sector size rounded down to the reported logical sector size</span></span>
-   <span data-ttu-id="a2894-266">Если размер физического сектора составляет два значения, превышающий 4 КБ, перед использованием этого значения следует оценить способность приложения работать с этим сценарием. в противном случае следует использовать физический размер сектора с округлением до 4 КБ.</span><span class="sxs-lookup"><span data-stu-id="a2894-266">If the physical sector size is a power-of-two value greater than 4 KB, you should evaluate your app s ability to handle this scenario before using that value; otherwise, you should consider using a physical sector size rounded down to 4 KB</span></span>

<span data-ttu-id="a2894-267">Использование этого IOCTL для получения размера физического сектора имеет несколько ограничений.</span><span class="sxs-lookup"><span data-stu-id="a2894-267">Using this IOCTL to get the physical sector size does have several limitations.</span></span> <span data-ttu-id="a2894-268">Им</span><span class="sxs-lookup"><span data-stu-id="a2894-268">It:</span></span>

-   <span data-ttu-id="a2894-269">Требуются повышенные привилегии; Если приложение не работает с правами доступа, может потребоваться написать приложение службы Windows, как отмечалось выше.</span><span class="sxs-lookup"><span data-stu-id="a2894-269">Requires elevated privilege; if your app is not running with privilege, you may need to write a Windows Service Application as noted above</span></span>
-   <span data-ttu-id="a2894-270">Не поддерживает тома SMB; Вам также может потребоваться написать приложение службы Windows для поддержки запроса размера физического сектора на этих томах.</span><span class="sxs-lookup"><span data-stu-id="a2894-270">Does not support SMB volumes; you may also need to write a Windows Service Application to support physical sector size querying on these volumes</span></span>
-   <span data-ttu-id="a2894-271">Не может быть выдан каким-либо маркером файла (запрос IOCTL должен быть выдан для маркера тома)</span><span class="sxs-lookup"><span data-stu-id="a2894-271">Cannot be issued to any file handle (the IOCTL must be issued to a Volume Handle)</span></span>

<span data-ttu-id="a2894-272">**Причина 3. форматы файлов, которые полагается на 512-байтовые сектора**</span><span class="sxs-lookup"><span data-stu-id="a2894-272">**Issue 3: file formats relying on 512-byte sectors**</span></span>

<span data-ttu-id="a2894-273">Некоторые приложения со стандартными форматами файлов (например, VHD 1,0) могут иметь жестко запрограммированные файлы, чтобы иметь размер секторов размером 512 байт.</span><span class="sxs-lookup"><span data-stu-id="a2894-273">Some apps with standard file formats (such as VHD 1.0) may have these files hard-coded to assume a 512-byte sector size.</span></span> <span data-ttu-id="a2894-274">Таким образом, операции обновления и записи в этот файл приведут к появлению на устройстве цикла чтения и изменения, что может привести к проблемам с производительностью и устойчивостью для клиентов.</span><span class="sxs-lookup"><span data-stu-id="a2894-274">Thus, updates and writes to this file would result in a Read-Modify-Write cycle on the device  which will potentially result in performance and resiliency issues for your customers.</span></span> <span data-ttu-id="a2894-275">Однако существует несколько способов предоставления поддержки для работы с носителями такого типа, например:</span><span class="sxs-lookup"><span data-stu-id="a2894-275">However, there are ways for an app to provide support for operating on this type of media, for example:</span></span>

-   <span data-ttu-id="a2894-276">Использование буферизации для проверки выполнения операций записи в единицах физического размера сектора</span><span class="sxs-lookup"><span data-stu-id="a2894-276">Use buffering to ensure that writes are performed in units of the physical sector size</span></span>
-   <span data-ttu-id="a2894-277">Реализуйте внутреннее чтение, изменение и запись, которое поможет обеспечить выполнение обновлений в единицах полученного физического сектора.</span><span class="sxs-lookup"><span data-stu-id="a2894-277">Implement an internal Read-Modify-Write that can help ensure that updates are performed in units of the reported physical sector size</span></span>
-   <span data-ttu-id="a2894-278">Если возможно, заполните запись на физический сектор таким образом, что заполнение будет интерпретироваться как пустое пространство</span><span class="sxs-lookup"><span data-stu-id="a2894-278">If possible, pad records out to a physical sector, in such a way that the padding would be interpreted as empty space</span></span>
-   <span data-ttu-id="a2894-279">Рассмотрите возможность перепроектирования версии структуры данных приложения с поддержкой больших секторов</span><span class="sxs-lookup"><span data-stu-id="a2894-279">Consider redesigning a version of the app data structure with support for larger sectors</span></span>

<span data-ttu-id="a2894-280">**Причина 4. сообщаемый размер физического сектора может измениться между сеансами**</span><span class="sxs-lookup"><span data-stu-id="a2894-280">**Issue 4: the reported physical sector size can change between sessions**</span></span>

<span data-ttu-id="a2894-281">Существует множество сценариев, в которых зарегистрированный размер физического сектора базового хранилища, на котором размещается Датастор, может измениться.</span><span class="sxs-lookup"><span data-stu-id="a2894-281">There are many scenarios where the reported physical sector size of the underlying storage that hosts the Datastor may change.</span></span> <span data-ttu-id="a2894-282">Чаще всего это происходит при переносе Датастор на другой том или даже по сети.</span><span class="sxs-lookup"><span data-stu-id="a2894-282">The most common of these is when you migrate the Datastor to another volume, or even across the network.</span></span> <span data-ttu-id="a2894-283">Изменение в сообщаемом размере физического сектора может быть непредсказуемым событием для многих приложений и потенциально может привести к тому, что некоторые приложения не смогут повторно инициализироваться.</span><span class="sxs-lookup"><span data-stu-id="a2894-283">A change in the reported physical sector size may be an unexpected event for many apps and potentially can result in some apps failing to re-initialize.</span></span>

<span data-ttu-id="a2894-284">Это не самый простой сценарий для поддержки, и он упоминается здесь как Совет.</span><span class="sxs-lookup"><span data-stu-id="a2894-284">This is not the easiest scenario to support, and is mentioned here as an advisory.</span></span> <span data-ttu-id="a2894-285">Необходимо учитывать требования к мобильности ваших клиентов и соответствующим образом настроить поддержку, чтобы гарантировать, что клиенты не будут негативно затронуты с помощью машинного или 512e носителя 4 КБ.</span><span class="sxs-lookup"><span data-stu-id="a2894-285">You should consider the mobility requirements of your customers and adjust your support accordingly to help ensure customers are not negatively impacted by using 4K native or 512e media.</span></span>

<span data-ttu-id="a2894-286">**Как пользователь может получить логический и физический размер сектора для тома**</span><span class="sxs-lookup"><span data-stu-id="a2894-286">**How a user can retrieve the logical and physical sector size for a volume**</span></span>

<span data-ttu-id="a2894-287">В Box с Windows — это служебная программа для вывода сведений о размере сектора для тома.</span><span class="sxs-lookup"><span data-stu-id="a2894-287">In-box with Windows is a utility to display the sector size info for a volume.</span></span> <span data-ttu-id="a2894-288">Версии Windows с поддержкой fsutil:</span><span class="sxs-lookup"><span data-stu-id="a2894-288">Versions of Windows with supported  fsutil  are:</span></span>

-   <span data-ttu-id="a2894-289">Windows 8</span><span class="sxs-lookup"><span data-stu-id="a2894-289">Windows 8</span></span>
-   <span data-ttu-id="a2894-290">Windows Server 2012</span><span class="sxs-lookup"><span data-stu-id="a2894-290">Windows Server 2012</span></span>
-   <span data-ttu-id="a2894-291">Пакет обновления 1 (SP1) для Windows 7 с Microsoft KB 982018</span><span class="sxs-lookup"><span data-stu-id="a2894-291">Windows 7 SP1 with Microsoft KB 982018</span></span>
-   <span data-ttu-id="a2894-292">Windows 7 с Microsoft KB 982018</span><span class="sxs-lookup"><span data-stu-id="a2894-292">Windows 7 with Microsoft KB 982018</span></span>
-   <span data-ttu-id="a2894-293">Windows Server 2008 R2 с пакетом обновления 1 (SP1) с Microsoft KB 982018 (v3)</span><span class="sxs-lookup"><span data-stu-id="a2894-293">Windows Server 2008 R2 SP1 with Microsoft KB 982018 (v3)</span></span>
-   <span data-ttu-id="a2894-294">Windows Server 2008 R2 с Microsoft KB 982018 (v3)</span><span class="sxs-lookup"><span data-stu-id="a2894-294">Windows Server 2008 R2 with Microsoft KB 982018 (v3)</span></span>
-   <span data-ttu-id="a2894-295">Windows Vista с Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="a2894-295">Windows Vista with Microsoft KB 2553708</span></span>
-   <span data-ttu-id="a2894-296">Windows Server 2008 с Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="a2894-296">Windows Server 2008 with Microsoft KB 2553708</span></span>

<span data-ttu-id="a2894-297">Чтобы получить сведения о размере сектора, вызовите служебную программу следующим образом из командной строки с повышенными привилегиями:</span><span class="sxs-lookup"><span data-stu-id="a2894-297">To get the sector size info, call the utility as follows from an elevated command prompt:</span></span>


```
fsutil fsinfo ntfsinfo <drive letter>
```



<span data-ttu-id="a2894-298">Для диска с сектором 4 КБ с эмуляцией 512 байта для поля bytes per секторе задано значение 512, а для поля bytes на физический сектор — значение 4096, как показано ниже:</span><span class="sxs-lookup"><span data-stu-id="a2894-298">A 4K Sector Disk with 512-byte Emulation has the  Bytes Per Sector  field set to 512 and the  Bytes Per Physical Sector  field set to 4096 as follows:</span></span>

![байт на сектор и на физический сектор диска 4 КБ с эмуляцией 512 байт](images/4ksectordiskwith512emulation.png)

<span data-ttu-id="a2894-300">В 4-килобайтном собственном диске байты на сектор и в байтах на физический сектор устанавливаются в 4096 следующим образом:</span><span class="sxs-lookup"><span data-stu-id="a2894-300">A 4K Native Disk has the  Bytes Per Sector  and  Bytes Per Physical Sector  fields both set to 4096 as follows:</span></span>

![байт на сектор и на физический сектор 4-разрядного диска](images/4knativedisk.png)

> [!Note]  
> <span data-ttu-id="a2894-302">Если в поле "байты на физический сектор" отображается значение не поддерживается, то либо драйвер хранилища не поддерживает \_ свойство запроса к хранилищу ioctl \_ , либо произошла \_ Ошибка при получении сведений.</span><span class="sxs-lookup"><span data-stu-id="a2894-302">If the  Byte Per Physical Sector  field displays  Not Supported  then either the storage driver does not support IOCTL\_STORAGE\_QUERY\_PROPERTY, or there was an error in retrieving the info.</span></span>

 

## <a name="resources"></a><span data-ttu-id="a2894-303">Ресурсы</span><span class="sxs-lookup"><span data-stu-id="a2894-303">Resources</span></span>

-   [<span data-ttu-id="a2894-304">Общая поддержка Windows</span><span class="sxs-lookup"><span data-stu-id="a2894-304">Windows General Support Statement</span></span>](https://support.microsoft.com/kb/2510009)
-   [<span data-ttu-id="a2894-305">Microsoft KB 982018</span><span class="sxs-lookup"><span data-stu-id="a2894-305">Microsoft KB 982018</span></span>](https://support.microsoft.com/kb/982018)
-   [<span data-ttu-id="a2894-306">Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="a2894-306">Microsoft KB 2553708</span></span>](https://support.microsoft.com/kb/2553708)
-   [<span data-ttu-id="a2894-307">Исправление для Windows 7 и Windows Server 2008 R2</span><span class="sxs-lookup"><span data-stu-id="a2894-307">Hotfix for Windows 7 and Windows Server 2008 R2</span></span>](https://support.microsoft.com/kb/982018)
-   [<span data-ttu-id="a2894-308">Исправление для Windows Vista и Windows Server 2008</span><span class="sxs-lookup"><span data-stu-id="a2894-308">Hotfix for Windows Vista and Windows Server 2008</span></span>](https://support.microsoft.com/kb/2553708)
-   [<span data-ttu-id="a2894-309">Оператор поддержки HyperV</span><span class="sxs-lookup"><span data-stu-id="a2894-309">HyperV Support Statement</span></span>](https://support.microsoft.com/kb/2515143)
-   [<span data-ttu-id="a2894-310">Общие сведения о \_ \_ \_ управляющем коде свойства запроса на хранение ioctl</span><span class="sxs-lookup"><span data-stu-id="a2894-310">General information about the IOCTL\_STORAGE\_QUERY\_PROPERTY control code</span></span>](/windows-hardware/drivers/ddi/ntddstor/ni-ntddstor-ioctl_storage_query_property)
-   [<span data-ttu-id="a2894-311">\_ \_ \_ Управляющий код свойства запроса на хранение ioctl</span><span class="sxs-lookup"><span data-stu-id="a2894-311">IOCTL\_STORAGE\_QUERY\_PROPERTY Control Code</span></span>](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_query_property)
-   [<span data-ttu-id="a2894-312">Общие сведения о \_ \_ структуре дескриптора выравнивания доступа к хранилищу \_</span><span class="sxs-lookup"><span data-stu-id="a2894-312">General information about the STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR structure</span></span>](/windows-hardware/drivers/ddi/ntddstor/ns-ntddstor-_storage_access_alignment_descriptor)
-   [<span data-ttu-id="a2894-313">Описание стандартной терминологии, используемой для описания обновлений программного обеспечения Майкрософт</span><span class="sxs-lookup"><span data-stu-id="a2894-313">Description of the standard terminology used to describe Microsoft software updates</span></span>](https://support.microsoft.com/kb/824684/)
-   [<span data-ttu-id="a2894-314">Пример кода WDK с подробными сведениями о том, как извлечь сообщаемое сведения о выравнивании доступа к хранилищу из \_ \_ структуры дескриптора выравнивания доступа к хранилищу \_ при вызове \_ \_ \_ управляющего кода для свойства запроса к хранилищу ioctl</span><span class="sxs-lookup"><span data-stu-id="a2894-314">WDK sample code with details for how to extract the reported storage access alignment info from the STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR structure when making a call to the IOCTL\_STORAGE\_QUERY\_PROPERTY control code</span></span>](/windows/win32/api/winioctl/ns-winioctl-storage_access_alignment_descriptor)
-   <span data-ttu-id="a2894-315">[Общие сведения о параметрах Command-Line ImageX](/previous-versions/windows/it-pro/windows-7/dd799302(v=ws.10))</span><span class="sxs-lookup"><span data-stu-id="a2894-315">[General information about ImageX Command-Line Options](/previous-versions/windows/it-pro/windows-7/dd799302(v=ws.10))</span></span>
-   [<span data-ttu-id="a2894-316">Требования к драйверу набора микросхем Intel для поддержки дисков секторов объемом 4 КБ</span><span class="sxs-lookup"><span data-stu-id="a2894-316">Intel Chipset driver requirements to support 4 KB Sector Drives</span></span>](https://www.intel.com/support/chipsets/imsm/sb/CS-031502.htm)

 

