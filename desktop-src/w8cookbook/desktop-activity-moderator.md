---
title: Модератор активности на рабочем столе
description: Модератор активности на рабочем столе
ms.assetid: F1C54DB0-0AFC-4A1B-9697-6CEB519C2663
keywords:
- время работы батареи
- подключенный ждущий режим
- приостановки
- регулирование
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b465bbb377a06fdad50d04d5fcf788cb2e687fdf5db852125e4143fd971773d7
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119815424"
---
# <a name="desktop-activity-moderator"></a>Модератор активности на рабочем столе

## <a name="platform"></a>Платформа

**клиенты** — Windows 8 


> [!Note]  
> DAM имеется только на Windows 8 клиентских компьютерах, поддерживающих подключение в режиме ожидания. DAM отсутствует в SKU сервера.

 

  

> [!Note]  
> Windows DAM не влияет на приложения магазина, созданные для Windows 8.

 

  
</dl>

## <a name="description"></a>Описание

Наши клиенты переходят на более мелкие и небольшие мобильные платформы для удовлетворения потребностей в сфере вычислений. В рамках смены на мобильные устройства пользователи больше беспокоится о времени работы батареи своих устройств. модератор активности настольных систем (DAM) — это одна из нескольких новых функций Windows 8 предназначенных для обеспечения единообразного времени работы батареи для устройств, поддерживающих подключение в режиме ожидания.

Подключенный ждущий режим происходит, когда устройство включено, но экран выключен. в этом состоянии система технически всегда имеет значение on (для поддержки ключевых сценариев, таких как почта, VoIP, социальные сети и обмен мгновенными сообщениями с приложениями Windows Store). Он аналогичен состоянию, в котором находится смарт-телефон, когда пользователь нажимает кнопку питания.

Таким образом, программное обеспечение (включая приложения и программное обеспечение операционной системы) должно быть правильно настроено во время ожидания подключения. DAM был создан для подавления выполнения настольных приложений таким же образом, как и в спящем режиме (S3 на устройствах ACPI). Это достигается путем приостановки или регулирования процессов настольного программного обеспечения в системе при наличии подключенной резервной записи. это позволяет системам, поддерживающим подключение в режиме ожидания, обеспечить минимальное использование ресурсов и длительное время работы от аккумулятора, одновременно обеспечивая Windows приложений магазина для доставки подключенных им возможностей.

## <a name="details"></a>Сведения

DAM — это драйвер режима ядра, который загружается и инициализируется при загрузке системы, если система поддерживает подключение в режиме ожидания. (Это определяется путем оценки того, является ли поле АОАК в системе \_ \_Структура возможностей питания, возвращаемая функцией каллнтповеринформатион, имеет значение true).

После включения DAM и создания рабочего процесса DAM добавляет ваш процесс в объекты заданий, управляемые системой:

-   Если процесс был создан в сеансе 0, DAM добавляет процесс в объект задания в соответствии с **регулированием** .
-   Если процесс был создан в интерактивном сеансе (сеанс 1 или более поздней версии), DAM добавляет процесс в объект задания в качестве субъекта к **приостановке**

> [!Note]  
> для Windows 8 объекты заданий могут быть вложенными. Это означает, что использование объектов заданий DAM не мешает работе с объектами заданий существующего приложения.

 

Когда экран включен, DAM отменяется и не влияет на процессы в системе. Если система подключена в режиме ожидания, в зависимости от активности системы DAM может регулировать или приостановить процессы.

-   Для процессов, которые подлежат приостановке, все их потоки приостановлены (не могут выполняться при каких-либо обстоятельствах); состояние приложения (память процесса) сохраняется
-   Процессы, подлежащие регулированию циклов между приостановленными и неприостановленными (большая часть времени затратится в приостановленном состоянии)
    -   имейте в виду, что Windows может также обнаружить, что происходят критические действия, и может отменить приостановку регулируемых служб на более длительные периоды времени во время выполнения этой операции.
    -   Кроме того, обратите внимание, что в подключенном режиме ожидания датчики и сети могут быть недоступны, поэтому регулируемые процессы должны быть устойчивыми к низкой ситуации сети (для большинства процессов это не требует каких-либо изменений).

При включении или отключении приостановки DAM метод DAM запускает доставку сообщения WM \_ поверброадкаст этим процессам, которые накладываются на доставку сообщений (через вызов API или оболочку совместимости, описанную ниже). Через несколько секунд режим DAM приостанавливает процесс.

При включении или выключении регулирования DAM уведомления не выводятся. Обработка не требует изменения; процессы продолжают работать, хотя и с более низкой скоростью.

## <a name="manifestation"></a>Проявление

Процессы часто приостанавливаются или регулируется в состоянии ожидания подключения. В большинстве приостановленных приложений это должно быть очень похоже на переход на спящий режим и возобновление режима сна S3. Манифесты могут включать в себя, но не ограничиваются несоответствиями в работе и времени выполнения, а также время работы с стенами, несогласованность в поведении таймера или значительные изменения состояния операционной системы до и после завершения приостановки.

Приостановка и регулирование происходит как единица (все Приостанавливаемые процессы приостанавливаются и не приостанавливаются в одновременном, и все процессы, которые можно регулировать, регулируется и не перерегулируется в одновременном), поэтому обмен данными между двумя приостановленными процессами или двумя регулируемыми процессами не создает проблем.

Программное обеспечение, использующее межпроцессное взаимодействие, может потребовать особого внимания:

-   **Взаимодействие между процессами в сеансе 0 (регулирование) и сеанс 1 + (приостановлено)** — примеры включают значки или компоненты пользовательского интерфейса, представляющие текущее состояние службы.
-   **Взаимодействие между компонентами в пользовательском режиме (сеанс 0 или 1) и драйверами (которые не являются регулируемыми или приостановленными)** — примеры включают службы, которые работают от имени драйвера.

В таких случаях, если межпроцессное взаимодействие не обрабатывается должным образом, приложения могут находиться в состоянии зависания или без реагирования (хотя пользователь может не видеть это воздействие напрямую, так как экран будет отключен при подключении в режиме ожидания). Однако в большинстве случаев службы и драйверы должны быть разработаны так, чтобы быть устойчивыми к проблемам межпроцессного взаимодействия.

Поставщики, создающие программное обеспечение для или зависящие от, должны учитывать, как приостановка процесса влияет на время существования подключения и подтверждения. Кроме того, поскольку сетевое подключение может быть недоступно в режиме ожидания подключения, разработчики процессов, созданных в сеансе 0, должны быть особенно осведомлены о том, как временные сетевые подключения влияют на процесс.

## <a name="solution"></a>Решение

Windows DAM не влияет на приложения Магазина. Если классическое приложение затронет DAM, вы можете запросить уведомления перед его приостановкой (например, чтобы сохранить состояние или закрыть сетевые подключения) с помощью одного из следующих методов:

-   Если приложение имеет окно (HWND) и вы хотите обменять эти уведомления с помощью процедуры окна, вызовите [регистерсуспендресуменотификатион](/windows/win32/api/winuser/nf-winuser-registersuspendresumenotification) для регистрации этих сообщений (или [унрегистерсуспендресуменотификатион](/windows/win32/api/winuser/nf-winuser-unregistersuspendresumenotification) для отмены регистрации). Вы можете использовать \_ \_ дескриптор окна уведомления устройства \_ в параметре Flags и передать HWND окна в качестве параметра получателя. Полученное сообщение является \_ сообщением WM поверброадкаст.
-   Если приложение не имеет окна (HWND) или вам нужен прямой обратный вызов, вызовите [поверрегистерсуспендресуменотификатион](/windows/win32/api/powerbase/nf-powerbase-powerregistersuspendresumenotification) для регистрации этих сообщений (или [поверунрегистерсуспендресуменотификатион](/windows/win32/api/powerbase/nf-powerbase-powerunregistersuspendresumenotification) для отмены регистрации). Необходимо использовать \_ \_ обратный вызов уведомления устройства в параметре Flags и передать значения параметров типа пдевице \_ Notify \_ подписки \_ в параметре Recipient.
-   Если приложение не может быть перекомпилировано, вы можете разрешить получение этих \_ сообщений ПОВЕРБРОАДКАСТ WM через [набор средств AppCompat](../win7appqual/application-compatibility-toolkit--act-.md) (с помощью оболочки совместимости промотедам).

Сообщение о приостановке — WM \_ поверброадкаст с параметром wParam = ПБТ \_ апмсуспенд; это сообщение передается в одновременный режим для всех участвующих в системе процессов. Приложение должно быстро и эффективно выполнять любую работу по пути приостановки. Время ожидания после широковещательного уведомления является глобальным, а не процессом, поэтому процесс может быть в процессе обработки системных ресурсов, если работа, необходимая для этого пути, является большой.

Сообщение возобновления — это WM \_ поверброадкаст с параметром wParam = ПБТ \_ апмресуме; это сообщение передается параллельно во все выбранные процессы после возобновления. Относительное время доставки в систему выхода из подключенного режима ожидания не гарантируется.

Для приложений, связанных с камерой, при переходе в состояние электропитания во время уведомления о приостановке приложения должны освободить все ссылки на камеру (все объекты конвейера захвата должны быть выключены и уничтожены).  чтобы избежать возможного истощения аккумулятора, на Windows 10 RS3 + systems Камера Windows служба Frame Server закрывает все сеансы отслеживания, если приложение не обрабатывает уведомление о приостановке надлежащим образом.  Побочный результат этого заключается в том, что когда система выходит из состояния ожидания или S3/S4, конвейер отслеживания приложения больше не находится в рабочем состоянии.

## <a name="tests"></a>Тесты

Протестируйте программное обеспечение в подключенных переходах в режиме ожидания.

## <a name="resources"></a>Ресурсы

-   [решения для мобильных батарей для Windows 7](/previous-versions/windows/hardware/design/dn641606(v=vs.85))
-   [\_возможности управления питанием системы \_](/windows/win32/api/winnt/ns-winnt-system_power_capabilities)
-   [Функция Каллнтповеринформатион](/windows/win32/api/powerbase/nf-powerbase-callntpowerinformation)
-   [Объекты заданий](../procthread/job-objects.md)
-   [регистерсуспендресуменотификатион](/windows/win32/api/winuser/nf-winuser-registersuspendresumenotification)
-   [унрегистерсуспендресуменотификатион](/windows/win32/api/winuser/nf-winuser-unregistersuspendresumenotification)
-   [поверрегистерсуспендресуменотификатион](/windows/win32/api/powerbase/nf-powerbase-powerregistersuspendresumenotification)
-   [поверунрегистерсуспендресуменотификатион](/windows/win32/api/powerbase/nf-powerbase-powerunregistersuspendresumenotification)
-   [Набор средств AppCompat](../win7appqual/application-compatibility-toolkit--act-.md)

 

 