---
description: При использовании функции автопрокси WinHTTP необходимо учитывать следующие важные моменты.
ms.assetid: 9bae89b7-8f54-42ec-a240-998c97e26d25
title: Проблемы с автопрокси в WinHTTP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 22c6edbf56ec1ffc4dfac930a5d4858429cc6447
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104266093"
---
# <a name="autoproxy-issues-in-winhttp"></a><span data-ttu-id="e1742-103">Проблемы с автопрокси в WinHTTP</span><span class="sxs-lookup"><span data-stu-id="e1742-103">AutoProxy Issues in WinHTTP</span></span>

<span data-ttu-id="e1742-104">При использовании функции автопрокси WinHTTP необходимо учитывать следующие важные моменты.</span><span class="sxs-lookup"><span data-stu-id="e1742-104">Consider the following important issues when using the WinHTTP autoproxy feature.</span></span>

## <a name="only-one-proxy-server-is-currently-supported"></a><span data-ttu-id="e1742-105">В настоящее время поддерживается только один прокси-сервер</span><span class="sxs-lookup"><span data-stu-id="e1742-105">Only One Proxy Server is Currently Supported</span></span>

<span data-ttu-id="e1742-106">В настоящее время WinHTTP не поддерживает конфигурации прокси-серверов, задающих более одного прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="e1742-106">WinHTTP does not currently support proxy configurations that specify more than one proxy server.</span></span> <span data-ttu-id="e1742-107">Если [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) возвращает структуру [**\_ \_ сведений о прокси-сервере WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) , содержащую список прокси-серверов, которые затем задаются приложением в обработчике запросов с помощью параметра **\_ \_ прокси-сервера параметра WinHTTP** , WinHTTP использует только первый прокси-сервер из списка.</span><span class="sxs-lookup"><span data-stu-id="e1742-107">If [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) returns a [**WINHTTP\_PROXY\_INFO**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) structure that contains a list of proxy servers, which the application then sets on the request handle using the **WINHTTP\_OPTION\_PROXY** option, WinHTTP uses only the first proxy server in the list.</span></span> <span data-ttu-id="e1742-108">Если этот прокси-сервер недоступен, служба WinHTTP не выполняет отработку отказа на другие прокси-серверы в списке.</span><span class="sxs-lookup"><span data-stu-id="e1742-108">If that proxy server is not accessible, WinHTTP does not failover to any of the other proxy servers in the list.</span></span> <span data-ttu-id="e1742-109">Чтобы это сделать, в приложении необходимо снова задать параметр **\_ \_ прокси-сервера для параметра WinHTTP** , а затем повторно отправить запрос.</span><span class="sxs-lookup"><span data-stu-id="e1742-109">It is up to the application to handle this case by setting the **WINHTTP\_OPTION\_PROXY** option again with the next proxy server in the list, and resending the request.</span></span>

## <a name="security-risk-mitigation"></a><span data-ttu-id="e1742-110">Устранение рисков безопасности</span><span class="sxs-lookup"><span data-stu-id="e1742-110">Security Risk Mitigation</span></span>

<span data-ttu-id="e1742-111">Для обработки файла автоматической конфигурации прокси-сервера требуется выполнение скачанного кода скрипта.</span><span class="sxs-lookup"><span data-stu-id="e1742-111">Processing the proxy auto-configuration file requires executing downloaded script code.</span></span> <span data-ttu-id="e1742-112">Некоторые проблемы безопасности, которые следует учитывать: Если сервер, на котором находится файл PAC, был скомпрометирован, код сценария PAC может быть вредоносным.</span><span class="sxs-lookup"><span data-stu-id="e1742-112">Some security concerns to consider: If the server on which the PAC file resides has been compromised, it is possible the PAC script code is malicious.</span></span> <span data-ttu-id="e1742-113">Таким образом, WinHTTP использует следующие меры предосторожности для защиты клиента:</span><span class="sxs-lookup"><span data-stu-id="e1742-113">Therefore, WinHTTP uses the following precautions to protect the client:</span></span>

1.  <span data-ttu-id="e1742-114">Коду сценария запрещено создавать экземпляры объектов ActiveX.</span><span class="sxs-lookup"><span data-stu-id="e1742-114">The script code is prevented from instantiating any ActiveX objects.</span></span> <span data-ttu-id="e1742-115">Это блокирует множество потенциально опасных функций, таких как возможность доступа к файлам и выполнения сетевых операций ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="e1742-115">This blocks a lot of potentially dangerous functionality, such as the ability to access files and to perform network I/O.</span></span>
2.  <span data-ttu-id="e1742-116">\* \* Windows Server 2003: \* \*[**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) делегирует всю обработку WPAD внешней службе, службе автоматического обнаружения веб-прокси WinHTTP, которая выполняется под встроенной учетной записью пользователя локальной службы с низким уровнем привилегий.</span><span class="sxs-lookup"><span data-stu-id="e1742-116">\*\*Windows Server 2003:  \*\*[**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) delegates the entire WPAD processing to an external out-of-process service, the WinHTTP Web Proxy Auto-Discovery service, which runs under the low-privileged Local Service built-in user account.</span></span>

3.  <span data-ttu-id="e1742-117">**Windows XP с пакетом обновления 2 (SP2) и Windows Server 2003:** Выполнение скрипта PAC не разрешено дольше 60 секунд, после чего выполнение скрипта прерывается.</span><span class="sxs-lookup"><span data-stu-id="e1742-117">**Windows XP with SP2 and Windows Server 2003:** A PAC script is not permitted to execute for longer than 60 seconds, after which script execution is terminated.</span></span>

4.  <span data-ttu-id="e1742-118">**Windows XP с пакетом обновления 2 (SP2) и Windows Server 2003:** WinHTTP отклоняет файлы PAC, размер которых превышает 1 МБ.</span><span class="sxs-lookup"><span data-stu-id="e1742-118">**Windows XP with SP2 and Windows Server 2003:** WinHTTP rejects PAC files larger than 1MB.</span></span> <span data-ttu-id="e1742-119">Обычно используется файл PAC, размер которого не превышает нескольких килобайт.</span><span class="sxs-lookup"><span data-stu-id="e1742-119">A typical PAC file is usually no more than a few kilobytes in size.</span></span>

<span data-ttu-id="e1742-120">Имейте в виду, что обработка кода сценария PAC требует использования COM, так как в WinHTTP для выполнения скрипта используется компонент Microsoft JScript.</span><span class="sxs-lookup"><span data-stu-id="e1742-120">Be aware that processing the PAC script code requires the use of COM, because WinHTTP uses Microsoft JScript component to execute the script.</span></span> <span data-ttu-id="e1742-121">Если служба WinHTTP не может делегировать обработку протокола WPAD во внешнюю службу автоматического обнаружения веб-прокси, [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) загружает среду выполнения COM в рамках процесса приложения на время вызова.</span><span class="sxs-lookup"><span data-stu-id="e1742-121">If WinHTTP cannot delegate WPAD protocol processing to an external, out-of-process Web Proxy Auto-Discovery service, [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) loads the COM runtime within the application process for the duration of the call.</span></span> <span data-ttu-id="e1742-122">Если само приложение уже использует COM, это не должно быть проблемой.</span><span class="sxs-lookup"><span data-stu-id="e1742-122">If the application itself is already using COM, this should not be a concern.</span></span>

## <a name="performance-considerations"></a><span data-ttu-id="e1742-123">Вопросы производительности</span><span class="sxs-lookup"><span data-stu-id="e1742-123">Performance Considerations</span></span>

<span data-ttu-id="e1742-124">Процесс автоматического обнаружения может выполняться медленно, возможно, до нескольких секунд.</span><span class="sxs-lookup"><span data-stu-id="e1742-124">The auto-detection process can be slow, possibly as long as several seconds.</span></span> <span data-ttu-id="e1742-125">Функции [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) и [винхттпдетектаутопроксиконфигурл](/windows/desktop/api/Winhttp/nf-winhttp-winhttpdetectautoproxyconfigurl) блокируют синхронные функции.</span><span class="sxs-lookup"><span data-stu-id="e1742-125">The [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) and [WinHttpDetectAutoProxyConfigUrl](/windows/desktop/api/Winhttp/nf-winhttp-winhttpdetectautoproxyconfigurl) functions are blocking, synchronous functions.</span></span> <span data-ttu-id="e1742-126">Это может быть то, что один конкретный механизм автоматического обнаружения (например, DHCP) работает намного медленнее, чем другой (например, DNS).</span><span class="sxs-lookup"><span data-stu-id="e1742-126">It could be that one particular auto-detection mechanism (such as DHCP) is much slower than the other (such as DNS).</span></span> <span data-ttu-id="e1742-127">Если для **\_ автоматического обнаружения WinHTTP \_ \_ типа \_ DHCP** и **WinHTTP \_ автоматически \_ обнаруживается \_ тип \_ DNS, \_ то** службы WinHTTP сначала используют DHCP в соответствии со спецификацией WPAD.</span><span class="sxs-lookup"><span data-stu-id="e1742-127">If both the **WINHTTP\_AUTO\_DETECT\_TYPE\_DHCP** and **WINHTTP\_AUTO\_DETECT\_TYPE\_DNS\_A** auto-detection flags are specified, WinHTTP uses DHCP first, in accordance with the WPAD specification.</span></span> <span data-ttu-id="e1742-128">Если URL-адрес PAC не обнаружен с помощью запроса DHCP, служба WinHTTP пытается найти файл PAC по известному DNS-адресу.</span><span class="sxs-lookup"><span data-stu-id="e1742-128">If no PAC URL is discovered by issuing a DHCP request, then WinHTTP tries to locate the PAC file at a well-known DNS address.</span></span>

<span data-ttu-id="e1742-129">[**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) использует параметр обработки сеанса WinHTTP для кэширования файла PAC и результатов автоматического обнаружения.</span><span class="sxs-lookup"><span data-stu-id="e1742-129">[**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) uses the WinHTTP Session handle parameter for caching the PAC file and the results of auto-detection.</span></span> <span data-ttu-id="e1742-130">Лучше использовать один и тот же обработчик сеанса для нескольких вызовов **WinHttpGetProxyForUrl** , если это возможно, чтобы избежать повторного обнаружения URL-адресов PAC и загрузки файлов.</span><span class="sxs-lookup"><span data-stu-id="e1742-130">It is best to use the same session handle for multiple **WinHttpGetProxyForUrl** calls if possible to avoid repeated PAC URL detection and file downloading.</span></span> <span data-ttu-id="e1742-131">Файл PAC кэшируется только в памяти и отбрасывается, когда приложение закрывает обработчик сеанса.</span><span class="sxs-lookup"><span data-stu-id="e1742-131">The PAC file is cached in-memory only, and is discarded when the application closes the session handle.</span></span>

<span data-ttu-id="e1742-132">Из-за влияния автопрокси на производительность рекомендуется, чтобы только клиентские приложения или службы настольных компьютеров использовали эту функцию. серверные приложения должны полагаться на администратора сервера с помощью служебной программы "ProxyCfg.exe".</span><span class="sxs-lookup"><span data-stu-id="e1742-132">Because of the performance impact of autoproxy, it is recommended that only desktop client applications or services use the feature; server-based applications should rely on the server administrator using the "ProxyCfg.exe" utility.</span></span>

 

 



