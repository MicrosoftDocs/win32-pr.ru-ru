---
description: 'Следующие вопросы безопасности применяются к приложениям, использующим WinHTTP: сертификаты сервера проверяются только один раз за сеанс.'
ms.assetid: 287e85ed-a324-4785-872a-26e4ab37986d
title: Вопросы безопасности WinHTTP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: dc06725ba03631eb4d5e5c29f8cfa0aae69b5022
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104497487"
---
# <a name="winhttp-security-considerations"></a><span data-ttu-id="9e5a0-103">Вопросы безопасности WinHTTP</span><span class="sxs-lookup"><span data-stu-id="9e5a0-103">WinHTTP Security Considerations</span></span>

<span data-ttu-id="9e5a0-104">Следующие вопросы безопасности относятся к приложениям, использующим WinHTTP.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-104">The following security considerations apply to applications that use WinHTTP:</span></span>

-   <span data-ttu-id="9e5a0-105">**Сертификаты сервера проверяются только один раз за сеанс.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-105">**Server certificates are only verified once per session.**</span></span> <span data-ttu-id="9e5a0-106">После проверки сертификата он остается действительным в течение текущего сеанса.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-106">After a certificate has been verified, it remains valid for the duration of the current session.</span></span> <span data-ttu-id="9e5a0-107">Если отпечаток сертификата совпадает, что означает, что сертификат не изменился, сертификат будет продолжать проверяться повторно.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-107">As long as the certificate fingerprint matches, which indicates that the certificate has not changed, the certificate continues to be re-validated.</span></span> <span data-ttu-id="9e5a0-108">В результате все изменения в условиях проверки с помощью флагов протокол, отзыв или сертификат-ошибка-игнорировать не вступают в силу после проверки сертификата.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-108">As a result, any change in the validation criteria, through the protocol, revocation-check, or certificate-error-ignore flags, does not take effect once the certificate is verified.</span></span> <span data-ttu-id="9e5a0-109">Чтобы принудительно применить это изменение немедленно, необходимо завершить текущий сеанс и запустить новый.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-109">To force such a change to take effect immediately, the current session must be ended and a new one started.</span></span> <span data-ttu-id="9e5a0-110">Аналогично, срок действия сертификата в течение сеанса может быть обнаружен только в том случае, если само приложение периодически проверяет сервер сертификатов на получение данных об истечении срока действия.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-110">Similarly, expiration of a certificate during the course of a session can only be detected if the application itself checks the certificate server periodically to retrieve expiration data.</span></span>
-   <span data-ttu-id="9e5a0-111">**Автоматический прокси включает загрузку и выполнение скриптов.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-111">**Auto-proxy involves downloading and executing scripts.**</span></span> <span data-ttu-id="9e5a0-112">Поддержка автоматического обнаружения прокси-сервера включает в себя обнаружение через DHCP или DNS, загрузку и выполнение скриптов прокси-сервера, таких как сценарии Java.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-112">The automatic proxy discovery support involves detecting through DHCP or DNS, downloading, and executing proxy scripts such as Java scripts.</span></span> <span data-ttu-id="9e5a0-113">Чтобы обеспечить более высокий уровень безопасности, приложение должно избегать передачи флага **запуска автоматического \_ прокси WinHTTP \_ \_** , чтобы автоматическое обнаружение прокси-сервера было инициировано вне процесса.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-113">To achieve a higher degree of security, an application must avoid passing the **WINHTTP\_AUTOPROXY\_RUN\_INPROCESS** flag, so that the auto-proxy discovery is initiated out-of-process.</span></span> <span data-ttu-id="9e5a0-114">Несмотря на это, служба WinHTTP пытается запустить скрипт автоматического прокси-сервера по умолчанию, если сценарий не работает должным образом.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-114">Even then, WinHTTP tries by default to run an auto-proxy script in-process if the script fails to run properly out-of-process.</span></span> <span data-ttu-id="9e5a0-115">Если вы считаете, что данное резервное поведение является неприемлемым, отключите поведение отката с помощью флага **\_ запуска "автопрокси WinHTTP \_ \_ \_ только обработка** ".</span><span class="sxs-lookup"><span data-stu-id="9e5a0-115">If you believe that this fallback behavior poses an unacceptable risk, disable the fallback behavior with the **WINHTTP\_AUTOPROXY\_RUN\_OUTPROCESS\_ONLY** flag.</span></span>
-   <span data-ttu-id="9e5a0-116">**\_ \_ Функции обратного вызова состояния WinHTTP должны быстро возвращаться.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-116">**WINHTTP\_STATUS\_CALLBACK functions must return promptly.**</span></span> <span data-ttu-id="9e5a0-117">При написании одной из этих функций ответного вызова Будьте внимательны, чтобы они не блокировались.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-117">When you write one of these callback functions, be careful that it does not block.</span></span> <span data-ttu-id="9e5a0-118">Например, ни обратный вызов, ни любая функция, которая вызывает, не должна отображать диалоговое окно пользователя или ожидать события.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-118">For example, neither the callback nor any function it calls should display a user dialog or wait for an event.</span></span> <span data-ttu-id="9e5a0-119">Если функция [*\_ \_ обратного вызова состояния WinHTTP*](/windows/win32/api/winhttp/nc-winhttp-winhttp_status_callback) блокируется, она влияет на внутреннее планирование WinHTTP и приводит к отказу других запросов в пределах того же процесса.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-119">If a [*WINHTTP\_STATUS\_CALLBACK*](/windows/win32/api/winhttp/nc-winhttp-winhttp_status_callback) function does block, it affects WinHTTP's internal scheduling and causes other requests within the same process to be denied service.</span></span>
-   <span data-ttu-id="9e5a0-120">**\_ \_ Функции обратного вызова состояния WinHTTP должны быть повторными.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-120">**WINHTTP\_STATUS\_CALLBACK functions must be reentrant.**</span></span> <span data-ttu-id="9e5a0-121">При написании обратного вызова Избегайте использования статических переменных или других конструкций, которые не являются ненадежными при перевходе, и избегайте вызова других функций, которые не являются повторными.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-121">When writing a callback, avoid static variables or other constructs that are unsafe under reentrance, and avoid calling other functions that are not reentrant.</span></span>
-   <span data-ttu-id="9e5a0-122">**Если возможна асинхронная операция, передайте значения NULL для параметров OUT.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-122">**If asynchronous operation is possible, pass NULLs for OUT parameters.**</span></span> <span data-ttu-id="9e5a0-123">Если асинхронная операция включена путем регистрации функции обратного вызова, всегда передавать значения **null** для таких параметров out в *качестве лпдвдатааваилабле* для [**винхттпкуеридатааваилабле**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpquerydataavailable), *лпдвбитесреад* для [**WinHttpReadData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreaddata)или *лпдвбитесвриттен* для [**WinHttpWriteData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpwritedata).</span><span class="sxs-lookup"><span data-stu-id="9e5a0-123">If you have enabled asynchronous operation by registering a callback function, always pass **NULL** values for such OUT parameters as *lpdwDataAvailable* for [**WinHttpQueryDataAvailable**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpquerydataavailable), *lpdwBytesRead* for [**WinHttpReadData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreaddata), or *lpdwBytesWritten* for [**WinHttpWriteData**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpwritedata).</span></span> <span data-ttu-id="9e5a0-124">В некоторых обстоятельствах вызывающий поток завершается до завершения операции, а если выходные параметры не **равны NULL**, функция может завершить запись в память, которая уже была освобождена.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-124">Under some circumstances, the calling thread is terminated before the operation completes, and if the OUT parameters are not **NULL**, the function can end up writing to memory that has already been freed.</span></span>
-   <span data-ttu-id="9e5a0-125">**Проверка подлинности паспорта не гарантируется.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-125">**Passport authentication is not foolproof.**</span></span> <span data-ttu-id="9e5a0-126">Любая схема проверки подлинности на основе файлов cookie уязвима для атак.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-126">Any cookie-based authentication scheme is vulnerable to attack.</span></span> <span data-ttu-id="9e5a0-127">Паспорт версии 1,4 основан на файлах cookie и, следовательно, подвержен уязвимостям, связанным с любым файлом cookie или схемой проверки подлинности на основе форм.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-127">Passport version 1.4 is cookie based, and therefore subject to the vulnerabilities that are associated with any cookie or form-based authentication scheme.</span></span> <span data-ttu-id="9e5a0-128">Поддержка паспорта отключена по умолчанию в WinHTTP; его можно включить с помощью [**винхттпсетоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption).</span><span class="sxs-lookup"><span data-stu-id="9e5a0-128">Passport support is disabled by default in WinHTTP; it can be enabled using [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption).</span></span>
-   <span data-ttu-id="9e5a0-129">**Обычная проверка подлинности должна использоваться только через безопасное соединение.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-129">**Basic authentication should only be used over a secure connection.**</span></span> <span data-ttu-id="9e5a0-130">Обычная проверка подлинности, которая отправляет имя пользователя и пароль в виде открытого текста (см. [RFC 2617](https://www.ietf.org/rfc/rfc2617.txt)), следует использовать только через зашифрованные соединения SSL или TLS.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-130">Basic authentication, which sends the user name and password in clear text (see [RFC 2617](https://www.ietf.org/rfc/rfc2617.txt)), should be used only over encrypted SSL or TLS connections.</span></span>
-   <span data-ttu-id="9e5a0-131">**Установка для политики автоматического входа значения "низкая" может представлять риск.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-131">**Setting Auto-Logon Policy to "low" can pose a risk.**</span></span> <span data-ttu-id="9e5a0-132">Если для политики автоматического входа задано значение низкий, для проверки подлинности на любом сайте можно использовать учетные данные входа пользователя.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-132">When the Auto-Logon Policy is set to low, a user's logon credential can be used to authenticate against any site.</span></span> <span data-ttu-id="9e5a0-133">Однако не рекомендуется использовать проверку подлинности на ненадежных сайтах.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-133">However, it is not good security practice to authenticate against sites you do not trust.</span></span>
-   <span data-ttu-id="9e5a0-134">**SSL-соединения 2,0 не используются, если явно не включено.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-134">**SSL 2.0 connections are not used unless explicitly enabled.**</span></span> <span data-ttu-id="9e5a0-135">Протоколы безопасности TLS 1,0 и SSL 3,0 считаются более безопасными, чем SSL 2,0.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-135">The TLS 1.0 and SSL 3.0 security protocols are considered more secure than SSL 2.0.</span></span> <span data-ttu-id="9e5a0-136">По умолчанию WinHTTP запрашивает TLS 1,0 или SSL 3,0 при согласовании SSL-соединения, а не SSL 2,0.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-136">By default, WinHTTP requests TLS 1.0 or SSL 3.0 when negotiating an SSL connection, not SSL 2.0.</span></span> <span data-ttu-id="9e5a0-137">Поддержку SSL 2,0 в WinHTTP можно включить только путем вызова [**винхттпсетоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption).</span><span class="sxs-lookup"><span data-stu-id="9e5a0-137">SSL 2.0 support in WinHTTP can only be enabled by calling [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption).</span></span>
-   <span data-ttu-id="9e5a0-138">**Необходимо явно запросить проверку отзыва сертификатов.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-138">**Certificate-revocation checking must be explicitly requested.**</span></span> <span data-ttu-id="9e5a0-139">По умолчанию при выполнении проверки подлинности сертификата служба WinHTTP не проверяет, отозван ли сертификат сервера.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-139">By default, when performing certificate authentication, WinHTTP does not check whether the server's certificate has been revoked.</span></span> <span data-ttu-id="9e5a0-140">Проверку отзыва сертификатов можно включить с помощью [**винхттпсетоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption).</span><span class="sxs-lookup"><span data-stu-id="9e5a0-140">Certificate-revocation checking can be enabled using [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption).</span></span>
-   <span data-ttu-id="9e5a0-141">**Приложения должны гарантировать, что сеанс сопоставляется с одним удостоверением.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-141">**Applications must ensure that a session maps to a single identity.**</span></span> <span data-ttu-id="9e5a0-142">Сеанс WinHTTP должен сопоставляться с одним и только одним удостоверением. то есть сеанс WinHTTP используется для управления Интернет-работой одного пользователя, прошедшего проверку подлинности, или группы анонимных пользователей.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-142">A WinHTTP session should map to one and only one identity; that is, a WinHTTP session is used to manage the Internet activity of a single authenticated user, or a group of anonymous users.</span></span> <span data-ttu-id="9e5a0-143">Однако поскольку служба WinHTTP не применяет это сопоставление автоматически, приложение должно предпринять шаги, чтобы убедиться в том, что участвует только одно удостоверение.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-143">However, because WinHTTP does not enforce this mapping automatically, your application must take steps to ensure that only a single identity is involved.</span></span>
-   <span data-ttu-id="9e5a0-144">**Операции с обработчиком запросов WinHTTP должны быть синхронизированы.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-144">**Operations on a WinHTTP request handle should be synchronized.**</span></span> <span data-ttu-id="9e5a0-145">Например, приложение не должно закрывать обработчик запроса в одном потоке, пока другой поток отправляет или получает запрос.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-145">For example, an application should avoid closing a request handle on one thread while another thread is sending or receiving a request.</span></span> <span data-ttu-id="9e5a0-146">Чтобы завершить асинхронный запрос, закройте обработчик запроса во время уведомления обратного вызова.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-146">To terminate an asynchronous request, close the request handle during a callback notification.</span></span> <span data-ttu-id="9e5a0-147">Чтобы завершить синхронный запрос, закройте этот обработчик при возвращении предыдущего вызова WinHTTP.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-147">To terminate a synchronous request, close the handle when the previous WinHTTP call returns.</span></span>
-   <span data-ttu-id="9e5a0-148">**Файлы трассировки содержат конфиденциальную информацию.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-148">**Trace files contain sensitive information.**</span></span> <span data-ttu-id="9e5a0-149">Файлы трассировки защищаются с помощью списков Access-Control (ACL), поэтому доступ к одному из них обычно может осуществлять только локальный администратор или учетная запись пользователя, создавшая его. Старайтесь не нарушить безопасность файлов трассировки при любом несанкционированном доступе.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-149">Trace files are protected using Access-Control Lists (ACLs) so that one can normally be accessed only by the local administrator or by the user account that created it.Avoid compromising trace files by any unauthorized access.</span></span>
-   <span data-ttu-id="9e5a0-150">**Старайтесь не передавать конфиденциальные данные через** [**винхттпсетоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption).</span><span class="sxs-lookup"><span data-stu-id="9e5a0-150">**Avoid passing sensitive data through** [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption).</span></span> <span data-ttu-id="9e5a0-151">Не указывайте имя пользователя, пароль или другие учетные данные для **винхттпсетоптион** , так как вы не контролируете используемую схему проверки подлинности, а конфиденциальные данные могут быть неожиданно отправлены в виде открытого текста.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-151">Do not supply a user name, password or any other credentials to **WinHttpSetOption** because you have no control over the authentication scheme that is used, and the sensitive data could unexpectedly be sent in clear text.</span></span> <span data-ttu-id="9e5a0-152">Для настройки учетных данных используйте [**винхттпкуеряуссчемес**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpqueryauthschemes) и **винхттпсеткредентиалс** вместо **винхттпсетоптион** .</span><span class="sxs-lookup"><span data-stu-id="9e5a0-152">Use [**WinHttpQueryAuthSchemes**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpqueryauthschemes) and **WinHttpSetCredentials** instead of **WinHttpSetOption** for setting credentials.</span></span>
-   <span data-ttu-id="9e5a0-153">**Автоматическое перенаправление может представлять угрозу безопасности.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-153">**Automatic redirection can pose a security risk.**</span></span> <span data-ttu-id="9e5a0-154">По умолчанию перенаправление (сообщение 302) пройдет автоматически даже для записи.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-154">By default, redirection (a 302 message) is followed automatically even for a POST.</span></span> <span data-ttu-id="9e5a0-155">Чтобы избежать возможного ложного перенаправления, приложения должны отключить автоматическое перенаправление или перенаправление монитора в обратных вызовах при отправке конфиденциальной информации.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-155">To avoid the possibility of spurious redirects, applications should disable auto-redirect or monitor re-direction in callbacks when posting sensitive information.</span></span>
-   <span data-ttu-id="9e5a0-156">**Определяемые пользователем заголовки передаются при неизменном перенаправлении.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-156">**User-defined headers are transferred across redirects unchanged.**</span></span> <span data-ttu-id="9e5a0-157">Определяемые пользователем заголовки, например файлы cookie, добавленные с помощью **винхттпаддрекуессеадерс**, передаются по перенаправлениям без изменения, а заголовки, формируемые WinHTTP, обновляются автоматически.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-157">User-defined headers, such as cookies added with **WinHTTPAddRequestHeaders**, are transferred across redirects without modification, while headers generated by WinHTTP are automatically updated.</span></span> <span data-ttu-id="9e5a0-158">Если пересылка определяемого пользователем заголовка между перенаправлениями создает угрозу безопасности, используйте обратный вызов [*\_ \_ обратного вызова состояния WinHTTP*](/windows/win32/api/winhttp/nc-winhttp-winhttp_status_callback) с **\_ состоянием обратного вызова WinHTTP \_ \_** , чтобы изменить заданный заголовок при каждом перенаправлении.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-158">If transferring a user-defined header across redirects poses a security risk, use the [*WINHTTP\_STATUS\_CALLBACK*](/windows/win32/api/winhttp/nc-winhttp-winhttp_status_callback) callback with the **WINHTTP\_CALLBACK\_STATUS\_REDIRECT** completion to modify the header in question whenever a redirect occurs.</span></span>
-   <span data-ttu-id="9e5a0-159">**Служба WinHTTP не передается в синхронном режиме.**</span><span class="sxs-lookup"><span data-stu-id="9e5a0-159">**WinHTTP is not reentrant in synchronous mode.**</span></span> <span data-ttu-id="9e5a0-160">Так как WinHTTP не перенадается в синхронном режиме, не запланируйте асинхронные вызовы процедур (APC), которые могут вызывать WinHTTP в потоке приложения, выполняемом внутри функции WinHTTP.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-160">Because WinHTTP is not reentrant in synchronous mode, do not schedule asynchronous procedure calls (APC) that can call into WinHTTP on an application thread that executes inside a WinHTTP function.</span></span> <span data-ttu-id="9e5a0-161">В синхронном режиме WinHTTP выполняет "ожидание с предупреждением", и если ожидающий поток предварительно виртуальная машина прервана для выполнения APC, а затем снова введет WinHTTP, то внутреннее состояние WinHTTP может быть повреждено.</span><span class="sxs-lookup"><span data-stu-id="9e5a0-161">While in synchronous mode, WinHTTP performs an "alertable wait," and if the waiting thread is pre-empted to execute an APC and then later re-enters WinHTTP again, WinHTTP's internal state can be corrupted.</span></span>

 

 
