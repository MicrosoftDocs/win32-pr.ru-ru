---
description: Обработка файлов cookie в WinHTTP
ms.assetid: ef0f0847-05f6-4477-8e48-e0bea66314ab
title: Обработка файлов cookie в WinHTTP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8e3b596225dc3c741ab9ed0139a63e343e7afb3d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105703397"
---
# <a name="cookie-handling-in-winhttp"></a><span data-ttu-id="50d1d-103">Обработка файлов cookie в WinHTTP</span><span class="sxs-lookup"><span data-stu-id="50d1d-103">Cookie Handling in WinHTTP</span></span>

<span data-ttu-id="50d1d-104">Данные сеанса HTTP передаются между клиентом и сервером в заголовке файла Cookie запроса или ответа.</span><span class="sxs-lookup"><span data-stu-id="50d1d-104">HTTP session data is passed between the client and server in the cookie header of the request or the response.</span></span> <span data-ttu-id="50d1d-105">Сервер отправляет файлы cookie клиенту в заголовке Set-Cookie ответа, а API WinHTTP повторно отправляет файл cookie сервера на сервер в заголовке файла Cookie запроса.</span><span class="sxs-lookup"><span data-stu-id="50d1d-105">The server sends cookies to the client in the Set-cookie header of the response and the WinHTTP API resends the server cookie to the server in the cookie header of the request.</span></span> <span data-ttu-id="50d1d-106">Спецификации обработки файлов cookie, описанные в RFC 2109 (механизм управления состоянием HTTP), реализуются по умолчанию в WinHTTP.</span><span class="sxs-lookup"><span data-stu-id="50d1d-106">The cookie handling specifications, described in rfc 2109 (HTTP State Management Mechanism), are implemented by default in WinHTTP.</span></span> <span data-ttu-id="50d1d-107">Последние спецификации обработки файлов cookie, описанные в RFC 2964, не поддерживаются WinHTTP.</span><span class="sxs-lookup"><span data-stu-id="50d1d-107">Recent cookie handling specifications, described in rfc 2964, are not supported by WinHTTP.</span></span>

<span data-ttu-id="50d1d-108">WinHTTP получает файл cookie из заголовка Servers Set-Cookie и сохраняет его в кэше отдельно для каждого сеанса.</span><span class="sxs-lookup"><span data-stu-id="50d1d-108">WinHTTP obtains the cookie from the servers Set-Cookie header and stores it in a cache on a per-session basis.</span></span> <span data-ttu-id="50d1d-109">Этот файл cookie повторно отправляется при последующих запросах в том же сеансе WinHTTP, где целевой объект соответствует источнику файла cookie.</span><span class="sxs-lookup"><span data-stu-id="50d1d-109">This cookie is resent on subsequent requests in the same WinHTTP session where the target matches the source of the cookie.</span></span> <span data-ttu-id="50d1d-110">API WinHTTP повторно создает заголовок файла запроса для каждого участка в запросе.</span><span class="sxs-lookup"><span data-stu-id="50d1d-110">The WinHTTP API regenerates the request cookie header for each leg in the request.</span></span>

<span data-ttu-id="50d1d-111">В списке ниже описаны некоторые параметры, которые клиентские приложения WinHTTP могут использовать для обработки файлов cookie:</span><span class="sxs-lookup"><span data-stu-id="50d1d-111">The follow list describes several options that WinHTTP client applications can use to handle cookies:</span></span>

-   <span data-ttu-id="50d1d-112">Автоматическая обработка файлов cookie. WinHTTP автоматически обрабатывает файлы cookie, а клиентское приложение не выполняет обработку пользовательских файлов cookie.</span><span class="sxs-lookup"><span data-stu-id="50d1d-112">Automatic Cookie Handling - WinHTTP automatically handles cookies and the client application performs no custom cookie handling.</span></span>
-   <span data-ttu-id="50d1d-113">Отключить автоматическую обработку файлов cookie. Автоматическая обработка файлов cookie в API WinHTTP отключена, а файлы cookie не отправляются.</span><span class="sxs-lookup"><span data-stu-id="50d1d-113">Disable Automatic Cookie Handling - Automatic cookie handling in the WinHTTP API is disabled and no cookies are sent.</span></span>
-   <span data-ttu-id="50d1d-114">Вручную указывать все файлы cookie — автоматическая обработка файлов cookie отключена, а клиентское приложение добавляет или удаляет все заголовки файлов cookie для каждого запроса в сеансе.</span><span class="sxs-lookup"><span data-stu-id="50d1d-114">Manually specify all Cookies – Automatic cookie handling is disabled and the client application adds or removes all cookie headers for each request in the session.</span></span>
-   <span data-ttu-id="50d1d-115">Ручная и автоматическая обработка файлов cookie. объединение автоматической и ручной обработки файлов cookie.</span><span class="sxs-lookup"><span data-stu-id="50d1d-115">Manual and Automatic Cookie Handling - Combine automatic and manual cookie handling.</span></span>

## <a name="disabling-automatic-cookie-handling"></a><span data-ttu-id="50d1d-116">Отключение автоматической обработки файлов cookie</span><span class="sxs-lookup"><span data-stu-id="50d1d-116">Disabling Automatic Cookie Handling</span></span>

<span data-ttu-id="50d1d-117">Чтобы отключить обработку файлов cookie, клиентское приложение WinHTTP вызывает функцию [**винхттпсетоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) с параметром *элемент dwoption* , установленным в \_ параметре WinHTTP \_ disable \_ , а параметр *лпбуффер* , установленный в WinHTTP, \_ отключит \_ файлы cookie.</span><span class="sxs-lookup"><span data-stu-id="50d1d-117">To disable cookie handling, the WinHTTP client application calls the [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) function with the *dwOption* parameter set to WINHTTP\_OPTION\_DISABLE\_FEATURE, and the *lpBuffer* parameter set to WINHTTP\_DISABLE\_COOKIES.</span></span> <span data-ttu-id="50d1d-118">Параметр *хинтернет* может быть либо обработчиком сеанса, либо обработчиком запроса.</span><span class="sxs-lookup"><span data-stu-id="50d1d-118">The *hInternet* parameter can be either a session handle or a request handle.</span></span> <span data-ttu-id="50d1d-119">Если обработка файлов cookie отключена для обработчика запроса, который отправил предыдущий запрос, клиент должен вручную удалить существующие заголовки Cookie запроса с помощью функции [**винхттпаддрекуессеадерс**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) перед отправкой следующего запроса.</span><span class="sxs-lookup"><span data-stu-id="50d1d-119">When cookie handling is disabled on a request handle that has sent a previous request, the client should manually remove existing request cookie headers with the [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) function before sending the next request.</span></span> <span data-ttu-id="50d1d-120">Дополнительные сведения см. в разделе [удаление заголовков файлов cookie](#removing-cookie-headers).</span><span class="sxs-lookup"><span data-stu-id="50d1d-120">For more information, see [Removing Cookie Headers](#removing-cookie-headers).</span></span>

<span data-ttu-id="50d1d-121">**Примечание**  .  Клиентское приложение должно установить все файлы cookie в сеансе после отключения автоматического режима.</span><span class="sxs-lookup"><span data-stu-id="50d1d-121">**Note**  The client application must set all cookies on the session after automatic mode has been disabled.</span></span>

## <a name="manually-specifying-all-cookies"></a><span data-ttu-id="50d1d-122">Указание всех файлов cookie вручную</span><span class="sxs-lookup"><span data-stu-id="50d1d-122">Manually Specifying All Cookies</span></span>

<span data-ttu-id="50d1d-123">Если автоматическая обработка файлов cookie отключена, клиентское приложение WinHTTP может вручную указать все файлы cookie.</span><span class="sxs-lookup"><span data-stu-id="50d1d-123">When automatic cookie handling is disabled, the WinHTTP client application has the option to manually specify all cookies.</span></span> <span data-ttu-id="50d1d-124">Чтобы вручную задать файл cookie, приложение вызывает [**винхттпаддрекуессеадерс**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) , указав заголовок cookie в параметре *пвсзеадерс* .</span><span class="sxs-lookup"><span data-stu-id="50d1d-124">To manually set the cookie, the application calls [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) specifying the cookie header in the *pwszHeaders* parameter.</span></span> <span data-ttu-id="50d1d-125">Клиентское приложение должно очистить все заголовки файлов cookie перед повторной отправкой запроса.</span><span class="sxs-lookup"><span data-stu-id="50d1d-125">The client application should clear all cookie headers before resending the request.</span></span>

<span data-ttu-id="50d1d-126">Клиентское приложение также должно изменить заголовок cookie при перенаправлении запроса.</span><span class="sxs-lookup"><span data-stu-id="50d1d-126">The client application should also change the cookie header when the request has been redirected.</span></span> <span data-ttu-id="50d1d-127">Чтобы изменить файл cookie в перенаправленных запросах, клиент указывает функцию обратного вызова с [**WinHttpSetStatusCallback**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetstatuscallback) , которая реагирует на случай обратного вызова перенаправления.</span><span class="sxs-lookup"><span data-stu-id="50d1d-127">To change the cookie on redirected requests, the client specifies a callback function with [**WinHttpSetStatusCallback**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetstatuscallback) that responds to the redirect callback case.</span></span> <span data-ttu-id="50d1d-128">Обработчик обратного вызова должен очистить файл cookie, ранее отправленный по запросу, вызвав [**винхттпаддрекуессеадерс**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders).</span><span class="sxs-lookup"><span data-stu-id="50d1d-128">The callback handler should clear the cookie previously sent on the request by calling [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders).</span></span> <span data-ttu-id="50d1d-129">Дополнительные сведения об удалении заголовков файлов cookie см. в разделе [удаление заголовков файлов cookie](#removing-cookie-headers).</span><span class="sxs-lookup"><span data-stu-id="50d1d-129">For more information about removing cookie headers, see [Removing Cookie Headers](#removing-cookie-headers).</span></span>

## <a name="manual-and-automatic-cookie-handling"></a><span data-ttu-id="50d1d-130">Ручная и автоматическая обработка файлов cookie</span><span class="sxs-lookup"><span data-stu-id="50d1d-130">Manual and Automatic Cookie Handling</span></span>

<span data-ttu-id="50d1d-131">Клиентские приложения WinHTTP могут сочетать механизм автоматической обработки файлов cookie WinHTTP с ручной обработкой файлов cookie.</span><span class="sxs-lookup"><span data-stu-id="50d1d-131">WinHTTP client applications can combine the WinHTTP automatic cookie handling mechanism with manual cookie handling.</span></span> <span data-ttu-id="50d1d-132">Приложение добавляет пользовательские файлы cookie в заголовок автоматически создаваемого файла cookie перед отправкой запроса функцией [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest) .</span><span class="sxs-lookup"><span data-stu-id="50d1d-132">The application adds custom cookies to the automatically generated cookie header before sending the request with the [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest) function.</span></span> <span data-ttu-id="50d1d-133">Пользовательский файл cookie должен быть первым заголовком файла cookie в запросе API WinHTTP для правильного кэширования файла cookie.</span><span class="sxs-lookup"><span data-stu-id="50d1d-133">The custom cookie should be the first cookie header in the request for the WinHTTP API to properly cache the cookie.</span></span> <span data-ttu-id="50d1d-134">Клиентское приложение также должно удалять файлы cookie, отправленные в предыдущих запросах, перед повторной отправкой запроса на тот же самый обработчик запроса.</span><span class="sxs-lookup"><span data-stu-id="50d1d-134">The client application should also remove cookies sent on previous requests before resending a request on the same request handle.</span></span> <span data-ttu-id="50d1d-135">Дополнительные сведения см. в разделе Удаление заголовков файлов cookie.</span><span class="sxs-lookup"><span data-stu-id="50d1d-135">For more information, see Removing Cookie Headers.</span></span>

<span data-ttu-id="50d1d-136">Файлы cookie, добавленные в запрос перед вызовом [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest) , включаются во все запросы WinHTTP, отправленные от имени следующих вызовов **WinHttpSendRequest** и [**WinHttpReceiveResponse**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreceiveresponse) .</span><span class="sxs-lookup"><span data-stu-id="50d1d-136">Cookies added to a request before the call to [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest) are included in all WinHTTP requests sent on behalf of the next **WinHttpSendRequest** and [**WinHttpReceiveResponse**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreceiveresponse) calls.</span></span> <span data-ttu-id="50d1d-137">При перенаправлении запроса клиентскому приложению может потребоваться очистить заголовок cookie.</span><span class="sxs-lookup"><span data-stu-id="50d1d-137">The client application may need to clear the cookie header when the request has been redirected.</span></span> <span data-ttu-id="50d1d-138">Чтобы очистить файл cookie в перенаправленных запросах, клиент указывает функцию обратного вызова с [**WinHttpSetStatusCallback**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetstatuscallback) , которая реагирует на случай обратного вызова перенаправления.</span><span class="sxs-lookup"><span data-stu-id="50d1d-138">To clear the cookie on redirected requests, the client specifies a callback function with [**WinHttpSetStatusCallback**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetstatuscallback) that responds to the redirect callback case.</span></span> <span data-ttu-id="50d1d-139">Обработчик обратного вызова должен очистить файл cookie, который ранее отправлялся по запросу, вызвав [**винхттпаддрекуессеадерс**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders).</span><span class="sxs-lookup"><span data-stu-id="50d1d-139">The callback handler should clear the cookie that was previously sent on the request by calling [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders).</span></span> <span data-ttu-id="50d1d-140">Функция обратного вызова не может задавать новые пользовательские файлы cookie при обратном вызове перенаправления.</span><span class="sxs-lookup"><span data-stu-id="50d1d-140">The callback function may not set new custom cookies on the redirect callback.</span></span> <span data-ttu-id="50d1d-141">Клиент должен дождаться завершения **WinHttpReceiveResponse** , прежде чем добавлять новые файлы cookie для следующего вызова **WinHttpSendRequest** .</span><span class="sxs-lookup"><span data-stu-id="50d1d-141">The client must wait for **WinHttpReceiveResponse** to complete before adding new cookies for the next **WinHttpSendRequest** call.</span></span>

## <a name="removing-cookie-headers"></a><span data-ttu-id="50d1d-142">Удаление заголовков файлов cookie</span><span class="sxs-lookup"><span data-stu-id="50d1d-142">Removing Cookie Headers</span></span>

<span data-ttu-id="50d1d-143">Клиентское приложение WinHTTP может потребовать очистки существующего файла Cookie запроса перед повторной отправкой запроса, чтобы предотвратить повторную отправку файлов cookie, отправленных в предыдущих запросах. Дополнительные сведения см. в следующем примечании.</span><span class="sxs-lookup"><span data-stu-id="50d1d-143">The WinHTTP client application may need to clear the existing request cookie before resending a request to prevent cookies that were sent on previous requests from being sent again on the current request; for more information, see the following Note.</span></span> <span data-ttu-id="50d1d-144">Также имейте в виду, что перед отправкой первого запроса в обработчик запроса не нужно очищать файлы cookie.</span><span class="sxs-lookup"><span data-stu-id="50d1d-144">Also be aware that Cookies do not have to be cleared before the first request is sent on the request handle.</span></span> <span data-ttu-id="50d1d-145">Клиент может очистить существующие файлы cookie, вызвав [**винхттпаддрекуессеадерс**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) с пустым заголовком cookie в параметре *пвсзеадерс* и \_ установив флаг замены WinHTTP аддрек \_ \_ в параметре *двмодифиер* .</span><span class="sxs-lookup"><span data-stu-id="50d1d-145">The client can clear existing cookies by calling [**WinHttpAddRequestHeaders**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) with an empty cookie header in the *pwszHeaders* parameter and the WINHTTP\_ADDREQ\_FLAG\_REPLACE flag set in the *dwModifier* parameter.</span></span> <span data-ttu-id="50d1d-146">В следующем примере кода показано, как очистить заголовок файла cookie в запросе.</span><span class="sxs-lookup"><span data-stu-id="50d1d-146">The following code example shows how to clear the cookie header on the request.</span></span>

``` syntax
WinHttpAddRequestHeaders( hRequest, 
                          L"Cookie:", 
                          -1, 
                          WINHTTP_ADDREQ_FLAG_REPLACE);
```

<span data-ttu-id="50d1d-147">API WinHTTP имеет различные поведения обработки файлов cookie для версий операционной системы, предшествующих Windows XP с пакетом обновления 2 (SP2) и Windows Server 2003 с пакетом обновления 1 (SP1).</span><span class="sxs-lookup"><span data-stu-id="50d1d-147">The WinHTTP API has different cookie handling behaviors for versions of the operating system earlier than Windows XP with Service Pack 2 (SP2) and Windows Server 2003 with Service Pack 1 (SP1).</span></span>

<span data-ttu-id="50d1d-148">\* \* Windows XP с пакетом обновления 2 (SP2) и Windows Server 2003 с пакетом обновления 1 (SP1) и выше: \* \*</span><span class="sxs-lookup"><span data-stu-id="50d1d-148">\*\*Windows XP with SP2 and later and Windows Server 2003 with SP1 and later:  \*\*</span></span>

<span data-ttu-id="50d1d-149">API WinHTTP очищает все файлы cookie, отправленные в предыдущих запросах, для обработки запроса.</span><span class="sxs-lookup"><span data-stu-id="50d1d-149">The WinHTTP API clears all cookies sent on previous requests for the request handle.</span></span> <span data-ttu-id="50d1d-150">Клиент может вручную добавить новые заголовки файлов cookie перед каждым вызовом WinHttpSendRequest.</span><span class="sxs-lookup"><span data-stu-id="50d1d-150">The client can manually add new cookie headers before each call to WinHttpSendRequest.</span></span> <span data-ttu-id="50d1d-151">Если функция автоматической обработки файлов cookie API WinHTTP не была отключена, API WinHTTP добавит новый заголовок файла cookie (или добавит новый заголовок файла cookie, если клиентское приложение не добавило его вручную) с файлом cookie с сервера.</span><span class="sxs-lookup"><span data-stu-id="50d1d-151">If the automatic cookie handling functionality of the WinHTTP API has not been disabled, the WinHTTP API will append the new cookie header (or add a new cookie header if the client application did not add one manually) with the cookie from the server.</span></span>

<span data-ttu-id="50d1d-152">\* \* Windows XP с пакетом обновления 2 и Windows Server 2003 с пакетом обновления 1 (SP1): \* \*</span><span class="sxs-lookup"><span data-stu-id="50d1d-152">\*\*Windows XP with SP2 and Windows Server 2003 with SP1:  \*\*</span></span>

<span data-ttu-id="50d1d-153">API WinHTTP не очищает заголовок Cookie запроса после завершения [**WinHttpReceiveResponse**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreceiveresponse) .</span><span class="sxs-lookup"><span data-stu-id="50d1d-153">The WinHTTP API does not clear the request cookie header after [**WinHttpReceiveResponse**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreceiveresponse) completes.</span></span> <span data-ttu-id="50d1d-154">Файлы cookie, отправленные в предыдущих запросах, будут повторно выполняться при последующих вызовах [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest).</span><span class="sxs-lookup"><span data-stu-id="50d1d-154">Cookies sent in previous requests will be resent in subsequent calls to [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest).</span></span> <span data-ttu-id="50d1d-155">Клиентское приложение WinHTTP должно очистить существующие заголовки файлов cookie перед повторной отправкой запроса к обработчику запроса.</span><span class="sxs-lookup"><span data-stu-id="50d1d-155">The WinHTTP client application should clear existing cookies headers before resending a request on the request handle.</span></span>

 

 



