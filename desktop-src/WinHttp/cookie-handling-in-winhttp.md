---
description: Обработка файлов cookie в WinHTTP
ms.assetid: ef0f0847-05f6-4477-8e48-e0bea66314ab
title: Обработка файлов cookie в WinHTTP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8e3b596225dc3c741ab9ed0139a63e343e7afb3d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105703397"
---
# <a name="cookie-handling-in-winhttp"></a>Обработка файлов cookie в WinHTTP

Данные сеанса HTTP передаются между клиентом и сервером в заголовке файла Cookie запроса или ответа. Сервер отправляет файлы cookie клиенту в заголовке Set-Cookie ответа, а API WinHTTP повторно отправляет файл cookie сервера на сервер в заголовке файла Cookie запроса. Спецификации обработки файлов cookie, описанные в RFC 2109 (механизм управления состоянием HTTP), реализуются по умолчанию в WinHTTP. Последние спецификации обработки файлов cookie, описанные в RFC 2964, не поддерживаются WinHTTP.

WinHTTP получает файл cookie из заголовка Servers Set-Cookie и сохраняет его в кэше отдельно для каждого сеанса. Этот файл cookie повторно отправляется при последующих запросах в том же сеансе WinHTTP, где целевой объект соответствует источнику файла cookie. API WinHTTP повторно создает заголовок файла запроса для каждого участка в запросе.

В списке ниже описаны некоторые параметры, которые клиентские приложения WinHTTP могут использовать для обработки файлов cookie:

-   Автоматическая обработка файлов cookie. WinHTTP автоматически обрабатывает файлы cookie, а клиентское приложение не выполняет обработку пользовательских файлов cookie.
-   Отключить автоматическую обработку файлов cookie. Автоматическая обработка файлов cookie в API WinHTTP отключена, а файлы cookie не отправляются.
-   Вручную указывать все файлы cookie — автоматическая обработка файлов cookie отключена, а клиентское приложение добавляет или удаляет все заголовки файлов cookie для каждого запроса в сеансе.
-   Ручная и автоматическая обработка файлов cookie. объединение автоматической и ручной обработки файлов cookie.

## <a name="disabling-automatic-cookie-handling"></a>Отключение автоматической обработки файлов cookie

Чтобы отключить обработку файлов cookie, клиентское приложение WinHTTP вызывает функцию [**винхттпсетоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) с параметром *элемент dwoption* , установленным в \_ параметре WinHTTP \_ disable \_ , а параметр *лпбуффер* , установленный в WinHTTP, \_ отключит \_ файлы cookie. Параметр *хинтернет* может быть либо обработчиком сеанса, либо обработчиком запроса. Если обработка файлов cookie отключена для обработчика запроса, который отправил предыдущий запрос, клиент должен вручную удалить существующие заголовки Cookie запроса с помощью функции [**винхттпаддрекуессеадерс**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) перед отправкой следующего запроса. Дополнительные сведения см. в разделе [удаление заголовков файлов cookie](#removing-cookie-headers).

**Примечание**  .  Клиентское приложение должно установить все файлы cookie в сеансе после отключения автоматического режима.

## <a name="manually-specifying-all-cookies"></a>Указание всех файлов cookie вручную

Если автоматическая обработка файлов cookie отключена, клиентское приложение WinHTTP может вручную указать все файлы cookie. Чтобы вручную задать файл cookie, приложение вызывает [**винхттпаддрекуессеадерс**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) , указав заголовок cookie в параметре *пвсзеадерс* . Клиентское приложение должно очистить все заголовки файлов cookie перед повторной отправкой запроса.

Клиентское приложение также должно изменить заголовок cookie при перенаправлении запроса. Чтобы изменить файл cookie в перенаправленных запросах, клиент указывает функцию обратного вызова с [**WinHttpSetStatusCallback**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetstatuscallback) , которая реагирует на случай обратного вызова перенаправления. Обработчик обратного вызова должен очистить файл cookie, ранее отправленный по запросу, вызвав [**винхттпаддрекуессеадерс**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders). Дополнительные сведения об удалении заголовков файлов cookie см. в разделе [удаление заголовков файлов cookie](#removing-cookie-headers).

## <a name="manual-and-automatic-cookie-handling"></a>Ручная и автоматическая обработка файлов cookie

Клиентские приложения WinHTTP могут сочетать механизм автоматической обработки файлов cookie WinHTTP с ручной обработкой файлов cookie. Приложение добавляет пользовательские файлы cookie в заголовок автоматически создаваемого файла cookie перед отправкой запроса функцией [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest) . Пользовательский файл cookie должен быть первым заголовком файла cookie в запросе API WinHTTP для правильного кэширования файла cookie. Клиентское приложение также должно удалять файлы cookie, отправленные в предыдущих запросах, перед повторной отправкой запроса на тот же самый обработчик запроса. Дополнительные сведения см. в разделе Удаление заголовков файлов cookie.

Файлы cookie, добавленные в запрос перед вызовом [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest) , включаются во все запросы WinHTTP, отправленные от имени следующих вызовов **WinHttpSendRequest** и [**WinHttpReceiveResponse**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreceiveresponse) . При перенаправлении запроса клиентскому приложению может потребоваться очистить заголовок cookie. Чтобы очистить файл cookie в перенаправленных запросах, клиент указывает функцию обратного вызова с [**WinHttpSetStatusCallback**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetstatuscallback) , которая реагирует на случай обратного вызова перенаправления. Обработчик обратного вызова должен очистить файл cookie, который ранее отправлялся по запросу, вызвав [**винхттпаддрекуессеадерс**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders). Функция обратного вызова не может задавать новые пользовательские файлы cookie при обратном вызове перенаправления. Клиент должен дождаться завершения **WinHttpReceiveResponse** , прежде чем добавлять новые файлы cookie для следующего вызова **WinHttpSendRequest** .

## <a name="removing-cookie-headers"></a>Удаление заголовков файлов cookie

Клиентское приложение WinHTTP может потребовать очистки существующего файла Cookie запроса перед повторной отправкой запроса, чтобы предотвратить повторную отправку файлов cookie, отправленных в предыдущих запросах. Дополнительные сведения см. в следующем примечании. Также имейте в виду, что перед отправкой первого запроса в обработчик запроса не нужно очищать файлы cookie. Клиент может очистить существующие файлы cookie, вызвав [**винхттпаддрекуессеадерс**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpaddrequestheaders) с пустым заголовком cookie в параметре *пвсзеадерс* и \_ установив флаг замены WinHTTP аддрек \_ \_ в параметре *двмодифиер* . В следующем примере кода показано, как очистить заголовок файла cookie в запросе.

``` syntax
WinHttpAddRequestHeaders( hRequest, 
                          L"Cookie:", 
                          -1, 
                          WINHTTP_ADDREQ_FLAG_REPLACE);
```

API WinHTTP имеет различные поведения обработки файлов cookie для версий операционной системы, предшествующих Windows XP с пакетом обновления 2 (SP2) и Windows Server 2003 с пакетом обновления 1 (SP1).

* * Windows XP с пакетом обновления 2 (SP2) и Windows Server 2003 с пакетом обновления 1 (SP1) и выше: * *

API WinHTTP очищает все файлы cookie, отправленные в предыдущих запросах, для обработки запроса. Клиент может вручную добавить новые заголовки файлов cookie перед каждым вызовом WinHttpSendRequest. Если функция автоматической обработки файлов cookie API WinHTTP не была отключена, API WinHTTP добавит новый заголовок файла cookie (или добавит новый заголовок файла cookie, если клиентское приложение не добавило его вручную) с файлом cookie с сервера.

* * Windows XP с пакетом обновления 2 и Windows Server 2003 с пакетом обновления 1 (SP1): * *

API WinHTTP не очищает заголовок Cookie запроса после завершения [**WinHttpReceiveResponse**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpreceiveresponse) . Файлы cookie, отправленные в предыдущих запросах, будут повторно выполняться при последующих вызовах [**WinHttpSendRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsendrequest). Клиентское приложение WinHTTP должно очистить существующие заголовки файлов cookie перед повторной отправкой запроса к обработчику запроса.

 

 



