---
description: Приложениям, которые используют для порта из WinINet в WinHTTP, может потребоваться использовать те же параметры автопрокси-сервера, которые они могут получить в папке WinINet или Internet Explorer (IE).
ms.assetid: c3e867d8-9d67-4e6a-8551-1fa846e089ed
title: Настройка конфигураций прокси-сервера WinINet в WinHTTP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91306f6591e0aab0f96fa010ee2a83d3f32c8fb4
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103999558"
---
# <a name="setting-wininet-proxy-configurations-in-winhttp"></a><span data-ttu-id="0a1a6-103">Настройка конфигураций прокси-сервера WinINet в WinHTTP</span><span class="sxs-lookup"><span data-stu-id="0a1a6-103">Setting WinINet Proxy Configurations in WinHTTP</span></span>

## <a name="setting-automatic-proxy-on-winhttp-51"></a><span data-ttu-id="0a1a6-104">Настройка автоматического прокси-сервера для WinHTTP 5,1</span><span class="sxs-lookup"><span data-stu-id="0a1a6-104">Setting Automatic Proxy on WinHTTP 5.1</span></span>

<span data-ttu-id="0a1a6-105">Приложениям, которые используют для порта из WinINet в WinHTTP, может потребоваться использовать те же параметры автопрокси-сервера, которые они могут получить в папке WinINet или Internet Explorer (IE).</span><span class="sxs-lookup"><span data-stu-id="0a1a6-105">Applications that port from WinINet to WinHTTP may need to use the same autoproxy settings that they can retrieve under WinINet or Internet Explorer (IE).</span></span> <span data-ttu-id="0a1a6-106">API-интерфейс WinHTTP версии 5,1 может извлекать и использовать эти параметры прокси.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-106">The WinHTTP version 5.1 API can retrieve and use these proxy settings.</span></span> <span data-ttu-id="0a1a6-107">В общем случае служба WinHTTP указывает серверы обхода прокси-сервера и прокси-серверов для каждого сеанса при создании сеанса.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-107">In general, WinHTTP specifies the proxy and proxy bypass servers on a per-session basis when the session is created.</span></span> <span data-ttu-id="0a1a6-108">Эти параметры могут быть переопределены отдельно для каждого запроса.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-108">These settings can be overridden on a per-request basis.</span></span>

<span data-ttu-id="0a1a6-109">Чтобы использовать ту же конфигурацию прокси-сервера, что и WinINet или IE, клиент WinHTTP должен задать параметры прокси-сервера для этого сеанса.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-109">To use the same proxy configuration as WinINet or IE, the WinHTTP client should set proxy settings for the session.</span></span> <span data-ttu-id="0a1a6-110">Кроме того, если IE или WinINet настроены для использования автоматического обнаружения веб-прокси (WPAD), то клиент WinHTTP, использующий эти параметры, должен задавать параметры прокси-сервера для каждого запроса.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-110">In addition, if IE or WinINet are configured to use Web Proxy Auto-Discovery (WPAD), the WinHTTP client that uses those settings must set proxy settings on a per-request basis.</span></span> <span data-ttu-id="0a1a6-111">В следующих разделах описано, как указать параметры прокси-сервера для сеанса и запроса.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-111">The following sections describe how to specify the proxy settings for a session and a request:</span></span>

-   [<span data-ttu-id="0a1a6-112">Настройка конфигурации прокси-сервера в сеансе</span><span class="sxs-lookup"><span data-stu-id="0a1a6-112">Setting the Proxy Configuration on a Session</span></span>](#setting-the-proxy-configuration-on-a-session)
-   [<span data-ttu-id="0a1a6-113">Настройка конфигурации прокси-сервера для одного запроса</span><span class="sxs-lookup"><span data-stu-id="0a1a6-113">Setting the Proxy Configuration on a Single Request</span></span>](#setting-the-proxy-configuration-on-a-single-request)

## <a name="setting-the-proxy-configuration-on-a-session"></a><span data-ttu-id="0a1a6-114">Настройка конфигурации прокси-сервера в сеансе</span><span class="sxs-lookup"><span data-stu-id="0a1a6-114">Setting the Proxy Configuration on a Session</span></span>

## <a name="the-application-is-running-on-a-user-account"></a><span data-ttu-id="0a1a6-115">Приложение работает под учетной записью пользователя</span><span class="sxs-lookup"><span data-stu-id="0a1a6-115">The Application is Running on a User Account</span></span>

<span data-ttu-id="0a1a6-116">Перед созданием сеанса приложение вызывает [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) для получения параметров прокси IE.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-116">Before a session is created, the application calls [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) to get the IE proxy settings.</span></span> <span data-ttu-id="0a1a6-117">Для получения этих параметров приложение должно выполняться от имени учетной записи пользователя.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-117">The application must be running as a user account to obtain these settings.</span></span> <span data-ttu-id="0a1a6-118">Параметр *ппроксиконфиг* — это указатель на структуру [**\_ \_ \_ \_ \_ конфигурации прокси-сервера для текущего пользователя WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) , которая содержит серверы прокси-сервера (*лпсзпрокси*) и обход прокси-сервера (*лпсзпроксибипасс*).</span><span class="sxs-lookup"><span data-stu-id="0a1a6-118">The *pProxyConfig* parameter is a pointer to a [**WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) structure that contains the proxy name (*lpszProxy*) and proxy bypass (*lpszProxyBypass*) servers.</span></span> <span data-ttu-id="0a1a6-119">Для инициализации сеанса WinHTTP используются значения прокси-сервера и обхода прокси-сервера для **\_ текущего \_ пользователя \_ \_ \_ WinHTTP** .</span><span class="sxs-lookup"><span data-stu-id="0a1a6-119">The proxy name and proxy bypass values of the **WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG** structure are then used to initialize the WinHTTP session.</span></span> <span data-ttu-id="0a1a6-120">Сеанс инициализируется путем вызова [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) с параметрами *пвсзпроксинаме* и *Пвсзпроксибипасс* , полученными из **лпсзпрокси** и **лпсзпроксибипасс** членов структуры **\_ \_ \_ \_ \_ конфигурации прокси-сервера для текущего пользователя WinHTTP** .</span><span class="sxs-lookup"><span data-stu-id="0a1a6-120">The session is initialized by calling [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) with the *pwszProxyName* and *pwszProxyBypass* parameters obtained from the **lpszProxy** and **lpszProxyBypass** members of the **WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG** structure.</span></span>

## <a name="the-application-is-running-as-a-service"></a><span data-ttu-id="0a1a6-121">Приложение работает как служба</span><span class="sxs-lookup"><span data-stu-id="0a1a6-121">The Application is Running as a Service</span></span>

<span data-ttu-id="0a1a6-122">Приложение должно гарантировать, что параметры реестра для отдельного пользователя загружаются в реестр перед вызовом [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span><span class="sxs-lookup"><span data-stu-id="0a1a6-122">The application must ensure that the registry settings for an individual user are loaded into the registry before calling [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span> <span data-ttu-id="0a1a6-123">Если эти параметры не загружены в реестр, **винхттпжетиепроксиконфигфоркуррентусер** не сможет получить параметры прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-123">If these settings are not loaded into the registry, **WinHttpGetIEProxyConfigForCurrentUser** cannot obtain the proxy settings.</span></span> <span data-ttu-id="0a1a6-124">Параметры реестра для отдельного пользователя можно загрузить в реестр, вызвав функцию **LoadUserProfile** .</span><span class="sxs-lookup"><span data-stu-id="0a1a6-124">Registry settings for an individual user can be loaded into the registry by calling the **LoadUserProfile** function.</span></span> <span data-ttu-id="0a1a6-125">Если загрузка параметров реестра пользователя не является возможностью, приложение может вызвать [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) с использованием **\_ \_ \_ \_ прокси-сервера по умолчанию типа доступа WinHTTP** , указанного в параметре *двацесстипе* .</span><span class="sxs-lookup"><span data-stu-id="0a1a6-125">If loading the user's registry settings is not an option, the application can call [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) with the **WINHTTP\_ACCESS\_TYPE\_DEFAULT\_PROXY** specified in the *dwAcessType* parameter.</span></span> <span data-ttu-id="0a1a6-126">Указание прокси-сервера по умолчанию в вызове **WinHttpOpen** указывает API WinHTTP на получение набора конфигурации прокси-сервера с помощью служебной программы [**proxycfg.exe**](proxycfg-exe--a-proxy-configuration-tool.md) WinHTTP.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-126">Specifying the default proxy in the call to **WinHttpOpen** tells the WinHTTP API to retrieve the proxy configuration set by using the WinHTTP [**proxycfg.exe**](proxycfg-exe--a-proxy-configuration-tool.md) utility.</span></span> <span data-ttu-id="0a1a6-127">После загрузки параметров реестра для отдельного пользователя приложение выполняет действия, описанные в разделе [приложение выполняется в учетной записи пользователя](#the-application-is-running-on-a-user-account) , чтобы задать имя прокси-сервера и обход прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-127">After the registry settings for an individual user have been loaded, the application follows the steps outlined under [The application is running on a user account](#the-application-is-running-on-a-user-account) to set the proxy name and proxy bypass servers.</span></span>

## <a name="setting-the-proxy-configuration-on-a-single-request"></a><span data-ttu-id="0a1a6-128">Настройка конфигурации прокси-сервера для одного запроса</span><span class="sxs-lookup"><span data-stu-id="0a1a6-128">Setting the Proxy Configuration on a Single Request</span></span>

<span data-ttu-id="0a1a6-129">Перед созданием сеанса приложение вызывает [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) , чтобы определить, настроены ли WinInet и IE на использование WPAD.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-129">Before the session is created, the application calls [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) to determine if WinINet and IE are configured to use WPAD.</span></span> <span data-ttu-id="0a1a6-130">**Винхттпжетиепроксиконфигфоркуррентусер** возвращает структуру [**\_ \_ \_ \_ \_ конфигурации прокси-сервера для текущего пользователя WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) , которая содержит элемент **фаутодетект** .</span><span class="sxs-lookup"><span data-stu-id="0a1a6-130">**WinHttpGetIEProxyConfigForCurrentUser** returns the [**WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) structure that contains the **fAutoDetect** member.</span></span> <span data-ttu-id="0a1a6-131">Значение **true** для этого элемента указывает, что используется WPAD, а член **лпсзаутоконфигурл** содержит URL-адрес WPAD.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-131">A value of **TRUE** for this member indicates that WPAD is used, and the **lpszAutoConfigUrl** member contains the WPAD URL.</span></span>

## <a name="automatic-proxy-configuration-is-used"></a><span data-ttu-id="0a1a6-132">Используется автоматическая конфигурация прокси-сервера</span><span class="sxs-lookup"><span data-stu-id="0a1a6-132">Automatic Proxy Configuration Is Used</span></span>

<span data-ttu-id="0a1a6-133">Если используется протокол WPAD, приложение вызывает [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) для получения учетной записи-посредника для запроса.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-133">If WPAD is used, the application calls [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) to retrieve the proxy for the request.</span></span> <span data-ttu-id="0a1a6-134">Параметр *лпвсзурл* содержит URL-адрес, на который отправляется запрос, а параметр *паутопроксйоптионс* содержит указатель на структуру ([**\_ \_ Параметры автопрокси WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_autoproxy_options)), который содержит параметры автопрокси.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-134">The *lpwszUrl* parameter contains the URL that the request is being sent to, and the *pAutoProxyOptions* parameter contains a pointer to the structure ([**WINHTTP\_AUTOPROXY\_OPTIONS**](/windows/win32/api/winhttp/ns-winhttp-winhttp_autoproxy_options)) that contains the autoproxy options.</span></span> <span data-ttu-id="0a1a6-135">Приложение инициализирует структуру **\_ \_ параметров автопрокси WinHTTP** с параметрами, возвращенными из структуры [**\_ \_ \_ \_ \_ конфигурации прокси-сервера для текущего пользователя WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) в вызове [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span><span class="sxs-lookup"><span data-stu-id="0a1a6-135">The application initializes the **WINHTTP\_AUTOPROXY\_OPTIONS** structure with the settings returned from the [**WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) structure in the call to [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span> <span data-ttu-id="0a1a6-136">Флаг **\_ \_ \_ URL-адреса конфигурации автопрокси WinHTTP** указывается в ЭЛЕМЕНТЕ **dwFlags** структуры **\_ \_ параметров автопрокси WinHTTP** , а элемент **лпсзаутоконфигурл** содержит URL-адрес автоматической настройки прокси-сервера из структуры **\_ \_ \_ \_ \_ конфигурации прокси-сервера для текущего пользователя WinHTTP** .</span><span class="sxs-lookup"><span data-stu-id="0a1a6-136">The **WINHTTP\_AUTOPROXY\_CONFIG\_URL** flag is specified in the **dwFlags** member of the **WINHTTP\_AUTOPROXY\_OPTIONS** structure, and the **lpszAutoconfigUrl** member contains the proxy auto-configuration URL from the **WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG** structure.</span></span> <span data-ttu-id="0a1a6-137">Функция **WinHttpGetProxyForUrl** возвращает имя прокси-сервера и список обхода прокси-сервера в члене **лпсзпрокси** и **лпсзпроксибипасс** в [**структуре \_ \_ сведений о прокси-сервере WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) .</span><span class="sxs-lookup"><span data-stu-id="0a1a6-137">The **WinHttpGetProxyForUrl** function returns the proxy name and the proxy bypass list in the **lpszProxy** and **lpszProxyBypass** members of the [**WINHTTP\_PROXY\_INFO**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) structure.</span></span>

<span data-ttu-id="0a1a6-138">После того как прокси-сервер для запроса получен из [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl), приложение создает запрос с помощью [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest).</span><span class="sxs-lookup"><span data-stu-id="0a1a6-138">After the proxy for the request is obtained from [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl), the application creates the request with [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest).</span></span> <span data-ttu-id="0a1a6-139">Затем вызывается [**винхттпсетоптион**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) для установки прокси-сервера для запроса путем указания маркера запроса в параметре *хинтернет* .</span><span class="sxs-lookup"><span data-stu-id="0a1a6-139">Then [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) is called to set the proxy for the request by specifying the request handle in the *hInternet* parameter.</span></span> <span data-ttu-id="0a1a6-140">Параметр *элемент dwoption* в вызове **винхттпсетоптион** должен иметь значение **WinHTTP \_ \_ proxy** , а параметр *лпбуффер* — указатель на структуру [**\_ \_ сведений о прокси-сервере WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) , которая содержит прокси-сервер и обход прокси-сервера, используемые для запроса.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-140">The *dwOption* parameter in the call to **WinHttpSetOption** should be set to **WINHTTP\_OPTION\_PROXY** and the *lpBuffer* parameter is a pointer to a [**WINHTTP\_PROXY\_INFO**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) structure that contains the proxy and proxy bypass to be used for the request.</span></span>

## <a name="automatic-proxy-configuration-is-not-used"></a><span data-ttu-id="0a1a6-141">Автоматическая настройка прокси-сервера не используется</span><span class="sxs-lookup"><span data-stu-id="0a1a6-141">Automatic Proxy Configuration Is Not Used</span></span>

<span data-ttu-id="0a1a6-142">Если вызов [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) указывает, что автопрокси не используется, приложение может просто создать запрос с помощью [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest).</span><span class="sxs-lookup"><span data-stu-id="0a1a6-142">If the call to [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) indicates that autoproxy is not used, the application can simply create the request with [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest).</span></span> <span data-ttu-id="0a1a6-143">Конфигурация прокси-сервера одинакова для всего сеанса, и изменения для каждого запроса не требуются.</span><span class="sxs-lookup"><span data-stu-id="0a1a6-143">The proxy configuration is the same for the entire session, and per-request changes are not needed.</span></span>

 

 



