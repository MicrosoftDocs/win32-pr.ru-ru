---
title: Пользовательские наборы шрифтов
description: В этом разделе описываются различные способы использования пользовательских шрифтов в приложении.
ms.assetid: 50842838-d150-df9a-f1b7-67ce5ea2bc80
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a79f1ccfcb1dadd355c5f582417aacb5041ecf8b
ms.sourcegitcommit: 89f99926f946dc6c5ea600fb7c41f6b19ceac516
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/21/2020
ms.locfileid: "104414109"
---
# <a name="custom-font-sets"></a><span data-ttu-id="1a4a8-103">Пользовательские наборы шрифтов</span><span class="sxs-lookup"><span data-stu-id="1a4a8-103">Custom Font Sets</span></span>

<span data-ttu-id="1a4a8-104">В этом разделе описываются различные способы использования пользовательских шрифтов в приложении.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-104">This topic describes various ways in which you can use custom fonts in your app.</span></span>

-   [<span data-ttu-id="1a4a8-105">Общие </span><span class="sxs-lookup"><span data-stu-id="1a4a8-105">Introduction </span></span>](#introduction)
-   [<span data-ttu-id="1a4a8-106">Сводка API-интерфейсов</span><span class="sxs-lookup"><span data-stu-id="1a4a8-106">Summary of APIs</span></span>](#summary-of-apis)
-   [<span data-ttu-id="1a4a8-107">Основные понятия</span><span class="sxs-lookup"><span data-stu-id="1a4a8-107">Key concepts</span></span>](#key-concepts)
-   [<span data-ttu-id="1a4a8-108">Шрифты и форматы файлов шрифтов</span><span class="sxs-lookup"><span data-stu-id="1a4a8-108">Fonts and font file formats</span></span>](#fonts-and-font-file-formats)
-   [<span data-ttu-id="1a4a8-109">Наборы шрифтов и коллекции шрифтов</span><span class="sxs-lookup"><span data-stu-id="1a4a8-109">Font sets and font collections</span></span>](#font-sets-and-font-collections)
-   [<span data-ttu-id="1a4a8-110">Распространенные сценарии</span><span class="sxs-lookup"><span data-stu-id="1a4a8-110">Common scenarios</span></span>](#common-scenarios)
    -   [<span data-ttu-id="1a4a8-111">Создание набора шрифтов с помощью произвольных шрифтов в локальной файловой системе</span><span class="sxs-lookup"><span data-stu-id="1a4a8-111">Creating a font set using arbitrary fonts in the local file system</span></span>](#creating-a-font-set-using-arbitrary-fonts-in-the-local-file-system)
    -   [<span data-ttu-id="1a4a8-112">Создание набора шрифтов с помощью известных шрифтов в локальной файловой системе</span><span class="sxs-lookup"><span data-stu-id="1a4a8-112">Creating a font set using known fonts in the local file system</span></span>](#creating-a-font-set-using-known-fonts-in-the-local-file-system)
    -   [<span data-ttu-id="1a4a8-113">Создание пользовательского набора шрифтов с помощью известных удаленных шрифтов в Интернете</span><span class="sxs-lookup"><span data-stu-id="1a4a8-113">Creating a custom font set using known, remote fonts on the Web</span></span>](#creating-a-custom-font-set-using-known-remote-fonts-on-the-web)
    -   [<span data-ttu-id="1a4a8-114">Создание пользовательского набора шрифтов с помощью данных шрифтов, загруженных в память</span><span class="sxs-lookup"><span data-stu-id="1a4a8-114">Creating a custom font set using font data loaded into memory</span></span>](#creating-a-custom-font-set-using-font-data-loaded-into-memory)
-   [<span data-ttu-id="1a4a8-115">Расширенные сценарии</span><span class="sxs-lookup"><span data-stu-id="1a4a8-115">Advanced scenarios</span></span>](#advanced-scenarios)
    -   [<span data-ttu-id="1a4a8-116">Объединение наборов шрифтов</span><span class="sxs-lookup"><span data-stu-id="1a4a8-116">Combining font sets</span></span>](#combining-font-sets)
    -   [<span data-ttu-id="1a4a8-117">Использование локальных данных шрифта WOFF или WOFF2 </span><span class="sxs-lookup"><span data-stu-id="1a4a8-117">Using local WOFF or WOFF2 font data </span></span>](#using-local-woff-or-woff2-font-data)
    -   [<span data-ttu-id="1a4a8-118">Использование удаленных механизмов шрифтов DirectWrite с пользовательской реализацией низкого уровня сети </span><span class="sxs-lookup"><span data-stu-id="1a4a8-118">Using DirectWrite remote font mechanisms with custom low-level network implementation </span></span>](#using-directwrite-remote-font-mechanisms-with-custom-low-level-network-implementation)
    -   [<span data-ttu-id="1a4a8-119">Поддержка сценариев в более ранних версиях Windows </span><span class="sxs-lookup"><span data-stu-id="1a4a8-119">Supporting scenarios on earlier Windows versions </span></span>](#supporting-scenarios-on-earlier-windows-versions)

## <a name="introduction"></a><span data-ttu-id="1a4a8-120">Введение</span><span class="sxs-lookup"><span data-stu-id="1a4a8-120">Introduction</span></span>

<span data-ttu-id="1a4a8-121">В большинстве случаев приложения используют шрифты, установленные локально в системе.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-121">Most of the time, apps use the fonts that are installed locally on the system.</span></span> <span data-ttu-id="1a4a8-122">DirectWrite предоставляет доступ к этим шрифтам с помощью методов [**IDWriteFactory3:: жетсистемфонтсет**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory3-getsystemfontset) или [**Идвритефактори:: жетсистемфонтколлектион**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-getsystemfontcollection) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-122">DirectWrite provides access to these fonts using the [**IDWriteFactory3::GetSystemFontSet**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory3-getsystemfontset) or [**IDWriteFactory::GetSystemFontCollection**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-getsystemfontcollection) methods.</span></span> <span data-ttu-id="1a4a8-123">В некоторых случаях приложения также могут использовать шрифты, включенные в состав Windows 10, но которые в настоящее время не установлены в текущей системе.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-123">In some cases, apps may also want to use fonts that are included as part of Windows 10 but that are not currently installed on the current system.</span></span> <span data-ttu-id="1a4a8-124">Доступ к таким шрифтам можно получить из службы шрифтов Windows с помощью метода **жетсистемфонтсет** или путем вызова [**IDWriteFactory3:: жетсистемфонтколлектион**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory3-getsystemfontcollection) с инклудедовнлоадаблефонтс значением true.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-124">Such fonts can be accessed from the Windows font service by using the **GetSystemFontSet** method, or by calling [**IDWriteFactory3::GetSystemFontCollection**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory3-getsystemfontcollection) with includeDownloadableFonts set to TRUE.</span></span> 

<span data-ttu-id="1a4a8-125">Однако в некоторых сценариях приложений приложениям необходимо использовать шрифты, которые не установлены в системе и не предоставляются службой шрифтов Windows.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-125">In some application scenarios, however, apps need to use fonts that are not installed in the system and are not provided by the Windows Font Service.</span></span> <span data-ttu-id="1a4a8-126">Ниже приведены примеры таких сценариев.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-126">The following are examples of such scenarios:</span></span>

-   <span data-ttu-id="1a4a8-127">Шрифты внедряются в виде ресурсов в двоичном файле приложения.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-127">Fonts are embedded as resources within an app binary.</span></span>
-   <span data-ttu-id="1a4a8-128">Файлы шрифтов упаковываются в пакет приложения и хранятся на диске в папке установки приложения.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-128">Font files are bundled within an app package and stored on disk under the app’s installation folder.</span></span>
-   <span data-ttu-id="1a4a8-129">Приложение — это средство разработки шрифтов, которое должно загружать файлы шрифтов, заданные пользователем.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-129">The app is a font-development tool that needs to load user-specified font files.</span></span> 
-   <span data-ttu-id="1a4a8-130">Шрифты внедряются в файлы документов, которые можно просматривать или изменять в приложении.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-130">Fonts are embedded in document files that can be viewed or edited in the app.</span></span> 
-   <span data-ttu-id="1a4a8-131">Приложение использует шрифты, полученные из общедоступной службы веб-шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-131">The app uses fonts obtained from a public Web font service.</span></span> 
-   <span data-ttu-id="1a4a8-132">Приложение использует потоковую передачу данных с помощью протокола частной сети.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-132">The app uses font data streamed via a private network protocol.</span></span> 

<span data-ttu-id="1a4a8-133">DirectWrite предоставляет интерфейсы API для работы с пользовательскими шрифтами в этих и других похожих сценариях.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-133">DirectWrite provides APIs for working with custom fonts in these and other similar scenarios.</span></span> <span data-ttu-id="1a4a8-134">Данные пользовательского шрифта могут поступать из файлов в локальной файловой системе; из удаленных облачных источников, доступ к которым осуществлялся по протоколу HTTP; или из произвольных источников после загрузки в буфер памяти.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-134">The custom font data might come from files in the local file system; from remote, cloud-based sources accessed using HTTP; or from arbitrary sources after having been loaded into a memory buffer.</span></span> 

> [!Note]  
> <span data-ttu-id="1a4a8-135">Хотя DirectWrite предоставляет интерфейсы API для работы с пользовательскими шрифтами с момента выпуска Windows 7, в Windows 10 были добавлены более новые API-интерфейсы и опять в Windows 10 Creators Update (Предварительная версия сборки 15021 или более поздней версии), которые упрощают реализацию нескольких упомянутых сценариев.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-135">While DirectWrite has provided APIs for working with custom fonts since Windows 7, newer APIs were added in Windows 10 and again in the Windows 10 Creators Update (preview build 15021 or later) that make it easier to implement several of the scenarios mentioned.</span></span> <span data-ttu-id="1a4a8-136">В этом разделе основное внимание уделяется интерфейсам API, доступным в Windows 10.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-136">This topic focuses on APIs available in Window 10.</span></span> <span data-ttu-id="1a4a8-137">Для приложений, которые должны работать в более ранних версиях Windows, см. раздел [пользовательские коллекции шрифтов (windows 7/8)](custom-font-collections.md).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-137">For applications that need to work on earlier Windows versions, see [Custom Font Collections (Windows 7/8)](custom-font-collections.md).</span></span> 

 

## <a name="summary-of-apis"></a><span data-ttu-id="1a4a8-138">Сводка API-интерфейсов</span><span class="sxs-lookup"><span data-stu-id="1a4a8-138">Summary of APIs</span></span>

<span data-ttu-id="1a4a8-139">Эта статья посвящена функциональным возможностям, предоставляемым следующими интерфейсами API:</span><span class="sxs-lookup"><span data-stu-id="1a4a8-139">This topic focuses on functionality provided by the following APIs:</span></span> 

-   <span data-ttu-id="1a4a8-140">Интерфейс [**идвритефонтсет**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontset)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-140">[**IDWriteFontSet**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontset) interface</span></span>
-   <span data-ttu-id="1a4a8-141">Интерфейс [**идвритефонтсетбуилдер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-141">[**IDWriteFontSetBuilder**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder) interface</span></span>
-   <span data-ttu-id="1a4a8-142">Интерфейс [**IDWriteFontSetBuilder1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder1)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-142">[**IDWriteFontSetBuilder1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder1) interface</span></span> 
-   <span data-ttu-id="1a4a8-143">Интерфейс [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-143">[**IDWriteFontFaceReference**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference) interface</span></span>
-   <span data-ttu-id="1a4a8-144">Интерфейс [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-144">[**IDWriteFontFile**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) interface</span></span>
-   <span data-ttu-id="1a4a8-145">Метод [**идвритефактори:: креатефонтфилереференце**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createfontfilereference)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-145">[**IDWriteFactory::CreateFontFileReference**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createfontfilereference) method</span></span> 
-   <span data-ttu-id="1a4a8-146">Метод [**идвритефактори:: креатекустомфонтфилереференце**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createcustomfontfilereference)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-146">[**IDWriteFactory::CreateCustomFontFileReference**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createcustomfontfilereference) method</span></span> 
-   <span data-ttu-id="1a4a8-147">Методы [**IDWriteFactory3:: креатефонтфацереференце**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontresource-createfontfacereference)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-147">[**IDWriteFactory3::CreateFontFaceReference**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontresource-createfontfacereference) methods</span></span> 
-   <span data-ttu-id="1a4a8-148">[**Дврите \_ Структура \_ свойства Font**](/windows/win32/api/dwrite_3/ns-dwrite_3-dwrite_font_property)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-148">[**DWRITE\_FONT\_PROPERTY**](/windows/win32/api/dwrite_3/ns-dwrite_3-dwrite_font_property) structure</span></span> 
-   <span data-ttu-id="1a4a8-149">[**Дврите \_ Перечисление \_ \_ идентификаторов свойств шрифтов**](/windows/win32/api/dwrite_3/ne-dwrite_3-dwrite_font_property_id)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-149">[**DWRITE\_FONT\_PROPERTY\_ID**](/windows/win32/api/dwrite_3/ne-dwrite_3-dwrite_font_property_id) enumeration</span></span> 
-   <span data-ttu-id="1a4a8-150">Интерфейс [**идвритефонтфилелоадер**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfileloader)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-150">[**IDWriteFontFileLoader**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfileloader) interface</span></span> 
-   <span data-ttu-id="1a4a8-151">Метод [**идвритефактори:: регистерфонтфилелоадер**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-registerfontfileloader)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-151">[**IDWriteFactory::RegisterFontFileLoader**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-registerfontfileloader) method</span></span> 
-   <span data-ttu-id="1a4a8-152">Метод [**идвритефактори:: унрегистерфонтфилелоадер**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-unregisterfontfileloader)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-152">[**IDWriteFactory::UnregisterFontFileLoader**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-unregisterfontfileloader) method</span></span> 
-   <span data-ttu-id="1a4a8-153">Метод [**IDWriteFactory5:: креатеинмеморифонтфилелоадер**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-createinmemoryfontfileloader)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-153">[**IDWriteFactory5::CreateInMemoryFontFileLoader**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-createinmemoryfontfileloader) method</span></span> 
-   <span data-ttu-id="1a4a8-154">Интерфейс [**идвритеинмеморифонтфилелоадер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteinmemoryfontfileloader)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-154">[**IDWriteInMemoryFontFileLoader**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteinmemoryfontfileloader) interface</span></span> 
-   <span data-ttu-id="1a4a8-155">Метод [**IDWriteFactory5:: креатехттпфонтфилелоадер**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-createhttpfontfileloader)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-155">[**IDWriteFactory5::CreateHttpFontFileLoader**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-createhttpfontfileloader) method</span></span> 
-   <span data-ttu-id="1a4a8-156">Интерфейс [**идвритеремотефонтфилелоадер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfileloader)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-156">[**IDWriteRemoteFontFileLoader**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfileloader) interface</span></span> 
-   <span data-ttu-id="1a4a8-157">Интерфейс [**идвритефонтдовнлоадкуеуе**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadqueue)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-157">[**IDWriteFontDownloadQueue**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadqueue) interface</span></span> 
-   <span data-ttu-id="1a4a8-158">Интерфейс [**идвритефонтдовнлоадлистенер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-158">[**IDWriteFontDownloadListener**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) interface</span></span> 
-   <span data-ttu-id="1a4a8-159">Интерфейс [**идвритефонтфилестреам**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-159">[**IDWriteFontFileStream**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream) interface</span></span> 
-   <span data-ttu-id="1a4a8-160">Интерфейс [**идвритеремотефонтфилестреам**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfilestream)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-160">[**IDWriteRemoteFontFileStream**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfilestream) interface</span></span> 
-   <span data-ttu-id="1a4a8-161">Интерфейс [**идвритеасинкресулт**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteasyncresult)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-161">[**IDWriteAsyncResult**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteasyncresult) interface</span></span> 
-   <span data-ttu-id="1a4a8-162">Метод [**IDWriteFactory5:: анализеконтаинертипе**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-analyzecontainertype)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-162">[**IDWriteFactory5::AnalyzeContainerType**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-analyzecontainertype) method</span></span> 
-   <span data-ttu-id="1a4a8-163">Метод [**IDWriteFactory5:: унпаккфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-unpackfontfile)</span><span class="sxs-lookup"><span data-stu-id="1a4a8-163">[**IDWriteFactory5::UnpackFontFile**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-unpackfontfile) method</span></span> 

 

## <a name="key-concepts"></a><span data-ttu-id="1a4a8-164">Основные понятия</span><span class="sxs-lookup"><span data-stu-id="1a4a8-164">Key concepts</span></span>

<span data-ttu-id="1a4a8-165">Чтобы понять интерфейсы API DirectWrite для работы с пользовательскими шрифтами, полезно понять концептуальную модель, которая опирается на эти API.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-165">To understand the DirectWrite APIs for working with custom fonts, it can be helpful to understand the conceptual model that underlies these APIs.</span></span> <span data-ttu-id="1a4a8-166">Основные понятия будут описаны здесь.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-166">Key concepts will be described here.</span></span> 

<span data-ttu-id="1a4a8-167">Когда DirectWrite выполняет фактический макет текста или отрисовку, ему необходимо получить доступ к реальным данным шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-167">When DirectWrite does actual text layout or rendering, it needs to access actual font data.</span></span> <span data-ttu-id="1a4a8-168">Объект начертания шрифта содержит фактические данные шрифта, которые должны существовать в локальной системе.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-168">A font face object holds actual font data, which must exist in the local system.</span></span> <span data-ttu-id="1a4a8-169">Но для других операций, таких как проверка доступности определенного шрифта или представление выбора шрифта пользователю, все, что требуется, — это ссылка на определенный шрифт, а не фактические данные шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-169">But for other operations, such as checking availability of a particular font, or presenting font choices to a user, all that is needed is a reference to a particular font, not the actual font data itself.</span></span> <span data-ttu-id="1a4a8-170">В DirectWrite объект-указатель начертания шрифта содержит только сведения, необходимые для нахождение и создания экземпляра шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-170">In DirectWrite, a font face reference object holds just the information needed to locate and instantiate a font.</span></span> <span data-ttu-id="1a4a8-171">Поскольку ссылка на начертание шрифта не содержит фактических данных, DirectWrite может работать со ссылками на начертание шрифта, для которых фактические данные находятся в удаленном сетевом расположении, а также когда фактические данные являются локальными.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-171">Because the font face reference doesn’t hold actual data, DirectWrite can deal with font face references for which actual data is in a remote network location as well as when the actual data is local.</span></span>

<span data-ttu-id="1a4a8-172">Набор шрифтов — это набор ссылок на начертание шрифта, а также некоторые базовые информационные свойства, которые можно использовать в ссылке на шрифт или в сравнении с другими шрифтами, например с именем семейства или со значением толщины шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-172">A font set is a set of font face references, along with certain basic, informational properties that can be used in referring to the font or in comparing it to other fonts, such as the family name, or a font-weight value.</span></span> <span data-ttu-id="1a4a8-173">Фактические данные для различных шрифтов могут быть локальными, или же они могут быть удаленными или иметь несколько комбинаций.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-173">The actual data for the various fonts may be local, or it may all be remote, or some mixture.</span></span>

<span data-ttu-id="1a4a8-174">Набор шрифтов можно использовать для получения соответствующего объекта коллекции шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-174">A font set can be used to obtain a corresponding font collection object.</span></span> <span data-ttu-id="1a4a8-175">Дополнительные сведения см. в разделе наборы шрифтов и коллекции шрифтов ниже.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-175">See Font sets and font collections below for more details.</span></span> 

<span data-ttu-id="1a4a8-176">Интерфейс Идвритефонтсет предоставляет методы, позволяющие выполнять запросы для значений свойств, таких как имя семейства или начертание шрифта, или для ссылок на начертание шрифта, которые соответствуют определенным значениям свойств.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-176">The IDWriteFontSet interface provides methods that allow querying for property values such as family name or font-weight, or for font face references that match particular property values.</span></span> <span data-ttu-id="1a4a8-177">После фильтрации до определенного выбора можно получить экземпляр интерфейса [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference) с методами для загрузки (если фактические данные шрифта в настоящее время являются удаленными) для получения соответствующего объекта [**IDWriteFontFace3**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontface3) , который можно использовать для макета и отрисовки.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-177">After filtering down to a particular selection, an instance of the [**IDWriteFontFaceReference**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference) interface can be obtained, with methods for downloading (if the actual font data is currently remote), for obtaining the corresponding [**IDWriteFontFace3**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontface3) object that can be used for layout and rendering.</span></span> 

<span data-ttu-id="1a4a8-178">Интерфейс Идвритефонтфиле полагается на каждое начертание шрифта или ссылку на начертание шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-178">The IDWriteFontFile interface underlies each font face or font face reference.</span></span> <span data-ttu-id="1a4a8-179">Он представляет расположение файла шрифта и содержит два компонента: загрузчик файла шрифта и ключ файла шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-179">This represents the location of a font file, and has two components: a font file loader, and a font file key.</span></span> <span data-ttu-id="1a4a8-180">Загрузчик файлов шрифтов ([**идвритефонтфилелоадер**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfileloader)) используется для открытия файла при необходимости и возвращает поток с данными ([**идвритефонтфилестреам**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream)).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-180">The font file loader ([**IDWriteFontFileLoader**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfileloader)) is used to open a file if needed, and returns a stream with the data ([**IDWriteFontFileStream**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream)).</span></span> <span data-ttu-id="1a4a8-181">В зависимости от загрузчика данные могут находиться в локальном пути к файлу, удаленном URL-адресе или в буфере памяти.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-181">Depending on the loader, the data may be located at a local file path, a remote URL, or in a memory buffer.</span></span> <span data-ttu-id="1a4a8-182">Ключ — это значение, определяемое загрузчиком, которое уникально определяет файл в контексте загрузчика, позволяя загрузчику искать данные и создавать для них поток.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-182">The key is a loader-defined value that uniquely identifies the file within the loader context, allowing the loader to locate the data and create a stream for it.</span></span> 

<span data-ttu-id="1a4a8-183">Пользовательские шрифты можно легко добавить в пользовательский набор шрифтов, который, в свою очередь, можно использовать для фильтрации или организации сведений о шрифтах в таких целях, как создание пользовательского интерфейса средства выбора шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-183">Custom fonts can easily be added to a custom font set, which in turn can be used for filtering or organizing font information for purposes such as creating a font-picker user interface.</span></span> <span data-ttu-id="1a4a8-184">Набор шрифтов также можно использовать для создания коллекции шрифтов для использования в интерфейсах API более высокого уровня, таких как [**идвритетекстформат**](/windows/win32/api/dwrite/nn-dwrite-idwritetextformat) и [**идвритетекстлайаут**](/windows/win32/api/dwrite/nn-dwrite-idwritetextlayout).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-184">The font set can also be used to create a font collection for use in higher-level APIs like [**IDWriteTextFormat**](/windows/win32/api/dwrite/nn-dwrite-idwritetextformat) and [**IDWriteTextLayout**](/windows/win32/api/dwrite/nn-dwrite-idwritetextlayout).</span></span> <span data-ttu-id="1a4a8-185">Интерфейс [**идвритефонтсетбуилдер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder) можно использовать для создания пользовательского набора шрифтов, включающего несколько пользовательских шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-185">The [**IDWriteFontSetBuilder**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder) interface can be used to create a custom font set that includes several custom fonts.</span></span> <span data-ttu-id="1a4a8-186">Его также можно использовать для создания пользовательского набора шрифтов, который смешивает пользовательские шрифты и шрифты, предоставленные системой. или, который смешивает шрифты с различными источниками для фактических данных — локальное хранилище, удаленные URL-адреса и память.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-186">It can also be used to create a custom font set that mixes custom fonts and system-provided fonts; or that mixes fonts with different sources for the actual data — local storage, remote URLs, and memory.</span></span> 

<span data-ttu-id="1a4a8-187">Как уже упоминалось, ссылка на начертание шрифта может ссылаться на данные шрифтов в удаленном источнике, но данные должны быть локальными, чтобы получить объект начертания шрифта, который можно использовать для макета и отрисовки.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-187">As mentioned, a font face reference may refer to font data at a remote source, but the data must be local in order to obtain a font face object that can be used for layout and rendering.</span></span> <span data-ttu-id="1a4a8-188">Загрузка удаленных данных осуществляется с помощью очереди загрузки шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-188">Downloading of remote data is handled by a font download queue.</span></span> <span data-ttu-id="1a4a8-189">Приложения могут использовать интерфейс [**идвритефонтдовнлоадкуеуе**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadqueue) для постановки в очередь запросов на загрузку удаленных шрифтов для запуска процесса загрузки, а также для регистрации объекта [**идвритефонтдовнлоадлистенер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) , чтобы предпринять действия по завершении процесса загрузки.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-189">Apps can use the [**IDWriteFontDownloadQueue**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadqueue) interface to enqueue requests to download remote fonts to initiate the download process, and to register an [**IDWriteFontDownloadListener**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) object to take action when the download process has completed.</span></span> 

<span data-ttu-id="1a4a8-190">Для большинства интерфейсов, описанных здесь, DirectWrite предоставляет системные реализации.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-190">For most of the interfaces described here, DirectWrite provides system implementations.</span></span> <span data-ttu-id="1a4a8-191">Единственным исключением является интерфейс [**идвритефонтдовнлоадлистенер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) , который реализуется приложением для выполнения действий, связанных с конкретным приложением, когда удаленные шрифты загружаются локально.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-191">The one exception is the [**IDWriteFontDownloadListener**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) interface, which an app implements to take app-specific actions when remote fonts have been downloaded locally.</span></span> <span data-ttu-id="1a4a8-192">Приложения могут быть причиной предоставления собственных пользовательских реализаций для некоторых других интерфейсов, хотя это будет необходимо только в определенных, более сложных сценариях.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-192">Apps may have reason to provide their own custom implementations for certain other interfaces, though that would only be needed in specific, more advanced scenarios.</span></span> <span data-ttu-id="1a4a8-193">Например, приложению потребуется предоставить пользовательскую реализацию интерфейса [**идвритефонтфилелоадер**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfileloader) для управления файлами шрифтов в локальном хранилище, в котором используется формат контейнера WOFF2.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-193">For example, an app would need to provide a custom implementation of the [**IDWriteFontFileLoader**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfileloader) interface to handle font files in local storage that use the WOFF2 container format.</span></span> <span data-ttu-id="1a4a8-194">Дополнительные сведения будут приведены ниже.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-194">Additional details will be provided below.</span></span> 

## <a name="fonts-and-font-file-formats"></a><span data-ttu-id="1a4a8-195">Шрифты и форматы файлов шрифтов</span><span class="sxs-lookup"><span data-stu-id="1a4a8-195">Fonts and font file formats</span></span>

<span data-ttu-id="1a4a8-196">Еще одним ключевым понятием, которое полезно для понимания, является связь между отдельными шрифтами и файлами шрифтов, которые их содержат.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-196">Another key concept that is helpful to understand is the relationship between individual font faces and font files that contain them.</span></span> <span data-ttu-id="1a4a8-197">Знакомство с файлом шрифтов OpenType (. ttf или. ОТФ), содержащим один шрифт.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-197">The idea of an OpenType font file (.ttf or .otf) containing a single font is familiar.</span></span> <span data-ttu-id="1a4a8-198">Но формат шрифта OpenType также позволяет коллекции шрифтов OpenType (. ТТК или. ОТК), которая представляет собой отдельный файл, содержащий несколько шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-198">But the OpenType font format also allows for an OpenType Font Collection (.ttc or .otc), which is a single file that contains multiple fonts.</span></span> <span data-ttu-id="1a4a8-199">Файлы коллекций OpenType часто используются для больших шрифтов, которые тесно связаны и имеют одинаковые значения для некоторых данных шрифтов: комбинируя шрифты в одном файле, можно отменить дублирование общих данных.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-199">OpenType Collection files are often used for large fonts that are closely related and have identical values for certain font data: by combining the fonts in a single file, the common data can be de-duplicated.</span></span> <span data-ttu-id="1a4a8-200">По этой причине начертание шрифта или начертание шрифта должно ссылаться не только на файл шрифта (или на эквивалентный источник данных), но и на тот общий случай, в котором файл может быть файлом коллекции.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-200">For this reason, a font face or font face reference needs to refer not only to a font file (or equivalent data source), but it must also specify a font index within that file, for the general case in which the file may be a Collection file.</span></span> 

<span data-ttu-id="1a4a8-201">Для шрифтов, используемых в Интернете, данные шрифтов часто упаковываются в определенные форматы контейнеров, WOFF или WOFF2, которые обеспечивают сжатие данных шрифтов и некоторый уровень защиты от пиратства и нарушения лицензий на шрифты.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-201">For fonts used on the Web, font data is often packed into certain container formats, WOFF or WOFF2, which provide some compression of the font data and some level of protection against piracy and violation of font licenses.</span></span> <span data-ttu-id="1a4a8-202">Функционально, файл WOFF или WOFF2 эквивалентен шрифту OpenType или файлу коллекции шрифтов, но данные кодируются в другом формате, который требует распаковки, прежде чем их можно будет использовать.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-202">Functionally, a WOFF or WOFF2 file is equivalent to an OpenType font or Font Collection file, but the data is encoded in a different format that requires unpacking before it can be used.</span></span> 

<span data-ttu-id="1a4a8-203">Некоторые API DirectWrite могут работать с отдельными лицами шрифта, а другие API-интерфейсы могут обрабатывать файлы, которые могут содержать файлы коллекций OpenType, содержащие несколько лиц.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-203">Certain DirectWrite APIs may deal with individual font faces, while other APIs can handle files that might include OpenType Collection files that contain multiple faces.</span></span> <span data-ttu-id="1a4a8-204">Аналогично некоторые API-интерфейсы работают только с необработанными данными формата OpenType, в то время как другие интерфейсы API могут обрабатывать Упакованные форматы контейнеров WOFF и WOFF2.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-204">Similarly, certain APIs deal only with raw, OpenType-format data, while other APIs can handle the packed, WOFF and WOFF2 container formats.</span></span> <span data-ttu-id="1a4a8-205">Эти сведения приведены в обсуждении ниже.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-205">These details are provided in the discussion below.</span></span> 

## <a name="font-sets-and-font-collections"></a><span data-ttu-id="1a4a8-206">Наборы шрифтов и коллекции шрифтов</span><span class="sxs-lookup"><span data-stu-id="1a4a8-206">Font sets and font collections</span></span>

<span data-ttu-id="1a4a8-207">Некоторые приложения могут быть реализованы для работы со шрифтами с помощью интерфейса [**идвритефонтколлектион**](/windows/win32/api/dwrite/nn-dwrite-idwritefontcollection) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-207">Some applications may be implemented to work with fonts using the [**IDWriteFontCollection**](/windows/win32/api/dwrite/nn-dwrite-idwritefontcollection) interface.</span></span> <span data-ttu-id="1a4a8-208">Существует прямая корреспонденция между коллекцией шрифтов и набором шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-208">There is a direct correspondence between a font collection and a font set.</span></span> <span data-ttu-id="1a4a8-209">Каждый из них может содержать одни и те же шрифты, но они представляются другой организации.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-209">Each can hold the same fonts, but they present them with a different organization.</span></span> <span data-ttu-id="1a4a8-210">Из любой коллекции шрифтов можно получить соответствующий набор шрифтов и наоборот.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-210">From any font collection, a corresponding font set can be obtained, and vice versa.</span></span>

<span data-ttu-id="1a4a8-211">При работе с несколькими пользовательскими шрифтами проще всего использовать интерфейс построителя наборов шрифтов, чтобы создать пользовательский набор шрифтов, а затем получить коллекцию шрифтов после создания набора шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-211">When working with a number of custom fonts, it is easiest to use a font set builder interface to create a custom font set, and then obtain a font collection after the font set is created.</span></span> <span data-ttu-id="1a4a8-212">Ниже подробно описан процесс создания пользовательского набора шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-212">The process for creating a custom font set will be described in detail below.</span></span> <span data-ttu-id="1a4a8-213">Чтобы получить интерфейс [**IDWriteFontCollection1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontcollection1) из набора шрифтов, используется метод [**IDWriteFactory3:: креатефонтколлектионфромфонтсет**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory3-createfontcollectionfromfontset) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-213">To obtain an [**IDWriteFontCollection1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontcollection1) interface from a font set, the [**IDWriteFactory3::CreateFontCollectionFromFontSet**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory3-createfontcollectionfromfontset) method is used.</span></span>

<span data-ttu-id="1a4a8-214">Если приложение содержит объект коллекции и ему нужно получить соответствующий набор шрифтов, это можно сделать с помощью метода [**IDWriteFontCollection1::-font**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontcollection1-getfontset) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-214">If the app has a collection object and needs to obtain a corresponding font set, this can be done using the [**IDWriteFontCollection1::GetFontSet**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontcollection1-getfontset) method.</span></span> 

## <a name="common-scenarios"></a><span data-ttu-id="1a4a8-215">Распространенные сценарии</span><span class="sxs-lookup"><span data-stu-id="1a4a8-215">Common scenarios</span></span>

<span data-ttu-id="1a4a8-216">В этом разделе описаны некоторые из наиболее распространенных сценариев, включающих пользовательские наборы шрифтов:</span><span class="sxs-lookup"><span data-stu-id="1a4a8-216">This section describes some of the most common scenarios involving custom font sets:</span></span>

-   <span data-ttu-id="1a4a8-217">Создание пользовательского набора шрифтов с помощью произвольных шрифтов в путях в локальной файловой системе.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-217">Creating a custom font set using arbitrary fonts at paths in the local file system.</span></span>
-   <span data-ttu-id="1a4a8-218">Создание пользовательского набора шрифтов с помощью известных шрифтов (возможно, Объединенных с приложением), которые хранятся в локальной файловой системе.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-218">Creating a custom font set using known fonts (perhaps bundled with the app) that are stored in the local file system.</span></span>
-   <span data-ttu-id="1a4a8-219">Создание пользовательского набора шрифтов с помощью известных удаленных шрифтов в Интернете.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-219">Creating a custom font set using known, remote fonts on the Web.</span></span>
-   <span data-ttu-id="1a4a8-220">Создание пользовательского набора шрифтов с использованием данных шрифта, загруженных в память.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-220">Creating a custom font set using font data loaded into memory.</span></span>

<span data-ttu-id="1a4a8-221">Полные реализации этих сценариев приведены в [примере пользовательских наборов шрифтов DirectWrite](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DirectWriteCustomFontSets/).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-221">Complete implementations for these scenarios are provided in the [DirectWrite Custom Font Sets sample](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DirectWriteCustomFontSets/).</span></span> <span data-ttu-id="1a4a8-222">Этот пример также иллюстрирует один более сложный сценарий для обработки данных шрифтов, упакованных в форматах контейнеров WOFF или WOFF2, которые будут рассмотрены ниже.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-222">That sample also illustrates one more advanced scenario for handling font data packed in WOFF or WOFF2 container formats, which will be discussed below.</span></span> 

### <a name="creating-a-font-set-using-arbitrary-fonts-in-the-local-file-system"></a><span data-ttu-id="1a4a8-223">Создание набора шрифтов с помощью произвольных шрифтов в локальной файловой системе</span><span class="sxs-lookup"><span data-stu-id="1a4a8-223">Creating a font set using arbitrary fonts in the local file system</span></span>

<span data-ttu-id="1a4a8-224">При работе с произвольным набором файлов шрифтов в локальном хранилище метод [**IDWriteFontSetBuilder1:: аддфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) удобен, поскольку в одном вызове он может выполнять все грани шрифта в файле коллекции шрифтов OpenType, а также все экземпляры для шрифта переменной OpenType.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-224">When dealing with an arbitrary set of font files in local storage, the [**IDWriteFontSetBuilder1::AddFontFile**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) method is convenient since, in a single call, it can handle all of the font faces within an OpenType Font Collection file, as well as all instances for an OpenType variable font.</span></span> <span data-ttu-id="1a4a8-225">Он доступен в Windows 10 Creators Update (Предварительная версия сборки 15021 или более поздней версии) и рекомендуется при наличии.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-225">This is available in the Windows 10 Creators Update (preview build 15021 or later), and is recommended whenever available.</span></span> 

<span data-ttu-id="1a4a8-226">Чтобы использовать этот метод, используйте следующий процесс.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-226">To use this method, use the following process.</span></span>

<dl> <span data-ttu-id="1a4a8-227">1. Начните с создания интерфейса <a href="/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory5">IDWriteFactory5</a> :</span><span class="sxs-lookup"><span data-stu-id="1a4a8-227">1. Start by creating the <a href="/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory5">IDWriteFactory5</a> interface:</span></span> 


```C++
IDWriteFactory5* pDWriteFactory; 
HRESULT hr = DWriteCreateFactory( 
  DWRITE_FACTORY_TYPE_SHARED, 
  __uuidof(IDWriteFactory5), 
  reinterpret_cast<IUnknown**>(&pDWriteFactory) 
); 
```



   
2. <span data-ttu-id="1a4a8-228">Используйте фабрику для получения интерфейса <a href=""></a> [**IDWriteFontSetBuilder1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder1) :</span><span class="sxs-lookup"><span data-stu-id="1a4a8-228">Use the factory to obtain the <a href=""></a>[**IDWriteFontSetBuilder1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder1) interface:</span></span> 


```C++
IDWriteFontSetBuilder1* pFontSetBuilder; 
if (SUCCEEDED(hr)) 
{ 
  hr = pDWriteFactory->CreateFontSetBuilder(&pFontSetBuilder); 
}  
                
```



  
3. <span data-ttu-id="1a4a8-229">Для каждого файла шрифта в локальной файловой системе создайте [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) , ссылающийся на него:</span><span class="sxs-lookup"><span data-stu-id="1a4a8-229">For each font file in the local file system, create an [**IDWriteFontFile**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) that refers to it:</span></span> 


```C++
IDWriteFontFile* pFontFile; 
if (SUCCEEDED(hr)) 
{ 
  hr = pDWriteFactory->CreateFontFileReference(pFilePath, /* lastWriteTime*/ nullptr, &pFontFile); 
} 
```



   
4. <span data-ttu-id="1a4a8-230">Добавьте объект [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) в конструктор набора шрифтов с помощью метода [**аддфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) :</span><span class="sxs-lookup"><span data-stu-id="1a4a8-230">Add the [**IDWriteFontFile**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) object to the font set builder using the [**AddFontFile**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) method:</span></span> 


```C++
hr = pFontSetBuilder->AddFontFile(pFontFile); 
```

<span data-ttu-id="1a4a8-231">Если путь к файлу, указанный в вызове [**креатефонтфилереференце**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createfontfilereference) , ссылается на нечто, отличное от поддерживаемого файла OpenType, то вызов [**АДДФОНТФИЛЕ**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) возвратит ошибку дврите \_ E \_ FILEFORMAT.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-231">If the file path specified in the call to [**CreateFontFileReference**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createfontfilereference) referred to something other than a supported OpenType file, then the call to [**AddFontFile**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) will return an error, DWRITE\_E\_FILEFORMAT.</span></span>

5. <span data-ttu-id="1a4a8-232">После добавления всех файлов в построитель набора шрифтов можно создать пользовательский набор шрифтов:</span><span class="sxs-lookup"><span data-stu-id="1a4a8-232">After all of the files have been added to the font set builder, the custom font set can be created:</span></span> 


```C++
IDWriteFontSet* pFontSet; 
hr = pFontSetBuilder->CreateFontSet(&pFontSet); 
```



   
</dl>

<span data-ttu-id="1a4a8-233">Если приложение должно работать в версиях Windows 10, предшествующих версии Windows 10 Creators Update, метод Аддфонтфиле будет недоступен.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-233">If the app needs to run on Windows 10 versions earlier than the Windows 10 Creators Update, then the AddFontFile method will not be available.</span></span> <span data-ttu-id="1a4a8-234">Доступность можно обнаружить путем создания интерфейса [**IDWriteFactory3**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory3) , а затем с помощью QueryInterface, чтобы попытаться получить интерфейс [**IDWriteFactory5**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory5) . Если это происходит, то также будет доступен интерфейс [**IDWriteFontSetBuilder1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder1) и метод [**аддфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-234">Availability can be detected by creating an [**IDWriteFactory3**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory3) interface and then using QueryInterface to try to obtain an [**IDWriteFactory5**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory5) interface: if this succeeds, then the [**IDWriteFontSetBuilder1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder1) interface and [**AddFontFile**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) method will also be available.</span></span>

<span data-ttu-id="1a4a8-235">Если метод Аддфонтфиле недоступен, то для добавления отдельных гарнитур необходимо использовать метод [**идвритефонтсетбуилдер:: аддфонтфацереференце**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontfacereference(idwritefontfacereference)) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-235">If the AddFontFile method is not available, then the [**IDWriteFontSetBuilder::AddFontFaceReference**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontfacereference(idwritefontfacereference)) method must be used to add individual font faces.</span></span> <span data-ttu-id="1a4a8-236">Чтобы разрешить использование файлов коллекций шрифтов OpenType, содержащих несколько лиц, метод [**идвритефонтфиле:: Analyze**](/windows/win32/api/dwrite/nf-dwrite-idwritefontfile-analyze) можно использовать для определения количества лиц, содержащихся в файле.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-236">To allow for OpenType Font Collection files that contain multiple faces, the [**IDWriteFontFile::Analyze**](/windows/win32/api/dwrite/nf-dwrite-idwritefontfile-analyze) method can be used to determine the number of faces contained within the file.</span></span> <span data-ttu-id="1a4a8-237">Процесс выглядит следующим образом.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-237">The process is as follows.</span></span>

<dl> <span data-ttu-id="1a4a8-238">1. Начните с создания интерфейса <a href="/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory3">IDWriteFactory3</a> :</span><span class="sxs-lookup"><span data-stu-id="1a4a8-238">1. Start by creating the <a href="/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory3">IDWriteFactory3</a> interface:</span></span> 


```C++
IDWriteFactory3* pDWriteFactory; 
HRESULT hr = DWriteCreateFactory( 
DWRITE_FACTORY_TYPE_SHARED, 
  __uuidof(IDWriteFactory5), 
  reinterpret_cast<IUnknown**>(&pDWriteFactory) 
); 
```



  
2. <span data-ttu-id="1a4a8-239">Используйте фабрику для получения интерфейса [**идвритефонтсетбуилдер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder) :</span><span class="sxs-lookup"><span data-stu-id="1a4a8-239">Use the factory to obtain the [**IDWriteFontSetBuilder**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder) interface:</span></span> 


```C++
IDWriteFontSetBuilder* pFontSetBuilder; 
if (SUCCEEDED(hr)) 
{ 
  hr = pDWriteFactory->CreateFontSetBuilder(&pFontSetBuilder); 
} 
```



  
3. <span data-ttu-id="1a4a8-240">Для каждого файла шрифта создайте [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile), как описано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-240">For each font file, create an [**IDWriteFontFile**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile), as above:</span></span> 


```C++
IDWriteFontFile* pFontFile; 
if (SUCCEEDED(hr)) 
{ 
  hr = pDWriteFactory->CreateFontFileReference(pFilePath, /* lastWriteTime*/ nullptr, &pFontFile); 
} 
```



<span data-ttu-id="1a4a8-241">Вместо того чтобы добавлять файл непосредственно в построитель набора шрифтов, необходимо определить количество граней и создать отдельные объекты [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-241">Instead of adding the file directly to the font set builder, we need to determine the number of faces and create individual [**IDWriteFontFaceReference**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference) objects.</span></span>   
4. <span data-ttu-id="1a4a8-242">Чтобы получить количество лиц в файле, используйте метод [**Analyze**](/windows/win32/api/dwrite/nf-dwrite-idwritefontfile-analyze) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-242">Use the [**Analyze**](/windows/win32/api/dwrite/nf-dwrite-idwritefontfile-analyze) method to get the number of faces in the file.</span></span> 


```C++
BOOL isSupported; 
DWRITE_FONT_FILE_TYPE fileType; 
UINT32 numberOfFonts; 
hr = pFontFile->Analyze(&isSupported, &fileType, /* face type */ nullptr, &numberOfFonts); 
```



<span data-ttu-id="1a4a8-243">Метод [**Analyze**](/windows/win32/api/dwrite/nf-dwrite-idwritefontfile-analyze) также задает значения для параметров support и filetype.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-243">The [**Analyze**](/windows/win32/api/dwrite/nf-dwrite-idwritefontfile-analyze) method will also set values for the isSupported and fileType parameters.</span></span> <span data-ttu-id="1a4a8-244">Если формат файла не поддерживается, то поддерживается значение FALSE и выполняется соответствующее действие, например игнорирование файла.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-244">If the file is not a supported format, then isSupported will be FALSE, and appropriate action, such as ignoring the file, can be taken.</span></span>   
5. <span data-ttu-id="1a4a8-245">Перебрать число шрифтов, заданных в параметре Нумбероффонтс.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-245">Loop over the number of fonts set in the numberOfFonts parameter.</span></span> <span data-ttu-id="1a4a8-246">В цикле создайте [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference) для каждой пары "файл-индекс" и добавьте их в конструктор набора шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-246">Within the loop, create an [**IDWriteFontFaceReference**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference) for each file/index pair, and add that to the font set builder.</span></span> 


```C++
for (uint32_t fontIndex = 0; fontIndex < numberOfFonts; fontIndex++) 
{ 
  IDWriteFontFaceReference* pFontFaceReference;
  hr = pDWriteFactory->CreateFontFaceReference(pFontFile, fontIndex, DWRITE_FONT_SIMULATIONS_NONE, &pFontFaceReference);

  if (SUCCEEDED(hr))
  {
    hr = pFontSetBuilder->AddFontFaceReference(pFontFaceReference);
  }
} 
```



  
6. <span data-ttu-id="1a4a8-247">После добавления всех граней в построитель набора шрифтов создайте пользовательский набор шрифтов, как показано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-247">After all the faces have been added to the font set builder, create the custom font set, as shown above.</span></span>  
</dl>

<span data-ttu-id="1a4a8-248">Приложение может быть спроектировано таким образом, чтобы оно использовало предпочтительный метод [**аддфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) при работе в Windows 10 Creators Update, но при работе в более ранних версиях Windows 10 необходимо использовать метод [**аддфонтфацереференце**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontfacereference(idwritefontfacereference)) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-248">An app can be designed so that it will use the preferred [**AddFontFile**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) method when running on the Windows 10 Creators Update, but fall back to use the [**AddFontFaceReference**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontfacereference(idwritefontfacereference)) method when running on earlier Windows 10 versions.</span></span> <span data-ttu-id="1a4a8-249">Проверьте доступность интерфейса [**IDWriteFactory5**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory5) , как описано выше, а затем создайте ветвь соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-249">Test for availability of the [**IDWriteFactory5**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory5) interface, as described above, and then branch accordingly.</span></span> <span data-ttu-id="1a4a8-250">Этот подход показан в [примере пользовательских наборов шрифтов DirectWrite](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DirectWriteCustomFontSets/).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-250">This approach is illustrated in the [DirectWrite Custom Font Sets sample](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DirectWriteCustomFontSets/).</span></span> 

### <a name="creating-a-font-set-using-known-fonts-in-the-local-file-system"></a><span data-ttu-id="1a4a8-251">Создание набора шрифтов с помощью известных шрифтов в локальной файловой системе</span><span class="sxs-lookup"><span data-stu-id="1a4a8-251">Creating a font set using known fonts in the local file system</span></span>

<span data-ttu-id="1a4a8-252">Как упоминалось выше, каждая ссылка на начертание шрифта в наборе шрифтов связана с определенными информационными свойствами, такими как имя семейства и плотность шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-252">As mentioned above, each font face reference in a font set is associated with certain informational properties, such as family name and font weight.</span></span> <span data-ttu-id="1a4a8-253">При добавлении пользовательских шрифтов к построителю набора шрифтов с помощью приведенных выше вызовов API эти информационные свойства получаются непосредственно из фактических данных шрифта, которые считываются при добавлении шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-253">When custom fonts are added to a font set builder using the API calls listed above, these informational properties are obtained directly from the actual font data, which is read as the font is added.</span></span> <span data-ttu-id="1a4a8-254">Однако в некоторых ситуациях, если у приложения есть другой источник информации о шрифте, может потребоваться предоставить собственные пользовательские значения для этих свойств.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-254">In some situations, however, if an app has another source of information about a font, it might wish to provide its own custom values for these properties.</span></span> 

<span data-ttu-id="1a4a8-255">В качестве примера того, как это может быть полезно, предположим, что приложение объединяет некоторые шрифты, используемые для представления определенных элементов пользовательского интерфейса в приложении.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-255">As an example of how this might be useful, suppose an app bundles some fonts that are used for presenting particular user-interface elements within the app.</span></span> <span data-ttu-id="1a4a8-256">Иногда может потребоваться изменить конкретные шрифты, используемые приложением для этих элементов, например, с новой версией приложения.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-256">At times, such as with a new app version, the specific fonts that the app uses for these elements may need to change.</span></span> <span data-ttu-id="1a4a8-257">Если в приложении закодированы ссылки на определенные шрифты, то замена одного шрифта на другой может потребовать изменения каждой из этих ссылок.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-257">If the app has encoded references to the specific fonts, then replacement of one font with another will require changing every one of those references.</span></span> <span data-ttu-id="1a4a8-258">Вместо этого, если приложение использует пользовательские свойства для назначения функциональных псевдонимов на основе типа отображаемого элемента или текста, сопоставляет каждый псевдоним с конкретным шрифтом в одном месте, а затем использует Псевдонимы во всех контекстах, где создаются и обрабатываются шрифты, а затем замена одного шрифта на другой требует только изменения одного места, где псевдоним сопоставляется с конкретным шрифтом.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-258">Instead, if the app uses custom properties to assign functional aliases based on the type of element or text being rendered, maps each alias to a specific font in one place and then uses the aliases in all the contexts where fonts are created and manipulated, then replacing one font with another requires only changing the one place where the alias is mapped to a specific font.</span></span> 

<span data-ttu-id="1a4a8-259">Пользовательские значения для информационных свойств могут быть назначены при вызове метода [**идвритефонтсетбуилдер:: аддфонтфацереференце**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontfacereference(idwritefontfacereference)) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-259">Custom values for informational properties can be assigned when the [**IDWriteFontSetBuilder::AddFontFaceReference**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontfacereference(idwritefontfacereference)) method is called.</span></span> <span data-ttu-id="1a4a8-260">Для этого используется следующий метод. его можно использовать в любой версии Windows 10.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-260">The method for doing this is as follows; this can be used on any Windows 10 version.</span></span> 

<span data-ttu-id="1a4a8-261">Как показано выше, начните с получения интерфейсов [**IDWriteFactory3**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory3) и [**идвритефонтсет**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontset) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-261">As shown above, start by obtaining the [**IDWriteFactory3**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefactory3) and [**IDWriteFontSet**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontset) interfaces.</span></span> <span data-ttu-id="1a4a8-262">Для добавления каждого пользовательского начертания шрифта создайте [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference), как показано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-262">For each custom font face to be added, create an [**IDWriteFontFaceReference**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference), as shown above.</span></span> <span data-ttu-id="1a4a8-263">Однако перед добавлением к построителю набора шрифтов (в цикле на шаге 5, показанном выше), приложение определяет используемые значения настраиваемых свойств.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-263">Before this is added to the font set builder (within the loop in step 5, shown above), however, the app defines the custom property values to be used.</span></span> 

<span data-ttu-id="1a4a8-264">Набор значений пользовательских свойств определяется с помощью массива структур [**\_ \_ свойств Font дврите**](/windows/win32/api/dwrite_3/ns-dwrite_3-dwrite_font_property) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-264">A set of custom property values is defined using an array of [**DWRITE\_FONT\_PROPERTY**](/windows/win32/api/dwrite_3/ns-dwrite_3-dwrite_font_property) structures.</span></span> <span data-ttu-id="1a4a8-265">Каждый из них определяет определенное свойство из перечисления с [**\_ \_ \_ идентификатором свойства Font дврите**](/windows/win32/api/dwrite_3/ne-dwrite_3-dwrite_font_property_id) и соответствующее значение свойства, которое будет использоваться.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-265">Each of these identifies a particular property from the [**DWRITE\_FONT\_PROPERTY\_ID**](/windows/win32/api/dwrite_3/ne-dwrite_3-dwrite_font_property_id) enum, and the corresponding property value that is to be used.</span></span>  

<span data-ttu-id="1a4a8-266">Обратите внимание, что все значения свойств присваиваются в виде строк.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-266">Note that all property values are assigned as strings.</span></span> <span data-ttu-id="1a4a8-267">Если впоследствии они будут отображаться для пользователей, можно задать альтернативные значения для данного свойства для разных языков, но это не является обязательным.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-267">If these may later be displayed to users, then alternate values for a given property for different languages may be set, but this is not required.</span></span> <span data-ttu-id="1a4a8-268">Также обратите внимание, что если в приложении заданы значения пользовательских свойств, то в наборе шрифтов будут использоваться только указанные значения. DirectWrite не будет наследовать значения непосредственно от шрифта для информационных свойств, используемых в наборе шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-268">Also note that if any custom property values are set by the app, then only those values that are specified will be used within the Font set; DirectWrite will not derive any values directly from the font for informational properties used in a font set.</span></span> 

<span data-ttu-id="1a4a8-269">В следующем примере определяются пользовательские значения для трех информационных свойств: имя семейства, полное имя и плотность шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-269">The following example defines custom values for three informational properties: family name, full name, and font weight.</span></span> 


```C++
DWRITE_FONT_PROPERTY props[] = 
{ 
  { DWRITE_FONT_PROPERTY_ID_FAMILY_NAME, L"My Icon Font", L"en-US" }, 
  { DWRITE_FONT_PROPERTY_ID_FULL_NAME, L"My Icon Font", L"en-US" }, 
  { DWRITE_FONT_PROPERTY_ID_WEIGHT, L"400", nullptr } 
}; 
               
            
```



<span data-ttu-id="1a4a8-270">После определения требуемого массива значений свойств для шрифта выполните вызов Аддфонтфацерефенце, передав массив свойств, а также ссылку на начертание шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-270">After defining the desired array of property values for a font, make a call to AddFontFaceRefence, passing the property array as well as the font face reference.</span></span> 


```C++
hr = pFontSetBuilder->AddFontFaceReference(pFontFaceReference, props, ARRAYSIZE(props)); 
```



 

<span data-ttu-id="1a4a8-271">После добавления всех пользовательских шрифтов к построителю набора шрифтов вместе со своими пользовательскими свойствами создайте пользовательский набор шрифтов, как показано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-271">Once all custom font faces have been added to the font set builder, along with their custom properties, create the custom font set, as shown above.</span></span> 

### <a name="creating-a-custom-font-set-using-known-remote-fonts-on-the-web"></a><span data-ttu-id="1a4a8-272">Создание пользовательского набора шрифтов с помощью известных удаленных шрифтов в Интернете</span><span class="sxs-lookup"><span data-stu-id="1a4a8-272">Creating a custom font set using known, remote fonts on the Web</span></span>

<span data-ttu-id="1a4a8-273">Пользовательские свойства важны для работы с удаленными шрифтами.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-273">Custom properties are important for working with remote fonts.</span></span> <span data-ttu-id="1a4a8-274">Каждая ссылка на начертание шрифта должна иметь некоторые информационные свойства, характеризующие шрифт и отличающие его от других шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-274">Each font face reference must have some informational properties to characterize the font and distinguish it from other fonts.</span></span> <span data-ttu-id="1a4a8-275">Так как данные шрифтов для удаленных шрифтов не являются локальными, DirectWrite не может наследовать свойства непосредственно из данных шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-275">Since the font data for remote fonts is not local, DirectWrite cannot derive properties directly from the font data.</span></span> <span data-ttu-id="1a4a8-276">Следовательно, свойства должны предоставляться явно при добавлении удаленного шрифта в построитель набора шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-276">Hence, properties must be provided explicitly when adding a remote font to the font set builder.</span></span>

<span data-ttu-id="1a4a8-277">Последовательность вызовов API для добавления удаленных шрифтов к набору шрифтов аналогична последовательности, описанной в предыдущем сценарии.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-277">The sequence of API calls for adding remote fonts to a font set is similar to the sequence described for the previous scenario.</span></span> <span data-ttu-id="1a4a8-278">Поскольку данные шрифта являются удаленными, операции, связанные с чтением фактических данных шрифта, будут отличаться, чем при работе с файлами в локальном хранилище.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-278">Since the font data is remote, however, the operations involved for reading the actual font data will be different than when working with files in local storage.</span></span> <span data-ttu-id="1a4a8-279">В этой ситуации новый интерфейс более низкого уровня, [**идвритеремотефонтфилелоадер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfileloader), был добавлен в Windows 10 Creators Update.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-279">For this situation, a new lower-level interface, [**IDWriteRemoteFontFileLoader**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfileloader), has been added in the Windows 10 Creators Update.</span></span> 

<span data-ttu-id="1a4a8-280">Чтобы использовать загрузчик файлов удаленного шрифта, его необходимо сначала зарегистрировать в фабрике DirectWrite.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-280">To use the remote font file loader, it must first be registered with a DirectWrite factory.</span></span> <span data-ttu-id="1a4a8-281">Загрузчик должен удерживаться в приложении до тех пор, пока используются шрифты, связанные с ним.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-281">The loader will need to be held by the app for as long as the fonts associated with it are being used.</span></span> <span data-ttu-id="1a4a8-282">После того как шрифты больше не используются и в некоторый момент до уничтожения фабрики, необходимо отменить регистрацию загрузчика.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-282">Once the fonts are no longer in use, and at some point before the factory is destroyed, the loader must be unregistered.</span></span> <span data-ttu-id="1a4a8-283">Это можно сделать в деструкторе для класса, владеющего объектом Loader.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-283">This can be done in the destructor for the class that owns the loader object.</span></span> <span data-ttu-id="1a4a8-284">Эти действия будут показаны ниже.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-284">These steps will be shown below.</span></span> 

<span data-ttu-id="1a4a8-285">Ниже приведен метод создания пользовательского набора шрифтов с использованием удаленных шрифтов. для этого требуется обновление Windows 10 Creators Update.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-285">The method for creating a custom font set using remote fonts is as follows; this requires the Windows 10 Creators Update.</span></span>  

<dl> <span data-ttu-id="1a4a8-286">1. Создайте интерфейс IDWriteFactory5, как показано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-286">1. Create an IDWriteFactory5 interface, as shown above.</span></span>   
<span data-ttu-id="1a4a8-287">2. Создайте интерфейс <a href="/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder">идвритефонтсетбуилдер</a> , как показано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-287">2. Create an <a href="/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder">IDWriteFontSetBuilder</a> interface, as shown above.</span></span>   
<span data-ttu-id="1a4a8-288">3. Используйте фабрику для получения <a href="/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfileloader">идвритеремотефонтфилелоадер</a>.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-288">3. Use the factory to obtain an <a href="/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfileloader">IDWriteRemoteFontFileLoader</a>.</span></span> 


```C++
IDWriteRemoteFontFileLoader* pRemoteFontFileLoader; 
if (SUCCEEDED(hr)) 
{ 
    hr = pDWriteFactory->CreateHttpFontFileLoader( 
        /* referrerURL */ nullptr, 
        /* extraHeaders */ nullptr, 
        &pRemoteFontFileLoader 
    ); 
} 
```



<span data-ttu-id="1a4a8-289">Он возвращает предоставляемую системой реализацию интерфейса удаленного загрузчика файлов шрифтов, которая может управлять HTTP-взаимодействием для загрузки данных шрифтов от имени приложения.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-289">This returns a system-provided implementation of the remote font file loader interface that is able to handle HTTP interactions for downloading font data on behalf of the app.</span></span> <span data-ttu-id="1a4a8-290">URL-адрес источника ссылки или дополнительные заголовки можно указать, если это требуется для службы шрифтов или служб, которые являются источником для шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-290">A referrer URL or extra headers can be specified if required by the font service or services that are the source for the fonts.</span></span>    

> [!IMPORTANT]
> <span data-ttu-id="1a4a8-291">Примечание о безопасности. при попытке получить удаленный шрифт злоумышленник может подменить предполагаемый сервер, который будет вызываться.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-291">Security note: When an attempt is made to fetch a remote font, the potential exists for an attacker to spoof the intended server that will be called.</span></span> <span data-ttu-id="1a4a8-292">В этом случае URL-адреса целевого объекта и источника ссылки и сведения о заголовке будут раскрываться злоумышленнику.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-292">In that case, the target and referrer URLs and header details would be disclosed to the attacker.</span></span> <span data-ttu-id="1a4a8-293">Разработчики приложений несут ответственность за устранение этого риска.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-293">App developers are responsible for mitigating this risk.</span></span> <span data-ttu-id="1a4a8-294">Рекомендуется использовать протокол HTTPS, а не HTTP.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-294">Use of the HTTPS protocol, rather than HTTP, is recommended.</span></span> 

 

<span data-ttu-id="1a4a8-295">Для нескольких шрифтов можно использовать один удаленный загрузчик файлов шрифтов, хотя при получении шрифтов из нескольких служб с разными требованиями к URL-адресу ссылки или дополнительным заголовкам можно использовать разные загрузчики.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-295">A single remote font file loader can be used for multiple fonts, though different loaders can be used if fonts are obtained from multiple services that have different requirements for referrer URL or extra headers.</span></span>   
4. <span data-ttu-id="1a4a8-296">Зарегистрируйте загрузчик файлов удаленного шрифта с фабрикой.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-296">Register the remote font file loader with the factory.</span></span> 


```C++
 if (SUCCEEDED(hr)) 
 { 
     hr = pDWriteFactory->RegisterFontFileLoader(pRemoteFontFileLoader); 
 } 
```



<span data-ttu-id="1a4a8-297">С этого момента действия по созданию пользовательского набора шрифтов похожи на те, которые описаны для известных локальных файлов шрифтов, с двумя важными исключениями.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-297">From this point, the steps for creating the custom font set are similar to those described for known, local font files, with two important exceptions.</span></span> <span data-ttu-id="1a4a8-298">Во-первых, объект [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) создается с помощью удаленного интерфейса загрузчика файлов шрифтов вместо использования фабрики.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-298">First, the [**IDWriteFontFile**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) object is created using the remote font file loader interface rather than using the factory.</span></span> <span data-ttu-id="1a4a8-299">Во-вторых, метод Analyze нельзя использовать, так как данные шрифта не являются локальными.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-299">Second, the Analyze method cannot be used since the font data is not local.</span></span> <span data-ttu-id="1a4a8-300">Вместо этого приложение должно определить, является ли файл удаленного шрифта файлом коллекции шрифтов OpenType, и если да, то он должен определить, какой из шрифтов в коллекции будет использоваться, и индекс для каждого из них.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-300">Instead, the app must know whether the remote font file is an OpenType Font Collection file, and if so, then it must know which of the fonts within the collection it will use, and the index for each.</span></span> <span data-ttu-id="1a4a8-301">Таким образом, оставшиеся шаги приведены ниже.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-301">Hence, the remaining steps are as follows.</span></span>   
5. <span data-ttu-id="1a4a8-302">Для каждого удаленного файла шрифтов используйте удаленный интерфейс загрузчика файлов шрифтов для создания [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile), указав URL-адрес, необходимый для доступа к файлу шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-302">For each remote font file, use the remote font file loader interface to create an [**IDWriteFontFile**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile), specifying the URL required to access the font file.</span></span> 


```C++
 IDWriteFontFile* pFontFile; 
 hr = pRemoteFontFileLoader->CreateFontFileReferenceFromUrl( 
     pDWriteFactory, 
     /* baseUrl */ L"https://github.com/", 
     /* fontFileUrl */ L"winjs/winjs/blob/master/src/fonts/Symbols.ttf?raw=true", 
     &pFontFile 
 ); 
```



<span data-ttu-id="1a4a8-303">Обратите внимание, что полный URL-адрес может быть указан в параметре Фонтфилеурл, или его можно разделить на базовые и относительные части.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-303">Note that the complete URL can be specified in the fontFileUrl parameter, or it can be split into base and relative portions.</span></span> <span data-ttu-id="1a4a8-304">Если указан базовый URL-адрес, то объединение значений baseUrl и Фонтфилеурл должно предоставить полный URL-адрес — DirectWrite не предоставит никаких дополнительных разделителей.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-304">If a base URL is specified, then the concatenation of the baseUrl and fontFileUrl values must provide the complete URL — DirectWrite will not supply any additional delimiter.</span></span>  

> [!IMPORTANT]
> <span data-ttu-id="1a4a8-305">Примечание о безопасности и производительности. при попытке получения удаленного шрифта не гарантируется, что Windows получит ответ от сервера.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-305">Security / performance note: When an attempt is made to fetch a remote font, there is no guarantee that Windows will receive a response from the server.</span></span> <span data-ttu-id="1a4a8-306">В некоторых случаях сервер может ответить с ошибкой "файл не найден" для недопустимого относительного URL-адреса, но перестает отвечать, если он получает несколько недопустимых запросов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-306">In some cases, a server may respond with a file-not-found error for an invalid relative URL, but stop responding if it receives multiple invalid requests.</span></span> <span data-ttu-id="1a4a8-307">Если сервер не отвечает, Windows в конечном итоге истечет, хотя это может занять несколько минут, если инициируется несколько выборок.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-307">If the server does not respond, Windows will eventually time out, though this may take several minutes if multiple fetches are initiated.</span></span> <span data-ttu-id="1a4a8-308">Необходимо сделать так, чтобы URL-адреса стали действительными при выполнении вызовов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-308">You should do what you can to ensure that URLs will be valid when calls are made.</span></span> 

 

<span data-ttu-id="1a4a8-309">Также обратите внимание, что URL-адрес может указывать на необработанный файл шрифта OpenType (. ttf,. ОТФ,. ТТК,. ОТК), но он также может указывать на шрифты в файле контейнера WOFF или WOFF2.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-309">Also note that the URL can point to a raw OpenType font file (.ttf, .otf, .ttc, .otc), but it can also point to fonts in a WOFF or WOFF2 container file.</span></span> <span data-ttu-id="1a4a8-310">Если имеется ссылка на файл WOFF или WOFF2, то реализация DirectWrite удаленного файла шрифта будет автоматически распаковать данные шрифта из файла контейнера.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-310">If a WOFF or WOFF2 file is referenced, then the DirectWrite implementation of the remote font file loader will automatically unpack the font data from the container file.</span></span>   
6. <span data-ttu-id="1a4a8-311">Для каждого индекса начертания шрифта в используемом удаленном файле шрифта создайте [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-311">For each font face index within the remote font file that is to be used, create an [**IDWriteFontFaceReference**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference).</span></span> 


```C++
 IDWriteFontFaceReference* pFontFaceReference; 
 hr = pDWriteFactory->CreateFontFaceReference(pFontFile, /* faceIndex */ 0, DWRITE_FONT_SIMULATIONS_NONE, &pFontFaceReference);
```



  
7. <span data-ttu-id="1a4a8-312">Определите пользовательские свойства для начертания шрифта, как показано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-312">Define custom properties for the font face, as shown above.</span></span>   
8. <span data-ttu-id="1a4a8-313">Добавьте ссылку на шрифт и пользовательские свойства в конструктор набора шрифтов, как показано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-313">Add the font face reference along with custom properties to the font set builder, as shown above.</span></span>   
9. <span data-ttu-id="1a4a8-314">После добавления всех шрифтов в построитель набора шрифтов создайте набор шрифтов, как показано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-314">After all fonts have been added to the font set builder, create the font set, as shown above.</span></span>   
10. <span data-ttu-id="1a4a8-315">В некоторый момент, когда удаленные шрифты больше не используются, отмените регистрацию удаленного загрузчика файлов шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-315">At some point when the remote fonts will no longer be used, unregister the remote font file loader.</span></span> 


```C++
hr = pDWriteFactory->UnregisterFontFileLoader(pRemoteFontFileLoader); 
```



  
</dl>

<span data-ttu-id="1a4a8-316">После создания пользовательского набора шрифтов с настраиваемыми удаленными шрифтами набор шрифтов содержит ссылки и информационные свойства для удаленных шрифтов, но фактические данные все еще являются удаленными.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-316">Once a custom font set with custom remote fonts is created, the font set contains references and informational properties for the remote fonts, but the actual data is still remote.</span></span> <span data-ttu-id="1a4a8-317">Поддержка DirectWrite для удаленных шрифтов позволяет поддерживать ссылку на шрифт в наборе шрифтов, а также выбирать шрифт для использования в макете и отрисовке, но фактические данные не загружаются до фактического использования, например, когда будет выполняться макет текста.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-317">DirectWrite support for remote fonts allows a font face reference to be maintained in the font set, and for a font to be selected for use in layout and rendering, but that the actual data is not downloaded until there is an actual need to use it, such as when text layout will be performed.</span></span>  

<span data-ttu-id="1a4a8-318">Приложение может использовать внешний подход, запрашивая, что DirectWrite скачивает данные шрифта, а затем ожидает подтверждения успешной загрузки до начала обработки с помощью шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-318">An app can take an up-front approach by requesting that DirectWrite download the font data and then waiting for confirmation of a successful download before any processing with the font is begun.</span></span> <span data-ttu-id="1a4a8-319">Однако загрузка по сети подразумевает некоторую задержку в непредсказуемом состоянии, и успешное выполнение также не имеет значения.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-319">But a network download implies some latency of unpredictable duration, and success is also uncertain.</span></span> <span data-ttu-id="1a4a8-320">По этой причине, как правило, лучше использовать другой подход, позволяя макету и подготовке к просмотру изначально использовать альтернативные или резервные шрифты, которые уже являются локальными, при запросе загрузки требуемого удаленного шрифта и последующем обновлении результатов после загрузки нужного шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-320">For this reason, it will usually be better to take a different approach, allowing layout and rendering to be done initially using alternate or fallback fonts that are already local, while requesting download of the desired, remote font in parallel, and then updating the results once the desired font has been downloaded.</span></span> 

<span data-ttu-id="1a4a8-321">Чтобы запрашивать загрузку всего шрифта перед его использованием, можно использовать метод [**идвритефонтфацереференце:: енкуеуефонтдовнлоадрекуест**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontfacereference-enqueuefontdownloadrequest) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-321">To request that the entire font be downloaded before it gets used, the [**IDWriteFontFaceReference::EnqueueFontDownloadRequest**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontfacereference-enqueuefontdownloadrequest) method can be used.</span></span> <span data-ttu-id="1a4a8-322">Если шрифт слишком большой, для обработки определенных строк может потребоваться только часть данных.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-322">If the font is very large, only a portion of the data may be needed for processing particular strings.</span></span> <span data-ttu-id="1a4a8-323">DirectWrite предоставляет дополнительные методы, которые можно использовать для запроса частей данных шрифта, необходимых для конкретного содержимого, [**енкуеуечарактердовнлоадрекуест**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontfacereference-enqueuecharacterdownloadrequest) и [**енкуеуеглифдовнлоадрекуест**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontfacereference-enqueueglyphdownloadrequest).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-323">DirectWrite provides additional methods that can be used to request portions of the font data needed for particular content, [**EnqueueCharacterDownloadRequest**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontfacereference-enqueuecharacterdownloadrequest) and [**EnqueueGlyphDownloadRequest**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontfacereference-enqueueglyphdownloadrequest).</span></span>  

<span data-ttu-id="1a4a8-324">Предположим, что подход, выполняемый в приложении, заключается в том, чтобы разрешить изначальное выполнение обработки с использованием локальных, альтернативных или резервных шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-324">Suppose the approach to be taken in the app is to allow processing to be done initially using local, alternate or fallback fonts.</span></span> <span data-ttu-id="1a4a8-325">Метод Идвритефонтфаллбакк::[**мапчарактерс**](idwritefontfallback-mapcharacters.md) можно использовать для задания локальных резервных шрифтов. Кроме того, он автоматически заставит в очередь запрос на загрузку предпочтительного шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-325">The IDWriteFontFallback::[**MapCharacters**](idwritefontfallback-mapcharacters.md) method can be used to identify local fallback fonts, and it will also automatically enqueue a request to download the preferred font.</span></span> <span data-ttu-id="1a4a8-326">Кроме того, если используется [**идвритетекстлайаут**](/windows/win32/api/dwrite/nn-dwrite-idwritetextlayout) и часть или весь текст в макете отформатированы с помощью удаленной ссылки на шрифт, то DirectWrite будет автоматически использовать метод **мапчарактерс** для получения локальных шрифтов отката и постановки запроса на загрузку удаленных данных шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-326">Also, if [**IDWriteTextLayout**](/windows/win32/api/dwrite/nn-dwrite-idwritetextlayout) is used and some or all of the text in the layout is formatted using a remote font reference, then DirectWrite will automatically use the **MapCharacters** method to get local fallback fonts and to enqueue a request to download the remote font data.</span></span> 

<span data-ttu-id="1a4a8-327">DirectWrite поддерживает очередь загрузки шрифтов для каждой фабрики, и запросы, выполненные с помощью упомянутых выше методов, добавляются в эту очередь.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-327">DirectWrite maintains a font download queue for each factory, and the requests made using the methods mentioned above get added to that queue.</span></span> <span data-ttu-id="1a4a8-328">Очередь загрузки шрифтов можно получить с помощью метода [**IDWriteFactory3:: жетфонтдовнлоадкуеуе**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory3-getfontdownloadqueue) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-328">The font download queue can be obtained using the [**IDWriteFactory3::GetFontDownloadQueue**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory3-getfontdownloadqueue) method.</span></span> 

<span data-ttu-id="1a4a8-329">Если запрос на загрузку выполнен, но данные шрифта уже являются локальными, это приведет к невыполнению операции: в очередь загрузки ничего не будет добавлено.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-329">If a download request is made but the font data is already local, this will result in a no-op: Nothing will be added to the download queue.</span></span> <span data-ttu-id="1a4a8-330">Приложение может проверить, пуста ли очередь, или нет ожидающих запросов на скачивание, вызвав метод [**идвритефонтдовнлоадкуеуе:: IsEmpty**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontdownloadqueue-isempty) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-330">An app can check whether the queue is empty or there are pending download requests by calling the [**IDWriteFontDownloadQueue::IsEmpty**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontdownloadqueue-isempty) method.</span></span> 

<span data-ttu-id="1a4a8-331">После добавления в очередь запросов удаленного шрифта необходимо запустить процесс загрузки.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-331">After remote font requests have been added to the queue, the download process must be initiated.</span></span> <span data-ttu-id="1a4a8-332">Если в [**идвритетекстлайаут**](/windows/win32/api/dwrite/nn-dwrite-idwritetextlayout)используются удаленные шрифты, загрузка будет инициирована автоматически, когда приложение вызывает методы **идвритетекстлайаут** , которые выполняют операции макета или отрисовки, такие как методы жетлинеметрикс или Draw.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-332">When remote fonts are used in [**IDWriteTextLayout**](/windows/win32/api/dwrite/nn-dwrite-idwritetextlayout), the download will be initiated automatically when the app calls **IDWriteTextLayout** methods that force layout or rendering operations, such as the GetLineMetrics or Draw methods.</span></span> <span data-ttu-id="1a4a8-333">В других сценариях приложение должно инициировать загрузку напрямую путем вызова [**идвритефонтдовнлоадкуеуе:: BeginDownload**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontdownloadqueue-begindownload).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-333">In other scenarios, the app must initiate the download directly by calling [**IDWriteFontDownloadQueue::BeginDownload**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontdownloadqueue-begindownload).</span></span>  

<span data-ttu-id="1a4a8-334">После завершения скачивания приложение будет выполнять необходимые действия — продолжить работу с ожидающими операциями или повторить операции, которые изначально были выполнены с помощью резервных шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-334">When a download is completed, it will be up to the app to take appropriate actions — proceeding with pending operations, or repeating operations that were done initially with fallback fonts.</span></span> <span data-ttu-id="1a4a8-335">(Если используется макет текста DirectWrite, то [**IDWriteTextLayout3:: инвалидателайаут**](idwritetextlayout3-invalidatelayout.md) можно использовать для очистки временных результатов, вычисленных с помощью резервных шрифтов.) Чтобы приложение было уведомлено о завершении процесса загрузки и предпринять соответствующие действия, приложение должно предоставить реализацию интерфейса [**идвритефонтдовнлоадлистенер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) и передать его в вызов BeginDownload.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-335">(If DirectWrite’s text layout is being used, then [**IDWriteTextLayout3::InvalidateLayout**](idwritetextlayout3-invalidatelayout.md) can be used to clear the temporary results computed using fallback fonts.) In order for the app to be notified when the download process has completed and to take appropriate actions, the app must provide an implementation of the [**IDWriteFontDownloadListener**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) interface, and pass this into the BeginDownload call.</span></span> 

> [!IMPORTANT]
> <span data-ttu-id="1a4a8-336">Примечание о безопасности и производительности. при попытке получения удаленного шрифта не гарантируется, что Windows получит ответ от сервера.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-336">Security / performance note: When an attempt is made to fetch a remote font, there is no guarantee that Windows will receive a response from the server.</span></span> <span data-ttu-id="1a4a8-337">Если сервер не отвечает, Windows в конечном итоге истечет, хотя это может занять несколько минут, если несколько удаленных шрифтов будут выделены, но не будут работать.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-337">If the server does not respond, Windows will eventually time out, though this may take several minutes if multiple remote fonts are being fetched but failing.</span></span> <span data-ttu-id="1a4a8-338">Вызов BeginDownload будет возвращаться немедленно.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-338">The BeginDownload call will return immediately.</span></span> <span data-ttu-id="1a4a8-339">Приложения не должны блокировать пользовательский интерфейс при ожидании вызова [**идвритефонтдовнлоадлистенер::D овнлоадкомплетед**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontdownloadlistener-downloadcompleted) .</span><span class="sxs-lookup"><span data-stu-id="1a4a8-339">Apps should not block UI while waiting for [**IDWriteFontDownloadListener::DownloadCompleted**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontdownloadlistener-downloadcompleted) to be called.</span></span> 

 

<span data-ttu-id="1a4a8-340">Примеры реализации этих взаимодействий с очередью загрузки шрифтов DirectWrite и интерфейсом [**идвритефонтдовнлоадлистенер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) можно просмотреть в [примере пользовательских наборов шрифтов DirectWrite](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DirectWriteCustomFontSets/), а также в [примере DirectWrite загружаемых шрифтов](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/DWriteTextLayoutCloudFont).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-340">Sample implementations of these interactions with DirectWrite’s font download queue and of the [**IDWriteFontDownloadListener**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontdownloadlistener) interface can be seen in the [DirectWrite Custom Font Sets sample](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DirectWriteCustomFontSets/), and also in the [DirectWrite Downloadable Fonts sample](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/DWriteTextLayoutCloudFont).</span></span> 

### <a name="creating-a-custom-font-set-using-font-data-loaded-into-memory"></a><span data-ttu-id="1a4a8-341">Создание пользовательского набора шрифтов с помощью данных шрифтов, загруженных в память</span><span class="sxs-lookup"><span data-stu-id="1a4a8-341">Creating a custom font set using font data loaded into memory</span></span>

<span data-ttu-id="1a4a8-342">Так же как низкоуровневые операции чтения данных из файла шрифта отличаются для файлов на локальном диске и удаленных файлов в Интернете, то же самое справедливо и для данных шрифтов, загружаемых в буфер памяти.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-342">Just as the low-level operations for reading data from a font file are different for files on a local disk versus remote files on the Web, the same is also true for font data loaded into a memory buffer.</span></span> <span data-ttu-id="1a4a8-343">Новый интерфейс низкого уровня для обработки данных шрифта в памяти был добавлен в Windows 10 Creators Update, [**идвритеинмеморифонтфилелоадер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteinmemoryfontfileloader).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-343">A new low-level interface for handling in-memory font data has been added in the Windows 10 Creators Update, [**IDWriteInMemoryFontFileLoader**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteinmemoryfontfileloader).</span></span> 

<span data-ttu-id="1a4a8-344">Как и в случае с удаленным загрузчиком файлов шрифтов, загрузчик файлов шрифта в памяти сначала должен быть зарегистрирован в фабрике DirectWrite.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-344">As with a remote font file loader, an in-memory font file loader must first be registered with a DirectWrite factory.</span></span> <span data-ttu-id="1a4a8-345">Загрузчик должен удерживаться в приложении до тех пор, пока используются шрифты, связанные с ним.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-345">The loader will need to be held by the app for as long as the fonts associated with it are being used.</span></span> <span data-ttu-id="1a4a8-346">После того как шрифты больше не используются и в некоторый момент до уничтожения фабрики, необходимо отменить регистрацию загрузчика.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-346">Once the fonts are no longer in use, and at some point before the factory is destroyed, the loader must be unregistered.</span></span> <span data-ttu-id="1a4a8-347">Это можно сделать в деструкторе для класса, владеющего объектом Loader.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-347">This can be done in the destructor for the class that owns the loader object.</span></span> <span data-ttu-id="1a4a8-348">Эти действия будут показаны ниже.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-348">These steps will be shown below.</span></span> 

<span data-ttu-id="1a4a8-349">Если приложение имеет отдельные сведения о шрифтах, представленных данными, он может добавить отдельные ссылки на шрифт в построитель набора шрифтов с заданными пользовательскими свойствами.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-349">If the app has separate information about the font faces represented by the data, it can add individual font face references to a font set builder with custom properties specified.</span></span> <span data-ttu-id="1a4a8-350">Поскольку данные шрифта находятся в локальной памяти, это не является обязательным. DirectWrite сможет считывать данные напрямую для получения значений свойств.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-350">Since the font data is in local memory, however, this is not required; DirectWrite will be able to read the data directly to derive the property values.</span></span> 

<span data-ttu-id="1a4a8-351">DirectWrite предполагает, что данные шрифта находятся в формате RAW (формат OpenType), эквивалентном файлу OpenType (. ttf,. ОТФ,. ТТК,. ОТК), но в памяти, а не на диске.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-351">DirectWrite assumes the font data is in raw, OpenType format, equivalent to an OpenType file (.ttf, .otf, .ttc, .otc), but in memory rather than on disk.</span></span> <span data-ttu-id="1a4a8-352">Данные не могут быть в формате контейнера WOFF или WOFF2.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-352">The data cannot be in a WOFF or WOFF2 container format.</span></span> <span data-ttu-id="1a4a8-353">Данные могут представлять коллекцию шрифтов OpenType.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-353">The data can represent an OpenType Font Collection.</span></span> <span data-ttu-id="1a4a8-354">Если пользовательские свойства не используются, метод [**IDWriteFontSetBuilder1:: аддфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) можно использовать для добавления в данные всех начертаний шрифтов в одном вызове.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-354">If custom properties are not being used, then the [**IDWriteFontSetBuilder1::AddFontFile**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) method can be used to add all font faces in the data in a single call.</span></span> 

<span data-ttu-id="1a4a8-355">Важным моментом для сценария в памяти является время существования данных.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-355">An important consideration for the in-memory scenario is the lifetime of the data.</span></span> <span data-ttu-id="1a4a8-356">Если указатель на буфер предоставляется DirectWrite без четкого указания на наличие владельца, DirectWrite скопирует данные в новый буфер памяти, который будет владеть.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-356">If a pointer to the buffer is provided to DirectWrite without a clear indication that there is an owner, then DirectWrite will make a copy of the data into a new memory buffer that it will own.</span></span> <span data-ttu-id="1a4a8-357">Чтобы избежать копирования данных и дополнительного выделения памяти, приложение может передать объект владельца данных, реализующий IUnknown, и который владеет буфером памяти, содержащим данные шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-357">To avoid copying of data and additional memory allocation, the app can pass a data-owner object that implements IUnknown, and that owns the memory buffer containing the font data.</span></span> <span data-ttu-id="1a4a8-358">Реализуя этот интерфейс, DirectWrite может добавить к счетчику ссылок объекта, тем самым гарантируя время существования принадлежащих данных.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-358">By implementing this interface, DirectWrite can add to the ref count of the object, thereby ensuring the lifetime of the owned data.</span></span> 

<span data-ttu-id="1a4a8-359">Метод создания пользовательского набора шрифтов с использованием данных шрифта в памяти выглядит следующим образом. для этого требуется обновление Windows 10 Creators Update.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-359">The method for creating a custom font set using in-memory font data is as follows; this requires the Windows 10 Creators Update.</span></span> <span data-ttu-id="1a4a8-360">Предполагается, что реализованный приложением объект-владелец данных, реализующий IUnknown, а также методы, возвращающие указатель на буфер памяти и размер буфера.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-360">This will assume an app-implemented data-owner object, that implements IUnknown and also has methods that return a pointer to the memory buffer and the size of the buffer.</span></span> 

<dl> <span data-ttu-id="1a4a8-361">1. Создайте интерфейс IDWriteFactory5, как показано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-361">1. Create an IDWriteFactory5 interface, as shown above.</span></span>  
<span data-ttu-id="1a4a8-362">2. Создайте интерфейс [**IDWriteFontSetBuilder1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder1) , как показано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-362">2. Create an [**IDWriteFontSetBuilder1**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontsetbuilder1) interface, as shown above.</span></span>  
<span data-ttu-id="1a4a8-363">3. Используйте фабрику для получения Идвритеинмеморифонтфилелоадер.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-363">3. Use the factory to obtain an IDWriteInMemoryFontFileLoader.</span></span> 


```C++
 IDWriteInMemoryFontFileLoader* pInMemoryFontFileLoader; 
if (SUCCEEDED(hr)) 
{ 
    hr = pDWriteFactory->CreateInMemoryFontFileLoader(&pInMemoryFontFileLoader); 
}
```



<span data-ttu-id="1a4a8-364">Это возвращает системную реализацию интерфейса загрузчика файлов шрифтов в памяти.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-364">This returns a system-provided implementation of the in-memory font file loader interface.</span></span>   
4. <span data-ttu-id="1a4a8-365">Зарегистрируйте загрузчик файлов шрифтов в памяти с фабрикой.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-365">Register the in-memory font file loader with the factory.</span></span> 


```C++
if (SUCCEEDED(hr)) 
{ 
    hr = pDWriteFactory->RegisterFontFileLoader(pInMemoryFontFileLoader); 
}
```



   
5. <span data-ttu-id="1a4a8-366">Для каждого файла шрифта в памяти используйте загрузчик файлов шрифтов в памяти для создания [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-366">For each in-memory font file, use the in-memory font file loader to create an [**IDWriteFontFile**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile).</span></span> 


```C++
IDWriteFontFile* pFontFile; 
hr = pInMemoryFontFileLoader->CreateInMemoryFontFileReference( 
    pDWriteFactory, 
    pFontDataOwner->fontData /* returns void* */, 
    pFontDataOwner->fontDataSize /* returns UINT32 */, 
    pFontDataOwner /* ownerObject, owns the memory with font data and implements IUknown */, 
    &pFontFile 
); 
```



   
6. <span data-ttu-id="1a4a8-367">Добавьте объект [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) в конструктор набора шрифтов с помощью метода [**аддфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) , как показано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-367">Add the [**IDWriteFontFile**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) object to the font set builder using the [**AddFontFile**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder1-addfontfile) method, as shown above.</span></span>  <span data-ttu-id="1a4a8-368">При необходимости приложение может создавать отдельные объекты [**идвритефонтфацереференце**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference) на основе **идвритефонтфиле**, при необходимости определять пользовательские свойства для каждой ссылки на шрифт, а затем добавлять ссылку на начертание шрифта с пользовательскими свойствами в набор шрифтов с помощью метода [**аддфонтфацереференце**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontfacereference(idwritefontfacereference)) , как показано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-368">If there is a need, the app can instead create individual [**IDWriteFontFaceReference**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwritefontfacereference) objects based on the **IDWriteFontFile**, optionally define custom properties for each font face reference, and then add the font face reference with custom properties to the font set using the [**AddFontFaceReference**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontfacereference(idwritefontfacereference)) method, as shown above.</span></span>   
7. <span data-ttu-id="1a4a8-369">После добавления всех шрифтов в построитель набора шрифтов создайте пользовательский набор шрифтов, как показано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-369">After all fonts have been added to the font set builder, create the custom font set, as shown above.</span></span>   
8. <span data-ttu-id="1a4a8-370">В какой-то момент, когда шрифты в памяти больше не используются, отмените регистрацию загрузчика файлов шрифтов в памяти.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-370">At some point when the in-memory fonts will no longer be used, unregister the in-memory font file loader.</span></span> 


```C++
hr = pDWriteFactory->UnregisterFontFileLoader(pInMemoryFontFileLoader);
```



  
</dl>

 

## <a name="advanced-scenarios"></a><span data-ttu-id="1a4a8-371">Сложные сценарии</span><span class="sxs-lookup"><span data-stu-id="1a4a8-371">Advanced scenarios</span></span>

<span data-ttu-id="1a4a8-372">Некоторые приложения могут иметь особые требования, требующие более сложной обработки, чем описано выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-372">Some apps may have special requirements that require more advanced processing than is described above.</span></span> 

### <a name="combining-font-sets"></a><span data-ttu-id="1a4a8-373">Объединение наборов шрифтов</span><span class="sxs-lookup"><span data-stu-id="1a4a8-373">Combining font sets</span></span>

<span data-ttu-id="1a4a8-374">Некоторым приложениям может потребоваться создать набор шрифтов, состоящий из сочетания элементов из других наборов шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-374">Some apps may need to create a font set that comprises some combination of items from other font sets.</span></span> <span data-ttu-id="1a4a8-375">Например, приложению может потребоваться создать набор шрифтов, который объединяет все шрифты, установленные в системе, с помощью выбора пользовательских шрифтов или комбинирует установленные шрифты, соответствующие определенным условиям, с другими шрифтами.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-375">For example, an app may want to create a font set that combines all the fonts installed on the system with a selection of custom fonts, or that combines installed fonts matching certain criteria with other fonts.</span></span> <span data-ttu-id="1a4a8-376">DirectWrite содержит API-интерфейсы для поддержки манипуляции и объединения наборов шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-376">DirectWrite has APIs to support manipulation and combining of font sets.</span></span> 

<span data-ttu-id="1a4a8-377">Чтобы объединить два или более наборов шрифтов, метод [**идвритефонтсетбуилдер:: аддфонтсет**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontset) добавляет все шрифты в заданном наборе шрифтов для добавления в построитель набора шрифтов в одном вызове.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-377">To combine two or more font sets, the [**IDWriteFontSetBuilder::AddFontSet**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontsetbuilder-addfontset) method adds all of the fonts in given font set to be added to a font set builder in a single call.</span></span> <span data-ttu-id="1a4a8-378">Если в новом наборе шрифтов требуется только определенное начертание шрифта из существующего набора шрифтов, метод [**идвритефонтсет:: жетматчингфонтс**](idwritefontset-getmatchingfonts-overload.md) можно использовать для получения нового объекта набора шрифтов, который был отфильтрован, чтобы включить только шрифты, соответствующие указанным свойствам.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-378">If only certain fonts from an existing font set are wanted in the new font set, the [**IDWriteFontSet::GetMatchingFonts**](idwritefontset-getmatchingfonts-overload.md) method can be used to derive a new font set object that has been filtered to include only fonts matching specified properties.</span></span> <span data-ttu-id="1a4a8-379">Эти методы предоставляют простой способ создания пользовательского набора шрифтов, объединяющего шрифты из двух или более существующих наборов шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-379">These methods provide an easy way to create a custom font set combining fonts from two or more existing font sets</span></span> 

### <a name="using-local-woff-or-woff2-font-data"></a><span data-ttu-id="1a4a8-380">Использование локальных данных шрифта WOFF или WOFF2</span><span class="sxs-lookup"><span data-stu-id="1a4a8-380">Using local WOFF or WOFF2 font data</span></span>

<span data-ttu-id="1a4a8-381">Если приложение имеет файлы шрифтов в локальной файловой системе или в буфере памяти, но они используют форматы контейнеров WOFF или WOFF2, DirectWrite (обновление Windows 10 Creator или более поздней версии) предоставляет метод для распаковки формата контейнера, [**IDWriteFactory5:: унпаккфонтфиле**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-unpackfontfile), который возвращает [**идвритефонтфилестреам**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-381">If an app has font files in the local file system or in a memory buffer, but they use the WOFF or WOFF2 container formats, DirectWrite (Windows 10 Creator Update or later) provides a method for unpacking the container format, [**IDWriteFactory5::UnpackFontFile**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefactory5-unpackfontfile), which returns an [**IDWriteFontFileStream**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream).</span></span> 

<span data-ttu-id="1a4a8-382">Однако приложению потребуется способ получить [**идвритефонтфилестреам**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream) в объекте-загрузчике файлов шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-382">However, the app will need a way to get the [**IDWriteFontFileStream**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream) into a font file loader object.</span></span> <span data-ttu-id="1a4a8-383">Один из способов сделать это — создать пользовательскую реализацию [**идвритефонтфилелоадер**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfileloader) , которая заключает поток в оболочку.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-383">One way to do this is to create a custom [**IDWriteFontFileLoader**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfileloader) implementation that wraps the stream.</span></span> <span data-ttu-id="1a4a8-384">Как и в случае с другими загрузчиками файлов шрифтов, это необходимо зарегистрировать перед использованием и отменить регистрацию, прежде чем фабрика выйдет из области действия.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-384">As with other font file loaders, this must be registered before use, and unregistered before the factory goes out of scope.</span></span>  

<span data-ttu-id="1a4a8-385">Если пользовательский загрузчик также будет использоваться с файлами необработанных шрифтов (без упаковки), то приложению также потребуется предоставить пользовательскую реализацию интерфейса [**идвритефонтфилестреам**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream) для обработки этих файлов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-385">If the custom loader will also be used with raw (not packed) font files, then the app would also need to provide a custom implementation of the [**IDWriteFontFileStream**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfilestream) interface for handling those files.</span></span> <span data-ttu-id="1a4a8-386">Однако существуют более простые способы использования интерфейсов API, описанных выше для обработки файлов необработанных шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-386">There are easier ways that use APIs discussed above for handling raw font files, however.</span></span> <span data-ttu-id="1a4a8-387">Необходимость в реализации пользовательского потока можно избежать с помощью отдельных путей кода для упакованных файлов шрифтов и файлов необработанных шрифтов.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-387">The need for a custom stream implementation could be avoided by using separate code paths for packed font files versus raw font files.</span></span> 

<span data-ttu-id="1a4a8-388">После создания пользовательского объекта-загрузчика файла шрифта Упакованные данные файла шрифта добавляются в загрузчик с помощью средств, зависящих от приложения.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-388">After a custom font file loader object is created, the packed font file data is added to the loader by app-specific means.</span></span> <span data-ttu-id="1a4a8-389">Загрузчик может работать с несколькими файлами шрифтов, каждый из которых определяется с помощью определяемого приложением ключа, который является непрозрачным для DirectWrite.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-389">The loader can handle multiple font files, each of which is identified using an app-defined key that is opaque to DirectWrite.</span></span> <span data-ttu-id="1a4a8-390">После добавления упакованного файла шрифта в загрузчик метод [**идвритефактори:: креатекустомфонтфилереференце**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createcustomfontfilereference) используется для получения [**идвритефонтфиле**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) на основе этого загрузчика для данных шрифта, идентифицируемых заданным ключом.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-390">After a packed font file has been added to the loader, the [**IDWriteFactory::CreateCustomFontFileReference**](/windows/win32/api/dwrite/nf-dwrite-idwritefactory-createcustomfontfilereference) method is used to obtain an [**IDWriteFontFile**](/windows/win32/api/dwrite/nn-dwrite-idwritefontfile) based on that loader for the font data identified by a given key.</span></span>  

<span data-ttu-id="1a4a8-391">Фактическое распаковку данных шрифтов можно выполнить при добавлении шрифтов в загрузчик, но их также можно обработать в методе [**идвритефонтфилелоадер:: креатестреамфромкэй**](/windows/win32/api/dwrite/nf-dwrite-idwritefontfileloader-createstreamfromkey) , который DirectWrite вызовет, когда ему сначала нужно считать данные шрифта.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-391">The actual unpacking of the font data can be done as fonts are added to the loader, but can also be handled in the [**IDWriteFontFileLoader::CreateStreamFromKey**](/windows/win32/api/dwrite/nf-dwrite-idwritefontfileloader-createstreamfromkey) method, which DirectWrite will call when it first needs to read the font data.</span></span> 

<span data-ttu-id="1a4a8-392">После создания объекта Идвритефонтфиле оставшиеся шаги по добавлению шрифтов в пользовательский набор шрифтов будут описаны выше.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-392">After an IDWriteFontFile object has been created, remaining steps for adding the fonts to a custom font set will be as described above.</span></span> 

<span data-ttu-id="1a4a8-393">Реализация, использующая этот подход, проиллюстрирована в [примере пользовательских наборов шрифтов DirectWrite](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DirectWriteCustomFontSets/).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-393">An implementation using this approach is illustrated in the [DirectWrite Custom Font Sets sample](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DirectWriteCustomFontSets/).</span></span> 

### <a name="using-directwrite-remote-font-mechanisms-with-custom-low-level-network-implementation"></a><span data-ttu-id="1a4a8-394">Использование удаленных механизмов шрифтов DirectWrite с пользовательской реализацией низкого уровня сети</span><span class="sxs-lookup"><span data-stu-id="1a4a8-394">Using DirectWrite remote font mechanisms with custom low-level network implementation</span></span>

<span data-ttu-id="1a4a8-395">Механизмы DirectWrite для обработки удаленных шрифтов можно разделить на механизмы более высокого уровня — наличие наборов шрифтов, включающих в себя ссылки на шрифт для удаленных шрифтов, проверку локализации данных шрифта и управление очередью для запросов на загрузку шрифтов, а также механизмы нижнего уровня, обрабатывающие фактическую загрузку.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-395">The DirectWrite mechanisms for handling remote fonts can be divided into higher-level mechanisms — having font sets that include font face references for remote fonts, checking locality of the font data, and managing the queue for font download requests — and the lower-level mechanisms that handle actual download.</span></span> <span data-ttu-id="1a4a8-396">Некоторым приложениям может потребоваться использовать удаленные механизмы шрифтов более высокого уровня, но также требуется пользовательское взаимодействие с сетью, например обмен данными с серверами с помощью протоколов, отличных от HTTP.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-396">Some apps may want to utilize the higher-level remote font mechanisms, but also require custom network interactions, such as communicating with servers using protocols other than HTTP.</span></span> 

<span data-ttu-id="1a4a8-397">В этой ситуации приложению потребуется создать пользовательскую реализацию интерфейса [**идвритеремотефонтфилелоадер**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfileloader) , который взаимодействует с другими интерфейсами более низкого уровня в требуемых направлениях.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-397">For this situation, an app will need to create a custom implementation of the [**IDWriteRemoteFontFileLoader**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfileloader) interface that interacts with other lower-level interfaces in the required ways.</span></span> <span data-ttu-id="1a4a8-398">Приложению также потребуется предоставить пользовательские реализации этих интерфейсов нижнего уровня: [**идвритеремотефонтфилестреам**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfilestream)и [**идвритеасинкресулт**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteasyncresult).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-398">The app will also need to provide custom implementations of these lower-level interfaces: [**IDWriteRemoteFontFileStream**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteremotefontfilestream), and [**IDWriteAsyncResult**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteasyncresult).</span></span> <span data-ttu-id="1a4a8-399">Эти три интерфейса имеют методы обратного вызова, которые DirectWrite будут вызывать во время операций загрузки.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-399">These three interfaces have callback methods that DirectWrite will call during download operations.</span></span> 

<span data-ttu-id="1a4a8-400">Когда вызывается [**идвритефонтдовнлоадкуеуе:: BeginDownload**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontdownloadqueue-begindownload) , DirectWrite делает запросы к удаленному загрузчику файлов шрифтов о локализации данных и запрашивает удаленный поток.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-400">When [**IDWriteFontDownloadQueue::BeginDownload**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwritefontdownloadqueue-begindownload) is called, DirectWrite will make queries to the remote font file loader about locality of the data, and will request the remote stream.</span></span> <span data-ttu-id="1a4a8-401">Если данные не являются локальными, будет вызван метод потока BeginDownload.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-401">If data is not local, then it will call the stream’s BeginDownload method.</span></span> <span data-ttu-id="1a4a8-402">Реализация потока не должна блокироваться в этом вызове, но должна немедленно возвращаться, передавая объект [**идвритеасинкресулт**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteasyncresult) , предоставляющий обработчик ожидания, DirectWrite будет использовать для ожидания асинхронной операции загрузки.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-402">The stream implementation should not block on that call, but should immediately return, passing back an [**IDWriteAsyncResult**](/windows/win32/api/dwrite_3/nn-dwrite_3-idwriteasyncresult) object that provides the wait handle DirectWrite will use to wait on the asynchronous download operation.</span></span> <span data-ttu-id="1a4a8-403">Реализация пользовательского потока отвечает за обработку удаленного соединения.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-403">The custom stream implementation is responsible for handling the remote communication.</span></span> <span data-ttu-id="1a4a8-404">При возникновении события завершения DirectWrite вызывает [**идвритеасинкресулт::**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwriteasyncresult-getresult) , чтобы определить результат операции.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-404">When the completion event has occurred, then DirectWrite will call [**IDWriteAsyncResult::GetResult**](/windows/win32/api/dwrite_3/nf-dwrite_3-idwriteasyncresult-getresult) to determine the result of the operation.</span></span> <span data-ttu-id="1a4a8-405">Если результат выполнен успешно, ожидается, что последующие вызовы Реадфрагмент к потоку для скачанных диапазонов будут успешными.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-405">If the result is successful, then it’s expected that subsequent ReadFragment calls to the stream for the downloaded ranges will succeed.</span></span> 

> [!IMPORTANT]
> <span data-ttu-id="1a4a8-406">Примечание о безопасности и производительности. при попытке получить удаленный шрифт возможны проблемы, которые могут быть вызваны злоумышленником для подмены вызываемого сервера или того, что сервер может не отвечать.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-406">Security / performance note: When an attempt is made to fetch a remote font, the potential exists in general for an attacker to spoof the intended server being called, or that the server may not respond.</span></span> <span data-ttu-id="1a4a8-407">При реализации пользовательских сетевых взаимодействий вы можете иметь больший контроль над устранением рисков, чем при работе с серверами сторонних производителей.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-407">If you are implementing custom network interactions, you may have greater control over mitigations than when dealing with third-party servers.</span></span> <span data-ttu-id="1a4a8-408">Однако следует рассмотреть соответствующие меры, чтобы избежать раскрытия информации или отказа в обслуживании.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-408">However, it is up to you to consider appropriate mitigations to avoid information disclosure or denial of service.</span></span> <span data-ttu-id="1a4a8-409">Рекомендуется использовать защищенные протоколы, такие как HTTPS.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-409">Secure protocols such as HTTPS are recommended.</span></span> <span data-ttu-id="1a4a8-410">Кроме того, следует выполнить сборку в некоторое время ожидания, чтобы обработчик событий, возвращаемый в DirectWrite, в конечном итоге получил набор.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-410">Also, you should build in some timeout so that the event handle returned to DirectWrite does eventually get set.</span></span> 

 

### <a name="supporting-scenarios-on-earlier-windows-versions"></a><span data-ttu-id="1a4a8-411">Поддержка сценариев в более ранних версиях Windows</span><span class="sxs-lookup"><span data-stu-id="1a4a8-411">Supporting scenarios on earlier Windows versions</span></span>

<span data-ttu-id="1a4a8-412">Описанные сценарии могут поддерживаться в DirectWrite в более ранних версиях Windows, но потребовалось бы гораздо более настраиваемой реализации в части приложения с использованием более ограниченных интерфейсов API, которые были доступны до Windows 10.</span><span class="sxs-lookup"><span data-stu-id="1a4a8-412">The scenarios that have been described can be supported in DirectWrite on earlier versions of Windows, but would require much more custom implementation on the part of the app using the more limited APIs that were available prior to Windows 10.</span></span> <span data-ttu-id="1a4a8-413">Дополнительные сведения см. в статье [пользовательские коллекции шрифтов (Windows 7/8)](custom-font-collections.md).</span><span class="sxs-lookup"><span data-stu-id="1a4a8-413">For more information, see [Custom Font Collections (Windows 7/8)](custom-font-collections.md).</span></span>

 

 