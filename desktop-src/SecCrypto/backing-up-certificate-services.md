---
description: Как можно использовать функции резервного копирования служб сертификатов для резервного копирования базы данных служб сертификатов и связанных с ней файлов.
ms.assetid: f5c9c9f9-5211-4151-b8e0-3351d462c71b
title: Резервное копирование служб сертификатов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d1be929fcf3bd9b8b9655b48758a97d19af7abc7
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103913424"
---
# <a name="backing-up-certificate-services"></a><span data-ttu-id="4fcb0-103">Резервное копирование служб сертификатов</span><span class="sxs-lookup"><span data-stu-id="4fcb0-103">Backing Up Certificate Services</span></span>

<span data-ttu-id="4fcb0-104">Ниже приведен сценарий, показывающий, как можно использовать функции резервного копирования служб сертификатов для резервного копирования базы данных служб сертификатов и связанных с ней файлов.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-104">The following is a scenario showing how you can use the Certificate Services backup functions to back up a Certificate Services database and its associated files.</span></span>

1.  <span data-ttu-id="4fcb0-105">Загрузка библиотеки Certadm.dll в память (путем вызова [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="4fcb0-105">Load the Certadm.dll library into memory (by calling [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span>
2.  <span data-ttu-id="4fcb0-106">Извлеките адрес каждой из необходимых функций в Certadm.dll (с помощью [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span><span class="sxs-lookup"><span data-stu-id="4fcb0-106">Retrieve the address of each of the necessary functions in Certadm.dll (by means of [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span></span> <span data-ttu-id="4fcb0-107">Используйте эти адреса при вызове функций на оставшихся этапах.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-107">Use these addresses when calling the functions in the remaining steps.</span></span>
3.  <span data-ttu-id="4fcb0-108">Вызовите [**цертсрвиссерверонлине**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) , чтобы определить, находятся ли службы сертификатов в сети.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-108">Call [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) to determine whether Certificate Services is online.</span></span> <span data-ttu-id="4fcb0-109">Для успешного выполнения операций резервного копирования службы сертификатов должны находиться в оперативном режиме.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-109">Certificate Services must be online for the backup operations to be successful.</span></span>
4.  <span data-ttu-id="4fcb0-110">Вызовите [**цертсрвбаккуппрепаре**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuppreparew) для запуска сеанса резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-110">Call [**CertSrvBackupPrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuppreparew) to start a backup session.</span></span> <span data-ttu-id="4fcb0-111">Результирующий маркер контекста резервного копирования служб сертификации будет использоваться многими другими функциями резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-111">The resulting Certificate Services backup context handle will be used by many of the other backup functions.</span></span>
5.  <span data-ttu-id="4fcb0-112">Вызовите [**цертсрвресторежетдатабаселокатионс**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw) , чтобы определить карту восстановления.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-112">Call [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw) to determine the restore map.</span></span> <span data-ttu-id="4fcb0-113">На карте восстановления содержатся пути, используемые при восстановлении резервной копии.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-113">The restore map contains the paths to be used when restoring the backup.</span></span> <span data-ttu-id="4fcb0-114">Сохраните информацию, полученную с помощью **цертсрвресторежетдатабаселокатионс** , в отдельном расположении приложения.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-114">Save the information retrieved by **CertSrvRestoreGetDatabaseLocations** to an application-specific location.</span></span>
6.  <span data-ttu-id="4fcb0-115">Вызовите [**цертсрвбаккупжетдатабасенамес**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) , чтобы определить имена файлов базы данных для резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-115">Call [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) to determine the names of the database files to backup.</span></span> <span data-ttu-id="4fcb0-116">Для каждого из этих файлов выполните шаги 7 – 9.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-116">For each of these files, execute steps 7 through 9.</span></span>
7.  <span data-ttu-id="4fcb0-117">Вызовите [**цертсрвбаккупопенфиле**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupopenfilew) , чтобы открыть файл для резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-117">Call [**CertSrvBackupOpenFile**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupopenfilew) to open the file for backup.</span></span>
8.  <span data-ttu-id="4fcb0-118">Вызовите [**цертсрвбаккупреад**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupread) , чтобы прочитать часть байтов из файла, а затем вызовите подпрограммы для конкретного приложения, чтобы хранить байты на носителе резервной копии.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-118">Call [**CertSrvBackupRead**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupread) to read a portion of bytes from the file, then call an application-specific routine to store the bytes on a backup medium.</span></span> <span data-ttu-id="4fcb0-119">Повторите этот шаг, пока не будут создаваться резервные копии всех байтов в файле.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-119">Repeat this step until all of the bytes in the file are backed up.</span></span>
9.  <span data-ttu-id="4fcb0-120">Вызовите [**цертсрвбаккупклосе**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupclose) , чтобы закрыть файл.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-120">Call [**CertSrvBackupClose**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupclose) to close the file.</span></span>
10. <span data-ttu-id="4fcb0-121">Вызовите [**цертсрвбаккупжетбаккуплогс**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) , чтобы определить имена файлов журналов для резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-121">Call [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) to determine the names of the log files to backup.</span></span> <span data-ttu-id="4fcb0-122">Для каждого из этих файлов выполните шаги 7 – 9.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-122">For each of these files, execute steps 7 through 9.</span></span>
11. <span data-ttu-id="4fcb0-123">Вызовите [**цертсрвбаккуптрункателогс**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuptruncatelogs) , чтобы усечь файлы журнала, которые были созданы в шагах 6 и 10.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-123">Call [**CertSrvBackupTruncateLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuptruncatelogs) to truncate the log files which were backed up in steps 6 and 10.</span></span> <span data-ttu-id="4fcb0-124">Этот шаг является необязательным. Однако вызывайте **цертсрвбаккуптрункателогс** только в том случае, если были созданы резервные копии всех файлов, возвращенных [**цертсрвбаккупжетдатабасенамес**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) и [**цертсрвбаккупжетбаккуплогс**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) (в противном случае операция восстановления завершится ошибкой).</span><span class="sxs-lookup"><span data-stu-id="4fcb0-124">This step is optional; however, call **CertSrvBackupTruncateLogs** only if all files returned by [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) and [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) have been backed up (otherwise, the restore operation will fail).</span></span> <span data-ttu-id="4fcb0-125">Дополнительные сведения см. на странице справочника по **цертсрвбаккуптрункателогс** .</span><span class="sxs-lookup"><span data-stu-id="4fcb0-125">Consult the **CertSrvBackupTruncateLogs** reference page for details.</span></span>
12. <span data-ttu-id="4fcb0-126">Вызовите [**цертсрвбаккупжетдинамикфилелист**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) , чтобы определить имена файлов, не являющихся базами данных, для резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-126">Call [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) to determine the names of the non-database files to backup.</span></span> <span data-ttu-id="4fcb0-127">Эти файлы идентифицируются только функцией и должны быть архивированы другими средствами.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-127">These files are only identified by the function, and must be backed up by some other means.</span></span>
13. <span data-ttu-id="4fcb0-128">Создайте резервную копию динамических файлов, указанных на шаге 12, с помощью подпрограмм, отделяющих от Certadm.dll.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-128">Backup the dynamic files identified in step 12, using routines separate from Certadm.dll.</span></span>
14. <span data-ttu-id="4fcb0-129">Вызовите [**цертсрвбаккупенд**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupend) , чтобы завершить сеанс резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-129">Call [**CertSrvBackupEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupend) to end the backup session.</span></span>
15. <span data-ttu-id="4fcb0-130">Вызовите [**цертсрвбаккупфри**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupfree) по мере необходимости, чтобы освободить буферы, выделенные определенными функциями резервного копирования служб сертификатов.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-130">Call [**CertSrvBackupFree**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupfree) as needed to release buffers allocated by certain Certificate Services backup functions.</span></span> <span data-ttu-id="4fcb0-131">Вызовы [**цертсрвбаккупжетбаккуплогс**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw), [**цертсрвбаккупжетдатабасенамес**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw)и [**цертсрвбаккупжетдинамикфилелист**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) будут выделять буферы, которые можно освободить путем вызова **CertSrvBackupFree**.</span><span class="sxs-lookup"><span data-stu-id="4fcb0-131">Calls to [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw), [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw), and [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) will allocate buffers that can be freed by a call to **CertSrvBackupFree**.</span></span>
16. <span data-ttu-id="4fcb0-132">Освободите Certadm.dll ресурсы, вызвав [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary).</span><span class="sxs-lookup"><span data-stu-id="4fcb0-132">Release the Certadm.dll resources by calling [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary).</span></span>

<span data-ttu-id="4fcb0-133">Сведения о привилегиях, необходимых для резервного копирования базы данных служб сертификатов и связанных файлов, см. [в разделе Установка привилегий резервного копирования и восстановления](setting-the-backup-and-restore-privileges.md).</span><span class="sxs-lookup"><span data-stu-id="4fcb0-133">For information about the privileges required to back up the Certificate Services database and associated files, see [Setting the Backup and Restore Privileges](setting-the-backup-and-restore-privileges.md).</span></span>

 

 
