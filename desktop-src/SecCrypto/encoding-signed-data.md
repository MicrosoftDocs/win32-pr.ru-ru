---
description: Описывает процедуру кодирования подписанного сообщения.
ms.assetid: 40d1c417-6d88-4421-920f-8b40d88d28ce
title: Кодирование подписанных данных
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: be4a542fe0890a6ee9d51ebc1a5ee6b98bab4242
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104265912"
---
# <a name="encoding-signed-data"></a><span data-ttu-id="d54c9-103">Кодирование подписанных данных</span><span class="sxs-lookup"><span data-stu-id="d54c9-103">Encoding Signed Data</span></span>

<span data-ttu-id="d54c9-104">[*Подписанные данные*](../secgloss/s-gly.md) состоят из содержимого любого типа и [*хэшей*](../secgloss/h-gly.md) зашифрованных сообщений с содержимым от одного или нескольких подписывающих.</span><span class="sxs-lookup"><span data-stu-id="d54c9-104">[*Signed data*](../secgloss/s-gly.md) consists of content of any type and encrypted message [*hashes*](../secgloss/h-gly.md) of the content by zero or more signers.</span></span> <span data-ttu-id="d54c9-105">Полученный хэш может подтвердить, что исходное сообщение не было изменено с момента подписания и что определенные лица или сущности подписаны данным.</span><span class="sxs-lookup"><span data-stu-id="d54c9-105">The resulting hash can confirm that the original message has not been modified since signing and that particular persons or entities signed the data.</span></span>

<span data-ttu-id="d54c9-106">На следующем рисунке показана процедура кодирования подписанного сообщения.</span><span class="sxs-lookup"><span data-stu-id="d54c9-106">The following illustration depicts the procedure for encoding a signed message.</span></span> <span data-ttu-id="d54c9-107">Эти шаги описаны в списке, приведенном на рисунке.</span><span class="sxs-lookup"><span data-stu-id="d54c9-107">The list following the illustration describes the steps.</span></span>

<span data-ttu-id="d54c9-108">Сообщение может иметь несколько подписывающих, алгоритмов хэширования и сертификатов.</span><span class="sxs-lookup"><span data-stu-id="d54c9-108">A message may have multiple signers, hashing algorithms, and certificates.</span></span> <span data-ttu-id="d54c9-109">На рисунке показаны только сертификаты, [*списки отзыва*](../secgloss/c-gly.md)сертификатов и [*списки CTL*](../secgloss/c-gly.md) , которые могут использовать один и тот же процесс.</span><span class="sxs-lookup"><span data-stu-id="d54c9-109">While the illustration shows only certificates, [*CRLs*](../secgloss/c-gly.md), and [*CTLs*](../secgloss/c-gly.md) can use the same process.</span></span> <span data-ttu-id="d54c9-110">Они помещаются на иллюстрации, где отображаются сертификаты.</span><span class="sxs-lookup"><span data-stu-id="d54c9-110">They would fit into the illustration wherever certificates are shown.</span></span>

![кодирование подписанного сообщения](images/signmsg2.png)

<span data-ttu-id="d54c9-112">Общий процесс кодирования [*подписанных данных*](../secgloss/s-gly.md) выглядит следующим образом.</span><span class="sxs-lookup"><span data-stu-id="d54c9-112">The general process for encoding [*Signed data*](../secgloss/s-gly.md) is as follows.</span></span>

<span data-ttu-id="d54c9-113">**Кодирование подписанных данных**</span><span class="sxs-lookup"><span data-stu-id="d54c9-113">**To encode signed data**</span></span>

1.  <span data-ttu-id="d54c9-114">Данные создаются (при необходимости) и получает указатель на него.</span><span class="sxs-lookup"><span data-stu-id="d54c9-114">The data is created (if necessary), and a pointer to it is retrieved.</span></span>
2.  <span data-ttu-id="d54c9-115">Откроется [*хранилище сертификатов*](../secgloss/c-gly.md) , содержащее сертификат подписавших.</span><span class="sxs-lookup"><span data-stu-id="d54c9-115">A [*certificate store*](../secgloss/c-gly.md) is opened that contains the signer's certificate.</span></span>
3.  <span data-ttu-id="d54c9-116">Получен закрытый ключ для сертификата.</span><span class="sxs-lookup"><span data-stu-id="d54c9-116">The private key for the certificate is retrieved.</span></span> <span data-ttu-id="d54c9-117">Для сертификата необходимо задать два свойства, прежде чем использовать его.</span><span class="sxs-lookup"><span data-stu-id="d54c9-117">There are two properties that must be set on the certificate before using it.</span></span> <span data-ttu-id="d54c9-118">Один из них используется для привязки сертификата к конкретному CSP и, в пределах этого CSP, к конкретному [*контейнеру*](../secgloss/k-gly.md)закрытого ключа.</span><span class="sxs-lookup"><span data-stu-id="d54c9-118">One is used to tie a certificate to a particular CSP and, within that CSP, to a particular private [*key container*](../secgloss/k-gly.md).</span></span> <span data-ttu-id="d54c9-119">Другой используется для указания того, какой алгоритм хэширования следует использовать при вызове операции [*хэширования*](../secgloss/h-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="d54c9-119">The other is used to indicate which hashing algorithm is to be used when a [*hash*](../secgloss/h-gly.md) operation is called.</span></span> <span data-ttu-id="d54c9-120">Их необходимо задать только один раз.</span><span class="sxs-lookup"><span data-stu-id="d54c9-120">These need only be set once.</span></span>
4.  <span data-ttu-id="d54c9-121">Свойство сертификата определяет хэш-алгоритм.</span><span class="sxs-lookup"><span data-stu-id="d54c9-121">A certificate's property determines the hash algorithm.</span></span>
5.  <span data-ttu-id="d54c9-122">Хэш данных создается путем отправки данных с помощью функции хэширования.</span><span class="sxs-lookup"><span data-stu-id="d54c9-122">A hash of the data is created by sending the data through the hashing function.</span></span>
6.  <span data-ttu-id="d54c9-123">Подпись создается путем шифрования хэша с помощью закрытого ключа, полученного с помощью свойства сертификата.</span><span class="sxs-lookup"><span data-stu-id="d54c9-123">The signature is created by encrypting the hash using the private key, obtained through a property on the certificate.</span></span>
7.  <span data-ttu-id="d54c9-124">В готовое подписанное сообщение включаются следующие данные:</span><span class="sxs-lookup"><span data-stu-id="d54c9-124">The following data is included in the finished, signed message:</span></span>
    -   <span data-ttu-id="d54c9-125">Исходные данные для подписи</span><span class="sxs-lookup"><span data-stu-id="d54c9-125">The original data to be signed</span></span>
    -   <span data-ttu-id="d54c9-126">Алгоритмы хэширования</span><span class="sxs-lookup"><span data-stu-id="d54c9-126">The hash algorithms</span></span>
    -   <span data-ttu-id="d54c9-127">Сигнатуры</span><span class="sxs-lookup"><span data-stu-id="d54c9-127">The signatures</span></span>
    -   <span data-ttu-id="d54c9-128">Структуры сведений о подписавшем, включая идентификатор подписавший (поставщик сертификата и серийный номер).</span><span class="sxs-lookup"><span data-stu-id="d54c9-128">The signer info structures, which includes the signer identifier (certificate issuer and serial number)</span></span>
    -   <span data-ttu-id="d54c9-129">Сертификаты подписавший (необязательно)</span><span class="sxs-lookup"><span data-stu-id="d54c9-129">The signer's certificates (optional)</span></span>

<span data-ttu-id="d54c9-130">Эта процедура иллюстрирует простой вариант.</span><span class="sxs-lookup"><span data-stu-id="d54c9-130">This procedure illustrates a simple case.</span></span> <span data-ttu-id="d54c9-131">Более сложные случаи включают в себя атрибуты, прошедшие проверку подлинности, которые включены в сообщение.</span><span class="sxs-lookup"><span data-stu-id="d54c9-131">More complex cases involve authenticated attributes included in the message.</span></span> <span data-ttu-id="d54c9-132">Если тип содержимого является любым, но строкой **байта** , или существует по крайней мере один атрибут, прошедший проверку подлинности, и любой тип данных, необходимы два стандартных атрибута проверки подлинности: тип содержимого (Data) и хэш содержимого.</span><span class="sxs-lookup"><span data-stu-id="d54c9-132">When the content type is anything but a **BYTE** string, or there is at least one authenticated attribute along with any data type, there are two standard authenticated attributes required: the content (data) type, and the hash of the content.</span></span> <span data-ttu-id="d54c9-133">В этих обстоятельствах [*CryptoAPI*](../secgloss/c-gly.md) автоматически предоставляет эти два обязательных атрибута.</span><span class="sxs-lookup"><span data-stu-id="d54c9-133">Under these circumstances, the [*CryptoAPI*](../secgloss/c-gly.md) automatically provides these two required attributes.</span></span> <span data-ttu-id="d54c9-134">Низкоуровневые функции облагают атрибуты, прошедшие проверку подлинности, шифруют хэш-код с помощью закрытого ключа и предоставляют его в качестве сигнатуры.</span><span class="sxs-lookup"><span data-stu-id="d54c9-134">The low-level message functions hash the authenticated attributes, encrypt the hash with the private key, and provide this as the signature.</span></span>

<span data-ttu-id="d54c9-135">Используйте низкоуровневые функции обработки сообщений для выполнения перечисленных задач с помощью следующей процедуры.</span><span class="sxs-lookup"><span data-stu-id="d54c9-135">Use the low-level message functions to accomplish the tasks just listed, by using the following procedure.</span></span>

<span data-ttu-id="d54c9-136">**Кодирование подписанного сообщения**</span><span class="sxs-lookup"><span data-stu-id="d54c9-136">**To encode a signed message**</span></span>

1.  <span data-ttu-id="d54c9-137">Создайте или извлеките содержимое.</span><span class="sxs-lookup"><span data-stu-id="d54c9-137">Create or retrieve the content.</span></span>
2.  <span data-ttu-id="d54c9-138">Получение поставщика служб шифрования.</span><span class="sxs-lookup"><span data-stu-id="d54c9-138">Get a cryptographic provider.</span></span>
3.  <span data-ttu-id="d54c9-139">Получение сертификатов подписавших.</span><span class="sxs-lookup"><span data-stu-id="d54c9-139">Get the signer certificates.</span></span>
4.  <span data-ttu-id="d54c9-140">Инициализируйте [**структуру \_ \_ \_ сведений о кодировке КМСГ для подписания**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signer_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="d54c9-140">Initialize the [**CMSG\_SIGNER\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signer_encode_info) structure.</span></span>
5.  <span data-ttu-id="d54c9-141">Инициализируйте [**структуру \_ \_ \_ сведений о кодировании со знаком КМСГ**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="d54c9-141">Initialize the [**CMSG\_SIGNED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) structure.</span></span>
6.  <span data-ttu-id="d54c9-142">Вызовите [**криптмсгкалкулатинкодедленгс**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) , чтобы получить размер BLOB-объекта закодированного сообщения.</span><span class="sxs-lookup"><span data-stu-id="d54c9-142">Call [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) to get the size of the encoded message BLOB.</span></span> <span data-ttu-id="d54c9-143">Выделите память для нее.</span><span class="sxs-lookup"><span data-stu-id="d54c9-143">Allocate memory for it.</span></span>
7.  <span data-ttu-id="d54c9-144">Вызовите [**криптмсгопентоенкоде**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), передав КМСГ, \_ подписанный на *двмсгтипе* , и указатель на [**КМСГ \_ подписанные \_ \_ сведения о кодировке**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) для *пвмсженкодеинфо* , чтобы получить маркер открытого сообщения.</span><span class="sxs-lookup"><span data-stu-id="d54c9-144">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing in CMSG\_SIGNED for *dwMsgType* and a pointer to [**CMSG\_SIGNED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) for *pvMsgEncodeInfo* to get a handle to the opened message.</span></span>
8.  <span data-ttu-id="d54c9-145">Вызовите [**криптмсгупдате**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), передав маркер, полученный на шаге 7, и указатель на данные, которые должны быть подписаны и закодированы.</span><span class="sxs-lookup"><span data-stu-id="d54c9-145">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passing in the handle retrieved in step 7, and a pointer to the data that is to be signed and encoded.</span></span> <span data-ttu-id="d54c9-146">Эту функцию можно вызывать столько раз, сколько необходимо для завершения процесса кодирования.</span><span class="sxs-lookup"><span data-stu-id="d54c9-146">This function can be called as many times as necessary to complete the encoding process.</span></span>
9.  <span data-ttu-id="d54c9-147">Вызовите [**криптмсгжетпарам**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), передав маркер, полученный на шаге 7, и соответствующие типы параметров для доступа к нужным закодированным данным.</span><span class="sxs-lookup"><span data-stu-id="d54c9-147">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passing in the handle retrieved in step 7 and the appropriate parameter types to access the desired, encoded data.</span></span> <span data-ttu-id="d54c9-148">Например, передайте значение \_ параметра КМСГ Content \_ param, чтобы получить указатель на все сообщение [*PKCS \# 7*](../secgloss/p-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="d54c9-148">For example, pass in CMSG\_CONTENT\_PARAM to get a pointer to the entire [*PKCS \#7*](../secgloss/p-gly.md) message.</span></span>

    <span data-ttu-id="d54c9-149">Если результат этой кодировки будет использоваться в качестве [*внутренних данных*](../secgloss/i-gly.md) для другого закодированного сообщения, например сообщения, упакованного в оболочку, \_ \_ \_ необходимо передать параметр параметра КМСГ исходного содержимого.</span><span class="sxs-lookup"><span data-stu-id="d54c9-149">If the result of this encoding is to be used as the [*inner data*](../secgloss/i-gly.md) for another encoded message, such as an enveloped message, the CMSG\_BARE\_CONTENT\_PARAM parameter must be passed.</span></span> <span data-ttu-id="d54c9-150">Пример, демонстрирующий это, см. в разделе [альтернативный код для кодирования запечатанного сообщения](alternate-code-for-encoding-an-enveloped-message.md).</span><span class="sxs-lookup"><span data-stu-id="d54c9-150">For an example showing this, see [Alternate Code for Encoding an Enveloped Message](alternate-code-for-encoding-an-enveloped-message.md).</span></span>

10. <span data-ttu-id="d54c9-151">Закройте сообщение, вызвав [**криптмсгклосе**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span><span class="sxs-lookup"><span data-stu-id="d54c9-151">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="d54c9-152">Результатом этой процедуры является закодированное сообщение, содержащее исходные данные, зашифрованный хэш данных (сигнатура) и сведения о подписавшем.</span><span class="sxs-lookup"><span data-stu-id="d54c9-152">The result of this procedure is an encoded message that contains the original data, the encrypted hash of that data (signature), and the signer information.</span></span> <span data-ttu-id="d54c9-153">Также имеется указатель на требуемый закодированный BLOB-объект.</span><span class="sxs-lookup"><span data-stu-id="d54c9-153">There is also a pointer to the desired, encoded BLOB.</span></span>

<span data-ttu-id="d54c9-154">Сведения о кодировании C см. в разделе [Пример программы c: подписывание, кодирование, декодирование и проверка сообщения](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).</span><span class="sxs-lookup"><span data-stu-id="d54c9-154">For C coding details, see [Example C Program: Signing, Encoding, Decoding, and Verifying a Message](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).</span></span>

 

 
