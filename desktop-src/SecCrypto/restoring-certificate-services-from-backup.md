---
description: Показывает, как можно использовать функции резервного копирования служб сертификатов, чтобы восстановить и восстановить базу данных служб сертификатов и связанные с ней файлы.
ms.assetid: f4914f45-629d-4f24-8328-d7f27e8a0062
title: Восстановление служб сертификатов из резервной копии
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8f5adf46d802194909397a3b70483b3cf43bb409
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105684327"
---
# <a name="restoring-certificate-services-from-backup"></a><span data-ttu-id="0297c-103">Восстановление служб сертификатов из резервной копии</span><span class="sxs-lookup"><span data-stu-id="0297c-103">Restoring Certificate Services from Backup</span></span>

<span data-ttu-id="0297c-104">В следующем сценарии показано, как можно использовать функции резервного копирования служб сертификатов, чтобы восстановить и восстановить базу данных служб сертификатов и связанные с ней файлы.</span><span class="sxs-lookup"><span data-stu-id="0297c-104">The following scenario shows how the Certificate Services backup functions can be used to restore and recover a Certificate Services database and its associated files.</span></span> <span data-ttu-id="0297c-105">Процесс восстановления включает запись файлов, содержащихся в резервном наборе данных на диск.</span><span class="sxs-lookup"><span data-stu-id="0297c-105">The restoration process involves writing the files contained in a backup set to disk.</span></span> <span data-ttu-id="0297c-106">Вы можете восстановить несколько резервных наборов данных (одна полная резервная копия, а также ноль или более добавочных резервных копий), но все операции восстановления должны быть выполнены до начала процесса.</span><span class="sxs-lookup"><span data-stu-id="0297c-106">You may restore multiple backup sets (one full backup plus zero or more incremental backups), but all restores must be complete prior to beginning the recovery process.</span></span> <span data-ttu-id="0297c-107">Процесс восстановления включает в себя воспроизведение файлов журнала службами сертификации для обеспечения согласованности базы данных и файлов журнала, обеспечивая целостность базы данных.</span><span class="sxs-lookup"><span data-stu-id="0297c-107">The recovery process involves Certificate Services replaying log files to ensure database and log file consistency, thereby ensuring database integrity.</span></span> <span data-ttu-id="0297c-108">Этот сценарий иллюстрирует вызовы функций для восстановления резервных наборов данных и информирования служб сертификатов о параметрах восстановления.</span><span class="sxs-lookup"><span data-stu-id="0297c-108">The scenario illustrates the function calls to restore the backup sets and inform Certificate Services of the recovery parameters.</span></span>

<span data-ttu-id="0297c-109">Перед реализацией этого сценария должна существовать существующая полная резервная копия базы данных служб сертификации.</span><span class="sxs-lookup"><span data-stu-id="0297c-109">An existing full backup of the Certificate Services database must exist before implementing this scenario.</span></span>

1.  <span data-ttu-id="0297c-110">Загрузка библиотеки Certadm.dll в память (путем вызова [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="0297c-110">Load the Certadm.dll library into memory (by calling [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span>
2.  <span data-ttu-id="0297c-111">Извлеките адрес каждой из необходимых функций в Certadm.dll (с помощью [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span><span class="sxs-lookup"><span data-stu-id="0297c-111">Retrieve the address of each of the necessary functions in Certadm.dll (by means of [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span></span> <span data-ttu-id="0297c-112">Используйте эти адреса при вызове функций на оставшихся этапах.</span><span class="sxs-lookup"><span data-stu-id="0297c-112">Use these addresses when calling the functions in the remaining steps.</span></span>
3.  <span data-ttu-id="0297c-113">Вызовите [**цертсрвиссерверонлине**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) , чтобы определить, находятся ли службы сертификатов в сети.</span><span class="sxs-lookup"><span data-stu-id="0297c-113">Call [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) to determine whether Certificate Services is online.</span></span> <span data-ttu-id="0297c-114">Если службы сертификатов работают, завершите ее, прежде чем продолжать работу.</span><span class="sxs-lookup"><span data-stu-id="0297c-114">If Certificate Services is running, shut it down before proceeding.</span></span> <span data-ttu-id="0297c-115">Для успешного выполнения операции восстановления службы сертификатов не должны находиться в оперативном режиме.</span><span class="sxs-lookup"><span data-stu-id="0297c-115">Certificate Services must not be online for the restore operations to be successful.</span></span>
4.  <span data-ttu-id="0297c-116">Вызовите [**цертсрвресторепрепаре**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) , чтобы начать сеанс восстановления.</span><span class="sxs-lookup"><span data-stu-id="0297c-116">Call [**CertSrvRestorePrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) to begin a restore session.</span></span> <span data-ttu-id="0297c-117">Итоговый обработчик контекста резервного копирования служб сертификации будет использоваться несколькими другими функциями.</span><span class="sxs-lookup"><span data-stu-id="0297c-117">The resulting Certificate Services backup context handle will be used by several of the other functions.</span></span>
5.  <span data-ttu-id="0297c-118">Определите путь к расположению базы данных.</span><span class="sxs-lookup"><span data-stu-id="0297c-118">Determine the path for the database location.</span></span> <span data-ttu-id="0297c-119">Во время резервного копирования это значение было бы доступно из вызова [**цертсрвресторежетдатабаселокатионс**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw); Это значение должно храниться в составе резервной копии.</span><span class="sxs-lookup"><span data-stu-id="0297c-119">During a backup scenario, this value would have been available from a call to [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw); this value should have been stored as part of the backup.</span></span>
6.  <span data-ttu-id="0297c-120">Создайте карту восстановления, указав имя восстановленной базы данных.</span><span class="sxs-lookup"><span data-stu-id="0297c-120">Create a restore map specifying the name of the restored database.</span></span> <span data-ttu-id="0297c-121">Для указания схемы восстановления используется структура восстановления схемы базы данных служб сертификатов (КСЕДБ \_ рстмапв).</span><span class="sxs-lookup"><span data-stu-id="0297c-121">A Certificate Services database restore map structure (CSEDB\_RSTMAPW) is used to specify a restore map.</span></span> <span data-ttu-id="0297c-122">Задайте элемент \_ **пвсздатабасенаме** кседб Рстмапв и \_ элемент **рстмапв** кседб пвсзневдатабасенаме в соответствии с расположением базы данных, определенным на шаге 5.</span><span class="sxs-lookup"><span data-stu-id="0297c-122">Set the CSEDB\_RSTMAPW's **pwszDatabaseName** member and the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the database location determined in step 5.</span></span> <span data-ttu-id="0297c-123">Кроме того, если восстановленная база данных должна иметь имя, отличное от имени базы данных резервного копирования, задайте \_ для элемента **пвсзневдатабасенаме** кседб рстмапв имя новой базы данных.</span><span class="sxs-lookup"><span data-stu-id="0297c-123">Optionally, if the restored database is to have a different name than the backup database, set the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the new database name.</span></span>
7.  <span data-ttu-id="0297c-124">Если необходимо, чтобы изменения, внесенные в базу данных после выполнения резервного копирования, не применялись повторно после завершения восстановления базы данных (в ходе восстановления базы данных, выполненной во время следующего запуска служб сертификации), удалите файлы из активной базы данных целевого сервера и каталогов журналов.</span><span class="sxs-lookup"><span data-stu-id="0297c-124">If you want to ensure that modifications made to the database after the backup was performed are not reapplied after database restore is complete (as part of database recovery performed during the next Certificate Services startup), delete files from the target server's active database and log directories.</span></span>
8.  <span data-ttu-id="0297c-125">Скопируйте файлы, содержащиеся в полной резервной копии, в активную базу данных и каталоги журналов целевого сервера.</span><span class="sxs-lookup"><span data-stu-id="0297c-125">Copy the files contained in the full backup to the target server's active database and log directories.</span></span>
9.  <span data-ttu-id="0297c-126">Вызовите [**цертсрвресторерегистер**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) , чтобы зарегистрировать операцию восстановления для полной резервной копии.</span><span class="sxs-lookup"><span data-stu-id="0297c-126">Call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) to register a restore operation for the full backup.</span></span> <span data-ttu-id="0297c-127">**Цертсрвресторерегистер** использует карту восстановления, указанную на шаге 6.</span><span class="sxs-lookup"><span data-stu-id="0297c-127">**CertSrvRestoreRegister** uses the restore map specified in step 6.</span></span> <span data-ttu-id="0297c-128">**Цертсрвресторерегистер** также указывает расположение резервной копии базы данных и журналов.</span><span class="sxs-lookup"><span data-stu-id="0297c-128">**CertSrvRestoreRegister** also specifies the location of the backup database and logs.</span></span> <span data-ttu-id="0297c-129">Вызов **цертсрвресторерегистер** приведет к принудительной попытке службы сертификатов выполнить операцию восстановления при следующем запуске.</span><span class="sxs-lookup"><span data-stu-id="0297c-129">Calling **CertSrvRestoreRegister** will force Certificate Services to attempt a restore operation the next time it is started.</span></span> <span data-ttu-id="0297c-130">Он также предотвращает обработку запросов сертификатов службами сертификации до завершения восстановления.</span><span class="sxs-lookup"><span data-stu-id="0297c-130">It also prevents Certificate Services from processing Certificate Requests until the restoration is complete.</span></span>
10. <span data-ttu-id="0297c-131">Вызовите [**цертсрвресторерегистеркомплете**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), тем самым завершая действие регистрации, начатое на шаге 8.</span><span class="sxs-lookup"><span data-stu-id="0297c-131">Call [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), thereby finishing the registration activity that started in step 8.</span></span> <span data-ttu-id="0297c-132">Обратите внимание, что регистрация операции восстановления является инструкцией, которую службы сертификации должны следовать при запуске. Фактическое восстановление будет выполняться только после запуска служб сертификатов.</span><span class="sxs-lookup"><span data-stu-id="0297c-132">Note that the registration of a restore operation is an instruction for Certificate Services to follow when it is started; the actual recovery will take place only after Certificate Services is started.</span></span>
11. <span data-ttu-id="0297c-133">Для каждого восстанавливаемого добавочного резервного копирования скопируйте файлы, содержащиеся в добавочной резервной копии, в активный каталог журнала целевого сервера, затем вызовите [**цертсрвресторерегистер**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw), а затем — вызов [**цертсрвресторерегистеркомплете**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete).</span><span class="sxs-lookup"><span data-stu-id="0297c-133">For each incremental backup to be restored, copy the files contained in the incremental backup to the target server's active log directory, then call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw), followed by a call to [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete).</span></span> <span data-ttu-id="0297c-134">Регистрация добавочных резервных копий для восстановления может выполняться в любом порядке, но только набор файлов для одной добавочной резервной копии должен быть скопирован на сервер перед каждым вызовом в **цертсрвресторерегистер**.</span><span class="sxs-lookup"><span data-stu-id="0297c-134">The registration of the incremental backups for restoration can occur in any order, but only the set of files for one incremental backup should be copied to the server before each call to **CertSrvRestoreRegister**.</span></span>
12. <span data-ttu-id="0297c-135">Скопируйте динамические файлы служб сертификатов на целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="0297c-135">Copy the Certificate Services dynamic files to the target server.</span></span> <span data-ttu-id="0297c-136">Динамические файлы были бы обнаружены во время резервного копирования при вызове [**цертсрвбаккупжетдинамикфилелист**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) .</span><span class="sxs-lookup"><span data-stu-id="0297c-136">The dynamic files would have been identified during the backup when [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) was called.</span></span> <span data-ttu-id="0297c-137">Может потребоваться отключить службу веб-публикаций, чтобы разрешить перезапись динамических файлов.</span><span class="sxs-lookup"><span data-stu-id="0297c-137">It may be necessary to stop the World Wide Web Publishing Service to allow overwriting the dynamic files.</span></span>
13. <span data-ttu-id="0297c-138">Вызовите [**цертсрвресторинд**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) , чтобы завершить сеанс восстановления.</span><span class="sxs-lookup"><span data-stu-id="0297c-138">Call [**CertSrvRestoreEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) to end the restore session.</span></span>
14. <span data-ttu-id="0297c-139">Запустите приложение служб сертификатов вручную (или дождитесь его следующей перезагрузки, чтобы он автоматически запускался).</span><span class="sxs-lookup"><span data-stu-id="0297c-139">Start the Certificate Services application manually (or wait until the next restart for it to start automatically).</span></span> <span data-ttu-id="0297c-140">При запуске служб сертификатов будет определена, была ли зарегистрирована операция восстановления. Если операция восстановления была зарегистрирована, Служба сертификатов начнет восстановление.</span><span class="sxs-lookup"><span data-stu-id="0297c-140">When Certificate Services starts, it will determine whether a restore operation has been registered; if a restore operation has been registered, Certificate Services will begin the recovery.</span></span> <span data-ttu-id="0297c-141">Службы сертификатов не будут обрабатывать запросы на сертификаты до завершения операции восстановления.</span><span class="sxs-lookup"><span data-stu-id="0297c-141">Certificate Services will not process any certificate requests until the recovery operation is completed.</span></span>

> [!Note]  
> <span data-ttu-id="0297c-142">После завершения восстановления важно создать новую полную резервную копию базы данных служб сертификации.</span><span class="sxs-lookup"><span data-stu-id="0297c-142">When a recovery is complete, it is important that you make a new full backup of the Certificate Services database.</span></span> <span data-ttu-id="0297c-143">Это необходимо для усечения восстановленных файлов журнала и для создания базового резервного набора данных для будущих восстановлений.</span><span class="sxs-lookup"><span data-stu-id="0297c-143">This is necessary to truncate the restored log files and to establish a base backup set for future restores.</span></span> <span data-ttu-id="0297c-144">Резервные копии, выполненные после восстановления, нельзя смешивать с резервными копиями (полными или добавочными), выполненными перед восстановлением. то есть после восстановления базы данных служб сертификатов и ее последующего состояния нельзя использовать резервные копии перед восстановлением, чтобы восстановить базу данных в это последующее состояние.</span><span class="sxs-lookup"><span data-stu-id="0297c-144">Backups performed after a restore cannot be mixed with backups (full or incremental) taken before the restore; that is, after a certificate services database is restored and has progressed to a subsequent state, you cannot use the pre-restoration backups to restore the database to that subsequent state.</span></span>

 

 

 
