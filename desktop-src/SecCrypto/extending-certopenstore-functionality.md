---
description: Хранилище сертификатов является центральным для всех операций управления сертификатами.
ms.assetid: e5c7c882-cbfc-4343-952c-b13c67326756
title: Расширение функциональных возможностей Цертопенсторе
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4cce198578cc482ba0488bd97ae0f1d7f923511b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104560832"
---
# <a name="extending-certopenstore-functionality"></a><span data-ttu-id="bc73a-103">Расширение функциональных возможностей Цертопенсторе</span><span class="sxs-lookup"><span data-stu-id="bc73a-103">Extending CertOpenStore Functionality</span></span>

<span data-ttu-id="bc73a-104">[*Хранилище сертификатов*](../secgloss/c-gly.md) является центральным для всех операций управления сертификатами.</span><span class="sxs-lookup"><span data-stu-id="bc73a-104">The [*certificate store*](../secgloss/c-gly.md) is central to all certificate management operations.</span></span> <span data-ttu-id="bc73a-105">Функциональность функции [**цертопенсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certopenstore) можно расширить с помощью устанавливаемой (или зарегистрированной) функции поставщика хранилища сертификатов.</span><span class="sxs-lookup"><span data-stu-id="bc73a-105">The functionality of the [**CertOpenStore**](/windows/win32/api/Wincrypt/nf-wincrypt-certopenstore) function can be extended through the use of an installable (or registered) certificate-store-provider function.</span></span> <span data-ttu-id="bc73a-106">Общие сведения об установке и регистрации функций для использования с CryptoAPI см. в разделе [Общие сведения о OID](oid-overview.md).</span><span class="sxs-lookup"><span data-stu-id="bc73a-106">For an overview of how to install or register functions for use with the CryptoAPI, see [OID Overview](oid-overview.md).</span></span>

> [!Note]  
> <span data-ttu-id="bc73a-107">Пользовательские хранилища сертификатов не переносятся автоматически при выполнении автоматических развертываний.</span><span class="sxs-lookup"><span data-stu-id="bc73a-107">Custom certificate stores are not automatically migrated when performing automated deployments.</span></span> <span data-ttu-id="bc73a-108">Чтобы перенести пользовательские хранилища сертификатов, необходимо создать манифест для переноса пользовательских хранилищ и использовать средство миграции пользовательской среды Windows (USMT).</span><span class="sxs-lookup"><span data-stu-id="bc73a-108">To migrate custom certificate stores, you must create a manifest for migrating the custom stores and use the Windows User State Migration Tool (USMT).</span></span> <span data-ttu-id="bc73a-109">Средство USMT доступно для загрузки в центре загрузки Майкрософт по адресу <https://www.microsoft.com/download/details.aspx?id=10837> .</span><span class="sxs-lookup"><span data-stu-id="bc73a-109">The USMT is available for download from the Microsoft Download Center at <https://www.microsoft.com/download/details.aspx?id=10837>.</span></span>

 

<span data-ttu-id="bc73a-110">[**Цертопенсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certopenstore) открывает пустое хранилище в памяти и вызывает функцию поставщика хранилища (если она зарегистрирована или установлена) с помощью [*идентификатора объекта*](../secgloss/o-gly.md) (OID), переданного в параметре *лпсзсторепровидер* .</span><span class="sxs-lookup"><span data-stu-id="bc73a-110">[**CertOpenStore**](/windows/win32/api/Wincrypt/nf-wincrypt-certopenstore) opens an empty store in memory and calls the store provider function (if it is registered or installed) by using the [*object identifier*](../secgloss/o-gly.md) (OID) that was passed in the *lpszStoreProvider* parameter.</span></span> <span data-ttu-id="bc73a-111">Список стандартных типов поставщиков, предоставляемых с помощью CryptoAPI, см. в разделе **цертопенсторе**.</span><span class="sxs-lookup"><span data-stu-id="bc73a-111">For a list of the predefined provider types that are supplied with the CryptoAPI, see **CertOpenStore**.</span></span>

<span data-ttu-id="bc73a-112">Функция поставщика хранилища копирует свои сертификаты и [*списки отзыва сертификатов*](../secgloss/c-gly.md) (CRL) в хранилище в памяти, заданное *хцертстореным* обработчиком.</span><span class="sxs-lookup"><span data-stu-id="bc73a-112">The store provider function copies its certificates and [*certificate revocation lists*](../secgloss/c-gly.md) (CRLs) to the in-memory store specified by the *hCertStore* handle passed to it.</span></span> <span data-ttu-id="bc73a-113">Новая функция поставщика хранилища может использовать любые функции хранилища сертификатов CryptoAPI, такие как, [**цертаддцертификатеконтексттосторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certaddcertificatecontexttostore) или [**цертаддсериализеделементтосторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certaddserializedelementtostore), чтобы добавить свои сертификаты и списки отзыва сертификатов в хранилище в памяти.</span><span class="sxs-lookup"><span data-stu-id="bc73a-113">The new store provider function can use any of the CryptoAPI certificate store functions, such as, [**CertAddCertificateContextToStore**](/windows/win32/api/Wincrypt/nf-wincrypt-certaddcertificatecontexttostore) or [**CertAddSerializedElementToStore**](/windows/win32/api/Wincrypt/nf-wincrypt-certaddserializedelementtostore), to add its certificates and CRLs to the in-memory store.</span></span> <span data-ttu-id="bc73a-114">Кроме того, функция Store-provider при необходимости возвращает значения для всех элементов данных структуры [**\_ \_ Prov \_ info хранилища сертификатов**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_store_prov_info) .</span><span class="sxs-lookup"><span data-stu-id="bc73a-114">In addition, the store-provider function optionally returns values for all of the data members of the [**CERT\_STORE\_PROV\_INFO**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_store_prov_info) structure.</span></span> <span data-ttu-id="bc73a-115">Функция должна обновить эту структуру только в том случае, если она поддерживает дополнительные функции обратного вызова.</span><span class="sxs-lookup"><span data-stu-id="bc73a-115">The function only needs to update this structure if it supports additional callback functions.</span></span> <span data-ttu-id="bc73a-116">Например, если хранилище должно быть хранилищем только для чтения, то поддержка других функций обратного вызова, вероятно, не потребуется.</span><span class="sxs-lookup"><span data-stu-id="bc73a-116">For example, if the store was to be a read-only store, the support of other callback functions probably would not be needed.</span></span> <span data-ttu-id="bc73a-117">Дополнительные сведения и прототипы возможных функций обратного вызова см. в разделе [функции обратного вызова поставщика хранилища сертификатов](cryptography-functions.md).</span><span class="sxs-lookup"><span data-stu-id="bc73a-117">For details and prototypes of the possible callback functions, see [Certificate Store Provider Callback Functions](cryptography-functions.md).</span></span>

<span data-ttu-id="bc73a-118">Хранилище TrustedPeople на пользователя ограничено стандартными физическими хранилищами.</span><span class="sxs-lookup"><span data-stu-id="bc73a-118">The per user TrustedPeople store is restricted to predefined physical stores.</span></span> <span data-ttu-id="bc73a-119">Вы не можете расширить TrustedPeople хранилище "на пользователя".</span><span class="sxs-lookup"><span data-stu-id="bc73a-119">You cannot extend the per user TrustedPeople store.</span></span> <span data-ttu-id="bc73a-120">Однако можно расширить хранилище TrustedPeople локального компьютера.</span><span class="sxs-lookup"><span data-stu-id="bc73a-120">However, you can extend the local machine TrustedPeople store.</span></span>

<span data-ttu-id="bc73a-121">**Windows XP и Windows Server 2003:** Хранилище TrustedPeople на пользователя не ограничено предопределенными физическими хранилищами.</span><span class="sxs-lookup"><span data-stu-id="bc73a-121">**Windows XP and Windows Server 2003:** The per user TrustedPeople store is not restricted to predefined physical stores.</span></span>

<span data-ttu-id="bc73a-122">Одним из элементов данных структуры [**\_ \_ Prov \_ info хранилища сертификатов**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_store_prov_info) является массив *ргпвсторепровфунк* .</span><span class="sxs-lookup"><span data-stu-id="bc73a-122">One of the data members of the [**CERT\_STORE\_PROV\_INFO**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_store_prov_info) structure is the *rgpvStoreProvFunc* array.</span></span> <span data-ttu-id="bc73a-123">Если функция поставщика хранилища должна поддерживать одну или несколько функций обратного вызова, она должна предоставлять указатели для этого массива.</span><span class="sxs-lookup"><span data-stu-id="bc73a-123">If the store provider function needs to support one or more of the callback functions, it must provide pointers for this array.</span></span> <span data-ttu-id="bc73a-124">Эти указатели должны указывать на функции обратного вызова, которые будут использоваться для других действий хранилища сертификатов (например, закрытие хранилища).</span><span class="sxs-lookup"><span data-stu-id="bc73a-124">These pointers must point to the callback functions that are to be used for other certificate-store activities (such as closing the store).</span></span> <span data-ttu-id="bc73a-125">На следующем рисунке показан поток этого процесса.</span><span class="sxs-lookup"><span data-stu-id="bc73a-125">The following illustration shows the flow of this process.</span></span>

![функции цертопенсторе](images/openstor.png)

<span data-ttu-id="bc73a-127">Как показано на следующем рисунке, после открытия хранилища другие функции CryptoAPI (например, [**цертклосесторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certclosestore)) используют массив указателей для доступа к функциям обратного вызова, выполняющим предполагаемую задачу.</span><span class="sxs-lookup"><span data-stu-id="bc73a-127">As shown in the following illustration, after the store has been opened, other CryptoAPI functions (such as [**CertCloseStore**](/windows/win32/api/Wincrypt/nf-wincrypt-certclosestore)) use the array of pointers to access the callback functions that perform the intended task.</span></span> <span data-ttu-id="bc73a-128">Определение [**\_ \_ \_ информационной структуры Prov хранилища**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_store_prov_info) сертификатов и прототипов функций обратного вызова по умолчанию, предоставляемых с помощью CryptoAPI, показаны в [функциях обратного вызова поставщика хранилища сертификатов](cryptography-functions.md).</span><span class="sxs-lookup"><span data-stu-id="bc73a-128">The definition of the [**CERT\_STORE\_PROV\_INFO**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_store_prov_info) structure and the prototypes of the default callback functions that are supplied with the CryptoAPI are shown in [Certificate Store Provider Callback Functions](cryptography-functions.md).</span></span>

![функции цертклосесторе](images/closstor.png)

<span data-ttu-id="bc73a-130">API-интерфейсы магазина позволяют поставщику услуг магазина поддерживать сертификаты, списки отзыва сертификатов и [*списков доверия сертификатов*](../secgloss/c-gly.md) (CTL) за пределами кэша хранилища (например, внешней базы данных сертификатов, например, предоставленной базой данных Microsoft Certificate Server).</span><span class="sxs-lookup"><span data-stu-id="bc73a-130">The store APIs allow a store provider to maintain the certificates, CRLs, and [*certificate trust lists*](../secgloss/c-gly.md) (CTLs) outside the cache of the store (for example, an external database of certificates, such as provided by the Microsoft Certificate Server Database).</span></span>

<span data-ttu-id="bc73a-131">[**Цертопенсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certopenstore) отправляет через параметр *Псзсторепровидер* в соответствующую [**цертдллопенсторепров**](/windows/win32/api/Wincrypt/nc-wincrypt-pfn_cert_dll_open_store_prov_func) функцию устанавливаемого поставщика.</span><span class="sxs-lookup"><span data-stu-id="bc73a-131">[**CertOpenStore**](/windows/win32/api/Wincrypt/nf-wincrypt-certopenstore) dispatches through the *pszStoreProvider* parameter to the appropriate [**CertDllOpenStoreProv**](/windows/win32/api/Wincrypt/nc-wincrypt-pfn_cert_dll_open_store_prov_func) installable provider function.</span></span> <span data-ttu-id="bc73a-132">Поставщик возвращает сведения в параметре *псторепровинфо* , который указывает на структуру [**\_ \_ Prov \_ info хранилища сертификатов**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_store_prov_info) .</span><span class="sxs-lookup"><span data-stu-id="bc73a-132">The provider returns information in the *pStoreProvInfo* parameter that points to a [**CERT\_STORE\_PROV\_INFO**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_store_prov_info) structure.</span></span> <span data-ttu-id="bc73a-133">Структура **\_ \_ \_ сведений о Prov хранилища сертификатов** содержит элемент **двсторепровфлагс** .</span><span class="sxs-lookup"><span data-stu-id="bc73a-133">The **CERT\_STORE\_PROV\_INFO** structure contains a **dwStoreProvFlags** member.</span></span> <span data-ttu-id="bc73a-134">\_ \_ \_ Был добавлен флаг внешнего флага хранилища сертификатов Prov, позволяющий \_ поставщику указать, что сертификаты, списки отзыва сертификатов и списки CTL являются внешними по отношению к кэшу хранилища.</span><span class="sxs-lookup"><span data-stu-id="bc73a-134">The CERT\_STORE\_PROV\_EXTERNAL\_FLAG flag was added to allow the provider to indicate that the certificates, CRLs, and CTLs are external to the cache of the store.</span></span>

<span data-ttu-id="bc73a-135">[**Цертдллопенсторепров**](/windows/win32/api/Wincrypt/nc-wincrypt-pfn_cert_dll_open_store_prov_func) возвращает массив функций обратного вызова.</span><span class="sxs-lookup"><span data-stu-id="bc73a-135">[**CertDllOpenStoreProv**](/windows/win32/api/Wincrypt/nc-wincrypt-pfn_cert_dll_open_store_prov_func) returns an array of callback functions.</span></span> <span data-ttu-id="bc73a-136">Поставщик может реализовать следующие функции обратного вызова:</span><span class="sxs-lookup"><span data-stu-id="bc73a-136">A provider can implement the following callback functions:</span></span>

-   <span data-ttu-id="bc73a-137">\_ \_ Prov \_ закрытие Func хранилища \_ сертификатов</span><span class="sxs-lookup"><span data-stu-id="bc73a-137">CERT\_STORE\_PROV\_CLOSE\_FUNC</span></span>
-   <span data-ttu-id="bc73a-138">сертификат \_ хранилища сертификатов \_ Prov \_ Чтение \_ сертификата \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-138">CERT\_STORE\_PROV\_READ\_CERT\_FUNC</span></span>
-   <span data-ttu-id="bc73a-139">\_хранилище сертификатов \_ Prov \_ запись \_ сертификата \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-139">CERT\_STORE\_PROV\_WRITE\_CERT\_FUNC</span></span>
-   <span data-ttu-id="bc73a-140">\_хранилище сертификатов \_ Prov \_ удалить \_ сертификат \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-140">CERT\_STORE\_PROV\_DELETE\_CERT\_FUNC</span></span>
-   <span data-ttu-id="bc73a-141">\_хранилище сертификатов \_ Prov \_ Set \_ CERT \_ Property \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-141">CERT\_STORE\_PROV\_SET\_CERT\_PROPERTY\_FUNC</span></span>
-   <span data-ttu-id="bc73a-142">\_хранилище сертификатов \_ Prov \_ Чтение \_ CRL \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-142">CERT\_STORE\_PROV\_READ\_CRL\_FUNC</span></span>
-   <span data-ttu-id="bc73a-143">\_хранилище сертификатов \_ Prov \_ запись \_ CRL \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-143">CERT\_STORE\_PROV\_WRITE\_CRL\_FUNC</span></span>
-   <span data-ttu-id="bc73a-144">\_хранилище сертификатов \_ Prov \_ удалить \_ CRL \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-144">CERT\_STORE\_PROV\_DELETE\_CRL\_FUNC</span></span>
-   <span data-ttu-id="bc73a-145">\_хранилище сертификатов \_ Prov \_ задать \_ \_ свойство CRL \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-145">CERT\_STORE\_PROV\_SET\_CRL\_PROPERTY\_FUNC</span></span>
-   <span data-ttu-id="bc73a-146">\_хранилище сертификатов \_ Prov \_ Чтение \_ CTL \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-146">CERT\_STORE\_PROV\_READ\_CTL\_FUNC</span></span>
-   <span data-ttu-id="bc73a-147">\_хранилище сертификатов \_ Prov \_ запись \_ CTL \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-147">CERT\_STORE\_PROV\_WRITE\_CTL\_FUNC</span></span>
-   <span data-ttu-id="bc73a-148">\_хранилище сертификатов \_ Prov \_ удалить \_ CTL \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-148">CERT\_STORE\_PROV\_DELETE\_CTL\_FUNC</span></span>
-   <span data-ttu-id="bc73a-149">\_хранилище сертификатов \_ Prov \_ задать \_ \_ свойство CTL \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-149">CERT\_STORE\_PROV\_SET\_CTL\_PROPERTY\_FUNC</span></span>

<span data-ttu-id="bc73a-150">При обращении к \_ сертификату записи, записи \_ списка отзыва сертификатов и записи \_ функций обратного вызова CTL, если \_ \_ установлен флаг Prov Write для хранилища сертификатов \_ \_ \_ , верхние 16 разрядов параметра *dwFlags* содержат значение *двадддиспоситион* .</span><span class="sxs-lookup"><span data-stu-id="bc73a-150">On calls to the WRITE\_CERT, WRITE\_CRL, and WRITE\_CTL callback functions when the CERT\_STORE\_PROV\_WRITE\_ADD\_FLAG is set, the upper 16 bits of the *dwFlags* parameter contains the *dwAddDisposition* value.</span></span> <span data-ttu-id="bc73a-151">Для поддержки внешних хранилищ поставщик может реализовать следующие функции обратного вызова:</span><span class="sxs-lookup"><span data-stu-id="bc73a-151">To support external stores, a provider can implement the following callback functions:</span></span>

-   <span data-ttu-id="bc73a-152">\_хранилище сертификатов \_ Prov \_ найти \_ сертификат \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-152">CERT\_STORE\_PROV\_FIND\_CERT\_FUNC</span></span>
-   <span data-ttu-id="bc73a-153">\_хранилище сертификатов \_ Prov \_ бесплатный \_ Поиск \_ сертификата \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-153">CERT\_STORE\_PROV\_FREE\_FIND\_CERT\_FUNC</span></span>
-   <span data-ttu-id="bc73a-154">\_хранилище сертификатов \_ Prov \_ получения \_ \_ Свойства сертификата \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-154">CERT\_STORE\_PROV\_GET\_CERT\_PROPERTY\_FUNC</span></span>
-   <span data-ttu-id="bc73a-155">\_хранилище сертификатов \_ Prov \_ найти \_ CRL \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-155">CERT\_STORE\_PROV\_FIND\_CRL\_FUNC</span></span>
-   <span data-ttu-id="bc73a-156">\_хранилище сертификатов \_ Prov \_ бесплатный \_ Поиск \_ CRL \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-156">CERT\_STORE\_PROV\_FREE\_FIND\_CRL\_FUNC</span></span>
-   <span data-ttu-id="bc73a-157">\_ \_ Prov \_ получения \_ свойства CRL хранилища \_ сертификатов \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-157">CERT\_STORE\_PROV\_GET\_CRL\_PROPERTY\_FUNC</span></span>
-   <span data-ttu-id="bc73a-158">\_хранилище сертификатов \_ Prov \_ найти \_ CTL \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-158">CERT\_STORE\_PROV\_FIND\_CTL\_FUNC</span></span>
-   <span data-ttu-id="bc73a-159">\_хранилище сертификатов \_ Prov \_ бесплатный \_ Поиск \_ CTL \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-159">CERT\_STORE\_PROV\_FREE\_FIND\_CTL\_FUNC</span></span>
-   <span data-ttu-id="bc73a-160">\_ \_ Prov \_ получения \_ Свойства CTL хранилища \_ сертификатов \_ Func</span><span class="sxs-lookup"><span data-stu-id="bc73a-160">CERT\_STORE\_PROV\_GET\_CTL\_PROPERTY\_FUNC</span></span>

<span data-ttu-id="bc73a-161">Функции обратного вызова сертификата имеют следующие сигнатуры:</span><span class="sxs-lookup"><span data-stu-id="bc73a-161">The certificate callback functions have the following signatures:</span></span>

``` syntax
typedef struct _CERT_STORE_PROV_FIND_INFO {
    DWORD               cbSize;
    DWORD               dwMsgAndCertEncodingType;
    DWORD               dwFindFlags;
    DWORD               dwFindType;
    const void          *pvFindPara;
} CERT_STORE_PROV_FIND_INFO, *PCERT_STORE_PROV_FIND_INFO;
typedef const CERT_STORE_PROV_FIND_INFO CCERT_STORE_PROV_FIND_INFO,
    *PCCERT_STORE_PROV_FIND_INFO;

typedef BOOL (WINAPI *PFN_CERT_STORE_PROV_FIND_CERT)(
        IN HCERTSTOREPROV hStoreProv,
        IN PCCERT_STORE_PROV_FIND_INFO pFindInfo,
        IN PCCERT_CONTEXT pPrevCertContext,
        IN DWORD dwFlags,
        IN OUT void **ppvStoreProvFindInfo,
        OUT PCCERT_CONTEXT *ppProvCertContext
        );

typedef BOOL (WINAPI *PFN_CERT_STORE_PROV_FREE_FIND_CERT)(
        IN HCERTSTOREPROV hStoreProv,
        IN PCCERT_CONTEXT pCertContext,
        IN void *pvStoreProvFindInfo,
        IN DWORD dwFlags
        );

typedef BOOL (WINAPI *PFN_CERT_STORE_PROV_GET_CERT_PROPERTY)(
        IN HCERTSTOREPROV hStoreProv,
        IN PCCERT_CONTEXT pCertContext,
        IN DWORD dwPropId,
        IN DWORD dwFlags,
        OUT void *pvData,
        IN OUT DWORD *pcbData
        );
```

<span data-ttu-id="bc73a-162">Сигнатуры для функций обратного вызова списка отзыва сертификатов и CTL идентичны с указателем на [**\_ контекст сертификата**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_context) , замененным указателем на [**\_ контекст списка отзыва сертификатов**](/windows/win32/api/Wincrypt/ns-wincrypt-crl_context) или [**\_ контекст CTL**](/windows/win32/api/Wincrypt/ns-wincrypt-ctl_context).</span><span class="sxs-lookup"><span data-stu-id="bc73a-162">The signatures for the CRL and CTL callback functions are identical to the above with the pointer to the [**CERT\_CONTEXT**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_context) replaced with a pointer to a [**CRL\_CONTEXT**](/windows/win32/api/Wincrypt/ns-wincrypt-crl_context) or [**CTL\_CONTEXT**](/windows/win32/api/Wincrypt/ns-wincrypt-ctl_context).</span></span>

<span data-ttu-id="bc73a-163">\_Обратный вызов Find Certificate вызывается при перечислении, поиске или добавлении сертификатов API-интерфейсам хранилища.</span><span class="sxs-lookup"><span data-stu-id="bc73a-163">The FIND\_CERT callback is called when the store APIs enumerate, find, or add certificates.</span></span> <span data-ttu-id="bc73a-164">*ппревцертконтекст* и *Ппвсторепровфиндинфо* имеют значение **null** для инициации нового поиска.</span><span class="sxs-lookup"><span data-stu-id="bc73a-164">*pPrevCertContext* and *ppvStoreProvFindInfo* are set to **NULL** to initiate a new FIND.</span></span> <span data-ttu-id="bc73a-165">Возвращенный *ппвсторепровфиндинфо* передается обратно при следующем поиске, когда он может быть освобожден поставщиком.</span><span class="sxs-lookup"><span data-stu-id="bc73a-165">The returned *ppvStoreProvFindInfo* is passed back on the next find at which time it may be freed by the provider.</span></span> <span data-ttu-id="bc73a-166">Поставщик может задать все, некоторые или ни одно из свойств сертификата.</span><span class="sxs-lookup"><span data-stu-id="bc73a-166">The provider may set all, some, or none of the certificate properties.</span></span> <span data-ttu-id="bc73a-167">Поставщик имеет возможность отложить до \_ \_ вызова свойства Get CERT.</span><span class="sxs-lookup"><span data-stu-id="bc73a-167">The provider has the option to defer until the GET\_CERT\_PROPERTY callback is called.</span></span> <span data-ttu-id="bc73a-168">Рекомендуется, чтобы поставщики установили максимально возможное количество свойств, чтобы разрешить копирование в другое хранилище.</span><span class="sxs-lookup"><span data-stu-id="bc73a-168">It is recommended for providers to set as many properties as possible to allow copying to another store.</span></span>

<span data-ttu-id="bc73a-169">В [**цертфиндцертификатеинсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certfindcertificateinstore)поддерживаются следующие типы поиска сертификатов:</span><span class="sxs-lookup"><span data-stu-id="bc73a-169">The following certificate find types are supported in [**CertFindCertificateInStore**](/windows/win32/api/Wincrypt/nf-wincrypt-certfindcertificateinstore):</span></span>

-   <span data-ttu-id="bc73a-170">\_Поиск сертификата \_</span><span class="sxs-lookup"><span data-stu-id="bc73a-170">CERT\_FIND\_ANY</span></span>
-   <span data-ttu-id="bc73a-171">\_Поиск сертификата \_ по \_ хэшу SHA1</span><span class="sxs-lookup"><span data-stu-id="bc73a-171">CERT\_FIND\_SHA1\_HASH</span></span>
-   <span data-ttu-id="bc73a-172">\_Поиск сертификата \_ MD5 \_ hash</span><span class="sxs-lookup"><span data-stu-id="bc73a-172">CERT\_FIND\_MD5\_HASH</span></span>
-   <span data-ttu-id="bc73a-173">\_свойство поиска \_ сертификатов</span><span class="sxs-lookup"><span data-stu-id="bc73a-173">CERT\_FIND\_PROPERTY</span></span>
-   <span data-ttu-id="bc73a-174">\_Поиск \_ открытого \_ ключа сертификата</span><span class="sxs-lookup"><span data-stu-id="bc73a-174">CERT\_FIND\_PUBLIC\_KEY</span></span>
-   <span data-ttu-id="bc73a-175">\_Поиск \_ имени субъекта \_ в сертификате</span><span class="sxs-lookup"><span data-stu-id="bc73a-175">CERT\_FIND\_SUBJECT\_NAME</span></span>
-   <span data-ttu-id="bc73a-176">\_найти \_ attr субъекта \_ в сертификате</span><span class="sxs-lookup"><span data-stu-id="bc73a-176">CERT\_FIND\_SUBJECT\_ATTR</span></span>
-   <span data-ttu-id="bc73a-177">\_Поиск \_ имени издателя \_ сертификата</span><span class="sxs-lookup"><span data-stu-id="bc73a-177">CERT\_FIND\_ISSUER\_NAME</span></span>
-   <span data-ttu-id="bc73a-178">СЕРТИФИКАТ поиска с атрибутом \_ \_ Issuer \_</span><span class="sxs-lookup"><span data-stu-id="bc73a-178">CERT\_FIND\_ISSUER\_ATTR</span></span>
-   <span data-ttu-id="bc73a-179">\_Поиск \_ и определение субъекта \_ \_ в str</span><span class="sxs-lookup"><span data-stu-id="bc73a-179">CERT\_FIND\_SUBJECT\_STR\_A</span></span>
-   <span data-ttu-id="bc73a-180">Поиск в выпуске " \_ \_ \_ строка темы \_ W"</span><span class="sxs-lookup"><span data-stu-id="bc73a-180">CERT\_FIND\_SUBJECT\_STR\_W</span></span>
-   <span data-ttu-id="bc73a-181">\_Поиск сертификата \_ \_ — строка \_ издателя</span><span class="sxs-lookup"><span data-stu-id="bc73a-181">CERT\_FIND\_ISSUER\_STR\_A</span></span>
-   <span data-ttu-id="bc73a-182">\_Поиск сертификата \_ — \_ строка \_ издателя</span><span class="sxs-lookup"><span data-stu-id="bc73a-182">CERT\_FIND\_ISSUER\_STR\_W</span></span>
-   <span data-ttu-id="bc73a-183">\_Спецификация поиска \_ ключа \_ сертификата</span><span class="sxs-lookup"><span data-stu-id="bc73a-183">CERT\_FIND\_KEY\_SPEC</span></span>
-   <span data-ttu-id="bc73a-184">\_Поиск \_ ЕНХКЭЙ \_ использования сертификата</span><span class="sxs-lookup"><span data-stu-id="bc73a-184">CERT\_FIND\_ENHKEY\_USAGE</span></span>

<span data-ttu-id="bc73a-185">\_Обратный вызов Find CERT вызывается для каждого из перечисленных выше типов поиска.</span><span class="sxs-lookup"><span data-stu-id="bc73a-185">The FIND\_CERT callback is called for each of the above find types.</span></span> <span data-ttu-id="bc73a-186">Параметры, передаваемые в [**цертфиндцертификатеинсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certfindcertificateinstore) , копируются непосредственно в \_ хранилище сертификатов \_ Prov \_ найти \_ структуру сведений перед \_ вызовом функции "найти сертификат".</span><span class="sxs-lookup"><span data-stu-id="bc73a-186">The parameters passed to [**CertFindCertificateInStore**](/windows/win32/api/Wincrypt/nf-wincrypt-certfindcertificateinstore) are copied directly to the CERT\_STORE\_PROV\_FIND\_INFO structure before the FIND\_CERT callback is called.</span></span> <span data-ttu-id="bc73a-187">Дополнительные сведения о значениях полей для различных типов поиска в \_ структуре Certificate Store \_ Prov \_ Find \_ info см. в разделе **цертфиндцертификатеинсторе**.</span><span class="sxs-lookup"><span data-stu-id="bc73a-187">For details about the field values for the different find types of the CERT\_STORE\_PROV\_FIND\_INFO structure, see **CertFindCertificateInStore**.</span></span>

<span data-ttu-id="bc73a-188">Следующие типы поиска сертификатов поддерживают API [**цертжетсубжектцертификатефромсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certgetsubjectcertificatefromstore) и [**цертжетиссуерцертификатефромсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certgetissuercertificatefromstore) и помогают определить, существует ли уже сертификат в хранилище перед добавлением:</span><span class="sxs-lookup"><span data-stu-id="bc73a-188">The following certificate find types support the [**CertGetSubjectCertificateFromStore**](/windows/win32/api/Wincrypt/nf-wincrypt-certgetsubjectcertificatefromstore) and [**CertGetIssuerCertificateFromStore**](/windows/win32/api/Wincrypt/nf-wincrypt-certgetissuercertificatefromstore) APIs and help determine whether the certificate already exists in the store before adding:</span></span>

-   <span data-ttu-id="bc73a-189">СЕРТИФИКАТ \_ поиска \_ субъекта \_ сертификата</span><span class="sxs-lookup"><span data-stu-id="bc73a-189">CERT\_FIND\_SUBJECT\_CERT</span></span>
-   <span data-ttu-id="bc73a-190">\_Поиск \_ поставщика \_ сертификата</span><span class="sxs-lookup"><span data-stu-id="bc73a-190">CERT\_FIND\_ISSUER\_OF</span></span>
-   <span data-ttu-id="bc73a-191">\_Поиск \_ существующего сертификата</span><span class="sxs-lookup"><span data-stu-id="bc73a-191">CERT\_FIND\_EXISTING</span></span>

<span data-ttu-id="bc73a-192">Для сертификата \_ Поиск \_ субъекта \_ сертификата параметр *пвфиндпара* указывает на структуру [**\_ сведений о сертификате**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_info) , содержащую издателя и серийный номер субъекта.</span><span class="sxs-lookup"><span data-stu-id="bc73a-192">For CERT\_FIND\_SUBJECT\_CERT, the *pvFindPara* parameter points to a [**CERT\_INFO**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_info) structure that contains the Issuer and SerialNumber of the subject.</span></span> <span data-ttu-id="bc73a-193">Для сертификата \_ найти \_ издатель \_ , *пвфиндпара* указывает на структуру [**\_ контекста сертификата**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_context) субъекта.</span><span class="sxs-lookup"><span data-stu-id="bc73a-193">For CERT\_FIND\_ISSUER\_OF, *pvFindPara* points to a [**CERT\_CONTEXT**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_context) structure, of the subject.</span></span> <span data-ttu-id="bc73a-194">\_ \_ Чтобы найти существующий сертификат, *пвфиндпара* указывает на **\_ контекст** сертификата, чтобы проверить его существование в хранилище.</span><span class="sxs-lookup"><span data-stu-id="bc73a-194">For CERT\_FIND\_EXISTING, *pvFindPara* points to a **CERT\_CONTEXT** of the certificate to check for its existence in the store.</span></span>

<span data-ttu-id="bc73a-195">Обратный вызов по БЕСПЛАТНОму \_ поиску сертификата \_ вызывается, когда сертификат, возвращенный функцией \_ обратного вызова find CERT, не был освобожден с помощью в последующем следующем поиске \_ сертификата, поэтому значение [*счетчика ссылок*](../secgloss/r-gly.md) уменьшается до нуля или освобождается вызовом [**цертклосесторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certclosestore).</span><span class="sxs-lookup"><span data-stu-id="bc73a-195">The FREE\_FIND\_CERT callback is called when the certificate returned by the FIND\_CERT callback was not released by being used in a subsequent next FIND\_CERT, thus having its [*reference count*](../secgloss/r-gly.md) decremented to zero, or by being released by a call to [**CertCloseStore**](/windows/win32/api/Wincrypt/nf-wincrypt-certclosestore).</span></span> <span data-ttu-id="bc73a-196">Перед вызовом функции обратного вызова CLOSE все сертификаты, возвращенные функцией обратного вызова FIND Certificate, \_ должны быть освобождены для поставщика путем передачи в вызов обратного вызова по поиску \_ сертификата или вызова бесплатного запроса на \_ Поиск \_ сертификата.</span><span class="sxs-lookup"><span data-stu-id="bc73a-196">Before the CLOSE callback is called, all certificates returned by the FIND\_CERT callback should be released to the provider by being passed to a call to the FIND\_CERT callback or a call to the FREE\_FIND\_CERT callback.</span></span> <span data-ttu-id="bc73a-197">То же относится и к ответным вызовам CRL и CTL.</span><span class="sxs-lookup"><span data-stu-id="bc73a-197">The same applies to the CRL and CTL callbacks.</span></span>

<span data-ttu-id="bc73a-198">\_ \_ Обратный вызов свойства Get CERT вызывается методом [**цертжетцертификатеконтекстпроперти**](/windows/win32/api/Wincrypt/nf-wincrypt-certgetcertificatecontextproperty) , если не удается найти указанное свойство для параметра *пцертконтекст* .</span><span class="sxs-lookup"><span data-stu-id="bc73a-198">The GET\_CERT\_PROPERTY callback is called by [**CertGetCertificateContextProperty**](/windows/win32/api/Wincrypt/nf-wincrypt-certgetcertificatecontextproperty) if it cannot find the specified property for the *pCertContext* parameter.</span></span> <span data-ttu-id="bc73a-199">Это справедливо и для свойства GET \_ CRL \_ и получения \_ Свойства CTL \_ .</span><span class="sxs-lookup"><span data-stu-id="bc73a-199">The same is true for GET\_CRL\_PROPERTY and GET\_CTL\_PROPERTY.</span></span>

<span data-ttu-id="bc73a-200">\_Обратный вызов Find CRL вызывается, когда API-интерфейсы хранилища перечисляют или получают списки отзыва сертификатов и перед добавлением списка отзыва сертификатов.</span><span class="sxs-lookup"><span data-stu-id="bc73a-200">The FIND\_CRL callback is called when the store APIs enumerate or get CRLs and before adding a CRL.</span></span> <span data-ttu-id="bc73a-201">Будут определены следующие типы поиска CRL:</span><span class="sxs-lookup"><span data-stu-id="bc73a-201">The following CRL find types will be defined:</span></span>

<span data-ttu-id="bc73a-202">Для списка отзыва сертификатов \_ \_ , выпущенного \_ , *пвфиндпара* является указателем [**на \_ контекст сертификата**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_context) поставщика CRL.</span><span class="sxs-lookup"><span data-stu-id="bc73a-202">For CRL\_FIND\_ISSUED\_BY, *pvFindPara* is a pointer to a [**CERT\_CONTEXT**](/windows/win32/api/Wincrypt/ns-wincrypt-cert_context) of the CRL issuer.</span></span> <span data-ttu-id="bc73a-203">Для списка CRL Find Exists \_ \_ *пвфиндпара* — это указатель на [**\_ контекст**](/windows/win32/api/Wincrypt/ns-wincrypt-crl_context) списка отзыва сертификатов, чтобы определить, существует ли он в магазине.</span><span class="sxs-lookup"><span data-stu-id="bc73a-203">For CRL\_FIND\_EXISTING, *pvFindPara* is a pointer to a [**CRL\_CONTEXT**](/windows/win32/api/Wincrypt/ns-wincrypt-crl_context) of the CRL to determine whether it already exists in the store.</span></span>

<span data-ttu-id="bc73a-204">\_Обратный вызов Find CTL вызывается при перечислении или поиске списков CTL в API-интерфейсах магазина.</span><span class="sxs-lookup"><span data-stu-id="bc73a-204">The FIND\_CTL callback is called when the store APIs enumerate or find CTLs.</span></span> <span data-ttu-id="bc73a-205">В [**цертфиндктлинсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certfindctlinstore)поддерживаются следующие типы поиска CTL:</span><span class="sxs-lookup"><span data-stu-id="bc73a-205">The following CTL find types are supported in [**CertFindCTLInStore**](/windows/win32/api/Wincrypt/nf-wincrypt-certfindctlinstore):</span></span>

-   <span data-ttu-id="bc73a-206">CTL " \_ найти \_ все"</span><span class="sxs-lookup"><span data-stu-id="bc73a-206">CTL\_FIND\_ANY</span></span>
-   <span data-ttu-id="bc73a-207">CTL \_ " \_ найти \_ хэш SHA1"</span><span class="sxs-lookup"><span data-stu-id="bc73a-207">CTL\_FIND\_SHA1\_HASH</span></span>
-   <span data-ttu-id="bc73a-208">CTL \_ " \_ найти \_ хэш MD5"</span><span class="sxs-lookup"><span data-stu-id="bc73a-208">CTL\_FIND\_MD5\_HASH</span></span>
-   <span data-ttu-id="bc73a-209">\_Поиск по \_ использованию CTL</span><span class="sxs-lookup"><span data-stu-id="bc73a-209">CTL\_FIND\_USAGE</span></span>
-   <span data-ttu-id="bc73a-210">CTL " \_ найти \_ тему"</span><span class="sxs-lookup"><span data-stu-id="bc73a-210">CTL\_FIND\_SUBJECT</span></span>
-   <span data-ttu-id="bc73a-211">CTL " \_ найти \_ существующий"</span><span class="sxs-lookup"><span data-stu-id="bc73a-211">CTL\_FIND\_EXISTING</span></span>

<span data-ttu-id="bc73a-212">\_Обратный вызов Find CTL вызывается для каждого из перечисленных выше типов поиска.</span><span class="sxs-lookup"><span data-stu-id="bc73a-212">The FIND\_CTL callback is called for each of the above find types.</span></span> <span data-ttu-id="bc73a-213">Параметры, передаваемые в [**цертфиндктлинсторе**](/windows/win32/api/Wincrypt/nf-wincrypt-certfindctlinstore) , копируются непосредственно в \_ хранилище сертификатов \_ Prov \_ найти \_ структуру сведений перед вызовом \_ обратного вызова find CTL.</span><span class="sxs-lookup"><span data-stu-id="bc73a-213">The parameters passed to [**CertFindCTLInStore**](/windows/win32/api/Wincrypt/nf-wincrypt-certfindctlinstore) are copied directly to the CERT\_STORE\_PROV\_FIND\_INFO structure before the FIND\_CTL callback is called.</span></span> <span data-ttu-id="bc73a-214">Дополнительные сведения о значениях полей для различных типов поиска в \_ структуре Certificate Store \_ Prov \_ Find \_ info см. в разделе **цертфиндктлинсторе**.</span><span class="sxs-lookup"><span data-stu-id="bc73a-214">For details about the field values for the different find types of the CERT\_STORE\_PROV\_FIND\_INFO structure, see **CertFindCTLInStore**.</span></span>

<span data-ttu-id="bc73a-215">Список CTL " \_ найти \_ существующий CTL" позволяет определить, существует ли уже этот CTL в магазине перед добавлением списка доверия сертификатов.</span><span class="sxs-lookup"><span data-stu-id="bc73a-215">The CTL\_FIND\_EXISTING CTL find type helps determine whether the CTL already exists in the store before doing a CTL add.</span></span>

<span data-ttu-id="bc73a-216">Для CTL " \_ найти \_ существующий" *пвфиндпара* является указателем на структуру [**\_ контекста CTL**](/windows/win32/api/Wincrypt/ns-wincrypt-ctl_context) CTL, чтобы определить, существует ли он в хранилище.</span><span class="sxs-lookup"><span data-stu-id="bc73a-216">For CTL\_FIND\_EXISTING, *pvFindPara* is a pointer to the [**CTL\_CONTEXT**](/windows/win32/api/Wincrypt/ns-wincrypt-ctl_context) structure of the CTL to determine whether it already exists in the store.</span></span>

 

 
