---
description: Синтаксис сообщений шифрования можно использовать для кодирования сообщений, упакованных в оболочку.
ms.assetid: f35aacda-6827-42e9-b7ac-58dc007fc697
title: Кодирование запечатанных данных
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 53dc20fc7483ba1ef364d8b59824d26bd14d458d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104566910"
---
# <a name="encoding-enveloped-data"></a><span data-ttu-id="7631e-103">Кодирование запечатанных данных</span><span class="sxs-lookup"><span data-stu-id="7631e-103">Encoding Enveloped Data</span></span>

<span data-ttu-id="7631e-104">Запечатанные данные состоят из зашифрованного содержимого любого типа и зашифрованных ключей сеанса шифрования содержимого для одного или нескольких получателей.</span><span class="sxs-lookup"><span data-stu-id="7631e-104">Enveloped data consists of encrypted content of any type and encrypted content-encryption session keys for one or more recipients.</span></span> <span data-ttu-id="7631e-105">Сообщения с оболочкой сохраняют содержимое секрета сообщения и разрешают получение содержимого только определенным лицам или сущностям.</span><span class="sxs-lookup"><span data-stu-id="7631e-105">Enveloped messages keep the contents of the message secret and allow only specified persons or entities to retrieve the contents.</span></span>

<span data-ttu-id="7631e-106">Синтаксис криптографического сообщения (CMS) можно использовать для кодирования сообщений, упакованных в оболочку.</span><span class="sxs-lookup"><span data-stu-id="7631e-106">Cryptographic message syntax (CMS) can be used to encode enveloped messages.</span></span> <span data-ttu-id="7631e-107">CMS поддерживает три метода управления ключами: транспорт ключей, соглашение о ключах и ранее распределенные симметричные ключи шифрования ключей (KEK).</span><span class="sxs-lookup"><span data-stu-id="7631e-107">CMS supports three key management techniques: key transport, key agreement, and previously distributed symmetric key-encryption keys (KEK).</span></span> <span data-ttu-id="7631e-108">Ранее распределенные симметричные KEK также называются распространением ключей списка рассылки.</span><span class="sxs-lookup"><span data-stu-id="7631e-108">Previously distributed symmetric KEK are also known as mailing list key distribution.</span></span>

<span data-ttu-id="7631e-109">В каждом из этих трех методов создается один сеансовый ключ для шифрования сообщения, упакованного в оболочку.</span><span class="sxs-lookup"><span data-stu-id="7631e-109">In each of these three techniques, a single session key is generated to encrypt the enveloped message.</span></span> <span data-ttu-id="7631e-110">Проблемы управления ключами связаны с тем, как ключ сеанса шифруется отправителем и расшифровывается получателем.</span><span class="sxs-lookup"><span data-stu-id="7631e-110">Key management issues deal with the way that session key is encrypted by the sender and decrypted by a receiver.</span></span> <span data-ttu-id="7631e-111">Одно зашифрованное сообщение может распространяться многим получателям с помощью сочетания методов управления ключами.</span><span class="sxs-lookup"><span data-stu-id="7631e-111">A single encrypted message can be distributed to many recipients using a mixture of the key management techniques.</span></span>

<span data-ttu-id="7631e-112">Управление ключами транспортного ключа использует для шифрования ключа сеанса открытый ключ предполагаемого получателя.</span><span class="sxs-lookup"><span data-stu-id="7631e-112">Key transport key management uses an intended receiver's public key to encrypt the session key.</span></span> <span data-ttu-id="7631e-113">Получатель расшифровывает сеансовый ключ с помощью закрытого ключа, связанного с открытым ключом, который использовался для шифрования.</span><span class="sxs-lookup"><span data-stu-id="7631e-113">The receiver decrypts the session key using the private key associated with the public key that was used to encrypt.</span></span> <span data-ttu-id="7631e-114">Затем получатель использует расшифрованный ключ сеанса для расшифровки данных, упакованных в оболочку.</span><span class="sxs-lookup"><span data-stu-id="7631e-114">The receiver then uses the decrypted session key to decrypt the enveloped data.</span></span> <span data-ttu-id="7631e-115">Когда используется транспорт ключей, получатель не подтвердил сведения об удостоверении отправителя.</span><span class="sxs-lookup"><span data-stu-id="7631e-115">When key transport is used, the receiver has not confirmed information on the identity of the sender.</span></span>

<span data-ttu-id="7631e-116">В управлении согласованием ключей создается временный, эфемерный Diffie-Hellman закрытый ключ, который используется для шифрования ключа сеанса.</span><span class="sxs-lookup"><span data-stu-id="7631e-116">In key agreement management, a temporary, ephemeral Diffie-Hellman private key is generated and used to encrypt the session key.</span></span> <span data-ttu-id="7631e-117">Открытый ключ, соответствующий эфемерному закрытому ключу, включается как часть сведений о получателе сообщения.</span><span class="sxs-lookup"><span data-stu-id="7631e-117">The public key corresponding to the ephemeral private key is included as part of the message's recipient information.</span></span> <span data-ttu-id="7631e-118">Получатель расшифровывает сеансовый ключ с помощью полученного временного ключа и использует этот расшифрованный ключ сеанса для расшифровки сообщения, упакованного в оболочку.</span><span class="sxs-lookup"><span data-stu-id="7631e-118">The recipient decrypts the session key using the received ephemeral key and uses this decrypted session key to decrypt the enveloped message.</span></span> <span data-ttu-id="7631e-119">При использовании временного ключа в сочетании с закрытым ключом получателя получатель сообщения подтвердил сведения об удостоверении отправителя.</span><span class="sxs-lookup"><span data-stu-id="7631e-119">Using ephemeral key agreement in conjunction with the receiver's private key, the message receiver does have confirmed information on the identity of the sender.</span></span>

<span data-ttu-id="7631e-120">Для управления ключами с использованием ранее распределенных [*симметричных ключей*](../secgloss/s-gly.md)каждое сообщение содержит ключ шифрования содержимого, который был зашифрован с помощью ранее распределенного ключа шифрования ключа.</span><span class="sxs-lookup"><span data-stu-id="7631e-120">For key management using previously distributed [*symmetric keys*](../secgloss/s-gly.md), each message includes the content-encryption key that has been encrypted with a previously distributed key-encryption key.</span></span> <span data-ttu-id="7631e-121">Получатели используют ранее распределенный ключ шифрования ключа для расшифровки ключа шифрования содержимого, а затем используют расшифрованный ключ шифрования содержимого для расшифровки запечатанного сообщения.</span><span class="sxs-lookup"><span data-stu-id="7631e-121">Receivers use the previously distributed key-encryption key to decrypt the content encryption key, then use the decrypted content-encryption key to decrypt the enveloped message.</span></span>

<span data-ttu-id="7631e-122">Типичная последовательность событий CMS для кодирования запечатанных данных показана на следующем рисунке.</span><span class="sxs-lookup"><span data-stu-id="7631e-122">A typical CMS sequence of events for encoding enveloped data, is shown in the following illustration.</span></span>

![кодирование запечатанных данных](images/envelmsg.png)

-   <span data-ttu-id="7631e-124">Извлекается указатель на сообщение с [*открытым текстом*](../secgloss/p-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="7631e-124">A pointer to the [*plaintext*](../secgloss/p-gly.md) message is retrieved.</span></span>
-   <span data-ttu-id="7631e-125">Создается симметричный ключ ([*сеанс*](../secgloss/s-gly.md)).</span><span class="sxs-lookup"><span data-stu-id="7631e-125">A symmetric ([*session*](../secgloss/s-gly.md)) key is generated.</span></span>
-   <span data-ttu-id="7631e-126">[*Симметричный ключ*](../secgloss/s-gly.md) и заданный алгоритм шифрования используются для шифрования данных сообщения.</span><span class="sxs-lookup"><span data-stu-id="7631e-126">The [*symmetric key*](../secgloss/s-gly.md) and specified encryption algorithm are used to encrypt the message data.</span></span>
-   <span data-ttu-id="7631e-127">Открыто [*хранилище сертификатов*](../secgloss/c-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="7631e-127">A [*certificate store*](../secgloss/c-gly.md) is opened.</span></span>
-   <span data-ttu-id="7631e-128">Сертификат получателя извлекается из магазина.</span><span class="sxs-lookup"><span data-stu-id="7631e-128">The recipient's certificate is retrieved from the store.</span></span>
-   <span data-ttu-id="7631e-129">[*Открытый ключ*](../secgloss/p-gly.md) извлекается из сертификата получателя.</span><span class="sxs-lookup"><span data-stu-id="7631e-129">The [*public key*](../secgloss/p-gly.md) is retrieved from the recipient's certificate.</span></span>
-   <span data-ttu-id="7631e-130">При использовании открытого ключа получателя симметричный ключ шифруется.</span><span class="sxs-lookup"><span data-stu-id="7631e-130">Using the recipient's public key, the symmetric key is encrypted.</span></span>
-   <span data-ttu-id="7631e-131">Из сертификата получателя извлекается идентификатор получателя.</span><span class="sxs-lookup"><span data-stu-id="7631e-131">From the recipient's certificate, the recipient's ID is retrieved.</span></span>
-   <span data-ttu-id="7631e-132">В сообщение с цифровой подписью включаются следующие сведения: алгоритм шифрования данных, зашифрованные данные, зашифрованный симметричный ключ и структура сведений о получателе.</span><span class="sxs-lookup"><span data-stu-id="7631e-132">The following information is included in the digitally enveloped message: the data encryption algorithm, the encrypted data, the encrypted symmetric key, and the recipient information structure.</span></span>

<span data-ttu-id="7631e-133">Чтобы использовать функции обработки сообщений низкого уровня для выполнения типичных задач, которые только что перечислены, используйте следующую процедуру.</span><span class="sxs-lookup"><span data-stu-id="7631e-133">To use low-level message functions to accomplish the typical tasks just listed, use the following procedure.</span></span>

<span data-ttu-id="7631e-134">**Кодирование запечатанного сообщения**</span><span class="sxs-lookup"><span data-stu-id="7631e-134">**To encode an enveloped message**</span></span>

1.  <span data-ttu-id="7631e-135">Создайте или извлеките содержимое.</span><span class="sxs-lookup"><span data-stu-id="7631e-135">Create or retrieve the content.</span></span>
2.  <span data-ttu-id="7631e-136">Получение поставщика служб шифрования.</span><span class="sxs-lookup"><span data-stu-id="7631e-136">Get a cryptographic provider.</span></span>
3.  <span data-ttu-id="7631e-137">Получение сертификата получателя.</span><span class="sxs-lookup"><span data-stu-id="7631e-137">Get a recipient certificate.</span></span>
4.  <span data-ttu-id="7631e-138">Инициализируйте [**\_ \_ \_ информационную структуру КМСГ с запечатанным кодированием**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="7631e-138">Initialize the [**CMSG\_ENVELOPED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) structure.</span></span>
5.  <span data-ttu-id="7631e-139">Вызовите [**криптмсгкалкулатинкодедленгс**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) , чтобы получить размер BLOB-объекта закодированного сообщения.</span><span class="sxs-lookup"><span data-stu-id="7631e-139">Call [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) to get the size of the encoded message BLOB.</span></span> <span data-ttu-id="7631e-140">Выделите память для нее.</span><span class="sxs-lookup"><span data-stu-id="7631e-140">Allocate memory for it.</span></span>
6.  <span data-ttu-id="7631e-141">Вызовите [**криптмсгопентоенкоде**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), передав КМСГ в \_ конверт для *Двмсгтипе* и указатель на [**КМСГ \_ \_ \_ сведения о закодированном конверте**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) для *пвмсженкодеинфо*.</span><span class="sxs-lookup"><span data-stu-id="7631e-141">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing in CMSG\_ENVELOPED for *dwMsgType* and a pointer to [**CMSG\_ENVELOPED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) for *pvMsgEncodeInfo*.</span></span> <span data-ttu-id="7631e-142">В результате этого вызова вы получите маркер открытого сообщения.</span><span class="sxs-lookup"><span data-stu-id="7631e-142">As a result of this call, you will get a handle to the opened message.</span></span>
7.  <span data-ttu-id="7631e-143">Вызовите [**криптмсгупдате**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), передав маркер, полученный на шаге 6, и указатель на данные, которые должны быть зашифрованы, запечатаны и закодированы.</span><span class="sxs-lookup"><span data-stu-id="7631e-143">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passing in the handle retrieved in step 6 and a pointer to the data that is to be encrypted, enveloped, and encoded.</span></span> <span data-ttu-id="7631e-144">Эту функцию можно вызывать столько раз, сколько необходимо для завершения процесса кодирования.</span><span class="sxs-lookup"><span data-stu-id="7631e-144">This function can be called as many times as necessary to complete the encoding process.</span></span>
8.  <span data-ttu-id="7631e-145">Вызовите [**криптмсгжетпарам**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), передав маркер, полученный на шаге 6, и соответствующие типы параметров для доступа к нужным закодированным данным.</span><span class="sxs-lookup"><span data-stu-id="7631e-145">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passing in the handle retrieved in step 6 and the appropriate parameter types to access the desired, encoded data.</span></span> <span data-ttu-id="7631e-146">Например, передайте значение \_ параметра КМСГ Content \_ param, чтобы получить указатель на все \# сообщение PKCS 7.</span><span class="sxs-lookup"><span data-stu-id="7631e-146">For example, pass in CMSG\_CONTENT\_PARAM to get a pointer to the entire PKCS \#7 message.</span></span>

    <span data-ttu-id="7631e-147">Если результат этой кодировки будет использоваться в качестве [*внутренних данных*](../secgloss/i-gly.md) для другого закодированного сообщения, например сообщения, упакованного в оболочку, \_ \_ \_ необходимо передать параметр параметра КМСГ исходного содержимого.</span><span class="sxs-lookup"><span data-stu-id="7631e-147">If the result of this encoding is to be used as the [*inner data*](../secgloss/i-gly.md) for another encoded message, such as an enveloped message, the CMSG\_BARE\_CONTENT\_PARAM parameter must be passed.</span></span> <span data-ttu-id="7631e-148">Пример см. в разделе [альтернативный код для кодирования запечатанного сообщения](alternate-code-for-encoding-an-enveloped-message.md).</span><span class="sxs-lookup"><span data-stu-id="7631e-148">For an example, see [Alternate Code for Encoding an Enveloped Message](alternate-code-for-encoding-an-enveloped-message.md).</span></span>

9.  <span data-ttu-id="7631e-149">Закройте сообщение, вызвав [**криптмсгклосе**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span><span class="sxs-lookup"><span data-stu-id="7631e-149">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="7631e-150">Результатом этой процедуры является закодированное сообщение, содержащее зашифрованные данные, [*симметричный ключ*](../secgloss/s-gly.md) , который шифруется с помощью открытых ключей получателя, и структуры данных о получателе.</span><span class="sxs-lookup"><span data-stu-id="7631e-150">The result of this procedure is an encoded message that contains the encrypted data, the [*symmetric key*](../secgloss/s-gly.md) that is encrypted with the recipient's public keys, and the recipient information data structures.</span></span> <span data-ttu-id="7631e-151">Сочетание зашифрованного содержимого и зашифрованного симметричного ключа получателя — это [*цифровой конверт*](../secgloss/d-gly.md) для этого получателя.</span><span class="sxs-lookup"><span data-stu-id="7631e-151">The combination of encrypted content and an encrypted symmetric key for a recipient is a [*digital envelope*](../secgloss/d-gly.md) for that recipient.</span></span> <span data-ttu-id="7631e-152">Любой тип содержимого может быть запечатан для нескольких получателей.</span><span class="sxs-lookup"><span data-stu-id="7631e-152">Any type of content can be enveloped for multiple recipients.</span></span>

## <a name="related-topics"></a><span data-ttu-id="7631e-153">См. также</span><span class="sxs-lookup"><span data-stu-id="7631e-153">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="7631e-154">Пример программы на языке C. кодирование подписанного сообщения с подписью</span><span class="sxs-lookup"><span data-stu-id="7631e-154">Example C Program: Encoding an Enveloped, Signed Message</span></span>](example-c-program-encoding-an-enveloped-signed-message.md)
</dt> </dl>

 

 
