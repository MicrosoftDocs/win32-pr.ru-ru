---
description: Объясняет, как создать HMAC.
ms.assetid: b1747b7e-a505-4b23-93bc-cef4e77bf825
title: Создание HMAC
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 364314081bd1d84d6d9bfff889c234470cc6775c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105663621"
---
# <a name="creating-an-hmac"></a><span data-ttu-id="ca6ca-103">Создание HMAC</span><span class="sxs-lookup"><span data-stu-id="ca6ca-103">Creating an HMAC</span></span>

<span data-ttu-id="ca6ca-104">**Вычисление HMAC**</span><span class="sxs-lookup"><span data-stu-id="ca6ca-104">**To compute an HMAC**</span></span>

1.  <span data-ttu-id="ca6ca-105">Получите указатель на [*поставщик служб шифрования*](../secgloss/c-gly.md) Майкрософт (CSP), вызвав [**CryptAcquireContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptacquirecontexta).</span><span class="sxs-lookup"><span data-stu-id="ca6ca-105">Get a pointer to the Microsoft [*Cryptographic Service Provider*](../secgloss/c-gly.md) (CSP) by calling [**CryptAcquireContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptacquirecontexta).</span></span>
2.  <span data-ttu-id="ca6ca-106">Создайте маркер для [*хэш-объекта*](../secgloss/h-gly.md) [*HMAC*](../secgloss/h-gly.md), вызвав [**CryptCreateHash**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptcreatehash).</span><span class="sxs-lookup"><span data-stu-id="ca6ca-106">Create a handle to an [*HMAC*](../secgloss/h-gly.md)[*hash object*](../secgloss/h-gly.md) by calling [**CryptCreateHash**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptcreatehash).</span></span> <span data-ttu-id="ca6ca-107">Передайте КАЛГ \_ HMAC в параметре *алгид* .</span><span class="sxs-lookup"><span data-stu-id="ca6ca-107">Pass CALG\_HMAC in the *Algid* parameter.</span></span> <span data-ttu-id="ca6ca-108">Передайте маркер [*симметричного ключа*](../secgloss/s-gly.md) в параметре *hKey* .</span><span class="sxs-lookup"><span data-stu-id="ca6ca-108">Pass the handle of a [*symmetric key*](../secgloss/s-gly.md) in the *hKey* parameter.</span></span> <span data-ttu-id="ca6ca-109">Этот симметричный ключ используется для вычисления HMAC.</span><span class="sxs-lookup"><span data-stu-id="ca6ca-109">This symmetric key is the key used to compute the HMAC.</span></span>
3.  <span data-ttu-id="ca6ca-110">Укажите тип хэша, который будет использоваться путем вызова [**криптсесашпарам**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptsethashparam) с параметром *двпарам* , для которого задано значение HP \_ HMAC \_ info.</span><span class="sxs-lookup"><span data-stu-id="ca6ca-110">Specify the type of hash to be used by calling [**CryptSetHashParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptsethashparam) with the *dwParam* parameter set to the value HP\_HMAC\_INFO.</span></span> <span data-ttu-id="ca6ca-111">Параметр *pbData* должен указывать на инициализированную структуру [**HMAC \_ info**](/windows/desktop/api/Wincrypt/ns-wincrypt-hmac_info) .</span><span class="sxs-lookup"><span data-stu-id="ca6ca-111">The *pbData* parameter must point to an initialized [**HMAC\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-hmac_info) structure.</span></span>
4.  <span data-ttu-id="ca6ca-112">Вызовите [**CryptHashData**](/windows/desktop/api/Wincrypt/nf-wincrypt-crypthashdata) , чтобы начать вычисление HMAC данных.</span><span class="sxs-lookup"><span data-stu-id="ca6ca-112">Call [**CryptHashData**](/windows/desktop/api/Wincrypt/nf-wincrypt-crypthashdata) to begin computing the HMAC of the data.</span></span> <span data-ttu-id="ca6ca-113">Первый вызов **CryptHashData** приводит к объединению значения ключа с помощью оператора XOR с внутренней строкой и данными.</span><span class="sxs-lookup"><span data-stu-id="ca6ca-113">The first call to **CryptHashData** causes the key value to be combined using the XOR operator with the inner string and the data.</span></span> <span data-ttu-id="ca6ca-114">Результат операции XOR хэшируется, а затем целевые данные для HMAC (на которые указывает параметр *pbData* , переданный в вызове **CryptHashData**) хэшируется.</span><span class="sxs-lookup"><span data-stu-id="ca6ca-114">The result of the XOR operation is hashed, and then the target data for the HMAC (pointed to by the *pbData* parameter passed in the call to **CryptHashData**) is hashed.</span></span> <span data-ttu-id="ca6ca-115">При необходимости можно выполнить последующие вызовы **CryptHashData** , чтобы завершить хэширование целевых данных.</span><span class="sxs-lookup"><span data-stu-id="ca6ca-115">If necessary, subsequent calls to **CryptHashData** may then be made to finish the hashing of the target data.</span></span>
5.  <span data-ttu-id="ca6ca-116">Вызовите [**CryptGetHashParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptgethashparam) , указав для параметра *двпарам* значение HP \_ хашвал.</span><span class="sxs-lookup"><span data-stu-id="ca6ca-116">Call [**CryptGetHashParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptgethashparam) with the *dwParam* parameter set to HP\_HASHVAL.</span></span> <span data-ttu-id="ca6ca-117">Этот вызов приводит к завершению внутреннего хэша и объединению внешней строки с помощью XOR с ключом.</span><span class="sxs-lookup"><span data-stu-id="ca6ca-117">This call causes the inner hash to be finished and the outer string to be combined using XOR with the key.</span></span> <span data-ttu-id="ca6ca-118">Результат операции XOR хэшируется, а затем результат внутреннего хэша (выполненного на предыдущем шаге) хэшируется.</span><span class="sxs-lookup"><span data-stu-id="ca6ca-118">The result of the XOR operation is hashed, and then the result of the inner hash (completed in the previous step) is hashed.</span></span> <span data-ttu-id="ca6ca-119">Внешний хэш затем завершается и возвращается в параметре *pbData* и длине в параметре *двдатален* .</span><span class="sxs-lookup"><span data-stu-id="ca6ca-119">The outer hash is then finished and returned in the *pbData* parameter and the length in the *dwDataLen* parameter.</span></span>

> [!Note]  
> <span data-ttu-id="ca6ca-120">Не используйте один и тот же [*симметричный*](../secgloss/s-gly.md) ключ ([*сеанс*](../secgloss/s-gly.md)) как для шифрования сообщений, так и для создания [*код проверки подлинности сообщения*](../secgloss/m-gly.md) (Mac).</span><span class="sxs-lookup"><span data-stu-id="ca6ca-120">Do not use the same [*symmetric*](../secgloss/s-gly.md) ([*session*](../secgloss/s-gly.md)) key for both message encryption and [*Message Authentication Code*](../secgloss/m-gly.md) (MAC) generation.</span></span> <span data-ttu-id="ca6ca-121">Использование одного и того же ключа позволяет значительно увеличить риск появления сообщений, декодированных злоумышленниками.</span><span class="sxs-lookup"><span data-stu-id="ca6ca-121">Using the same key for both greatly increases the risk of messages being decoded by attackers.</span></span>

 

 

 
