---
description: Сведения о процедуре кодирования общего сообщения.
ms.assetid: 554cab0d-cfa2-46a7-80d9-f41430eb4b47
title: Процедура кодирования и декодирования сообщений
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 49da09c2318fffd3d1c92d6012055172709609a7
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105683268"
---
# <a name="procedure-for-encoding-and-decoding-messages"></a><span data-ttu-id="1070f-103">Процедура кодирования и декодирования сообщений</span><span class="sxs-lookup"><span data-stu-id="1070f-103">Procedure for Encoding and Decoding Messages</span></span>

<span data-ttu-id="1070f-104">Процедура кодирования общего сообщения выглядит следующим образом.</span><span class="sxs-lookup"><span data-stu-id="1070f-104">The procedure for encoding a general message is as follows.</span></span>

<span data-ttu-id="1070f-105">**Кодирование сообщения**</span><span class="sxs-lookup"><span data-stu-id="1070f-105">**To encode a message**</span></span>

1.  <span data-ttu-id="1070f-106">Инициализируйте соответствующие структуры данных для требуемого типа данных.</span><span class="sxs-lookup"><span data-stu-id="1070f-106">Initialize the appropriate data structures for the desired data type.</span></span>
2.  <span data-ttu-id="1070f-107">Вызовите [**криптмсгопентоенкоде**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), передав необходимые аргументы.</span><span class="sxs-lookup"><span data-stu-id="1070f-107">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing the necessary arguments.</span></span> <span data-ttu-id="1070f-108">Если при вызове **криптмсгопентоенкоде** данные, которые должны быть предоставлены [**криптмсгупдате**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) , уже закодированы в сообщении, передайте соответствующий идентификатор объекта в *псзиннерконтентобжид* (например, "1.2.840.113549.1.7.2" для сзоид \_ RSA \_ signedData).</span><span class="sxs-lookup"><span data-stu-id="1070f-108">When calling **CryptMsgOpenToEncode**, if the data that is to be provided to [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) has already been message-encoded, pass the appropriate object identifier in *pszInnerContentObjID* (for example, "1.2.840.113549.1.7.2" for szOID\_RSA\_signedData).</span></span> <span data-ttu-id="1070f-109">Если *псзиннерконтентобжид* имеет **значение NULL**, то предполагается, что тип [*внутреннего содержимого*](../secgloss/i-gly.md) не был ранее закодирован и обрабатывается соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="1070f-109">If *pszInnerContentObjID* is **NULL**, the [*inner content*](../secgloss/i-gly.md) type is assumed not to have been previously encoded and is processed appropriately.</span></span>
3.  <span data-ttu-id="1070f-110">Вызовите [**криптмсгупдате**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) столько раз, сколько необходимо для завершения сообщения.</span><span class="sxs-lookup"><span data-stu-id="1070f-110">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) as many times as necessary to complete the message.</span></span> <span data-ttu-id="1070f-111">При последнем вызове задайте для параметра *ФФинал* **значение true**.</span><span class="sxs-lookup"><span data-stu-id="1070f-111">On the last call, set the *fFinal* parameter to **TRUE**.</span></span> <span data-ttu-id="1070f-112">(Дополнительные сведения см. в разделе **криптмсгупдате**).</span><span class="sxs-lookup"><span data-stu-id="1070f-112">(For details, see **CryptMsgUpdate**).</span></span>
4.  <span data-ttu-id="1070f-113">Вызовите [**криптмсгжетпарам**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam) , чтобы получить указатель на нужные параметры, например содержимое.</span><span class="sxs-lookup"><span data-stu-id="1070f-113">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam) to get a pointer to the desired parameters, such as the content.</span></span> <span data-ttu-id="1070f-114">Для кодирования простых, общих данных используйте \_ параметр содержимого КМСГ \_ для *двпарамтипе*.</span><span class="sxs-lookup"><span data-stu-id="1070f-114">For encoding simple, general data, use CMSG\_CONTENT\_PARAM for the *dwParamtype*.</span></span>
5.  <span data-ttu-id="1070f-115">Закройте сообщение, вызвав [**криптмсгклосе**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span><span class="sxs-lookup"><span data-stu-id="1070f-115">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="1070f-116">Эта процедура приводит к получению закодированного сообщения типа, указанного в вызовах функции.</span><span class="sxs-lookup"><span data-stu-id="1070f-116">This procedure results in an encoded message of a type specified in the function calls.</span></span>

<span data-ttu-id="1070f-117">Ниже приведена процедура декодирования общего сообщения.</span><span class="sxs-lookup"><span data-stu-id="1070f-117">The procedure for decoding a general message is as follows.</span></span>

<span data-ttu-id="1070f-118">**Расшифровка сообщения**</span><span class="sxs-lookup"><span data-stu-id="1070f-118">**To decode a message**</span></span>

1.  <span data-ttu-id="1070f-119">Определите длину, необходимую буферу для хранения закодированных данных, с помощью [**криптмсгкалкулатинкодедленгс**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength).</span><span class="sxs-lookup"><span data-stu-id="1070f-119">Determine the length needed for the buffer to hold the encoded data using [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength).</span></span>
2.  <span data-ttu-id="1070f-120">Вызовите [**криптмсгопентодекоде**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentodecode), передав необходимые аргументы.</span><span class="sxs-lookup"><span data-stu-id="1070f-120">Call [**CryptMsgOpenToDecode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentodecode), passing the necessary arguments.</span></span> <span data-ttu-id="1070f-121">Чтобы обеспечить совместимость с Internet Explorer версии 3,0, предоставляется параметр *двмсгтипе* .</span><span class="sxs-lookup"><span data-stu-id="1070f-121">To maintain compatibility with Internet Explorer version 3.0, the *dwMsgType* parameter is provided.</span></span> <span data-ttu-id="1070f-122">Подписанные данные, созданные в Internet Explorer 3,0, не содержат сведений о заголовке.</span><span class="sxs-lookup"><span data-stu-id="1070f-122">Signed data created in Internet Explorer 3.0 does not contain header information.</span></span> <span data-ttu-id="1070f-123">Таким образом, если такое сообщение извлекается из сигнатур файлов, тип сообщения должен передаваться в функцию.</span><span class="sxs-lookup"><span data-stu-id="1070f-123">Therefore, if such a message is extracted from file signatures, the message type must be passed into the function.</span></span> <span data-ttu-id="1070f-124">Если в параметр *двмсгтипе* передается ноль, функция будет считывать тип сообщений из заголовка сообщения.</span><span class="sxs-lookup"><span data-stu-id="1070f-124">If zero is passed into the *dwMsgType* parameter, the function will read the message type from the header on the message.</span></span> <span data-ttu-id="1070f-125">Если заголовок отсутствует, вызов функции завершится ошибкой.</span><span class="sxs-lookup"><span data-stu-id="1070f-125">If the header is missing, the function call will fail.</span></span> <span data-ttu-id="1070f-126">В случае успешного выполнения возвращается маркер открытого сообщения.</span><span class="sxs-lookup"><span data-stu-id="1070f-126">If successful, a handle to the opened message is returned.</span></span>
3.  <span data-ttu-id="1070f-127">Вызовите [**криптмсгупдате**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) один раз.</span><span class="sxs-lookup"><span data-stu-id="1070f-127">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) once.</span></span> <span data-ttu-id="1070f-128">Это приводит к тому, что в зависимости от типа сообщений в сообщении будут выполняться соответствующие действия.</span><span class="sxs-lookup"><span data-stu-id="1070f-128">This causes the appropriate actions to be taken on the message, depending on the message type.</span></span>
4.  <span data-ttu-id="1070f-129">Для дополнительной обработки сообщения, например дополнительной расшифровки или проверки подписи, вызовите [**криптмсгконтрол**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcontrol), передав нужное действие в *двктрлтипе*.</span><span class="sxs-lookup"><span data-stu-id="1070f-129">For additional processing of the message, such as additional decryption or signature verification, call [**CryptMsgControl**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcontrol), passing the desired action in *dwCtrlType*.</span></span>
5.  <span data-ttu-id="1070f-130">Вызовите [**криптмсгжетпарам**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam) , чтобы получить указатель на нужные параметры, например содержимое.</span><span class="sxs-lookup"><span data-stu-id="1070f-130">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam) to get a pointer to the desired parameters, such as the content.</span></span> <span data-ttu-id="1070f-131">Чтобы декодировать простые общие данные, используйте \_ параметр КМСГ содержимого \_ для параметра *двпарамтипе* .</span><span class="sxs-lookup"><span data-stu-id="1070f-131">To decode simple general data, use CMSG\_CONTENT\_PARAM for the *dwParamtype* parameter.</span></span>
6.  <span data-ttu-id="1070f-132">Вызовите [**криптмсгклосе**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose) , чтобы закрыть сообщение.</span><span class="sxs-lookup"><span data-stu-id="1070f-132">Call [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose) to close the message.</span></span>

<span data-ttu-id="1070f-133">Пример, в котором реализованы эти шаги, см. в разделе [Пример программы C: кодирование и декодирование данных](example-c-program-encoding-and-decoding-data.md).</span><span class="sxs-lookup"><span data-stu-id="1070f-133">For an example that implements these steps, see [Example C Program: Encoding and Decoding Data](example-c-program-encoding-and-decoding-data.md).</span></span> <span data-ttu-id="1070f-134">Процедуры и пример, демонстрирующий процесс кодирования, декодирования и проверки подписи подписанного сообщения, см. в разделе [Пример программы C: подписывание, кодирование, декодирование и проверка сообщения](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).</span><span class="sxs-lookup"><span data-stu-id="1070f-134">For procedures and an example demonstrating the process of encoding, decoding, and verifying the signature of a signed message, see [Example C Program: Signing, Encoding, Decoding, and Verifying a Message](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).</span></span>

 

 
