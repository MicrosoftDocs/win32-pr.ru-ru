---
description: Несколько функций предоставляют службы для управления состоянием хранилища сертификатов.
ms.assetid: bae3d693-31b3-4c1d-9a8f-0dafa8bb6897
title: Управление состоянием хранилища сертификатов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 53d66e40817f0f92f48e8841455998eff4dbffd6
ms.sourcegitcommit: de72a1294df274b0a71dc0fdc42d757e5f6df0f3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "104000000"
---
# <a name="managing-a-certificate-store-state"></a><span data-ttu-id="be21b-103">Управление состоянием хранилища сертификатов</span><span class="sxs-lookup"><span data-stu-id="be21b-103">Managing a Certificate Store State</span></span>

<span data-ttu-id="be21b-104">Несколько функций предоставляют службы для управления [*состоянием*](../secgloss/s-gly.md) [*хранилища сертификатов*](../secgloss/c-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="be21b-104">Several functions provide services for managing a [*certificate store*](../secgloss/c-gly.md) [*state*](../secgloss/s-gly.md).</span></span>

<span data-ttu-id="be21b-105">Чтобы получить доступ к сертификатам, хранилище сертификатов, в котором они хранятся, необходимо открыть с помощью вызова [**цертопенсторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) или [**цертопенсистемсторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopensystemstorea).</span><span class="sxs-lookup"><span data-stu-id="be21b-105">To gain access to certificates, the certificate store in which they are stored must be opened through a call to [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) or [**CertOpenSystemStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopensystemstorea).</span></span>

<span data-ttu-id="be21b-106">Обычно хранилище сертификатов открывается в кэшированной памяти.</span><span class="sxs-lookup"><span data-stu-id="be21b-106">Usually a certificate store is opened in cached memory.</span></span> <span data-ttu-id="be21b-107">Это может быть новое хранилище или его содержимое, которое можно загрузить из локального реестра, реестра на удаленном компьютере, файла на диске, \# сообщения PKCS 7 или другого источника.</span><span class="sxs-lookup"><span data-stu-id="be21b-107">It can be a new store or its contents can be loaded from the local registry, the registry on a remote computer, a disk file, a PKCS \#7 message, or some other source.</span></span>

<span data-ttu-id="be21b-108">Функции хранилища сертификатов CryptoAPI также позволяют магазину хранить сертификаты вне кэшированной памяти в, например, во внешней базе данных сертификатов, например в базе данных Microsoft Certificate Server.</span><span class="sxs-lookup"><span data-stu-id="be21b-108">CryptoAPI certificate store functions also allow a store to maintain certificates outside cached memory in, for example, an external database of certificates such as the one provided by the Microsoft Certificate Server Database.</span></span>

<span data-ttu-id="be21b-109">Один из параметров функции [**цертопенсторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) , *лпсзсторепровидер,* определяет тип открытого хранилища и поставщика, используемого для открытия этого хранилища.</span><span class="sxs-lookup"><span data-stu-id="be21b-109">One of the parameters of the [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) function, *lpszStoreProvider,* determines the type of store opened and the provider used to open that store.</span></span> <span data-ttu-id="be21b-110">Примеры открытия хранилищ сертификатов с помощью различных поставщиков см. [в примере кода C для открытия хранилищ сертификатов](example-c-code-for-opening-certificate-stores.md).</span><span class="sxs-lookup"><span data-stu-id="be21b-110">For examples of opening certificate stores using various providers, see [Example C Code for Opening Certificate Stores](example-c-code-for-opening-certificate-stores.md).</span></span>

<span data-ttu-id="be21b-111">[**Цертклосесторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) закрывает хранилище сертификатов.</span><span class="sxs-lookup"><span data-stu-id="be21b-111">[**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) closes a certificate store.</span></span> <span data-ttu-id="be21b-112">При закрытии хранилища сертификатов для каждого из контекстов сертификатов в этом хранилище уменьшается [*число ссылок*](../secgloss/r-gly.md) , уменьшенное на единицу.</span><span class="sxs-lookup"><span data-stu-id="be21b-112">When a certificate store is closed, each of the certificate contexts in that store has its [*reference count*](../secgloss/r-gly.md) reduced by one.</span></span> <span data-ttu-id="be21b-113">Память освобождается для сертификатов, количество ссылок которых равно нулю.</span><span class="sxs-lookup"><span data-stu-id="be21b-113">Memory is freed for certificates whose reference count goes to zero.</span></span>

<span data-ttu-id="be21b-114">Установка \_ \_ \_ флага принудительного закрытия хранилища сертификата \_ с помощью [**цертклосесторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) закрывает хранилище сертификатов и освобождает память для всех его контекстов сертификатов независимо от их счетчика ссылок.</span><span class="sxs-lookup"><span data-stu-id="be21b-114">Setting CERT\_CLOSE\_STORE\_FORCE\_FLAG with [**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) closes the certificate store and frees memory for all of its certificate contexts regardless of their reference count.</span></span> <span data-ttu-id="be21b-115">В некоторых случаях, например в многопоточных программах, это нежелательно.</span><span class="sxs-lookup"><span data-stu-id="be21b-115">In some cases, such as in multithreaded programs, this cannot be desirable.</span></span> <span data-ttu-id="be21b-116">Если установлен \_ \_ \_ флаг проверки закрытия сертификата \_ , хранилище закрывается, но функция возвращает значение предупреждения, если память по-прежнему выделяется для сертификатов, счетчик ссылок которых не был уменьшен до нуля.</span><span class="sxs-lookup"><span data-stu-id="be21b-116">If CERT\_CLOSE\_STORE\_CHECK\_FLAG is set, the store is closed, but a warning value is returned by the function if memory is still allocated for certificates whose reference counts have not been reduced to zero.</span></span> <span data-ttu-id="be21b-117">Если число ссылок на сертификат больше нуля, то дубликат этого контекста сертификата не был освобожден.</span><span class="sxs-lookup"><span data-stu-id="be21b-117">If a certificate's reference count is greater than zero, a duplicate of that certificate context has not been freed.</span></span> <span data-ttu-id="be21b-118">Для освобождения открытых сертификатов используйте [**цертфрицертификатеконтекст**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecertificatecontext), [**цертфрикрлконтекст**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecrlcontext)и [**цертфриктлконтекст**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreectlcontext) .</span><span class="sxs-lookup"><span data-stu-id="be21b-118">Use [**CertFreeCertificateContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecertificatecontext), [**CertFreeCRLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecrlcontext), and [**CertFreeCTLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreectlcontext) to free any certificates left open.</span></span>

> [!Note]
> <span data-ttu-id="be21b-119">[*Контекст сертификата*](../secgloss/c-gly.md) представляет собой структуру [**\_ контекста типа CERT**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_context) , имеющую, помимо прочих членов, указатель на закодированный [*BLOB-объект сертификата*](../secgloss/c-gly.md) и указатель на структуру [**\_ сведений о сертификате**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_info) .</span><span class="sxs-lookup"><span data-stu-id="be21b-119">A [*certificate context*](../secgloss/c-gly.md) is a structure of type [**CERT\_CONTEXT**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_context) that has, among other members, a pointer to the encoded [*certificate BLOB*](../secgloss/c-gly.md) and a pointer to a [**CERT\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_info) structure.</span></span> <span data-ttu-id="be21b-120">Структура **\_ сведений о** сертификате содержит наиболее значимые данные сертификата.</span><span class="sxs-lookup"><span data-stu-id="be21b-120">The **CERT\_INFO** structure contains the most significant certificate data.</span></span> <span data-ttu-id="be21b-121">Дополнительные сведения о [*сертификате*](../secgloss/c-gly.md), [*списке отзыва сертификатов*](../secgloss/c-gly.md) (CRL) и структурах контекста [*списка доверия сертификатов*](../secgloss/c-gly.md) (CTL) см. [в разделе Кодирование и декодирование контекста сертификата](encoding-and-decoding-a-certificate-context.md).</span><span class="sxs-lookup"><span data-stu-id="be21b-121">For more information about [*certificate*](../secgloss/c-gly.md), [*certificate revocation list*](../secgloss/c-gly.md) (CRL), and [*certificate trust list*](../secgloss/c-gly.md) (CTL) context structures, see [Encoding and Decoding a Certificate Context](encoding-and-decoding-a-certificate-context.md).</span></span>
> 
> <span data-ttu-id="be21b-122">Каждый контекст сертификата также содержит [*счетчик ссылок*](../secgloss/r-gly.md) , указывающий количество назначенных копий адреса контекста.</span><span class="sxs-lookup"><span data-stu-id="be21b-122">Each certificate context also contains a [*reference count*](../secgloss/r-gly.md) indicating the number of copies of the context's address that have been assigned.</span></span> <span data-ttu-id="be21b-123">Каждый раз, когда контекст сертификата дублируется каким-либо образом, его счетчик ссылок увеличивается на единицу.</span><span class="sxs-lookup"><span data-stu-id="be21b-123">Each time a certificate context is duplicated in any way, its reference count is incremented by one.</span></span> <span data-ttu-id="be21b-124">Каждый раз при освобождении указателя на контекст сертификата число ссылок в контексте сертификата уменьшается на единицу.</span><span class="sxs-lookup"><span data-stu-id="be21b-124">Each time a pointer to a certificate context is freed, the reference count in the certificate context is decremented by one.</span></span> <span data-ttu-id="be21b-125">Когда количество ссылок в контексте сертификата достигает нуля, память, удерживаемая в контексте, освобождается.</span><span class="sxs-lookup"><span data-stu-id="be21b-125">When the reference count on a certificate context reaches zero, the memory holding the context is de-allocated.</span></span> <span data-ttu-id="be21b-126">Память, выделенная для контекста сертификата, также освобождается, если этот контекст находится в хранилище, а хранилище закрыто с помощью \_ \_ \_ флага принудительного закрытия сертификата \_ .</span><span class="sxs-lookup"><span data-stu-id="be21b-126">Memory allocated for a certificate context is also de-allocated when that context is in a store and the store is closed using CERT\_CLOSE\_STORE\_FORCE\_FLAG.</span></span> <span data-ttu-id="be21b-127">Если память для контекста освобождается и указатели на этот контекст все еще используются, эти указатели больше не являются допустимыми.</span><span class="sxs-lookup"><span data-stu-id="be21b-127">If the memory for a context is de-allocated and pointers to that context are still in use, those pointers are no longer valid.</span></span>

 

<span data-ttu-id="be21b-128">[**Цертдупликатесторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certduplicatestore) увеличивает [*число ссылок*](../secgloss/r-gly.md) в магазине.</span><span class="sxs-lookup"><span data-stu-id="be21b-128">[**CertDuplicateStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certduplicatestore) increases the [*reference count*](../secgloss/r-gly.md) on the store.</span></span>

<span data-ttu-id="be21b-129">[**Цертсавесторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsavestore) сохраняет содержимое хранилища в файл на диске или в область памяти;</span><span class="sxs-lookup"><span data-stu-id="be21b-129">[**CertSaveStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsavestore) saves the contents of a store to a disk file or a memory location, and</span></span>

<span data-ttu-id="be21b-130">[**Цертконтролсторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) управляет хранилищем, когда оно открыто.</span><span class="sxs-lookup"><span data-stu-id="be21b-130">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) manages a store while it is open.</span></span> <span data-ttu-id="be21b-131">Приложение с открытым хранилищем может получать уведомления, когда сохраненное состояние этого хранилища изменилось другим процессом.</span><span class="sxs-lookup"><span data-stu-id="be21b-131">An application with an open store can be notified when the persisted state of that store has changed by some other process.</span></span> <span data-ttu-id="be21b-132">Это может произойти, если новые сертификаты были скопированы в хранилище локального компьютера с компьютера, на котором выполняется управление доменами.</span><span class="sxs-lookup"><span data-stu-id="be21b-132">This could happen if new certificates were copied to the local computer store from a domain control computer.</span></span>

<span data-ttu-id="be21b-133">При обнаружении изменений кэшированное хранилище может повторно синхронизировать свое кэшированное хранилище в соответствии с сохраненным состоянием хранилища.</span><span class="sxs-lookup"><span data-stu-id="be21b-133">When changes are discovered, the cached store can re-synchronize its cached store to match the persisted state of the store.</span></span> <span data-ttu-id="be21b-134">[**Цертконтролсторе**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) также поддерживает процесс, который копирует изменения кэшированного хранилища в постоянное хранилище, если эти изменения в кэшированном хранилище не сохраняются автоматически.</span><span class="sxs-lookup"><span data-stu-id="be21b-134">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) also supports a process that copies cached store changes to permanent storage when these changes in the cached store are not automatically saved.</span></span>

<span data-ttu-id="be21b-135">Контексты сертификатов, схожие с хранилищем сертификатов, могут иметь расширенные свойства.</span><span class="sxs-lookup"><span data-stu-id="be21b-135">Certificate store-like certificate contexts can have extended properties.</span></span> <span data-ttu-id="be21b-136">[**Цертсетсторепроперти**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsetstoreproperty) добавляет расширенные свойства в хранилище сертификатов.</span><span class="sxs-lookup"><span data-stu-id="be21b-136">[**CertSetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsetstoreproperty) adds extended properties to a certificate store.</span></span> <span data-ttu-id="be21b-137">[**Цертжетсторепроперти**](/windows/desktop/api/Wincrypt/nf-wincrypt-certgetstoreproperty) извлекает все свойства, заданные в хранилище сертификатов.</span><span class="sxs-lookup"><span data-stu-id="be21b-137">[**CertGetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certgetstoreproperty) retrieves any properties set on a certificate store.</span></span> <span data-ttu-id="be21b-138">В настоящее время единственным предопределенным свойством хранилища сертификатов является локализованное имя хранилища.</span><span class="sxs-lookup"><span data-stu-id="be21b-138">Currently, the only predefined certificate store property is a store's localized name.</span></span>

 

 
