---
description: Описывает задачи, необходимые для кодирования хэшированного сообщения.
ms.assetid: c1a65452-c634-4cc6-9afe-d6bf11d999d1
title: Кодирование и декодирование хэшированного сообщения
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d91d165634c1ae00a59f2c77b1fc5a36b53dbd96
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105664139"
---
# <a name="encoding-and-decoding-a-hashed-message"></a><span data-ttu-id="d3897-103">Кодирование и декодирование хэшированного сообщения</span><span class="sxs-lookup"><span data-stu-id="d3897-103">Encoding and Decoding a Hashed Message</span></span>

<span data-ttu-id="d3897-104">Хэшированные данные состоят из содержимого любого типа и [*хэша*](../secgloss/h-gly.md) содержимого.</span><span class="sxs-lookup"><span data-stu-id="d3897-104">Hashed data consists of content of any type and a [*hash*](../secgloss/h-gly.md) of the content.</span></span> <span data-ttu-id="d3897-105">Его можно использовать, когда необходимо только подтвердить, что содержимое сообщения не было изменено с момента создания хэша.</span><span class="sxs-lookup"><span data-stu-id="d3897-105">It can be used when it is only necessary to confirm that the message content has not been modified since the hash was created.</span></span>

<span data-ttu-id="d3897-106">При создании хэшированного сообщения может существовать несколько хэш-алгоритмов и несколько хэшей.</span><span class="sxs-lookup"><span data-stu-id="d3897-106">When creating a hashed message, there can be multiple hash algorithms and multiple hashes.</span></span> <span data-ttu-id="d3897-107">На следующем рисунке показаны задачи, необходимые для кодирования хэшированного сообщения.</span><span class="sxs-lookup"><span data-stu-id="d3897-107">The following illustration depicts the tasks required to encode a hashed message.</span></span> <span data-ttu-id="d3897-108">Процедура описана в тексте, который следует за иллюстрацией.</span><span class="sxs-lookup"><span data-stu-id="d3897-108">The procedure is described in the text that follows the illustration.</span></span>

![Создание хэшированного сообщения](images/hashmsg.png)

<span data-ttu-id="d3897-110">**Создание хэшированного сообщения**</span><span class="sxs-lookup"><span data-stu-id="d3897-110">**To create a hashed message**</span></span>

1.  <span data-ttu-id="d3897-111">Получите указатель на данные для хэширования.</span><span class="sxs-lookup"><span data-stu-id="d3897-111">Get a pointer to the data to be hashed.</span></span>
2.  <span data-ttu-id="d3897-112">Выберите хэш-алгоритм, который будет использоваться.</span><span class="sxs-lookup"><span data-stu-id="d3897-112">Select the hash algorithm to be used.</span></span>
3.  <span data-ttu-id="d3897-113">Разместите данные с помощью функции хэширования с помощью хэш-алгоритма.</span><span class="sxs-lookup"><span data-stu-id="d3897-113">Put the data through a hashing function using the hash algorithm.</span></span>
4.  <span data-ttu-id="d3897-114">Включите в закодированные исходные данные, хэш-алгоритмы и хэши в кодированном сообщении.</span><span class="sxs-lookup"><span data-stu-id="d3897-114">Include the original data to be hashed, the hashing algorithms, and the hashes in the encoded message.</span></span>

<span data-ttu-id="d3897-115">Чтобы использовать функции обработки сообщений низкого уровня для выполнения задач, описанных выше, используйте следующую процедуру.</span><span class="sxs-lookup"><span data-stu-id="d3897-115">To use low-level message functions to accomplish the tasks just outlined, use the following procedure.</span></span>

<span data-ttu-id="d3897-116">**Хэширование и кодирование сообщения с помощью функций сообщений низкого уровня**</span><span class="sxs-lookup"><span data-stu-id="d3897-116">**To hash and encode a message using low-level message functions**</span></span>

1.  <span data-ttu-id="d3897-117">Создайте или извлеките содержимое для хэширования.</span><span class="sxs-lookup"><span data-stu-id="d3897-117">Create or retrieve the content to be hashed.</span></span>
2.  <span data-ttu-id="d3897-118">Получение поставщика служб шифрования.</span><span class="sxs-lookup"><span data-stu-id="d3897-118">Get a cryptographic provider.</span></span>
3.  <span data-ttu-id="d3897-119">Инициализируйте [**структуру \_ \_ \_ сведений о хэшированном кодировании КМСГ**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_hashed_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="d3897-119">Initialize the [**CMSG\_HASHED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_hashed_encode_info) structure.</span></span>
4.  <span data-ttu-id="d3897-120">Вызовите [**криптмсгкалкулатинкодедленгс**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) , чтобы получить размер BLOB-объекта закодированного сообщения.</span><span class="sxs-lookup"><span data-stu-id="d3897-120">Call [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) to get the size of the encoded message BLOB.</span></span> <span data-ttu-id="d3897-121">Выделите память для нее.</span><span class="sxs-lookup"><span data-stu-id="d3897-121">Allocate memory for it.</span></span>
5.  <span data-ttu-id="d3897-122">Вызовите [**криптмсгопентоенкоде**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), передав КМСГ \_ хэшированный для параметра *Двмсгтипе* и указатель на [**КМСГ \_ хэшированные \_ \_ сведения о кодировании**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_hashed_encode_info) для параметра *пвмсженкодеинфо* .</span><span class="sxs-lookup"><span data-stu-id="d3897-122">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing in CMSG\_HASHED for the *dwMsgType* parameter and a pointer to [**CMSG\_HASHED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_hashed_encode_info) for the *pvMsgEncodeInfo* parameter.</span></span> <span data-ttu-id="d3897-123">В результате этого вызова вы получаете маркер открытого сообщения.</span><span class="sxs-lookup"><span data-stu-id="d3897-123">As a result of this call, you get a handle to the opened message.</span></span>
6.  <span data-ttu-id="d3897-124">Вызовите [**криптмсгупдате**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), передав маркер, полученный на шаге 5, и указатель на данные, которые должны быть хэшированы и закодированы.</span><span class="sxs-lookup"><span data-stu-id="d3897-124">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passing in the handle retrieved in step 5 and a pointer to the data that is to be hashed and encoded.</span></span> <span data-ttu-id="d3897-125">Эту функцию можно вызывать столько раз, сколько необходимо для завершения процесса кодирования.</span><span class="sxs-lookup"><span data-stu-id="d3897-125">This function can be called as many times as necessary to complete the encoding process.</span></span>
7.  <span data-ttu-id="d3897-126">Вызовите [**криптмсгжетпарам**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), передав маркер, полученный на шаге 5, и соответствующие типы параметров для доступа к нужным закодированным данным.</span><span class="sxs-lookup"><span data-stu-id="d3897-126">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passing in the handle retrieved in step 5 and the appropriate parameter types to access the desired, encoded data.</span></span> <span data-ttu-id="d3897-127">Например, передайте значение \_ параметра КМСГ Content \_ param, чтобы получить указатель на все сообщение [*PKCS \# 7*](../secgloss/p-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="d3897-127">For example, pass in CMSG\_CONTENT\_PARAM to get a pointer to the entire [*PKCS \#7*](../secgloss/p-gly.md) message.</span></span>

    <span data-ttu-id="d3897-128">Если результат этой кодировки будет использоваться в качестве [*внутренних данных*](../secgloss/i-gly.md) для другого закодированного сообщения, например сообщения, упакованного в оболочку, \_ \_ \_ необходимо передать параметр КМСГ для исходного содержимого.</span><span class="sxs-lookup"><span data-stu-id="d3897-128">If the result of this encoding is to be used as the [*inner data*](../secgloss/i-gly.md) for another encoded message, such as an enveloped message, CMSG\_BARE\_CONTENT\_PARAM must be passed.</span></span> <span data-ttu-id="d3897-129">Пример, демонстрирующий это, см. в разделе [альтернативный код для кодирования запечатанного сообщения](alternate-code-for-encoding-an-enveloped-message.md).</span><span class="sxs-lookup"><span data-stu-id="d3897-129">For an example showing this, see [Alternate Code for Encoding an Enveloped Message](alternate-code-for-encoding-an-enveloped-message.md).</span></span>

8.  <span data-ttu-id="d3897-130">Закройте сообщение, вызвав [**криптмсгклосе**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span><span class="sxs-lookup"><span data-stu-id="d3897-130">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="d3897-131">Результатом этой процедуры является закодированное сообщение, содержащее исходные данные, алгоритмы хэширования и [*хэш*](../secgloss/h-gly.md) этих данных.</span><span class="sxs-lookup"><span data-stu-id="d3897-131">The result of this procedure is an encoded message that contains the original data, the hashing algorithms, and the [*hash*](../secgloss/h-gly.md) of that data.</span></span> <span data-ttu-id="d3897-132">Указатель на [*большой двоичный объект*](../secgloss/b-gly.md) закодированного сообщения получен на шаге 7.</span><span class="sxs-lookup"><span data-stu-id="d3897-132">A pointer to the encoded message [*BLOB*](../secgloss/b-gly.md) is obtained in step 7.</span></span>

<span data-ttu-id="d3897-133">Следующие две процедуры используются для декодирования и последующей проверки хэшированных данных.</span><span class="sxs-lookup"><span data-stu-id="d3897-133">The following two procedures decode and then verify hashed data.</span></span>

<span data-ttu-id="d3897-134">**Расшифровка хэшированных данных**</span><span class="sxs-lookup"><span data-stu-id="d3897-134">**To decode hashed data**</span></span>

1.  <span data-ttu-id="d3897-135">Получение указателя на закодированный BLOB-объект.</span><span class="sxs-lookup"><span data-stu-id="d3897-135">Get a pointer to the encoded BLOB.</span></span>
2.  <span data-ttu-id="d3897-136">Вызовите [**криптмсгопентодекоде**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentodecode), передав необходимые аргументы.</span><span class="sxs-lookup"><span data-stu-id="d3897-136">Call [**CryptMsgOpenToDecode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentodecode), passing the necessary arguments.</span></span>
3.  <span data-ttu-id="d3897-137">Вызовите [**криптмсгупдате**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) один раз, передав маркер, полученный на шаге 2, и указатель на данные, которые необходимо декодировать.</span><span class="sxs-lookup"><span data-stu-id="d3897-137">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate) once, passing in the handle retrieved in step 2 and a pointer to the data that is to be decoded.</span></span> <span data-ttu-id="d3897-138">Это приводит к тому, что в зависимости от типа сообщений в сообщении будут выполняться соответствующие действия.</span><span class="sxs-lookup"><span data-stu-id="d3897-138">This causes the appropriate actions to be taken on the message, depending on the message type.</span></span>
4.  <span data-ttu-id="d3897-139">Вызовите [**криптмсгжетпарам**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), передав маркер, полученный на шаге 2, и соответствующие типы параметров для доступа к нужным декодированным данным.</span><span class="sxs-lookup"><span data-stu-id="d3897-139">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passing in the handle retrieved in step 2, and the appropriate parameter types to access the desired, decoded data.</span></span> <span data-ttu-id="d3897-140">Например, передайте значение \_ параметра КМСГ Content \_ param, чтобы получить указатель на декодированное содержимое.</span><span class="sxs-lookup"><span data-stu-id="d3897-140">For example, pass in CMSG\_CONTENT\_PARAM to get a pointer to the decoded content.</span></span>

<span data-ttu-id="d3897-141">**Проверка хэша**</span><span class="sxs-lookup"><span data-stu-id="d3897-141">**To verify the hash**</span></span>

1.  <span data-ttu-id="d3897-142">Вызовите [**криптмсгконтрол**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcontrol), передав КМСГ \_ CTRL \_ , \_ чтобы проверить хэши.</span><span class="sxs-lookup"><span data-stu-id="d3897-142">Call [**CryptMsgControl**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcontrol), passing in CMSG\_CTRL\_VERIFY\_HASH to verify the hashes.</span></span>
2.  <span data-ttu-id="d3897-143">Вызовите [**криптмсгклосе**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose) , чтобы закрыть сообщение.</span><span class="sxs-lookup"><span data-stu-id="d3897-143">Call [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose) to close the message.</span></span>

<span data-ttu-id="d3897-144">Пример программы см. в разделе [Пример программы C: кодирование и декодирование хэшированного сообщения](example-c-program-encoding-and-decoding-a-hashed-message.md).</span><span class="sxs-lookup"><span data-stu-id="d3897-144">For an example program, see [Example C Program: Encoding and Decoding a Hashed Message](example-c-program-encoding-and-decoding-a-hashed-message.md).</span></span>

 

 
