---
title: Буферизируемые службы
description: Буферизируемые службы
ms.assetid: 4816ab05-42fc-4c22-b753-8fd153d88c27
keywords:
- файловые операции ввода-вывода мультимедиа, буферизованные службы
- файловый ввод-вывод, буферизованные службы
- входные и выходные данные (ввод-вывод), буферизованные службы
- Ввод-вывод (входные и выходные данные), буферизованные службы
- буферизованный ввод-вывод
- Функция Ммиупен
- внутренний буфер ввода-вывода
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d014ed765609dd43886cc7b33987f8fd5ac7e65a
ms.sourcegitcommit: 7ef31bf778e76ce4196205d4c4c632fbdc649805
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2021
ms.locfileid: "103999807"
---
# <a name="buffered-services"></a><span data-ttu-id="2b1a4-110">Буферизируемые службы</span><span class="sxs-lookup"><span data-stu-id="2b1a4-110">Buffered Services</span></span>

<span data-ttu-id="2b1a4-111">Большая часть издержек в файловых операциях ввода-вывода возникает при доступе к устройству мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-111">Most of the overhead in file I/O occurs when accessing the media device.</span></span> <span data-ttu-id="2b1a4-112">При чтении или записи большого количества мелких блоков информации устройство может потратить много времени на перемещение в физическое место на носителе для каждой операции чтения или записи.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-112">If you are reading or writing many small blocks of information, the device can spend a lot of time moving to the physical location on the media for each read or write operation.</span></span> <span data-ttu-id="2b1a4-113">В этом случае можно повысить производительность с помощью буферизованных файловых операций ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-113">In this case, you can achieve better performance by using buffered file I/O services.</span></span> <span data-ttu-id="2b1a4-114">При буферизованном вводе-выводе диспетчер файлового ввода-вывода обслуживает промежуточный буфер, превышающий количество блоков данных, которые вы читаете или пишете.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-114">With buffered I/O, the file I/O manager maintains an intermediate buffer larger than the blocks of information you are reading or writing.</span></span> <span data-ttu-id="2b1a4-115">Он обращается к устройству только в том случае, если буфер должен быть заполнен или записан на диск.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-115">It accesses the device only when the buffer must be filled from or written to the disk.</span></span>

<span data-ttu-id="2b1a4-116">Перед настройкой и использованием буферизованного файлового ввода-вывода необходимо решить, нужно ли, чтобы Файловый диспетчер ввода-вывода или приложение выделили буфер.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-116">Before you set up and use buffered file I/O, you must decide whether you want the file I/O manager or the application to allocate the buffer.</span></span> <span data-ttu-id="2b1a4-117">Проще позволить диспетчеру файлового ввода-вывода выделить буфер.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-117">It is simpler to let the file I/O manager allocate the buffer.</span></span> <span data-ttu-id="2b1a4-118">Однако можно позволить приложению выделить буфер, если требуется получить прямой доступ к буферу или открыть файл памяти.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-118">However, you can let the application allocate the buffer if you want to directly access the buffer or open a memory file.</span></span> <span data-ttu-id="2b1a4-119">Дополнительные сведения об использовании файлов памяти см. в разделе [выполнение операций файлового ввода-вывода в памяти](performing-memory-file-i-o.md).</span><span class="sxs-lookup"><span data-stu-id="2b1a4-119">For more information about using memory files, see [Performing Memory File I/O](performing-memory-file-i-o.md).</span></span> <span data-ttu-id="2b1a4-120">Пример прямого доступа к буферу ввода-вывода см. в разделе [доступ к буферу файлового ввода-вывода](accessing-a-file-i-o-buffer.md) .</span><span class="sxs-lookup"><span data-stu-id="2b1a4-120">For an example of directly accessing an I/O buffer, see [Accessing a File I/O Buffer](accessing-a-file-i-o-buffer.md)</span></span>

<span data-ttu-id="2b1a4-121">Буфер, выделенный диспетчером файлового ввода-вывода, называется внутренним буфером ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-121">A buffer allocated by the file I/O manager is called an internal I/O buffer.</span></span> <span data-ttu-id="2b1a4-122">Чтобы открыть файл для буферизованного ввода-вывода с помощью внутреннего буфера, укажите \_ флаг АЛЛОКБУФ MMIO при открытии файла с помощью функции [**ммиупен**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioopen) .</span><span class="sxs-lookup"><span data-stu-id="2b1a4-122">To open a file for buffered I/O using an internal buffer, specify the MMIO\_ALLOCBUF flag when you open the file with the [**mmioOpen**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioopen) function.</span></span> <span data-ttu-id="2b1a4-123">На следующем рисунке показано начальное состояние буфера файлового ввода-вывода после открытия файла для буферизованной операции чтения.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-123">The following illustration shows the initial state of the file I/O buffer after a file is opened for a buffered read operation.</span></span> <span data-ttu-id="2b1a4-124">Буферизация прозрачна — вы читаете и ищете, как если бы вы использовали операции ввода-вывода без буферизации.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-124">The buffering is transparent — you read and seek as if you were using unbuffered I/O.</span></span> <span data-ttu-id="2b1a4-125">Функция **ммиупен** установила Пчнекст и *пчендреад* , указывающие на начало буфера файлового ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-125">The **mmioOpen** function has set pchNext and *pchEndRead* to point to the beginning of the file I/O buffer.</span></span>

![Снимок экрана, на котором показаны "Пчендреад" и "Пчнекст", указывающие на начало буфера файлового ввода-вывода.](images/mmio7.gif)

<span data-ttu-id="2b1a4-127">На следующем рисунке показано начальное состояние буфера файлового ввода-вывода после открытия файла для буферизованной операции записи.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-127">The following illustration shows the initial state of the file I/O buffer after a file is opened for a buffered write operation.</span></span> <span data-ttu-id="2b1a4-128">Функция **ммиупен** установила **пчнекст** , чтобы она указывала на начало буфера файлового ввода-вывода и **пчендврите** , чтобы она указывала на конец буфера.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-128">The **mmioOpen** function has set **pchNext** to point to the beginning of the file I/O buffer and **pchEndWrite** to point to the end of the buffer.</span></span>

![Снимок экрана, показывающий "Пчнекст" в начале буфера файлового ввода-вывода и "Пчендврите" в конце.](images/mmio11.gif)

<span data-ttu-id="2b1a4-130">Размер внутреннего буфера ввода-вывода по умолчанию — 8 КБ.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-130">The default size of the internal I/O buffer is 8K.</span></span> <span data-ttu-id="2b1a4-131">Если этот размер недостаточен, можно использовать функцию [**ммиосетбуффер**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetbuffer) для изменения размера буфера.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-131">If this size is not adequate, you can use the [**mmioSetBuffer**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetbuffer) function to change the buffer size.</span></span> <span data-ttu-id="2b1a4-132">Эту функцию также можно использовать для включения буферизации файла, открытого для небуферизованного ввода-вывода, или для предоставления собственного буфера для использования в качестве файла памяти.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-132">You can also use this function to enable buffering on a file opened for unbuffered I/O, or to supply your own buffer for use as a memory file.</span></span>

<span data-ttu-id="2b1a4-133">Можно принудительно записать содержимое буфера ввода-вывода на диск с помощью функции [**ммиофлуш**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioflush) .</span><span class="sxs-lookup"><span data-stu-id="2b1a4-133">You can force the contents of an I/O buffer to be written to disk by using the [**mmioFlush**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioflush) function.</span></span> <span data-ttu-id="2b1a4-134">Однако при закрытии файла с помощью функции [**ммиоклосе**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioclose) нет необходимости вызывать **ммиофлуш** для записи буфера ввода-вывода — функция **ммиоклосе** автоматически сбрасывает ее.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-134">However, when you close a file by using the [**mmioClose**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioclose) function, you do not have to call **mmioFlush** to flush an I/O buffer — the **mmioClose** function automatically flushes it.</span></span> <span data-ttu-id="2b1a4-135">Если закончилось место на диске, **ммиофлуш** может завершиться сбоем, даже если предыдущие вызовы функции [**ммиоврите**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiowrite) были успешными.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-135">If you run out of disk space, **mmioFlush** could fail, even if the preceding calls to the [**mmioWrite**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiowrite) function were successful.</span></span> <span data-ttu-id="2b1a4-136">Аналогично, **ммиоклосе** может завершиться ошибкой, когда записывает буфер ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-136">Similarly, **mmioClose** could fail when it is flushing its I/O buffer.</span></span>

<span data-ttu-id="2b1a4-137">Приложения с учетом производительности, такие как потоковая передача данных с компакт-диска в реальном времени, могут оптимизировать производительность файлового ввода-вывода путем прямого доступа к буферу ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-137">Applications that are performance-sensitive, such as those that stream data in real time from a CD-ROM, can optimize file I/O performance by directly accessing the I/O buffer.</span></span> <span data-ttu-id="2b1a4-138">Следует быть внимательным, если вы решили это сделать, так как вы обходите некоторые меры защиты и проверку ошибок, предоставляемые диспетчером файлового ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-138">You should be careful if you choose to do this, because you bypass some of the safeguards and error checking provided by the file I/O manager.</span></span>

<span data-ttu-id="2b1a4-139">Диспетчер файлового ввода-вывода мультимедиа использует структуру [**ммиоинфо**](/previous-versions//dd757322(v=vs.85)) для сохранения сведений о состоянии открытого файла.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-139">The multimedia file I/O manager uses the [**MMIOINFO**](/previous-versions//dd757322(v=vs.85)) structure to maintain state information about an open file.</span></span> <span data-ttu-id="2b1a4-140">Для чтения и записи буфера ввода-вывода используются три члена этой структуры: **пчнекст**, **пчендреад** и **пчендврите**.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-140">You use three members in this structure to read and write the I/O buffer: **pchNext**, **pchEndRead**, and **pchEndWrite**.</span></span> <span data-ttu-id="2b1a4-141">Элемент **пчнекст** указывает на следующее место в буфере для чтения или записи.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-141">The **pchNext** member points to the next location in the buffer to read or write.</span></span> <span data-ttu-id="2b1a4-142">Необходимо увеличить этот элемент при чтении и записи буфера.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-142">You must increment this member as you read and write the buffer.</span></span> <span data-ttu-id="2b1a4-143">Элемент **пчендреад** определяет последний допустимый символ, который можно прочитать из буфера.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-143">The **pchEndRead** member identifies the last valid character you can read from the buffer.</span></span> <span data-ttu-id="2b1a4-144">Аналогичным образом, этот член определяет Последнее расположение в буфере, которое можно написать.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-144">Likewise, this member identifies the last location in the buffer you can write.</span></span> <span data-ttu-id="2b1a4-145">Точнее, как **пчендреад** , так и **пчендврите** указывают на расположение в памяти, следующее за последними допустимыми данными в буфере.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-145">More precisely, both **pchEndRead** and **pchEndWrite** point to the memory location that follows the last valid data in the buffer.</span></span> <span data-ttu-id="2b1a4-146">Используйте функции [**ммиожетинфо**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiogetinfo) и [**ммиосетинфо**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetinfo) для получения и задания сведений о состоянии буфера файлового ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-146">Use the [**mmioGetInfo**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiogetinfo) and [**mmioSetInfo**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetinfo) functions to retrieve and set state information about the file I/O buffer.</span></span> <span data-ttu-id="2b1a4-147">На следующем рисунке показано состояние буфера ввода-вывода после того, как приложение вызовет **ммиоадванце** во время операции чтения.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-147">The following illustration shows the state of the I/O buffer after the application calls **mmioAdvance** during a read operation.</span></span> <span data-ttu-id="2b1a4-148">Функция **ммиоадванце** заполняет буфер и устанавливает указатель **пчендреад** на конец буфера.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-148">The **mmioAdvance** function fills the buffer and sets the **pchEndRead** pointer to the end of the buffer.</span></span>

![Снимок экрана, показывающий "Пчнекст" в начале буфера файлового ввода-вывода и "Пчендреад" в конце.](images/mmio8.gif)

<span data-ttu-id="2b1a4-150">На следующем рисунке приложение считывает данные из буфера ввода-вывода в расположении, указанном параметром **пчнекст**, и перемещает указатель.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-150">In the following illustration, the application reads from the I/O buffer at the location specified by **pchNext**, and advances the pointer.</span></span>

![Снимок экрана, показывающий "Пчнекст" в середине буфера файлового ввода-вывода и "Пчендреад" в конце.](images/mmio9.gif)

<span data-ttu-id="2b1a4-152">Аналогично для операции записи приложение выполняет запись в буфер ввода-вывода и перемещает указатель **пчнекст** , как показано на следующем рисунке.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-152">Similarly, for a write operation, the application writes to the I/O buffer and advances the **pchNext** pointer, as shown in the following illustration.</span></span>

![Снимок экрана, показывающий "Пчнекст" в середине буфера файлового ввода-вывода и "Пчендврите" в конце.](images/mmio12.gif)

<span data-ttu-id="2b1a4-154">После заполнения буфера приложением вызывается **ммиоадванце** для записи буфера на диск.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-154">After the application fills the buffer, it calls **mmioAdvance** to flush the buffer to disk.</span></span> <span data-ttu-id="2b1a4-155">Функция **ммиоадванце** сбрасывает **пчнекст** , чтобы указывать на начало буфера, как показано на следующем рисунке.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-155">The **mmioAdvance** function resets **pchNext** to point to the beginning of the buffer, as shown in the following illustration.</span></span>

![Снимок экрана, показывающий "Пчнекст" в начале буфера файлового ввода-вывода, буфер в середине E O F и "Пчендврите" в конце буфера.](images/mmio13.gif)

<span data-ttu-id="2b1a4-157">Когда вы дойдете до конца буфера ввода-вывода, необходимо передвинуть буфер, чтобы его заполнить с диска, если выполняется чтение, или записать на диск при записи.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-157">When you reach the end of the I/O buffer, you must advance the buffer to fill it from the disk, if you are reading, or flush it to the disk, if you are writing.</span></span> <span data-ttu-id="2b1a4-158">Чтобы переместить буфер ввода-вывода, используйте функцию [**ммиоадванце**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioadvance) .</span><span class="sxs-lookup"><span data-stu-id="2b1a4-158">Use the [**mmioAdvance**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioadvance) function to advance an I/O buffer.</span></span> <span data-ttu-id="2b1a4-159">Чтобы заполнить буфер ввода-вывода с диска, используйте **ммиоадванце** с \_ флагом MMIO Read.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-159">To fill an I/O buffer from disk, use **mmioAdvance** with the MMIO\_READ flag.</span></span> <span data-ttu-id="2b1a4-160">Если в файле осталось недостаточно данных для заполнения буфера, элемент **пчендреад** структуры **ммиоинфо** указывает на расположение, следующее за последним допустимым байтом в буфере.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-160">If there is not enough data remaining in the file to fill the buffer, the **pchEndRead** member of the **MMIOINFO** structure points to the location following the last valid byte in the buffer.</span></span> <span data-ttu-id="2b1a4-161">Чтобы сбросить буфер на диск, установите \_ флаг MMIO "грязный" в элементе **DwFlags** структуры **ммиоинфо** , а затем вызовите **ммиоадванце** с \_ флагом записи MMIO.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-161">To flush a buffer to disk, set the MMIO\_DIRTY flag in the **dwFlags** member of the **MMIOINFO** structure and then call **mmioAdvance** with the MMIO\_WRITE flag.</span></span>

<span data-ttu-id="2b1a4-162">Например, во время операции чтения функция **ммиоадванце** задает **пчендреад** для указания на конец допустимых данных в буфере, как показано на следующем рисунке.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-162">For example, during a read operation, the **mmioAdvance** function sets **pchEndRead** to point to the end of valid data in the buffer, as shown in the following illustration.</span></span>

![Снимок экрана, показывающий "Пчнекст" в начале буфера файлового ввода-вывода, буфер в конце E O F и "Пчендреад" в конце буфера.](images/mmio10.gif)

<span data-ttu-id="2b1a4-164">Аналогичным образом во время операции записи приложение вызывает **ммиоадванце** , чтобы очистить буфер и продвинуть **пчнекст** до конца допустимых данных в буфере, как показано на следующем рисунке.</span><span class="sxs-lookup"><span data-stu-id="2b1a4-164">Similarly, during a write operation, the application calls **mmioAdvance** to flush the buffer and advance **pchNext** to the end of valid data in the buffer, as shown in the following illustration.</span></span>

![изображение буфера файлового ввода-вывода](images/mmio14.gif)

 

 