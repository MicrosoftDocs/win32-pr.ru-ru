---
title: Экземпляры драйверов
description: Экземпляры драйверов
ms.assetid: 93dba9e8-bfb3-4714-9466-cf5c78babcf2
keywords:
- устанавливаемые драйверы, экземпляры
- устанавливаемые драйверы, несколько экземпляров
- несколько экземпляров драйверов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 37148dcb12fbfa2984d4e55424102b5985165d9d
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "103775125"
---
# <a name="driver-instances"></a><span data-ttu-id="f6365-106">Экземпляры драйверов</span><span class="sxs-lookup"><span data-stu-id="f6365-106">Driver Instances</span></span>

<span data-ttu-id="f6365-107">Windows поддерживает несколько экземпляров устанавливаемого драйвера.</span><span class="sxs-lookup"><span data-stu-id="f6365-107">Windows allows for multiples instances of an installable driver.</span></span> <span data-ttu-id="f6365-108">Система создает экземпляр драйвера каждый раз при открытии драйвера и уничтожает экземпляр при закрытии драйвера.</span><span class="sxs-lookup"><span data-stu-id="f6365-108">The system creates an instance of the driver each time the driver is opened and destroys the instance when the driver is closed.</span></span> <span data-ttu-id="f6365-109">Экземпляры драйверов особенно полезны для устанавливаемых драйверов, которые поддерживают несколько устройств или могут быть открыты несколькими приложениями или одним приложением несколько раз.</span><span class="sxs-lookup"><span data-stu-id="f6365-109">Driver instances are especially useful for installable drivers that support multiple devices or that are opened by multiple applications or by the same application multiple times.</span></span>

<span data-ttu-id="f6365-110">Чтобы помочь драйверу отследить экземпляры, система отправляет обработчик экземпляров драйвера с каждым сообщением драйвера после создания экземпляра.</span><span class="sxs-lookup"><span data-stu-id="f6365-110">To help the driver keep track of the instances, the system sends a driver instance handle with each driver message after the instance has been created.</span></span> <span data-ttu-id="f6365-111">Поскольку этот обработчик уникально идентифицирует экземпляр, устанавливаемые драйверы часто связывают этот обработчик с памятью и другими ресурсами, которые были специально выделены для экземпляра.</span><span class="sxs-lookup"><span data-stu-id="f6365-111">Because this handle uniquely identifies the instance, installable drivers often associate the handle with memory and other resources that they have specifically allocated for the instance.</span></span>

<span data-ttu-id="f6365-112">При открытии первого экземпляра система отправляет в драйвер в указанном порядке все [**\_ открытые**](drv-open.md) сообщения с помощью [**\_ перегрузки DRV**](drv-load.md), [**DRV \_ Enable**](drv-enable.md)и DRV.</span><span class="sxs-lookup"><span data-stu-id="f6365-112">When the first instance is opened, the system sends the [**DRV\_LOAD**](drv-load.md), [**DRV\_ENABLE**](drv-enable.md), and [**DRV\_OPEN**](drv-open.md) messages to the driver in that order.</span></span> <span data-ttu-id="f6365-113">Сообщения DRV \_ Load и DRV \_ Enable позволяют уведомить драйвер о том, что он теперь находится в памяти и включен для работы.</span><span class="sxs-lookup"><span data-stu-id="f6365-113">The DRV\_LOAD and DRV\_ENABLE messages notify the driver that it is now in memory and is enabled for operation.</span></span> <span data-ttu-id="f6365-114">Сообщение с \_ открытым кодом DRV определяет экземпляр обработчика и может включать сведения о конфигурации для экземпляра.</span><span class="sxs-lookup"><span data-stu-id="f6365-114">The DRV\_OPEN message identifies the instance handle and may include configuration information for the instance.</span></span> <span data-ttu-id="f6365-115">При каждом последующем открытии экземпляра одного и того же драйвера система отправляет только сообщение, открытое в виде DRV \_ .</span><span class="sxs-lookup"><span data-stu-id="f6365-115">On each subsequent opening of an instance of the same driver, the system sends only a DRV\_OPEN message.</span></span>

<span data-ttu-id="f6365-116">При обработке \_ сообщения загрузки DRV драйвер, как правило, считывает параметры конфигурации из реестра, настраивает драйвер и соответствующее оборудование и выделяет память для использования всеми экземплярами драйвера.</span><span class="sxs-lookup"><span data-stu-id="f6365-116">When processing a DRV\_LOAD message, a driver typically reads configuration settings from the registry, configures the driver and any associated hardware, and allocates memory for use by all instances of the driver.</span></span> <span data-ttu-id="f6365-117">Если драйвер не может завершить настройку или выделить память, он возвращает нуль, чтобы направить систему на немедленное удаление драйвера из памяти и предотвратить отправку последующих сообщений.</span><span class="sxs-lookup"><span data-stu-id="f6365-117">If a driver cannot complete the configuration or allocate memory, it returns zero to direct the system to immediately remove the driver from memory and prevent any subsequent messages from being sent.</span></span> <span data-ttu-id="f6365-118">При обработке сообщения с \_ включенным параметром DRV драйвер подготавливает оборудование для приема и обработки запросов ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="f6365-118">When processing the DRV\_ENABLE message, the driver prepares the hardware to receive and process input and output (I/O) requests.</span></span> <span data-ttu-id="f6365-119">Подготовка может включать в себя установку обработчиков прерываний.</span><span class="sxs-lookup"><span data-stu-id="f6365-119">The preparation may include installing interrupt handlers.</span></span>

<span data-ttu-id="f6365-120">При обработке сообщения DRV \_ Open драйвер выделяет память или ресурсы, необходимые данному экземпляру драйвера, а затем возвращает ненулевое значение.</span><span class="sxs-lookup"><span data-stu-id="f6365-120">When processing the DRV\_OPEN message, the driver allocates memory or resources required by the given instance of the driver and then returns a nonzero value.</span></span> <span data-ttu-id="f6365-121">Система использует это ненулевое значение в качестве *идентификатора драйвера* в последующих сообщениях драйвера для экземпляра.</span><span class="sxs-lookup"><span data-stu-id="f6365-121">The system uses this nonzero value as the *driver identifier* in subsequent driver messages for the instance.</span></span> <span data-ttu-id="f6365-122">Драйвер может использовать этот идентификатор для любой цели.</span><span class="sxs-lookup"><span data-stu-id="f6365-122">The driver can use this identifier for any purpose.</span></span> <span data-ttu-id="f6365-123">Например, некоторые драйверы используют для идентификатора маркер памяти, чтобы получить быстрый доступ к памяти, содержащей сведения о данном экземпляре.</span><span class="sxs-lookup"><span data-stu-id="f6365-123">For example, some drivers use a memory handle for the identifier to gain quick access to memory containing information about the given instance.</span></span>

<span data-ttu-id="f6365-124">Многие устанавливаемые драйверы обрабатывают второй параметр \_ сообщения DRV Open, предоставляя системе и приложениям возможность отправки дополнительных сведений драйверу при открытии экземпляра.</span><span class="sxs-lookup"><span data-stu-id="f6365-124">Many installable drivers process the second parameter of the DRV\_OPEN message, giving the system and applications the means to send additional information to the driver when opening an instance.</span></span> <span data-ttu-id="f6365-125">Параметр может быть одиночным значением или адресом структуры, содержащей набор значений.</span><span class="sxs-lookup"><span data-stu-id="f6365-125">The parameter can be a single value or an address of a structure containing a set of values.</span></span> <span data-ttu-id="f6365-126">При обработке DRV \_ Open драйвер проверяет параметр, чтобы определить, является ли он значением, и использует заданные значения (если таковые имеются) для завершения создания экземпляра.</span><span class="sxs-lookup"><span data-stu-id="f6365-126">When processing DRV\_OPEN, the driver checks the parameter to determine whether it is a value and uses the given values, if any, to complete the creation of the instance.</span></span>

<span data-ttu-id="f6365-127">Система отправляет сообщение [**\_ закрытия DRV**](drv-close.md) каждый раз при закрытии экземпляра.</span><span class="sxs-lookup"><span data-stu-id="f6365-127">The system sends a [**DRV\_CLOSE**](drv-close.md) message each time an instance is closed.</span></span> <span data-ttu-id="f6365-128">Обработчик экземпляра, отправленный с сообщением, определяет, какой экземпляр нужно закрыть.</span><span class="sxs-lookup"><span data-stu-id="f6365-128">The instance handle sent with the message identifies which instance to close.</span></span> <span data-ttu-id="f6365-129">Когда последний оставшийся экземпляр закрывается, система отправляет \_ в этом порядке [**\_ Бесплатные**](drv-free.md) сообщения, которые [**\_ отключаются**](drv-disable.md)к Close, DRV и DRV.</span><span class="sxs-lookup"><span data-stu-id="f6365-129">When the last remaining instance is closed, the system sends the DRV\_CLOSE, [**DRV\_DISABLE**](drv-disable.md), and [**DRV\_FREE**](drv-free.md) messages in that order.</span></span> <span data-ttu-id="f6365-130">\_Сообщение о закрытии DRV указывает драйверу закрыть экземпляр, а \_ сообщения, отключенные и DRV, \_ не уведомлят драйвер о том, что он сейчас отключен и будет немедленно освобожден из памяти.</span><span class="sxs-lookup"><span data-stu-id="f6365-130">The DRV\_CLOSE message directs the driver to close the instance, and the DRV\_DISABLE and DRV\_FREE messages notify the driver that it is now disabled and will be immediately freed from memory.</span></span>

<span data-ttu-id="f6365-131">При обработке сообщения о \_ закрытии DRV драйвер, как правило, освобождает память или ресурсы, выделенные для экземпляра.</span><span class="sxs-lookup"><span data-stu-id="f6365-131">When processing the DRV\_CLOSE message, the driver typically frees any memory or resources allocated for the instance.</span></span> <span data-ttu-id="f6365-132">При обработке \_ сообщения об отключении DRV драйвер помещает любое оборудование в неактивное состояние, которое может включать удаление обработчиков прерываний.</span><span class="sxs-lookup"><span data-stu-id="f6365-132">When processing the DRV\_DISABLE message, the driver places any hardware in an inactive state, which may include the removal of interrupt handlers.</span></span> <span data-ttu-id="f6365-133">При обработке сообщения DRV \_ Free драйвер освобождает память или ресурсы, которые все еще выделены.</span><span class="sxs-lookup"><span data-stu-id="f6365-133">When processing the DRV\_FREE message, the driver frees any memory or resources that are still allocated.</span></span>

<span data-ttu-id="f6365-134">Устанавливаемые драйверы не обязательно должны поддерживать несколько экземпляров.</span><span class="sxs-lookup"><span data-stu-id="f6365-134">Installable drivers are not required to support multiple instances.</span></span> <span data-ttu-id="f6365-135">Драйвер может препятствовать созданию экземпляра, возвращая нулевое значение для открытого сообщения [**DRV \_**](drv-open.md) .</span><span class="sxs-lookup"><span data-stu-id="f6365-135">A driver can prevent any instance from being created by returning zero for the [**DRV\_OPEN**](drv-open.md) message.</span></span>

 

 




