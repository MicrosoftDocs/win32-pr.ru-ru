---
title: Структуры (RPC)
description: Описание различных типов структур в удаленном вызове процедур (RPC).
ms.assetid: edaf547d-d3d1-443c-93dd-8e036bc42944
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1783508a834ce2fa3d93d3db04edc1de362d6f888c29511c1eb6852cce0e83ae
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "120017414"
---
# <a name="structures-rpc"></a>Структуры (RPC)

Существует несколько категорий структур, которые постепенно более сложны в отношении действий, необходимых для маршалирования. Они начинаются с простой структуры, которую можно блокировать, копировать в целом и продолжать до сложной структуры, которая должна обслуживаться полем по полю.

-   [Простая структура](#simple-structure)
-   [Простая структура с указателями](#simple-structure-with-pointers)
-   [Согласованная структура](#conformant-structure)
-   [Согласованная структура с указателями](#conformant-structure-with-pointers)
-   [Согласованная структура (с указателями или без них)](#conformant-varying-structure-with-or-without-pointers)
-   [Жесткая структура](#hard-structure)
-   [Сложная структура](#complex-structure)
-   [Описание макета элемента структуры](#structure-member-layout-description)

> [!Note]  
> По сравнению с категориями массива становится ясно, что можно описать только структуры размером до 64 КБ (размер для плоской части структуры), то есть не имеет эквивалента массивов SM и LG.

 

**Элементы, общие для структур**

-   **Выравнивание**

    Необходимое выравнивание буфера перед деупаковкой структуры. Допустимые значения: 0, 1, 3 и 7 (фактическое выравнивание минус 1).

-   **\_объем памяти**

    Размер структуры в памяти в байтах; для согласованных структур этот размер не включает размер массива.

-   **смещение \_ к \_ \_ описанию массива**

    Смещение от текущего указателя строки формата к описанию согласованного массива, содержащегося в структуре.

-   **\_макет элемента**

    Описание каждого элемента структуры. Подпрограммы NDR должны проверять эту часть строки формата типа, если требуется преобразование с обратным порядком байтов или если тип является сложной структурой.

-   **\_Макет указателя**

    См. раздел [Макет указателя](pointer-layout-tfs.md) .

## <a name="simple-structure"></a>Простая структура

Простая структура содержит только базовые типы, фиксированные массивы и другие простые структуры. Основная функция простой структуры заключается в том, что ее можно блокировать и копировать в целом.

``` syntax
FC_STRUCT alignment<1> 
memory_size<2> 
member_layout<> 
FC_END
```

## <a name="simple-structure-with-pointers"></a>Простая структура с указателями

Простая структура с указателями содержит только базовые типы, указатели, фиксированные массивы, простые структуры и другие простые структуры с указателями. Так как при преобразовании архитектуре необходимо только посещение<> макета, оно помещается в конец описания.

``` syntax
FC_PSTRUCT alignment<1> 
memory_size<2> 
pointer_layout<> 
member_layout<> 
FC_END
```

## <a name="conformant-structure"></a>Согласованная структура

Согласованная структура содержит только базовые типы, фиксированные массивы и простые структуры и должна содержать либо согласованную строку, либо согласованный массив. Этот массив фактически может содержаться в другой согласованной структуре или в согласованной структуре с указателями, внедренными в эту структуру.

``` syntax
FC_CSTRUCT alignment<1> 
memory_size<2> 
offset_to_array_description<2> 
member_layout<> 
FC_END
```

## <a name="conformant-structure-with-pointers"></a>Согласованная структура с указателями

Согласованная структура с указателями содержит только базовые типы, указатели, фиксированные массивы, простые структуры и простые структуры с указателями. Согласованная структура должна содержать согласованный массив. Этот массив фактически может содержаться в другой согласованной структуре или в согласованной структуре с указателями, внедренными в эту структуру.

``` syntax
FC_CPSTRUCT alignment<1> 
memory_size<2> 
offset_to_array_description<2> 
pointer_layout<> 
member_layout<> FC_END
```

## <a name="conformant-varying-structure-with-or-without-pointers"></a>Согласованная структура (с указателями или без них)

В согласованной различной структуре содержатся только простые типы, указатели, фиксированные массивы, простые структуры и простые структуры с указателями. Согласованная структура должна содержать либо согласованную строку, либо согласованный, изменяющихся массив. Согласованная строка или массив фактически могут содержаться в другой согласованной структуре или согласованной структуре с указателями, внедренными в эту структуру.

``` syntax
FC_CVSTRUCT alignment<1> 
memory_size<2> 
offset_to_array_description<2> 
[pointer_layout<>] 
layout<> 
FC_END
```

## <a name="hard-structure"></a>Жесткая структура

Жесткая структура была концепцией, направленной на устранение тяжелых потерь, связанных с обработкой сложных структур. Он является производным от наблюдения за тем, что сложная структура обычно имеет только одно или два условия, предотвращающие копирование блоков и, следовательно, вредно его производительность по сравнению с простой структурой. Эти причины обычно являются объединениями или полями перечисления.

Жесткая структура — это структура с enum16, заполнением в памяти или объединением в качестве последнего элемента. Эти три элемента препятствуют переходу структуры в одну из предыдущих категорий структуры, что повлияет на небольшие издержки на интерпретацию и максимальную оптимизацию, но не следует применять их к категории очень дорогостоящей сложной структуры.

Enum16 не должен приводить к разным размерам памяти и сети в структуре. Структура не может иметь ни одного согласованного массива или ни одного указателя (если только часть объединения); единственными допустимыми членами являются базовые типы, фиксированные массивы и простые структуры.

``` syntax
FC_HARD_STRUCTURE alignment<1> 
memory_size<2> 
reserved<4> 
enum_offset<2> 
copy_size<2> 
mem_copy_incr<2> 
union_description_offset<2>
member_layout<> 
FC_END
```

Смещение Enum \_<2> предоставляет смещение от начала структуры в памяти до enum16, если оно содержит единицу. в противном случае \_ смещение enum<2> поле равно – 1.

\_Поле размер копии<2> предоставляет общее число байтов в структуре, которые могут быть заблокированы в буфере или скопированы в него. Этот итог не включает в себя все замыкающие объединения и заполнение в памяти. Это значение также представляет собой величину, с которой указатель буфера должен увеличиваться после копирования.

Поле MEM \_ Copy \_ incr<2> — это количество байтов, которое должен увеличить указатель памяти после блока-Copy перед обработкой любого замыкающего объединения. Приращение в этом объеме (не по \_ размеру копии<2> байтах) приводит к правильному указателю на память для любого замыкающего объединения.

## <a name="complex-structure"></a>Сложная структура

Сложная структура — это любая структура, содержащая одно или несколько полей, которые либо препятствуют копированию в блок, либо, для которой должна быть выполнена дополнительная проверка во время маршалирования или распаковки (например, связанные проверки перечисления). Следующие типы NDR относятся к этой категории:

-   [простые типы](simple-types-tfs.md): ENUM16, \_ \_ INT3264 (только на 64-разрядных платформах), интеграл с \[ [ **диапазоном**](/windows/desktop/Midl/range)\]
-   Выравнивание отступа в конце структуры
-   указатели интерфейса (они используют внедренный сложный)
-   Игнорируемые указатели (которые связаны с \[ [](/windows/desktop/Midl/ignore) \] атрибутом Ignore и \_ маркером игнорирования токена FC)
-   сложные массивы, различные массивы, массивы строк
-   многомерные массивы, имеющие по меньшей мере одно нефиксированное измерение
-   объединения
-   элементы, определенные с помощью \[ [**передачи \_ as**](/windows/desktop/Midl/transmit-as) \] , \[ [**представляются \_ как**](/windows/desktop/Midl/represent-as) \] , \[ [**проводная \_ Упаковка**](/windows/desktop/Midl/wire-marshal) \] , \[ [**\_ маршалирование пользователя**](/windows/desktop/Midl/user-marshal)\]
-   внедренные сложные структуры
-   заполнение в конце структуры

Сложная структура имеет следующее описание формата:

``` syntax
FC_BOGUS_STRUCT alignment<1> 
memory_size<2> 
offset_to_conformant_array_description<2> 
offset_to_pointer_layout<2> 
member_layout<> 
FC_END 
[pointer_layout<>]
```

Размер памяти \_<2> поле — это размер структуры в памяти в байтах.

Если структура содержит согласованный массив, то смещение \_ в \_ \_ описании соответствия массиву \_<2> поле предоставляет смещение к описанию согласованного массива, в противном случае — ноль.

Если структура имеет указатели, то смещение \_ в \_ \_ макете указателя<2> поле предоставляет смещение после макета структуры указателем, в противном случае это поле равно нулю.

Макет указателя \_<> поле сложной структуры обрабатывается несколько иначе, чем для других структур. Макет указателя \_<> поле сложной структуры содержит только описания фактических полей указателя в самой структуре. Любые указатели, содержащиеся в любых внедренных массивах, объединениях или структурах, не описываются в макете указателя сложной структуры \_<> поле.

> [!Note]  
> Это отличается от других структур, которые дублируют описание всех указателей, содержащихся во внедренных массивах или структурах, в их собственном \_ макете указателя<> поле.

 

Формат макета с указателем сложной структуры также имеет коренные отличия. Так как он содержит только описания фактических элементов указателя, а сложная структура упакована и неупакована по одному полю за раз, \_ Макет указателя<> поле просто содержит описание указателя всех членов указателя. PP FC не существует \_ , и ни один из обычных макетов указателей не \_<> информации.

## <a name="structure-member-layout-description"></a>Описание макета элемента структуры

Описание макета структуры содержит один или несколько следующих символов формата:

-   Любой из символов базового типа, например FC \_ char и т. д.
-   Директивы выравнивания. Существует три символа формата, определяющие выравнивание указателя памяти: FC \_ ALIGNM2, FC \_ ALIGNM4 и FC \_ ALIGNM8.
    > [!Note]  
    > Существуют также маркеры выравнивания буфера, FC \_ ALIGNB2 через FC \_ ALIGNM8; они не используются.

     

-   Заполнение памяти. Они происходят только в конце описания структуры и обозначают число байтов заполнения в памяти перед согласованным массивом в структуре: FC \_ структпадн, где n — число байтов заполнения.
-   Любой внедренный небазовый тип (Обратите внимание, что согласованный массив никогда не происходит в макете структуры). Это 4-байтное описание:

    ``` syntax
    FC_EMBEDDED_COMPLEX memory_pad<1> 
    offset_to_description<2>,
    ```

    где смещение не гарантируется в 2 байта.

    \_панель памяти<1> — это дополнение, необходимое в памяти перед сложным полем.

    смещение \_ к \_ описанию<2> — это относительное смещение типа к внедренному типу.

Кроме того \_ , при необходимости можно использовать клавиатуру FC перед завершающим \_ ЗАВЕРШЕНИЕм FC, чтобы обеспечить выравнивание строки формата по 2-байтовой границе после \_ конца FC.

 

 