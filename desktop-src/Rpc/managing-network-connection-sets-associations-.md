---
title: Управление наборами сетевых подключений (ассоциациями)
description: Начиная с Windows 2000, время выполнения RPC может поддерживать более одного подключения между клиентом и сервером.
ms.assetid: 9b9c42e9-8ed5-46a6-b6ec-4093ce0128bb
keywords:
- Управление наборами сетевых подключений
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 81e99afe23d90e44d85dc7a2ec9301b45e1f20b1
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "104258770"
---
# <a name="managing-network-connection-sets-associations"></a><span data-ttu-id="7b1a5-104">Управление наборами сетевых подключений (ассоциациями)</span><span class="sxs-lookup"><span data-stu-id="7b1a5-104">Managing Network Connection Sets (Associations)</span></span>

<span data-ttu-id="7b1a5-105">Начиная с Windows 2000, время выполнения RPC может поддерживать более одного подключения между клиентом и сервером.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-105">Starting with Windows 2000, the RPC run time may maintain more than one connection between the client and the server.</span></span> <span data-ttu-id="7b1a5-106">Это упрощает работу с транспортами, которые не поддерживают изменение удостоверения клиента без повторного создания соединения, многопоточных клиентов и асинхронных клиентов.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-106">This facilitates operation on transports that do not support changing the client identity without reestablishing the connection, multithreaded clients, and asynchronous clients.</span></span> <span data-ttu-id="7b1a5-107">Набор соединений между клиентским процессом и конечной точкой сервера называется *Ассоциацией* в терминологии RPC.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-107">The set of connections between a client process and a server endpoint is called an *association* in RPC terminology.</span></span> <span data-ttu-id="7b1a5-108">Понимание взаимосвязей может улучшить реализацию RPC.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-108">Understanding associations can improve the implementation of RPC.</span></span>

<span data-ttu-id="7b1a5-109">В сценарии однопотокового удостоверения с одним потоком RPC открывает одно соединение между клиентским процессом и конечной точкой сервера для выполнения вызовов RPC.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-109">In a single-thread, single-client identity scenario, RPC opens one connection between a client process and a server endpoint to make RPC calls.</span></span> <span data-ttu-id="7b1a5-110">Когда выполняется синхронный вызов RPC, клиент отправляет запрос серверу через это подключение и получает ответ на него.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-110">When a synchronous RPC call is made, the client sends the request to the server on this connection, and receives the reply on it as well.</span></span> <span data-ttu-id="7b1a5-111">Когда число потоков, выполняющих вызовы RPC в клиентском процессе, растет, идентификатор безопасности клиента может измениться.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-111">When the number of threads making RPC calls in the client process grows, the security identity of the client can change.</span></span> <span data-ttu-id="7b1a5-112">При смешении асинхронных вызовов/каналов с синхронными вызовами на клиенте RPC может потребоваться более одного сетевого подключения.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-112">When asynchronous/pipe calls are mixed with synchronous calls on the client, RPC may need more than one network connection.</span></span> <span data-ttu-id="7b1a5-113">Все соединения в наборе помещаются в пул соединений, называемый ассоциацией.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-113">All connections in the set are put in a connection pool called an association.</span></span>

<span data-ttu-id="7b1a5-114">Синхронный удаленный вызов процедур использует только заданное соединение для обеспечения соответствия стандартам RPC.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-114">A synchronous remote procedure call exclusively uses a given connection to conform with RPC standards.</span></span> <span data-ttu-id="7b1a5-115">Соединение, используемое синхронным вызовом RPC, считается занятым, если запрос был отправлен, но ответ не был получен.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-115">A connection used by a synchronous RPC call is considered busy if a request has been sent, but a response has not been received.</span></span> <span data-ttu-id="7b1a5-116">В этом подключении не разрешается никакой другой трафик, пока не будет получен ответ.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-116">No other traffic is allowed on that connection until the response is received.</span></span> <span data-ttu-id="7b1a5-117">Во время выполнения RPC выполняется попытка мультиплексирования асинхронных вызовов RPC и вызова по конвейеру в одном соединении.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-117">The RPC run time attempts to multiplex asynchronous and pipe RPC calls on the same connection.</span></span> <span data-ttu-id="7b1a5-118">Синхронные и асинхронные вызовы по конвейеру не могут смешиваться в одном соединении. Это означает, что данное соединение может использоваться для синхронных вызовов RPC или для асинхронных вызовов RPC/pipe.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-118">Synchronous and asynchronous/pipe calls cannot be mixed on the same connection, which means that a given connection can be used for either synchronous RPC calls or for asynchronous/pipe RPC calls.</span></span>

<span data-ttu-id="7b1a5-119">RPC активно пытается повторно использовать подключения из пула.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-119">RPC aggressively tries to reuse connections from the pool.</span></span> <span data-ttu-id="7b1a5-120">Когда выполняется новый вызов RPC, RPC пытается найти подходящее подключение из пула и создает новое соединение, только если не удается найти подходящее подключение.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-120">When a new RPC call is made, RPC attempts to find a suitable connection from the pool, and creates a new connection only if a suitable connection cannot be found.</span></span> <span data-ttu-id="7b1a5-121">Чтобы соединение считалось подходящим, оно должно:</span><span class="sxs-lookup"><span data-stu-id="7b1a5-121">For a connection to be considered suitable, it must:</span></span>

-   <span data-ttu-id="7b1a5-122">Должен иметь соответствующий тип (синхронный или асинхронный/канал).</span><span class="sxs-lookup"><span data-stu-id="7b1a5-122">Be of the appropriate type (synchronous, or asynchronous/pipe).</span></span>
-   <span data-ttu-id="7b1a5-123">Будьте свободны.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-123">Be free.</span></span>
-   <span data-ttu-id="7b1a5-124">Имеют то же удостоверение безопасности, что и маркер привязки, для которого выполняется вызов.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-124">Have the same security identity as the binding handle on which the call is made.</span></span> <span data-ttu-id="7b1a5-125">Если используется динамическое отслеживание идентификаторов, удостоверение маркера привязки обновляется из токена потока в начале вызова.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-125">If dynamic identity tracking is used, the identity of the binding handle is refreshed from the thread token at the beginning of the call.</span></span> <span data-ttu-id="7b1a5-126">Если используется статическое отслеживание идентификаторов, используется удостоверение клиента, помеченное для маркера привязки.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-126">If static identity tracking is used, the client identity stamped on the binding handle is used.</span></span>

<span data-ttu-id="7b1a5-127">После получения ответа соединение помечается как свободное и может использоваться для других вызовов RPC.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-127">When the call is complete, once the response is received, the connection is marked as free and can be used for other RPC calls.</span></span>

<span data-ttu-id="7b1a5-128">Невозможно изменить удостоверение безопасности для соединения.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-128">The security identity on a connection cannot change.</span></span> <span data-ttu-id="7b1a5-129">Например, если большое количество вызовов одного и того же сервера выполняется с разными идентификаторами безопасности, количество соединений в пуле потоков растет.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-129">For example, if a large number of calls to the same server are made under different security identities, the number of connections in the thread pool grows.</span></span> <span data-ttu-id="7b1a5-130">Сама Ассоциация подсчитывается по ссылкам, и когда все ссылки исчезают, она останавливает и закрывает все соединения.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-130">The association itself is reference-counted, and when all references are gone, it stops and closes all connections.</span></span> <span data-ttu-id="7b1a5-131">Каждый обработчик привязки и каждый обработчик контекста содержат ссылку на ассоциацию.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-131">Every binding handle and every context handle hold a reference on the association.</span></span> <span data-ttu-id="7b1a5-132">Когда все закрываются, связь исчезает.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-132">When all are closed, the association disappears.</span></span> <span data-ttu-id="7b1a5-133">В Windows XP связи не обязательно исчезают немедленно. они могут остаться в течение короткого периода (целевой период составляет 20 секунд, но во время выполнения RPC может возникнуть задержка уничтожения связи, если нет доступных потоков для выполнения задачи).</span><span class="sxs-lookup"><span data-stu-id="7b1a5-133">On Windows XP, associations do not necessarily disappear immediately; they may remain for a short period (the target period is 20 seconds, but the RPC run time may choose to delay destroying the association if no threads are available to execute the task).</span></span> <span data-ttu-id="7b1a5-134">Если вы не хотите, чтобы связь оставалась в активном состоянии после закрытия последнего маркера контекста или маркера привязки, \_ Используйте \_ параметр RPC C opt \_ не \_ , чтобы принудительно закрыть среду выполнения RPC для немедленного закрытия подключения.</span><span class="sxs-lookup"><span data-stu-id="7b1a5-134">If you do not want the association to stay alive after the last context handle/binding handle is closed, use the RPC\_C\_OPT\_DONT\_LINGER option to force the RPC Runtime to immediately close the connection.</span></span>

 

 




