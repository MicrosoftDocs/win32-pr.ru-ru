---
title: Вспомогательные токены для заданий передачи BITS
description: Вспомогательные токены для заданий передачи BITS
ms.assetid: f29f9870-e406-472b-9342-203def7453ae
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 52925a6e0d5a9601e21848d514214bfb843f6246
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "104488260"
---
# <a name="helper-tokens-for-bits-transfer-jobs"></a><span data-ttu-id="d7c72-103">Вспомогательные токены для заданий передачи BITS</span><span class="sxs-lookup"><span data-stu-id="d7c72-103">Helper Tokens for BITS Transfer Jobs</span></span>

<span data-ttu-id="d7c72-104">В Windows Vista служба фоновая интеллектуальная служба передачи (BITS) позволяет приложению связать один маркер безопасности с заданием передачи BITS.</span><span class="sxs-lookup"><span data-stu-id="d7c72-104">In Windows Vista, the Background Intelligent Transfer Service (BITS) service allows an application to associate a single security token to a BITS transfer job.</span></span> <span data-ttu-id="d7c72-105">Затем задание передачи BITS использует этот маркер для проверки подлинности и доступа к локальным и удаленным ресурсам.</span><span class="sxs-lookup"><span data-stu-id="d7c72-105">The BITS transfer job then uses this token for authentication and for access to local and remote resources.</span></span>

<span data-ttu-id="d7c72-106">В Windows 7 служба BITS связывает дополнительный маркер с заданием передачи BITS.</span><span class="sxs-lookup"><span data-stu-id="d7c72-106">In Windows 7, the BITS service associates an additional token to a BITS transfer job.</span></span> <span data-ttu-id="d7c72-107">Задание передачи BITS можно настроить с помощью дополнительного маркера безопасности, который является маркером олицетворения, созданным приложением, вызывающим API-интерфейс BITS.</span><span class="sxs-lookup"><span data-stu-id="d7c72-107">The BITS transfer job can be configured with an additional security token, which is an impersonation token created by an application calling the BITS COM API.</span></span> <span data-ttu-id="d7c72-108">Эта модель вспомогательных токенов позволяет приложениям одновременно использовать два разных маркера безопасности для доступа к локальным файлам, сертификатам на стороне клиента, удаленным файлам и прокси-серверам.</span><span class="sxs-lookup"><span data-stu-id="d7c72-108">This helper token model allows applications to simultaneously use two different security tokens to access local files, client-side certificates, remote files, and proxies.</span></span> <span data-ttu-id="d7c72-109">Например, создается задание передачи BITS, которое записывает Скачанные данные в привилегированный локальный каталог, а затем предоставляет удостоверение домена с низким уровнем прав для HTTP-сервера и прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="d7c72-109">For example, a BITS transfer job is created that writes the downloaded data to a privileged local directory, and then it presents a low-rights domain identity to the HTTP server and proxy server.</span></span>

<span data-ttu-id="d7c72-110">Приложение, как правило, служба Windows, указывает вспомогательный токен с помощью нового интерфейса [**ибитстокеноптионс**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span><span class="sxs-lookup"><span data-stu-id="d7c72-110">An application, typically a Windows service, specifies a helper token by using the new interface [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span> <span data-ttu-id="d7c72-111">Этот интерфейс реализуется с помощью объекта задания BITS.</span><span class="sxs-lookup"><span data-stu-id="d7c72-111">This interface is implemented by the BITS job object.</span></span> <span data-ttu-id="d7c72-112">Приложение вызывает [**использованием метода ibackgroundcopyjob:: QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) для получения указателя интерфейса.</span><span class="sxs-lookup"><span data-stu-id="d7c72-112">The application calls [**IBackgroundCopyJob::QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) to get the interface pointer.</span></span> <span data-ttu-id="d7c72-113">Приложение олицетворяет вспомогательное удостоверение и вызывает [**ибитстокеноптионс:: сеселпертокен**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) для передачи маркера службе BITS.</span><span class="sxs-lookup"><span data-stu-id="d7c72-113">The application impersonates the helper identity and calls [**IBitsTokenOptions::SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) to pass the token to the BITS service.</span></span> <span data-ttu-id="d7c72-114">Затем приложение определяет ресурсы, к которым применяется маркер, передавая набор битовых флагов с помощью [**ибитстокеноптионс:: сеселпертокенфлагс**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags).</span><span class="sxs-lookup"><span data-stu-id="d7c72-114">Then the application specifies the resources to which the token applies by passing a set of bit flags using [**IBitsTokenOptions::SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags).</span></span> <span data-ttu-id="d7c72-115">Приложение очищает все флаги (с помощью **сеселпертокенфлагс** повторно), чтобы отменить это поведение.</span><span class="sxs-lookup"><span data-stu-id="d7c72-115">The application clears all the flags (using **SetHelperTokenFlags** again) to revert the behavior.</span></span> <span data-ttu-id="d7c72-116">Служба BITS сохраняет битовые флаги и маркер в задании передачи BITS.</span><span class="sxs-lookup"><span data-stu-id="d7c72-116">The BITS service stores the bit flags and the token in the BITS transfer job.</span></span>

<span data-ttu-id="d7c72-117">Когда владелец заданий передачи BITS выходит из системы, служба BITS отклоняет все вспомогательные маркеры, связанные с заданием передачи.</span><span class="sxs-lookup"><span data-stu-id="d7c72-117">When the owner of the BITS transfer jobs logs off, the BITS service discards any helper tokens that are associated with the transfer job.</span></span> <span data-ttu-id="d7c72-118">Если перемещение не завершено, служба BITS помещает задание в состояние ошибки с помощью **\_ маркера BG E, \_ \_ необходимого** код ошибки, и удаляет вспомогательный токен.</span><span class="sxs-lookup"><span data-stu-id="d7c72-118">If the transfer is not complete, the BITS service places the job in an error state with the **BG\_E\_TOKEN\_REQUIRED** error code and discards the helper token.</span></span> <span data-ttu-id="d7c72-119">Клиентское приложение может обновить маркер, вызвав [**ибитстокеноптионс:: сеселпертокен**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) , а затем возобновить задание передачи BITS.</span><span class="sxs-lookup"><span data-stu-id="d7c72-119">The client application can refresh the token by calling [**IBitsTokenOptions::SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) and can then resume the BITS transfer job.</span></span> <span data-ttu-id="d7c72-120">Кроме того, клиентское приложение может очистить флаги вспомогательного маркера с помощью [**ибитстокеноптионс:: сеселпертокенфлагс**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) , а затем возобновить задание на перемещение без вспомогательного токена.</span><span class="sxs-lookup"><span data-stu-id="d7c72-120">Alternatively, the client application can clear the helper token flags using [**IBitsTokenOptions::SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) and then resume the transfer job without a helper token.</span></span>

<span data-ttu-id="d7c72-121">Аналогичным образом, когда владелец сеанса служб терминалов выходит из системы, служба BITS должна удалить все вспомогательные токены из этого сеанса и поместить затронутые задания передачи в состояние ошибки с помощью **\_ \_ маркера BG \_ E** .</span><span class="sxs-lookup"><span data-stu-id="d7c72-121">Similarly, when the owner of a terminal services session logs off, the BITS service must discard any helper tokens from that session and place the affected transfer jobs in an error state with the **BG\_E\_TOKEN\_REQUIRED** error code.</span></span>

<span data-ttu-id="d7c72-122">Для модели вспомогательного токена требуется изменение политики управления доступом к службе BITS.</span><span class="sxs-lookup"><span data-stu-id="d7c72-122">The helper token model requires a change to BITS access control policy.</span></span> <span data-ttu-id="d7c72-123">Предыдущие версии BITS реализовали проверки доступа при каждом вызове метода.</span><span class="sxs-lookup"><span data-stu-id="d7c72-123">Previous versions of BITS implemented access checks on every method call.</span></span> <span data-ttu-id="d7c72-124">Начиная с Windows 7 Проверка доступа должна выполняться внутри вызова [**использованием метода ibackgroundcopyjob:: QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) ; в противном случае вспомогательный токен может не иметь доступа к заданию перемещения.</span><span class="sxs-lookup"><span data-stu-id="d7c72-124">Starting with Windows 7, the access check must be performed inside the [**IBackgroundCopyJob::QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) call; otherwise, the helper token might not have access to the transfer job.</span></span>

> [!Note]  
> <span data-ttu-id="d7c72-125">Более ранние реализации фактически требовали, чтобы пользователи службы BITS имели права администратора для установки вспомогательных маркеров.</span><span class="sxs-lookup"><span data-stu-id="d7c72-125">Older implementations effectively required that BITS users have administrator privileges in order to set helper tokens.</span></span> <span data-ttu-id="d7c72-126">Начиная с Windows 10 версии 1607, пользователи, не являющиеся администраторами, могут использовать [**ибитстокеноптионс:: сеселпертокен**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) , чтобы задать вспомогательные токены без прав администратора в заданиях BITS, которыми они владеют.</span><span class="sxs-lookup"><span data-stu-id="d7c72-126">Starting with Windows 10, version 1607, non-administrator BITS users can use [**IBitsTokenOptions::SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) to set non-administrator helper tokens on BITS jobs they own.</span></span> <span data-ttu-id="d7c72-127">Это изменение позволяет пользователям BITS без прав администратора (например, службы фонового загрузчика, работающие под [учетной записью NetworkService](/windows/desktop/Services/networkservice-account)) задавать вспомогательные токены.</span><span class="sxs-lookup"><span data-stu-id="d7c72-127">This change enables non-administrator BITS users (such as background downloader services running under the [NetworkService account](/windows/desktop/Services/networkservice-account)) to set helper tokens.</span></span>
>
> <span data-ttu-id="d7c72-128">В частности, реализация была изменена, чтобы разрешить пользователям без прав администратора настраивать вспомогательные маркеры, если выполняются следующие условия.</span><span class="sxs-lookup"><span data-stu-id="d7c72-128">Specifically, the implementation has been changed to allow users without administrator privileges to set helper tokens, as long as the following conditions are met:</span></span>
>
> -   <span data-ttu-id="d7c72-129">во время вызова [**использованием метода ibackgroundcopyjob:: QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) идентификатор безопасности маркера среад'с вызывающего объекта совпадает с идентификатором безопасности учетной записи владельца задания.</span><span class="sxs-lookup"><span data-stu-id="d7c72-129">during the [**IBackgroundCopyJob::QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) call, the SID of the caller's thread's token is the same as the SID of the job owner's user account, and</span></span>
> -   <span data-ttu-id="d7c72-130">При вызове [**ибитстокеноптионс:: сеселпертокен**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) маркер вспомогательного приложения не имеет идентификатора безопасности администратора (**\_ псевдонимы домена \_ RID \_**).</span><span class="sxs-lookup"><span data-stu-id="d7c72-130">when [**IBitsTokenOptions::SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) is called, the helper token does not have the administrator SID (**DOMAIN\_ALIAS\_RID\_ADMINS**) enabled.</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="d7c72-131">См. также</span><span class="sxs-lookup"><span data-stu-id="d7c72-131">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="d7c72-132">**ибитстокеноптионс**</span><span class="sxs-lookup"><span data-stu-id="d7c72-132">**IBitsTokenOptions**</span></span>](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions)
</dt> </dl>

 

 