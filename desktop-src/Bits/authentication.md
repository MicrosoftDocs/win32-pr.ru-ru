---
title: Проверка подлинности (BITS)
description: Служба BITS поддерживает обычную проверку подлинности, проверку подлинности Passport и несколько схем проверки подлинности запросов и ответов.
ms.assetid: cfd4aec3-79d0-4971-93f8-df797e5c0f75
ms.topic: article
ms.date: 10/09/2018
ms.openlocfilehash: 5d970956676a3348dd4b8c4b420e044bd4714775
ms.sourcegitcommit: 8fa6614b715bddf14648cce36d2df22e5232801a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2020
ms.locfileid: "103988095"
---
# <a name="authentication-bits"></a><span data-ttu-id="ecf5b-103">Проверка подлинности (BITS)</span><span class="sxs-lookup"><span data-stu-id="ecf5b-103">Authentication (BITS)</span></span>

<span data-ttu-id="ecf5b-104">Служба BITS поддерживает обычную проверку подлинности, проверку подлинности Passport и несколько схем проверки подлинности запросов и ответов.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-104">BITS supports Basic authentication, Passport authentication, and several challenge/response authentication schemes.</span></span> <span data-ttu-id="ecf5b-105">Если для сервера или прокси требуется проверка подлинности пользователя, используйте функцию [**IBackgroundCopyJob2:: сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) , чтобы указать учетные данные пользователя.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-105">If the server or proxy requires user authentication, use the [**IBackgroundCopyJob2::SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) function to specify the user's credentials.</span></span> <span data-ttu-id="ecf5b-106">Служба BITS использует интерфейс [CryptoAPI](/windows/desktop/SecCrypto/cryptography-portal) для защиты учетных данных.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-106">BITS uses the [CryptoAPI](/windows/desktop/SecCrypto/cryptography-portal) to protect the credentials.</span></span>

<span data-ttu-id="ecf5b-107">Чтобы задать учетные данные для обычной проверки подлинности, используйте функцию [**сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) , чтобы указать имя пользователя и пароль.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-107">To set credentials for Basic authentication use the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) function to specify the user name and password.</span></span> <span data-ttu-id="ecf5b-108">Следует использовать только обычную проверку подлинности с защищенными веб-сайтами https://. в противном случае имя пользователя и пароль будут видны пользователям.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-108">You should only use Basic authentication with https:// protected secure websites; otherwise the username and password will be visible to users.</span></span> 

<span data-ttu-id="ecf5b-109">Имя пользователя и пароль можно внедрить в URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-109">It's possible to embed the user name and password in the URL.</span></span> <span data-ttu-id="ecf5b-110">Это не считается хорошей практикой в области безопасности и является устаревшим в RFC 3986 (раздел 3.2.1).</span><span class="sxs-lookup"><span data-stu-id="ecf5b-110">This is not considered a good security practice, and is deprecated in RFC 3986 (section 3.2.1).</span></span>

<span data-ttu-id="ecf5b-111">Для проверки подлинности с помощью [Passport](/windows/desktop/WinHttp/passport-authentication-in-winhttp) служба BITS поддерживает только явные учетные данные, а не неявные учетные данные, привязанные</span><span class="sxs-lookup"><span data-stu-id="ecf5b-111">For [Passport](/windows/desktop/WinHttp/passport-authentication-in-winhttp) authentication, BITS supports explicit credentials only, not implicit credentials tied to the account.</span></span>

<span data-ttu-id="ecf5b-112">Для проверки подлинности "запрос-ответ" служба BITS олицетворяет пользователя и использует [снего](../com/snego.md) для определения используемой проверки подлинности запроса/ответа, например NTLM или протокола Kerberos.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-112">For challenge/response authentication, BITS impersonates the user and uses [Snego](../com/snego.md) to determine which challenge/response authentication to use, such as NTLM or the Kerberos protocol.</span></span> <span data-ttu-id="ecf5b-113">Список схем "запрос/ответ", поддерживаемых BITS, см. в статье [**\_ \_ Схема проверки подлинности BG**](/windows/desktop/api/Bits1_5/ne-bits1_5-bg_auth_scheme).</span><span class="sxs-lookup"><span data-stu-id="ecf5b-113">For a list of challenge/response schemes that BITS supports, see [**BG\_AUTH\_SCHEME**](/windows/desktop/api/Bits1_5/ne-bits1_5-bg_auth_scheme).</span></span>

<span data-ttu-id="ecf5b-114">Задания BITS могут завершиться ошибкой, если в виртуальном каталоге на сервере есть анонимная проверка подлинности, а другая схема проверки подлинности включена, а также для защиты виртуального каталога или загрузки файлов.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-114">BITS jobs can fail if the virtual directory on the server has anonymous authentication and another authentication scheme enabled and if ACLs protect the virtual directory or download files.</span></span> <span data-ttu-id="ecf5b-115">Например, задание завершается с ошибкой "доступ запрещен", если в виртуальном каталоге включена анонимная и встроенная проверка подлинности, а файл содержит ACL, позволяющий только Бен чтение файла.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-115">For example, a job fails with "access denied" if the virtual directory has anonymous and integrated authentication enabled and the file contains an ACL that allows only Ben to read the file.</span></span> <span data-ttu-id="ecf5b-116">Это происходит из-за того, что виртуальный каталог допускает анонимный доступ, поэтому IIS не выполняет явную проверку подлинности Бен (учетные данные Бен не используются для доступа к файлу и доступ запрещен).</span><span class="sxs-lookup"><span data-stu-id="ecf5b-116">This occurs because the virtual directory allows anonymous access, so IIS does not explicitly authenticate Ben (Ben's credentials are not used to access the file and access is denied).</span></span>

## <a name="using-implicit-credentials"></a><span data-ttu-id="ecf5b-117">Использование неявных учетных данных</span><span class="sxs-lookup"><span data-stu-id="ecf5b-117">Using implicit credentials</span></span>

<span data-ttu-id="ecf5b-118">Чтобы использовать неявные учетные данные пользователя (вход в систему) для проверки подлинности NTLM или Kerberos, вызовите метод [**IBackgroundCopyJob2:: сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) и задайте для членов **username** и **Password** в структуре [**\_ \_ учетных данных BG Basic**](/windows/desktop/api/Bits1_5/ns-bits1_5-bg_basic_credentials) **значение NULL**.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-118">To use the user's implicit (logon) credentials for NTLM or Kerberos authentication, call the [**IBackgroundCopyJob2::SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method and set the **UserName** and **Password** members of the [**BG\_BASIC\_CREDENTIALS**](/windows/desktop/api/Bits1_5/ns-bits1_5-bg_basic_credentials) structure to **NULL**.</span></span> <span data-ttu-id="ecf5b-119">При указании неявных учетных данных для прокси-сервера BITS также будет использовать неявные учетные данные для проверки подлинности сервера, если не указать явные учетные данные сервера</span><span class="sxs-lookup"><span data-stu-id="ecf5b-119">If you specify implicit credentials for a proxy, BITS will also use the implicit credentials for server authentication unless you specify explicit server credentials.</span></span>

<span data-ttu-id="ecf5b-120">Дополнительные сведения о службах см. в статье [учетные записи служб и службы BITS](service-accounts-and-bits.md).</span><span class="sxs-lookup"><span data-stu-id="ecf5b-120">For additional information for services, see [Service Accounts and BITS](service-accounts-and-bits.md).</span></span>

<span data-ttu-id="ecf5b-121">Можно также изменить значение реестра **LmCompatibilityLevel** или **уселмкомпат** . Однако эти значения следует изменять только в том случае, если имеется приложение, которое нельзя изменить для вызова метода [**сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="ecf5b-121">You could also change the **LMCompatibilityLevel** or **UseLMCompat** registry value; however, you should change these values only if you have an existing application that cannot be changed to call the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span>

<span data-ttu-id="ecf5b-122">Службы BITS будут использовать неявные учетные данные для проверки подлинности, если значение реестра **LmCompatibilityLevel** равно двум или больше, и метод [**сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) не вызывался.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-122">BITS will use implicit credentials for authentication if the **LMCompatibilityLevel** registry value is two or greater, and you have not called the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span> <span data-ttu-id="ecf5b-123">Полный путь к параметру реестра **LmCompatibilityLevel** — **hKey \_ Local \_ Machine** \\ **System** \\ **CurrentControlSet** \\ **Control** \\ **LSA** \\ **LmCompatibilityLevel**.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-123">The full path to the **LMCompatibilityLevel** registry value is **HKEY\_LOCAL\_MACHINE**\\**System**\\**CurrentControlSet**\\**Control**\\**LSA**\\**LmCompatibilityLevel**.</span></span>

<span data-ttu-id="ecf5b-124">Обратите внимание, что изменение значения реестра **LmCompatibilityLevel** может повлиять на другие приложения и службы, выполняющиеся на компьютере.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-124">Note that changing the **LMCompatibilityLevel** registry value can affect other applications and services running on the computer.</span></span> <span data-ttu-id="ecf5b-125">Дополнительные сведения об использовании значения реестра **LmCompatibilityLevel** см. в разделе [KB147706](https://support.microsoft.com/kb/147706).</span><span class="sxs-lookup"><span data-stu-id="ecf5b-125">For more information about using the **LMCompatibilityLevel** registry value, see [KB147706](https://support.microsoft.com/kb/147706).</span></span>

<span data-ttu-id="ecf5b-126">Если при установке значения реестра **LmCompatibilityLevel** возникла ошибка, можно создать значение реестра **уселмкомпат** в разделе **hKey \_ Local \_ Machine** \\ **Software** \\ **Microsoft** \\ **Windows** \\ **CurrentVersion** \\ **BITS**.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-126">If setting the **LMCompatibilityLevel** registry value is an issue, you can create the **UseLMCompat** registry value under **HKEY\_LOCAL\_MACHINE**\\**Software**\\**Microsoft**\\**Windows**\\**CurrentVersion**\\**BITS**.</span></span> <span data-ttu-id="ecf5b-127">Значение реестра — DWORD.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-127">The registry value is a DWORD.</span></span> <span data-ttu-id="ecf5b-128">В следующей таблице перечислены возможные значения для **уселмкомпат**:</span><span class="sxs-lookup"><span data-stu-id="ecf5b-128">The following table lists the possible values for **UseLMCompat**:</span></span>

|<span data-ttu-id="ecf5b-129">Значение</span><span class="sxs-lookup"><span data-stu-id="ecf5b-129">Value</span></span>|<span data-ttu-id="ecf5b-130">Описание</span><span class="sxs-lookup"><span data-stu-id="ecf5b-130">Description</span></span>|
|-|-|
| <span data-ttu-id="ecf5b-131">0</span><span class="sxs-lookup"><span data-stu-id="ecf5b-131">0</span></span>     | <span data-ttu-id="ecf5b-132">Служба BITS будет отсылать неявные учетные данные каждый раз, когда сервер запрашивает учетные данные NTLM или Kerberos.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-132">BITS will send implicit credentials whenever the server prompts for NTLM or Kerberos credentials.</span></span>                                                                                           |
| <span data-ttu-id="ecf5b-133">1</span><span class="sxs-lookup"><span data-stu-id="ecf5b-133">1</span></span>     | <span data-ttu-id="ecf5b-134">Служба BITS будет отсылать неявные учетные данные только в том случае, если значение реестра **LmCompatibilityLevel** клиентского компьютера больше или равно 2.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-134">BITS will send implicit credentials only if the client computer's **LMCompatibilityLevel** registry value is greater than or equal to 2.</span></span><br/>     |
| <span data-ttu-id="ecf5b-135">2</span><span class="sxs-lookup"><span data-stu-id="ecf5b-135">2</span></span>     | <span data-ttu-id="ecf5b-136">Служба BITS будет отсылать неявные учетные данные только в том случае, если приложение вызвало метод [**сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="ecf5b-136">BITS will send implicit credentials only if the application called the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span><br/> |

<span data-ttu-id="ecf5b-137">Если значение реестра не существует, BITS будет использовать значение по умолчанию 2 для параметра реестра **уселмкомпат** .</span><span class="sxs-lookup"><span data-stu-id="ecf5b-137">BITS will use a default value of "2" for the **UseLMCompat** registry value if the registry value does not exist.</span></span>

## <a name="using-certificates-for-clientserver-authentication"></a><span data-ttu-id="ecf5b-138">Использование сертификатов для проверки подлинности клиента и сервера</span><span class="sxs-lookup"><span data-stu-id="ecf5b-138">Using certificates for client/server authentication</span></span>

<span data-ttu-id="ecf5b-139">При обеспечении безопасности обмена данными между клиентом и сервером клиенты и серверы могут использовать цифровые сертификаты для взаимной проверки подлинности друг друга.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-139">In secure client/server communication, clients and servers can use digital certificates to mutually authenticate each other.</span></span> <span data-ttu-id="ecf5b-140">BITS автоматически поддерживает проверку подлинности сервера на основе сертификатов для защищенных транспортов HTTP.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-140">BITS automatically supports certificate-based server authentication for secure HTTP transports.</span></span> <span data-ttu-id="ecf5b-141">Чтобы предоставить службе BITS сертификат клиента, необходимый для взаимной проверки подлинности, вызовите метод [**ибаккграундкопижобхттпоптионс:: сетклиентцертификатебид**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) или [**Ибаккграундкопижобхттпоптионс:: SetClientCertificateByName**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname) .</span><span class="sxs-lookup"><span data-stu-id="ecf5b-141">To provide BITS the client certificate needed for mutual authentication, call either the [**IBackgroundCopyJobHttpOptions::SetClientCertificateByID**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) or [**IBackgroundCopyJobHttpOptions::SetClientCertificateByName**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname) method.</span></span>

<span data-ttu-id="ecf5b-142">Если веб-сайт принимает, но не требует сертификата клиента SSL, а в задании BITS не указан сертификат клиента, задание завершится ошибкой, и **\_ \_ \_ \_ \_ требуется сертификат проверки подлинности клиента WinHTTP** (0x80072f0c).</span><span class="sxs-lookup"><span data-stu-id="ecf5b-142">When a website accepts but does not require an SSL client certificate, and the BITS job does not specify a client certificate, the job will fail with **ERROR\_WINHTTP\_CLIENT\_AUTH\_CERT\_NEEDED** (0x80072f0c).</span></span>

## <a name="how-to-handle-authenticated-proxy-scenarios-that-require-user-specific-settings"></a><span data-ttu-id="ecf5b-143">Как работать с проверенными прокси-сценариями, требующими пользовательские параметры</span><span class="sxs-lookup"><span data-stu-id="ecf5b-143">How to handle authenticated proxy scenarios that require user-specific settings</span></span>

<span data-ttu-id="ecf5b-144">При использовании BITS в среде, требующей проверки подлинности прокси-сервера при запуске в качестве учетной записи без использования учетных данных NTLM или Kerberos в сетевом домене компьютера, необходимо выполнить дополнительные действия для правильной проверки подлинности с помощью учетных данных другой учетной записи, которая имеет учетные данные в домене.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-144">If you are using BITS in an environment that requires proxy authentication while running as an account without usable NTLM or Kerberos credentials in the machine's network domain, you must take extra steps to authenticate properly by using the credentials of another user account that does have credentials on the domain.</span></span> <span data-ttu-id="ecf5b-145">Это типичный сценарий, когда код BITS выполняется как системная служба, например LocalService, NetworkService или LocalSystem, так как эти учетные записи не имеют пригодных для использования учетных данных NTLM или Kerberos.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-145">This is a typical scenario when your BITS code is running as a system service such as LocalService, NetworkService, or LocalSystem, as those accounts do not have usable NTLM or Kerberos credentials.</span></span>

<span data-ttu-id="ecf5b-146">Логика обнаружения прокси-сервера, используемая в службе BITS, выполняет следующие действия при установке маркера модуля поддержки сети ( \_ сети токенов BG \_ ):</span><span class="sxs-lookup"><span data-stu-id="ecf5b-146">The proxy detection logic used in BITS does the following when a network helper token (BG\_TOKEN\_NETWORK) is set:</span></span>

-   <span data-ttu-id="ecf5b-147">Если [**использованием метода ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) был вызван с помощью параметра **\_ \_ \_ \_ конфигурации использования прокси-сервера задания BG**, то для считывания параметров локального прокси-сервера IE используется олицетворение контекста владельца задания через [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span><span class="sxs-lookup"><span data-stu-id="ecf5b-147">If [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) was called with **BG\_JOB\_PROXY\_USAGE\_PRECONFIG**, then read local IE proxy settings using job owner token context impersonation via [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span> <span data-ttu-id="ecf5b-148">Начиная с Windows 10, версия 1809 (10,0; Сборка 17763), для этого шага используется удостоверение вспомогательного токена.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-148">Starting in Windows 10, version 1809 (10.0; Build 17763), the helper token identity is used for this step.</span></span>
-   <span data-ttu-id="ecf5b-149">Если [**использованием метода ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) был вызван с **\_ \_ \_ автоопределением использования прокси-сервера BG** или в параметрах IE из предварительной **\_ \_ \_ \_ конфигурации использования прокси-сервера задания BG** укажите URL-адрес автоматического обнаружения или автонастройки, выполните автоматическое обнаружение прокси-сервера или протокол автообнаружения веб-прокси с помощью [**WinHttpGetProxyForUrl**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetproxyforurl).</span><span class="sxs-lookup"><span data-stu-id="ecf5b-149">If [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) was called with **BG\_PROXY\_USAGE\_AUTODETECT** or if the IE settings from the **BG\_JOB\_PROXY\_USAGE\_PRECONFIG** case specify auto-detect or an auto-config URL, then conduct auto-proxy detection, or Web Proxy Autodiscovery Protocol (WPAD), using helper token impersonation via [**WinHttpGetProxyForUrl**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetproxyforurl).</span></span>

<span data-ttu-id="ecf5b-150">После этого для проверки подлинности прокси или сервера в течение всего времени используется олицетворение токена.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-150">After that, helper token impersonation is used for proxy or server authentication throughout.</span></span>

<span data-ttu-id="ecf5b-151">Начиная с Windows 10, версия 1809 (10,0; Сборка 17763), прошедший проверку подлинности сценарий прокси-сервера с учетными данными пользователя упрощен.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-151">Starting in Windows 10, version 1809 (10.0; Build 17763), the authenticated proxy scenario with user-specific credentials is simplified.</span></span>

1.  <span data-ttu-id="ecf5b-152">Вызовите метод [**сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) задания BITS с помощью **\_ схемы проверки подлинности BG \_ \_ Negotiate**, параметр *username* имеет значение **null**, *пароль* имеет **значение null,** а для параметра *Target* задано значение " **\_ \_ целевой \_ прокси-сервер BG auth**".</span><span class="sxs-lookup"><span data-stu-id="ecf5b-152">Call the BITS job's [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method with **BG\_AUTH\_SCHEME\_NEGOTIATE**, *UserName* set to **NULL**, *Password* set to **NULL**, and *Target* set to **BG\_AUTH\_TARGET\_PROXY**.</span></span> <span data-ttu-id="ecf5b-153">Это приводит к тому, что неявные учетные данные учетной записи пользователя будут использоваться для проверки подлинности NTLM и Kerberos с прокси и сервером.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-153">This causes the user account's implicit credentials to be used for NTLM and Kerberos authentication with the proxy and server.</span></span>
2.  <span data-ttu-id="ecf5b-154">Вызовите [**использованием метода ibackgroundcopyjob:: SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) с параметром **\_ \_ \_ \_ конфигурации использования прокси-сервера задания BG**.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-154">Call [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with **BG\_JOB\_PROXY\_USAGE\_PRECONFIG**.</span></span>
3.  <span data-ttu-id="ecf5b-155">QueryInterface для [**ибитстокеноптионс**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span><span class="sxs-lookup"><span data-stu-id="ecf5b-155">QueryInterface for [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span>
4.  <span data-ttu-id="ecf5b-156">Олицетворение учетной записи пользователя, используемой для учетных данных NTLM/Kerberos.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-156">Impersonate the user account you're using for NTLM/Kerberos credentials.</span></span>
5.  <span data-ttu-id="ecf5b-157">Вызовите [**сеселпертокен**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span><span class="sxs-lookup"><span data-stu-id="ecf5b-157">Call [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span></span>
6. <span data-ttu-id="ecf5b-158">Вызовите [**сеселпертокенфлагс**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) с помощью **\_ токена BG \_ Network**.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-158">Call [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) with **BG\_TOKEN\_NETWORK**.</span></span>
7. <span data-ttu-id="ecf5b-159">Отменить олицетворение.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-159">Revert impersonation.</span></span>
8. <span data-ttu-id="ecf5b-160">Продолжить настройку задания.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-160">Continue job setup.</span></span>
9. <span data-ttu-id="ecf5b-161">Вызовите [**возобновление**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) задания.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-161">Call [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) on the job.</span></span>

<span data-ttu-id="ecf5b-162">До Windows 10 версии 1809 (10,0; Сборка 17763). Правильная идентификация пользователя (удостоверение вспомогательного маркера) используется для обнаружения прокси-сервера на основе сети (WPAD) и проверки подлинности прокси, но фактическое обнаружение локальных параметров прокси-сервера (IE) всегда выполняется с помощью маркера владельца задания, даже если настроен вспомогательный токен.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-162">Before Windows 10, version 1809 (10.0; Build 17763), the correct user identity (the helper token's identity) is used for network-based proxy detection (WPAD) and for proxy authentication, but the actual detection of local (IE) proxy settings is always done using the job owner's token, even when a helper token is configured.</span></span> <span data-ttu-id="ecf5b-163">Чтобы обойти этот недостаток, можно выполнить следующие действия.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-163">To work around this shortcoming, you can follow these steps.</span></span>

1.  <span data-ttu-id="ecf5b-164">Олицетворение учетной записи пользователя, используемой для учетных данных NTLM/Kerberos.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-164">Impersonate the user account you're using for NTLM/Kerberos credentials.</span></span>
2.  <span data-ttu-id="ecf5b-165">Получите параметры прокси-сервера IE учетной записи пользователя, вызвав [**винхттпжетиепроксиконфигфоркуррентусер**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span><span class="sxs-lookup"><span data-stu-id="ecf5b-165">Retrieve the user account's IE proxy settings by calling [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span>
3.  <span data-ttu-id="ecf5b-166">Отменить олицетворение.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-166">Revert impersonation.</span></span>
4.  <span data-ttu-id="ecf5b-167">Вызовите метод [**сеткредентиалс**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) задания BITS с помощью **\_ схемы проверки подлинности BG \_ \_ Negotiate**, параметр *username* имеет значение **null**, *пароль* имеет **значение null,** а для параметра *Target* задано значение " **\_ \_ целевой \_ прокси-сервер BG auth**".</span><span class="sxs-lookup"><span data-stu-id="ecf5b-167">Call the BITS job's [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method with **BG\_AUTH\_SCHEME\_NEGOTIATE**, *UserName* set to **NULL**, *Password* set to **NULL**, and *Target* set to **BG\_AUTH\_TARGET\_PROXY**.</span></span> <span data-ttu-id="ecf5b-168">Это приводит к тому, что неявные учетные данные учетной записи пользователя будут использоваться для проверки подлинности NTLM и Kerberos с прокси и сервером.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-168">This causes the user account's implicit credentials to be used for NTLM and Kerberos authentication with the proxy and server.</span></span>
5.  <span data-ttu-id="ecf5b-169">Если на шаге 2 были получены пользовательские параметры прокси-сервера (т. е. *лпсзпрокси* или *Лпсзпроксибипасс* не **равны NULL**), задайте соответствующие параметры задания вручную, используя [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) с параметром **\_ \_ \_ \_ переопределения использования прокси-сервера задания BG** .</span><span class="sxs-lookup"><span data-stu-id="ecf5b-169">If step 2 yielded any user-specific proxy settings (i.e. *lpszProxy* or *lpszProxyBypass* are not **NULL**), set the corresponding job settings manually, using [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with the **BG\_JOB\_PROXY\_USAGE\_OVERRIDE** setting.</span></span>
6.  <span data-ttu-id="ecf5b-170">Если на шаге 2 не были получены какие-либо пользовательские параметры прокси-сервера, вызовите [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) с помощью предварительной **\_ \_ \_ настройки использования задания BG**.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-170">If step 2 did not yield any user-specific proxy settings, call [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with **BG\_JOB\_USAGE\_PRECONFIG**.</span></span>
7.  <span data-ttu-id="ecf5b-171">QueryInterface для [**ибитстокеноптионс**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span><span class="sxs-lookup"><span data-stu-id="ecf5b-171">QueryInterface for [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span>
8.  <span data-ttu-id="ecf5b-172">Снова олицетворять учетную запись пользователя.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-172">Impersonate the user account again.</span></span>
9.  <span data-ttu-id="ecf5b-173">Вызовите [**сеселпертокен**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span><span class="sxs-lookup"><span data-stu-id="ecf5b-173">Call [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span></span>
10. <span data-ttu-id="ecf5b-174">Вызовите [**сеселпертокенфлагс**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) с помощью **\_ токена BG \_ Network**.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-174">Call [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) with **BG\_TOKEN\_NETWORK**.</span></span>
11. <span data-ttu-id="ecf5b-175">Отменить олицетворение.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-175">Revert impersonation.</span></span>
12. <span data-ttu-id="ecf5b-176">Продолжить настройку задания.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-176">Continue job setup.</span></span>
13. <span data-ttu-id="ecf5b-177">Вызовите [**возобновление**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) задания.</span><span class="sxs-lookup"><span data-stu-id="ecf5b-177">Call [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) on the job.</span></span>
