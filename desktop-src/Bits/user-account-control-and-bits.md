---
title: Контроль учетных записей и служба BITS
description: Когда пользователь с правами администратора входит в систему на компьютере, создаются два маркера доступа. Один из них — отфильтрованный маркер доступа обычного пользователя, а другой — полный маркер доступа администратора.
ms.assetid: 02439ab3-b885-4a2f-b507-0c48d2b30b76
ms.topic: article
ms.date: 7/12/2019
ms.openlocfilehash: 3017b3a0d816ba393d1427c5c1d2315a68b2dcc0
ms.sourcegitcommit: be77ed1f97d3be57a2f42070589de21b66034adf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/29/2020
ms.locfileid: "103987277"
---
# <a name="bits-security-tokens-and-administrator-accounts"></a><span data-ttu-id="3e3d6-104">Безопасность, токены и учетные записи администраторов BITS</span><span class="sxs-lookup"><span data-stu-id="3e3d6-104">BITS Security, Tokens, and Administrator Accounts</span></span>

## <a name="http-server-certificate-callbacks"></a><span data-ttu-id="3e3d6-105">Обратные вызовы сертификатов HTTP-сервера</span><span class="sxs-lookup"><span data-stu-id="3e3d6-105">HTTP Server certificate callbacks</span></span>
<span data-ttu-id="3e3d6-106">Правильная проверка сертификатов сервера является ключевой частью поддержания безопасности HTTPS.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-106">Correctly validating server certificates is a key part of maintaining HTTPS security.</span></span> <span data-ttu-id="3e3d6-107">Служба BITS позволяет всегда проверять сертификаты сервера по списку требований, заданных параметром [**сетсекуритифлагс**](/windows/desktop/api/bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setsecurityflags).</span><span class="sxs-lookup"><span data-stu-id="3e3d6-107">BITS helps by always validating server certificates against a list of requirements specified by [**SetSecurityFlags**](/windows/desktop/api/bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setsecurityflags).</span></span> <span data-ttu-id="3e3d6-108">По умолчанию BITS использует проверку сертификата в стиле браузера.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-108">By default, BITS uses "browser" style certificate validation.</span></span>

<span data-ttu-id="3e3d6-109">Можно также указать пользовательскую функцию для вызова для дальнейшей проверки сертификата.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-109">You can also specify a custom function to call in order to further validate the certificate.</span></span> <span data-ttu-id="3e3d6-110">Задайте обратный вызов сертификата сервера с помощью метода [**сетсерверцертификатевалидатионинтерфаце**](/windows/desktop/api/Bits10_3/nf-bits10_3-ibackgroundcopyjobhttpoptions3-setservercertificatevalidationinterface) .</span><span class="sxs-lookup"><span data-stu-id="3e3d6-110">Set the server certificate callback with the [**SetServerCertificateValidationInterface**](/windows/desktop/api/Bits10_3/nf-bits10_3-ibackgroundcopyjobhttpoptions3-setservercertificatevalidationinterface) method.</span></span> <span data-ttu-id="3e3d6-111">Метод будет вызван только после того, как операционная система проверила сертификат на основе вызова [ **сетсекуритифлаг**](/windows/desktop/api/bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setsecurityflags) .</span><span class="sxs-lookup"><span data-stu-id="3e3d6-111">Your method will only be called after the operating system has validated the certificate based on the [**SetSecurityFlag** s](/windows/desktop/api/bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setsecurityflags) call.</span></span> 

## <a name="http-client-certificates"></a><span data-ttu-id="3e3d6-112">Сертификаты клиента HTTP</span><span class="sxs-lookup"><span data-stu-id="3e3d6-112">HTTP Client certificates</span></span>
<span data-ttu-id="3e3d6-113">Можно задать сертификат клиента для задания HTTP с двумя разными методами параметров сертификата.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-113">You can set a client certificate on an HTTP job with two different certificate settings methods.</span></span> <span data-ttu-id="3e3d6-114">Сертификат можно задать по [идентификатору](/windows/desktop/api/bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) или по [имени субъекта](/windows/desktop/api/bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname)сертификата.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-114">You can set a certificate either by [ID](/windows/desktop/api/bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) or by the certificate [subject name](/windows/desktop/api/bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname).</span></span> <span data-ttu-id="3e3d6-115">Сертификат клиента будет использоваться во время согласования TLS (или повторного согласования), если сервер требует проверки подлинности клиента.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-115">The client certificate will be used during TLS negotiation (or renegotiation) if the server requires client authentication.</span></span>

## <a name="write-only-http-headers"></a><span data-ttu-id="3e3d6-116">Заголовки HTTP только для записи</span><span class="sxs-lookup"><span data-stu-id="3e3d6-116">Write-only HTTP headers</span></span>
<span data-ttu-id="3e3d6-117">Служба BITS помогает защитить маркеры проверки подлинности HTTP от нежелательного доступа.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-117">BITS helps you protect HTTP authentication tokens from unwanted access.</span></span> <span data-ttu-id="3e3d6-118">Часто HTTP-серверу требуется определенный маркер безопасности или строка при скачивании или отправке файла на HTTP-серверы.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-118">Often an HTTP server will need some kind of security token or string when downloading or uploading a file to HTTP servers.</span></span>

<span data-ttu-id="3e3d6-119">Служба BITS защищает эти маркеры проверки подлинности несколькими способами.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-119">BITS protects these authentication tokens in several ways.</span></span>
* <span data-ttu-id="3e3d6-120">Служба BITS позволяет использовать HTTP-подключения, защищенные с помощью TLS и SSL, путем указания URL-адреса HTTPS.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-120">BITS lets you use TLS- and SSL-protected HTTP connections by specifying an HTTPS URL.</span></span>
* <span data-ttu-id="3e3d6-121">Пользовательские заголовки всегда сохраняются в зашифрованном виде на диске.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-121">Custom headers are always persisted in an encrypted format on disk.</span></span>
* <span data-ttu-id="3e3d6-122">Вы можете запретить возврат заголовков клиентов другим программам с помощью метода [**IBackgroundCopyJobHttpOptions3:: макекустомхеадерсвритеонли**](/windows/win32/api/Bits10_3/nf-bits10_3-ibackgroundcopyjobhttpoptions3-makecustomheaderswriteonly) .</span><span class="sxs-lookup"><span data-stu-id="3e3d6-122">You can prevent customer headers from being returned to other programs with the [**IBackgroundCopyJobHttpOptions3::MakeCustomHeadersWriteOnly**](/windows/win32/api/Bits10_3/nf-bits10_3-ibackgroundcopyjobhttpoptions3-makecustomheaderswriteonly) method.</span></span>


## <a name="standard-and-administrator-users"></a><span data-ttu-id="3e3d6-123">Пользователи Standard и Administrator</span><span class="sxs-lookup"><span data-stu-id="3e3d6-123">Standard and Administrator users</span></span>
<span data-ttu-id="3e3d6-124">Пользователь, который входит в группу администраторов, может запустить процесс со стандартным доступом пользователей или в состоянии с повышенными правами (с правами администратора).</span><span class="sxs-lookup"><span data-stu-id="3e3d6-124">A user who is in the administrator group can run a process with standard user access or in an elevated state (with administrator privileges).</span></span> <span data-ttu-id="3e3d6-125">Служба BITS будет запускать задание в любом состоянии при условии, что пользователь вошел в систему на компьютере.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-125">BITS will run the job in either state as long as the user is logged onto the computer.</span></span> <span data-ttu-id="3e3d6-126">Однако если пользователь создал задание или не владеет заданием в привилегированном состоянии, он должен находиться в состоянии повышенной привилегии, чтобы получить или изменить задание (в противном случае вызов завершается с отказом в доступе (0x80070005)).</span><span class="sxs-lookup"><span data-stu-id="3e3d6-126">However, if the user created the job or took ownership of the job in an elevated state, the user must be in the elevated state to retrieve or modify the job (otherwise, the call fails with Access Denied (0x80070005)).</span></span> <span data-ttu-id="3e3d6-127">Чтобы определить состояние задания с повышенными привилегиями, вызовите метод [**IBackgroundCopyJob4:: жетовнерелеватионстате**](/windows/desktop/api/Bits3_0/nf-bits3_0-ibackgroundcopyjob4-getownerelevationstate) .</span><span class="sxs-lookup"><span data-stu-id="3e3d6-127">To determine the elevated state of a job, call the [**IBackgroundCopyJob4::GetOwnerElevationState**](/windows/desktop/api/Bits3_0/nf-bits3_0-ibackgroundcopyjob4-getownerelevationstate) method.</span></span>

<span data-ttu-id="3e3d6-128">Стандартный пользователь не может перечислить или изменить задания, принадлежащие другим пользователям.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-128">A standard user cannot enumerate or modify jobs owned by other users.</span></span>

## <a name="integrity-level"></a><span data-ttu-id="3e3d6-129">Уровень целостности</span><span class="sxs-lookup"><span data-stu-id="3e3d6-129">Integrity level</span></span>
<span data-ttu-id="3e3d6-130">Помимо состояния с повышенными правами, уровень целостности токена может определять, может ли пользователь изменять задание.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-130">In addition to the elevated state, the integrity level of the token can determine if the user can modify a job.</span></span> <span data-ttu-id="3e3d6-131">Клиент не может изменять задания, созданные маркером, с более высоким уровнем целостности.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-131">A client cannot modify jobs created by a token with a higher integrity level.</span></span> <span data-ttu-id="3e3d6-132">В частности, многие маркеры локальной системы имеют уровень целостности выше уровня целостности окна с повышенными привилегиями и поэтому не могут быть изменены администратором из обычного окна командной строки с повышенными привилегиями.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-132">In particular, many local-system tokens carry an integrity level higher than the integrity level of an elevated window, and so they cannot be modified by an administrator from an ordinary elevated command window.</span></span> <span data-ttu-id="3e3d6-133">Например, Центр обновления Windows и задания SMS выполняются от имени LocalSystem с более высоким уровнем целостности, чем маркер с повышенными правами, поэтому администратор не может изменять или удалять эти задания.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-133">For example, Windows Update and SMS jobs run as LocalSystem which has a higher integrity level than an elevated token so an administrator cannot modify or delete these jobs.</span></span> <span data-ttu-id="3e3d6-134">Чтобы изменить это задание, создайте задачу планировщик задач, которая выполняется как локальная система.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-134">To modify these job, create a Task Scheduler task that runs as local system.</span></span> <span data-ttu-id="3e3d6-135">Задача может выполнять консольное приложение, использующее API BITS, или задача может выполнить сценарий, вызывающий BitsAdmin.exe.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-135">The task can execute a console application that uses the BITS API, or the task could execute a script that calls BitsAdmin.exe.</span></span> <span data-ttu-id="3e3d6-136">Чтобы определить используемый уровень целостности, вызовите метод [**IBackgroundCopyJob4:: жетовнеринтегритилевел**](/windows/desktop/api/Bits3_0/nf-bits3_0-ibackgroundcopyjob4-getownerintegritylevel) .</span><span class="sxs-lookup"><span data-stu-id="3e3d6-136">To determine the integrity level used, call the [**IBackgroundCopyJob4::GetOwnerIntegrityLevel**](/windows/desktop/api/Bits3_0/nf-bits3_0-ibackgroundcopyjob4-getownerintegritylevel) method.</span></span>

## <a name="service-identity"></a><span data-ttu-id="3e3d6-137">Удостоверение службы</span><span class="sxs-lookup"><span data-stu-id="3e3d6-137">Service identity</span></span>
<span data-ttu-id="3e3d6-138">Начиная с Windows 10 Май 2019 обновления (10,0; Сборка 18362). задания BITS, запущенные из службы, будут поддерживать удостоверение службы.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-138">Starting in the Windows 10 May 2019 Update (10.0; Build 18362), BITS jobs started from a service will maintain the service identity.</span></span> <span data-ttu-id="3e3d6-139">Это позволяет службам, которые хотят использовать BITS, скачивать файлы или передавать их из каталога, разрешения которого привязаны к идентификатору безопасности службы.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-139">This allows for services that wish to use BITS to download files to or upload files from a directory whose permissions are tied to the service SID.</span></span> <span data-ttu-id="3e3d6-140">Кроме того, сетевой трафик будет правильно относиться к службе, которая запросила задание BITS вместо атрибута BITS.</span><span class="sxs-lookup"><span data-stu-id="3e3d6-140">Additionally, network traffic will be correctly attributed to the service that requested the BITS job instead of being attributed to BITS.</span></span>

 




