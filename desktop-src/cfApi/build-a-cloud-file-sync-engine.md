---
description: Узнайте, как создать модуль синхронизации облачных файлов, использующий файлы заполнителей с помощью API облачных файлов.
title: Создание облачного модуля синхронизации, поддерживающего файлы заполнителей
ms.topic: article
ms.date: 11/12/2020
ms.openlocfilehash: 4f1330285d0c8ef0359639f2be84162f8bc2ef3b
ms.sourcegitcommit: 3bdf30edb314e0fcd17dc4ddbc70e4ec7d3596e6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/10/2021
ms.locfileid: "104557629"
---
# <a name="build-a-cloud-sync-engine-that-supports-placeholder-files"></a><span data-ttu-id="df527-103">Создание облачного модуля синхронизации, поддерживающего файлы заполнителей</span><span class="sxs-lookup"><span data-stu-id="df527-103">Build a Cloud Sync Engine that Supports Placeholder Files</span></span>

<span data-ttu-id="df527-104">Модуль синхронизации — это служба, которая синхронизирует файлы, обычно между удаленным узлом и локальным клиентом.</span><span class="sxs-lookup"><span data-stu-id="df527-104">A sync engine is a service that syncs files, typically between a remote host and a local client.</span></span> <span data-ttu-id="df527-105">Модули синхронизации в Windows часто представляют эти файлы пользователю с помощью файловой системы Windows и проводника.</span><span class="sxs-lookup"><span data-stu-id="df527-105">Sync engines on Windows often present those files to the user through the Windows file system and File Explorer.</span></span> <span data-ttu-id="df527-106">До Windows 10, версия 1709, поддержка модуля синхронизации в Windows была ограничена нерегламентированными поверхностями, такими как панель навигации проводника, область задач Windows и (для дополнительных технических приложений) драйверы фильтра файловой системы.</span><span class="sxs-lookup"><span data-stu-id="df527-106">Before Windows 10, version 1709, sync engine support in Windows was limited to scenario-agnostic ad-hoc surfaces, such as File Explorer’s navigation pane, the Windows system tray, and (for more technical applications) file system filter drivers.</span></span>

<span data-ttu-id="df527-107">В Windows 10 версии 1709 (также именуемой обновлением для авторов обновлений) появился *API облачных файлов*.</span><span class="sxs-lookup"><span data-stu-id="df527-107">Windows 10 version 1709 (also called the Fall Creators Update) introduced the *cloud files API*.</span></span> <span data-ttu-id="df527-108">Этот API — это новая платформа, которая является формализацией поддержки модулей синхронизации.</span><span class="sxs-lookup"><span data-stu-id="df527-108">This API is a new platform that formalizes support for sync engines.</span></span> <span data-ttu-id="df527-109">API облачных файлов обеспечивает поддержку модулей синхронизации таким образом, что предоставляет разработчикам и конечным пользователям множество новых преимуществ.</span><span class="sxs-lookup"><span data-stu-id="df527-109">The cloud files API provides support for sync engines in a way that offers many new benefits to developers and end users.</span></span>

<span data-ttu-id="df527-110">API облачных файлов содержит следующие собственные API-интерфейсы Win32 и среда выполнения Windows (WinRT):</span><span class="sxs-lookup"><span data-stu-id="df527-110">The cloud files API contains the following native Win32 APIs and Windows Runtime (WinRT) APIs:</span></span>

* <span data-ttu-id="df527-111">[API облачного фильтра](cloud-filter-reference.md). Этот собственный API Win32 обеспечивает функциональность на границе между режимом пользователя и файловой системой.</span><span class="sxs-lookup"><span data-stu-id="df527-111">[Cloud Filter API](cloud-filter-reference.md): This native Win32 API provides functionality at the boundary between the user mode and the file system.</span></span> <span data-ttu-id="df527-112">Этот API обрабатывает создание и управление заполнителями файлов и каталогов.</span><span class="sxs-lookup"><span data-stu-id="df527-112">This API handles the creation and management of placeholder files and directories.</span></span>
* <span data-ttu-id="df527-113">[Пространство имен Windows. Storage. Provider](/uwp/api/windows.storage.provider). Этот API-интерфейс WinRT позволяет приложениям настроить поставщик облачного хранилища и зарегистрировать корень синхронизации в операционной системе.</span><span class="sxs-lookup"><span data-stu-id="df527-113">[Windows.Storage.Provider namespace](/uwp/api/windows.storage.provider): This WinRT API enables applications to configure the cloud storage provider and register the sync root with the operating system.</span></span>

> [!NOTE]
> <span data-ttu-id="df527-114">В настоящее время API облачных файлов не поддерживает реализацию облачных модулей синхронизации в приложениях UWP.</span><span class="sxs-lookup"><span data-stu-id="df527-114">The cloud files API does not currently support implementing cloud sync engines in UWP apps.</span></span> <span data-ttu-id="df527-115">Модули синхронизации облака должны быть реализованы в приложениях для настольных систем.</span><span class="sxs-lookup"><span data-stu-id="df527-115">Cloud sync engines must be implemented in desktop apps.</span></span>

## <a name="supported-features"></a><span data-ttu-id="df527-116">Поддерживаемые функции</span><span class="sxs-lookup"><span data-stu-id="df527-116">Supported features</span></span>

<span data-ttu-id="df527-117">API облачных файлов предоставляет следующие возможности для создания облачных модулей синхронизации.</span><span class="sxs-lookup"><span data-stu-id="df527-117">The cloud files API provides the following features for building cloud sync engines.</span></span>

### <a name="placeholder-files"></a><span data-ttu-id="df527-118">Файлы заполнителей</span><span class="sxs-lookup"><span data-stu-id="df527-118">Placeholder files</span></span>

* <span data-ttu-id="df527-119">Модули синхронизации могут создавать файлы заполнителей, которые используют только 1 КБ хранилища для заголовка FileSystem и автоматически расконсервации в полные файлы при нормальных условиях использования.</span><span class="sxs-lookup"><span data-stu-id="df527-119">Sync engines can create placeholder files that consume only 1 KB of storage for the filesystem header, and that automatically hydrate into full files under normal use conditions.</span></span> <span data-ttu-id="df527-120">Файлы заполнителей представляются как обычные файлы для приложений и конечных пользователей в оболочке Windows.</span><span class="sxs-lookup"><span data-stu-id="df527-120">Placeholder files present as typical files to apps and to end users in the Windows Shell.</span></span>
* <span data-ttu-id="df527-121">Файлы заполнителей вертикально интегрированы из ядра Windows в оболочку Windows, а совместимость приложений с файлами заполнителей обычно не вызывает проблем.</span><span class="sxs-lookup"><span data-stu-id="df527-121">Placeholder files are vertically integrated from the Windows kernel up to the Windows Shell, and app compatibility with placeholder files is generally a non-issue.</span></span> <span data-ttu-id="df527-122">Независимо от того, используете ли вы API-интерфейсы файловой системы, командную строку или приложение UWP для доступа к файлу заполнителя, файл будет расконсервации без дополнительных изменений кода и приложение сможет использовать этот файл в обычном режиме.</span><span class="sxs-lookup"><span data-stu-id="df527-122">Whether you use file system APIs, the Command Prompt, or a desktop or a UWP app to access a placeholder file, the file will hydrate without additional code changes and that app can use the file normally.</span></span>
* <span data-ttu-id="df527-123">Файлы могут находиться в трех состояниях:</span><span class="sxs-lookup"><span data-stu-id="df527-123">Files can exist in three states:</span></span>
  * <span data-ttu-id="df527-124">**Файл заполнителя**: пустое представление файла и доступно только в том случае, если доступна служба синхронизации.</span><span class="sxs-lookup"><span data-stu-id="df527-124">**Placeholder file**: An empty representation of the file and only available if the sync service is available.</span></span>
  * <span data-ttu-id="df527-125">**Полный файл**. файл был сохранен неявным образом и может быть восстановлен системой, если требуется пространство.</span><span class="sxs-lookup"><span data-stu-id="df527-125">**Full file**: The file has been hydrated implicitly and could be dehydrated by the system if space is needed.</span></span>
  * <span data-ttu-id="df527-126">**Закрепленный полный файл**: файл сохранен явным образом пользователем через проводник и гарантированно доступен в автономном режиме.</span><span class="sxs-lookup"><span data-stu-id="df527-126">**Pinned full file**: The file has been hydrated explicitly by the user through File Explorer and is guaranteed to be available offline.</span></span>

<span data-ttu-id="df527-127">На следующем рисунке показано, как заполнители, полные и закрепленные полные состояния файлов отображаются в проводнике.</span><span class="sxs-lookup"><span data-stu-id="df527-127">The following image demonstrates how the placeholder, full, and pinned full file states are shown in File Explorer.</span></span>

  ![Пример трех состояний файла в проводнике](images/cloud-file-states-file-explorer.png)

### <a name="standardized-sync-root-registration"></a><span data-ttu-id="df527-129">Стандартизированная регистрация в корне синхронизации</span><span class="sxs-lookup"><span data-stu-id="df527-129">Standardized sync root registration</span></span>

* <span data-ttu-id="df527-130">Регистрация корня синхронизации является простой и стандартизированной.</span><span class="sxs-lookup"><span data-stu-id="df527-130">Registering a sync root is straightforward and standardized.</span></span> <span data-ttu-id="df527-131">Это включает создание фирменного узла в области навигации проводника, как показано на следующем снимке экрана.</span><span class="sxs-lookup"><span data-stu-id="df527-131">This includes creation of a branded node in the navigation pane of File Explorer, as shown in the following screenshot.</span></span> <span data-ttu-id="df527-132">Корни могут создаваться либо как отдельные записи верхнего уровня, либо как дочерние элементы родительской группировки.</span><span class="sxs-lookup"><span data-stu-id="df527-132">Roots can be created either as individual top-level entries, or as children of a parent grouping.</span></span>

  ![Пример корневой записи синхронизации в проводнике](images/register-sync-root-file-explorer.png)

### <a name="shell-integration"></a><span data-ttu-id="df527-134">Интеграция оболочки</span><span class="sxs-lookup"><span data-stu-id="df527-134">Shell integration</span></span>

* <span data-ttu-id="df527-135">Значки состояния:</span><span class="sxs-lookup"><span data-stu-id="df527-135">State icons:</span></span>
  * <span data-ttu-id="df527-136">API облачных файлов предоставляет стандартизированные, автоматические значки состояния расконсервации, отображаемые в проводнике и на рабочем столе Windows.</span><span class="sxs-lookup"><span data-stu-id="df527-136">The cloud files API provides standardized, automatic hydration state icons shown in File Explorer and on the Windows desktop.</span></span>
  * <span data-ttu-id="df527-137">Помимо стандартных значков состояния Windows, используемых для состояния расконсервации, можно предоставить настраиваемые значки состояния для дополнительных свойств, зависящих от службы.</span><span class="sxs-lookup"><span data-stu-id="df527-137">In addition to the standard Windows state icons used for hydration state, you can provide custom state icons for additional service-specific properties.</span></span>
  * <span data-ttu-id="df527-138">Заменяет расширения оболочки наложения значков прежних версий.</span><span class="sxs-lookup"><span data-stu-id="df527-138">Replaces legacy icon overlay Shell extensions.</span></span>
* <span data-ttu-id="df527-139">Индикатор хода выполнения:</span><span class="sxs-lookup"><span data-stu-id="df527-139">Progress indication:</span></span>
  * <span data-ttu-id="df527-140">Открытие файла заполнителя, который занимает более нескольких секунд, расконсервации будет показывать ход выполнения расконсервации.</span><span class="sxs-lookup"><span data-stu-id="df527-140">Opening a placeholder file that takes more than a few seconds to hydrate will show hydration progress.</span></span> <span data-ttu-id="df527-141">Ход выполнения отображается в нескольких расположениях в зависимости от контекста:</span><span class="sxs-lookup"><span data-stu-id="df527-141">Progress is shown in a few locations depending on context:</span></span>
    * <span data-ttu-id="df527-142">В диалоговом окне механизма копирования.</span><span class="sxs-lookup"><span data-stu-id="df527-142">In a copy engine dialog window.</span></span>
    * <span data-ttu-id="df527-143">Встроенный ход выполнения отображается рядом с файлом в проводнике.</span><span class="sxs-lookup"><span data-stu-id="df527-143">Inline progress is shown next to the file in File Explorer.</span></span>
    * <span data-ttu-id="df527-144">Если файл не открывается в инструкции пользователя, отображается всплывающее уведомление для информирования пользователя и предоставления способа управления непредвиденными действиями расконсервации.</span><span class="sxs-lookup"><span data-stu-id="df527-144">If the file is not opened at the user’s specific instruction, a toast notification is shown to inform the user and provide a way to control unintended hydration activity.</span></span>
* <span data-ttu-id="df527-145">Эскизы и метаданные:</span><span class="sxs-lookup"><span data-stu-id="df527-145">Thumbnails and metadata:</span></span>
  * <span data-ttu-id="df527-146">Файлы заполнителей могут иметь обширные эскизы, предоставляемые службой, и расширенные метаданные файлов, чтобы предоставить пользователю возможность беспрепятственно работать с обозревателем файлов.</span><span class="sxs-lookup"><span data-stu-id="df527-146">Placeholder files can have rich service-provided thumbnails and extended file metadata to provide the user with a seamless File Explorer experience.</span></span>
* <span data-ttu-id="df527-147">Панель навигации обозревателя файлов:</span><span class="sxs-lookup"><span data-stu-id="df527-147">File Explorer navigation pane:</span></span>
  * <span data-ttu-id="df527-148">Регистрация корня синхронизации с помощью API облачных файлов приводит к тому, что корневой каталог синхронизации (со значком и настраиваемым именем) отображается в области навигации проводника.</span><span class="sxs-lookup"><span data-stu-id="df527-148">Registering a sync root with the cloud files API causes that sync root (with an icon and custom name) to appear in File Explorer’s navigation pane.</span></span>
* <span data-ttu-id="df527-149">Контекстные меню проводника:</span><span class="sxs-lookup"><span data-stu-id="df527-149">File Explorer context menus:</span></span>
  * <span data-ttu-id="df527-150">Регистрация корня синхронизации с помощью API облачных файлов автоматически предоставляет несколько команд (пункты меню) в контекстном меню проводника, позволяющие пользователю управлять состоянием расконсервации файла.</span><span class="sxs-lookup"><span data-stu-id="df527-150">Registering a sync root with the cloud files API automatically provides several verbs (menu entries) in File Explorer’s context menu that let the user control the hydration state of their file.</span></span>
  * <span data-ttu-id="df527-151">Дополнительные команды можно добавить в этот раздел контекстного меню с помощью интерфейсов API, совместимых с мостом рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="df527-151">Additional verbs can be added to this section of the context menu using Desktop Bridge-compatible APIs.</span></span>
* <span data-ttu-id="df527-152">Пользовательское управление файлом расконсервации:</span><span class="sxs-lookup"><span data-stu-id="df527-152">User control of file hydration:</span></span>
  * <span data-ttu-id="df527-153">Пользователи всегда управляют файлами расконсервации, даже если они не сохраняются явным образом пользователем.</span><span class="sxs-lookup"><span data-stu-id="df527-153">Users are always in control of file hydration, even when the files are not hydrated explicitly by the user.</span></span> <span data-ttu-id="df527-154">Интерактивное всплывающее уведомление отображается в фоновом расконсервации для оповещения пользователя и предоставления параметров.</span><span class="sxs-lookup"><span data-stu-id="df527-154">An interactive toast is shown for background hydration to alert the user and provide options.</span></span> <span data-ttu-id="df527-155">На следующем рисунке показано всплывающее уведомление для файла с заархивированием.</span><span class="sxs-lookup"><span data-stu-id="df527-155">The following image demonstrates a toast notification for a hydrating file.</span></span>
    <span data-ttu-id="df527-156">![Пример интерактивного уведомления, отображаемого для фонового расконсервации файла](images/file-hydration-interactive-toast.png)</span><span class="sxs-lookup"><span data-stu-id="df527-156">![Example of an interactive toast shown for background file hydration](images/file-hydration-interactive-toast.png)</span></span>
  * <span data-ttu-id="df527-157">Если пользователь блокирует восстановление файлов с помощью интерактивного всплывающего уведомления, он может разблокировать приложение на странице " **Автоматическая загрузка файлов** " в окне " **Параметры**".</span><span class="sxs-lookup"><span data-stu-id="df527-157">If a user blocks an app from hydrating files through an interactive toast, they can unblock the app in the **Automatic file downloads** page in **Settings**.</span></span>
    <span data-ttu-id="df527-158">![Снимок экрана: параметр "Автоматическая загрузка файлов"](images/allow-automatic-file-downloads-setting.png)</span><span class="sxs-lookup"><span data-stu-id="df527-158">![Screenshot of the automatic file downloads setting](images/allow-automatic-file-downloads-setting.png)</span></span>
* <span data-ttu-id="df527-159">Подключение операций механизма копирования (поддерживается в предварительной версии Windows 10 Insider Build 19624 и более поздних версий):</span><span class="sxs-lookup"><span data-stu-id="df527-159">Hooking copy engine operations (supported in Windows 10 Insider Preview Build 19624 and later versions):</span></span>
  * <span data-ttu-id="df527-160">Поставщики облачного хранилища могут зарегистрировать обработчик копии оболочки для отслеживания операций с файлами в корне синхронизации.</span><span class="sxs-lookup"><span data-stu-id="df527-160">Cloud storage providers can register a shell copy hook for monitoring file operations within their sync root.</span></span>
  * <span data-ttu-id="df527-161">Поставщик регистрирует свой обработчик копии, установив значение реестра **копихук** в разделе реестра корневого раздела синхронизации равным CLSID своего объекта ЛОКАЛЬНОГО сервера COM.</span><span class="sxs-lookup"><span data-stu-id="df527-161">The provider registers their copy hook by setting the **CopyHook** registry value under their sync root registry key to a the CLSID of their COM local server object.</span></span> <span data-ttu-id="df527-162">Этот объект локального сервера реализует интерфейс [исторажепровидеркопихук](../shell/nn-shobjidl-istorageprovidercopyhook.md) .</span><span class="sxs-lookup"><span data-stu-id="df527-162">This local server object implements the [IStorageProviderCopyHook](../shell/nn-shobjidl-istorageprovidercopyhook.md) interface.</span></span>

### <a name="desktop-bridge"></a><span data-ttu-id="df527-163">Мост для классических приложений</span><span class="sxs-lookup"><span data-stu-id="df527-163">Desktop Bridge</span></span>

* <span data-ttu-id="df527-164">Модули синхронизации, использующие API облачных файлов, предназначены для использования [настольного моста](/windows/uwp/porting/desktop-to-uwp-root) в качестве требования к реализации.</span><span class="sxs-lookup"><span data-stu-id="df527-164">Sync engines using the cloud files APIs are designed to use the [Desktop Bridge](/windows/uwp/porting/desktop-to-uwp-root) as an implementation requirement.</span></span>

## <a name="cloud-mirror-sample"></a><span data-ttu-id="df527-165">Пример зеркального облака</span><span class="sxs-lookup"><span data-stu-id="df527-165">Cloud Mirror sample</span></span>

<span data-ttu-id="df527-166">В [примере зеркальной базы облака](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/CloudMirror) показано, как создать решение, использующее API облачных файлов.</span><span class="sxs-lookup"><span data-stu-id="df527-166">The [Cloud Mirror sample](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/CloudMirror) illustrates how to build a solution that uses the cloud files API.</span></span> <span data-ttu-id="df527-167">Он не предназначен для использования в качестве рабочего кода.</span><span class="sxs-lookup"><span data-stu-id="df527-167">It is not intended to be used as production code.</span></span> <span data-ttu-id="df527-168">В нем отсутствует надежная обработка ошибок, и она написана так, чтобы быть понятной как можно более понятную.</span><span class="sxs-lookup"><span data-stu-id="df527-168">It lacks robust error handling and it is written to be as easily understood as possible.</span></span> <span data-ttu-id="df527-169">Он называется зеркалом облака, так как он просто зеркально отображает локальную папку на локальном диске.</span><span class="sxs-lookup"><span data-stu-id="df527-169">It's called Cloud Mirror because it simply mirrors a local folder on your local disk.</span></span> <span data-ttu-id="df527-170">Укажите серверную папку, которая должна представлять облачный файловый сервер, и клиентскую папку, которая будет указывать корневой путь синхронизации.</span><span class="sxs-lookup"><span data-stu-id="df527-170">You specify a server folder that is meant to represent your cloud file server and a client folder that is meant to specify the sync root path.</span></span> <span data-ttu-id="df527-171">Узел верхнего уровня появится в области навигации проводника с именем **тестсторажепровидердисплайнаме**, а этот узел сопоставляется с указанной клиентской папкой.</span><span class="sxs-lookup"><span data-stu-id="df527-171">A top-level node appears in the navigation pane in File Explorer called **TestStorageProviderDisplayName**, and this node maps to the specified client folder.</span></span>

<span data-ttu-id="df527-172">Когда дело доходит до синхронизации, это все, что необходимо реализовать в полностью разработанном поставщике синхронизации облачных файлов:</span><span class="sxs-lookup"><span data-stu-id="df527-172">When it comes to syncing, these are the things that a fully-developed cloud files sync provider must implement:</span></span>

* <span data-ttu-id="df527-173">Если корневой файл синхронизации является просто заполнителем, служба несет ответственность за копирование содержимого файла для расконсервации.</span><span class="sxs-lookup"><span data-stu-id="df527-173">When the sync root file is just a placeholder, the service is responsible for copying down the contents of the file for hydration.</span></span> <span data-ttu-id="df527-174">Это реализовано в примере.</span><span class="sxs-lookup"><span data-stu-id="df527-174">This is implemented in the sample.</span></span>
* <span data-ttu-id="df527-175">Если корневой файл синхронизации является полным файлом и содержимое файла в облачной службе изменяется, служба несет ответственность за уведомление клиента об изменении локальной синхронизации, и клиент локальной синхронизации должен выполнять слияние в соответствии с собственными характеристиками.</span><span class="sxs-lookup"><span data-stu-id="df527-175">When the sync root file is a full file and the contents of the file in the cloud service change, the service is responsible of notifying the local sync client of the change and the local sync client must handle merges according to their own specifications.</span></span> <span data-ttu-id="df527-176">Это не реализовано в примере.</span><span class="sxs-lookup"><span data-stu-id="df527-176">This is not implemented in the sample.</span></span>
* <span data-ttu-id="df527-177">Если корневой файл синхронизации представляет собой полный файл и содержимое файла в корневом пути синхронизации (локальный клиент), локальный клиент синхронизации должен уведомлять облачную службу и выполнять слияние в соответствии с собственными характеристиками.</span><span class="sxs-lookup"><span data-stu-id="df527-177">When the sync root file is a full file and the contents of the file in the sync root path (the local client) change, the local sync client must notify the cloud service and handle merges according to their own specifications.</span></span> <span data-ttu-id="df527-178">Уведомление об изменении локального файла реализовано в примере, но не выполняет никаких действий.</span><span class="sxs-lookup"><span data-stu-id="df527-178">The local file change notification is implemented in the sample, but it does not do anything.</span></span>

### <a name="use-the-sample"></a><span data-ttu-id="df527-179">Использование примера</span><span class="sxs-lookup"><span data-stu-id="df527-179">Use the sample</span></span>

1. <span data-ttu-id="df527-180">Создайте две папки на локальном жестком диске.</span><span class="sxs-lookup"><span data-stu-id="df527-180">Create two folders on your local hard drive.</span></span> <span data-ttu-id="df527-181">Один из них будет действовать как сервер, а другой — как клиент.</span><span class="sxs-lookup"><span data-stu-id="df527-181">One of them will act as the server and the other as the client.</span></span>
2. <span data-ttu-id="df527-182">Добавьте файлы в папку сервера.</span><span class="sxs-lookup"><span data-stu-id="df527-182">Add some files to the server folder.</span></span> <span data-ttu-id="df527-183">Убедитесь, что папка клиента пуста.</span><span class="sxs-lookup"><span data-stu-id="df527-183">Make sure the client folder is empty.</span></span>
3. <span data-ttu-id="df527-184">Откройте пример зеркала Cloud в Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="df527-184">Open the Cloud Mirror sample in Visual Studio.</span></span> <span data-ttu-id="df527-185">Задайте проект **клаудмиррорпаккаже** в качестве запускаемого проекта, а затем выполните сборку и запуск примера.</span><span class="sxs-lookup"><span data-stu-id="df527-185">Set the **CloudMirrorPackage** project as your startup project and then build and run the sample.</span></span> <span data-ttu-id="df527-186">При появлении запроса в примере введите два пути к серверу и клиентским папкам.</span><span class="sxs-lookup"><span data-stu-id="df527-186">When prompted by the sample, enter the two paths to your server and client folders.</span></span> <span data-ttu-id="df527-187">После этого отобразится окно консоли с диагностической информацией.</span><span class="sxs-lookup"><span data-stu-id="df527-187">After this you will see a console window with diagnostic information.</span></span>
4. <span data-ttu-id="df527-188">Откройте проводник и убедитесь, что вы видите узел **тестсторажепровидердисплайнаме** и заполнители для всех файлов, скопированных в папку сервера.</span><span class="sxs-lookup"><span data-stu-id="df527-188">Open File Explorer and confirm that you see the **TestStorageProviderDisplayName** node and the placeholders for all the files that you copied into the server folder.</span></span> <span data-ttu-id="df527-189">Чтобы имитировать приложение, которое пытается открыть файлы без использования средства выбора, скопируйте несколько образов в папку сервера.</span><span class="sxs-lookup"><span data-stu-id="df527-189">To simulate an application that tries to open files without using the picker, copy several images to the server folder.</span></span> <span data-ttu-id="df527-190">Дважды щелкните одну из них в корневой папке синхронизации и подтвердите, что она будет восстановлена.</span><span class="sxs-lookup"><span data-stu-id="df527-190">Double-click one of them in your sync root folder and confirm that it hydrates.</span></span> <span data-ttu-id="df527-191">Затем откройте приложение "фотографии".</span><span class="sxs-lookup"><span data-stu-id="df527-191">Then, open the Photos app.</span></span> <span data-ttu-id="df527-192">Приложение будет предварительно загружать смежные файлы в фоновом режиме, что позволит пользователю не столкнуться с задержками при просмотре других изображений.</span><span class="sxs-lookup"><span data-stu-id="df527-192">The app will pre-load adjacent files in the background to make it more likely the user does not experience delays when looking through the other pictures.</span></span> <span data-ttu-id="df527-193">Вы можете наблюдать за фоновым восстановлением с помощью всплывающих уведомлений или проводника.</span><span class="sxs-lookup"><span data-stu-id="df527-193">You can observe the background dehydration happen via toasts or in File Explorer.</span></span>
5. <span data-ttu-id="df527-194">Щелкните правой кнопкой мыши файл в проводнике, чтобы открыть контекстное меню, и убедитесь, что вы видите пункт меню **тесткомманд** .</span><span class="sxs-lookup"><span data-stu-id="df527-194">Right-click a file in File Explorer to bring up a context menu, and confirm that you see the **TestCommand** menu item.</span></span> <span data-ttu-id="df527-195">При щелчке этого пункта меню отображается окно сообщения.</span><span class="sxs-lookup"><span data-stu-id="df527-195">Clicking this menu item will display a message box.</span></span>
6. <span data-ttu-id="df527-196">Чтобы прерывать выборку, установите фокус на выходные данные консоли и нажмите клавиши **CTRL + C**.</span><span class="sxs-lookup"><span data-stu-id="df527-196">To stop the sample, set focus to the console output and press **Ctrl-C**.</span></span> <span data-ttu-id="df527-197">При этом будет выполнена очистка корневой регистрации синхронизации, чтобы поставщик был удален.</span><span class="sxs-lookup"><span data-stu-id="df527-197">This will cleanup the sync root registration so that the provider is uninstalled.</span></span> <span data-ttu-id="df527-198">Если пример завершается сбоем, то возможно, что корень синхронизации останется зарегистрированным.</span><span class="sxs-lookup"><span data-stu-id="df527-198">If the sample crashes, it’s possible that the sync root will remain registered.</span></span> <span data-ttu-id="df527-199">Это приведет к повторному запуску проводника при каждом щелчке любого элемента и появлении запроса на фиктивные расположения клиента и сервера.</span><span class="sxs-lookup"><span data-stu-id="df527-199">This will cause File Explorer to relaunch every time you click on anything, and you would get prompted for the fake client and server locations.</span></span> <span data-ttu-id="df527-200">В этом случае удалите пример приложения **клаудмиррорпаккаже** с компьютера.</span><span class="sxs-lookup"><span data-stu-id="df527-200">If this occurs, uninstall the **CloudMirrorPackage** sample application from your computer.</span></span>

### <a name="sample-architecture"></a><span data-ttu-id="df527-201">Пример архитектуры</span><span class="sxs-lookup"><span data-stu-id="df527-201">Sample architecture</span></span>

<span data-ttu-id="df527-202">Пример намеренно прост.</span><span class="sxs-lookup"><span data-stu-id="df527-202">The sample is deliberately simple.</span></span> <span data-ttu-id="df527-203">Он использует статические классы, чтобы сделать его ненужным для передачи указателей на экземпляры.</span><span class="sxs-lookup"><span data-stu-id="df527-203">It uses static classes to make it unnecessary to pass instance pointers.</span></span> <span data-ttu-id="df527-204">Ниже приведены основные классы в примере.</span><span class="sxs-lookup"><span data-stu-id="df527-204">Here are the main classes in the sample:</span></span>

* <span data-ttu-id="df527-205">**Факеклаудпровидер**: Этот класс верхнего уровня управляет следующими рабочими классами:</span><span class="sxs-lookup"><span data-stu-id="df527-205">**FakeCloudProvider**: This top-level class controls the following worker classes:</span></span>
  * <span data-ttu-id="df527-206">**Клаудпровидеррегистрар**: регистрирует корневую информацию синхронизации с оболочкой Windows.</span><span class="sxs-lookup"><span data-stu-id="df527-206">**CloudProviderRegistrar**: Registers the sync root information with the Windows Shell.</span></span>
  * <span data-ttu-id="df527-207">**Заполнители**: создает файлы заполнителей в корневом пути синхронизации.</span><span class="sxs-lookup"><span data-stu-id="df527-207">**Placeholders**: Generates the placeholder files in the sync root path.</span></span>
  * <span data-ttu-id="df527-208">**Шеллсервицес**: конструирует поставщиков оболочки Windows для контекстного меню, эскизов и других служб.</span><span class="sxs-lookup"><span data-stu-id="df527-208">**ShellServices**: Constructs the Windows Shell providers for the context menu, thumbnails, and other services.</span></span>
  * <span data-ttu-id="df527-209">**Клаудпровидерсинкрутватчер**: создает экземпляр директориватчер для отслеживания изменений в корневом пути синхронизации и выполнения действий над изменениями.</span><span class="sxs-lookup"><span data-stu-id="df527-209">**CloudProviderSyncRootWatcher**: Instantiates a DirectoryWatcher to monitor changes to the sync root path and act on changes.</span></span>
  * <span data-ttu-id="df527-210">**Филекопиервиспрогресс**: копирует файлы из серверной папки в папку клиента медленно в фрагментах, чтобы имитировать их загрузку с реального облачного сервера.</span><span class="sxs-lookup"><span data-stu-id="df527-210">**FileCopierWithProgress**: Copies files from the server folder to the client folder slowly in chunks to simulate downloading them from a real cloud server.</span></span> <span data-ttu-id="df527-211">Предоставляет индикатор хода выполнения, чтобы всплывающие окна и пользовательский интерфейс проводника могли показать пользователю что-нибудь информативное.</span><span class="sxs-lookup"><span data-stu-id="df527-211">Provides progress indication so that toasts and File Explorer UI shows the user something informative.</span></span>

<span data-ttu-id="df527-212">Помимо приведенных выше классов, пример также предоставляет несколько вспомогательных классов для запроса пользователю папок и некоторых служебных программ.</span><span class="sxs-lookup"><span data-stu-id="df527-212">In addition to the classes above, the sample also provides several helper classes to prompt the user for folders and some utilities.</span></span> <span data-ttu-id="df527-213">**Тестексплореркоммандхандлер**, **кустомстатепровидер**, **сумбнаилпровидер** и **Урисаурце** — это все примеры поставщиков служб оболочки.</span><span class="sxs-lookup"><span data-stu-id="df527-213">The **TestExplorerCommandHandler**, **CustomStateProvider**, **ThumbnailProvider**, and **UriSource** are all examples of Shell service providers.</span></span>

## <a name="cloud-files-api-architecture"></a><span data-ttu-id="df527-214">Архитектура API облачных файлов</span><span class="sxs-lookup"><span data-stu-id="df527-214">Cloud files API architecture</span></span>

<span data-ttu-id="df527-215">Ядром стека хранилища в API облачных файлов является драйвер минифильтра файловой системы, именуемый cldflt.sys.</span><span class="sxs-lookup"><span data-stu-id="df527-215">At the core of the storage stack in the cloud files API is a file system minifilter driver called cldflt.sys.</span></span> <span data-ttu-id="df527-216">Этот драйвер выступает в качестве прокси-сервера между приложениями пользователя и модулем синхронизации.</span><span class="sxs-lookup"><span data-stu-id="df527-216">This driver acts as a proxy between the user’s applications and your sync engine.</span></span> <span data-ttu-id="df527-217">Модуль синхронизации знает, как загружать и загружать данные по запросу, в то время как обязанностью cldflt.sys работать с оболочкой для представления файлов, как если бы облачные данные были локально доступны.</span><span class="sxs-lookup"><span data-stu-id="df527-217">Your sync engine knows how to download and upload the data on demand while it is responsibility of cldflt.sys to work with the Shell to present files as if the cloud data were locally available.</span></span>

<span data-ttu-id="df527-218">Cldflt.sys в настоящее время поддерживает только тома NTFS, так как он зависит от некоторых функций, уникальных для NTFS.</span><span class="sxs-lookup"><span data-stu-id="df527-218">Cldflt.sys currently only supports NTFS volumes because it depends on some features unique to NTFS.</span></span>

<span data-ttu-id="df527-219">В системе имеется много драйверов минифильтра файловой системы, которые могут быть активны на заданном томе одновременно.</span><span class="sxs-lookup"><span data-stu-id="df527-219">There are many file system minifilter drivers in a system and they can be active on a given volume at the same time.</span></span> <span data-ttu-id="df527-220">Драйверы, которые наиболее интересны для API облачных файлов, — это фильтры файловой системы антивирусной программы.</span><span class="sxs-lookup"><span data-stu-id="df527-220">The drivers that are of most interest to the cloud files API are the anti-virus file system filters.</span></span>

<span data-ttu-id="df527-221">Драйверы минифильтра файловой системы управляются и поддерживаются специальным компонентом режима ядра, который называется диспетчером фильтров.</span><span class="sxs-lookup"><span data-stu-id="df527-221">File system minifilter drivers are managed and supported by a special kernel-mode component called the filter manager.</span></span> <span data-ttu-id="df527-222">Помимо многих других обязанностей Диспетчер фильтров упрощает нефильтрованное взаимодействие между фильтрами и компонентами пользовательского режима с помощью конструкции, известной как порт сообщений фильтра.</span><span class="sxs-lookup"><span data-stu-id="df527-222">Among many other duties, the filter manager facilitates unfiltered communication between filters and user mode components via a construct known as filter message port.</span></span>

## <a name="hydration-policies"></a><span data-ttu-id="df527-223">Политики расконсервации</span><span class="sxs-lookup"><span data-stu-id="df527-223">Hydration Policies</span></span>

<span data-ttu-id="df527-224">Windows поддерживает ряд [основных политик расконсервации](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_primary) и дополнительных модификаторов [политики расконсервации](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_modifier) .</span><span class="sxs-lookup"><span data-stu-id="df527-224">Windows supports a variety of [primary hydration policies](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_primary) and [secondary hydration policy](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_modifier) modifiers.</span></span> <span data-ttu-id="df527-225">Ниже приведен порядок, в котором политики PRIMARY расконсервации:</span><span class="sxs-lookup"><span data-stu-id="df527-225">Primary hydration policies have this order:</span></span>

  <span data-ttu-id="df527-226">**Всегда полностью > полный > прогрессивный > частичный**</span><span class="sxs-lookup"><span data-stu-id="df527-226">**Always full > Full > Progressive > Partial**</span></span>

<span data-ttu-id="df527-227">Приложения и модули синхронизации могут определять предпочтительную основную политику расконсервации.</span><span class="sxs-lookup"><span data-stu-id="df527-227">Both applications and sync engines can define their preferred primary hydration policy.</span></span> <span data-ttu-id="df527-228">Если не указано, то политика расконсервации по умолчанию прогрессивна для приложений и модулей синхронизации.</span><span class="sxs-lookup"><span data-stu-id="df527-228">If not specified, the default hydration policy is progressive for both applications and sync engines.</span></span>

<span data-ttu-id="df527-229">Политика расконсервации для облачного файла определяется во время открытия файла по следующей формуле:</span><span class="sxs-lookup"><span data-stu-id="df527-229">The hydration policy of a cloud file is determined at the file open time by this formula:</span></span>

  ```File hydration policy = max(app hydration policy, provider hydration policy)```

<span data-ttu-id="df527-230">Например, предположим, что пользователь пытается открыть PDF-файл, хранящийся на облачном диске Fabrikam, с помощью средства просмотра PDF-файлов Contoso, которое не указывает предпочитаемую политику расконсервации.</span><span class="sxs-lookup"><span data-stu-id="df527-230">For example, let’s say the user is trying to open a PDF file stored on Fabrikam Cloud Drive using Contoso PDF Viewer, which doesn’t specify a preferred hydration policy.</span></span> <span data-ttu-id="df527-231">Поэтому политика расконсервации приложений по умолчанию является прогрессивной расконсервации в данном случае.</span><span class="sxs-lookup"><span data-stu-id="df527-231">The application hydration policy is therefore progressive hydration, in this case by default.</span></span> <span data-ttu-id="df527-232">Однако, поскольку облачный диск Fabrikam является полным модулем синхронизации расконсервации, окончательная политика расконсервации в файле становится полной расконсервации, что приведет к полному восстановлению файла при первом доступе.</span><span class="sxs-lookup"><span data-stu-id="df527-232">However, because Fabrikam Cloud Drive is a full hydration sync engine, the final hydration policy on the file becomes full hydration, which will result in the file being fully hydrated on first access.</span></span> <span data-ttu-id="df527-233">Тот же результат происходит в случаях, когда модуль синхронизации поддерживает прогрессивный расконсервации, но предпочтение приложения полностью расконсервации.</span><span class="sxs-lookup"><span data-stu-id="df527-233">The same outcome happens in cases where the sync engine supports progressive hydration, but the app’s preference is full hydration.</span></span>

<span data-ttu-id="df527-234">Обратите внимание, что политику расконсервации файла нельзя изменить после открытия файла.</span><span class="sxs-lookup"><span data-stu-id="df527-234">Note that the file hydration policy cannot be changed after the file is opened.</span></span>

## <a name="compatibility-with-applications-that-use-reparse-points"></a><span data-ttu-id="df527-235">Совместимость с приложениями, использующими точки повторного анализа</span><span class="sxs-lookup"><span data-stu-id="df527-235">Compatibility with applications that use reparse points</span></span>

<span data-ttu-id="df527-236">API облачных файлов реализует систему-заполнитель с помощью [точек повторного анализа](/windows/desktop/FileIO/reparse-points).</span><span class="sxs-lookup"><span data-stu-id="df527-236">The cloud files API implements the placeholder system using [reparse points](/windows/desktop/FileIO/reparse-points).</span></span> <span data-ttu-id="df527-237">Распространенным заблуждением точек повторного анализа является то, что они совпадают с символической ссылкой.</span><span class="sxs-lookup"><span data-stu-id="df527-237">A common misconception about reparse points is that they are the same as symbolic links.</span></span> <span data-ttu-id="df527-238">Это ошибочное понятие иногда отражено в реализациях приложений, и в результате многие существующие приложения сталкиваются с ошибками при обнаружении любой точки повторного анализа.</span><span class="sxs-lookup"><span data-stu-id="df527-238">This misconception is occasionally reflected in application implementations, and as a result, many existing applications hit errors when encountering any reparse point.</span></span>

<span data-ttu-id="df527-239">Чтобы устранить эту проблемы совместимости, API облачных файлов всегда скрывает свои точки повторной обработки из всех приложений, за исключением модулей синхронизации и процессов, основной образ которых находится в папке **% systemroot%**.</span><span class="sxs-lookup"><span data-stu-id="df527-239">To mitigate this compatibility issue, the cloud files API always hides its reparse points from all applications except for sync engines and processes whose main image resides under **%systemroot%**.</span></span> <span data-ttu-id="df527-240">Приложения, которые понимают точки повторного анализа, правильно позволяют платформе предоставлять точки повторного анализа API облачных файлов с помощью [ртлсетпроцессплацехолдеркомпатибилитимоде](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetprocessplaceholdercompatibilitymode) или [ртлсетсреадпроцессплацехолдеркомпатибилитимоде](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetthreadplaceholdercompatibilitymode).</span><span class="sxs-lookup"><span data-stu-id="df527-240">Applications that understand reparse points correctly can force the platform to expose cloud files API reparse points using [RtlSetProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetprocessplaceholdercompatibilitymode) or [RtlSetThreadProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetthreadplaceholdercompatibilitymode).</span></span>