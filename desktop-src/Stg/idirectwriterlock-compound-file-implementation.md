---
title: Идиректвритерлокк — реализация составного файла
description: Реализация составного файла Идиректвритерлокк предоставляет способ открытия составного файла в прямом режиме с одним модулем записи и несколькими читателями.
ms.assetid: 4b247dae-d937-430a-bdb7-c47fa3c026b6
keywords:
- Идиректвритерлокк Стрктд STG, реализация составного файла
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 861935a4c373ce03408c0e633e581e56d39623da
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "103773988"
---
# <a name="idirectwriterlock---compound-file-implementation"></a><span data-ttu-id="8b77b-104">Идиректвритерлокк — реализация составного файла</span><span class="sxs-lookup"><span data-stu-id="8b77b-104">IDirectWriterLock - Compound File Implementation</span></span>

<span data-ttu-id="8b77b-105">Реализация составного файла [**идиректвритерлокк**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock) предоставляет способ открытия составного файла в прямом режиме с одним модулем записи и несколькими читателями.</span><span class="sxs-lookup"><span data-stu-id="8b77b-105">The compound file implementation of [**IDirectWriterLock**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock) provides a way to open a compound file in direct mode with a single writer and multiple readers.</span></span>

<span data-ttu-id="8b77b-106">Составные файлы можно открывать в прямом режиме с помощью \_ флага Direct стгм.</span><span class="sxs-lookup"><span data-stu-id="8b77b-106">Compound files can be opened in direct mode using the STGM\_DIRECT flag.</span></span> <span data-ttu-id="8b77b-107">Интерфейс [**идиректвритерлокк**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock) ЗАДАЕТ для стгм \_ ReadWrite \| стгм Share Deny, который \_ \_ \_ является допустимым в режиме прямого доступа, не требуя дополнительной нагрузки на копию моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="8b77b-107">The [**IDirectWriterLock**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock) interface sets the STGM\_READWRITE\|STGM\_SHARE\_DENY\_WRITE flag as valid in direct mode without requiring the overhead of a snapshot copy.</span></span>

<span data-ttu-id="8b77b-108">Если составной файл открывается в режиме транзакций с помощью \_ флага транзакций стгм, можно также иметь несколько модулей чтения и один модуль записи с помощью \_ \| флага записи стгм ReadWrite стгм \_ Share \_ Deny \_ .</span><span class="sxs-lookup"><span data-stu-id="8b77b-108">When a compound file is opened in transacted mode using the STGM\_TRANSACTED flag, you can also have multiple readers and a single writer using the STGM\_READWRITE\|STGM\_SHARE\_DENY\_WRITE flag.</span></span> <span data-ttu-id="8b77b-109">Тем не менее в этом случае для читателей создается копия файла моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="8b77b-109">However, in this case, a snapshot copy of the file is made for the readers.</span></span> <span data-ttu-id="8b77b-110">Часто возникают затраты на копирование временных файлов.</span><span class="sxs-lookup"><span data-stu-id="8b77b-110">There is often overhead of a scratch copy.</span></span>

## <a name="when-to-use"></a><span data-ttu-id="8b77b-111">Назначение</span><span class="sxs-lookup"><span data-stu-id="8b77b-111">When to Use</span></span>

<span data-ttu-id="8b77b-112">Используйте предоставляемую системой реализацию [**идиректвритерлокк**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock) при открытии хранилища в прямом режиме (стгм \_ Direct) с параметром стгм \_ ReadWrite \| стгм \_ совместное использование \_ \_ флагов записи.</span><span class="sxs-lookup"><span data-stu-id="8b77b-112">Use the system-supplied implementation of [**IDirectWriterLock**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock) when you open a storage in direct mode (STGM\_DIRECT) with the STGM\_READWRITE\|STGM\_SHARE\_DENY\_WRITE flags.</span></span>

<span data-ttu-id="8b77b-113">Чтобы получить указатель на [**идиректвритерлокк**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock), вызовите **QueryInterface** в [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) , чтобы получить корневой объект хранилища для составного файла.</span><span class="sxs-lookup"><span data-stu-id="8b77b-113">To obtain a pointer to [**IDirectWriterLock**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock), call **QueryInterface** on [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) to get the root storage object for the compound file.</span></span>

<span data-ttu-id="8b77b-114">Вызовите метод [**идиректвритерлокк:: ваитфорвритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) , чтобы получить монопольный доступ на запись к составному файлу.</span><span class="sxs-lookup"><span data-stu-id="8b77b-114">Call [**IDirectWriterLock::WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) to obtain exclusive write access to a compound file.</span></span> <span data-ttu-id="8b77b-115">Вызовите [**идиректвритерлокк:: релеасевритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-releasewriteaccess) , чтобы освободить монопольный доступ на запись.</span><span class="sxs-lookup"><span data-stu-id="8b77b-115">Call [**IDirectWriterLock::ReleaseWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-releasewriteaccess) to release exclusive write access.</span></span>

<span data-ttu-id="8b77b-116">[**Идиректвритерлокк:: хавевритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-havewriteaccess) указывает, заблокирован ли файл в данный момент.</span><span class="sxs-lookup"><span data-stu-id="8b77b-116">[**IDirectWriterLock::HaveWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-havewriteaccess) indicates whether the file is currently locked.</span></span>

## <a name="remarks"></a><span data-ttu-id="8b77b-117">Комментарии</span><span class="sxs-lookup"><span data-stu-id="8b77b-117">Remarks</span></span>

<span data-ttu-id="8b77b-118">Реализация составного файла функции однократного записи и множественного чтения основана на блокировке диапазона.</span><span class="sxs-lookup"><span data-stu-id="8b77b-118">The compound file implementation of the single-writer, multiple-reader feature is based on range locking.</span></span> <span data-ttu-id="8b77b-119">Модуль записи получает монопольный доступ к хранилищу для записи после того, как все текущие модули чтения закрыли хранилище.</span><span class="sxs-lookup"><span data-stu-id="8b77b-119">The writer obtains exclusive access to the storage to write after all current readers have closed the storage.</span></span> <span data-ttu-id="8b77b-120">Пока модуль записи активен, последующие модули чтения не смогут открыть хранилище.</span><span class="sxs-lookup"><span data-stu-id="8b77b-120">While the writer is active, subsequent readers cannot open the storage.</span></span> <span data-ttu-id="8b77b-121">Модуль записи вызывает [**идиректвритерлокк:: ваитфорвритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) для получения монопольного доступа на запись.</span><span class="sxs-lookup"><span data-stu-id="8b77b-121">The writer calls [**IDirectWriterLock::WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) to obtain exclusive write access.</span></span> <span data-ttu-id="8b77b-122">Чтобы освободить хранилище, модуль записи должен вызвать [**идиректвритерлокк:: релеасевритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-releasewriteaccess) .</span><span class="sxs-lookup"><span data-stu-id="8b77b-122">The writer must then call [**IDirectWriterLock::ReleaseWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-releasewriteaccess) to release the storage.</span></span>

<span data-ttu-id="8b77b-123">Вызов [**идиректвритерлокк:: ваитфорвритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) требуется перед записью в этом режиме с одним чтением, несколькими модулями записи.</span><span class="sxs-lookup"><span data-stu-id="8b77b-123">The call to [**IDirectWriterLock::WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) is required before writing in this single-reader, multiple-writer mode.</span></span> <span data-ttu-id="8b77b-124">Пытается выполнить запись в файл без вызова **идиректвритерлокк:: ваитфорвритеакцесс** первый результат в STG \_ E \_ ACCESSDENIED.</span><span class="sxs-lookup"><span data-stu-id="8b77b-124">Attempts to write to the file without calling **IDirectWriterLock::WaitForWriteAccess** first result in STG\_E\_ACCESSDENIED.</span></span> <span data-ttu-id="8b77b-125">Эта ошибка возвращается даже в том случае, если модуль записи открыл файл изначально и ни один из читателей не открыл файл.</span><span class="sxs-lookup"><span data-stu-id="8b77b-125">This error is returned even if the writer opened the file initially, and no readers currently have the file open.</span></span>

## <a name="marshaling-considerations"></a><span data-ttu-id="8b77b-126">Рекомендации по упаковке</span><span class="sxs-lookup"><span data-stu-id="8b77b-126">Marshaling Considerations</span></span>

<span data-ttu-id="8b77b-127">Настраиваемая упаковка обычно используется, когда составной файл маршалируется в другой процесс на том же компьютере.</span><span class="sxs-lookup"><span data-stu-id="8b77b-127">Custom marshaling is typically used when a compound file is marshaled to another process on the same machine.</span></span> <span data-ttu-id="8b77b-128">При упаковке хранилищ, права доступа не учитываются, а указатель [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) передается в новый процесс с теми же режимами доступа и правами, что и в исходном процессе упаковки.</span><span class="sxs-lookup"><span data-stu-id="8b77b-128">When marshaling storages, access rights are not considered, and the [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) pointer is passed to the new process with the same access modes and rights as the original marshaling process.</span></span> <span data-ttu-id="8b77b-129">Дополнительные сведения о режимах доступа см. в разделе [**константы стгм**](stgm-constants.md).</span><span class="sxs-lookup"><span data-stu-id="8b77b-129">For more information about access modes, see [**STGM Constants**](stgm-constants.md).</span></span> <span data-ttu-id="8b77b-130">Во время маршалирования никакие блокировки не выполняются или не проверяются, чтобы обеспечить монопольный доступ на запись.</span><span class="sxs-lookup"><span data-stu-id="8b77b-130">During marshaling, no locks are taken or verified to ensure exclusive write access.</span></span> <span data-ttu-id="8b77b-131">В этом случае не применяется политика единого модуля записи для составных файлов, открытых в режиме с одним модулем записи, несколькими модулями чтения.</span><span class="sxs-lookup"><span data-stu-id="8b77b-131">In this case, there is no enforcement of the single-writer policy for compound files opened in the single-writer, multiple-reader mode.</span></span> <span data-ttu-id="8b77b-132">Вместо этого принудительная обработка выполняется внутри реализации составного файла.</span><span class="sxs-lookup"><span data-stu-id="8b77b-132">Instead, enforcement is handled internally by the compound file implementation.</span></span>

<span data-ttu-id="8b77b-133">Поскольку указатель [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) передается в другой процесс во время маршалирования, два процесса могут иметь одновременный доступ к одному и тому же составному файлу.</span><span class="sxs-lookup"><span data-stu-id="8b77b-133">Because the [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) pointer is passed to another process during marshaling, it is possible for two processes to have simultaneous access to the same compound file.</span></span> <span data-ttu-id="8b77b-134">Несмотря на то, что вызывающий объект может получить эксклюзивный доступ на запись к хранилищу путем вызова [**идиректвритерлокк:: ваитфорвритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess), упакованная версия также может иметь доступ одновременно.</span><span class="sxs-lookup"><span data-stu-id="8b77b-134">Even though a caller may have obtained exclusive write access to the storage by calling [**IDirectWriterLock::WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess), the marshaled version can also have access simultaneously.</span></span> <span data-ttu-id="8b77b-135">Упакованные версии не принудительно закрываются, пока один модуль записи обращается к файлу.</span><span class="sxs-lookup"><span data-stu-id="8b77b-135">The marshaled versions are not forced to close while the single writer accesses the file.</span></span> <span data-ttu-id="8b77b-136">В этом случае реализация составного файла выполняет внутреннюю синхронизацию операций записи.</span><span class="sxs-lookup"><span data-stu-id="8b77b-136">In this case, the compound file implementation synchronizes the writes internally.</span></span>

<span data-ttu-id="8b77b-137">Если один модуль записи получает эксклюзивный доступ путем вызова, [**идиректвритерлокк:: ваитфорвритеакцесс**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess), то упакованное хранилище также имеет доступ на запись и не обязательно вызывать **Идиректвритерлокк:: ваитфорвритеакцесс**.</span><span class="sxs-lookup"><span data-stu-id="8b77b-137">If a single writer obtains exclusive access by calling, [**IDirectWriterLock::WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess), the marshaled storage also has write access and does not have to call **IDirectWriterLock::WaitForWriteAccess**.</span></span> <span data-ttu-id="8b77b-138">Оба процесса имеют доступ на запись и синхронизация управляются внутренней реализацией составного файла.</span><span class="sxs-lookup"><span data-stu-id="8b77b-138">Both processes have write access and synchronization is controlled by the internal compound file implementation.</span></span>

## <a name="related-topics"></a><span data-ttu-id="8b77b-139">См. также</span><span class="sxs-lookup"><span data-stu-id="8b77b-139">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="8b77b-140">**идиректвритерлокк**</span><span class="sxs-lookup"><span data-stu-id="8b77b-140">**IDirectWriterLock**</span></span>](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock)
</dt> </dl>

 

 




