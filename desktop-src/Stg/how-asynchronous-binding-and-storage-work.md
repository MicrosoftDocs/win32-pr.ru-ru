---
title: Как работает асинхронная привязка и хранилище
description: Асинхронное хранилище расширяет спецификацию структурированного хранилища COM для поддержки загрузки объектов хранилища в сетях с высокой задержкой, например в Интернете.
ms.assetid: 891152c3-5abd-45e4-a7bb-0aac23262b03
keywords:
- Как работает асинхронная привязка и хранилище
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 626e8c7a55b667e158de42b3c88a17315b5e41ad
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "104413132"
---
# <a name="how-asynchronous-binding-and-storage-work"></a><span data-ttu-id="0527f-104">Как работает асинхронная привязка и хранилище</span><span class="sxs-lookup"><span data-stu-id="0527f-104">How Asynchronous Binding and Storage Work</span></span>

<span data-ttu-id="0527f-105">Асинхронное хранилище расширяет спецификацию структурированного хранилища COM для поддержки загрузки объектов хранилища в сетях с высокой задержкой, например в Интернете.</span><span class="sxs-lookup"><span data-stu-id="0527f-105">Asynchronous storage enhances the COM structured storage specification to support downloading of storage objects on high-latency, slow-link networks such as the Internet.</span></span> <span data-ttu-id="0527f-106">Асинхронное хранилище работает совместно с асинхронными моникерами для обеспечения полного асинхронного поведения привязки.</span><span class="sxs-lookup"><span data-stu-id="0527f-106">Asynchronous storage works together with asynchronous monikers to provide complete asynchronous binding behavior.</span></span>

## <a name="document-object-embedded-in-a-web-page"></a><span data-ttu-id="0527f-107">Объект Document, внедренный в веб-страницу</span><span class="sxs-lookup"><span data-stu-id="0527f-107">Document object embedded in a Web page</span></span>

<span data-ttu-id="0527f-108">Когда пользователь щелкает ссылку, представляющую документ, внедренный в веб-страницу, происходят следующие события.</span><span class="sxs-lookup"><span data-stu-id="0527f-108">When a user clicks a link representing a document embedded in a Web page, the following events occur:</span></span>

1.  <span data-ttu-id="0527f-109">Браузер вызывает функцию [**мкпарседисплайнаме**](/windows/win32/api/objbase/nf-objbase-mkparsedisplayname) , передавая URL-адрес ссылки.</span><span class="sxs-lookup"><span data-stu-id="0527f-109">The browser calls the [**MkParseDisplayName**](/windows/win32/api/objbase/nf-objbase-mkparsedisplayname) function, passing the link URL.</span></span>
2.  <span data-ttu-id="0527f-110">[**Мкпарседисплайнаме**](/windows/win32/api/objbase/nf-objbase-mkparsedisplayname) анализирует URL-адрес, создает соответствующее асинхронное моникерное имя и возвращает указатель на интерфейс [**IMoniker**](/windows/win32/api/objidl/nn-objidl-imoniker) моникера.</span><span class="sxs-lookup"><span data-stu-id="0527f-110">[**MkParseDisplayName**](/windows/win32/api/objbase/nf-objbase-mkparsedisplayname) parses the URL, creates a corresponding asynchronous moniker, and returns a pointer to the moniker's [**IMoniker**](/windows/win32/api/objidl/nn-objidl-imoniker) interface.</span></span>
3.  <span data-ttu-id="0527f-111">Браузер вызывает [**исасинкмоникер**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775110(v=vs.85)) , чтобы определить, является ли моникер асинхронным, создает контекст привязки, регистрирует интерфейс [**метода интерфейса IBindStatusCallback**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775060(v=vs.85)) в контексте привязки, только если моникер является асинхронным, и вызывает [**IMoniker:: биндтубжект**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtoobject), передавая контекст привязки.</span><span class="sxs-lookup"><span data-stu-id="0527f-111">The browser calls [**IsAsyncMoniker**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775110(v=vs.85)) to determine if the moniker is asynchronous, creates a bind context, registers the [**IBindStatusCallback**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775060(v=vs.85)) interface with the bind context, only if the moniker is asynchronous, and calls [**IMoniker::BindToObject**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtoobject), passing the bind context.</span></span>
4.  <span data-ttu-id="0527f-112">Моникер привязывается к объекту и запрашивает его для интерфейса [**иперсистмоникер**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775042(v=vs.85)) , который указывает, поддерживает ли объект асинхронную привязку и хранилище.</span><span class="sxs-lookup"><span data-stu-id="0527f-112">The moniker binds to the object and queries it for the [**IPersistMoniker**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775042(v=vs.85)) interface, which indicates whether the object supports asynchronous binding and storage.</span></span> <span data-ttu-id="0527f-113">Если объект возвращает указатель на **иперсистмоникер**:</span><span class="sxs-lookup"><span data-stu-id="0527f-113">If the object returns a pointer to **IPersistMoniker**:</span></span>

    1.  <span data-ttu-id="0527f-114">Моникер URL вызывает [**иперсистмоникер:: Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775044(v=vs.85)), передавая ему собственный указатель [**IMoniker**](/windows/win32/api/objidl/nn-objidl-imoniker) на объект.</span><span class="sxs-lookup"><span data-stu-id="0527f-114">The URL moniker calls [**IPersistMoniker::Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775044(v=vs.85)), passing its own [**IMoniker**](/windows/win32/api/objidl/nn-objidl-imoniker) pointer to the object.</span></span>
    2.  <span data-ttu-id="0527f-115">Объект изменяет контекст привязки, выбирает, требуется ли блокировка или неблокировка хранилища, регистрирует собственный [**метода интерфейса IBindStatusCallback**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775060(v=vs.85)) и вызывает [**IMoniker:: биндтостораже**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage) в указателе, полученном через [**иперсистмоникер:: Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775044(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="0527f-115">The object modifies the bind context, chooses whether it wants a blocking or nonblocking storage, registers its own [**IBindStatusCallback**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775060(v=vs.85)) and calls [**IMoniker::BindToStorage**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage) on the pointer it received through [**IPersistMoniker::Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775044(v=vs.85)).</span></span>
    3.  <span data-ttu-id="0527f-116">Моникер создает асинхронное хранилище, сохраняет ссылку на интерфейс [**ифилллоккбитес**](/windows/desktop/api/Objidl/nn-objidl-ifilllockbytes) объекта-оболочки, регистрирует интерфейс [**ипрогресснотифи**](/windows/win32/api/objidl/nn-objidl-iprogressnotify) в корневом хранилище и вызывает [**иперсистстораже:: Load**](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load), передавая указатель [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) асинхронного хранилища.</span><span class="sxs-lookup"><span data-stu-id="0527f-116">The moniker creates an asynchronous storage, keeps a reference to the wrapper object's [**IFillLockBytes**](/windows/desktop/api/Objidl/nn-objidl-ifilllockbytes) interface, registers the [**IProgressNotify**](/windows/win32/api/objidl/nn-objidl-iprogressnotify) interface on the root storage, and calls [**IPersistStorage::Load**](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load), passing the asynchronous storage's [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) pointer.</span></span> <span data-ttu-id="0527f-117">По мере поступления данных (в фоновом потоке) моникер вызывает **ифилллоккбитес** для заполнения [**ILockBytes**](/windows/desktop/api/Objidl/nn-objidl-ilockbytes) во временном файле.</span><span class="sxs-lookup"><span data-stu-id="0527f-117">As data arrives (on a background thread) the moniker calls **IFillLockBytes** to fill the [**ILockBytes**](/windows/desktop/api/Objidl/nn-objidl-ilockbytes) on the temp file.</span></span>
    4.  <span data-ttu-id="0527f-118">Объект считывает данные из хранилища и возвращает из [**иперсистмоникер:: Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775044(v=vs.85)) , когда он получает достаточно данных для самостоятельной инициализации.</span><span class="sxs-lookup"><span data-stu-id="0527f-118">The object reads data from the storage and returns from [**IPersistMoniker::Load**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775044(v=vs.85)) when it has received sufficient data to consider itself initialized.</span></span> <span data-ttu-id="0527f-119">Если объект пытается прочитать данные, которые еще не скачаны, загрузчик получает уведомление на [**ипрогресснотифи**](/windows/win32/api/objidl/nn-objidl-iprogressnotify).</span><span class="sxs-lookup"><span data-stu-id="0527f-119">If the object attempts to read data that has not yet been downloaded, the downloader receives a notification on [**IProgressNotify**](/windows/win32/api/objidl/nn-objidl-iprogressnotify).</span></span> <span data-ttu-id="0527f-120">Внутри метода [**ипрогресснотифи:: OnProgress**](/windows/win32/api/objidl/nf-objidl-iprogressnotify-onprogress) поток загрузки либо блокируется в модальном цикле обработки сообщений, либо приводит к тому, что асинхронное хранилище возвращает «е \_ » в ожидании, в зависимости от того, запрашивал ли объект блокирование или неблокировку хранилища.</span><span class="sxs-lookup"><span data-stu-id="0527f-120">Inside the [**IProgressNotify::OnProgress**](/windows/win32/api/objidl/nf-objidl-iprogressnotify-onprogress) method, the downloading thread either blocks in a modal message loop, or causes the asynchronous storage to return E\_PENDING, depending on whether the object has requested a blocking or nonblocking storage.</span></span>

5.  <span data-ttu-id="0527f-121">Если объект не реализует [**иперсистмоникер**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775042(v=vs.85)), моникер запрашивает [**иперсистстораже**](/windows/win32/api/objidl/nn-objidl-ipersiststorage), который указывает, что устойчивое состояние объекта хранится в объекте хранилища.</span><span class="sxs-lookup"><span data-stu-id="0527f-121">If the object does not implement [**IPersistMoniker**](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775042(v=vs.85)), the moniker queries for [**IPersistStorage**](/windows/win32/api/objidl/nn-objidl-ipersiststorage), which indicates that the object's persistent state is stored in a storage object.</span></span> <span data-ttu-id="0527f-122">Если объект возвращает указатель на **иперсистстораже**:</span><span class="sxs-lookup"><span data-stu-id="0527f-122">If the object returns a pointer to **IPersistStorage**:</span></span>

    1.  <span data-ttu-id="0527f-123">Моникер вызывает [**IMoniker:: биндтостораже**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage) на самом себе, запрашивая блокировку [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) (поскольку объект не поддерживает асинхронную передачу), создает асинхронное хранилище, сохраняет ссылку на интерфейс [**ифилллоккбитес**](/windows/desktop/api/Objidl/nn-objidl-ifilllockbytes) объекта-оболочки, регистрирует интерфейс [**Ипрогресснотифи**](/windows/win32/api/objidl/nn-objidl-iprogressnotify) в корневом хранилище и вызывает [**иперсистстораже:: Load**](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load), передавая указатель **IStorage** асинхронного хранилища.</span><span class="sxs-lookup"><span data-stu-id="0527f-123">The Moniker calls [**IMoniker::BindToStorage**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtostorage) on itself, requesting a blocking [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) (because the object is not asynchronous-aware), creates an asynchronous storage, keeps a reference to the wrapper object's [**IFillLockBytes**](/windows/desktop/api/Objidl/nn-objidl-ifilllockbytes) interface, registers the [**IProgressNotify**](/windows/win32/api/objidl/nn-objidl-iprogressnotify) interface on the root storage, and calls [**IPersistStorage::Load**](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load), passing the asynchronous storage's **IStorage** pointer.</span></span> <span data-ttu-id="0527f-124">По мере поступления данных (в фоновом потоке) моникер вызывает [**ифилллоккбитес**](/windows/desktop/api/Objidl/nn-objidl-ifilllockbytes) для заполнения [**ILockBytes**](/windows/desktop/api/Objidl/nn-objidl-ilockbytes) во временном файле.</span><span class="sxs-lookup"><span data-stu-id="0527f-124">As data arrives (on a background thread) the moniker calls [**IFillLockBytes**](/windows/desktop/api/Objidl/nn-objidl-ifilllockbytes) to fill the [**ILockBytes**](/windows/desktop/api/Objidl/nn-objidl-ilockbytes) on the temporary file.</span></span>
    2.  <span data-ttu-id="0527f-125">Объект считывает данные из хранилища и возвращает из [**иперсистстораже:: Load**](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load) , если он получил достаточно данных для самостоятельной инициализации.</span><span class="sxs-lookup"><span data-stu-id="0527f-125">The object reads data from storage and returns from [**IPersistStorage::Load**](/windows/win32/api/objidl/nf-objidl-ipersiststorage-load) when it has received sufficient data to consider itself initialized.</span></span> <span data-ttu-id="0527f-126">Если объект пытается прочитать данные, которые еще не были загружены, он получает уведомление о [**ипрогресснотифи**](/windows/win32/api/objidl/nn-objidl-iprogressnotify).</span><span class="sxs-lookup"><span data-stu-id="0527f-126">If the object attempts to read data that has not yet been downloaded, it receives a notification on [**IProgressNotify**](/windows/win32/api/objidl/nn-objidl-iprogressnotify).</span></span> <span data-ttu-id="0527f-127">Внутри метода [**ипрогресснотифи:: OnProgress**](/windows/win32/api/objidl/nf-objidl-iprogressnotify-onprogress) поток загрузки всегда блокируется в модальном цикле обработки сообщений.</span><span class="sxs-lookup"><span data-stu-id="0527f-127">Inside the [**IProgressNotify::OnProgress**](/windows/win32/api/objidl/nf-objidl-iprogressnotify-onprogress) method, the downloading thread always blocks in a modal message loop.</span></span>

6.  <span data-ttu-id="0527f-128">Независимо от того, является ли загрузка синхронной или асинхронной, моникер возвращает из [**IMoniker:: биндтубжект**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtoobject), и браузер получает инициализированный запрошенный объект.</span><span class="sxs-lookup"><span data-stu-id="0527f-128">Regardless of whether the download is synchronous or asynchronous, the moniker returns from [**IMoniker::BindToObject**](/windows/win32/api/objidl/nf-objidl-imoniker-bindtoobject), and the browser receives the initialized object it requested.</span></span>
7.  <span data-ttu-id="0527f-129">Браузер запрашивает [**иолеобжект**](/windows/win32/api/oleidl/nn-oleidl-ioleobject) и размещает объект как объект документа.</span><span class="sxs-lookup"><span data-stu-id="0527f-129">The browser queries for [**IOleObject**](/windows/win32/api/oleidl/nn-oleidl-ioleobject) and hosts the object as a Document Object.</span></span> <span data-ttu-id="0527f-130">(На этом этапе объект может быть инициализирован не полностью, но достаточно для того, чтобы он отображал что-нибудь полезное, в этом случае скачивание продолжится в фоновом режиме.)</span><span class="sxs-lookup"><span data-stu-id="0527f-130">(At this point the object may not be initialized completely, but enough to display something useful, in which case downloading continues in the background.)</span></span>

 

 