---
description: В этом разделе приводятся общие сведения о потоковой модели с прямым управлением, способах обработки оконных сообщений путем непосредственной обработки и о том, как состояние окна просмотра изменяется в качестве входных данных, сопоставленных с выходными движениями.
ms.assetid: 0818E34E-990E-4C36-9954-EF87EB226AF6
title: Обработка входных данных с помощью Директманипулатион
ms.topic: article
ms.date: 02/03/2020
ms.openlocfilehash: 284a0a1866a2082e2c34c65de347b0dcdfab3a64
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "105719236"
---
# <a name="processing-input-with-directmanipulation"></a><span data-ttu-id="d0158-103">Обработка входных данных с помощью Директманипулатион</span><span class="sxs-lookup"><span data-stu-id="d0158-103">Processing input with DirectManipulation</span></span>

<span data-ttu-id="d0158-104">В этом разделе приводятся общие сведения о потоковой модели с [прямым](direct-manipulation-portal.md) управлением, способах обработки оконных сообщений путем непосредственной обработки и о том, как состояние окна просмотра изменяется в качестве входных данных, сопоставленных с выходными движениями.</span><span class="sxs-lookup"><span data-stu-id="d0158-104">This section provides an overview of the [Direct Manipulation](direct-manipulation-portal.md) threading model, how window messages are processed by Direct Manipulation, and how the state of a viewport changes as input is mapped to output motions.</span></span>

- [<span data-ttu-id="d0158-105">Поток ввода</span><span class="sxs-lookup"><span data-stu-id="d0158-105">Input flow</span></span>](#input-flow)
- [<span data-ttu-id="d0158-106">Замечания</span><span class="sxs-lookup"><span data-stu-id="d0158-106">Remarks</span></span>](#remarks)

<span data-ttu-id="d0158-107">При [непосредственной манипуляции](direct-manipulation-portal.md) для координации асинхронных операций используются два потока:</span><span class="sxs-lookup"><span data-stu-id="d0158-107">[Direct Manipulation](direct-manipulation-portal.md) uses two threads to coordinate asynchronous operations:</span></span>

<span data-ttu-id="d0158-108">*Поток пользовательского интерфейса* — это поток, которому принадлежит **HWND** , связанный с входными данными.</span><span class="sxs-lookup"><span data-stu-id="d0158-108">*UI thread* - the thread that owns the **HWND** associated with input.</span></span> <span data-ttu-id="d0158-109">Этот поток владеет принадлежащей инициализации [непосредственной манипуляции](direct-manipulation-portal.md).</span><span class="sxs-lookup"><span data-stu-id="d0158-109">This thread owns initialization of [Direct Manipulation](direct-manipulation-portal.md).</span></span> <span data-ttu-id="d0158-110">Обработка ввода с помощью мыши и клавиатуры также происходит в потоке пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="d0158-110">Mouse and keyboard input processing also happens on the UI thread.</span></span>

<span data-ttu-id="d0158-111">*Поток делегата* — это поток, созданный и принадлежащий [непосредственной манипуляции](direct-manipulation-portal.md).</span><span class="sxs-lookup"><span data-stu-id="d0158-111">*Delegate thread* - the thread created and owned by [Direct Manipulation](direct-manipulation-portal.md).</span></span> <span data-ttu-id="d0158-112">Обработка входных данных сенсорного ввода происходит в потоке делегата.</span><span class="sxs-lookup"><span data-stu-id="d0158-112">Touch input processing happens on the delegate thread.</span></span>

## <a name="input-flow"></a><span data-ttu-id="d0158-113">Поток ввода</span><span class="sxs-lookup"><span data-stu-id="d0158-113">Input flow</span></span>

<span data-ttu-id="d0158-114">В типичной конфигурации, в которой проверка попадания выполняется в потоке пользовательского интерфейса, сообщения окон обрабатываются путем [непосредственной манипуляции](direct-manipulation-portal.md) в следующем порядке:</span><span class="sxs-lookup"><span data-stu-id="d0158-114">In a typical configuration where hit testing is done on the UI thread, window messages are processed by [Direct Manipulation](direct-manipulation-portal.md) in the following order:</span></span>

![Схема, показывающая порядок обработки сообщений.](images/inputprocessing.png)

<span data-ttu-id="d0158-116">Для окна просмотра неактивных:</span><span class="sxs-lookup"><span data-stu-id="d0158-116">For a viewport at rest:</span></span>

1. <span data-ttu-id="d0158-117">Ряд оконных сообщений достигает потока делегата.</span><span class="sxs-lookup"><span data-stu-id="d0158-117">A series of window messages reach the delegate thread.</span></span>
2. <span data-ttu-id="d0158-118">[WM_POINTERDOWN](../inputmsg/wm-pointerdown.md) и [DM_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) сообщения отправляются потоком делегата в поток независимого теста попаданий (ИХТ).</span><span class="sxs-lookup"><span data-stu-id="d0158-118">[WM_POINTERDOWN](../inputmsg/wm-pointerdown.md) and [DM_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) messages are sent by the delegate thread to the Independent Hit Test (IHT) thread.</span></span>
3. <span data-ttu-id="d0158-119">Если [**сетконтакт**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) вызывается из потока ИХТ, сообщения могут отправляться в поток пользовательского интерфейса потоком делегата, в зависимости от значения [**директманипулатион \_ HITTEST \_ Type**](/windows/win32/api/directmanipulation/ne-directmanipulation-directmanipulation_hittest_type) при вызове [**регистерхиттесттаржет**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationmanager-registerhittesttarget) .</span><span class="sxs-lookup"><span data-stu-id="d0158-119">If [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) is called from the IHT thread, messages might get sent to the UI thread by the delegate thread, depending on the value of [**DIRECTMANIPULATION\_HITTEST\_TYPE**](/windows/win32/api/directmanipulation/ne-directmanipulation-directmanipulation_hittest_type) when [**RegisterHitTestTarget**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationmanager-registerhittesttarget) was called.</span></span>
4. <span data-ttu-id="d0158-120">Если [**сетконтакт**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) не вызывается из потока ИХТ, то сообщения всегда отправляются потоком делегата в поток пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="d0158-120">If [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) is not called from the IHT thread, messages are always sent by the delegate thread to the UI thread.</span></span>
5. <span data-ttu-id="d0158-121">Клиент может вызвать [**сетконтакт**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) из потока пользовательского интерфейса, чтобы позволить [прямой манипуляции](direct-manipulation-portal.md) обнаруживать манипуляцию.</span><span class="sxs-lookup"><span data-stu-id="d0158-121">The client can call [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) from the UI thread to let [Direct Manipulation](direct-manipulation-portal.md) detect a manipulation.</span></span>
6. <span data-ttu-id="d0158-122">При обнаружении манипуляции [Непосредственная манипуляция](direct-manipulation-portal.md) отправляет сообщение [WM/_POINTERCAPTURECHANGED](../inputmsg/wm-pointercapturechanged.md) для уведомления клиента о том, что входные данные обрабатываются посредством непосредственной манипуляции.</span><span class="sxs-lookup"><span data-stu-id="d0158-122">If a manipulation is detected, [Direct Manipulation](direct-manipulation-portal.md) sends a [WM/_POINTERCAPTURECHANGED](../inputmsg/wm-pointercapturechanged.md) message to notify the client that the input is being handled by Direct Manipulation.</span></span> <span data-ttu-id="d0158-123">Для окна просмотра задано состояние **выполняется** и преобразование выходных данных будет обновлено.</span><span class="sxs-lookup"><span data-stu-id="d0158-123">The viewport status is set to **RUNNING** and the output transform will be updated.</span></span>
7. <span data-ttu-id="d0158-124">Если обнаруживается взаимодействие, не связанное с манипуляцией, [Непосредственная манипуляция](direct-manipulation-portal.md) отправляет оставшиеся сообщения в поток пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="d0158-124">If an interaction other than a manipulation is detected, [Direct Manipulation](direct-manipulation-portal.md) sends remaining messages to the UI thread.</span></span>

<span data-ttu-id="d0158-125">Для окна просмотра в движении (с состоянием "выполняется" или "ИНЕРЦИя") сообщение окна достигает потока делегата, где тесты нажатия [прямых манипуляций](direct-manipulation-portal.md) выполняются для всех работающих окон просмотра.</span><span class="sxs-lookup"><span data-stu-id="d0158-125">For a viewport in motion (with a status of RUNNING or INERTIA), the window message reaches the delegate thread first, where [Direct Manipulation](direct-manipulation-portal.md) hit tests against all running viewports.</span></span> <span data-ttu-id="d0158-126">При непосредственной манипуляции контакт автоматически назначается соответствующим окнам просмотра, определенным при проверке нажатия.</span><span class="sxs-lookup"><span data-stu-id="d0158-126">Direct Manipulation automatically assigns the contact to the appropriate viewports identified by hit testing.</span></span> <span data-ttu-id="d0158-127">Состояние окна просмотра — "выполняется", а преобразование "выход" будет обновлено.</span><span class="sxs-lookup"><span data-stu-id="d0158-127">The viewport status is RUNNING and the output transform will be updated.</span></span>

<span data-ttu-id="d0158-128">В некоторых случаях поток пользовательского интерфейса приложения может оказаться слишком медленным для реагирования на проверку попадания.</span><span class="sxs-lookup"><span data-stu-id="d0158-128">In some cases, an application UI thread may be too slow to respond to hit testing.</span></span> <span data-ttu-id="d0158-129">Можно использовать поток проверки нажатия ([**регистерхиттесттаржет**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationmanager-registerhittesttarget)), чтобы позволить клиенту перемещать сообщения [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) и [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) в конкретный поток, чтобы разрешить проверку попадания.</span><span class="sxs-lookup"><span data-stu-id="d0158-129">A hit test thread may be used ([**RegisterHitTestTarget**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationmanager-registerhittesttarget)) to allow the client to move [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) and [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) messages to a specific thread to allow for hit testing.</span></span>

## <a name="remarks"></a><span data-ttu-id="d0158-130">Комментарии</span><span class="sxs-lookup"><span data-stu-id="d0158-130">Remarks</span></span>

<span data-ttu-id="d0158-131">Как правило, [Непосредственная манипуляция](direct-manipulation-portal.md) отправляет сообщения [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) и [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) в поток пользовательского интерфейса, задерживая последующие сообщения при ожидании ответа от клиента.</span><span class="sxs-lookup"><span data-stu-id="d0158-131">Typically, [Direct Manipulation](direct-manipulation-portal.md) sends only [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) and [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) messages to the UI thread, withholding later messages while waiting for a response from the client.</span></span> <span data-ttu-id="d0158-132">Если клиент вызывает [**сетконтакт**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact), то только сообщения, получаемые ПОТОКОМ пользовательского интерфейса при обнаружении манипуляции, — это [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) и [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md), а также [сообщение WM/_POINTERCAPTURECHANGED](../inputmsg/wm-pointercapturechanged.md).</span><span class="sxs-lookup"><span data-stu-id="d0158-132">If the client calls [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact), the only messages the UI thread receives when a manipulation is detected are [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) and [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md), and [WM/_POINTERCAPTURECHANGED message](../inputmsg/wm-pointercapturechanged.md).</span></span>

<span data-ttu-id="d0158-133">Клиент может не вызывать [**сетконтакт**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) при обработке сообщений [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) и [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) .</span><span class="sxs-lookup"><span data-stu-id="d0158-133">The client might not call [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) when processing [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) and [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) messages.</span></span> <span data-ttu-id="d0158-134">В этом случае [Непосредственная манипуляция](direct-manipulation-portal.md) отправляет все сообщения в поток пользовательского интерфейса без анализа сообщений, чтобы проверить, существует ли манипуляция.</span><span class="sxs-lookup"><span data-stu-id="d0158-134">In this case, [Direct Manipulation](direct-manipulation-portal.md) sends all messages to the UI thread without analyzing the messages to see if there is a manipulation.</span></span> <span data-ttu-id="d0158-135">Затем клиент может выбрать любую точку для вызова **сетконтакт** , чтобы начать обнаружение манипуляций и отправить сообщения [WM/_POINTERCAPTURECHANGED](../inputmsg/wm-pointercapturechanged.md) при обнаружении одного.</span><span class="sxs-lookup"><span data-stu-id="d0158-135">The client can then choose any point to call **SetContact** and have Direct Manipulation start detecting manipulations, and send [WM/_POINTERCAPTURECHANGED message](../inputmsg/wm-pointercapturechanged.md) messages when one is detected.</span></span>

<span data-ttu-id="d0158-136">**Windows 10 и более поздние версии:** Вы можете решить, какие манипуляции необходимо обрабатывать, вызвав [**деферконтакт**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationdefercontactservice-defercontact) перед вызовом [**Сетконтакт**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) в сообщении [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) или [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) .</span><span class="sxs-lookup"><span data-stu-id="d0158-136">**Windows 10 and later:** You can decide which manipulations you want to handle by calling [**DeferContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationdefercontactservice-defercontact) before calling [**SetContact**](/windows/win32/api/DirectManipulation/nf-directmanipulation-idirectmanipulationviewport-setcontact) on a [WM/_POINTERDOWN](../inputmsg/wm-pointerdown.md) or [DM/_POINTERHITTEST](../inputmsg/dm-pointerhittest.md) message.</span></span> <span data-ttu-id="d0158-137">**Деферконтакт** гарантирует, что все последующие сообщения отправляются в поток пользовательского интерфейса в течение указанного периода времени.</span><span class="sxs-lookup"><span data-stu-id="d0158-137">**DeferContact** ensures all subsequent messages are sent to the UI thread for the specified period of time.</span></span>
