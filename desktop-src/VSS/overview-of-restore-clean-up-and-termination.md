---
description: После восстановления средства записи проверяют состояние операции, чтобы можно было использовать восстановленные данные и обрабатывать ошибки.
ms.assetid: f9def67a-c4ea-4014-929f-51fbd10d770a
title: Общие сведения о сбросе и завершении восстановления
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 391e029cdb109589b42240b5482f6aba2ff43555
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104080620"
---
# <a name="overview-of-restore-clean-up-and-termination"></a><span data-ttu-id="236f8-103">Общие сведения о сбросе и завершении восстановления</span><span class="sxs-lookup"><span data-stu-id="236f8-103">Overview of Restore Clean up and Termination</span></span>

<span data-ttu-id="236f8-104">После восстановления средства записи проверяют состояние операции, чтобы можно было использовать восстановленные данные и обрабатывать ошибки.</span><span class="sxs-lookup"><span data-stu-id="236f8-104">Following a restore, writers check the status of the operation so that they can make use of the restored data and deal with errors.</span></span> <span data-ttu-id="236f8-105">Инициатор запроса должен дождаться завершения этого действия.</span><span class="sxs-lookup"><span data-stu-id="236f8-105">The requester must wait for the completion of this activity.</span></span> <span data-ttu-id="236f8-106">Дополнительные сведения см. в разделе Общие сведения об [обработке восстановления в VSS](overview-of-processing-a-restore-under-vss.md).</span><span class="sxs-lookup"><span data-stu-id="236f8-106">For more information, see [Overview of Processing a Restore Under VSS](overview-of-processing-a-restore-under-vss.md).</span></span>

<span data-ttu-id="236f8-107">В следующей таблице показана последовательность действий и событий, необходимых после выполнения операции восстановления.</span><span class="sxs-lookup"><span data-stu-id="236f8-107">The following table shows the sequence of actions and events that are required after a restore operation has taken place.</span></span>



| <span data-ttu-id="236f8-108">Действие запросившего</span><span class="sxs-lookup"><span data-stu-id="236f8-108">Requester action</span></span>                                                                                                                                                                                                                                                                                                                                                              | <span data-ttu-id="236f8-109">Событие</span><span class="sxs-lookup"><span data-stu-id="236f8-109">Event</span></span>                                                           | <span data-ttu-id="236f8-110">Действие записи</span><span class="sxs-lookup"><span data-stu-id="236f8-110">Writer action</span></span>                                                                                                                                                                                                                                      |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="236f8-111">Инициатор запроса указывает на окончание восстановления (см. раздел [**ивссбаккупкомпонентс::P остресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore)).</span><span class="sxs-lookup"><span data-stu-id="236f8-111">The requester indicates the end of the restore (see [**IVssBackupComponents::PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore)).</span></span>                                                                                                                                                                                                                                           | [<span data-ttu-id="236f8-112">*Восстановление после восстановления*</span><span class="sxs-lookup"><span data-stu-id="236f8-112">*PostRestore*</span></span>](vssgloss-p.md) | <span data-ttu-id="236f8-113">Модуль записи выполняет очистку после восстановления и обрабатывает сбои восстановления и файлы, восстановленные в нестандартном расположении (см. раздел [**квссвритер:: онпостресторе**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore), [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent)).</span><span class="sxs-lookup"><span data-stu-id="236f8-113">The writer conducts post-restore cleanup, and handles restoration failures and files that have been restored to nonstandard locations (see [**CVssWriter::OnPostRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore), [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent)).</span></span> |
| <span data-ttu-id="236f8-114">Инициатор запроса ждет, пока модули записи не обрабатывали [**событие**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) [**ивссасинк**](/windows/desktop/api/Vss/nn-vss-ivssasync).</span><span class="sxs-lookup"><span data-stu-id="236f8-114">The requester waits on writers to handle the [**PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) event with [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync).</span></span> <span data-ttu-id="236f8-115">Он также должен проверить состояние модуля записи (см. раздел [**ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**Ивссбаккупкомпонентс:: жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)).</span><span class="sxs-lookup"><span data-stu-id="236f8-115">It should also verify writer status (see [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)).</span></span> | <span data-ttu-id="236f8-116">Нет</span><span class="sxs-lookup"><span data-stu-id="236f8-116">None</span></span>                                                            | <span data-ttu-id="236f8-117">Нет</span><span class="sxs-lookup"><span data-stu-id="236f8-117">None</span></span>                                                                                                                                                                                                                                               |
| <span data-ttu-id="236f8-118">Инициатор запроса освобождает интерфейс [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) .</span><span class="sxs-lookup"><span data-stu-id="236f8-118">The requester releases the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface.</span></span>                                                                                                                                                                                                                                                                                    | <span data-ttu-id="236f8-119">Нет</span><span class="sxs-lookup"><span data-stu-id="236f8-119">None</span></span>                                                            | <span data-ttu-id="236f8-120">Нет</span><span class="sxs-lookup"><span data-stu-id="236f8-120">None</span></span>                                                                                                                                                                                                                                               |



 

## <a name="requester-actions-during-cleanup-and-termination"></a><span data-ttu-id="236f8-121">Действия запросившего во время очистки и завершения</span><span class="sxs-lookup"><span data-stu-id="236f8-121">Requester Actions during Cleanup and Termination</span></span>

<span data-ttu-id="236f8-122">На этом этапе инициатор запроса указывает на завершение действий по восстановлению файла путем создания события [*восстановления*](vssgloss-p.md) путем вызова [**Ивссбаккупкомпонентс::P остресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore).</span><span class="sxs-lookup"><span data-stu-id="236f8-122">At this point, a requester indicates the end of its file restoration activities by generating a [*PostRestore*](vssgloss-p.md) event by calling [**IVssBackupComponents::PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore).</span></span>

<span data-ttu-id="236f8-123">Действия запросившего ограничены модулями записи, для которых может потребоваться выполнение некоторой финальной очистки и обработка ошибок восстановления, а также освобождение интерфейса [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) после того, как все модули записи будут возвращены после обработки события, выполняемого методом [*RESTORE*](vssgloss-p.md) .</span><span class="sxs-lookup"><span data-stu-id="236f8-123">The requester's actions are limited to waiting on the writers, which may need to perform some final cleanup and handle restore errors, and releasing the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface after all writers have returned from handling the [*PostRestore*](vssgloss-p.md) event.</span></span>

## <a name="writer-actions-during-cleanup-and-termination"></a><span data-ttu-id="236f8-124">Действия модуля записи во время очистки и завершения</span><span class="sxs-lookup"><span data-stu-id="236f8-124">Writer Actions during Cleanup and Termination</span></span>

<span data-ttu-id="236f8-125">Событие [*RESTORE*](vssgloss-p.md) обрабатывается виртуальным методом [**квссвритер:: онпостресторе**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore).</span><span class="sxs-lookup"><span data-stu-id="236f8-125">The [*PostRestore*](vssgloss-p.md) event is handled by the virtual method [**CVssWriter::OnPostRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore).</span></span> <span data-ttu-id="236f8-126">Реализация по умолчанию просто возвращает **значение true** , не принимая никаких действий.</span><span class="sxs-lookup"><span data-stu-id="236f8-126">The default implementation simply returns **true** without taking any action.</span></span> <span data-ttu-id="236f8-127">Если модуль записи должен повысить управляемость ситуации, выполняемой после восстановления, он может переопределить этот метод.</span><span class="sxs-lookup"><span data-stu-id="236f8-127">If a writer needs to exercise more control of the post-restore situation, it can override this method.</span></span>

<span data-ttu-id="236f8-128">Помимо обычной очистки (например, удаления временных файлов), которую модуль записи может выполнять в [**квссвритер:: онпостресторе**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore), он может справиться с успешным или неудачным выполнением операций восстановления.</span><span class="sxs-lookup"><span data-stu-id="236f8-128">In addition to any normal cleanup (such as removing temporary files) that a writer might perform in [**CVssWriter::OnPostRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostrestore), it can handle the success or failure of restore operations.</span></span>

<span data-ttu-id="236f8-129">Как он обрабатывает ошибки восстановления, файлы, восстановленные в альтернативное расположение, и потребность в будущих восстановлениях, совершенно достаточно для пользователя.</span><span class="sxs-lookup"><span data-stu-id="236f8-129">How it handles restore errors, files restored to an alternate location, and the need for future restores are completely at the writer's discretion.</span></span> <span data-ttu-id="236f8-130">Типичные действия могут включать сравнение файлов в альтернативных или новых местах с файлами, используемыми в данный момент, объединением данных из нескольких файлов или запуском новых сеансов, подключенных к новым файлам данных.</span><span class="sxs-lookup"><span data-stu-id="236f8-130">Typical actions might include comparing files in alternate or new locations with files currently in use, merging data from multiple files, or starting new sessions connected to the new data files.</span></span> <span data-ttu-id="236f8-131">Служба VSS предоставляет следующие механизмы для поддержки этого компонента в зависимости от компонента:</span><span class="sxs-lookup"><span data-stu-id="236f8-131">VSS provides the following mechanisms for supporting this on a component-by-component basis:</span></span>

-   <span data-ttu-id="236f8-132">Успех или неудача при восстановлении любого компонента можно найти с помощью [**ивсскомпонент:: жетфилересторестатус**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getfilerestorestatus).</span><span class="sxs-lookup"><span data-stu-id="236f8-132">Success or failure in restoring any component can be found with [**IVssComponent::GetFileRestoreStatus**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getfilerestorestatus).</span></span>
-   <span data-ttu-id="236f8-133">Использование сопоставлений альтернативного расположения в восстановленных файлах будет отмечено [**ивсскомпонент:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span><span class="sxs-lookup"><span data-stu-id="236f8-133">The use of alternate location mappings in restoring files will be indicated by [**IVssComponent::GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span></span>
-   <span data-ttu-id="236f8-134">Определение, является ли восстановление добавочным и потребует дальнейших восстановлений путем вызова [**ивсскомпонент:: жетаддитионалресторес**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getadditionalrestores).</span><span class="sxs-lookup"><span data-stu-id="236f8-134">Determining if a restore is incremental and will require further restores is done by calling [**IVssComponent::GetAdditionalRestores**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getadditionalrestores).</span></span> <span data-ttu-id="236f8-135">Модули записи, которым требуется полное восстановление данных, не должны перезапускаться, пока этот метод не вернет значение false.</span><span class="sxs-lookup"><span data-stu-id="236f8-135">Writers that need a complete restoration of their data should not restart until this method returns false.</span></span>
-   <span data-ttu-id="236f8-136">Модули записи могут определить, нужен ли инициатору запроса для восстановления файлов в ранее неопределенном расположении с помощью [**ивсскомпонент:: жетневтаржеткаунт**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getnewtargetcount) и [**Ивсскомпонент:: жетневтаржет**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getnewtarget)</span><span class="sxs-lookup"><span data-stu-id="236f8-136">Writers can determine if the requester has needed to restore files to a previously unspecified location using [**IVssComponent::GetNewTargetCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getnewtargetcount) and [**IVssComponent::GetNewTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getnewtarget)</span></span>

<span data-ttu-id="236f8-137">(Дополнительные сведения о восстановлении файлов в расположениях, отличных от по умолчанию, см. в разделе [расположения резервного копирования и восстановления не по умолчанию](non-default-backup-and-restore-locations.md).)</span><span class="sxs-lookup"><span data-stu-id="236f8-137">(For more information on restoring files to non-default locations, see [Non-Default Backup and Restore Locations](non-default-backup-and-restore-locations.md).)</span></span>

<span data-ttu-id="236f8-138">Как и для любого метода [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) , сведения, возвращаемые данным экземпляром, применяются к компонентам, [*явным образом включенным*](vssgloss-e.md) для резервного копирования, и к любому из его [*неявного включения*](vssgloss-i.md) для резервного копирования, включая эти подкомпоненты, явно включенные для восстановления инициатором запроса с помощью [**ивссбаккупкомпонентс:: аддресторесубкомпонент**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent) (Дополнительные сведения см. в разделе [Работа с выборкой для восстановления и подкомпонентов](working-with-selectability-for-restore-and-subcomponents.md) .</span><span class="sxs-lookup"><span data-stu-id="236f8-138">As with any [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) method, the information returned by a given instance applies to those components [*explicitly included*](vssgloss-e.md) for backup and any of its [*implicitly included*](vssgloss-i.md) for backup subcomponents, including those subcomponents explicitly included for restore by the requester using [**IVssBackupComponents::AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent) (see [Working with Selectability For Restore and Subcomponents](working-with-selectability-for-restore-and-subcomponents.md) for details).</span></span>

<span data-ttu-id="236f8-139">Поскольку потокам записи требуется доступ к документу компонентов резервного копирования, важно, чтобы инициатор запроса не освободил интерфейс [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) , пока поток не завершит обработку.</span><span class="sxs-lookup"><span data-stu-id="236f8-139">Because the writers will require access to the Backup Components Document, it is important that the requester not release the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface until writers have finished processing.</span></span>

 

 



