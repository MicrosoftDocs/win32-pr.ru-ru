---
description: Набор восстановления — это список всех восстанавливаемых файлов и расположений, в которые они будут восстановлены.
ms.assetid: 3196c26c-3407-4c00-a800-c3497df583e5
title: Создание набора восстановления
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: db3447ba6d258a5f22fff958761abc7ac0e4f27f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692925"
---
# <a name="generating-a-restore-set"></a><span data-ttu-id="86e17-103">Создание набора восстановления</span><span class="sxs-lookup"><span data-stu-id="86e17-103">Generating A Restore Set</span></span>

<span data-ttu-id="86e17-104">Набор восстановления — это список всех восстанавливаемых файлов и расположений, в которые они будут восстановлены.</span><span class="sxs-lookup"><span data-stu-id="86e17-104">A restore set is a list of all files to be restored and the locations to which they will be restored.</span></span>

<span data-ttu-id="86e17-105">Как и при создании списка файлов резервных копий (см. раздел [Создание резервного набора данных](generating-a-backup-set.md)), алгоритм определения восстанавливаемых файлов и их восстановления должен проделать [*экземпляр модуля записи*](vssgloss-w.md) экземпляром модуля записи, а также на уровне отдельных компонентов для каждого экземпляра модуля записи.</span><span class="sxs-lookup"><span data-stu-id="86e17-105">As when generating the backup file list (see [Generating A Backup Set](generating-a-backup-set.md)), an algorithm for determining which files to restore and where to restore them must proceed [*writer instance*](vssgloss-w.md) by writer instance, and on a component-by-component basis for each writer instance.</span></span>

<span data-ttu-id="86e17-106">Необходимо связать каждый файл на носителе резервных копий с управляемым им компонентом.</span><span class="sxs-lookup"><span data-stu-id="86e17-106">It is necessary to associate each file on the backup media with the component that managed it.</span></span> <span data-ttu-id="86e17-107">Также необходимо получить [*метод восстановления*](vssgloss-r.md)управляющего компонента, сведения о [*целевом объекте восстановления*](vssgloss-r.md) файла и [*сопоставлении альтернативного расположения*](vssgloss-a.md) (если они есть).</span><span class="sxs-lookup"><span data-stu-id="86e17-107">It is also necessary to obtain the managing component's [*restore method*](vssgloss-r.md), and the file's [*restore target*](vssgloss-r.md) information, and its [*alternate location mappings*](vssgloss-a.md) (if any).</span></span>

<span data-ttu-id="86e17-108">Для некоторых файлов также могут потребоваться операции с [*частичными файлами*](vssgloss-p.md) или [*направленные целевые объекты*](vssgloss-d.md) для восстановления.</span><span class="sxs-lookup"><span data-stu-id="86e17-108">Some files may also require [*partial files*](vssgloss-p.md) operations or [*directed targets*](vssgloss-d.md) for restore.</span></span>

<span data-ttu-id="86e17-109">Изучив возможность [*выбора компонентов для резервного копирования*](vssgloss-s.md) и [*логических путей*](vssgloss-l.md) (см. раздел [Работа с возможностью выбора и логическими путями](working-with-selectability-and-logical-paths.md)), инициатор запроса может определить структуру компонентов операции резервного копирования, которую планируется восстановить.</span><span class="sxs-lookup"><span data-stu-id="86e17-109">By examining the components' [*selectability for backup*](vssgloss-s.md) and [*logical paths*](vssgloss-l.md) (see [Working with Selectability and Logical Paths](working-with-selectability-and-logical-paths.md)), a requester is able to determine the component structure of the backup operation it is going to restore.</span></span>

<span data-ttu-id="86e17-110">После установки структуры компонентов резервной копии инициатор запроса может получить сведения о [*наборе файлов*](vssgloss-f.md) каждого компонента (спецификация файла, путь и флаг рекурсии).</span><span class="sxs-lookup"><span data-stu-id="86e17-110">With the component structure of the backup established, the requester can get each component's [*file set*](vssgloss-f.md) information (file specification, path, and recursion flag).</span></span> <span data-ttu-id="86e17-111">Затем инициатор запроса может создать набор восстановления.</span><span class="sxs-lookup"><span data-stu-id="86e17-111">A requester can then generate a restore set.</span></span>

<span data-ttu-id="86e17-112">Файлы, требующие [*частичных файлов*](vssgloss-p.md)или [*направленные целевые объекты*](vssgloss-d.md) , предоставляют собственные подробные инструкции по восстановлению (см. раздел [расположения резервных копий и восстановления, не используемые по умолчанию](non-default-backup-and-restore-locations.md)), которые затем можно добавить в набор восстановления.</span><span class="sxs-lookup"><span data-stu-id="86e17-112">Files requiring [*partial files*](vssgloss-p.md), or [*directed targets*](vssgloss-d.md) provide their own detailed restoration instructions (see [Non-Default Backup and Restore Locations](non-default-backup-and-restore-locations.md)), which can then be added to the restore set.</span></span>

<span data-ttu-id="86e17-113">Типичный механизм создания набора восстановления для файлов, не участвующих в операциях с частичными файлами, или [*направленные целевые объекты*](vssgloss-d.md) могут выполняться следующим образом.</span><span class="sxs-lookup"><span data-stu-id="86e17-113">A typical mechanism for generating a restore set for files not involved with partial files operations, or [*directed targets*](vssgloss-d.md) might proceed by doing the following:</span></span>

1.  <span data-ttu-id="86e17-114">Получите список файлов на носителе резервных копий, включая исходные пути.</span><span class="sxs-lookup"><span data-stu-id="86e17-114">Obtain a list of files on the backup media, including their original paths.</span></span>

2.  <span data-ttu-id="86e17-115">Чтобы найти [*класс и компонент модуля записи*](vssgloss-w.md) для каждого файла на носителе резервной копии, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="86e17-115">Identify the [*writer class*](vssgloss-w.md) and component for each file on the backup media by doing the following:</span></span>

    -   <span data-ttu-id="86e17-116">Для каждого модуля записи получите сведения о компоненте ([**ивссвмкомпонент**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent)), вызвав [**ивссексаминевритерметадата::-Component**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) для всех его компонентов.</span><span class="sxs-lookup"><span data-stu-id="86e17-116">For each writer, obtain component information ([**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent)) by calling [**IVssExamineWriterMetadata::GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) on all its components.</span></span>
    -   <span data-ttu-id="86e17-117">Для каждого компонента получите сведения о дескрипторе файла ([**ивссвмфиледеск**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc)) для каждого набора файлов, содержащихся в компоненте (в зависимости от типов данных, содержащихся в компоненте, путем вызова [**ивссвмкомпонент::-File**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile), [**Ивссвмкомпонент:: Жетдатабасефиле**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabasefile)и [**ивссвмкомпонент:: жетдатабаселогфиле**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabaselogfile).</span><span class="sxs-lookup"><span data-stu-id="86e17-117">For each component, obtain file descriptor ([**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc)) information for every set of files the component contains (depending on the types of data the component contains by calling [**IVssWMComponent::GetFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile), [**IVssWMComponent::GetDatabaseFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabasefile), and [**IVssWMComponent::GetDatabaseLogFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabaselogfile).</span></span>
    -   <span data-ttu-id="86e17-118">Сравните имя файла и сведения о пути, возвращаемые сведениями о пути, которые содержатся в дескрипторе файла для каждого набора файлов в компоненте (возвращаемых [**ивссвмфиледеск::**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath) [**Ивссвмфиледеск:: жетфилеспек**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec)и [**ивссвмфиледеск:: жетрекурсиве**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive)) по пути к сохраненным файлам, чтобы определить, является ли файл частью компонента.</span><span class="sxs-lookup"><span data-stu-id="86e17-118">Compare the file's name and path information against that returned by the path information contained in the file descriptor for each set of files in a component (returned by [**IVssWMFiledesc::GetPath**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath), [**IVssWMFiledesc::GetFilespec**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec), and [**IVssWMFiledesc::GetRecursive**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive)) against stored files path information to determine whether the file is part of the component.</span></span>
        > [!Note]  
        > <span data-ttu-id="86e17-119">Следует игнорировать любые сведения о альтернативном расположении в дескрипторе файла, полученном из компонента, найденного в документе метаданных сохраненного модуля записи (то есть [**ивссвмфиледеск:: жеталтернателокатион**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) не возвращает **значение NULL**).</span><span class="sxs-lookup"><span data-stu-id="86e17-119">You should ignore any alternate location information in the file descriptor retrieved from a component found in a stored Writer Metadata Document (that is, [**IVssWMFiledesc::GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) does not return **NULL**).</span></span> <span data-ttu-id="86e17-120">Это альтернативное расположение — [*альтернативный путь*](vssgloss-a.md), который используется только во время резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="86e17-120">This alternate location is the [*alternate path*](vssgloss-a.md), which is used only during backup.</span></span>

         

3.  <span data-ttu-id="86e17-121">Получите дополнительные сведения о сопоставлении для каждого файла на резервном носителе:</span><span class="sxs-lookup"><span data-stu-id="86e17-121">Obtain alternate mapping information for each file on the backup media:</span></span>

    -   <span data-ttu-id="86e17-122">Альтернативные сопоставления файлов хранятся в модуле записи, а не на уровне компонента, и получаются из объекта [**ивссвмфиледеск**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) , возвращаемого [**Ивссексаминевритерметадата:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping).</span><span class="sxs-lookup"><span data-stu-id="86e17-122">Alternate file mappings are stored at the writer, not the component level, and are obtained from the object [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) returned by [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping).</span></span>
    -   <span data-ttu-id="86e17-123">Можно определить, имеет ли определенный файл сопоставление альтернативного расположения, путем проверки пути и имени файла по пути и спецификации файла, которые содержатся в сопоставлении альтернативного расположения, возвращаемом [**ивссексаминевритерметадата:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping), через [**Ивссвмфиледеск:: Multipath**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath), [**Ивссвмфиледеск:: GetFilespec**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec)и [**IVssWMFiledesc:: GetRecursive**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive).</span><span class="sxs-lookup"><span data-stu-id="86e17-123">You can determine if a particular file has an alternate location mapping by checking the file's path and name against the path and file specification contained in the alternate location mapping returned by [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping), via [**IVssWMFiledesc::GetPath**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath), [**IVssWMFiledesc::GetFilespec**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec), and [**IVssWMFiledesc::GetRecursive**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive).</span></span> <span data-ttu-id="86e17-124">(Если во время резервного копирования использовался альтернативный путь, эти сведения должны игнорироваться во время этой проверки при обработке восстановления.)</span><span class="sxs-lookup"><span data-stu-id="86e17-124">(If an alternate path was used during backup, that information should be ignored during this check in processing a restore.)</span></span>
    -   <span data-ttu-id="86e17-125">Если файл и альтернативное расположение сопоставляют дескрипторы файлов, то для поиска альтернативного расположения, в котором можно восстановить файл, используется метод [**ивссвмфиледеск:: жеталтернателокатион**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) объекта [**ивссвмфиледеск**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) , возвращаемого [**ивссексаминевритерметадата:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) .</span><span class="sxs-lookup"><span data-stu-id="86e17-125">If a file and an alternate location mappings file descriptors match, you then use the [**IVssWMFiledesc::GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) method of the [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) object returned by [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) to find the alternate location to which you can restore the file.</span></span>
    -   <span data-ttu-id="86e17-126">Сопоставление альтернативного расположения, полученное таким способом, не обязательно будет соответствовать возвращенному из документа компонентом резервного копирования с помощью [**ивсскомпонент:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span><span class="sxs-lookup"><span data-stu-id="86e17-126">The alternate location mapping obtained in this way will not necessarily agree with that returned from the Backup Components Document by [**IVssComponent::GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span></span> <span data-ttu-id="86e17-127">Значение [**ивссвмфиледеск:: жеталтернателокатион**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) непусто только в том случае, если для файла используется сопоставление альтернативного расположения.</span><span class="sxs-lookup"><span data-stu-id="86e17-127">The [**IVssWMFiledesc::GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) value is nonblank only if the alternate location mapping is used for a file.</span></span>

4.  <span data-ttu-id="86e17-128">С помощью этого файла и сведений о компонентах можно запросить документ с компонентами резервного копирования, чтобы получить сведения о целевых объектах восстановления, параметрах и новых расположениях для восстановления каждого файла.</span><span class="sxs-lookup"><span data-stu-id="86e17-128">With this file and component information, the Backup Components Document can be queried to obtain information about restore targets, options, and new restore locations for each file.</span></span> <span data-ttu-id="86e17-129">Эти сведения можно объединить со списком файлов, компонентов и альтернативных расположений.</span><span class="sxs-lookup"><span data-stu-id="86e17-129">This information can be combined with the list of files, components, and alternate locations.</span></span>

5.  <span data-ttu-id="86e17-130">Файлы, не защищенные модулями записи, можно выбирать способом, согласованным с традиционными операциями восстановления.</span><span class="sxs-lookup"><span data-stu-id="86e17-130">Files not protected by writers can be selected in a manner consistent with traditional restore operations.</span></span>

<span data-ttu-id="86e17-131">На этом этапе инициатору запроса должен быть предоставлен список всех файлов, необходимых для восстановления, а также инструкции по их восстановлению, а также можно начинать восстановление файлов на основе:</span><span class="sxs-lookup"><span data-stu-id="86e17-131">At this point, a requester should have a list of all the files it needs to restore, along with instructions about how to restore them, and can begin restoring files on the basis of:</span></span>

-   <span data-ttu-id="86e17-132">Следует ли использовать сопоставление альтернативного расположения или расположение исходного файла в качестве целевого объекта для восстановления, зависит от наличия или отсутствия файла в этом целевом расположении и настроек компонентов [**\_ \_ целевого объекта восстановления VSS**](/windows/desktop/api/VsWriter/ne-vswriter-vss_restore_target) и [**\_ \_ перечислений Ресторемесод VSS**](/windows/desktop/api/VsWriter/ne-vswriter-vss_restoremethod_enum) (см. раздел [расположения резервных копий и восстановления, отличные от используемых по умолчанию](non-default-backup-and-restore-locations.md)).</span><span class="sxs-lookup"><span data-stu-id="86e17-132">Whether alternate location mappings, or the original file location is to be used as the target for the restore will depend on the presence or absence of a file at that target location and component settings of [**VSS\_RESTORE\_TARGET**](/windows/desktop/api/VsWriter/ne-vswriter-vss_restore_target) and [**VSS\_RESTOREMETHOD\_ENUM**](/windows/desktop/api/VsWriter/ne-vswriter-vss_restoremethod_enum) (see [Non-Default Backup and Restore Locations](non-default-backup-and-restore-locations.md)).</span></span>
-   <span data-ttu-id="86e17-133">Возможность выполнения попытки восстановления будет зависеть от таких проблем, как разрешения на доступ к целевой системе, если целевые файлы заблокированы и другие обычные проблемы, связанные с восстановлением файлов.</span><span class="sxs-lookup"><span data-stu-id="86e17-133">Whether an attempt at restoration succeeds will depend on issues such as the access permissions of the target, if target files are locked, and other conventional issues involved in file restoration.</span></span>
-   <span data-ttu-id="86e17-134">Успешное или неуспешное выполнение восстановления данного компонента для данного экземпляра модуля записи должно быть сохранено в документе компоненты резервного копирования путем вызова [**ивссбаккупкомпонентс:: сетфилересторестатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setfilerestorestatus).</span><span class="sxs-lookup"><span data-stu-id="86e17-134">The success or failure of restoring a given component for a given writer instance should be preserved in the Backup Components Document by calling [**IVssBackupComponents::SetFileRestoreStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setfilerestorestatus).</span></span> <span data-ttu-id="86e17-135">Это сделает эту информацию доступной для модулей записи при обработке события повторного восстановления.</span><span class="sxs-lookup"><span data-stu-id="86e17-135">This will make the information accessible to writers when they process the PostRestore event.</span></span>
-   <span data-ttu-id="86e17-136">Если файл восстанавливается в сопоставление с альтернативным расположением, инициатор запроса должен вызвать [**ивссбаккупкомпонентс:: аддалтернативелокатионмаппинг**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addalternativelocationmapping).</span><span class="sxs-lookup"><span data-stu-id="86e17-136">If a file is restored to an alternate location mapping, the requester must call [**IVssBackupComponents::AddAlternativeLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addalternativelocationmapping).</span></span> <span data-ttu-id="86e17-137">Это позволит модулям записи определить, восстановлены ли файлы в альтернативных расположениях с помощью [**ивсскомпонент:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span><span class="sxs-lookup"><span data-stu-id="86e17-137">This will allow writers to determine whether their files have been restored to alternate locations through the [**IVssComponent::GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span></span>
-   <span data-ttu-id="86e17-138">Инициаторы запроса могут попытаться восстановить файлы в совершенно новые места.</span><span class="sxs-lookup"><span data-stu-id="86e17-138">Requesters may find it desirable to restore files to completely new locations.</span></span> <span data-ttu-id="86e17-139">Это допустимо, но инициатор запроса должен указать это значение для модуля записи с помощью метода [**ивссбаккупкомпонентс:: аддневтаржет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addnewtarget) .</span><span class="sxs-lookup"><span data-stu-id="86e17-139">This is acceptable, but the requester must indicate this to the writer by using the [**IVssBackupComponents::AddNewTarget**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addnewtarget) method.</span></span>

 

 



