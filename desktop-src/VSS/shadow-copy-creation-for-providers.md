---
description: Создание теневых копий для поставщиков
ms.assetid: d5042945-ba81-40d0-b204-1f08d153a788
title: Создание теневых копий для поставщиков
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91cc7306e7a13ef8e96ab032016a922411a70f95
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104080616"
---
# <a name="shadow-copy-creation-for-providers"></a><span data-ttu-id="3c48a-103">Создание теневых копий для поставщиков</span><span class="sxs-lookup"><span data-stu-id="3c48a-103">Shadow Copy Creation for Providers</span></span>

## <a name="the-shadow-copy-creation-process"></a><span data-ttu-id="3c48a-104">Процесс создания теневой копии</span><span class="sxs-lookup"><span data-stu-id="3c48a-104">The Shadow Copy Creation Process</span></span>

<span data-ttu-id="3c48a-105">Инициатор запроса — это приложение, которое инициирует запрос на создание теневой копии.</span><span class="sxs-lookup"><span data-stu-id="3c48a-105">A requester is the application that initiates the request to create a shadow copy.</span></span> <span data-ttu-id="3c48a-106">Как правило, инициатор запроса является приложением резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="3c48a-106">Typically the requester is a backup application.</span></span> <span data-ttu-id="3c48a-107">При необходимости служба VSS будет вызывать задействованные поставщики.</span><span class="sxs-lookup"><span data-stu-id="3c48a-107">As necessary, VSS will call the providers involved.</span></span> <span data-ttu-id="3c48a-108">Большинство поставщиков заинтересованы в трех конкретных запросах от инициатора запроса.</span><span class="sxs-lookup"><span data-stu-id="3c48a-108">Most providers are interested in three specific requests from the requester.</span></span>

1.  <span data-ttu-id="3c48a-109">Инициатор запроса начинает действие создания теневого копирования с помощью вызова [**ивссбаккупкомпонентс:: стартснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span><span class="sxs-lookup"><span data-stu-id="3c48a-109">The requester begins the shadow copy creation activity with a call to [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span></span> <span data-ttu-id="3c48a-110">При этом создается идентификатор **GUID** типа **, \_ который** уникальным образом идентифицирует этот набор теневых копий — снапшотсетид.</span><span class="sxs-lookup"><span data-stu-id="3c48a-110">This generates a **GUID** of type **VSS\_ID** that uniquely identifies this specific shadow copy set - the SnapshotSetId.</span></span> <span data-ttu-id="3c48a-111">На этом этапе поставщик не участвует, но Снапшотсетид широко используется во всех последующих шагах.</span><span class="sxs-lookup"><span data-stu-id="3c48a-111">The provider is not involved in this step, but the SnapshotSetId is used extensively in all subsequent steps.</span></span>
2.  <span data-ttu-id="3c48a-112">Для каждого тома, который он хочет включить в этот набор теневых копий, запросивший объект вызывает [**ивссбаккупкомпонентс:: аддтоснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span><span class="sxs-lookup"><span data-stu-id="3c48a-112">For each volume it wishes to include in this shadow copy set, the requester calls [**IVssBackupComponents::AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span></span> <span data-ttu-id="3c48a-113">VSS определяет, какой поставщик будет использоваться для теневого копирования тома.</span><span class="sxs-lookup"><span data-stu-id="3c48a-113">VSS determines which provider will be used to shadow copy the volume.</span></span>
    -   <span data-ttu-id="3c48a-114">В наборе теневых копий может участвовать несколько поставщиков.</span><span class="sxs-lookup"><span data-stu-id="3c48a-114">Multiple providers may participate in a shadow copy set.</span></span> <span data-ttu-id="3c48a-115">Например, если системный том и том данных входят в один и тот же набор теневых копий, то поставщик системы может выступать в качестве поставщика теневого копирования для системного тома, в то время как поставщик оборудования может выступать в качестве поставщика теневого копирования для тома данных.</span><span class="sxs-lookup"><span data-stu-id="3c48a-115">For example, if the system volume and a data volume are part of the same shadow copy set, the system provider may serve as the shadow copy provider for the system volume while a hardware provider may serve as the shadow copy provider for the data volume.</span></span> <span data-ttu-id="3c48a-116">Оба поставщика будут входить в один и тот же набор теневых копий, и пользователь будет ждать одинаковой согласованности на каждом из этих томов.</span><span class="sxs-lookup"><span data-stu-id="3c48a-116">Both providers would be part of the same shadow copy set and the user would expect the same point-in-time consistency across both volumes.</span></span>
    -   <span data-ttu-id="3c48a-117">Чтобы поставщик оборудования был выбран, поставщик оборудования должен поддерживать все LUN, участвующие в указанном томе.</span><span class="sxs-lookup"><span data-stu-id="3c48a-117">For a hardware provider to be selected, the hardware provider must be able to support all LUNs contributing to the specified volume.</span></span>
    -   <span data-ttu-id="3c48a-118">Все зарегистрированные поставщики получают возможность указывать поддержку для данного тома во время создания теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="3c48a-118">All registered providers are given the opportunity to indicate support for a given volume during shadow copy creation.</span></span> <span data-ttu-id="3c48a-119">Если более чем один поставщик указывает на поддержку, служба VSS сначала по умолчанию будет иметь поставщиков оборудования, поставщиков программного обеспечения и, наконец, поставщика системы (если другие поставщики не указывают на поддержку этого тома).</span><span class="sxs-lookup"><span data-stu-id="3c48a-119">If more than one provider indicates support, VSS will first default to hardware providers, then software providers, and finally the system provider (if no other provider indicates support for that volume).</span></span>
    -   <span data-ttu-id="3c48a-120">Инициатор запроса может переопределить этот порядок по умолчанию, явно указав поставщика, который требуется для создания теневой копии.</span><span class="sxs-lookup"><span data-stu-id="3c48a-120">A requester may override this default order by explicitly indicating the provider it requires to create the shadow copy.</span></span>
    -   <span data-ttu-id="3c48a-121">При наличии нескольких поставщиков оборудования, поддерживающих данный том, не существует гарантии того, в каком порядке будут вызываться поставщики оборудования.</span><span class="sxs-lookup"><span data-stu-id="3c48a-121">If there are multiple hardware providers that support a given volume, there is no guarantee to the order in which the hardware providers will be called.</span></span>
3.  <span data-ttu-id="3c48a-122">После одного или нескольких вызовов [**аддтоснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset)инициатор запроса может запросить создание теневой копии с помощью метода [**Ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) .</span><span class="sxs-lookup"><span data-stu-id="3c48a-122">After one or more calls to [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset), the requester can ask for the shadow copy to be created by using the [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) method.</span></span> <span data-ttu-id="3c48a-123">Затем служба VSS работает с системой для создания теневой копии.</span><span class="sxs-lookup"><span data-stu-id="3c48a-123">VSS then works with the system to create the shadow copy.</span></span> <span data-ttu-id="3c48a-124">Метод **доснапшотсет** выполняет эту работу асинхронно, и инициатор запроса может либо опросить, либо дождаться завершения процесса создания теневой копии.</span><span class="sxs-lookup"><span data-stu-id="3c48a-124">The **DoSnapshotSet** method performs this work asynchronously, and the requester can either poll or wait for the shadow copy creation process to complete.</span></span>

<span data-ttu-id="3c48a-125">На этой диаграмме показано взаимодействие между инициатором запроса, службой VSS, поддержкой ядра VSS, всеми вовлеченными модулями записи VSS и поставщиками оборудования VSS.</span><span class="sxs-lookup"><span data-stu-id="3c48a-125">This diagram shows the interactions between the requester, the VSS service, the VSS kernel support, any VSS writers involved, and any VSS hardware providers.</span></span> <span data-ttu-id="3c48a-126">Подробное описание этих взаимодействий см. в описании [процесса создания теневой копии](the-shadow-copy-creation-process.md) .</span><span class="sxs-lookup"><span data-stu-id="3c48a-126">See [The Shadow Copy Creation Process](the-shadow-copy-creation-process.md) for a detailed description of these interactions.</span></span>

![взаимодействие между инициатором запроса, компонентами резервного копирования, модулями записи и поставщиками](images/vssimpl.png)

<span data-ttu-id="3c48a-128">После завершения процесса создания теневой копии инициатор запроса может определить, успешно ли создана теневая копия, и, если нет, определить источник сбоя.</span><span class="sxs-lookup"><span data-stu-id="3c48a-128">When the shadow copy creation process is complete, the requester can determine if the shadow copy creation was successful, and if not, determine the source of the failure.</span></span>

<span data-ttu-id="3c48a-129">Интервал времени между замораживанием и разморозкой приложений для записи должен быть минимальным.</span><span class="sxs-lookup"><span data-stu-id="3c48a-129">The time interval between the freeze and thaw of the writer applications must be minimized.</span></span> <span data-ttu-id="3c48a-130">Поставщик должен асинхронно запускать всю подготовительную работу, связанную с теневой копией (например, поставщик оборудования, использующий плекс, запускающий синхронизацию) в методе [**ивсшардвареснапшотпровидер:: бегинпрепареснапшот**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) , а затем дожидаться завершения в методе [**Ивсспровидеркреатеснапшотсет:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) .</span><span class="sxs-lookup"><span data-stu-id="3c48a-130">Provider must asynchronously start all preparation work related to the shadow copy (such as a hardware provider that uses plexes starting the synchronization) in the [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) method, and then wait for the completions in the [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) method.</span></span>

<span data-ttu-id="3c48a-131">Существуют несколько окон временных ограничений, которые должны следовать поставщикам.</span><span class="sxs-lookup"><span data-stu-id="3c48a-131">There are multiple timing limit windows that providers must follow.</span></span> <span data-ttu-id="3c48a-132">В результате правильно работающие поставщики будут выполнять всю ненужную обработку перед [**ивсспровидеркреатеснапшотсет::P рекоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) и после [**Ивсспровидеркреатеснапшотсет::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots).</span><span class="sxs-lookup"><span data-stu-id="3c48a-132">As a result, well-behaved providers will perform all unnecessary processing before [**IVssProviderCreateSnapshotSet::PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) and after [**IVssProviderCreateSnapshotSet::PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots).</span></span>

<span data-ttu-id="3c48a-133">Набор теневых копий фиксируется при вызове [**доснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) .</span><span class="sxs-lookup"><span data-stu-id="3c48a-133">The shadow copy set is fixed when [**DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) is called.</span></span> <span data-ttu-id="3c48a-134">Дополнительные тома не могут быть добавлены позже, так как дополнительные тома не будут совместно использовать один момент времени.</span><span class="sxs-lookup"><span data-stu-id="3c48a-134">Additional volumes cannot be added later because the additional volumes would not share the same point-in-time.</span></span>

<span data-ttu-id="3c48a-135">В наборе теневых копий имеется ограничение в 64 томов.</span><span class="sxs-lookup"><span data-stu-id="3c48a-135">There is a limit of 64 volumes in the shadow copy set.</span></span> <span data-ttu-id="3c48a-136">Конкретный том может сопоставляться с целым LUN, частью LUN или частями нескольких LUN.</span><span class="sxs-lookup"><span data-stu-id="3c48a-136">A specific volume may map to an entire LUN, a portion of a LUN, or portions of multiple LUNs.</span></span> <span data-ttu-id="3c48a-137">В большинстве конфигураций будет по одному тому на один LUN, хотя произвольные сопоставления возможны.</span><span class="sxs-lookup"><span data-stu-id="3c48a-137">Most configurations will have one volume per LUN, although arbitrary mappings are possible.</span></span>

<span data-ttu-id="3c48a-138">Количество наборов теневых копий или количество наборов теневых копий исходного тома не ограничено.</span><span class="sxs-lookup"><span data-stu-id="3c48a-138">There is no limit on the number of shadow copy sets or the number of shadow copy sets of an original volume.</span></span> <span data-ttu-id="3c48a-139">Поставщик может определять определенные ограничения или динамически ограничиваться исходя из доступных аппаратных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="3c48a-139">A provider may define specific limits, or dynamically limit based on hardware resources available.</span></span>

### <a name="point-in-time-for-writerless-applications"></a><span data-ttu-id="3c48a-140">Приложения, которые не подготовились к моменту времени</span><span class="sxs-lookup"><span data-stu-id="3c48a-140">Point-in-time for Writerless Applications</span></span>

<span data-ttu-id="3c48a-141">VSS включает специальную поддержку, которая определяет определенный момент времени для всех томов в наборе теневых копий.</span><span class="sxs-lookup"><span data-stu-id="3c48a-141">VSS includes special support that defines the point-in-time that is common for all volumes in a shadow copy set.</span></span> <span data-ttu-id="3c48a-142">Поставщикам оборудования не требуется напрямую взаимодействовать с этими технологиями ядра, так как они вызываются как часть обычной обработки фиксации теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="3c48a-142">Hardware providers do not need to directly interface with these kernel technologies, since they are invoked as part of the normal shadow copy commit processing.</span></span> <span data-ttu-id="3c48a-143">Тем не менее полезно понимать механизмы, используемые, поскольку в нем объясняется определение "на момент времени" для приложений без записи (приложений, которые не предоставляли интерфейс модуля записи VSS и поэтому не участвуют в процессе создания теневой копии тома).</span><span class="sxs-lookup"><span data-stu-id="3c48a-143">However, it is useful to understand the mechanisms used because it explains the definition of 'point-in-time' for writerless applications (applications that have not exposed a VSS Writer interface and therefore do not participate in the volume shadow copy creation process.)</span></span>

<span data-ttu-id="3c48a-144">Эта поддержка ядра VSS для общего момента времени распределяется между драйвером VolSnap.sys, файловыми системами и VSS.</span><span class="sxs-lookup"><span data-stu-id="3c48a-144">This VSS kernel support for common point-in-time is distributed between the VolSnap.sys driver, the file systems, and VSS.</span></span>

1.  <span data-ttu-id="3c48a-145">До вызова поддержки ядра VSS служба VSS уже выполняет следующие действия.</span><span class="sxs-lookup"><span data-stu-id="3c48a-145">Before the VSS kernel support is invoked, VSS has already:</span></span>
    1.  <span data-ttu-id="3c48a-146">Определяет, какие тома должны быть включены в теневую копию.</span><span class="sxs-lookup"><span data-stu-id="3c48a-146">Determined which volumes are to be involved in the shadow copy.</span></span>
    2.  <span data-ttu-id="3c48a-147">Определяет, какой поставщик следует использовать на каждом томе.</span><span class="sxs-lookup"><span data-stu-id="3c48a-147">Determined which provider is to be used on each volume.</span></span>
    3.  <span data-ttu-id="3c48a-148">Замороженные приложения, принимающие сообщения о зависании и разморозе.</span><span class="sxs-lookup"><span data-stu-id="3c48a-148">Frozen applications that are accepting freeze/thaw messages.</span></span>
    4.  <span data-ttu-id="3c48a-149">Подготовлены поставщики для теневой копии путем вызова методов [**прекоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="3c48a-149">Prepared the providers for the shadow copy by calling the [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) methods.</span></span> <span data-ttu-id="3c48a-150">Все поставщики теперь ожидают выполнения фактического создания теневой копии.</span><span class="sxs-lookup"><span data-stu-id="3c48a-150">All providers are now waiting to do the actual shadow copy creation.</span></span>
2.  <span data-ttu-id="3c48a-151">Затем создается точка во времени.</span><span class="sxs-lookup"><span data-stu-id="3c48a-151">The point-in-time is then created.</span></span> <span data-ttu-id="3c48a-152">Служба VSS одновременно очищает файловые системы на всех томах, которые должны быть теневыми копиями.</span><span class="sxs-lookup"><span data-stu-id="3c48a-152">VSS concurrently flushes the file systems on all of the volumes that are to be shadow copied.</span></span>
    1.  <span data-ttu-id="3c48a-153">Служба VSS выдает \_ команду ioctl VOLSNAP \_ flush \_ и \_ удерживает \_ запись на каждом томе, который очищает файловые системы.</span><span class="sxs-lookup"><span data-stu-id="3c48a-153">VSS issues an IOCTL\_VOLSNAP\_FLUSH\_AND\_HOLD\_WRITES control command on each volume that flushes the file systems.</span></span> <span data-ttu-id="3c48a-154">Этот запрос IOCTL передается вниз по стеку хранилища в VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="3c48a-154">That IOCTL is passed down the storage stack to VolSnap.sys.</span></span> <span data-ttu-id="3c48a-155">Затем VolSnap.sys сохраняет все операции IRP до шага 4 ниже.</span><span class="sxs-lookup"><span data-stu-id="3c48a-155">VolSnap.sys then holds all write IRPs until step 4 below.</span></span> <span data-ttu-id="3c48a-156">Любая файловая система (например, RAW) без поддержки этого нового IOCTL передает неизвестный запрос IOCTL вниз, где он снова удерживается VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="3c48a-156">Any file system (such as RAW) without support for this new IOCTL passes the unknown IOCTL down—where it is again held by VolSnap.sys.</span></span> <span data-ttu-id="3c48a-157">На томах NTFS диск записи также фиксирует журнал NTFS.</span><span class="sxs-lookup"><span data-stu-id="3c48a-157">On NTFS volumes, the flush also commits the NTFS log.</span></span>
    2.  <span data-ttu-id="3c48a-158">Это приостанавливает все действия с метаданными NTFS/FAT. метаданные файловой системы фиксируются в чистом виде.</span><span class="sxs-lookup"><span data-stu-id="3c48a-158">This suspends all NTFS/FAT metadata activity; the file system metadata is cleanly committed.</span></span>
    3.  <span data-ttu-id="3c48a-159">Мгновенная теневая копия: VolSnap.sys приводит к последующей очереди запросов IRP на все тома, подходящие для теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="3c48a-159">The shadow copy instant: VolSnap.sys causes all subsequent write IRPs to be queued on all of the volumes that are to be shadow copied.</span></span>
    4.  <span data-ttu-id="3c48a-160">VolSnap.sys ожидает завершения всех ожидающих операций записи на тенев скопированных томах.</span><span class="sxs-lookup"><span data-stu-id="3c48a-160">VolSnap.sys waits for all pending writes on the shadow copied volumes to complete.</span></span> <span data-ttu-id="3c48a-161">Теперь тома загруженася с учетом операций записи и были загружена в точно тот же момент на каждом томе.</span><span class="sxs-lookup"><span data-stu-id="3c48a-161">The volumes are now quiescent with respect to writes, and were quiescent at exactly the same moment on each volume.</span></span> <span data-ttu-id="3c48a-162">Нет гарантии на запись в сопоставленные разделы пользователя или записи, выданные между (a) и (b) в файловых системах, которые не реализуют обратный вызов IOCTL (например, RAW).</span><span class="sxs-lookup"><span data-stu-id="3c48a-162">There are no guarantees about writes to user mapped sections or writes issued between (a) and (b) on file systems that do not implement the flush IOCTL (e.g. RAW).</span></span>
3.  <span data-ttu-id="3c48a-163">VSS предписывает каждому поставщику принимать в теневой копии, вызывая методы [**ивсспровидеркреатеснапшотсет:: коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="3c48a-163">VSS instructs each provider to take in the shadow copy by calling the [**IVssProviderCreateSnapshotSet::CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods.</span></span> <span data-ttu-id="3c48a-164">Поставщики должны выполнить все подготовительные действия, чтобы это действие было быстрым.</span><span class="sxs-lookup"><span data-stu-id="3c48a-164">The providers should have all preparation done so that this is a quick operation.</span></span>

    <span data-ttu-id="3c48a-165">Обратите внимание, что система ввода-вывода загружена только во время выполнения этих методов [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="3c48a-165">Note that the I/O system is quiescent only while these [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods are executing.</span></span> <span data-ttu-id="3c48a-166">Если поставщик выполняет синхронизацию исходных и теневых копий, то эту синхронизацию необходимо выполнить до возврата метода **коммитснапшотс** поставщика.</span><span class="sxs-lookup"><span data-stu-id="3c48a-166">If a provider performs any synchronization of the source and shadow copy LUNs, this synchronization must be completed before the provider's **CommitSnapshots** method returns.</span></span> <span data-ttu-id="3c48a-167">Он не может выполняться асинхронно.</span><span class="sxs-lookup"><span data-stu-id="3c48a-167">It cannot be performed asynchronously.</span></span>

4.  <span data-ttu-id="3c48a-168">Сразу после возврата последнего метода [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) поставщика служба VSS освобождает все ожидающие записи IRP (включая IRP, которые блокируют файловые системы по завершении их путей фиксации), вызывая другой IRP, переданный в VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="3c48a-168">Immediately after the last provider's [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) method returns, VSS releases all pending write IRPs (including the IRPs that were blocking the file systems at the conclusion of their commit paths) by invoking another IRP passed to VolSnap.sys.</span></span>
5.  <span data-ttu-id="3c48a-169">Если процесс теневого копирования был успешным, VSS сейчас:</span><span class="sxs-lookup"><span data-stu-id="3c48a-169">If the shadow copy process was successful, then VSS now:</span></span>
    1.  <span data-ttu-id="3c48a-170">Вызывает [**посткоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) для используемых поставщиков.</span><span class="sxs-lookup"><span data-stu-id="3c48a-170">Calls [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) for the providers involved.</span></span>
    2.  <span data-ttu-id="3c48a-171">Вызывает [**квссвритер:: размораживание**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) для задействованных модулей записи.</span><span class="sxs-lookup"><span data-stu-id="3c48a-171">Calls [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) for the writers involved.</span></span>
    3.  <span data-ttu-id="3c48a-172">Информирует инициатор запроса о завершении процесса теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="3c48a-172">Informs the requester that the shadow copy process has completed.</span></span>

<span data-ttu-id="3c48a-173">[**Прекоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)и [**посткоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) являются критически важными.</span><span class="sxs-lookup"><span data-stu-id="3c48a-173">[**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), to [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) are all time critical.</span></span> <span data-ttu-id="3c48a-174">Все операции ввода-вывода в приложениях с модулями записи фиксируются от **прекоммитснапшотс** до **посткоммитснапшотс**; любые задержки влияют на доступность приложения.</span><span class="sxs-lookup"><span data-stu-id="3c48a-174">All I/O from applications with writers is frozen from **PreCommitSnapshots** to **PostCommitSnapshots**; any delays affect application availability.</span></span> <span data-ttu-id="3c48a-175">Все файловые операции ввода-вывода, в том числе операции ввода-вывода в приложении, приостанавливаются во время **коммитснапшотс**.</span><span class="sxs-lookup"><span data-stu-id="3c48a-175">All file I/O, including writerless application I/O, is suspended during **CommitSnapshots**.</span></span>

<span data-ttu-id="3c48a-176">Поставщики должны выполнить всю критическую работу до возврата из [**ендпрепареснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots).</span><span class="sxs-lookup"><span data-stu-id="3c48a-176">Providers should complete all time-critical work prior to returning from [**EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots).</span></span>

-   <span data-ttu-id="3c48a-177">[**Коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) должен возвращаться в течение нескольких секунд.</span><span class="sxs-lookup"><span data-stu-id="3c48a-177">[**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) should be returned within seconds.</span></span> <span data-ttu-id="3c48a-178">Фаза **коммитснапшотс** находится в окне очистки и удерживания.</span><span class="sxs-lookup"><span data-stu-id="3c48a-178">The **CommitSnapshots** phase is located within the Flush and Hold window.</span></span> <span data-ttu-id="3c48a-179">Поддержка ядра VSS отменит очистку и удержание, удерживающие операции ввода-вывода, если последующий выпуск не будет получен в течение 10 секунд, а VSS не завершит процесс создания теневой копии.</span><span class="sxs-lookup"><span data-stu-id="3c48a-179">VSS kernel support will cancel the Flush and Hold that is holding the I/O if the subsequent release is not received within 10 seconds, and VSS will fail the shadow copy creation process.</span></span> <span data-ttu-id="3c48a-180">В системе будут выполняться другие действия, поэтому поставщик не должен полагаться на все 10 секунд.</span><span class="sxs-lookup"><span data-stu-id="3c48a-180">Other activities will be happening on the system, so a provider should not rely on having the full 10 seconds.</span></span> <span data-ttu-id="3c48a-181">Поставщик не должен вызывать API-интерфейсы Win32 во время фиксации, так как многие из них приведут к непредвиденным операциям записи и блокировки.</span><span class="sxs-lookup"><span data-stu-id="3c48a-181">The provider should not call Win32 APIs during commit as many will result in unexpected writes and block.</span></span> <span data-ttu-id="3c48a-182">Если поставщику требуется более нескольких секунд для завершения вызова, возникает большая вероятность того, что произойдет сбой.</span><span class="sxs-lookup"><span data-stu-id="3c48a-182">If the provider takes more than a few seconds to complete the call, there is a high probability that this will fail.</span></span>
-   <span data-ttu-id="3c48a-183">Полная последовательность от [**прекоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) до возврата [**посткоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) сопоставляется с окном между модулями записи, получающими события замораживания и разморозкой.</span><span class="sxs-lookup"><span data-stu-id="3c48a-183">The full sequence from [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) to the return of [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) maps to the window between writers receiving the Freeze and Thaw events.</span></span> <span data-ttu-id="3c48a-184">Значение по умолчанию модуля записи для этого окна составляет 60 секунд, но модуль записи может переопределять этот параметр с меньшим временем ожидания.</span><span class="sxs-lookup"><span data-stu-id="3c48a-184">The writer default for this window is 60 seconds, but a writer may override this value with a smaller timeout.</span></span> <span data-ttu-id="3c48a-185">Например, Microsoft Exchange Server Writer изменяет время ожидания на 20 секунд.</span><span class="sxs-lookup"><span data-stu-id="3c48a-185">For example, the Microsoft Exchange Server writer changes the timeout to 20 seconds.</span></span> <span data-ttu-id="3c48a-186">В этом методе поставщики не должны тратить больше второго или двух.</span><span class="sxs-lookup"><span data-stu-id="3c48a-186">Providers should not spend more than a second or two in this method.</span></span>

<span data-ttu-id="3c48a-187">Во время [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) поставщик должен избегать операций файлового ввода-вывода без подкачки. Такой ввод-вывод имеет очень высокую вероятность взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="3c48a-187">During [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) the provider must avoid any non-paging file I/O; such I/O has a very high probability of deadlocking.</span></span> <span data-ttu-id="3c48a-188">В частности, поставщик не должен синхронно записывать журналы отладки или трассировки.</span><span class="sxs-lookup"><span data-stu-id="3c48a-188">In particular, the provider should not synchronously write any debug or trace logs.</span></span>

 

 



