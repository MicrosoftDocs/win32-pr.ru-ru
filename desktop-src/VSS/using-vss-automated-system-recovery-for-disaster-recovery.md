---
description: Приложение для резервного копирования и восстановления VSS, которое выполняет аварийное восстановление (также называемое восстановлением исходного состояния системы), может использовать средство записи аварийного восстановления (ASR) вместе с среда предустановки Windows (Windows PE) для резервного копирования и восстановления критических томов и других компонентов загрузочного состояния системы. Приложение резервного копирования реализуется как инициатор запроса VSS.
ms.assetid: 13adfd79-f26a-4385-9b59-129d06fa72eb
title: Использование автоматического восстановления системы VSS для аварийного восстановления
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1e31ef8ba223f40928e2422fa92240656f94592d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692391"
---
# <a name="using-vss-automated-system-recovery-for-disaster-recovery"></a><span data-ttu-id="99e38-104">Использование автоматического восстановления системы VSS для аварийного восстановления</span><span class="sxs-lookup"><span data-stu-id="99e38-104">Using VSS Automated System Recovery for Disaster Recovery</span></span>

<span data-ttu-id="99e38-105">Приложение для резервного копирования и восстановления VSS, которое выполняет аварийное восстановление (также называемое восстановлением исходного состояния системы), может использовать средство записи аварийного восстановления (ASR) вместе с среда предустановки Windows (Windows PE) для резервного копирования и восстановления критических томов и других компонентов загрузочного состояния системы.</span><span class="sxs-lookup"><span data-stu-id="99e38-105">A VSS backup-and-recovery application that performs disaster recovery (also called bare-metal recovery) can use the Automated System Recovery (ASR) writer together with Windows Preinstallation Environment (Windows PE) to back up and restore critical volumes and other components of the bootable system state.</span></span> <span data-ttu-id="99e38-106">Приложение резервного копирования реализуется как инициатор запроса VSS.</span><span class="sxs-lookup"><span data-stu-id="99e38-106">The backup application is implemented as a VSS requester.</span></span>

<span data-ttu-id="99e38-107">**Примечание**  .  Приложения, использующие ASR, должны лицензировать Windows PE.</span><span class="sxs-lookup"><span data-stu-id="99e38-107">**Note**  Applications that use ASR must license Windows PE.</span></span>

<span data-ttu-id="99e38-108">**Windows Server 2003 и Windows XP:** ASR не реализован в качестве модуля записи VSS.</span><span class="sxs-lookup"><span data-stu-id="99e38-108">**Windows Server 2003 and Windows XP:** ASR is not implemented as a VSS writer.</span></span>

<span data-ttu-id="99e38-109">Сведения о средствах трассировки, которые можно использовать с ASR, см. в разделе [использование средств трассировки с помощью приложений VSS ASR](using-tracing-tools-with-vss-asr-applications.md).</span><span class="sxs-lookup"><span data-stu-id="99e38-109">For information about tracing tools that you can use with ASR, see [Using Tracing Tools with VSS ASR Applications](using-tracing-tools-with-vss-asr-applications.md).</span></span>

<span data-ttu-id="99e38-110">**В этой статье:**</span><span class="sxs-lookup"><span data-stu-id="99e38-110">**In this article:**</span></span>

-   [<span data-ttu-id="99e38-111">Общие сведения о задачах этапа резервного копирования</span><span class="sxs-lookup"><span data-stu-id="99e38-111">Overview of Backup Phase Tasks</span></span>](#overview-of-backup-phase-tasks)
-   [<span data-ttu-id="99e38-112">Выбор критически важных компонентов для резервного копирования</span><span class="sxs-lookup"><span data-stu-id="99e38-112">Choosing Which Critical Components to Back Up</span></span>](#choosing-which-critical-components-to-back-up)
-   [<span data-ttu-id="99e38-113">Обзор задач этапа восстановления</span><span class="sxs-lookup"><span data-stu-id="99e38-113">Overview of Restore Phase Tasks</span></span>](#overview-of-restore-phase-tasks)
-   [<span data-ttu-id="99e38-114">Исключение всех дисков для тома</span><span class="sxs-lookup"><span data-stu-id="99e38-114">Excluding All Disks for a Volume</span></span>](#excluding-all-disks-for-a-volume)

## <a name="overview-of-backup-phase-tasks"></a><span data-ttu-id="99e38-115">Общие сведения о задачах этапа резервного копирования</span><span class="sxs-lookup"><span data-stu-id="99e38-115">Overview of Backup Phase Tasks</span></span>

<span data-ttu-id="99e38-116">Во время резервного копирования инициатор запроса выполняет следующие действия.</span><span class="sxs-lookup"><span data-stu-id="99e38-116">At backup time, the requester performs the following steps.</span></span>

> [!Note]  
> <span data-ttu-id="99e38-117">Все действия необходимы, если не указано иное.</span><span class="sxs-lookup"><span data-stu-id="99e38-117">All steps are required unless otherwise indicated.</span></span>

 

1.  <span data-ttu-id="99e38-118">Вызовите функцию [**креатевссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) , чтобы создать экземпляр интерфейса [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) и вызвать метод [**ивссбаккупкомпонентс:: инитиализефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) , чтобы инициализировать экземпляр для управления резервной копией.</span><span class="sxs-lookup"><span data-stu-id="99e38-118">Call the [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) function to create an instance of the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface and call the [**IVssBackupComponents::InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) method to initialize the instance to manage a backup.</span></span>
2.  <span data-ttu-id="99e38-119">Вызовите [**ивссбаккупкомпонентс:: SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) , чтобы задать контекст для операции теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="99e38-119">Call [**IVssBackupComponents::SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) to set the context for the shadow copy operation.</span></span>
3.  <span data-ttu-id="99e38-120">Вызовите [**ивссбаккупкомпонентс:: сетбаккупстате**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) , чтобы настроить резервное копирование.</span><span class="sxs-lookup"><span data-stu-id="99e38-120">Call [**IVssBackupComponents::SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) to configure the backup.</span></span> <span data-ttu-id="99e38-121">Задайте для параметра *ббаккупбутаблесистемстате* **значение true** , чтобы указать, что резервная копия будет включать загрузочное состояние системы.</span><span class="sxs-lookup"><span data-stu-id="99e38-121">Set the *bBackupBootableSystemState* parameter to **true** to indicate that the backup will include a bootable system state.</span></span>
4.  <span data-ttu-id="99e38-122">Выберите критически важные компоненты в документе метаданных модуля записи ASR Writer для резервного копирования и вызовите метод [**ивссбаккупкомпонентс:: AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) для каждого из них.</span><span class="sxs-lookup"><span data-stu-id="99e38-122">Choose which critical components in the ASR writer's Writer Metadata Document to back up and call [**IVssBackupComponents::AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) for each of them.</span></span>
5.  <span data-ttu-id="99e38-123">Вызовите метод [**ивссбаккупкомпонентс:: стартснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) , чтобы создать новый пустой набор теневых копий.</span><span class="sxs-lookup"><span data-stu-id="99e38-123">Call [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) to create a new, empty shadow copy set.</span></span>
6.  <span data-ttu-id="99e38-124">Вызовите метод [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) , чтобы инициировать асинхронное обращение с модулями записи.</span><span class="sxs-lookup"><span data-stu-id="99e38-124">Call [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) to initiate asynchronous contact with writers.</span></span>
7.  <span data-ttu-id="99e38-125">Вызовите [**ивссбаккупкомпонентс:: жетвритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) , чтобы получить документ метаданных модуля записи ASR Writer.</span><span class="sxs-lookup"><span data-stu-id="99e38-125">Call [**IVssBackupComponents::GetWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) to retrieve the ASR writer's Writer Metadata Document.</span></span> <span data-ttu-id="99e38-126">Идентификатор модуля записи для модуля записи ASR — BE000CBE-11FE-4426-9C58-531AA6355FC4, а строка имени модуля записи — "ASR Writer".</span><span class="sxs-lookup"><span data-stu-id="99e38-126">The writer ID for the ASR writer is BE000CBE-11FE-4426-9C58-531AA6355FC4, and the writer name string is "ASR Writer".</span></span>
8.  <span data-ttu-id="99e38-127">Вызовите [**ивссексаминевритерметадата:: савеасксмл**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) , чтобы сохранить копию документа метаданных модуля записи ASR Writer.</span><span class="sxs-lookup"><span data-stu-id="99e38-127">Call [**IVssExamineWriterMetadata::SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) to save a copy of the ASR writer's Writer Metadata Document.</span></span>
9.  <span data-ttu-id="99e38-128">Вызовите [**ивссбаккупкомпонентс:: аддтоснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset) для каждого тома, который может участвовать в теневых копиях, чтобы добавить том в набор теневых копий.</span><span class="sxs-lookup"><span data-stu-id="99e38-128">Call [**IVssBackupComponents::AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset) for each volume that can participate in shadow copies to add the volume to the shadow copy set.</span></span>
10. <span data-ttu-id="99e38-129">Вызовите [**ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , чтобы уведомить модули записи о необходимости подготовки к операциям резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="99e38-129">Call [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) to notify writers to prepare for a backup operation.</span></span>
11. <span data-ttu-id="99e38-130">Вызовите [**ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) и [**Ивссбаккупкомпонентс:: Жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) (или [**IVssBackupComponentsEx3:: жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex3-getwriterstatusex)), чтобы проверить состояние модуля записи ASR.</span><span class="sxs-lookup"><span data-stu-id="99e38-130">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) (or [**IVssBackupComponentsEx3::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex3-getwriterstatusex)) to verify the status of the ASR writer.</span></span>
12. <span data-ttu-id="99e38-131">На этом этапе можно запросить сообщения об ошибках, которые были заданы модулем записи в своем методе [**квссвритер:: онпрепаребаккуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) .</span><span class="sxs-lookup"><span data-stu-id="99e38-131">At this point, you can query for failure messages that were set by the writer in its [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method.</span></span> <span data-ttu-id="99e38-132">Пример кода, демонстрирующий просмотр этих сообщений, см. в разделе [**ивсскомпонентекс:: жетпрепарефорбаккупфаилуремсг**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponentex-getprepareforbackupfailuremsg).</span><span class="sxs-lookup"><span data-stu-id="99e38-132">For example code that shows how to view these messages, see [**IVssComponentEx::GetPrepareForBackupFailureMsg**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponentex-getprepareforbackupfailuremsg).</span></span>
13. <span data-ttu-id="99e38-133">Вызовите [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) , чтобы создать теневую копию тома.</span><span class="sxs-lookup"><span data-stu-id="99e38-133">Call [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) to create a volume shadow copy.</span></span>
14. <span data-ttu-id="99e38-134">Вызовите [**ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) и [**Ивссбаккупкомпонентс:: жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) , чтобы проверить состояние модуля записи ASR.</span><span class="sxs-lookup"><span data-stu-id="99e38-134">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) to verify the status of the ASR writer.</span></span>
15. <span data-ttu-id="99e38-135">Создайте резервную копию данных.</span><span class="sxs-lookup"><span data-stu-id="99e38-135">Back up the data.</span></span>
16. <span data-ttu-id="99e38-136">Укажите, завершилась ли операция резервного копирования путем вызова [**ивссбаккупкомпонентс:: сетбаккупсукцеедед**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded).</span><span class="sxs-lookup"><span data-stu-id="99e38-136">Indicate whether the backup operation succeeded by calling [**IVssBackupComponents::SetBackupSucceeded**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded).</span></span>
17. <span data-ttu-id="99e38-137">Вызовите [**ивссбаккупкомпонентс:: баккупкомплете**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) , чтобы указать, что операция резервного копирования завершена.</span><span class="sxs-lookup"><span data-stu-id="99e38-137">Call [**IVssBackupComponents::BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) to indicate that the backup operation has completed.</span></span>
18. <span data-ttu-id="99e38-138">Вызовите [**ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) и [**Ивссбаккупкомпонентс:: жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus).</span><span class="sxs-lookup"><span data-stu-id="99e38-138">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus).</span></span> <span data-ttu-id="99e38-139">Память состояния сеанса модуля записи является ограниченным ресурсом, и модули записи должны в конечном итоге повторно использовать состояния сеанса.</span><span class="sxs-lookup"><span data-stu-id="99e38-139">The writer session state memory is a limited resource, and writers must eventually reuse session states.</span></span> <span data-ttu-id="99e38-140">Этот шаг помечает состояние сеанса резервного копирования модуля записи как завершенное и уведомляет VSS о том, что этот слот сеанса резервного копирования может быть повторно использован последующей операцией резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="99e38-140">This step marks the writer’s backup session state as completed and notifies VSS that this backup session slot can be reused by a subsequent backup operation.</span></span>
    > [!Note]  
    > <span data-ttu-id="99e38-141">Это необходимо только в Windows Server 2008 с пакетом обновления 2 (SP2) и более ранних версий.</span><span class="sxs-lookup"><span data-stu-id="99e38-141">This is only necessary on Windows Server 2008 with Service Pack 2 (SP2) and earlier.</span></span>

     

19. <span data-ttu-id="99e38-142">Вызовите [**ивссбаккупкомпонентс:: савеасксмл**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) , чтобы сохранить копию документа компонентов резервного копирования инициатора запроса.</span><span class="sxs-lookup"><span data-stu-id="99e38-142">Call [**IVssBackupComponents::SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) to save a copy of the requester's Backup Components Document.</span></span> <span data-ttu-id="99e38-143">Сведения в документе о компонентах резервного копирования используются во время восстановления, когда инициатор запроса вызывает метод [**ивссбаккупкомпонентс:: инитиализефорресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) .</span><span class="sxs-lookup"><span data-stu-id="99e38-143">The information in the Backup Components Document is used at restore time when the requester calls the [**IVssBackupComponents::InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) method.</span></span>

## <a name="choosing-which-critical-components-to-back-up"></a><span data-ttu-id="99e38-144">Выбор критически важных компонентов для резервного копирования</span><span class="sxs-lookup"><span data-stu-id="99e38-144">Choosing Which Critical Components to Back Up</span></span>

<span data-ttu-id="99e38-145">На этапе инициализации резервного копирования модуль записи ASR сообщает о следующих типах компонентов в своем документе метаданных модуля записи:</span><span class="sxs-lookup"><span data-stu-id="99e38-145">In the backup initialization phase, the ASR writer reports the following types of components in its Writer Metadata Document:</span></span>

-   <span data-ttu-id="99e38-146">Критические тома, такие как загрузочный, системный и Windows RE, и раздел Windows RE, связанный с экземпляром Windows Vista или Windows Server 2008, который выполняется в данный момент.</span><span class="sxs-lookup"><span data-stu-id="99e38-146">Critical volumes, such as the boot, system, and Windows Recovery Environment (Windows RE) volumes and the Windows RE partition that is associated with the instance of Windows Vista or Windows Server 2008 that is currently running.</span></span> <span data-ttu-id="99e38-147">Том является *критическим томом* , если он содержит сведения о состоянии системы.</span><span class="sxs-lookup"><span data-stu-id="99e38-147">A volume is a *critical volume* if it contains system state information.</span></span> <span data-ttu-id="99e38-148">Загрузочный и системный тома включаются автоматически.</span><span class="sxs-lookup"><span data-stu-id="99e38-148">The boot and system volumes are included automatically.</span></span> <span data-ttu-id="99e38-149">Инициатор запроса должен включать все тома, которые содержат критически важные для системы компоненты, например тома, содержащие Active Directory.</span><span class="sxs-lookup"><span data-stu-id="99e38-149">The requester must include all volumes that contain system-critical components reported by writers, such as the volumes that contain the Active Directory.</span></span> <span data-ttu-id="99e38-150">Критические для системы компоненты отмечены как "невыбираемые для резервного копирования".</span><span class="sxs-lookup"><span data-stu-id="99e38-150">System-critical components are marked as "not selectable for backup."</span></span> <span data-ttu-id="99e38-151">В VSS "не является выбираемым" означает "не необязательно".</span><span class="sxs-lookup"><span data-stu-id="99e38-151">In VSS, "not selectable" means "not optional."</span></span> <span data-ttu-id="99e38-152">Таким образом, инициатору запроса необходимо создать резервную копию в рамках состояния системы.</span><span class="sxs-lookup"><span data-stu-id="99e38-152">Thus, the requester is required to back them up as part of system state.</span></span> <span data-ttu-id="99e38-153">Дополнительные сведения см. в разделе [резервное копирование и восстановление состояния системы](locating-additional-system-files.md).</span><span class="sxs-lookup"><span data-stu-id="99e38-153">For more information, see [Backing Up and Restoring System State](locating-additional-system-files.md).</span></span> <span data-ttu-id="99e38-154">Компоненты, для которых \_ \_ установлен флаг VSS CF не \_ \_ состояния системы, не являются критически важными для системы.</span><span class="sxs-lookup"><span data-stu-id="99e38-154">Components for which the VSS\_CF\_NOT\_SYSTEM\_STATE flag is set are not system-critical.</span></span>
    > [!Note]  
    > <span data-ttu-id="99e38-155">Компонент ASR — это критически важный для системы компонент, о котором сообщает модуль записи ASR.</span><span class="sxs-lookup"><span data-stu-id="99e38-155">The ASR component is a system-critical component that is reported by the ASR writer.</span></span>

     

-   <span data-ttu-id="99e38-156">Диски.</span><span class="sxs-lookup"><span data-stu-id="99e38-156">Disks.</span></span> <span data-ttu-id="99e38-157">Каждый фиксированный диск компьютера предоставляется в виде компонента ASR.</span><span class="sxs-lookup"><span data-stu-id="99e38-157">Every fixed disk on the computer is exposed as a component in ASR.</span></span> <span data-ttu-id="99e38-158">Если диск не был исключен во время резервного копирования, он будет назначен во время восстановления и может быть создан повторно и отформатирован.</span><span class="sxs-lookup"><span data-stu-id="99e38-158">If a disk was not excluded during backup, it will be assigned during restore and can be re-created and reformatted.</span></span> <span data-ttu-id="99e38-159">Обратите внимание, что во время восстановления инициатор запроса по-прежнему может повторно создать диск, который был исключен во время резервного копирования, вызвав метод [**ивссбаккупкомпонентс:: сетрестореоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) .</span><span class="sxs-lookup"><span data-stu-id="99e38-159">Note that during restore, the requester can still re-create a disk that was excluded during backup by calling the [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) method.</span></span> <span data-ttu-id="99e38-160">Если выбран один диск в динамическом пакете диска, также необходимо выбрать все остальные диски в этом пакете.</span><span class="sxs-lookup"><span data-stu-id="99e38-160">If one disk in a dynamic disk pack is selected, all other disks in that pack must also be selected.</span></span> <span data-ttu-id="99e38-161">Если выбран том, так как это критически важный том (т. е. том, содержащий сведения о состоянии системы), необходимо также выбрать каждый диск, содержащий экстент для этого тома.</span><span class="sxs-lookup"><span data-stu-id="99e38-161">If a volume is selected because it is a critical volume (that is, a volume that contains system state information), every disk that contains an extent for that volume must also be selected.</span></span> <span data-ttu-id="99e38-162">Чтобы найти экстенты для тома, используйте управляющий код на подзапросе [**ioctl \_ \_ \_ \_ \_**](/windows/win32/api/winioctl/ni-winioctl-ioctl_volume_get_volume_disk_extents) .</span><span class="sxs-lookup"><span data-stu-id="99e38-162">To find the extents for a volume, use the [**IOCTL\_VOLUME\_GET\_VOLUME\_DISK\_EXTENTS**](/windows/win32/api/winioctl/ni-winioctl-ioctl_volume_get_volume_disk_extents) control code.</span></span>

    > [!Note]  
    > <span data-ttu-id="99e38-163">Во время резервного копирования инициатор запроса должен включать все фиксированные диски.</span><span class="sxs-lookup"><span data-stu-id="99e38-163">During backup, the requester should include all fixed disks.</span></span> <span data-ttu-id="99e38-164">Если диск, содержащий резервный набор данных инициатора запроса, является локальным диском, этот диск следует добавить.</span><span class="sxs-lookup"><span data-stu-id="99e38-164">If the disk that contains the requester's backup set is a local disk, this disk should be included.</span></span> <span data-ttu-id="99e38-165">Во время восстановления запрашивающий объект должен исключить диск, содержащий резервный набор данных инициатора запроса, чтобы предотвратить перезапись.</span><span class="sxs-lookup"><span data-stu-id="99e38-165">During restore, the requester must exclude the disk that contains the requester's backup set to prevent it from being overwritten.</span></span>

     

    <span data-ttu-id="99e38-166">В среде с кластеризацией ASR не создает повторно макет общих дисков кластера.</span><span class="sxs-lookup"><span data-stu-id="99e38-166">In a clustering environment, ASR does not re-create the layout of the cluster's shared disks.</span></span> <span data-ttu-id="99e38-167">Эти диски следует восстанавливать в оперативном режиме после восстановления операционной системы в Windows RE.</span><span class="sxs-lookup"><span data-stu-id="99e38-167">Those disks should be restored online after the operating system is restored in the Windows RE.</span></span>

-   <span data-ttu-id="99e38-168">Хранилище данные конфигурации загрузки (BCD).</span><span class="sxs-lookup"><span data-stu-id="99e38-168">Boot Configuration Data (BCD) store.</span></span> <span data-ttu-id="99e38-169">Этот компонент задает путь к каталогу, содержащему хранилище BCD.</span><span class="sxs-lookup"><span data-stu-id="99e38-169">This component specifies the path of the directory that contains the BCD store.</span></span> <span data-ttu-id="99e38-170">Инициатор запроса должен указать этот компонент и создать резервную копию всех файлов в каталоге хранилища BCD.</span><span class="sxs-lookup"><span data-stu-id="99e38-170">The requester must specify this component and back up all of the files in the BCD store directory.</span></span> <span data-ttu-id="99e38-171">Дополнительные сведения о хранилище BCD см. в разделе [About BCD](/previous-versions/windows/desktop/bcd/about-bcd).</span><span class="sxs-lookup"><span data-stu-id="99e38-171">For more information about the BCD store, see [About BCD](/previous-versions/windows/desktop/bcd/about-bcd).</span></span>
    > [!Note]  
    > <span data-ttu-id="99e38-172">На компьютерах, использующих интерфейс EFI, системный раздел EFI (ESP) всегда скрыт и не может быть включен в теневую копию тома.</span><span class="sxs-lookup"><span data-stu-id="99e38-172">On computers that use the Extended Firmware Interface (EFI), the EFI System Partition (ESP) is always hidden and cannot be included in a volume shadow copy.</span></span> <span data-ttu-id="99e38-173">Инициатор запроса должен создать резервную копию содержимого этой секции.</span><span class="sxs-lookup"><span data-stu-id="99e38-173">The requester must back up the contents of this partition.</span></span> <span data-ttu-id="99e38-174">Так как эта Секция не может быть включена в теневую копию тома, резервное копирование может выполняться только из динамического тома, а не из теневой копии.</span><span class="sxs-lookup"><span data-stu-id="99e38-174">Because this partition cannot be included in a volume shadow copy, the backup can only be performed from the live volume, not from the shadow copy.</span></span> <span data-ttu-id="99e38-175">Дополнительные сведения о EFI и ESP см. в статье о [программе](/windows-hardware/drivers/bringup/).</span><span class="sxs-lookup"><span data-stu-id="99e38-175">For more information about EFI and ESP, see [Bring up guide](/windows-hardware/drivers/bringup/).</span></span>

<span data-ttu-id="99e38-176">В именах компонентов используются следующие форматы:</span><span class="sxs-lookup"><span data-stu-id="99e38-176">The component names use the following formats:</span></span>

-   <span data-ttu-id="99e38-177">Для компонентов диска используется формат</span><span class="sxs-lookup"><span data-stu-id="99e38-177">For disk components, the format is</span></span>

    <COMPONENT logicalPath="Disks" componentName="harddisk*n*" componentType="filegroup" />

    <span data-ttu-id="99e38-178">где *n* — номер диска.</span><span class="sxs-lookup"><span data-stu-id="99e38-178">where *n* is the disk number.</span></span> <span data-ttu-id="99e38-179">Записывается только номер диска.</span><span class="sxs-lookup"><span data-stu-id="99e38-179">Only the disk number is recorded.</span></span> <span data-ttu-id="99e38-180">Чтобы получить номер диска, используйте контрольный код для [**\_ \_ получения \_ \_ номера устройства в хранилище ioctl**](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_get_device_number) .</span><span class="sxs-lookup"><span data-stu-id="99e38-180">To get the disk number, use the [**IOCTL\_STORAGE\_GET\_DEVICE\_NUMBER**](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_get_device_number) control code.</span></span>

-   <span data-ttu-id="99e38-181">Для компонентов тома используется формат</span><span class="sxs-lookup"><span data-stu-id="99e38-181">For volume components, the format is</span></span>

    <COMPONENT logicalPath="Volumes" componentName="Volume{*GUID*}" componentType="filegroup" />

    <span data-ttu-id="99e38-182">где *GUID* — GUID тома.</span><span class="sxs-lookup"><span data-stu-id="99e38-182">where *GUID* is the volume GUID.</span></span>

-   <span data-ttu-id="99e38-183">Для компонента хранилища BCD используется формат</span><span class="sxs-lookup"><span data-stu-id="99e38-183">For the BCD store component, the format is</span></span>

    <COMPONENT logicalPath="BCD" componentName="BCD" componentType="filegroup" componentCaption = "This is the path to the boot BCD store and the boot managers...All the files in this directory need to be backed up...">

    <span data-ttu-id="99e38-184">Если системный раздел имеет имя GUID тома, этот компонент доступен для выбора.</span><span class="sxs-lookup"><span data-stu-id="99e38-184">If the system partition has a volume GUID name, this component is selectable.</span></span> <span data-ttu-id="99e38-185">В противном случае он не может быть выбран.</span><span class="sxs-lookup"><span data-stu-id="99e38-185">Otherwise, it is not selectable.</span></span>

    > [!Note]  
    > <span data-ttu-id="99e38-186">ASR добавляет файлы в файловую группу компонента хранилища BCD следующим образом:</span><span class="sxs-lookup"><span data-stu-id="99e38-186">ASR adds the files to the BCD store component's file group as follows:</span></span>
    >
    > -   <span data-ttu-id="99e38-187">Для дисков EFI добавляется ASR</span><span class="sxs-lookup"><span data-stu-id="99e38-187">For EFI disks, ASR adds</span></span>
    >
    >     <span data-ttu-id="99e38-188">*Системпартитионпас* \\ \\Загрузка EFI \\ Майкрософт \\ \* .\*</span><span class="sxs-lookup"><span data-stu-id="99e38-188">*SystemPartitionPath*\\EFI\\Microsoft\\Boot\\\*.\*</span></span>
    >
    >     <span data-ttu-id="99e38-189">где *системпартитионпас* — это путь к системному разделу.</span><span class="sxs-lookup"><span data-stu-id="99e38-189">where *SystemPartitionPath* is the path to the system partition.</span></span>
    >
    > -   <span data-ttu-id="99e38-190">Для дисков GPT добавляется ASR</span><span class="sxs-lookup"><span data-stu-id="99e38-190">For GPT disks, ASR adds</span></span>
    >
    >     <span data-ttu-id="99e38-191">*Системпартитионпас* \\ Загрузка \\ \* .\*</span><span class="sxs-lookup"><span data-stu-id="99e38-191">*SystemPartitionPath*\\Boot\\\*.\*</span></span>
    >
    >     <span data-ttu-id="99e38-192">где *системпартитионпас* — это путь к системному разделу.</span><span class="sxs-lookup"><span data-stu-id="99e38-192">where *SystemPartitionPath* is the path to the system partition.</span></span>
    >
    > -   <span data-ttu-id="99e38-193">Путь к системному разделу можно найти в следующем разделе реестра: **\_ \_** \\  \\ **программа установки** \\ **системпартитион** локального компьютера hKey.</span><span class="sxs-lookup"><span data-stu-id="99e38-193">The system partition path can be found under the following registry key: **HKEY\_LOCAL\_MACHINE**\\**System**\\**Setup**\\**SystemPartition**</span></span>

     

<span data-ttu-id="99e38-194">При восстановлении необходимо восстановить все компоненты, помеченные как критические тома.</span><span class="sxs-lookup"><span data-stu-id="99e38-194">On restore, all components that are marked as critical volumes must be restored.</span></span> <span data-ttu-id="99e38-195">Если не удается восстановить один или несколько критических томов, операция восстановления завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="99e38-195">If one or more critical volumes cannot be restored, the restore operation fails.</span></span>

<span data-ttu-id="99e38-196">На этапе предварительного [**восстановления**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) последовательности восстановления диски, которые не были исключены во время резервного копирования, создаются повторно и форматируются по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="99e38-196">In the [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) phase of the restore sequence, disks that were not excluded during backup are re-created and reformatted by default.</span></span> <span data-ttu-id="99e38-197">Однако они не создаются повторно или переформатированы, если они отвечают следующим условиям.</span><span class="sxs-lookup"><span data-stu-id="99e38-197">However, they are not re-created or reformatted if they meet the following conditions:</span></span>

-   <span data-ttu-id="99e38-198">Базовый диск не создается повторно, если его структура диска не повреждена или в нее внесены только Аддитивные изменения.</span><span class="sxs-lookup"><span data-stu-id="99e38-198">A basic disk is not re-created if its disk layout is intact or only additive changes have been made to it.</span></span> <span data-ttu-id="99e38-199">Структура диска не изменяется, если выполняются следующие условия.</span><span class="sxs-lookup"><span data-stu-id="99e38-199">The disk layout is intact if the following conditions are true:</span></span>
    -   <span data-ttu-id="99e38-200">Подпись диска, тип диска (GPT или MBR), размер логического сектора и смещение начала тома не изменяются.</span><span class="sxs-lookup"><span data-stu-id="99e38-200">The disk signature, disk style (GPT or MBR), logical sector size, and volume start offset are not changed.</span></span>
    -   <span data-ttu-id="99e38-201">Размер тома не уменьшается.</span><span class="sxs-lookup"><span data-stu-id="99e38-201">The volume size is not decreased.</span></span>
    -   <span data-ttu-id="99e38-202">Для дисков GPT идентификатор секции не изменяется.</span><span class="sxs-lookup"><span data-stu-id="99e38-202">For GPT disks, the partition identifier is not changed.</span></span>
-   <span data-ttu-id="99e38-203">Динамический диск не создается повторно, если его структура диска не повреждена или в нее были внесены только добавочные изменения.</span><span class="sxs-lookup"><span data-stu-id="99e38-203">A dynamic disk is not re-created if its disk layout is intact or only additive changes have been made to it.</span></span> <span data-ttu-id="99e38-204">Для неизменности динамического диска необходимо выполнить все условия для базового диска.</span><span class="sxs-lookup"><span data-stu-id="99e38-204">For a dynamic disk to be intact, all of the conditions for a basic disk must be met.</span></span> <span data-ttu-id="99e38-205">Кроме того, вся структура тома в пакете диска не должна быть повреждена.</span><span class="sxs-lookup"><span data-stu-id="99e38-205">In addition, the entire disk pack's volume structure must be intact.</span></span> <span data-ttu-id="99e38-206">Структура тома диска не изменяется, если она соответствует следующим условиям, которые применяются к дискам MBR и GPT:</span><span class="sxs-lookup"><span data-stu-id="99e38-206">The disk pack's volume structure is intact if it meets the following conditions, which apply to both MBR and GPT disks:</span></span>
    -   <span data-ttu-id="99e38-207">Количество томов, доступных в физическом пакете во время восстановления, должно быть больше или равно числу томов, указанных в метаданных модуля записи ASR во время резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="99e38-207">The number of volumes that are available in the physical pack during restore must be greater than or equal to the number of volumes that were specified in the ASR writer metadata during backup.</span></span>
    -   <span data-ttu-id="99e38-208">Число [*плексов*](../vds/virtual-disk-service-glossary-all.md) на том должно быть не изменено.</span><span class="sxs-lookup"><span data-stu-id="99e38-208">The number of [*plexes*](../vds/virtual-disk-service-glossary-all.md) per volume must be unchanged.</span></span>
    -   <span data-ttu-id="99e38-209">Число [*членов*](../vds/virtual-disk-service-glossary-all.md) должно быть неизменным.</span><span class="sxs-lookup"><span data-stu-id="99e38-209">The number of [*members*](../vds/virtual-disk-service-glossary-all.md) must be unchanged.</span></span>
    -   <span data-ttu-id="99e38-210">Число экстентов физического диска должно быть больше числа экстентов диска, указанных в метаданных модуля записи ASR.</span><span class="sxs-lookup"><span data-stu-id="99e38-210">The number of physical disk extents must be greater than the number of disk extents specified in the ASR writer metadata.</span></span>
    -   <span data-ttu-id="99e38-211">Неповрежденный пакет остается неизменным при добавлении дополнительных томов или при расширении тома в пакете (например, с простого тома на составной том).</span><span class="sxs-lookup"><span data-stu-id="99e38-211">An intact pack remains intact when additional volumes are added, or if a volume in the pack is extended (for example, from a simple volume to a spanned volume).</span></span>
        > [!Note]  
        > <span data-ttu-id="99e38-212">Если простой том зеркально отражается, он не изменяется и будет создан повторно, чтобы убедиться в том, что после восстановления состояние BCD и загрузочный том остаются постоянными.</span><span class="sxs-lookup"><span data-stu-id="99e38-212">If a simple volume is mirrored, the pack is not intact and will be re-created to ensure that the BCD and boot volume state remain consistent after restore.</span></span> <span data-ttu-id="99e38-213">При удалении томов пакет создается повторно.</span><span class="sxs-lookup"><span data-stu-id="99e38-213">If volumes are deleted, the pack is re-created.</span></span>

         
-   <span data-ttu-id="99e38-214">Если структура тома динамического диска не повреждена и в нее были внесены только Аддитивные изменения, диски в пакете не создаются повторно.</span><span class="sxs-lookup"><span data-stu-id="99e38-214">If the dynamic disk pack's volume structure is intact and only additive changes have been made to it, the disks in the pack are not re-created.</span></span>

    <span data-ttu-id="99e38-215">**Windows Vista:** Динамические диски всегда создаются повторно.</span><span class="sxs-lookup"><span data-stu-id="99e38-215">**Windows Vista:** Dynamic disks are always re-created.</span></span> <span data-ttu-id="99e38-216">Обратите внимание, что это поведение изменилось в Windows Server 2008 и Windows Vista с пакетом обновления 1 (SP1).</span><span class="sxs-lookup"><span data-stu-id="99e38-216">Note that this behavior has changed with Windows Server 2008 and Windows Vista with Service Pack 1 (SP1).</span></span>

<span data-ttu-id="99e38-217">В любое время до начала этапа восстановления инициатор запроса может указать, что диски должны быть кратко отформатированы, задав раздел реестра **hKey \_ Local \_ Machine** \\ **Software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **ресторесессион** .</span><span class="sxs-lookup"><span data-stu-id="99e38-217">At any time before the beginning of the restore phase, the requester can specify that the disks should be quick-formatted by setting the **HKEY\_LOCAL\_MACHINE**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession** registry key.</span></span> <span data-ttu-id="99e38-218">В этом разделе есть значение с именем **куиккформат** и типом данных REG \_ DWORD.</span><span class="sxs-lookup"><span data-stu-id="99e38-218">Under this key, there is a value named **QuickFormat** with the data type REG\_DWORD.</span></span> <span data-ttu-id="99e38-219">Если это значение не существует, его следует создать.</span><span class="sxs-lookup"><span data-stu-id="99e38-219">If this value does not exist, you should create it.</span></span> <span data-ttu-id="99e38-220">Задайте для параметра **куиккформат** значение 1 для быстрого форматирования или 0 для ускорения форматирования.</span><span class="sxs-lookup"><span data-stu-id="99e38-220">Set the data of the **QuickFormat** value to 1 for quick formatting or 0 for slow formatting.</span></span>

<span data-ttu-id="99e38-221">Если значение **куиккформат** не существует, диски будут иметь низкую отформатированную.</span><span class="sxs-lookup"><span data-stu-id="99e38-221">If the **QuickFormat** value does not exist, the disks will be slow-formatted.</span></span>

<span data-ttu-id="99e38-222">Быстрое форматирование выполняется значительно быстрее, чем медленный формат (также называется полным форматированием).</span><span class="sxs-lookup"><span data-stu-id="99e38-222">Quick formatting is significantly faster than slow formatting (also called full formatting).</span></span> <span data-ttu-id="99e38-223">Однако быстрое форматирование не проверяет каждый сектор тома.</span><span class="sxs-lookup"><span data-stu-id="99e38-223">However, quick formatting does not verify each sector on the volume.</span></span>

## <a name="overview-of-restore-phase-tasks"></a><span data-ttu-id="99e38-224">Обзор задач этапа восстановления</span><span class="sxs-lookup"><span data-stu-id="99e38-224">Overview of Restore Phase Tasks</span></span>

<span data-ttu-id="99e38-225">Во время восстановления инициатор запроса выполняет следующие действия:</span><span class="sxs-lookup"><span data-stu-id="99e38-225">At restore time, the requester performs the following steps:</span></span>

> [!Note]  
> <span data-ttu-id="99e38-226">Все действия необходимы, если не указано иное.</span><span class="sxs-lookup"><span data-stu-id="99e38-226">All steps are required unless otherwise indicated.</span></span>

 

1.  <span data-ttu-id="99e38-227">Вызовите функцию [**креатевссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) , чтобы создать экземпляр интерфейса [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) и вызвать метод [**ивссбаккупкомпонентс:: инитиализефорресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) , чтобы инициализировать экземпляр для восстановления, загрузив документ компонентов резервного копирования инициатора запроса в экземпляр.</span><span class="sxs-lookup"><span data-stu-id="99e38-227">Call the [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) function to create an instance of the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface and call the [**IVssBackupComponents::InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) method to initialize the instance for restore by loading the requester's Backup Components Document into the instance.</span></span>
2.  <span data-ttu-id="99e38-228">\[Этот шаг необходим только в том случае, если инициатору запроса необходимо изменить значение "Инклудедиск" или "Ексклудедиск" для одного или нескольких дисков. \] Вызовите метод [**ивссбаккупкомпонентс:: сетрестореоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) , чтобы задать параметры восстановления для компонентов модуля записи ASR.</span><span class="sxs-lookup"><span data-stu-id="99e38-228">\[This step is required only if the requester needs to change whether "IncludeDisk" or "ExcludeDisk" is specified for one or more disks.\] Call [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) to set the restore options for the ASR writer components.</span></span> <span data-ttu-id="99e38-229">Модуль записи ASR поддерживает следующие параметры: "Инклудедиск" позволяет инициатору запроса включить в целевую систему диск, который будет считаться восстановленным, даже если он не был выбран на этапе резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="99e38-229">The ASR writer supports the following options: "IncludeDisk" allows the requester to include a disk on the target system to be considered for restore, even if it was not selected during the backup phase.</span></span> <span data-ttu-id="99e38-230">"Ексклудедиск" позволяет инициатору запроса предотвратить повторное создание диска в целевой системе.</span><span class="sxs-lookup"><span data-stu-id="99e38-230">"ExcludeDisk" allows the requester to prevent a disk on the target system from being re-created.</span></span> <span data-ttu-id="99e38-231">Обратите внимание, что если для диска, содержащего критический том, указан параметр "Ексклудедиск", последующий вызов [**ивссбаккупкомпонентс::P**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) Повторное восстановление будет невозможно.</span><span class="sxs-lookup"><span data-stu-id="99e38-231">Note that if "ExcludeDisk" is specified for a disk that contains a critical volume, the subsequent call to [**IVssBackupComponents::PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) will fail.</span></span>

    <span data-ttu-id="99e38-232">В следующем примере показано, как использовать [**сетрестореоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) , чтобы предотвратить повторное создание диска 0 и диска 1 и внедрить сторонние драйверы в восстановленный загрузочный том.</span><span class="sxs-lookup"><span data-stu-id="99e38-232">The following example shows how to use [**SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) to prevent disk 0 and disk 1 from being re-created and inject third-party drivers into the restored boot volume.</span></span>

    <span data-ttu-id="99e38-233">Windows **server 2008, Windows Vista, Windows server 2003 и Windows XP:** Внедрение драйверов сторонних производителей не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="99e38-233">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** Injection of third-party drivers is not supported.</span></span>

    <span data-ttu-id="99e38-234">В примере предполагается, что указатель [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) , m \_ пбаккупкомпонентс, является допустимым.</span><span class="sxs-lookup"><span data-stu-id="99e38-234">The example assumes that the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) pointer, m\_pBackupComponents, is valid.</span></span>

    ```C++
        m_pBackupComponents->SetRestoreOptions(
            AsrWriterId,
            VSS_CT_FILEGROUP,
            NULL,
            TEXT("ASR"),
            TEXT("\"ExcludeDisk\"=\"0\", \"ExcludeDisk\"=\"1\" "),
            TEXT("\"InjectDrivers\"=\"1\" ")
            );
    ```

    

    <span data-ttu-id="99e38-235">Чтобы исключить все диски для указанного тома, см. следующую статью "исключение всех дисков для тома".</span><span class="sxs-lookup"><span data-stu-id="99e38-235">To exclude all disks for a specified volume, see the following "Excluding All Disks for a Volume."</span></span>

3.  <span data-ttu-id="99e38-236">Вызовите [**ивссбаккупкомпонентс::P Rerestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) , чтобы уведомить модуль записи ASR о необходимости подготовиться к операции восстановления.</span><span class="sxs-lookup"><span data-stu-id="99e38-236">Call [**IVssBackupComponents::PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) to notify the ASR writer to prepare for a restore operation.</span></span> <span data-ttu-id="99e38-237">Вызывайте [**ивссасинк:: QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) столько раз, сколько необходимо, пока значение состояния, возвращенное в параметре *фрресулт* , не является \_ \_ асинхронным \_ ожиданием VSS S.</span><span class="sxs-lookup"><span data-stu-id="99e38-237">Call [**IVssAsync::QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) as many times as necessary until the status value returned in the *pHrResult* parameter is not VSS\_S\_ASYNC\_PENDING.</span></span>
4.  <span data-ttu-id="99e38-238">Восстановление данных.</span><span class="sxs-lookup"><span data-stu-id="99e38-238">Restore the data.</span></span> <span data-ttu-id="99e38-239">На этапе восстановления ASR перестраивает путь GUID тома ( \\ \\ ? \\ Том {GUID}) для каждого тома, совпадающего с путем GUID тома, который использовался на этапе резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="99e38-239">In the restore phase, ASR reconfigures the volume GUID path (\\\\?\\Volume{GUID}) for each volume to match the volume GUID path that was used during the backup phase.</span></span> <span data-ttu-id="99e38-240">Однако буквы дисков не сохраняются, так как это приведет к конфликту с буквами дисков, которые автоматически назначаются в среде восстановления.</span><span class="sxs-lookup"><span data-stu-id="99e38-240">However, drive letters are not preserved, because this would cause collisions with the drive letters that are automatically assigned in the recovery environment.</span></span> <span data-ttu-id="99e38-241">Поэтому при восстановлении данных инициатору запроса необходимо использовать пути GUID тома, а не буквы диска для доступа к томам.</span><span class="sxs-lookup"><span data-stu-id="99e38-241">Thus, when restoring data, the requester must use volume GUID paths, not drive letters, to access the volumes.</span></span>
5.  <span data-ttu-id="99e38-242">Задайте раздел реестра **HKLM** \\ **Software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **ресторесессион** , чтобы указать набор восстановленных или переформатированных томов.</span><span class="sxs-lookup"><span data-stu-id="99e38-242">Set the **HKLM**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession** registry key to indicate the set of volumes that have been restored or reformatted.</span></span>

    <span data-ttu-id="99e38-243">В этом разделе есть значение с именем **ресторедволумес** и типом данных REG \_ Multi \_ SZ.</span><span class="sxs-lookup"><span data-stu-id="99e38-243">Under this key, there is a value named **RestoredVolumes** with the data type REG\_MULTI\_SZ.</span></span> <span data-ttu-id="99e38-244">Если это значение не существует, его следует создать.</span><span class="sxs-lookup"><span data-stu-id="99e38-244">If this value does not exist, you should create it.</span></span> <span data-ttu-id="99e38-245">В этом значении инициатору запроса следует создать запись GUID тома для каждого восстановленного тома.</span><span class="sxs-lookup"><span data-stu-id="99e38-245">Under this value, your requester should create a volume GUID entry for each volume that has been restored.</span></span> <span data-ttu-id="99e38-246">Эта запись должна иметь следующий формат: \\ \\ ? \\ Том {78618c8f-aefd-11da-a898-806e6f6e6963}.</span><span class="sxs-lookup"><span data-stu-id="99e38-246">This entry should be in the following format: \\\\?\\Volume{78618c8f-aefd-11da-a898-806e6f6e6963}.</span></span> <span data-ttu-id="99e38-247">При каждом выполнении восстановления без операционной системы ASR устанавливает значение **ресторедволумес** в набор томов, восстановленных с помощью ASR.</span><span class="sxs-lookup"><span data-stu-id="99e38-247">Each time a bare-metal recovery is performed, ASR sets the **RestoredVolumes** value to the set of volumes that ASR restored.</span></span> <span data-ttu-id="99e38-248">Если инициатор запроса восстановил дополнительные тома, ему следует задать для этого параметра объединение набора томов, восстановленных инициатором запроса, и набора томов, восстановленных с помощью ASR.</span><span class="sxs-lookup"><span data-stu-id="99e38-248">If the requester restored additional volumes, it should set this value to the union of the set of volumes that the requester restored and the set of volumes that ASR restored.</span></span> <span data-ttu-id="99e38-249">Если инициатор запроса не использовал ASR, он должен заменить список томов.</span><span class="sxs-lookup"><span data-stu-id="99e38-249">If the requester did not use ASR, it should replace the list of volumes.</span></span>

    <span data-ttu-id="99e38-250">Необходимо также создать значение с именем **ластинстанце** и типом данных REG \_ SZ.</span><span class="sxs-lookup"><span data-stu-id="99e38-250">You should also create a value named **LastInstance** with the data type REG\_SZ.</span></span> <span data-ttu-id="99e38-251">Этот ключ должен содержать случайный файл cookie, который однозначно определяет текущую операцию восстановления.</span><span class="sxs-lookup"><span data-stu-id="99e38-251">This key should contain a random cookie that uniquely identifies the current restore operation.</span></span> <span data-ttu-id="99e38-252">Такой файл cookie можно создать с помощью функций [**ууидкреате**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) и [**ууидтостринг**](/windows/win32/api/rpcdce/nf-rpcdce-uuidtostring) .</span><span class="sxs-lookup"><span data-stu-id="99e38-252">Such a cookie can be created by using the [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) and [**UuidToString**](/windows/win32/api/rpcdce/nf-rpcdce-uuidtostring) functions.</span></span> <span data-ttu-id="99e38-253">При каждом выполнении восстановления без операционной системы ASR сбрасывает этот параметр реестра, чтобы уведомлять запрашивающих и не поддерживающих VSS приложения резервного копирования, которые произошли при восстановлении.</span><span class="sxs-lookup"><span data-stu-id="99e38-253">Each time a bare-metal recovery is performed, ASR resets this registry value to notify requesters and non-VSS backup applications that the recovery has occurred.</span></span>

6.  <span data-ttu-id="99e38-254">Вызовите [**ивссбаккупкомпонентс::P остресторе**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) , чтобы указать конец операции восстановления.</span><span class="sxs-lookup"><span data-stu-id="99e38-254">Call [**IVssBackupComponents::PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) to indicate the end of the restore operation.</span></span> <span data-ttu-id="99e38-255">Вызывайте [**ивссасинк:: QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) столько раз, сколько необходимо, пока значение состояния, возвращенное в параметре *фрресулт* , не является \_ \_ асинхронным \_ ожиданием VSS S.</span><span class="sxs-lookup"><span data-stu-id="99e38-255">Call [**IVssAsync::QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) as many times as necessary until the status value returned in the *pHrResult* parameter is not VSS\_S\_ASYNC\_PENDING.</span></span>

<span data-ttu-id="99e38-256">На этапе восстановления ASR может создать или удалить разделы, чтобы восстановить предыдущее состояние компьютера.</span><span class="sxs-lookup"><span data-stu-id="99e38-256">In the restore phase, ASR may create or remove partitions to restore the computer to its previous state.</span></span> <span data-ttu-id="99e38-257">Запрашивающие стороны не должны пытаться сопоставлять номера дисков с этапа резервного копирования на этапе восстановления.</span><span class="sxs-lookup"><span data-stu-id="99e38-257">Requesters must not attempt to map disk numbers from the backup phase to the restore phase.</span></span>

<span data-ttu-id="99e38-258">При восстановлении инициатор запроса должен исключить диск, содержащий резервный набор данных инициатора запроса.</span><span class="sxs-lookup"><span data-stu-id="99e38-258">On restore, the requester must exclude the disk that contains the requester's backup set.</span></span> <span data-ttu-id="99e38-259">В противном случае резервный набор данных может быть перезаписан операцией восстановления.</span><span class="sxs-lookup"><span data-stu-id="99e38-259">Otherwise, the backup set can be overwritten by the restore operation.</span></span>

<span data-ttu-id="99e38-260">При восстановлении диск исключается, если он не был выбран в качестве компонента во время резервного копирования или явно исключен путем вызова [**ивссбаккупкомпонентс:: сетрестореоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) с параметром "ексклудедиск" во время восстановления.</span><span class="sxs-lookup"><span data-stu-id="99e38-260">On restore, a disk is excluded if it was not selected as a component during backup, or if it is explicitly excluded by calling [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) with the "ExcludeDisk" option during restore.</span></span>

<span data-ttu-id="99e38-261">Важно отметить, что во время аварийного восстановления WinPE существует функция модуля записи ASR, но другие модули записи недоступны, а служба VSS не запущена.</span><span class="sxs-lookup"><span data-stu-id="99e38-261">It is important to note that during WinPE disaster recovery, ASR writer functionality is present, but no other writers are available, and the VSS service is not running.</span></span> <span data-ttu-id="99e38-262">После завершения аварийного восстановления WinPE компьютер перезапускается, и операционная система Windows работает нормально, служба VSS может быть запущена, а инициатор запроса может выполнять любые дополнительные операции восстановления, для которых требуется участие в модулях записи ASR.</span><span class="sxs-lookup"><span data-stu-id="99e38-262">After WinPE disaster recovery has completed, the computer has restarted, and the Windows operating system is running normally, the VSS service can be started, and the requester can perform any additional restore operations that require participation of writers other than the ASR writer.</span></span>

<span data-ttu-id="99e38-263">Если во время сеанса восстановления приложение резервного копирования обнаруживает, что уникальные идентификаторы томов не изменились и, следовательно, все тома с момента создания резервной копии находятся в среде WinPE и остаются нетронутыми, приложение резервного копирования может восстановить только содержимое томов, не включая ASR.</span><span class="sxs-lookup"><span data-stu-id="99e38-263">If during the restore session the backup application detects that the volume unique IDs are unchanged, and therefore all volumes from the time of the backup are present and intact in WinPE, the backup application can proceed to restore only the contents of the volumes, without involving ASR.</span></span> <span data-ttu-id="99e38-264">В этом случае приложение резервного копирования должно указать, что компьютер был восстановлен, задав следующий раздел реестра в восстановленной операционной системе: **hKey \_ Local \_ Machine** \\ **Software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **ресторесессион**</span><span class="sxs-lookup"><span data-stu-id="99e38-264">In this case, the backup application should indicate that the computer was restored by setting the following registry key in the restored operating system: **HKEY\_LOCAL\_MACHINE**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession**</span></span>

<span data-ttu-id="99e38-265">В этом разделе Укажите **ластинстанце** в качестве значения Name, REG \_ SZ для типа значения и случайный файл cookie (например, GUID, созданный функцией [**ууидкреате**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) ) для данных значения.</span><span class="sxs-lookup"><span data-stu-id="99e38-265">Under this key, specify **LastInstance** for the value name, REG\_SZ for the value type, and a random cookie (such as a GUID created by the [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) function) for the value data.</span></span>

<span data-ttu-id="99e38-266">Если во время сеанса восстановления приложение резервного копирования обнаруживает, что один или несколько томов изменились или отсутствуют, приложение резервного копирования должно использовать ASR для выполнения восстановления.</span><span class="sxs-lookup"><span data-stu-id="99e38-266">If during the restore session the backup application detects that one or more volumes are changed or missing, the backup application should use ASR to perform the restore.</span></span> <span data-ttu-id="99e38-267">ASR воссоздаст тома точно так же, как и на момент резервного копирования, и установит раздел реестра **ресторесессион** .</span><span class="sxs-lookup"><span data-stu-id="99e38-267">ASR will re-create the volumes exactly the way they were at the time of the backup and set the **RestoreSession** registry key.</span></span>

## <a name="excluding-all-disks-for-a-volume"></a><span data-ttu-id="99e38-268">Исключение всех дисков для тома</span><span class="sxs-lookup"><span data-stu-id="99e38-268">Excluding All Disks for a Volume</span></span>

<span data-ttu-id="99e38-269">В следующем примере показано, как исключить все диски для указанного тома.</span><span class="sxs-lookup"><span data-stu-id="99e38-269">The following example shows how to exclude all disks for a specified volume.</span></span>


```C++
HRESULT BuildRestoreOptionString
(
    const WCHAR             *pwszVolumeNamePath,
    CMyString               *pstrExclusionList
)
{
    HANDLE                  hVolume           = INVALID_HANDLE_VALUE;
    DWORD                   cbSize            = 0;
    VOLUME_DISK_EXTENTS     * pExtents        = NULL;
    DISK_EXTENT             * pExtent         = NULL;
    ULONG                   i                 = 0;
    BOOL                    fIoRet            = FALSE;
    WCHAR                   wszDest[MAX_PATH] = L"";
    CMyString               strVolumeName;
    CMyString               strRestoreOption;

    // Open a handle to the volume device.
    strVolumeName.Set( pwszVolumeNamePath );
    // If the volume name contains a trailing backslash, remove it.
    strVolumeName.UnTrailing( L'\\' );
    hVolume = ::CreateFile(strVolumeName, 0, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, NULL, 0);
    // Check whether the call to CreateFile succeeded.

    // Get the list of disks used by this volume.
    cbSize = sizeof(VOLUME_DISK_EXTENTS);
    pExtents = (VOLUME_DISK_EXTENTS *)::CoTaskMemAlloc(cbSize);

    ::ZeroMemory(pExtents, cbSize);

    fIoRet = ::DeviceIoControl(hVolume, IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS, NULL, 0, pExtents, cbSize, &cbSize, 0);
    if ( !fIoRet && GetLastError() == ERROR_MORE_DATA )
    {
        // Allocate more memory.
        cbSize = FIELD_OFFSET(VOLUME_DISK_EXTENTS, Extents) + pExtents->NumberOfDiskExtents * sizeof(DISK_EXTENT);
        ::CoTaskMemFree(pExtents);
        pExtents = NULL;

        pExtents = (VOLUME_DISK_EXTENTS *) ::CoTaskMemAlloc(cbSize);
        // Check whether CoTaskMemAlloc returned an out-of-memory error.
        ::ZeroMemory(pExtents, cbSize);

        // Now the buffer should be big enough.
        ::DeviceIoControl(hVolume, IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS, NULL, 0, pExtents, cbSize, &cbSize, 0);
        // Check whether the IOCTL succeeded.
    }
    // Check for errors; note that the IOCTL can fail for a reason other than insufficient memory.

    // For each disk, mark it to be excluded in the Restore Option string.
    for (i = 0; i < pExtents->NumberOfDiskExtents; i++)
    {
        pExtent = &pExtents->Extents[i];

        *wszDest = L'\0';
        StringCchPrintf(wszDest, MAX_PATH, L"\"ExcludeDisk\"=\"%d\", ", pExtent->DiskNumber); // check errors

        strRestoreOption.Append(wszDest);
        // Check for an out-of-memory error.
    }

    // Remove the trailing comma.
    strRestoreOption.TrimRight();
    strRestoreOption.UnTrailing(',');

    // Set the output parameter.
    strRestoreOption.Transfer( pstrExclusionList );

Exit:
    if( pExtents )
    {
        ::CoTaskMemFree(pExtents);
        pExtents = NULL;
    }

    if( hVolume != INVALID_HANDLE_VALUE )
    {
        ::CloseHandle(hVolume);
        hVolume = INVALID_HANDLE_VALUE;
    }

    return ( hr );
}

```



 

 
