---
description: Как правило, создание теневой копии зависит от типа создаваемой теневой копии, ее контекста и роли, которая прилагается к модулям записи в операции теневого копирования.
ms.assetid: eab3b39b-dfa7-43ea-adba-cd0b495c373f
title: Сведения о создании теневой копии
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8b9281b899593ca0751f1d549aed60305041b18c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692872"
---
# <a name="shadow-copy-creation-details"></a><span data-ttu-id="69527-103">Сведения о создании теневой копии</span><span class="sxs-lookup"><span data-stu-id="69527-103">Shadow Copy Creation Details</span></span>

<span data-ttu-id="69527-104">Как правило, создание теневой копии зависит от типа создаваемой теневой копии, ее контекста и роли, которая прилагается к модулям записи в операции теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="69527-104">In general, how a shadow copy is created depends on the type of shadow copy to be created, its context, and the role accorded to writers in the shadow copy operation.</span></span> <span data-ttu-id="69527-105">(Дополнительные сведения см. в разделе [конфигурации контекста теневого копирования](shadow-copy-context-configurations.md) .)</span><span class="sxs-lookup"><span data-stu-id="69527-105">(See [Shadow Copy Context Configurations](shadow-copy-context-configurations.md) for more information.)</span></span>

<span data-ttu-id="69527-106">Контекст теневой копии задается путем вызова метода [**ивссбаккупкомпонентс:: SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) .</span><span class="sxs-lookup"><span data-stu-id="69527-106">The shadow copy context is set by calling the [**IVssBackupComponents::SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) method.</span></span> <span data-ttu-id="69527-107">Перед вызовом метода [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) для создания теневой копии запрашивающие стороны должны вызывать методы [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) в порядке, указанном в следующих разделах.</span><span class="sxs-lookup"><span data-stu-id="69527-107">Before calling the [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) method to create a shadow copy, requesters must call the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) methods in the order specified in the following sections.</span></span>

## <a name="prerequisites-for-all-shadow-copies"></a><span data-ttu-id="69527-108">Необходимые условия для всех теневых копий</span><span class="sxs-lookup"><span data-stu-id="69527-108">Prerequisites for All Shadow Copies</span></span>

<span data-ttu-id="69527-109">Независимо от уровня участия в записи, создание любой теневой копии всегда требует, чтобы запрашивающий был инициализирован с вызовами [**ивссбаккупкомпонентс:: инитиализефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) и [**Ивссбаккупкомпонентс:: стартснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span><span class="sxs-lookup"><span data-stu-id="69527-109">Regardless of the level of writer participation, the creation of any shadow copy will always require the requestor be initialized with calls to [**IVssBackupComponents::InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) and [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span></span>

<span data-ttu-id="69527-110">Если этот вызов не выполняется, метод [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) возвратит ошибку.</span><span class="sxs-lookup"><span data-stu-id="69527-110">If this call is not made, the [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) method will return an error.</span></span>

## <a name="shadow-copies-with-writer-participation"></a><span data-ttu-id="69527-111">Теневые копии с участием в модуле записи</span><span class="sxs-lookup"><span data-stu-id="69527-111">Shadow Copies with Writer Participation</span></span>

<span data-ttu-id="69527-112">Если в контексте теневого копирования задано участие в записи (то есть [**ивссбаккупкомпонентс:: SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) вызывается с **\_ \_ резервным копированием VSS CTX** или **\_ \_ \_ откат приложения VSS CTX**):</span><span class="sxs-lookup"><span data-stu-id="69527-112">If the shadow copy context specifies writer participation (that is, [**IVssBackupComponents::SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) is called with **VSS\_CTX\_BACKUP**, or **VSS\_CTX\_APP\_ROLLBACK**):</span></span>

-   <span data-ttu-id="69527-113">Запрашивающие стороны должны всегда вызывать [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) , если контекст теневого копирования поддерживает участие в записи.</span><span class="sxs-lookup"><span data-stu-id="69527-113">Requesters must always call [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) when the shadow copy context supports writer participation.</span></span> <span data-ttu-id="69527-114">Если контекст теневого копирования поддерживает участие в записи и метод **ивссбаккупкомпонентс:: гасервритерметадата** не вызывается до [**Ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), будет возвращена ошибка.</span><span class="sxs-lookup"><span data-stu-id="69527-114">If the shadow copy context supports writer participation and **IVssBackupComponents::GatherWriterMetadata** is not called prior to [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), an error will be returned.</span></span>
-   <span data-ttu-id="69527-115">Если инициатор запроса хочет выбрать определенные компоненты модуля записи, он должен вызвать [**ивссбаккупкомпонентс:: AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) перед вызовом [**стартснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) для создания набора теневых копий.</span><span class="sxs-lookup"><span data-stu-id="69527-115">If a requester wants to select specific writer components, it must call [**IVssBackupComponents::AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) before calling [**StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) to create the shadow copy set.</span></span>
-   <span data-ttu-id="69527-116">Для создания набора теневых копий необходимо вызвать [**стартснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) .</span><span class="sxs-lookup"><span data-stu-id="69527-116">[**StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) must be called to create the shadow copy set.</span></span>
-   <span data-ttu-id="69527-117">Инициаторы запроса могут добавить один или несколько томов в набор теневых копий, вызвав [**аддтоснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span><span class="sxs-lookup"><span data-stu-id="69527-117">Requesters may add one or more volumes to the shadow copy set by calling [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span></span> <span data-ttu-id="69527-118">Некоторые компоненты модуля записи могут не указывать какие либо затронутые тома.</span><span class="sxs-lookup"><span data-stu-id="69527-118">Some writer components may not specify any affected volumes.</span></span> <span data-ttu-id="69527-119">В этом случае допустимо, чтобы моментальный снимок был пустым (то есть не должен содержать томов).</span><span class="sxs-lookup"><span data-stu-id="69527-119">In this case, it is acceptable for a snapshot set to be empty (that is, to contain no volumes).</span></span>
-   <span data-ttu-id="69527-120">Чтобы гарантировать согласованность метаданных модуля записи, инициатор запроса должен всегда вызывать [**ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , даже если компоненты не выбраны.</span><span class="sxs-lookup"><span data-stu-id="69527-120">To guarantee the consistency of writer metadata, a requester should always call [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) even if no components are selected.</span></span> <span data-ttu-id="69527-121">Это приводит к тому, что VSS создает событие **PrepareForBackup** , в котором VSS вызывает метод [**Квссвритер:: онпрепаребаккуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) для каждого модуля записи участия.</span><span class="sxs-lookup"><span data-stu-id="69527-121">This causes VSS to generate a **PrepareForBackup** event, in which VSS calls the [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method for each participating writer.</span></span>
-   <span data-ttu-id="69527-122">Служба VSS создаст [*препарефорснапшот*](vssgloss-p.md) и [*заморозить*](vssgloss-f.md) события перед созданием теневой копии в ответ на [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset).</span><span class="sxs-lookup"><span data-stu-id="69527-122">VSS will generate [*PrepareForSnapshot*](vssgloss-p.md) and [*Freeze*](vssgloss-f.md) events before creating the shadow copy in response to [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset).</span></span> <span data-ttu-id="69527-123">Модули записи будут выполнять обработку событий с помощью [**квссвритер:: онпрепареснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) и [**квссвритер:: onfreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze).</span><span class="sxs-lookup"><span data-stu-id="69527-123">Writers will handle the events with [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) and [**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze).</span></span>
-   <span data-ttu-id="69527-124">После создания теневой копии в ответ на [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)службы VSS создают события [*разморозки*](vssgloss-t.md) и события [*моментального снимка*](vssgloss-p.md) .</span><span class="sxs-lookup"><span data-stu-id="69527-124">VSS will generate [*Thaw*](vssgloss-t.md) events and [*PostSnapshot*](vssgloss-p.md) events after creating a shadow copy in response to [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset).</span></span> <span data-ttu-id="69527-125">Модули записи будут выполнять обработку событий с помощью [**квссвритер:: размораживание**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) и [**квссвритер:: онпостснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot).</span><span class="sxs-lookup"><span data-stu-id="69527-125">Writers will handle the events with [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) and [**CVssWriter::OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot).</span></span>

## <a name="shadow-copies-without-writer-participation"></a><span data-ttu-id="69527-126">Теневые копии без участия в записи</span><span class="sxs-lookup"><span data-stu-id="69527-126">Shadow Copies without Writer Participation</span></span>

<span data-ttu-id="69527-127">Создание теневых копий без участия в записи не рекомендуется для стандартных приложений резервного копирования (см. статью [резервное копирование без участия в записи](backups-without-writer-participation.md)).</span><span class="sxs-lookup"><span data-stu-id="69527-127">Creating shadow copies without writer participation is discouraged for standard backup applications (see [Backups without Writer Participation](backups-without-writer-participation.md)).</span></span>

<span data-ttu-id="69527-128">Существуют такие средства, как быстрое резервное копирование диска для обеспечения безопасности от случайного повреждения файлов, которое может быть проведено без явного участия в записи.</span><span class="sxs-lookup"><span data-stu-id="69527-128">There are uses, such as fast backups of a disk to provide a safety net against accidental file corruption, which can be conducted without explicit writer participation.</span></span> <span data-ttu-id="69527-129">Такая теневая копия будет иметь контекст **\_ CTX \_ \_ \_ резервной копии общей папки VSS** или **VSS \_ CTX \_ NAS \_ ROLLBACK**.</span><span class="sxs-lookup"><span data-stu-id="69527-129">Such a shadow copy would have a context of either **VSS\_CTX\_FILE\_SHARE\_BACKUP** or **VSS\_CTX\_NAS\_ROLLBACK**.</span></span>

<span data-ttu-id="69527-130">Для этого типа теневого копирования Обратите внимание на следующее:</span><span class="sxs-lookup"><span data-stu-id="69527-130">For this type of shadow copy, note the following:</span></span>

-   <span data-ttu-id="69527-131">Запрашивающие стороны должны по-прежнему вызывать необходимые методы, перечисленные в статье [необходимые условия для всех теневых копий](#prerequisites-for-all-shadow-copies).</span><span class="sxs-lookup"><span data-stu-id="69527-131">Requesters must still call the required methods listed in [Prerequisites for All Shadow Copies](#prerequisites-for-all-shadow-copies).</span></span>
-   <span data-ttu-id="69527-132">Инициаторы запроса могут вызывать [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata), но это не является обязательным.</span><span class="sxs-lookup"><span data-stu-id="69527-132">Requesters may call [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata), but this is not required.</span></span>
-   <span data-ttu-id="69527-133">Если инициаторы запроса вызывают [**ивссбаккупкомпонентс:: AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent), [**Ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)или [**ивссбаккупкомпонентс:: BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete), будет возвращена ошибка.</span><span class="sxs-lookup"><span data-stu-id="69527-133">If requesters call [**IVssBackupComponents::AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent), [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup), or [**IVssBackupComponents::BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete), an error will be returned.</span></span>
-   <span data-ttu-id="69527-134">Поставщики не будут создавать события [*препарефорснапшот*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*разморозить*](vssgloss-t.md)или [*моментальные снимки*](vssgloss-p.md) для этого типа теневой копии.</span><span class="sxs-lookup"><span data-stu-id="69527-134">Providers will not generate [*PrepareForSnapshot*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*Thaw*](vssgloss-t.md), or [*PostSnapshot*](vssgloss-p.md) events for this type of shadow copy.</span></span>

 

 



