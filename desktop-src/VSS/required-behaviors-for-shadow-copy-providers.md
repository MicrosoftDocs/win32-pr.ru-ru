---
description: Поставщик теневого копирования должен соответствовать рекомендациям, чтобы обеспечить совместимость с инициатором запроса.
ms.assetid: 49baeb89-1dc9-45c2-a532-071085a8e52f
title: Требуемые поведения для поставщиков теневого копирования
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f451dea7154a313cd64a3a46fbcc3b5fe663ec12
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692883"
---
# <a name="required-behaviors-for-shadow-copy-providers"></a><span data-ttu-id="91964-103">Требуемые поведения для поставщиков теневого копирования</span><span class="sxs-lookup"><span data-stu-id="91964-103">Required Behaviors for Shadow Copy Providers</span></span>

<span data-ttu-id="91964-104">Поставщик теневого копирования должен соответствовать рекомендациям, чтобы обеспечить совместимость с инициатором запроса.</span><span class="sxs-lookup"><span data-stu-id="91964-104">A shadow copy provider must conform to guidelines to ensure requester compatibility.</span></span> <span data-ttu-id="91964-105">Во время выполнения приложение резервного копирования или любой другой инициатор запроса, использующий теневые копии, должен работать правильно без знания конкретных сведений о реализации поставщика.</span><span class="sxs-lookup"><span data-stu-id="91964-105">At runtime, a backup application or any other requester that uses shadow copies must function correctly without any knowledge of specific provider implementation details.</span></span>

## <a name="automagic-resource-management"></a><span data-ttu-id="91964-106">Управление ресурсами automagic</span><span class="sxs-lookup"><span data-stu-id="91964-106">Automagic Resource Management</span></span>

<span data-ttu-id="91964-107">Инициатор запроса должен просто добавить том в набор теневых копий.</span><span class="sxs-lookup"><span data-stu-id="91964-107">It must be possible for the requester to simply add a volume to a shadow copy set.</span></span> <span data-ttu-id="91964-108">Инициатор запроса может указать атрибуты теневого копирования, такие как **\_ \_ \_ транспортная служба VSS**, переопределяющая **\_ \_ \_ разностная копия, VSS Volsnap** attr и (или) **VSS \_ Volsnap \_ attr \_** в [**\_ \_ \_ контексте моментального снимка VSS**](/windows/desktop/api/Vss/ne-vss-vss_snapshot_context).</span><span class="sxs-lookup"><span data-stu-id="91964-108">The requester can specify shadow copy attributes such as **VSS\_VOLSNAP\_ATTR\_TRANSPORTABLE**, **VSS\_VOLSNAP\_ATTR\_DIFFERENTIAL**, and/or **VSS\_VOLSNAP\_ATTR\_PLEX** in the [**\_VSS\_SNAPSHOT\_CONTEXT**](/windows/desktop/api/Vss/ne-vss-vss_snapshot_context).</span></span> <span data-ttu-id="91964-109">Поставщик должен учитывать эти атрибуты.</span><span class="sxs-lookup"><span data-stu-id="91964-109">The provider must honor those attributes.</span></span> <span data-ttu-id="91964-110">Если эти атрибуты не учитываются, то он должен указывать на то, что набор теневых копий не поддерживается путем установки параметра \* *Пбиссуппортед* в [**ивсшардвареснапшотпровидер:: арелунссуппортед**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) в **значение false**.</span><span class="sxs-lookup"><span data-stu-id="91964-110">If it cannot honor those attributes, then it should indicate that the shadow copy set is unsupported by setting the \**pbIsSupported* in [**IVssHardwareSnapshotProvider::AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) to **FALSE**.</span></span>

<span data-ttu-id="91964-111">Поставщик не должен согласиться на поддержку теневой копии, которую он не может создать.</span><span class="sxs-lookup"><span data-stu-id="91964-111">The provider must never agree to support a shadow copy that it cannot create.</span></span> <span data-ttu-id="91964-112">Если в инициаторе запроса не указан Плекс или разностный атрибут, поставщик должен включить логику автоволшебия для выделения пространства подсистемы для теневого копирования и создания теневой копии с помощью наиболее подходящего метода.</span><span class="sxs-lookup"><span data-stu-id="91964-112">If the requester does not specify a plex or differential attribute, the provider must include automagic logic for allocating subsystem space for the shadow copy and create the shadow copy using the most appropriate method.</span></span> <span data-ttu-id="91964-113">Поставщик оборудования не должен включать API конкретного поставщика для управления необходимыми свойствами теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="91964-113">The hardware provider must not include a provider-specific API for managing required shadow copy properties.</span></span>

## <a name="created-shadow-copy-volumes-are-read-only-and-hidden"></a><span data-ttu-id="91964-114">Тома теневой копии созданы Read-Only и скрыты</span><span class="sxs-lookup"><span data-stu-id="91964-114">Created Shadow Copy Volumes Are Read-Only and Hidden</span></span>

<span data-ttu-id="91964-115">VSS устанавливает флаги на каждом затронутом LUN таким, что результирующие тома теневых копий будут скрыты и доступны только для чтения при обнаружении компьютером под управлением Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="91964-115">VSS sets flags on each affected LUN such that the resulting shadow copy volumes will be hidden and read-only when detected by a computer running Windows Server 2003.</span></span> <span data-ttu-id="91964-116">Буквы дисков и подключенные папки не назначаются автоматически.</span><span class="sxs-lookup"><span data-stu-id="91964-116">Drive letters and mounted folders are not automatically assigned.</span></span> <span data-ttu-id="91964-117">VSS поддерживает эти флаги в течение жизненного цикла теневой копии.</span><span class="sxs-lookup"><span data-stu-id="91964-117">VSS maintains these flags throughout the life cycle of a shadow copy.</span></span>

## <a name="hardware-shadow-copy-luns-must-be-readwrite"></a><span data-ttu-id="91964-118">Аппаратные теневые копии LUN должны быть доступны для чтения и записи</span><span class="sxs-lookup"><span data-stu-id="91964-118">Hardware Shadow Copy LUNs Must Be Read/Write</span></span>

<span data-ttu-id="91964-119">VSS поддерживает аппаратные теневые копии только в том случае, если базовый LUN сопоставлен как доступный для чтения и записи.</span><span class="sxs-lookup"><span data-stu-id="91964-119">VSS supports hardware shadow copies only where the underlying LUN is mapped as read/write.</span></span> <span data-ttu-id="91964-120">Это необходимо сделать до создания теневой копии. его невозможно выполнить после факта.</span><span class="sxs-lookup"><span data-stu-id="91964-120">This must be done before the shadow copy is created; it cannot be done after the fact.</span></span> <span data-ttu-id="91964-121">Поставщики оборудования не должны изменять эти флаги.</span><span class="sxs-lookup"><span data-stu-id="91964-121">Hardware providers should not modify these flags.</span></span> <span data-ttu-id="91964-122">Дополнительные сведения о том, как VSS использует эти флаги, см. [в разделе процесс создания теневой копии](the-shadow-copy-creation-process.md).</span><span class="sxs-lookup"><span data-stu-id="91964-122">For more information about how VSS uses these flags, see [The Shadow Copy Creation Process](the-shadow-copy-creation-process.md).</span></span>

## <a name="auto-import-hardware-shadow-copies-are-not-supported-on-windows-cluster-service"></a><span data-ttu-id="91964-123">Автоматическое импортирование аппаратных теневых копий не поддерживается в службе кластеров Windows</span><span class="sxs-lookup"><span data-stu-id="91964-123">Auto-Import Hardware Shadow Copies Are Not Supported on Windows Cluster Service</span></span>

<span data-ttu-id="91964-124">Служба кластеров Windows не поддерживает LUN с повторяющимися сигнатурами и разметкой секций.</span><span class="sxs-lookup"><span data-stu-id="91964-124">Windows Cluster service cannot accommodate LUNs with duplicate signatures and partition layout.</span></span> <span data-ttu-id="91964-125">LUN теневой копии должен быть перенесен на узел, находящийся за пределами кластера.</span><span class="sxs-lookup"><span data-stu-id="91964-125">The shadow copy LUNs must be transported to a host outside the cluster.</span></span> <span data-ttu-id="91964-126">Дополнительные сведения см. в статье [быстрое восстановление с помощью переносимых теневых скопированных томов](fast-recovery-using-transportable-shadow-copied-volumes.md).</span><span class="sxs-lookup"><span data-stu-id="91964-126">For more information, see [Fast Recovery Using Transportable Shadow Copied Volumes](fast-recovery-using-transportable-shadow-copied-volumes.md).</span></span>

## <a name="shadow-copies-that-contain-dynamic-disks-must-be-transported-to-a-different-host"></a><span data-ttu-id="91964-127">Теневые копии, содержащие динамические диски, должны переноситься на другой узел</span><span class="sxs-lookup"><span data-stu-id="91964-127">Shadow Copies That Contain Dynamic Disks Must Be Transported to a Different Host</span></span>

<span data-ttu-id="91964-128">**До Windows Server 2008:** Собственная поддержка динамических дисков не может поддерживать LUN с повторяющимися сигнатурами и содержимым базы данных конфигурации.</span><span class="sxs-lookup"><span data-stu-id="91964-128">**Prior to Windows Server 2008:** The native support for dynamic disks cannot accommodate LUNs with duplicate signatures and configuration database contents.</span></span> <span data-ttu-id="91964-129">LUN теневой копии должен быть перенесен на другой узел.</span><span class="sxs-lookup"><span data-stu-id="91964-129">The shadow copy LUNs must be transported to a different host.</span></span> <span data-ttu-id="91964-130">VSS применяет это, не разрешая автоматическое импортирование теневых копий динамических дисков.</span><span class="sxs-lookup"><span data-stu-id="91964-130">VSS enforces this by not allowing auto-import shadow copies of dynamic disks.</span></span> <span data-ttu-id="91964-131">Инициатор запроса не должен импортировать транспортную теневую копию обратно на тот же узел.</span><span class="sxs-lookup"><span data-stu-id="91964-131">A requester should not import a transportable shadow copy back to the same host.</span></span>

<span data-ttu-id="91964-132">**Начиная с Windows Server 2008:** Это ограничение удаляется.</span><span class="sxs-lookup"><span data-stu-id="91964-132">**Beginning with Windows Server 2008:** This limitation is removed.</span></span>

## <a name="providers-are-out-of-process"></a><span data-ttu-id="91964-133">Поставщики вне процесса</span><span class="sxs-lookup"><span data-stu-id="91964-133">Providers Are Out-of-Process</span></span>

<span data-ttu-id="91964-134">Все поставщики должны быть реализованы как необработанные COM-компоненты.</span><span class="sxs-lookup"><span data-stu-id="91964-134">All providers must be implemented as out-of-process COM components.</span></span>

## <a name="time-critical-operations"></a><span data-ttu-id="91964-135">Time-Critical операции</span><span class="sxs-lookup"><span data-stu-id="91964-135">Time-Critical Operations</span></span>

<span data-ttu-id="91964-136">Длительные операции, такие как синхронизация плексов, должны быть инициированы в [**ивсшардвареснапшотпровидер:: бегинпрепареснапшот**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot).</span><span class="sxs-lookup"><span data-stu-id="91964-136">Long operations, such as syncing plexes, should be initiated in [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot).</span></span> <span data-ttu-id="91964-137">Эта функция должна запустить асинхронную подготовку и быстро возвращать данные.</span><span class="sxs-lookup"><span data-stu-id="91964-137">This function should start the asynchronous preparation work and return quickly.</span></span> <span data-ttu-id="91964-138">[**Ивсспровидеркреатеснапшотсет:: ендпрепареснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) служит «встречной» функцией — поставщик может подождать синхронно в этом методе для завершения подготовительной работы, запущенной **бегинпрепареснапшот**.</span><span class="sxs-lookup"><span data-stu-id="91964-138">[**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) serves as a "rendezvous" function—the provider can wait synchronously in this method for the completion of the preparation work that was started by **BeginPrepareSnapshot**.</span></span>

<span data-ttu-id="91964-139">Поставщики не должны добавлять задержки в [**ивсспровидеркреатеснапшотсет::P рекоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**Ивсспровидеркреатеснапшотсет:: CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)или [**IVssProviderCreateSnapshotSet::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) , так как приложения фиксируются во время этих вызовов.</span><span class="sxs-lookup"><span data-stu-id="91964-139">Providers must not add delays in [**IVssProviderCreateSnapshotSet::PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**IVssProviderCreateSnapshotSet::CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), or [**IVssProviderCreateSnapshotSet::PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) as applications are frozen during these calls.</span></span> <span data-ttu-id="91964-140">**Коммитснапшотс** должен возвращаться в течение нескольких секунд, так как этот вызов вызывается во время очистки и удерживания, а поддержка ядра VSS отменит сброс и удержание, если выпуск не будет получен в течение 10 секунд, что приведет к сбою VSS при создании теневой копии.</span><span class="sxs-lookup"><span data-stu-id="91964-140">**CommitSnapshots** should return within seconds, because this is called during the Flush and Hold window, and VSS Kernel Support will cancel the Flush and Hold if the release is not received within 10 seconds, which would cause VSS to fail the shadow copy creation process.</span></span> <span data-ttu-id="91964-141">Если для выполнения этого вызова поставщик занимает более нескольких секунд, существует высокая вероятность того, что создание теневой копии завершится ошибкой.</span><span class="sxs-lookup"><span data-stu-id="91964-141">If the provider takes more than a few seconds to complete this call, there is a high probability that the shadow copy creation will fail.</span></span>

## <a name="careful-io-during-commitsnapshots"></a><span data-ttu-id="91964-142">Тщательный ввод-вывод во время Коммитснапшотс</span><span class="sxs-lookup"><span data-stu-id="91964-142">Careful I/O During CommitSnapshots</span></span>

<span data-ttu-id="91964-143">Поставщикам оборудования не нужно выполнять операции ввода-вывода для томов, участвующих в теневой копии, во время [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots).</span><span class="sxs-lookup"><span data-stu-id="91964-143">Hardware providers should not need to do any I/O to the volumes involved in the shadow copy during [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots).</span></span> <span data-ttu-id="91964-144">Если требуется любой ввод-вывод, поставщики не должны инициировать операции ввода-вывода для исходного тома при обработке метода **коммитснапшотс** .</span><span class="sxs-lookup"><span data-stu-id="91964-144">If any I/O is required, providers must not initiate any I/O to an original volume while handling the **CommitSnapshots** method.</span></span>

<span data-ttu-id="91964-145">Во время [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)драйверы поддержки ядра VSS блокируют ввод-вывод для исходных томов, для которых выполняется теневое копирование.</span><span class="sxs-lookup"><span data-stu-id="91964-145">During [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), VSS Kernel Support drivers block I/O to the original volumes that are being shadow copied.</span></span> <span data-ttu-id="91964-146">Если поставщик использует синхронный ввод-вывод для тома, который находится в наборе теневых копий, операции ввода-вывода будут заблокированы, и процесс фиксации теневой копии будет блокироваться.</span><span class="sxs-lookup"><span data-stu-id="91964-146">If the provider uses synchronous I/O to a volume which is in the shadow copy set, then that I/O will be blocked and the shadow copy commit process will be deadlocked.</span></span> <span data-ttu-id="91964-147">Поставщик не должен вызывать API-интерфейсы Win32 во время **коммитснапшотс** , так как они будут иметь высокую вероятность возникновения операций ввода-вывода и взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="91964-147">The provider should not call any Win32 APIs during **CommitSnapshots** as they will have a high probability of causing I/O and a deadlock.</span></span> <span data-ttu-id="91964-148">Время ожидания поддержки ядра VSS приведет к нарушению этой взаимоблокировки через 10 секунд, но это вызовет сбой создания теневой копии.</span><span class="sxs-lookup"><span data-stu-id="91964-148">The VSS Kernel Support timeout will break this deadlock after 10 seconds, but this will cause the shadow copy creation to fail.</span></span>

<span data-ttu-id="91964-149">Если необходимо попытаться выполнить операцию ввода-вывода, она должна выполняться асинхронно.</span><span class="sxs-lookup"><span data-stu-id="91964-149">If I/O must be attempted, it must be performed asynchronously.</span></span> <span data-ttu-id="91964-150">Ввод-вывод не будет выполнен до тех пор, пока все поставщики не будут возвращены из своих методов [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="91964-150">The I/O will not complete until after all providers have returned from their [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods.</span></span> <span data-ttu-id="91964-151">Как правило, лучше выполнять такие операции в вызове [**посткоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="91964-151">In general, it is better to perform such operations in the [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) call.</span></span>

## <a name="readwrite-shadow-copy-luns"></a><span data-ttu-id="91964-152">Чтение и запись LUN теневого копирования</span><span class="sxs-lookup"><span data-stu-id="91964-152">Read/Write Shadow Copy LUNs</span></span>

<span data-ttu-id="91964-153">В этой версии служба VSS поддерживает только LUN для чтения и записи, даже если тома доступны только для чтения.</span><span class="sxs-lookup"><span data-stu-id="91964-153">In this version, VSS supports only read/write shadow copy LUNs even if the volumes are exposed as read-only.</span></span> <span data-ttu-id="91964-154">Причина заключается в том, что системе необходимо изменить такие структуры данных на диске, как:</span><span class="sxs-lookup"><span data-stu-id="91964-154">The reason is that the system needs to change on-disk data structures such as:</span></span>

-   <span data-ttu-id="91964-155">Подпись диска, которая изменяется в процессе теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="91964-155">Disk signature, which changes during the shadow copy process</span></span>
-   <span data-ttu-id="91964-156">Структуры данных, связанные с секциями, включая те, которые указывают, что Секция доступна только для чтения, скрыта, является теневой копией и не должна назначать букву диска.</span><span class="sxs-lookup"><span data-stu-id="91964-156">Partition-related data structures, including those indicating the partition is read-only, hidden, a shadow copy, and should not be assigned a drive letter.</span></span>

## <a name="unique-page-83-information"></a><span data-ttu-id="91964-157">Уникальная страница сведения 83</span><span class="sxs-lookup"><span data-stu-id="91964-157">Unique Page 83 Information</span></span>

<span data-ttu-id="91964-158">Как исходный LUN, так и созданный LUN теневой копии должны иметь по крайней мере один уникальный идентификатор хранилища на странице 83 данных.</span><span class="sxs-lookup"><span data-stu-id="91964-158">Both the original LUN and the newly created shadow copy LUN must have at least one unique storage identifier in the page 83 data.</span></span> <span data-ttu-id="91964-159">По крайней мере один \_ идентификатор хранилища с типом, равным 1, 2, 3 или 8, и Ассоциация 0 должна быть уникальной в ИСХОДНОМ LUN и только что созданном LUN теневой копии.</span><span class="sxs-lookup"><span data-stu-id="91964-159">At least one STORAGE\_IDENTIFIER with a type of 1, 2, 3, or 8, and an association of 0 must be unique on the original LUN and the newly created shadow copy LUN.</span></span>

 

 



