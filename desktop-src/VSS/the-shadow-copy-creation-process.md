---
description: Процесс создания теневой копии
ms.assetid: ca484eec-31c6-4790-9232-3ed67263f6fb
title: Процесс создания теневой копии
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4239e2b671edcaeb35b404d9b9411b43316c0212
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103809850"
---
# <a name="the-shadow-copy-creation-process"></a><span data-ttu-id="e7069-103">Процесс создания теневой копии</span><span class="sxs-lookup"><span data-stu-id="e7069-103">The Shadow Copy Creation Process</span></span>

<span data-ttu-id="e7069-104">Ниже приведено подробное описание роли поставщика оборудования при создании набора теневых копий.</span><span class="sxs-lookup"><span data-stu-id="e7069-104">The following is a detailed description of the hardware provider's role in the creation of a shadow copy set.</span></span> <span data-ttu-id="e7069-105">Схему этого процесса см. в разделе [Создание теневых копий для поставщиков](shadow-copy-creation-for-providers.md).</span><span class="sxs-lookup"><span data-stu-id="e7069-105">For a diagram of this process, see [Shadow Copy Creation for Providers](shadow-copy-creation-for-providers.md).</span></span>

1.  <span data-ttu-id="e7069-106">Когда инициатор запроса добавляет каждый том в набор теневых копий, VSS определяет связанные LUN.</span><span class="sxs-lookup"><span data-stu-id="e7069-106">As the requester adds each volume to the shadow copy set, VSS determines the associated LUNs.</span></span> <span data-ttu-id="e7069-107">Например, составной том может состоять из нескольких LUN.</span><span class="sxs-lookup"><span data-stu-id="e7069-107">For example, a spanned volume could be composed of multiple LUNs.</span></span> <span data-ttu-id="e7069-108">VSS создает исходные [**\_ \_ сведения о LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , используя сведения о физических устройствах для каждого LUN.</span><span class="sxs-lookup"><span data-stu-id="e7069-108">VSS creates an initial [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) using physical device information for each LUN.</span></span>
2.  <span data-ttu-id="e7069-109">VSS вызывает [**арелунссуппортед**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) , чтобы определить, поддерживает ли поставщик теневую копию для этого LUN.</span><span class="sxs-lookup"><span data-stu-id="e7069-109">VSS calls [**AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) to determine if the provider supports a shadow copy for that LUN.</span></span> <span data-ttu-id="e7069-110">Поставщик оборудования использует [**\_ \_ сведения о LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , чтобы определить, поддерживаются ли номера LUN.</span><span class="sxs-lookup"><span data-stu-id="e7069-110">The hardware provider uses the [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) to determine whether the LUNs are supported.</span></span> <span data-ttu-id="e7069-111">Это определение должно иметь значение "все" или "нет" — один и тот же поставщик оборудования должен поддерживать все LUN, участвующие в конкретном томе.</span><span class="sxs-lookup"><span data-stu-id="e7069-111">This determination must be all or nothing—the same hardware provider must support all LUNs contributing to a specific volume.</span></span> <span data-ttu-id="e7069-112">В примере составного тома поставщик не может указать, что он поддерживает только один из LUN, составляющих том.</span><span class="sxs-lookup"><span data-stu-id="e7069-112">In the spanned volume example, the provider cannot indicate that it supports only one of the LUNs that comprise the volume.</span></span>
3.  <span data-ttu-id="e7069-113">Для каждого тома в наборе теневых копий VSS вызывает [**ивсшардвареснапшотпровидер:: бегинпрепареснапшот**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) с тем же массивом [**структур \_ \_ данных LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) .</span><span class="sxs-lookup"><span data-stu-id="e7069-113">For each volume in the shadow copy set, VSS calls [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) with the same array of [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) structures.</span></span> <span data-ttu-id="e7069-114">В рамках одного вызова все LUN в массиве являются уникальными, но один и тот же LUN может появиться в последующем вызове каждый раз, когда один и тот же LUN участвует в нескольких томах.</span><span class="sxs-lookup"><span data-stu-id="e7069-114">Within a single call, all LUNs in the array are unique, but the same LUN may appear in a subsequent call whenever the same LUN contributes to multiple volumes.</span></span> <span data-ttu-id="e7069-115">Поставщик должен правильно справиться с этим случаем.</span><span class="sxs-lookup"><span data-stu-id="e7069-115">The provider must handle that case correctly.</span></span>
4.  <span data-ttu-id="e7069-116">Сразу после [**ивсспровидеркреатеснапшотсет:: ендпрепареснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)служба VSS установит флаги "только для чтения", "скрытый", "без буквы диска" и "теневое копирование" на всех затронутых LUN.</span><span class="sxs-lookup"><span data-stu-id="e7069-116">Immediately after [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots), VSS will set the read-only, hidden, no drive letter, and shadow copy flags on all affected LUNs.</span></span> <span data-ttu-id="e7069-117">Эти флаги реализуются с помощью скрытых секторов на MBR-дисках или в битах, относящихся к операционной системе, в записи заголовка секции на дисках GPT.</span><span class="sxs-lookup"><span data-stu-id="e7069-117">The flags are implemented using hidden sectors on MBR disks or operating-system-specific bits in the partition header entry on GPT disks.</span></span> <span data-ttu-id="e7069-118">Эти флаги приводят к тому, что все тома на затронутых дисках будут отображаться на принимающих компьютерах в качестве только для чтения и скрыты.</span><span class="sxs-lookup"><span data-stu-id="e7069-118">The flags will cause all volumes on the affected disks to be surfaced on the receiving machines as read-only and hidden.</span></span> <span data-ttu-id="e7069-119">Обратите внимание, что скопированные с помощью теневого копирования LUN не были зафиксированы на этом этапе, поэтому в случае сбоя системы флаги будут сняты, а исходный LUN не будет затронуты.</span><span class="sxs-lookup"><span data-stu-id="e7069-119">Note that the shadow-copied LUNs have not been committed at this stage, so that in the event of a system crash, the flags will be cleared and the original LUN will not be affected.</span></span> <span data-ttu-id="e7069-120">То есть все тома исходного LUN будут считаться нормальными — и сохранить их исходные буквы дисков, подключенные папки и состояние чтения и записи.</span><span class="sxs-lookup"><span data-stu-id="e7069-120">That is, all volumes on the original LUN will be treated as normal—and keep their original drive-letter assignments, mounted folders, and read/write status.</span></span>
    > [!Note]  
    > <span data-ttu-id="e7069-121">Поставщики не должны пытаться изменить какие либо флаги LUN.</span><span class="sxs-lookup"><span data-stu-id="e7069-121">Providers should not attempt to modify any of the LUN flags.</span></span>

     

5.  <span data-ttu-id="e7069-122">В [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)теневые копии LUN фиксируются.</span><span class="sxs-lookup"><span data-stu-id="e7069-122">At [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), the shadow copy LUNs are committed.</span></span> <span data-ttu-id="e7069-123">**Коммитснапшотс** должен быть возвращен в течение нескольких секунд, или процесс создания теневой копии, вероятно, завершится ошибкой.</span><span class="sxs-lookup"><span data-stu-id="e7069-123">**CommitSnapshots** should be returned within a few seconds or the whole shadow copy creation process will probably fail.</span></span>
6.  <span data-ttu-id="e7069-124">После [**коммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)VSS очищает флаги для всех исходных LUN, участвующих в теневой копии.</span><span class="sxs-lookup"><span data-stu-id="e7069-124">After [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), VSS clears the flags on all original LUNs involved in the shadow copy.</span></span> <span data-ttu-id="e7069-125">Так как на этом этапе были зафиксированы LUN теневой копии, в LUN теневой копии сохранены эти флаги.</span><span class="sxs-lookup"><span data-stu-id="e7069-125">Since the shadow copy LUNs have been committed at this point, the shadow copy LUNs retain these flags.</span></span>
7.  <span data-ttu-id="e7069-126">После [**ивсспровидеркреатеснапшотсет::P осткоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots)служба VSS очищает флаги LUN (заданный после [**Ивсспровидеркреатеснапшотсет:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)) и уведомляет средства записи о необходимости разморозить их.</span><span class="sxs-lookup"><span data-stu-id="e7069-126">After [**IVssProviderCreateSnapshotSet::PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots), VSS clears the LUN flags (that it set after [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)) and notifies the writers to thaw.</span></span> <span data-ttu-id="e7069-127">Затем служба VSS вызывает методы [**ивсспровидеркреатеснапшотсет::P рефиналкоммитснапшотс**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-prefinalcommitsnapshots) и [**Ивсспровидеркреатеснапшотсет::P ostfinalcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postfinalcommitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="e7069-127">VSS then calls the provider's [**IVssProviderCreateSnapshotSet::PreFinalCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-prefinalcommitsnapshots) and [**IVssProviderCreateSnapshotSet::PostFinalCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postfinalcommitsnapshots) methods.</span></span>
8.  <span data-ttu-id="e7069-128">VSS извлекает массив структур [**\_ \_ данных LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , по одному для каждого созданного LUN теневого копирования путем вызова [**ивсшардвареснапшотпровидер:: жеттаржетлунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns).</span><span class="sxs-lookup"><span data-stu-id="e7069-128">VSS retrieves an array of [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) structures, one for each newly created shadow copy LUN, by calling [**IVssHardwareSnapshotProvider::GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns).</span></span> <span data-ttu-id="e7069-129">Поставщик должен предоставить достаточно информации, чтобы разрешить VSS и поставщику однозначно находить теневые копии в любое время и в любой системе, подключенной к подсистеме.</span><span class="sxs-lookup"><span data-stu-id="e7069-129">The provider must provide enough information to allow VSS and the provider to identify the shadow copies at any later time and on any system connected to the subsystem.</span></span> <span data-ttu-id="e7069-130">На данный момент LUN теневого копирования должен быть недоступен для этого компьютера — поставщик должен использовать какой-либо механизм, отличный от, просто считывая сведения из LUN.</span><span class="sxs-lookup"><span data-stu-id="e7069-130">At this time, the shadow copy LUNs should be inaccessible to this machine—the provider must use some mechanism other than by simply reading the information from the LUN.</span></span>
9.  <span data-ttu-id="e7069-131">Для перепереносимых теневых копий VSS добавляет следующее в документ компонентов резервного копирования, описывающий набор теневых копий:</span><span class="sxs-lookup"><span data-stu-id="e7069-131">For transportable shadow copies, VSS appends the following to the Backup Components Document describing the shadow copy set:</span></span>
    1.  <span data-ttu-id="e7069-132">Исходный массив [**\_ \_ данных LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) для LUN.</span><span class="sxs-lookup"><span data-stu-id="e7069-132">The original LUN [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) array.</span></span>
    2.  <span data-ttu-id="e7069-133">Новый массив [**\_ \_ данных LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) для службы теневого копирования LUN.</span><span class="sxs-lookup"><span data-stu-id="e7069-133">The new shadow copy LUN [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) array.</span></span>
    3.  <span data-ttu-id="e7069-134">Области диска для каждого тома в наборе теневых копий.</span><span class="sxs-lookup"><span data-stu-id="e7069-134">The disk extents for each volume in the shadow copy set.</span></span>
10. <span data-ttu-id="e7069-135">Для автоматического импорта теневых копий начинается процесс импорта.</span><span class="sxs-lookup"><span data-stu-id="e7069-135">For auto-import shadow copies, the import process begins.</span></span> <span data-ttu-id="e7069-136">В [**ивсшардвареснапшотпровидер:: локателунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns)поставщику будут предоставлены [**\_ \_ сведения о LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , созданные в [**жеттаржетлунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) во время создания.</span><span class="sxs-lookup"><span data-stu-id="e7069-136">In [**IVssHardwareSnapshotProvider::LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), the provider will be given the [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) generated in [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) at creation time.</span></span> <span data-ttu-id="e7069-137">Во время **локателунс** поставщик должен сделать эти теневые копии LUN видимыми для системы.</span><span class="sxs-lookup"><span data-stu-id="e7069-137">During **LocateLuns**, the provider should make those shadow copy LUNs visible to the system.</span></span> <span data-ttu-id="e7069-138">Поставщик не должен вызывать повторное сканирование шины.</span><span class="sxs-lookup"><span data-stu-id="e7069-138">The provider should not cause a bus rescan.</span></span> <span data-ttu-id="e7069-139">Служба VSS приведет к тому, что повторное сканирование и перечисление будут разрешать обнаружение LUN с помощью PNP, а тома будут подключены к сети.</span><span class="sxs-lookup"><span data-stu-id="e7069-139">VSS will cause the rescan and enumeration to allow the LUNs to be discovered by PNP and the volumes to come online.</span></span>
11. <span data-ttu-id="e7069-140">VSS вызывает [**ивсшардвареснапшотпровидер:: филлинлунинфо**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) для новых прибывших дисков в системе.</span><span class="sxs-lookup"><span data-stu-id="e7069-140">VSS calls [**IVssHardwareSnapshotProvider::FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) for the newly arrived disks in the system.</span></span> <span data-ttu-id="e7069-141">Служба VSS использует массив [**\_ \_ данных**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) LUN службы теневого копирования LUN из **филлинлунинфо**, сравнивая его **с \_ \_ данными LUN VDS** , созданными во время создания в [**жеттаржетлунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) , и экстенты дисков для каждого тома в наборе теневых копий, чтобы определить вновь поступившие LUN теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="e7069-141">VSS uses the shadow copy LUN [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) array from **FillInLunInfo**, comparing it with the **VDS\_LUN\_INFORMATION** generated during creation in [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) and the disk extents for each volume in the shadow copy set to identify the newly arrived shadow copy LUNs.</span></span>
12. <span data-ttu-id="e7069-142">На этом этапе все тома, содержащиеся в LUN теневого копирования, подключены к скрытым и только для чтения, а VSS имеет сопоставление исходного тома с теневой копией тома.</span><span class="sxs-lookup"><span data-stu-id="e7069-142">At this point, all volumes contained on the shadow copy LUNs are mounted hidden and read-only, and VSS has a mapping from original volume to shadow copy volume.</span></span>

<span data-ttu-id="e7069-143">Поскольку один LUN может содержать части нескольких томов, набор LUN теневого копирования может включать "лишние" тома.</span><span class="sxs-lookup"><span data-stu-id="e7069-143">Because a single LUN can contain portions of multiple volumes, the set of shadow copy LUNs may include "extra" volumes.</span></span> <span data-ttu-id="e7069-144">Эти тома не являются частью набора теневых копий и не должны использоваться, так как они не гарантированно должны быть постоянными.</span><span class="sxs-lookup"><span data-stu-id="e7069-144">Those volumes are not part of the shadow copy set and should not be used as they are not guaranteed to be consistent.</span></span>

<span data-ttu-id="e7069-145">После импорта доступ к теневой копии можно получить с помощью метода [**ивссбаккупкомпонентс:: Query**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query) .</span><span class="sxs-lookup"><span data-stu-id="e7069-145">After import, the shadow copy can be accessed via the [**IVssBackupComponents::Query**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query) method.</span></span> <span data-ttu-id="e7069-146">Теневая копия также может быть представлена в виде буквы диска, подключенной папки или общего доступа с помощью [**ивссбаккупкомпонентс:: експосеснапшот**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-exposesnapshot).</span><span class="sxs-lookup"><span data-stu-id="e7069-146">A shadow copy can also be exposed as a drive letter, mounted folder, or share using [**IVssBackupComponents::ExposeSnapshot**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-exposesnapshot).</span></span> <span data-ttu-id="e7069-147">Набор теневых копий также может быть преобразован в обычный LUN с помощью метода [**ивссбаккупкомпонентс:: бреакснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-breaksnapshotset) .</span><span class="sxs-lookup"><span data-stu-id="e7069-147">A shadow copy set may also be converted to a regular LUN by using the [**IVssBackupComponents::BreakSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-breaksnapshotset) method.</span></span> <span data-ttu-id="e7069-148">В приложениях управления могут использовать соответствующие API управления дисками для дальнейшего управления LUN (например, изменение атрибутов чтения и записи).</span><span class="sxs-lookup"><span data-stu-id="e7069-148">From there management applications can use appropriate disk management APIs to further manage the LUN (such as changing the read/write attributes).</span></span>

### <a name="transportable-shadow-copies-on-a-san"></a><span data-ttu-id="e7069-149">Перепереносимые теневые копии в сети SAN</span><span class="sxs-lookup"><span data-stu-id="e7069-149">Transportable Shadow Copies on a SAN</span></span>

<span data-ttu-id="e7069-150">Начиная с Windows Server 2003, Datacenter Edition и Windows Server 2003, Enterprise Edition, VSS позволяет переносить наборы теневых копий в сети SAN.</span><span class="sxs-lookup"><span data-stu-id="e7069-150">Beginning with Windows Server 2003, Datacenter Edition and Windows Server 2003, Enterprise Edition, VSS enables transportable shadow copy sets on a SAN.</span></span> <span data-ttu-id="e7069-151">С точки зрения поставщика, способного переносить LUN между узлами, между непереносимым и переносимым набором теневых копий не существует различий.</span><span class="sxs-lookup"><span data-stu-id="e7069-151">From the point of view of a provider capable of transporting LUNs between hosts, there is little or no difference between a non-transportable and a transportable shadow copy set.</span></span>

<span data-ttu-id="e7069-152">**Windows server 2003, Standard Edition, Windows Server 2003, Web Edition и Windows XP:** Перепереносимые наборы теневых копий не поддерживаются.</span><span class="sxs-lookup"><span data-stu-id="e7069-152">**Windows Server 2003, Standard Edition, Windows Server 2003, Web Edition and Windows XP:** Transportable shadow copy sets are not supported.</span></span> <span data-ttu-id="e7069-153">Все выпуски Windows Server 2003 с пакетом обновления 1 (SP1) поддерживают переносимые наборы теневых копий.</span><span class="sxs-lookup"><span data-stu-id="e7069-153">All editions of Windows Server 2003 with Service Pack 1 (SP1) support transportable shadow copy sets.</span></span>

<span data-ttu-id="e7069-154">Перепереносимые наборы теневых копий должны создаваться с помощью атрибута **VSS \_ VOLSNAP \_ attr \_** , добавленного к контексту теневой копии, описанному в разделе Перечисление [**\_ \_ \_ \_ атрибутов моментальных снимков тома VSS**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) .</span><span class="sxs-lookup"><span data-stu-id="e7069-154">Transportable shadow copy sets must be created with the **VSS\_VOLSNAP\_ATTR\_TRANSPORTABLE** attribute added to the shadow copy context described by the [**\_VSS\_VOLUME\_SNAPSHOT\_ATTRIBUTES**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) enumeration.</span></span> <span data-ttu-id="e7069-155">Все тома в наборе должны быть перепереносимыми.</span><span class="sxs-lookup"><span data-stu-id="e7069-155">All volumes in the set must be transportable.</span></span> <span data-ttu-id="e7069-156">При возврате успеха из [**ивсшардвареснапшотпровидер:: арелунссуппортед**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported)поставщик указывает, что он не поддерживает LUN, а также может передавать LUN.</span><span class="sxs-lookup"><span data-stu-id="e7069-156">By returning success from [**IVssHardwareSnapshotProvider::AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported), the provider is indicating that not only does it support the LUN, but also that it can transport the LUN.</span></span> <span data-ttu-id="e7069-157">Создание транспортного набора теневых копий завершается, когда VSS записывает сведения о LUN в документ компонентов резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="e7069-157">The creation of a transportable shadow copy set concludes when VSS records the LUN information in the Backup Components Document.</span></span> <span data-ttu-id="e7069-158">Набор теневых копий может быть импортирован только один раз после первоначального создания.</span><span class="sxs-lookup"><span data-stu-id="e7069-158">A shadow copy set may only be imported once after initial creation.</span></span>

<span data-ttu-id="e7069-159">На принимающем компьютере инициатор импортирует набор теневых копий.</span><span class="sxs-lookup"><span data-stu-id="e7069-159">On the receiving machine, the requester imports the shadow copy set.</span></span> <span data-ttu-id="e7069-160">Метод [**ивссбаккупкомпонентс:: импортснапшотс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) использует компоненты резервного копирования, описывающие набор теневых копий в качестве входных данных.</span><span class="sxs-lookup"><span data-stu-id="e7069-160">The [**IVssBackupComponents::ImportSnapshots**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) method uses the Backup Components Document describing the shadow copy set as input.</span></span> <span data-ttu-id="e7069-161">Импорт продолжается следующим образом:</span><span class="sxs-lookup"><span data-stu-id="e7069-161">Importing proceeds by:</span></span>

1.  <span data-ttu-id="e7069-162">VSS формирует массив структур [**\_ \_ данных LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) для теневого копирования из документа компоненты резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="e7069-162">VSS constructs an array of shadow copy [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) structures from the Backup Components Document.</span></span>
2.  <span data-ttu-id="e7069-163">Когда VSS вызывает [**ивсшардвареснапшотпровидер:: локателунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), массив структур [**\_ \_ данных LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , созданный в [**ивсшардвареснапшотпровидер:: жеттаржетлунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) , будет передан поставщику.</span><span class="sxs-lookup"><span data-stu-id="e7069-163">When VSS calls [**IVssHardwareSnapshotProvider::LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), the array of [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) structures generated in [**IVssHardwareSnapshotProvider::GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) will be passed to the provider.</span></span> <span data-ttu-id="e7069-164">При обработке этого метода поставщик должен сделать эти LUN теневой копии видимыми для системы.</span><span class="sxs-lookup"><span data-stu-id="e7069-164">While processing this method, the provider should make those shadow copy LUNs visible to the system.</span></span> <span data-ttu-id="e7069-165">Поставщик не должен вызывать повторное сканирование шины.</span><span class="sxs-lookup"><span data-stu-id="e7069-165">The provider should not cause a bus rescan.</span></span> <span data-ttu-id="e7069-166">VSS запустит повторное сканирование и перечисление, чтобы разрешить обнаружение LUN с помощью PNP и подключить тома к сети.</span><span class="sxs-lookup"><span data-stu-id="e7069-166">VSS will trigger the rescan and enumeration to allow the LUNs to be discovered by PNP and the volumes to come online.</span></span>
3.  <span data-ttu-id="e7069-167">VSS вызывает [**ивсшардвареснапшотпровидер:: филлинлунинфо**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) для новых прибывших дисков в системе.</span><span class="sxs-lookup"><span data-stu-id="e7069-167">VSS calls [**IVssHardwareSnapshotProvider::FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) for the newly arrived disks in the system.</span></span> <span data-ttu-id="e7069-168">VSS использует массив LUN теневого копирования для [**виртуальных \_ структур \_ LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) из **филлинлунинфо**, сравнивая его с **\_ \_ данными LUN VDS** , созданными во время создания набора теневых копий в [**жеттаржетлунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) , и экстенты дисков для каждого тома в наборе теневых копий, чтобы определить вновь поступившие LUN теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="e7069-168">VSS uses the shadow copy LUN array of [**VDS\_LUN\_INFORMATION**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) structures from **FillInLunInfo**, comparing it with the **VDS\_LUN\_INFORMATION** generated during shadow copy set creation in [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) and the disk extents for each volume in the shadow copy set to identify the newly arrived shadow copy LUNs.</span></span>
4.  <span data-ttu-id="e7069-169">На этом этапе все тома, содержащиеся в перенесенных LUN, монтируются как скрытые и доступные только для чтения, а у VSS есть сопоставление исходного тома с Томом теневых копий.</span><span class="sxs-lookup"><span data-stu-id="e7069-169">At this point, all volumes contained on the transported LUNs are mounted hidden and read-only and VSS has a mapping from the original volume to the shadow copy volume.</span></span>

<span data-ttu-id="e7069-170">Как для одного компьютера, так и для транспортного варианта последовательность аналогична, начиная с точки, в которой вызывается [**жеттаржетлунс**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) .</span><span class="sxs-lookup"><span data-stu-id="e7069-170">For both the single machine and transportable case, the sequence is similar starting with the point that [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) is called.</span></span> <span data-ttu-id="e7069-171">При автоматическом импорте шаги выполняются непосредственно после создания.</span><span class="sxs-lookup"><span data-stu-id="e7069-171">For auto-import, the steps happen directly after creation.</span></span>

 

 
