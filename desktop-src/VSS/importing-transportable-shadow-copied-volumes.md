---
description: Иногда желательно создать теневую копию в одной системе, но использовать теневую копию на второй системе.
ms.assetid: 4ec63917-03c0-434e-892e-3d9d4c47740e
title: Импорт переносимых теневых скопированных томов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3d259fbc047d088ee1f7064804a3ee98fe48da1b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104156126"
---
# <a name="importing-transportable-shadow-copied-volumes"></a><span data-ttu-id="9c92e-103">Импорт переносимых теневых скопированных томов</span><span class="sxs-lookup"><span data-stu-id="9c92e-103">Importing Transportable Shadow Copied Volumes</span></span>

<span data-ttu-id="9c92e-104">Иногда желательно создать теневую копию в одной системе, но использовать теневую копию на второй системе.</span><span class="sxs-lookup"><span data-stu-id="9c92e-104">It is sometimes desirable to create a shadow copy on one system, but use the shadow copy on a second system.</span></span>

<span data-ttu-id="9c92e-105">Рассмотрим случай, когда данные для резервного копирования обычно управляются заданной системой (*системоне*) во время нормальной работы и что эти данные физически хранятся в массиве хранения данных или на устройстве.</span><span class="sxs-lookup"><span data-stu-id="9c92e-105">Consider the case where data to be backed up is normally managed by a given system (*systemOne*) during normal operations, and that this data is physically stored on a storage array or an appliance.</span></span>

<span data-ttu-id="9c92e-106">Чтобы минимизировать перебои в *системоне* (поскольку операции резервного копирования могут быть ресурсоемкими), желательно выполнить резервное копирование с помощью *системтво*, сервера резервного копирования, который имеет доступ к тому же массиву хранения данных, что и *системоне*.</span><span class="sxs-lookup"><span data-stu-id="9c92e-106">To minimize any disruption to *systemOne* (because backup operations can be resource intensive), it is desirable to perform the backup using *systemTwo*, a backup server, which has access to the same storage array as *systemOne*.</span></span>

<span data-ttu-id="9c92e-107">Для обеспечения правильной теневой копии — взаимодействия с модулями записи в *системоне* и сохранения состояния в соответствии с текущими задачами — теневая копия должна выполняться *системоне*.</span><span class="sxs-lookup"><span data-stu-id="9c92e-107">To ensure a proper shadow copy—cooperating with the writers on *systemOne* and preserving the state appropriately for ongoing tasks—the shadow copy should be performed by *systemOne*.</span></span>

<span data-ttu-id="9c92e-108">Поэтому *системоне* должен создать [*транспортную теневую копию*](vssgloss-t.md), которая затем будет импортирована *системтво* .</span><span class="sxs-lookup"><span data-stu-id="9c92e-108">Therefore, *systemOne* must create a [*transportable shadow copy*](vssgloss-t.md), which *systemTwo* will then import.</span></span>

<span data-ttu-id="9c92e-109">**Windows server 2003, Standard Edition, Windows Server 2003, Web Edition и Windows XP:** Перепереносимые наборы теневых копий не поддерживаются.</span><span class="sxs-lookup"><span data-stu-id="9c92e-109">**Windows Server 2003, Standard Edition, Windows Server 2003, Web Edition and Windows XP:** Transportable shadow copy sets are not supported.</span></span> <span data-ttu-id="9c92e-110">Все выпуски Windows Server 2003 с пакетом обновления 1 (SP1) поддерживают переносимые наборы теневых копий.</span><span class="sxs-lookup"><span data-stu-id="9c92e-110">All editions of Windows Server 2003 with Service Pack 1 (SP1) support transportable shadow copy sets.</span></span>

<span data-ttu-id="9c92e-111">Типичный пример импорта переносимой теневой копии может быть выполнен следующим образом.</span><span class="sxs-lookup"><span data-stu-id="9c92e-111">A typical example of importing a transportable shadow copy can proceed in the following way:</span></span>

1.  <span data-ttu-id="9c92e-112">Изначально логическая единица (LUN), предоставляемая массивом хранения данных, монтируется как том на *системоне* (скажем, F:).</span><span class="sxs-lookup"><span data-stu-id="9c92e-112">Initially, the logical unit (LUN) that is provided by the storage array is mounted as a volume on *systemOne* (say, F:).</span></span>
2.  <span data-ttu-id="9c92e-113">Запрашивающий объект, выполняющийся на *системоне* , создает экземпляр [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) и продолжает работу, как если бы он был готов к резервному копированию.</span><span class="sxs-lookup"><span data-stu-id="9c92e-113">A requester that is running on *systemOne* instantiates an instance of [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) and proceeds as if it were preparing for a backup.</span></span> <span data-ttu-id="9c92e-114">(Дополнительные сведения см. в разделе [Обзор инициализации резервного копирования](overview-of-backup-initialization.md), [Обзор этапа обнаружения резервных копий](overview-of-the-backup-discovery-phase.md)и [Обзор задач, выполняемых перед резервным копированием](overview-of-pre-backup-tasks.md) .)</span><span class="sxs-lookup"><span data-stu-id="9c92e-114">(See [Overview of Backup Initialization](overview-of-backup-initialization.md), [Overview of the Backup Discovery Phase](overview-of-the-backup-discovery-phase.md), and [Overview of Pre-Backup Tasks](overview-of-pre-backup-tasks.md) for more information.)</span></span>
3.  <span data-ttu-id="9c92e-115">Запрашивающий объект *системоне* изменяет контекст теневого копирования, который обычно используется для локальной операции резервного копирования **( \_ \_ \_ резервное копирование приложений VSS CTX**), чтобы указать, что будет создана транспортная теневая копия (**VSS \_ VOLSNAP attr может быть \_ \_ транспортом**).</span><span class="sxs-lookup"><span data-stu-id="9c92e-115">The requester on *systemOne* modifies the shadow copy context that is typically used for local backup operation (**VSS\_CTX\_APP\_BACKUP**) to indicate that a transportable shadow copy will be created (**VSS\_VOLSNAP\_ATTR\_TRANSPORTABLE**).</span></span> <span data-ttu-id="9c92e-116">Транспортный атрибут можно также добавить в другие контексты теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="9c92e-116">The transportable attribute can be added to other shadow copy contexts as well.</span></span>
4.  <span data-ttu-id="9c92e-117">С помощью контекста теневого копирования **для \_ \_ \_ резервного копирования CTX** для VSS в службе VSS с \| **\_ \_ \_ транспортным** экземпляром, который находится на *системоне* , создает теневую копию путем вызова [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset).</span><span class="sxs-lookup"><span data-stu-id="9c92e-117">With a shadow copy context of **VSS\_CTX\_APP\_BACKUP** \| **VSS\_VOLSNAP\_ATTR\_TRANSPORTABLE**, the requester that is on *systemOne* creates a shadow copy by calling [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset).</span></span>
5.  <span data-ttu-id="9c92e-118">*Системоне* использует [**Ивссбаккупкомпонентс:: савеасксмл**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) для сохранения текущего состояния документа компонентов резервного копирования и [**ивссексаминевритерметадата:: Савеасксмл**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) для сохранения документов метаданных модуля записи каждого модуля записи.</span><span class="sxs-lookup"><span data-stu-id="9c92e-118">*SystemOne* uses [**IVssBackupComponents::SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) to save the current state of the Backup Components Document and [**IVssExamineWriterMetadata::SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) to save each writer's Writer Metadata Documents.</span></span> <span data-ttu-id="9c92e-119">Затем строки XML, содержащие эти документы, становятся доступными для запрашивающей стороны, который выполняется в *системтво*.</span><span class="sxs-lookup"><span data-stu-id="9c92e-119">The XML strings that contain these documents are then made available to a requester that is running on *systemTwo*.</span></span>

    <span data-ttu-id="9c92e-120">Инициатор запроса передает документ компонентов резервного копирования в *системтво*.</span><span class="sxs-lookup"><span data-stu-id="9c92e-120">The requester transfers the Backup Components Document to *systemTwo*.</span></span>

    <span data-ttu-id="9c92e-121">Обратите внимание, что инициатор запроса на *системоне* не освобождает экземпляр [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) в этот момент, если целью теневой копии является резервная копия.</span><span class="sxs-lookup"><span data-stu-id="9c92e-121">Note that the requester on *systemOne* does not release its instance of [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) at this point if the purpose of the shadow copy is for backup.</span></span> <span data-ttu-id="9c92e-122">Интерфейс должен оставаться открытым до тех пор, пока *системтво* успешно не завершит свои операции резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="9c92e-122">The interface should remain open until *systemTwo* successfully finishes its backup operations.</span></span> <span data-ttu-id="9c92e-123">Только тогда инициатор запроса выдает событие [**баккупкомплете**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) , так как некоторые модули записи усекаются журналы и выполняют другие действия после успешной архивации.</span><span class="sxs-lookup"><span data-stu-id="9c92e-123">Only then should the requester issue a [**BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) event since some writers will truncate logs and do other work after a successful backup.</span></span> <span data-ttu-id="9c92e-124">Если целью теневой копии является интеллектуальный анализ данных или другие цели, то на этом шаге интерфейс можно закрыть.</span><span class="sxs-lookup"><span data-stu-id="9c92e-124">If the goal of the shadow copy is data mining or other purposes, then the interface can be closed at this step.</span></span>

6.  <span data-ttu-id="9c92e-125">Затем запрашивающий объект *системтво* вызывает [**Ивссбаккупкомпонентс:: импортснапшотс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) , чтобы получить доступ к теневой копии, созданной инициатором запроса на *системоне*.</span><span class="sxs-lookup"><span data-stu-id="9c92e-125">The requester on *systemTwo* then calls [**IVssBackupComponents::ImportSnapshots**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) to get access to the shadow copy that was created by the requester on *systemOne*.</span></span>
    > [!Note]  
    > <span data-ttu-id="9c92e-126">Инициатор запроса отвечает за сериализацию операции импорта теневого копирования.</span><span class="sxs-lookup"><span data-stu-id="9c92e-126">The requester is responsible for serializing the import shadow copy operation.</span></span> <span data-ttu-id="9c92e-127">Кроме того, если вызов [**ивссбаккупкомпонентс:: импортснапшотс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) завершается СБОЕМ, VSS не будет очищать LUN.</span><span class="sxs-lookup"><span data-stu-id="9c92e-127">Also, if the call to [**IVssBackupComponents::ImportSnapshots**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) fails, the VSS won't clean up LUNs on it's own.</span></span> <span data-ttu-id="9c92e-128">Инициатору запроса необходимо инициировать очистку LUN.</span><span class="sxs-lookup"><span data-stu-id="9c92e-128">The requester has to initiate the cleanup of LUNs.</span></span>

     

7.  <span data-ttu-id="9c92e-129">Инициатор запроса на *системтво* продолжает создавать резервную копию материала с теневым копированием точно так же, как при резервном копировании созданной им теневой копии (см. [Обзор фактической резервной копии файлов](overview-of-actual-backup-of-files.md)).</span><span class="sxs-lookup"><span data-stu-id="9c92e-129">The requester on *systemTwo* proceeds with the backup of the shadow copied material exactly as if it were backing up a shadow copy that it created by itself (see [Overview of Actual Backup Of Files](overview-of-actual-backup-of-files.md)).</span></span>

    <span data-ttu-id="9c92e-130">Инициатор запроса *системтво* получает [*объект устройства*](vssgloss-d.md) теневой копии с помощью [**ивссбаккупкомпонентс:: жетснапшотпропертиес**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getsnapshotproperties) в импортированной теневой копии и добавляет его в начало исходных путей к файлам, полученных из метаданных для доступа к файлам для резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="9c92e-130">The requester on *systemTwo* obtains the shadow copy's [*device object*](vssgloss-d.md) using [**IVssBackupComponents::GetSnapshotProperties**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getsnapshotproperties) on the imported shadow copy and appends that to the beginning of the original file paths that were obtained from the metadata to access files to be backed up.</span></span>

8.  <span data-ttu-id="9c92e-131">После использования теневой копии инициатор запроса на *системтво* должен удалить теневую копию.</span><span class="sxs-lookup"><span data-stu-id="9c92e-131">After using the shadow copy, the requester on *systemTwo* must delete the shadow copy.</span></span> <span data-ttu-id="9c92e-132">Как и в случае с непереносимыми теневыми копиями, если контекст теневой копии указывает на теневые копии с автоматическим освобождением (например, **\_ CTX \_ резервное копирование VSS**), то освобождение [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) на *системтво* вызовет удаление теневой копии службой VSS.</span><span class="sxs-lookup"><span data-stu-id="9c92e-132">As with non-transportable shadow copies, if the shadow copy context indicates auto-release shadow copies (for example, **VSS\_CTX\_BACKUP**), then releasing the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) on *systemTwo* will cause the VSS service to delete the shadow copy.</span></span> <span data-ttu-id="9c92e-133">В противном случае, если контекст указывает на постоянную теневую копию (например, **\_ \_ \_ откат приложения VSS CTX**), инициатор запроса на *системтво* должен явным образом удалить теневую копию.</span><span class="sxs-lookup"><span data-stu-id="9c92e-133">Otherwise, if the context indicates a persistent shadow copy (for example, **VSS\_CTX\_APP\_ROLLBACK**), then the requester on *systemTwo* must explicitly delete the shadow copy.</span></span>

    <span data-ttu-id="9c92e-134">Затем инициатор запроса на *системтво* сигнализирует инициатору запроса на *системоне* , что он завершился с резервной копией переносимой теневой копии.</span><span class="sxs-lookup"><span data-stu-id="9c92e-134">Then the requester on *systemTwo* signals the requester on *systemOne* that it has finished with the backup of the transportable shadow copy.</span></span>

9.  <span data-ttu-id="9c92e-135">После того как инициатор запроса *системоне* получил уведомление о том, что инициатор запроса на *системтво* завершил резервное копирование переносимой теневой копии, он уведомляет модули записи о своей системе, создавая событие [**баккупкомплете**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) с вызовом **ивссбаккупкомпонентс:: баккупкомплете**.</span><span class="sxs-lookup"><span data-stu-id="9c92e-135">After the requester on *systemOne* has received notification that the requester on *systemTwo* has finished the backup of the transportable shadow copy, it notifies the writers on its system by generating a [**BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) event with a call to **IVssBackupComponents::BackupComplete**.</span></span> <span data-ttu-id="9c92e-136">На этом этапе инициатор запроса в *системоне* может освободить свой экземпляр [**ивссбаккупкомпонентс**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents).</span><span class="sxs-lookup"><span data-stu-id="9c92e-136">At this point, the requester on *systemOne* is free to release its instance of [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents).</span></span>

<span data-ttu-id="9c92e-137">**Перепереносимые теневые копии в кластере:** Перепереносимые теневые копии необходимо импортировать из-за пределов кластера, если исходный том подключен в кластере.</span><span class="sxs-lookup"><span data-stu-id="9c92e-137">**Transportable shadow copies in a cluster:** Transportable shadow copies must be imported from outside the cluster as long as the original volume is mounted within the cluster.</span></span> <span data-ttu-id="9c92e-138">Сведения о реализации быстрого восстановления в кластере см. в статье [быстрое восстановление с помощью переносимых теневых скопированных томов](fast-recovery-using-transportable-shadow-copied-volumes.md).</span><span class="sxs-lookup"><span data-stu-id="9c92e-138">For information about implementing a fast recovery in a cluster, see [Fast Recovery Using Transportable Shadow Copied Volumes](fast-recovery-using-transportable-shadow-copied-volumes.md).</span></span>

 

 



