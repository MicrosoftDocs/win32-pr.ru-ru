---
description: в Windows Vista и Windows Server 2008 и более поздних версий разработчик модуля записи VSS или приложения может исключить определенные файлы из теневых копий.
ms.assetid: 4fe1ae94-7b2f-421a-9009-3a7e88822458
title: Исключение файлов из теневых копий
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c39acf8c92d44bcf8786a880b6ae5eb6a88786809f5af1609dee1b342cd2fb65
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118122116"
---
# <a name="excluding-files-from-shadow-copies"></a>Исключение файлов из теневых копий

в Windows Vista и Windows Server 2008 и более поздних версий разработчик модуля записи VSS или приложения может исключить определенные файлы из теневых копий.

Влияние на производительность и область хранения теневых копий (также называемое «областью копирования») файла в теневой копии напрямую связаны с объемом изменений в содержимом файла после создания теневой копии. Кроме того, исключение файлов из теневых копий может замедлить создание теневых копий.

По этим причинам файл должен быть исключен из теневых копий только в том случае, если он большой, не требует значительных изменений между одной теневой копией и следующей и не нуждается в резервном копировании.

Следует исключать только файлы, принадлежащие приложению.

Если \_ в контексте теневого копирования не установлен флаг "VOLSNAP" для VSS, то \_ \_ \_ это означает, что автоматическое восстановление отключено и никакие файлы не могут быть исключены из теневой копии. Дополнительные сведения см. в разделе Перечисление [**\_ \_ \_ \_ атрибутов моментальных снимков тома VSS**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) .

## <a name="using-the-addexcludefilesfromsnapshot-method"></a>Использование метода Аддексклудефилесфромснапшот

Модуль записи VSS может исключить файлы из теневой копии следующим образом:

1.  Вызовите метод [**ивсскреатевритерметадатаекс:: аддексклудефилесфромснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadataex-addexcludefilesfromsnapshot) , чтобы сообщить исключаемые файлы.
2.  В методе [**квссвритер:: онпостснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) модуля записи удалите файлы из теневой копии.

## <a name="using-the-filesnottosnapshot-registry-key"></a>Использование раздела реестра Филесноттоснапшот

> [!Note]  
> Раздел реестра **FilesNotToSnapshot** предназначен для использования только приложениями. Пользователи, пытающиеся использовать этот раздел, сталкиваются с приведенными ниже ограничениями.
>
> -   Он не может удалять файлы из теневой копии, созданной на Windows Server, с помощью функции "Предыдущие версии".
> -   Он не может удалить файлы из теневых копий общих папок.
> -   Он может удалять файлы из теневой копии, созданной с помощью служебной программы [Diskshadow](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc772172(v=ws.11)) , но не может удалять файлы из теневой копии, созданной с помощью программы [vssadmin](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc754968(v=ws.11)) .
> -   Файлы удаляются из теневой копии при наличии соответствующих ресурсов и возможностей. Это означает, что их удаление не гарантируется.

 

Приложение VSS может удалять файлы из теневой копии во время создания теневой копии с помощью следующего раздела реестра:

**HKEY \_ локальный \_ компьютер \\ система \\ CurrentControlSet \\ элемент управления \\ баккупресторе \\ филесноттоснапшот**

Этот раздел реестра содержит \_ несколько \_ SZ значений для каждого приложения, файлы которого можно исключить. Файлы указываются с помощью полных путей, которые могут содержать \* подстановочные знаки.

Во всех случаях запись не учитывается, если нет файлов, соответствующих строке пути.

После добавления файла к соответствующему разделу реестра он удаляется из теневой копии во время создания с помощью модуля записи оптимизации теневого копирования.

Если невозможно указать полный путь, то путь может быть также неявно указан с помощью $UserProfile $ или $AllVolumes $ Variable. Пример:

-   $UserProfile $ \\ каталог \\ имя файла подкаталога \\ .\*
-   $AllVolumes $ \\ темпорарифилес \\ \* .\*

Чтобы сделать путь рекурсивным, добавьте "/s" в конец. Пример:

-   $UserProfile $ \\ каталог \\ подкаталог \\ имя_файла. \* /s
-   $AllVolumes $ \\ темпорарифилес \\ \* . \* /s

Переменная $UserProfile $ вызывает применение строки пути ко всем профилям пользователей на компьютере. Профили пользователей перечисляются путем проверки следующего раздела реестра:

**HKEY \_ \_ \\ программное обеспечение на локальном компьютере \\ Microsoft \\ Windows NT \\ CurrentVersion \\ профилелист**

Переменная $AllVolumes $ вызывает применение строки пути ко всем теневым копиям на компьютере. Например, предположим, что путь имеет значение «$AllVolumes $ \\ темпорарифилес \\ \* . \* /s ", и компьютер имеет три тома: C:, D: и Е:. Если C: и E: содержат путь " \\ темпорарифилес \\ ", а том d: содержит только путь d: \\ Data \\ , дерево каталогов C: \\ темпорарифилес \\ удаляется из теневых копий C:, а дерево каталогов E: \\ темпорарифилес \\ удаляется из теневых копий е:.

Администраторы могут отключить расширение переменной $UserProfile $, используя следующий раздел реестра:

**\_ \_ \\ \\ CurrentControlSet \\ службы \\ \\ Параметры Vss локального компьютера в HKEY System**

В разделе этого раздела реестра укажите Дисаблеусерпрофиликспансион в качестве имени значения, REG \_ DWORD для типа значения и ненулевое значение для данных значения.

## <a name="about-the-filesnottobackup-registry-key"></a>Сведения о разделе реестра Филесноттобаккуп

Раздел реестра **филесноттобаккуп** можно использовать для указания имен файлов и каталогов, которые приложения резервного копирования не должны выполнять резервное копирование или восстановление. Однако они не исключают эти файлы из теневых копий. Дополнительные сведения об этом разделе реестра см. в разделе [разделы реестра и значения для резервного копирования и восстановления](../backup/registry-keys-for-backup-and-restore.md).

 

 
