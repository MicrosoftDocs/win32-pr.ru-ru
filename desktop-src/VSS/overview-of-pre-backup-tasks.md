---
description: Задачи, выполняемые перед резервным копированием в VSS, посвящены созданию теневой копии томов, содержащих данные для резервного копирования.
ms.assetid: e6b082af-719b-4426-8217-0fc940f5884d
title: Общие сведения о задачах, выполняемых перед резервным копированием
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 709345b8aa0421699efe26ad2901cc497b7d4ac0
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692896"
---
# <a name="overview-of-pre-backup-tasks"></a><span data-ttu-id="13443-103">Общие сведения о задачах, выполняемых перед резервным копированием</span><span class="sxs-lookup"><span data-stu-id="13443-103">Overview of Pre-Backup Tasks</span></span>

<span data-ttu-id="13443-104">Задачи, выполняемые перед резервным копированием в VSS, посвящены созданию теневой копии томов, содержащих данные для резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="13443-104">Pre-backup tasks under VSS are focused on creating a shadow copy of the volumes containing data for backup.</span></span> <span data-ttu-id="13443-105">Приложение резервного копирования сохранит данные из теневой копии, а не из фактического тома.</span><span class="sxs-lookup"><span data-stu-id="13443-105">The backup application will save data from the shadow copy, not the actual volume.</span></span> <span data-ttu-id="13443-106">Дополнительные сведения см. в разделе Общие сведения об [обработке резервной копии в VSS](overview-of-processing-a-backup-under-vss.md).</span><span class="sxs-lookup"><span data-stu-id="13443-106">For more information, see [Overview of Processing a Backup Under VSS](overview-of-processing-a-backup-under-vss.md).</span></span>

<span data-ttu-id="13443-107">Инициаторы запроса обычно ожидают подготовки модулей записи к резервному копированию и созданию теневой копии.</span><span class="sxs-lookup"><span data-stu-id="13443-107">Requesters typically wait for writers to prepare for backup and creating the shadow copy.</span></span> <span data-ttu-id="13443-108">Модуль записи должен определить, следует ли принимать участие в резервной копии, и, если это так, настроить свои файлы и обеспечить готовность к архивации и теневому копированию.</span><span class="sxs-lookup"><span data-stu-id="13443-108">The writer must determine if it is to participate in the backup and, if it is, configure its files and itself to be ready for backup and shadow copy.</span></span> <span data-ttu-id="13443-109">В следующей таблице показана последовательность действий и событий, необходимых для подготовки к операции резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="13443-109">The following table shows the sequence of actions and events that are required to prepare for a backup operation.</span></span>



| <span data-ttu-id="13443-110">Действие запросившего</span><span class="sxs-lookup"><span data-stu-id="13443-110">Requester action</span></span>                                                                                                                                                                                                                                                                                                            | <span data-ttu-id="13443-111">Событие</span><span class="sxs-lookup"><span data-stu-id="13443-111">Event</span></span>                                                                      | <span data-ttu-id="13443-112">Действие записи</span><span class="sxs-lookup"><span data-stu-id="13443-112">Writer action</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="13443-113">Инициатор запроса может задать параметры резервного копирования (см [**. раздел ивссбаккупкомпонентс:: сетбаккупоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions)).</span><span class="sxs-lookup"><span data-stu-id="13443-113">The requester can set backup options (see [**IVssBackupComponents::SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions))</span></span>                                                                                                                                                                                          | <span data-ttu-id="13443-114">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-114">None</span></span>                                                                       | <span data-ttu-id="13443-115">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-115">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span data-ttu-id="13443-116">Поддержка добавочных и разностных операций резервного копирования путем проверки любых сохраненных меток резервного копирования (см [**. раздел ивсскомпонент:: жетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp), [**Ивссбаккупкомпонентс:: сетпревиаусбаккупстамп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)).</span><span class="sxs-lookup"><span data-stu-id="13443-116">Support incremental and differential backup operations by examining any stored backup stamps (see [**IVssComponent::GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp), [**IVssBackupComponents::SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp))</span></span>                                               | <span data-ttu-id="13443-117">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-117">None</span></span>                                                                       | <span data-ttu-id="13443-118">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-118">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span data-ttu-id="13443-119">Уведомлять составителей подготовиться к операции резервного копирования с помощью [ **ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)</span><span class="sxs-lookup"><span data-stu-id="13443-119">Notify writers to prepare for a backup operation using [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)</span></span>                                                                                                                                                                              | [<span data-ttu-id="13443-120">*PrepareForBackup*</span><span class="sxs-lookup"><span data-stu-id="13443-120">*PrepareForBackup*</span></span>](vssgloss-p.md)  | <span data-ttu-id="13443-121">Подготовительная Подготовка модуля записи включает определение того, следует ли выполнять резервное копирование файлов, может быть, когда модуль записи участвует в закрепление теневой копии, а также создает метаданные для конкретного модуля записи (см. раздел [**квссвритер:: онпрепаребаккуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup), [**Квссвритер:: испасаффектед**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected), [**ивссвритеркомпонентс**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents), [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**IVssComponent:: GetBackupOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupoptions), [**CVssWriter:: AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected), [**IVssComponent:: SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata)и [**IVssComponent:: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).</span><span class="sxs-lookup"><span data-stu-id="13443-121">Writer preparations include determining if files are to be backed up, whether the writer will participate in the shadow copy freeze, as well as creating writer-specific metadata (see [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup), [**CVssWriter::IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected), [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents), [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**IVssComponent::GetBackupOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupoptions), [**CVssWriter::AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected), [**IVssComponent::SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata), and [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).</span></span> |
| <span data-ttu-id="13443-122">Инициатор запроса ожидает настройки модулей записи для резервного копирования с помощью [**ивссасинк**](/windows/desktop/api/Vss/nn-vss-ivssasync).</span><span class="sxs-lookup"><span data-stu-id="13443-122">The requester waits for writers to set up for backup using [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync).</span></span> <span data-ttu-id="13443-123">Он также должен проверить состояние модуля записи (см [**. раздел ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**Ивссбаккупкомпонентс:: жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)).</span><span class="sxs-lookup"><span data-stu-id="13443-123">It should also verify writer status (see [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus))</span></span>     | <span data-ttu-id="13443-124">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-124">None</span></span>                                                                       | <span data-ttu-id="13443-125">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-125">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span data-ttu-id="13443-126">Инициатор запроса запрашивает теневую копию с помощью [ **ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)</span><span class="sxs-lookup"><span data-stu-id="13443-126">Requester requests a shadow copy using [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)</span></span>                                                                                                                                                                                                    | <span data-ttu-id="13443-127">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-127">None</span></span>                                                                       | <span data-ttu-id="13443-128">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-128">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span data-ttu-id="13443-129">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-129">None</span></span>                                                                                                                                                                                                                                                                                                                        | [<span data-ttu-id="13443-130">*препарефорснапшот*</span><span class="sxs-lookup"><span data-stu-id="13443-130">*PrepareForSnapshot*</span></span>](vssgloss-p.md) | <span data-ttu-id="13443-131">[**Квссвритер:: онпрепареснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot): перевод модуля записи в состояние готовности к теневому копированию.</span><span class="sxs-lookup"><span data-stu-id="13443-131">[**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot): Put the writer into a shadow copy ready state.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| <span data-ttu-id="13443-132">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-132">None</span></span>                                                                                                                                                                                                                                                                                                                        | [<span data-ttu-id="13443-133">*Заморозить*</span><span class="sxs-lookup"><span data-stu-id="13443-133">*Freeze*</span></span>](vssgloss-f.md)                      | <span data-ttu-id="13443-134">[**Квссвритер:: onfreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze): Окончательная настройка перед теневой копией.</span><span class="sxs-lookup"><span data-stu-id="13443-134">[**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze): Final setup before the shadow copy.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| <span data-ttu-id="13443-135">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-135">None</span></span>                                                                                                                                                                                                                                                                                                                        | [<span data-ttu-id="13443-136">*Разморозить*</span><span class="sxs-lookup"><span data-stu-id="13443-136">*Thaw*</span></span>](vssgloss-t.md)                          | <span data-ttu-id="13443-137">[**Квссвритер:: размораживание**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw): нормальная работа (включая ввод-вывод) может быть возобновлена.</span><span class="sxs-lookup"><span data-stu-id="13443-137">[**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw): Normal functioning (including I/O) can resume.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| <span data-ttu-id="13443-138">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-138">None</span></span>                                                                                                                                                                                                                                                                                                                        | [<span data-ttu-id="13443-139">*Моментальный снимок*</span><span class="sxs-lookup"><span data-stu-id="13443-139">*PostSnapshot*</span></span>](vssgloss-p.md)          | <span data-ttu-id="13443-140">[**Квссвритер:: онпостснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot): окончательная очистка процедур подготовки к теневому копированию.</span><span class="sxs-lookup"><span data-stu-id="13443-140">[**CVssWriter::OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot): Final clean ups of shadow copy preparations.</span></span> <span data-ttu-id="13443-141">См. раздел [**ивсскомпонент:: адддифференцедфилесбиластмодифитиме**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) and [**Ивсскомпонент:: сетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span><span class="sxs-lookup"><span data-stu-id="13443-141">See [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) and [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| <span data-ttu-id="13443-142">Инициатор запроса ожидает завершения теневого копирования с помощью: [**ивссасинк**](/windows/desktop/api/Vss/nn-vss-ivssasync), он также должен проверить состояние модуля записи (см [**. Ивссбаккупкомпонентс:: гасервритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**ивссбаккупкомпонентс:: жетвритерстатус**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)</span><span class="sxs-lookup"><span data-stu-id="13443-142">Requester waits for completion of shadow copy using: [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync), it should also verify writer status (see [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)</span></span><br/> | <span data-ttu-id="13443-143">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-143">None</span></span>                                                                       | <span data-ttu-id="13443-144">Нет</span><span class="sxs-lookup"><span data-stu-id="13443-144">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |



 

## <a name="requester-pre-backup-tasks"></a><span data-ttu-id="13443-145">Задачи, выполняемые перед резервным копированием запросившего</span><span class="sxs-lookup"><span data-stu-id="13443-145">Requester Pre-Backup Tasks</span></span>

<span data-ttu-id="13443-146">Кроме того, перед созданием события [**ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) инициатор запроса может также установить параметры резервного копирования для отдельных модулей записи с помощью [**Ивссбаккупкомпонентс:: сетбаккупоптионс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions) в зависимости от особенностей каждого модуля записи и от того, знает ли инициатор запроса.</span><span class="sxs-lookup"><span data-stu-id="13443-146">In addition, before creating a [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event, a requester may also set backup options for individual writers using [**IVssBackupComponents::SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions) depending on the specifics of each writer and whether a requester is aware of them.</span></span>

<span data-ttu-id="13443-147">Для поддержки добавочных и разностных операций инициаторы запроса могут на этом этапе проверить компоненты на наличие меток времени для предыдущей операции резервного копирования (с помощью [**ивсскомпонент:: жетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp)) и использовать эти сведения для установки предыдущей метки времени для процесса записи (с помощью [**Ивссбаккупкомпонентс:: сетпревиаусбаккупстамп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)).</span><span class="sxs-lookup"><span data-stu-id="13443-147">To support incremental and differential operations, requesters may at this point choose to examine components for time stamps of earlier backup operation (using [**IVssComponent::GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp)) and use that information to set a previous time stamp for a writer to process (using [**IVssBackupComponents::SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)).</span></span> <span data-ttu-id="13443-148">Дополнительные сведения см. в статье [добавочные и разностные резервные копии](incremental-and-differential-backups.md) .</span><span class="sxs-lookup"><span data-stu-id="13443-148">See [Incremental and Differential Backups](incremental-and-differential-backups.md) for more information.</span></span>

<span data-ttu-id="13443-149">Инициатор запроса теперь может направлять системные модули записи для завершения подготовительной подготовки и обработки создания теневой копии.</span><span class="sxs-lookup"><span data-stu-id="13443-149">A requester can now direct the system's writers to complete pre-backup preparations and to handle the creation of a shadow copy.</span></span>

<span data-ttu-id="13443-150">Во-первых, инициатор запроса создает событие [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , вызывая [**Ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).</span><span class="sxs-lookup"><span data-stu-id="13443-150">First, the requester generates a [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event by calling [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).</span></span>

<span data-ttu-id="13443-151">После того как все записи, участвующие в участии, возвращали обработку события [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) (которое определяется инициатором запроса с помощью экземпляра интерфейса [**ивссасинк**](/windows/desktop/api/Vss/nn-vss-ivssasync) , возвращенного **PrepareForBackup**), инициатор запроса может инициировать теневую копию путем вызова [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), который, по мере выполнения, создаст события [*препарефорснапшот*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*разморозить*](vssgloss-t.md)и [*моментального снимка*](vssgloss-p.md) для обработки.</span><span class="sxs-lookup"><span data-stu-id="13443-151">After all participating writers return from handling the [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event (which a requester determines by using the instance of the [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync) interface returned by **PrepareForBackup**), the requester can initiate the shadow copy by calling [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), which, as it progresses, will generate [*PrepareForSnapshot*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*Thaw*](vssgloss-t.md), and [*PostSnapshot*](vssgloss-p.md) events for the writers to handle.</span></span>

<span data-ttu-id="13443-152">В некоторых случаях инициатору может не потребоваться создавать теневую копию.</span><span class="sxs-lookup"><span data-stu-id="13443-152">There are some cases where a requester may not need to create a shadow copy.</span></span> <span data-ttu-id="13443-153">В частности, каждый [*набор файлов*](vssgloss-f.md) , управляемых одним из компонентов конкретного модуля записи, имеет файловую маску резервной копии (обозначенную побитовой или из значений [**\_ \_ \_ \_ типа резервной копии спецификации файла VSS**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) ), заданную во время события [*Identify*](vssgloss-i.md) .</span><span class="sxs-lookup"><span data-stu-id="13443-153">Specifically, each [*file set*](vssgloss-f.md) managed by one of a given writer's components has a File Specification Backup mask (indicated by a bitwise OR of [**VSS\_FILE\_SPEC\_BACKUP\_TYPE**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) values) set during the [*Identify*](vssgloss-i.md) event.</span></span> <span data-ttu-id="13443-154">Эта маска определяет, помимо прочего, необходимость теневого копирования системы перед выполнением резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="13443-154">This mask specifies, among other things, whether a file set requires the system to be shadow copied before its backup is performed.</span></span>

<span data-ttu-id="13443-155">Если для резервного копирования наборов файлов на томах требуется теневая копия, то [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) не нужно вызывать.</span><span class="sxs-lookup"><span data-stu-id="13443-155">If no file sets to be backed up on any volumes require a shadow copy, then [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) need not be called.</span></span>

## <a name="writer-pre-backup-tasks"></a><span data-ttu-id="13443-156">Задачи, выполняемые перед резервным копированием модуля записи</span><span class="sxs-lookup"><span data-stu-id="13443-156">Writer Pre-Backup Tasks</span></span>

<span data-ttu-id="13443-157">При обработке события [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) служба VSS вызывает метод [**Квссвритер:: онпрепаребаккуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) средства записи, виртуальный метод, который по умолчанию просто возвращает значение true.</span><span class="sxs-lookup"><span data-stu-id="13443-157">When handling the [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event, VSS will call each writer's [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method, a virtual method, which by default simply returns true.</span></span>

<span data-ttu-id="13443-158">Модули записи могут переопределить эту реализацию по умолчанию и использовать обработку, чтобы найти сведения о предстоящем резервном копировании и принять меры.</span><span class="sxs-lookup"><span data-stu-id="13443-158">Writers can override this default implementation and use the handling to find information about the upcoming backup and take action.</span></span>

<span data-ttu-id="13443-159">Модуль записи может определить сведения о ходе операции резервного копирования, связанные с шаблоном, с помощью следующих методов.</span><span class="sxs-lookup"><span data-stu-id="13443-159">A writer can determine information about the sort of backup operation contemplated by using the following methods:</span></span>

1.  [<span data-ttu-id="13443-160">**Квссвритер:: Жетбаккуптипе**</span><span class="sxs-lookup"><span data-stu-id="13443-160">**CVssWriter::GetBackupType**</span></span>](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-getbackuptype)
2.  [<span data-ttu-id="13443-161">**Квссвритер:: Исбутаблестатебаккедуп**</span><span class="sxs-lookup"><span data-stu-id="13443-161">**CVssWriter::IsBootableStateBackedUp**</span></span>](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-isbootablesystemstatebackedup)
3.  [<span data-ttu-id="13443-162">**Квссвритер:: Арекомпонентсселектед**</span><span class="sxs-lookup"><span data-stu-id="13443-162">**CVssWriter::AreComponentsSelected**</span></span>](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected)

<span data-ttu-id="13443-163">Модуль записи определяет, будут ли файлы, которыми он управляет, участвовать в теневой копии с помощью [**квссвритер:: испасаффектед**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected).</span><span class="sxs-lookup"><span data-stu-id="13443-163">A writer determines if the files it manages will be involved in the shadow copy by using [**CVssWriter::IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected).</span></span>

<span data-ttu-id="13443-164">Более важно, когда VSS вызывает метод [**квссвритер:: онпрепаребаккуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) , он передает экземпляр интерфейса [**ивссвритеркомпонентс**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) , который обеспечивает прямой доступ через интерфейс [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) к соответствующим компонентам, [*явным образом включаемым*](vssgloss-e.md) в документ компонентов резервного копирования инициатора запроса.</span><span class="sxs-lookup"><span data-stu-id="13443-164">More important, when VSS calls the [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method, it passes in an instance of the [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) interface, which allows direct access through the [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) interface to those of its components [*explicitly included*](vssgloss-e.md) in the requester's Backup Components Document.</span></span> <span data-ttu-id="13443-165">Модуль записи использовал экземпляры интерфейса **ивсскомпонент** , определяющие наборы компонентов для получения доступа к его *неявно включаемому* компоненту (см. раздел [Выбор и работа со свойствами компонента](selectability-and-working-with-component-properties.md)).</span><span class="sxs-lookup"><span data-stu-id="13443-165">The writer used the instances of the **IVssComponent** interface that define component sets to gain access to its *implicitly included* component (see [Selectability and working with Component Properties](selectability-and-working-with-component-properties.md)).</span></span>

<span data-ttu-id="13443-166">Во время обработки события [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) модули записи используют интерфейс [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) для выполнения операций по компонентам (или по набору компонентов), в том числе:</span><span class="sxs-lookup"><span data-stu-id="13443-166">During the handling of the [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event, writers use the [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) interface to perform component-by-component (or component set by component set) operations, including:</span></span>

1.  <span data-ttu-id="13443-167">Добавление [*частичных файлов*](vssgloss-p.md) (если поддерживается) путем вызова [**Ивсскомпонент:: аддпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span><span class="sxs-lookup"><span data-stu-id="13443-167">Adding [*partial files*](vssgloss-p.md) (if supported) by calling [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span></span>
2.  <span data-ttu-id="13443-168">Задание любых частных метаданных, которые модуль записи должен будет выполнять для восстановления.</span><span class="sxs-lookup"><span data-stu-id="13443-168">Setting any private metadata that the writer will need to handle the restore.</span></span>
3.  <span data-ttu-id="13443-169">Если модуль записи поддерживает добавочные и разностные резервные копии (см. раздел [добавочное и разностное резервное копирование](incremental-and-differential-backups.md)), выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="13443-169">If the writer supports incremental and differential backups (see [Incremental and Differential Backups](incremental-and-differential-backups.md)), doing the following:</span></span>
    -   <span data-ttu-id="13443-170">Проверка на наличие предыдущих меток времени резервного копирования путем вызова [**ивсскомпонент:: жетпревиаусбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).</span><span class="sxs-lookup"><span data-stu-id="13443-170">Checking for previous backup time stamps by calling [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).</span></span>
    -   <span data-ttu-id="13443-171">Добавление необходимых [*файловых различий*](vssgloss-d.md) путем вызова [**Ивсскомпонент:: адддифференцедфилесбиластмодифитиме**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).</span><span class="sxs-lookup"><span data-stu-id="13443-171">Adding any required [*differenced files*](vssgloss-d.md) by calling [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).</span></span>
    -   <span data-ttu-id="13443-172">Если модуль записи поддерживает схему **\_ \_ метки** времени "BS" VSS, добавляйте строки временной метки резервного копирования в собственном формате модуля записи с помощью [**ивсскомпонент:: сетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span><span class="sxs-lookup"><span data-stu-id="13443-172">If the writer supports the **VSS\_BS\_TIMESTAMPED** schema, adding backup time-stamp strings in the writer's own format using [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span></span>
4.  <span data-ttu-id="13443-173">Инициация очень длительных асинхронных операций, таких как синхронизация данных на нескольких дисках.</span><span class="sxs-lookup"><span data-stu-id="13443-173">Initiating very time-consuming asynchronous operations, such as synchronizing data across multiple disks.</span></span> <span data-ttu-id="13443-174">Это позволит модулю записи продолжать работу во время обработки операции, включая обработку других событий VSS.</span><span class="sxs-lookup"><span data-stu-id="13443-174">This will allow the writer to continue working while the operation is processed, including handling other VSS events.</span></span> <span data-ttu-id="13443-175">Эти операции должны завершаться до события [*Freeze*](vssgloss-f.md) .</span><span class="sxs-lookup"><span data-stu-id="13443-175">These operations must terminate before the [*Freeze*](vssgloss-f.md) event.</span></span>

<span data-ttu-id="13443-176">Вызов [**ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) инициирует теневую копию и создает следующие события, которые должны быть обработаны разработчиками:</span><span class="sxs-lookup"><span data-stu-id="13443-176">The requester's call to [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) initiates the shadow copy and generates the following events for the writers to handle:</span></span>

-   [<span data-ttu-id="13443-177">*препарефорснапшот*</span><span class="sxs-lookup"><span data-stu-id="13443-177">*PrepareForSnapshot*</span></span>](vssgloss-p.md)
-   [<span data-ttu-id="13443-178">*Заморозить*</span><span class="sxs-lookup"><span data-stu-id="13443-178">*Freeze*</span></span>](vssgloss-f.md)
-   [<span data-ttu-id="13443-179">*Разморозить*</span><span class="sxs-lookup"><span data-stu-id="13443-179">*Thaw*</span></span>](vssgloss-t.md)
-   [<span data-ttu-id="13443-180">*Моментальный снимок*</span><span class="sxs-lookup"><span data-stu-id="13443-180">*PostSnapshot*</span></span>](vssgloss-p.md)

<span data-ttu-id="13443-181">Три обработчика модуля записи —[**квссвритер:: онпрепареснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot), [**квссвритер:: onfreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)и [**квссвритер:: размораживание**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)— чистые виртуальные методы, и каждый модуль записи должен реализовать их, а не использовать значения по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="13443-181">Three of the writer's handlers—[**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot), [**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze), and [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)—are pure virtual methods, and each writer must implement them rather than relying on defaults.</span></span> <span data-ttu-id="13443-182">В зависимости от потребностей модуля записи их можно закодировать как фиктивные методы, просто возвращая **значение true**.</span><span class="sxs-lookup"><span data-stu-id="13443-182">Depending on a writer's needs, they may be coded as dummy methods, simply returning **TRUE**.</span></span>

<span data-ttu-id="13443-183">Поскольку обычно промежуток времени между выдачей события [*Freeze*](vssgloss-f.md) и выдачей события [*разморозки*](vssgloss-t.md) , большая часть основной работы по подготовке к теневой копии, такой как завершение работы процессов, создание временных файлов или сток очередей ввода-вывода, будет обрабатываться в [**квссвритер:: онпрепареснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot).</span><span class="sxs-lookup"><span data-stu-id="13443-183">Because there is typically a narrow time window between the issuing of a [*Freeze*](vssgloss-f.md) event and the issuing of a [*Thaw*](vssgloss-t.md) event, most of the major work in preparing for the shadow copy—such as shutting down processes, creating temporary files, or draining I/O queues—would be handled in [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot).</span></span>

<span data-ttu-id="13443-184">Как модуль записи может использовать [**квссвритер:: онпрепареснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) для управления вводом-выводом, прежде чем создание теневой копии сильно зависит от собственной архитектуры модуля записи.</span><span class="sxs-lookup"><span data-stu-id="13443-184">How a writer might use [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) to handle its I/O before the creation of a shadow copy is highly dependent on the writer's own architecture.</span></span>

<span data-ttu-id="13443-185">Все записи, которые могут позволить хранить все операции записи и сохранять данные в абсолютном состоянии перед [*закреплением*](vssgloss-f.md), должны сделать это.</span><span class="sxs-lookup"><span data-stu-id="13443-185">Writers that can afford to hold all writes and keep the data in an absolute consistent state before [*Freeze*](vssgloss-f.md), should do so.</span></span>

<span data-ttu-id="13443-186">Если модуль записи не может заморозить операции ввода-вывода, он должен принять действия по созданию стабильного источника для резервного копирования и уменьшению времени восстановления для теневой копии.</span><span class="sxs-lookup"><span data-stu-id="13443-186">If the writer cannot freeze its I/O, then it should take actions to create a stable source for backup and to reduce the recovery time for a shadow copy.</span></span> <span data-ttu-id="13443-187">Примерами могут служить очередь входящих запросов ввода-вывода или создание повторяющегося набора файлов в [*альтернативном пути*](vssgloss-a.md) , который будет использоваться в качестве источника резервной копии.</span><span class="sxs-lookup"><span data-stu-id="13443-187">Examples of this might include queuing incoming I/O requests or generating a duplicate set of files in an [*alternate path*](vssgloss-a.md) to be used as the source of a backup.</span></span>

<span data-ttu-id="13443-188">Метод [**квссвритер:: onfreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze) выполняет простые и короткие задачи, такие как проверка того, что [**Квссвритер:: онпрепареснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) Left I/O в правильном состоянии и что все асинхронные задачи, запускаемые [**квссвритер:: онпрепаребаккуп**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) завершены.</span><span class="sxs-lookup"><span data-stu-id="13443-188">The [**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze) method performs simple, short tasks such as verifying that the [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) left I/O in the correct state, and that any asynchronous tasks started by [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) completed.</span></span> <span data-ttu-id="13443-189">Этот метод является последней возможностью модуля записи для запрета теневой копии в случае возникновения проблем (см. раздел [ошибки и запреты модуля записи](writer-errors-and-vetoes.md)).</span><span class="sxs-lookup"><span data-stu-id="13443-189">This method is a writer's last chance to veto a shadow copy if there are problems (see [Writer Errors and Vetoes](writer-errors-and-vetoes.md)).</span></span>

<span data-ttu-id="13443-190">Обычно средство записи может возобновить нормальную работу после события [*разморозки*](vssgloss-t.md) : теневая копия не будет немедленно готова к резервному копированию после разморозки, но модуль записи должен возобновить нормальную работу.</span><span class="sxs-lookup"><span data-stu-id="13443-190">It is generally possible for a writer to resume normal operation following a [*Thaw*](vssgloss-t.md) event: a shadow copy may not be immediately ready for backup after the Thaw, but a writer should be able to resume normal operation.</span></span> <span data-ttu-id="13443-191">Поэтому, как правило, [**квссвритер:: размораживание**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) используется модулями записи для возврата в состояние, предшествующее замораживанию.</span><span class="sxs-lookup"><span data-stu-id="13443-191">Therefore, typically [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) is used by writers to return to a pre-freeze state.</span></span> <span data-ttu-id="13443-192">Однако все временные файлы, созданные для поддержки теневой копии, должны оставаться на месте до события [*моментального снимка*](vssgloss-p.md) .</span><span class="sxs-lookup"><span data-stu-id="13443-192">However, any temporary files created to support the shadow copy should be left in place until the [*PostSnapshot*](vssgloss-p.md) event.</span></span> <span data-ttu-id="13443-193">Как правило, для такого рода очистки следует использовать [**квссвритер:: онпостснапшот**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) .</span><span class="sxs-lookup"><span data-stu-id="13443-193">Typically, you would use [**CVssWriter::OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) for this sort of cleanup.</span></span> <span data-ttu-id="13443-194">Так как многие приложения не нуждаются в такой очистке, **квссвритер:: онпостснапшот** является виртуальным методом с реализацией по умолчанию, который просто возвращает **значение true**.</span><span class="sxs-lookup"><span data-stu-id="13443-194">Because many applications do not require this sort of cleanup, **CVssWriter::OnPostSnapshot** is a virtual method with a default implementation that simply returns **TRUE**.</span></span> <span data-ttu-id="13443-195">Если выполняется добавочная или разностная резервная копия, модуль записи может вызывать [**ивсскомпонент:: жетпревиаусбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) и [**Ивсскомпонент:: сетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span><span class="sxs-lookup"><span data-stu-id="13443-195">If an incremental or differential backup is being performed, the writer may call [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) and [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span></span> <span data-ttu-id="13443-196">Дополнительные сведения см. [в разделе роль модуля записи в резервном копировании сложных хранилищ](writer-role-in-backing-up-complex-stores.md).</span><span class="sxs-lookup"><span data-stu-id="13443-196">For more information, see [Writer Role in Backing Up Complex Stores](writer-role-in-backing-up-complex-stores.md).</span></span> <span data-ttu-id="13443-197">В данный момент можно вызвать еще один метод — [**ивсскомпонент:: адддифференцедфилесбиластмодифитиме**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).</span><span class="sxs-lookup"><span data-stu-id="13443-197">Another method that can be called at this time is [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).</span></span>

 

 




