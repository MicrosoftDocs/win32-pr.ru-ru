---
description: Узнайте о роли запрашивающего в добавочных и разностных резервных копиях, которые потребовали тесного взаимодействия между запрашивающими и модулями записи.
ms.assetid: 00391a49-8c81-4518-88a2-741ad5ee4ac3
title: Роль инициатора запроса при резервном копировании сложных хранилищ
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a84dfa1b0b1837bacc2488b6bd9e3ffdd51b92c0
ms.sourcegitcommit: d0eb44d0a95f5e5efbfec3d3e9c143f5cba25bc3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/17/2021
ms.locfileid: "112262186"
---
# <a name="requester-role-in-backing-up-complex-stores"></a>Роль инициатора запроса при резервном копировании сложных хранилищ

Как и все важные операции в VSS, [*добавочные*](vssgloss-i.md) и [*разностные*](vssgloss-d.md) резервные копии потребовали тесного взаимодействия между запрашивающими стороны и модулями записи.

## <a name="backup-type"></a>Тип резервного копирования

Инфраструктура обеспечивает специальную поддержку пяти типов резервных копий. Они описаны ниже.

-   Full (**\_ \_ полная резервная служба VSS**). Файлы будут архивироваться независимо от даты их последнего резервного копирования. Будет обновлен Журнал резервного копирования каждого файла, и этот тип резервного копирования можно использовать в качестве основы для добавочной или разностной резервной копии. Если имеются файлы журнала, они могут быть усечены в результате резервного копирования.

    Для восстановления полной резервной копии требуется только один образ резервной копии.

-   Разностная (**VSS \_ BT \_ разностная**). API VSS используется, чтобы гарантировать копирование только тех файлов, которые были изменены или добавлены с момента последнего полного резервного копирования, на носитель. все промежуточные резервные копии игнорируются. Это могут быть целые файлы или определенные диапазоны в файлах. Разностная резервная копия связана с полной резервной копией и обычно не может быть восстановлена до тех пор, пока не будет восстановлена полная резервная копия. Если имеются файлы журнала, они обычно не усекаются в результате резервного копирования.

    Для восстановления разностной резервной копии требуется исходный образ резервной копии и последняя разностная резервная копия, созданная с момента последнего полного резервного копирования.

-   Добавочная **( \_ \_ добавочная служба VSS**). API VSS используется, чтобы гарантировать копирование только тех файлов, которые были изменены или добавлены с момента последнего полного или добавочного резервного копирования, на носитель. Это могут быть целые файлы или определенные диапазоны в файлах. Некоторые модули записи не позволяют смешивать добавочные резервные копии с разностными резервными копиями. Если имеются файлы журнала, они могут быть усечены в результате резервного копирования.

    Для восстановления добавочной резервной копии требуется исходный образ резервного копирования и все добавочные образы резервных копий, созданные с момента создания исходной резервной копии.

-   Резервная копия журнала (**\_ \_ Журнал VSS BT**). Будет создана резервная копия только файлов журнала модуля записи (файлов, добавленных в компонент с помощью метода [**ивсскреатевритерметадата:: адддатабаселогфилес**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles) и получаемых путем вызова [**Ивссвмкомпонент:: жетдатабаселогфиле**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getdatabaselogfile)). Этот тип резервного копирования относится только к VSS. Резервные копии журналов обычно выполняются довольно часто. Как правило, файл журнала будет усечен в результате резервного копирования.
-   Копирование резервной копии (**\_ BT- \_ копия VSS**). Как и в \_ \_ случае с типом данных BT Full, резервное копирование файлов выполняется независимо от даты их последнего резервного копирования. Однако журнал резервного копирования каждого файла не будет обновлен, и такой тип резервного копирования нельзя использовать в качестве основы для добавочной или разностной резервной копии. Файлы журнала никогда не следует усекать в результате резервного копирования.

<dl> <dt>

<span id="Partial_File_Support"></span><span id="partial_file_support"></span><span id="PARTIAL_FILE_SUPPORT"></span>Частичная поддержка файлов
</dt> <dd>

Некоторые модули записи поддерживают восстановление файлов с помощью перезаписи частей файлов, которыми они управляют. Инициатор запроса может воспользоваться преимуществами этого метода, и если да, то он указывает, что нужно установить сведения в [**ивссбаккупкомпонентс:: сетбаккупстате**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate).

</dd> </dl>

Инициатор запроса указывает, какой тип резервного копирования выполняется с помощью параметра *BackupType* [**Ивссбаккупкомпонентс:: сетбаккупстате**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate). Различные модули записи поддерживают разные типы резервного копирования. После вызова [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) инициатор запроса может определить, какие типы резервного копирования поддерживает данный модуль записи, вызвав [**Ивссексаминевритерметадата:: жетбаккупсчема**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema). Возвращаемое значение является битовой маской, обозначающей поддержку различных типов резервных копий. Служба **VSS \_ В \_ разностной** резервной копии указана поддержка разностного резервного копирования, **\_ \_ добавочного обновления VSS** для добавочного резервного копирования, **\_ \_ журнала "BS** " для резервных копий журналов и **копии " \_ BS \_ " VSS** для резервного копирования. все модули записи должны поддерживать Если модуль записи не поддерживает смешивание добавочных резервных копий с разностными резервными копиями, также будет добавлен флаг с **\_ \_ эксклюзивным \_ добавочным \_ разностным** копированием в VSS. Если инициатор запроса выполняет добавочную или разностную архивацию, а данный модуль записи не поддерживает этот тип резервного копирования, то для этого модуля записи должно быть выполнено полное резервное копирование.

## <a name="backup-stamps"></a>Метки резервного копирования

Добавочные и разностные резервные копии всегда привязаны к предыдущей резервной копии. Существует два способа привязки резервных копий. Для простых хранилищ данных инициатор запроса может вести отслеживание корреляции между резервными копиями. Однако для более сложных хранилищ данных модуль записи должен поддерживать собственную метку времени с помощью резервной копии. Эта метка времени может вести отслеживание расположения журнала, сведений о контрольных точках и т. д. Инициатор запроса может определить, должен ли заданный модуль записи хранить собственную метку времени, проверяя наличие бита **\_ \_ метки времени в VSS** в значении, возвращаемом функцией [**ивссексаминевритерметадата:: жетбаккупсчема**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema).

Для модулей записи, которые хранят метку времени в резервной копии, будет добавлена метка времени при обработке [**ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) или при обработке [**Ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset). Инициатор запроса может получить эту метку времени путем вызова [**ивсскомпонент:: жетбаккупстамп**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp). При выполнении добавочной или разностной резервной копии инициатору запроса необходимо связать текущую резервную копию с предыдущей резервной копией. Для этого необходимо получить метку времени из предыдущей резервной копии определенного компонента и передать ее в функцию [**ивссбаккупкомпонентс:: сетпревиаусбаккупстамп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp) . Это необходимо сделать для каждого компонента, резервная копия которого была создана в предыдущей резервной копии.

## <a name="backing-up-files"></a>Резервное копирование файлов

### <a name="backing-up-files-reported-by-writer"></a>Резервное копирование файлов, сообщаемых модулем записи

Каждая спецификация файла, которую модуль записи добавляет к своим метаданным на этапе Гасервритерметадата, содержит маску типа резервной копии, которая указывает, когда следует выполнять резервное копирование файла. Инициатор запроса определяет, что это за маску, вызывая [**ивссвмфиледеск:: жетбаккуптипемаск**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getbackuptypemask). Значения в этой маске используются, чтобы определить, для каких типов резервного копирования необходимо создать резервную копию спецификации файла. Маска может содержать одно или несколько следующих битовых значений:

<dl> <dt>

<span id="VSS_FSBT_FULL_BACKUP_REQUIRED"></span><span id="vss_fsbt_full_backup_required"></span>**\_ \_ \_ требуется полная резервная копия VSS фсбт \_**
</dt> <dd>

Требуется для полных резервных копий.

</dd> <dt>

<span id="VSS_FSBT_DIFFERENTIAL_BACKUP_REQUIRED"></span><span id="vss_fsbt_differential_backup_required"></span>**\_ \_ требуется разностное \_ резервное копирование VSS фсбт \_**
</dt> <dd>

Требуется для разностного резервного копирования.

</dd> <dt>

<span id="VSS_FSBT_INCREMENTAL_BACKUP_REQUIRED"></span><span id="vss_fsbt_incremental_backup_required"></span>**\_ \_ требуется добавочное \_ резервное копирование VSS фсбт \_**
</dt> <dd>

Требуется для добавочного резервного копирования.

</dd> <dt>

<span id="VSS_FSBT_LOG_BACKUP_REQUIRED"></span><span id="vss_fsbt_log_backup_required"></span>**\_ \_ \_ требуется резервная копия журнала фсбт для VSS \_**
</dt> <dd>

Требуется для резервного копирования журнала.

</dd> <dt>

<span id="VSS_FSBT_ALL_BACKUP_REQUIRED"></span><span id="vss_fsbt_all_backup_required"></span>**\_ФСБТ VSS \_ \_ требуется вся резервная копия \_**
</dt> <dd>

Требуется для всех типов резервных копий; Это значение по умолчанию.

</dd> </dl>

Эта спецификация переопределяет спецификацию селективности компонента. Например, рассмотрим компонент, файлы которого все помечены с помощью **\_ \_ \_ резервной копии журнала \_ фсбт VSS** , но **не \_ \_ требуются для полной \_ резервной копии \_ фсбт VSS**. Предположим, этот компонент не может быть выбран для резервного копирования (*бселектабле* был ложным при вызове [**Ивсскреатевритерметадата:: AddComponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addcomponent) ). В случае резервного копирования журнала это означает, что все файлы в этом компоненте всегда должны быть резервными копиями. Однако в случае полного резервного копирования ни один из файлов не нуждается в резервном копировании, несмотря на тот факт, что избирательность компонента требует резервного копирования.

### <a name="backup-by-last-modify-time"></a>Резервное копирование по времени последнего изменения

Сведения о спецификации файла, указанные на этапе [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) , не предоставляют запрашивающей стороне сведения об изменениях с момента последнего резервного копирования. Один из способов, с помощью которого модуль записи указывает изменения в инициаторе запроса, — использование механизма сравнения файлов. Модуль записи может указать, что необходимо архивировать определенные файлы компонента, только если они были изменены с момента определенного времени; модуль записи может указывать эти файлы либо в [**ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , либо в [**Ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset). Инициатор запроса может определить эти файлы, вызвав [**ивсскомпонент:: жетдифференцедфилескаунт**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfilescount) и [**Ивсскомпонент:: жетдифференцедфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdifferencedfile). Если спецификация файла соответствует одному набору в **ивссбаккупкомпонентс:: гасервритерметадата** (который в настоящее время является допустимым на основе маски типа резервной копии), то сведения о различиях в файле переопределяют предыдущую информацию. то есть файлы, соответствующие спецификации файла, теперь архивируются только в том случае, если они были изменены с момента указанного времени. Время последнего изменения передается с помощью структуры [**fileTime**](/windows/win32/api/minwinbase/ns-minwinbase-filetime) . Если значение этой структуры равно нулю, это означает, что время последнего изменения должно быть определено на основе записи времени последнего резервного копирования.

### <a name="partial-file-backup"></a>Частичная Архивация файлов

Другой способ, позволяющий модулю записи указать изменения в инициаторе запроса, — использовать частичный механизм файлов. Модуль записи может указывать диапазоны байтов в файлах компонентов, для которых необходимо создать резервную копию; модуль записи может указывать эти диапазоны файлов либо в [**ивссбаккупкомпонентс::P репарефорбаккуп**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , либо в [**Ивссбаккупкомпонентс::D оснапшотсет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset). Инициатор запроса может определить эти файлы, вызвав [**ивсскомпонент:: жетпартиалфилекаунт**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfilecount) и [**Ивсскомпонент:: жетпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile). **Ивсскомпонент:: жетпартиалфиле** будет возвращать путь и имя файла, указывающие на файл, и строку диапазонов, указывающую, что необходимо архивировать в файле. Как и в случае с различными файлами, если путь и имя файла соответствуют спецификации файла, заданной модулем записи в [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata), сведения о частичном файле переопределяют предыдущий параметр. Строка Ranges может иметь два формата: она может либо указать диапазоны напрямую, либо указать файл, содержащий сведения о диапазонах. Если указать диапазоны напрямую, синтаксис представляет собой разделенный запятыми список в формате offset1: length1, offset2: length2, где каждое смещение и длина представляют собой 64-разрядное целое число без знака. При указании файла диапазонов необходимо задать для строки Ranges значение File = *filename*, где *filename* — это полный путь к файлу Ranges. Сам файл Ranges представляет собой двоичный файл, отформатированный как список из 64-разрядных целых чисел без знака. Первое целое число указывает, сколько диапазонов представлено в файле. Каждая последующая пара целых чисел представляет смещение и длину диапазона. Инициатору запроса необходимо также выполнить резервное копирование и восстановление этого файла Ranges.

### <a name="file-specification-rules"></a>Правила спецификации файла

Спецификации файлов, добавленные с помощью механизмов сравнения и частичного файла, либо изменяют спецификации файлов, заданные в [**ивссбаккупкомпонентс:: гасервритерметадата**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) , либо добавляют совершенно новые файлы. Если при изменении спецификаций файлов, заданных в **ивссбаккупкомпонентс:: гасервритерметадата** с помощью механизма частичного файла, запрашивающая сторона может заждать, что спецификация файла будет точно соответствовать одной из спецификаций файлов, заданных в компоненте в **Ивссбаккупкомпонентс:: гасервритерметадата**. Спецификация файла не будет частично перекрываться с другой спецификацией файла и не будет соответствовать спецификациям файлов в других компонентах этого модуля. Однако спецификации файлов, добавленные с помощью механизма частичного файла, могут частично перекрывать другую спецификацию файла. Если это так, то спецификация Difference-File или partial-File переопределяет спецификацию, заданную в **ивссбаккупкомпонентс:: гасервритерметадата**. Общие спецификации файлов могут иметь значение альтернативного расположения (возвращаемое функцией [**ивссвмфиледеск:: жеталтернателокатион**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation)), которое указывает на альтернативное место для получения файла во время резервного копирования. Если спецификации файлов, заданные с помощью механизма Difference-File или частичного файла, соответствуют существующей спецификации файлов с альтернативным расположением, данные должны быть получены из этого альтернативного расположения. Если спецификации файлов, заданные с помощью механизмов Difference-File или partial-File, не соответствуют ни одной из существующих спецификаций для компонента, то эти диапазоны файлов теперь должны быть добавлены в резервную копию. Инициатор запроса может предполагать, что только файлы на томах, которые уже были включены в набор теневых копий, будут добавлены с помощью одного из этих механизмов.

### <a name="backup-without-a-shadow-copy"></a>Резервное копирование без теневой копии

Для некоторых типов файлов резервное копирование тома теневой копии может не требоваться. Например, это часто справедливо для файлов журнала базы данных. Так как файлы журналов увеличиваются монотонно, и модуль записи может указать, какие части файла нужно архивировать с помощью частичных файлов, можно создать резервную копию журнала, который будет находиться на исходном томе. В качестве оптимизации модуль записи может отметить, какие файлы нуждаются в теневых копиях для различных типов резервного копирования, используя маску типа резервного копирования. Значение, возвращаемое из [**ивссвмфиледеск:: жетбаккуптипемаск**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getbackuptypemask) , может содержать одно или несколько из следующих битовых значений:

<dl> <dt>

<span id="VSS_FSBT_FULL_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_full_snapshot_required"></span>**\_ \_ \_ требуется полный моментальный снимок VSS фсбт \_**
</dt> <dd>

Для полных резервных копий требуется теневая копия.

</dd> <dt>

<span id="VSS_FSBT_DIFFERENTIAL_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_differential_snapshot_required"></span>**\_ \_ требуется разностный \_ моментальный снимок VSS фсбт \_**
</dt> <dd>

Для разностного резервного копирования требуется теневая копия.

</dd> <dt>

<span id="VSS_FSBT_INCREMENTAL_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_incremental_snapshot_required"></span>**\_ \_ требуется добавочный \_ моментальный снимок VSS фсбт \_**
</dt> <dd>

Для добавочного резервного копирования требуется теневое копирование.

</dd> <dt>

<span id="VSS_FSBT_LOG_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_log_snapshot_required"></span>**\_ \_ \_ требуется моментальный снимок журнала фсбт для VSS \_**
</dt> <dd>

Для резервного копирования журналов требуется теневая копия.

</dd> <dt>

<span id="VSS_FSBT_ALL_SNAPSHOT_REQUIRED"></span><span id="vss_fsbt_all_snapshot_required"></span>**\_ \_ \_ требуется моментальный снимок фсбт для VSS \_**
</dt> <dd>

Для всех типов резервных копий требуется теневая копия; Это значение по умолчанию.

</dd> </dl>

Если конкретный том содержит только те компоненты, для которых не требуется теневая копия для этой резервной копии, инициатор запроса может пропустить шаг создания теневой копии для этого тома. Все данные на этом томе можно скопировать на носитель резервной копии непосредственно из исходного тома.

## <a name="restoring-files"></a>Восстановление файлов

### <a name="sequential-restores"></a>Последовательные восстановления

После выполнения операции восстановления инициатор запроса отправляет событие, выполняемое при восстановлении, во все модули записи. Как правило, модули записи обрабатывали это событие, выполняя восстановление или другие операции, выполняемые после восстановления. Однако восстановление добавочных резервных копий обычно происходит в виде последовательности операций восстановления, по одному на добавочное резервное копирование. Инициатору запроса необходимо сообщить средству записи о том, что выполняется такое восстановление, чтобы предотвратить восстановление или другие нежелательные операции до полного завершения восстановления. Это делается путем вызова [**ивссбаккупкомпонентс:: сетаддитионалресторес**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setadditionalrestores). Этот метод вызывается для каждого компонента и указывает средству записи, что для этого компонента поступают дополнительные восстановления. Для окончательного восстановления в последовательности флагу дополнительных восстановлений следует присвоить значение false (по умолчанию), которое указывает, что это последнее восстановление в последовательности для этого компонента.

### <a name="new-targets"></a>Новые цели

Если поддерживается модулем записи, инициатор запроса может восстановить файлы данных в расположении, отличном от исходного расположения времени резервного копирования. Инициатор запроса может проверить эту поддержку, вызвав [**ивссексаминевритерметадата:: жетбаккупсчема**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getbackupschema). **\_ Модуль записи "BS" VSS \_ \_ поддерживает \_ новый \_ целевой** бит, если модуль записи поддерживает такое поведение. Инициатор запроса информирует средство записи о новом расположении, вызывая [**ивссбаккупкомпонентс:: аддневтаржет**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addnewtarget) для каждой переходящей спецификации файла. Инициатор запроса может также решить восстановить заданный файл диапазонов в другом расположении. Инициатор запроса информирует средство записи об этом изменении, вызывая [**ивссбаккупкомпонентс:: сетранжесфилепас**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrangesfilepath).

### <a name="directed-targets"></a>Направленные целевые объекты

Для сложных сценариев восстановления разработчику может потребоваться сопоставлять диапазоны резервного файла с различными диапазонами того же или другого файла. Это можно сделать с помощью направленного целевого механизма. Инициатор запроса может определить после этапа повторного [**восстановления ивссбаккупкомпонентс::P**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) , что этот механизм используется для компонента путем вызова [**Ивсскомпонент:: жетресторетаржет**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoretarget) и проверки возврата **службы VSS \_ RT \_**. Инициатор запроса может по сравнению с получением всех этих перенаправленных восстановлений путем вызова [**ивсскомпонент:: жетдиректедтаржеткаунт**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdirectedtargetcount) и [**Ивсскомпонент:: жетдиректедтаржет**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getdirectedtarget). **Ивсскомпонент:: жетдиректедтаржет** будет возвращать полный путь к исходному файлу в резервной копии и полный путь к целевому файлу, который будет восстановлен. Он также возвращает список диапазонов для каждого из этих файлов. Затем инициатор запроса отвечает за восстановление указанных диапазонов в исходном файле на сопоставленные диапазоны в целевом файле. Формат строки диапазонов такой же, как и в [**ивсскомпонент:: жетпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile).

-   [Роль модуля записи в добавочных и разностных резервных копиях VSS](writer-role-in-vss-incremental-and-differential-backups.md)
-   [Роль инициатора запроса в добавочных и разностных резервных копиях VSS](requestor-role-in-vss-incremental-and-differential-backups.md)

 

 
