---
description: Существует множество причин, по которым запрашивающая сторона не должна иметь возможности восстановить файлы с резервного носителя в исходное расположение.
ms.assetid: 2a9cfd99-5a2c-4c0c-98ff-11c745298cda
title: Работа с альтернативными расположениями во время восстановления
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1338d76f98153ccb388e86e738b408c03dd253b4
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692340"
---
# <a name="working-with-alternate-locations-during-restore"></a><span data-ttu-id="8b02b-103">Работа с альтернативными расположениями во время восстановления</span><span class="sxs-lookup"><span data-stu-id="8b02b-103">Working with Alternate Locations during Restore</span></span>

<span data-ttu-id="8b02b-104">Существует множество причин, по которым запрашивающая сторона не должна иметь возможности восстановить файлы с резервного носителя в исходное расположение.</span><span class="sxs-lookup"><span data-stu-id="8b02b-104">There are many reasons why a requester either should not, or may not, be able to restore files from backup media to their original location.</span></span> <span data-ttu-id="8b02b-105">Например, метод восстановления или целевой объект может потребовать такого восстановления, либо текущее расположение восстановления может быть занято и недоступно для записи.</span><span class="sxs-lookup"><span data-stu-id="8b02b-105">For example, a restore method or target may require such a restoration, or the current restoration location may be occupied and unwritable.</span></span>

<span data-ttu-id="8b02b-106">Для таких случаев модуль записи может определить [*альтернативное сопоставление расположения*](vssgloss-a.md), нестандартное назначение восстановления, которое будет использоваться в особых обстоятельствах.</span><span class="sxs-lookup"><span data-stu-id="8b02b-106">To handle such cases, a writer may have defined an [*alternate location mapping*](vssgloss-a.md), a nonstandard restore destination to be used for special circumstances.</span></span>

<span data-ttu-id="8b02b-107">Термин альтернативное сопоставление местоположения, используемый в VSS, не следует путать с термином [*альтернативный путь*](vssgloss-a.md).</span><span class="sxs-lookup"><span data-stu-id="8b02b-107">The term alternate location mapping, as used with VSS, should not be confused with the term [*alternate path*](vssgloss-a.md).</span></span> <span data-ttu-id="8b02b-108">Сопоставления альтернативного расположения используются только во время операций восстановления и ссылаются на альтернативное назначение для операций восстановления.</span><span class="sxs-lookup"><span data-stu-id="8b02b-108">Alternate location mappings are used only during restore operations, and refer to an alternate destination for restore operations.</span></span> <span data-ttu-id="8b02b-109">Альтернативные пути используются только во время операций резервного копирования и относятся к альтернативному источнику, из которого производится резервное копирование.</span><span class="sxs-lookup"><span data-stu-id="8b02b-109">Alternate paths are used only during backup operations, and refer to an alternate source from which to back up.</span></span>

<span data-ttu-id="8b02b-110">Чтобы использовать сопоставления альтернативного расположения во время восстановления, инициатор запроса выдаст следующее (как правило, после создания события, выполняемого перед [**восстановлением**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) ):</span><span class="sxs-lookup"><span data-stu-id="8b02b-110">To use alternate location mappings during restore, a requester would do the following (typically following the generation of a [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) event):</span></span>

1.  <span data-ttu-id="8b02b-111">Используя экземпляр интерфейса [**ивссексаминевритерметадата**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata) , полученный путем извлечения сохраненного модуля записи, запросивший объект использует метод [**Ивссексаминевритерметадата:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) для получения сопоставлений альтернативного расположения модуля записи в качестве экземпляров интерфейса [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) .</span><span class="sxs-lookup"><span data-stu-id="8b02b-111">Using an instance of the [**IVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata) interface obtained by retrieving a stored writer, a requester uses the [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) method to obtain a writer's alternate location mappings as instances of the [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) interface.</span></span>

    > [!Note]  
    > <span data-ttu-id="8b02b-112">Запросивший объект использует [**ивссексаминевритерметадата:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping), а не [**Ивсскомпонент:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span><span class="sxs-lookup"><span data-stu-id="8b02b-112">The requester uses [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping), not [**IVssComponent::GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span></span> <span data-ttu-id="8b02b-113">Первый из них Возвращает сопоставления альтернативного расположения, доступные для использования инициатором запроса.</span><span class="sxs-lookup"><span data-stu-id="8b02b-113">The former returns those alternate location mappings available for use by a requester.</span></span> <span data-ttu-id="8b02b-114">Второй используется для указания на то, что сопоставления альтернативного расположения фактически используются инициатором запроса.</span><span class="sxs-lookup"><span data-stu-id="8b02b-114">The latter is used to indicate those alternate location mappings actually used by a requester.</span></span>

     

2.  <span data-ttu-id="8b02b-115">Вызов метода [**ивссексаминевритерметадата:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) возвращает экземпляр интерфейса [**ивссвмфиледеск**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) .</span><span class="sxs-lookup"><span data-stu-id="8b02b-115">The call to the [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) returns an instance of the [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) interface.</span></span> <span data-ttu-id="8b02b-116">Этот экземпляр содержит сведения о наборе файлов — путь, заданный [**ивссвмфиледеск::**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath)Path, спецификацию файла, возвращаемой с помощью [**Ивссвмфиледеск:: жетфилеспек**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec), и флаг рекурсии, полученный из [**ивссвмфиледеск:: жетрекурсиве**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive), соответствующий одному из добавленных наборов файлов (с помощью [**ивсскреатевритерметадата:: AddDatabaseFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabasefiles), [**IVssCreateWriterMetadata:: AddDatabaseLogFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles)или [**IVssCreateWriterMetadata:: AddFilesToFileGroup**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup)) в один из компонентов, управляемых модулем записи</span><span class="sxs-lookup"><span data-stu-id="8b02b-116">This instance contains file set information—a path specified by [**IVssWMFiledesc::GetPath**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getpath), a file specification returned through [**IVssWMFiledesc::GetFilespec**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getfilespec), and a recursion flag obtained from [**IVssWMFiledesc::GetRecursive**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getrecursive)—matching one of the file sets added (using [**IVssCreateWriterMetadata::AddDatabaseFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabasefiles), [**IVssCreateWriterMetadata::AddDatabaseLogFiles**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-adddatabaselogfiles), or [**IVssCreateWriterMetadata::AddFilesToFileGroup**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadata-addfilestofilegroup)) to one of the components managed by the writer.</span></span>

    <span data-ttu-id="8b02b-117">Значение, возвращаемое функцией [**ивссвмфиледеск:: жеталтернателокатион**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) , является сопоставлением альтернативного расположения для этого набора файлов.</span><span class="sxs-lookup"><span data-stu-id="8b02b-117">The value returned by [**IVssWMFiledesc::GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation) is the alternate location mapping for this file set.</span></span>

3.  <span data-ttu-id="8b02b-118">Сопоставления альтернативного расположения не содержат сведений о компонентах, поэтому необходимо сравнить сведения о наборе файлов (путь, спецификацию файла и флаг рекурсии), полученные путем вызова [**ивссексаминевритерметадата:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) , который содержится в компонентах модуля записи.</span><span class="sxs-lookup"><span data-stu-id="8b02b-118">Alternate location mappings do not contain component information, so it will be necessary to compare the file set information (path, file specification, and recursion flag) obtained by calling [**IVssExamineWriterMetadata::GetAlternateLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getalternatelocationmapping) to that contained by the writer's components.</span></span>

    <span data-ttu-id="8b02b-119">Эти сведения можно найти, просматривая компоненты модуля записи и вызвав [**ивссексаминевритерметадата::-Component**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) , чтобы получить экземпляр интерфейса [**Ивссвмкомпонент**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent) и использовать [**ивссвмкомпонент::-File**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile) для получения экземпляра [**ивссвмфиледеск**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) , содержащего сведения о наборе файлов компонента.</span><span class="sxs-lookup"><span data-stu-id="8b02b-119">This information can be found by iterating over the writer's components and calling [**IVssExamineWriterMetadata::GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) to get an instance of the [**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent) interface and use [**IVssWMComponent::GetFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile) to obtain a [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) instance containing the component file set information.</span></span>

    <span data-ttu-id="8b02b-120">Когда сведения о наборе файлов, возвращаемые экземпляром [**ивссвмфиледеск**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) , получены из [**ивссексаминевритерметадата::**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) и [**ивссвмкомпонент:: Profiler**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile) , полученных из экземпляра **ивссвмфиледеск** , производного от [**ивссвмфиледеск:: GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation), обнаружен компонент, управляющий файлами с указанным сопоставлением с конкретным альтернативным расположением.</span><span class="sxs-lookup"><span data-stu-id="8b02b-120">When the file set information returned by the instance of [**IVssWMFiledesc**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswmfiledesc) obtained from [**IVssExamineWriterMetadata::GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) and [**IVssWMComponent::GetFile**](/windows/desktop/api/VsBackup/nf-vsbackup-ivsswmcomponent-getfile) matches that obtained from the **IVssWMFiledesc** instance derived from [**IVssWMFiledesc::GetAlternateLocation**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswmfiledesc-getalternatelocation), the component managing the files with the specific alternate location mapping has been found.</span></span>

4.  <span data-ttu-id="8b02b-121">После обнаружения компонента инициатор запроса может определить условия, при которых следует использовать альтернативное сопоставление расположения, выполнив следующие действия.</span><span class="sxs-lookup"><span data-stu-id="8b02b-121">Having located the component, the requester can determine the conditions under which an alternate location mapping should be used by doing the following:</span></span>

    -   <span data-ttu-id="8b02b-122">Проверка метода восстановления компонента, полученного путем вызова [**ивссексаминевритерметадата:: жетресторемесод**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getrestoremethod).</span><span class="sxs-lookup"><span data-stu-id="8b02b-122">Examining the component's restore method, which is obtained by calling [**IVssExamineWriterMetadata::GetRestoreMethod**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getrestoremethod).</span></span>
    -   <span data-ttu-id="8b02b-123">Проверка того, переопределяет ли целевой объект восстановления метод Restore, вызывая [**ивсскомпонент:: жетресторетаржет**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoretarget).</span><span class="sxs-lookup"><span data-stu-id="8b02b-123">Checking to see if a restore target overrides the restore method, by calling [**IVssComponent::GetRestoreTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoretarget).</span></span>

        <span data-ttu-id="8b02b-124">Если компонент, найденный в документе метаданных модуля записи, был [*явно включен*](vssgloss-e.md) в резервную копию, экземпляр интерфейса [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) будет соответствовать этому компоненту.</span><span class="sxs-lookup"><span data-stu-id="8b02b-124">If the component found in the Writer Metadata Document had been [*explicitly included*](vssgloss-e.md) in the backup, the instance of the [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) interface will correspond to that component.</span></span> <span data-ttu-id="8b02b-125">Если компонент был [*неявно включен*](vssgloss-i.md) в резервную копию, экземпляр **ивсскомпонент** будет соответствовать компоненту, определяющему набор компонентов, в котором компонент в документе метаданных модуля записи является подкомпонентом.</span><span class="sxs-lookup"><span data-stu-id="8b02b-125">If the component had been [*implicitly included*](vssgloss-i.md) in the backup, then the instance of **IVssComponent** will correspond to the component defining the component set of which the component in the Writer Metadata Document is a subcomponent.</span></span>

5.  <span data-ttu-id="8b02b-126">С помощью этих сведений инициатор запроса может определить на уровне отдельных компонентов, если требуется восстановить заданный набор файлов данного компонента в назначение, определенное с помощью сопоставления альтернативного расположения.</span><span class="sxs-lookup"><span data-stu-id="8b02b-126">With this information, the requester can determine on a component-by-component basis if it needs to restore a given file set of a given component to a destination defined by the alternate location mapping.</span></span>

6.  <span data-ttu-id="8b02b-127">При использовании сопоставления альтернативного расположения запрашивающий объект учитывает дескриптор файла и рекурсивный флаг, а также использует путь, указанный в сопоставлении альтернативного расположения.</span><span class="sxs-lookup"><span data-stu-id="8b02b-127">When using an alternate location mapping, the requester respects the file set's file descriptor and recursive flag and uses the path provided by the alternate location mapping.</span></span>

    <span data-ttu-id="8b02b-128">Инициатор запроса указывает, что во время операции восстановления использовалось сопоставление альтернативного расположения, вызвав метод [**ивссбаккупкомпонентс:: аддалтернативелокатионмаппинг**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addalternativelocationmapping) с данными о расположении по умолчанию для набора файлов, используемое альтернативное расположение для восстановления и имя компонента.</span><span class="sxs-lookup"><span data-stu-id="8b02b-128">The requester indicates that it has used an alternate location mapping during a restore operation by calling the [**IVssBackupComponents::AddAlternativeLocationMapping**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addalternativelocationmapping) with the file set's default location information, the alternate restore destination used, and a component name.</span></span>

    <span data-ttu-id="8b02b-129">Если набор файлов был управляем компонентом, который был явно добавлен в резервную копию, будет использоваться это имя компонента.</span><span class="sxs-lookup"><span data-stu-id="8b02b-129">If the file set was managed by a component that was explicitly included in the backup, that component name will be used.</span></span> <span data-ttu-id="8b02b-130">Если набор файлов был управляем компонентом, который был неявно включен в резервную копию, то используется имя компонента, определяющего набор компонентов, в котором компонент, управляющий набором файлов, является подкомпонентом.</span><span class="sxs-lookup"><span data-stu-id="8b02b-130">If the file set was managed by a component that was implicitly included in the backup, then the name used will be that of the component defining the component set of which the component managing the file set is a subcomponent.</span></span>

<span data-ttu-id="8b02b-131">Модули записи проверяют, восстанавливаются ли наборы файлов из одного из их компонентов в альтернативное сопоставление расположения путем вызова [**ивсскомпонент:: жеталтернателокатионмаппинг**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span><span class="sxs-lookup"><span data-stu-id="8b02b-131">Writers verify whether file sets from one of their components were restored to an alternate location mapping by calling [**IVssComponent::GetAlternateLocationMapping**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getalternatelocationmapping).</span></span>

 

 



