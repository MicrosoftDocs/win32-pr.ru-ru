---
description: Иногда бывает полезно выполнять резервное копирование и восстановление только разделов файлов. Служба VSS предоставляет частичные механизмы файлов, которые, если инициаторы их поддерживают, позволяют модулям записи указывать частичные резервные копии файлов и восстановления.
ms.assetid: 02b74a4e-d69f-4eeb-866a-3399598b7035
title: Работа с частичными файлами
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7194f01df11f6c0e368941e17ef6ab1620b17f67
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692336"
---
# <a name="working-with-partial-files"></a><span data-ttu-id="5bf0a-104">Работа с частичными файлами</span><span class="sxs-lookup"><span data-stu-id="5bf0a-104">Working with Partial Files</span></span>

<span data-ttu-id="5bf0a-105">Иногда бывает полезно выполнять резервное копирование и восстановление только разделов файлов.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-105">It is sometimes useful to back up and restore only sections of files.</span></span> <span data-ttu-id="5bf0a-106">Служба VSS предоставляет [*частичные механизмы файлов*](vssgloss-p.md) , которые, если инициаторы их поддерживают, позволяют модулям записи указывать частичные резервные копии файлов и восстановления.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-106">VSS provides [*partial file*](vssgloss-p.md) mechanisms, which, if requesters support it, allows writers to specify partial file backups and restores.</span></span>

<span data-ttu-id="5bf0a-107">Частичные операции с файлами часто используются для модулей записи, которые поддерживают очень большие файлы, а лишь небольшие доли от изменения между операциями резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-107">Partial file operations are frequently of greatest use to writers that maintain very large files, only a small fraction of which change between backup operations.</span></span> <span data-ttu-id="5bf0a-108">В этом случае часто бывает полезно скопировать только этот раздел, который был изменен на носитель резервной копии.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-108">This being the case, it is frequently useful to copy only that section that changed to backup media.</span></span> <span data-ttu-id="5bf0a-109">По этой причине частичные операции с файлами обычно, но не являются монопольными, используются для поддержки добавочных операций резервного копирования и восстановления.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-109">For this reason, partial file operations are typically, but not exclusively, used to support incremental backup and restore operations.</span></span>

<span data-ttu-id="5bf0a-110">Если модуль записи хочет реализовать операцию с частичным файлом, он использует [**квссвритер:: испартиалфилесуппортенаблед**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispartialfilesupportenabled) , чтобы определить, поддерживает ли инициатор запроса, с которым он работает, операцию.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-110">If a writer wants to implement a partial file operation, it uses [**CVssWriter::IsPartialFileSupportEnabled**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispartialfilesupportenabled) to determine whether the requester it is working with supports the operation.</span></span>

<span data-ttu-id="5bf0a-111">Если инициатор запроса поддерживает частичные операции с файлами и добавляет компонент, управляющий файлом (или компонентом, определяющим набор компонентов, который содержит файл), в документ компонентов резервного копирования, то средство записи указывает, какие разделы файла нужно сохранить (как правило, при обработке события [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) или [*моментального снимка*](vssgloss-p.md) ), вызвав [**ивсскомпонент:: аддпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span><span class="sxs-lookup"><span data-stu-id="5bf0a-111">If the requester supports partial file operations, and if it adds the component that manages the file (or the component that defines the component set that contains the file) to the Backup Components Document, a writer indicates which sections of the file to save (typically while handling a [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) or [*PostSnapshot*](vssgloss-p.md) event) by calling [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span></span>

<span data-ttu-id="5bf0a-112">Помимо пути и имени файла, модуль записи предоставляет диапазон, дополнительные сведения о метаданных для [**ивсскомпонент:: аддпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span><span class="sxs-lookup"><span data-stu-id="5bf0a-112">In addition to a path and file name, the writer supplies the range, optional metadata information to [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span></span>

<span data-ttu-id="5bf0a-113">Сведения о диапазоне предоставляются в виде строки, содержащей одно из следующих значений:</span><span class="sxs-lookup"><span data-stu-id="5bf0a-113">The range information is provided as a string that contains either of the following:</span></span>

-   <span data-ttu-id="5bf0a-114">Пары смещений в файл для резервного копирования (в байтах) и длину раздела для резервного копирования (в байтах), смещение и длину, разделенные двоеточием, и каждая пара, разделенная запятыми, например \*Offset1 \***:**_length1_*_,_* \* Offset2 \***:**_length2_.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-114">Pairs of offsets into the file to be backed up (in bytes) and the length of the section to be backed up (in bytes), the offset and length being separated by a colon, and each pair separated by a comma, for example, *Offset1\***:**_Length1_*_,_\* \*Offset2\***:**_Length2_.</span></span>

    <span data-ttu-id="5bf0a-115">Каждое значение представляет собой 64-разрядное целое число (в шестнадцатеричном или десятичном формате), задающее смещение байтов и длину в байтах соответственно.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-115">Each value is a 64-bit integer (in either hexadecimal or decimal format) specifying a byte offset and length in bytes, respectively.</span></span>

-   <span data-ttu-id="5bf0a-116">Полный путь, включая имя файла, в текущей системе файла двоичных диапазонов, содержащий следующие данные:</span><span class="sxs-lookup"><span data-stu-id="5bf0a-116">The full path, including file name, on the current system of a binary ranges file containing the following:</span></span>
    -   <span data-ttu-id="5bf0a-117">Число (выраженное в виде 64-разрядного целого числа) различных диапазонов файлов, содержащихся в файле</span><span class="sxs-lookup"><span data-stu-id="5bf0a-117">The number (expressed as a 64-bit integer) of distinct file ranges contained in the file</span></span>
    -   <span data-ttu-id="5bf0a-118">Каждый диапазон, выраженный в виде пары из 64-разрядных целых чисел: первый член пары, являющийся смещением в копируемом файле (в байтах), а второй элемент — это длина данных для резервного копирования (в байтах).</span><span class="sxs-lookup"><span data-stu-id="5bf0a-118">Each range expressed as a pair of 64-bit integers: the first member of the pair being the offset into the file being backed up (in bytes), and the second member being the length of data to be backed up (in bytes)</span></span>

<span data-ttu-id="5bf0a-119">Если модуль записи использует файл Ranges для указания операции частичного файла, то инициатор запроса должен гарантировать, что резервная копия этого файла (даже если файл не обязательно является частью резервного набора данных по умолчанию) или что сведения о диапазонах на носителе резервной копии сохраняются каким-либо другим способом.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-119">If a writer uses a ranges file to specify a partial file operation, a requester must guarantee that either this file is backed up (even if the file is not necessarily part of the default backup set) or that the ranges information is preserved on the backup media in some other way.</span></span> <span data-ttu-id="5bf0a-120">Если резервная копия сведений о файле Ranges не создана, восстановление частично заархивированного файла будет невозможно.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-120">If the ranges file's information is not backed up, restoring the partially backed up file will be impossible.</span></span>

<span data-ttu-id="5bf0a-121">Модуль записи также может добавлять строку, содержащую метаданные.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-121">The writer can also add a string containing metadata.</span></span> <span data-ttu-id="5bf0a-122">Эти метаданные могут быть в формате, зависящем от модуля записи, так как они предназначены для того, чтобы модуль записи мог проверить все будущие восстановления.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-122">This metadata can be in a writer-specific format because it is intended to allow the writer to validate any future restores.</span></span>

<span data-ttu-id="5bf0a-123">С этой информацией вспомогательный запрашивающий объект может выполнять частичное резервное копирование файлов.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-123">With this information, a supporting requester can perform a partial file backup.</span></span>

<span data-ttu-id="5bf0a-124">В качестве примера рассмотрим большой файл, заголовок которого (байты 64-512) содержит число записей и другие часто обновляемые сведения, а последние данные — в байтах файла (последние 65536 байта), 0x1239E8577A в 0x1239E7577A.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-124">As an example, consider a large file whose header (bytes 64-512) contains a record count and other frequently updated information, and whose most recent data is to be found in the file's last 65536 bytes—bytes 0x1239E8577A to 0x1239E7577A.</span></span>

<span data-ttu-id="5bf0a-125">Модуль записи может указать список диапазонов в виде строки "**64:448, 0x1239E8577A: 65536**."</span><span class="sxs-lookup"><span data-stu-id="5bf0a-125">A writer could specify a range list as the string "**64:448,0x1239E8577A:65536**."</span></span>

<span data-ttu-id="5bf0a-126">При восстановлении и до фактического выполнения операции восстановления инициатор запроса должен проверить, требует ли какие-либо файлов частичную поддержку файлов.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-126">On restore, and prior to actually performing a restore operation, a requester should check to see if any files require partial file support.</span></span>

<span data-ttu-id="5bf0a-127">Для этого инициатор запроса сначала выполняет перебор модулей записи с хранимыми компонентами в своем документе компонентов резервного копирования с помощью [**ивссбаккупкомпонентс:: жетвритеркомпонентскаунт**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) и [**Ивссбаккупкомпонентс:: жетвритеркомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents).</span><span class="sxs-lookup"><span data-stu-id="5bf0a-127">To do this, the requester first iterates over the writers with stored components in its Backup Components Document using [**IVssBackupComponents::GetWriterComponentsCount**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) and [**IVssBackupComponents::GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents).</span></span>

<span data-ttu-id="5bf0a-128">Затем интерфейс [**ивссбаккупкомпонентс:: жетвритеркомпонентс**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents) используется для возвращения экземпляров интерфейса [**ивссвритеркомпонентсекст**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) , которые предоставляют [**ивссвритеркомпонентсекст::-Component**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponent) и [**IVssWriterComponentsExt:: GetComponentCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponentcount), которые позволяют инициатору запроса получать экземпляры [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) .</span><span class="sxs-lookup"><span data-stu-id="5bf0a-128">The [**IVssBackupComponents::GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents) interface is then used to return instances of the [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) interface, which provide [**IVssWriterComponentsExt::GetComponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponent) and [**IVssWriterComponentsExt::GetComponentCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponentcount), that allow the requester to obtain [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) instances.</span></span>

<span data-ttu-id="5bf0a-129">Это позволяет инициатору запроса получать сведения о частично резервном копировании файлов для участия в восстановлении с помощью [**ивсскомпонент:: жетпартиалфилекаунт**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfilecount) и [**Ивсскомпонент:: Жетпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) для экземпляра [**ивсскомпонент**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) , соответствующего компоненту, который управляет файлом (или компонентом, определяющим набор компонентов, который содержит файл).</span><span class="sxs-lookup"><span data-stu-id="5bf0a-129">This allows a requester to obtain information about the partially backed up files to participate in a restore by using [**IVssComponent::GetPartialFileCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfilecount) and [**IVssComponent::GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) for the instance of [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) corresponding to the component that manages the file (or the component that defines the component set that contains the file).</span></span>

<span data-ttu-id="5bf0a-130">Если операция с частичным файлом управлялась файлом диапазонов, этот файл следует восстановить до копирования данных обратно на диск.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-130">If the partial file operation was controlled by a ranges file, that file should be restored prior to copied data back to disk.</span></span> <span data-ttu-id="5bf0a-131">Может произойти, что инициатору запроса требуется скопировать файл Ranges обратно в новое расположение на диске.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-131">It may happen that the requester needed to copy the ranges file back to a new location on disk.</span></span> <span data-ttu-id="5bf0a-132">В этом случае это означает, что это сделано с помощью [**ивссбаккупкомпонентс:: сетранжесфилепас**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrangesfilepath).</span><span class="sxs-lookup"><span data-stu-id="5bf0a-132">In this case, it indicates that it has done so through the [**IVssBackupComponents::SetRangesFilePath**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrangesfilepath).</span></span>

<span data-ttu-id="5bf0a-133">Затем инициатор запроса продолжает копирование данных в соответствующие места назначения восстановления, которые уже находятся на диске.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-133">The requester then proceeds to copy data into the appropriate locations in the restore destination already on disk.</span></span>

<span data-ttu-id="5bf0a-134">Модуль записи (при обработке события [**RESTORE**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) ) путем проверки [**ивсскомпонент:: жетфилересторестатус**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getfilerestorestatus) для файлов, указанных в [**ивсскомпонент:: жетпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile), определяет, была ли операция частичного файла выполнена успешно.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-134">A writer (while handling a [**PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) event), by examining [**IVssComponent::GetFileRestoreStatus**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getfilerestorestatus) for the files indicated by [**IVssComponent::GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile), determines if the partial file operation was successful.</span></span> <span data-ttu-id="5bf0a-135">Модуль записи должен всегда пытаться проверить правильность этого восстановления, используя сведения о смещении и все метаданные, содержащиеся в документе резервные компоненты.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-135">The writer should always attempt to verify the correctness of this restore using the offset information and any metadata included in the Backup Components Document.</span></span>

<span data-ttu-id="5bf0a-136">Если инициатору запроса пришлось восстановить файл Ranges в новом расположении, служба VSS обновит эти сведения, чтобы путь, возвращенный [**ивсскомпонент:: жетпартиалфиле**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) , был правильным.</span><span class="sxs-lookup"><span data-stu-id="5bf0a-136">If the requester has had to restore the ranges file to a new location, VSS will update this information so that the path returned by [**IVssComponent::GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) is correct.</span></span>

 

 
