---
description: Служба реестра Windows поддерживает модуль записи VSS, называемый модулем записи реестра, который позволяет запрашивающим стороне создавать резервные копии системного реестра, используя данные, хранящиеся на теневом скопированном томе.
ms.assetid: 94a45b04-0bdc-4211-bed0-caeabba774af
title: Операции резервного копирования и восстановления реестра в VSS
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: db1a3022ec2fb08b07bcff8b28455ae7154e4c40
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692885"
---
# <a name="registry-backup-and-restore-operations-under-vss"></a><span data-ttu-id="d2e1a-103">Операции резервного копирования и восстановления реестра в VSS</span><span class="sxs-lookup"><span data-stu-id="d2e1a-103">Registry Backup and Restore Operations Under VSS</span></span>

<span data-ttu-id="d2e1a-104">Служба реестра Windows поддерживает модуль записи VSS, называемый модулем записи реестра, который позволяет запрашивающим стороне создавать резервные копии системного реестра, используя данные, хранящиеся на теневом скопированном томе.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-104">The Windows Registry Service supports a VSS writer, called the registry writer, which allows requesters to back up a system registry using data stored on a shadow copied volume.</span></span> <span data-ttu-id="d2e1a-105">Дополнительные сведения о модуле записи реестра см. [в разделе модули записи VSS в Box](in-box-vss-writers.md).</span><span class="sxs-lookup"><span data-stu-id="d2e1a-105">For more information about the registry writer, see [In-Box VSS Writers](in-box-vss-writers.md).</span></span>

<span data-ttu-id="d2e1a-106">Модуль записи реестра выполняет резервное копирование на месте и восстанавливает реестр.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-106">The registry writer performs in-place backups and restores of the registry.</span></span> <span data-ttu-id="d2e1a-107">Кроме того, модуль записи реестра сообщает только о системных кустах; Он не сообщает о пользовательских кустах.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-107">In addition, the registry writer reports only system hives; it does not report user hives.</span></span>

<span data-ttu-id="d2e1a-108">**Windows Server 2003:** Средство записи реестра использует промежуточный файл репозитория (также известный как файл выдам) для хранения данных реестра.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-108">**Windows Server 2003:** The registry writer uses an intermediate repository file (also known as a spit file) to store registry data.</span></span> <span data-ttu-id="d2e1a-109">Кроме того, модуль записи реестра сообщает о кустах системы и пользовательских кустах.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-109">In addition, the registry writer reports system hives and user hives.</span></span>

<span data-ttu-id="d2e1a-110">Идентификатор модуля записи реестра — AFBAB4A2-367D-4D15-A586-71DBB18F8485.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-110">The writer ID for the registry writer is AFBAB4A2-367D-4D15-A586-71DBB18F8485.</span></span>

<span data-ttu-id="d2e1a-111">**Windows XP:** Модуль записи в реестр отсутствует.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-111">**Windows XP:** There is no registry writer.</span></span> <span data-ttu-id="d2e1a-112">Данные реестра сообщаются модулем записи загрузочного состояния, ИДЕНТИФИКАТОРом модуля записи которого является F2436E37-09F5-41AF-9B2A-4CA2435DBFD5.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-112">The registry data is reported by the Bootable State writer, whose writer ID is F2436E37-09F5-41AF-9B2A-4CA2435DBFD5.</span></span>

> [!Note]  
> <span data-ttu-id="d2e1a-113">Корпорация Майкрософт не предоставляет техническую поддержку для разработчиков и ИТ-специалистов по внедрению оперативного восстановления состояния системы в Windows (все выпуски).</span><span class="sxs-lookup"><span data-stu-id="d2e1a-113">Microsoft does not provide developer or IT professional technical support for implementing online system state restores on Windows (all releases).</span></span> <span data-ttu-id="d2e1a-114">Сведения об использовании интерфейсов API и процедур, предоставляемых корпорацией Майкрософт для внедрения оперативного восстановления состояния системы, см. в разделе Ресурсы сообщества, доступные в [центре сообщества MSDN](https://msdn.microsoft.com/community/default.aspx).</span><span class="sxs-lookup"><span data-stu-id="d2e1a-114">For information about using Microsoft-provided APIs and procedures to implement online system state restores, see the community resources available at the [MSDN Community Center](https://msdn.microsoft.com/community/default.aspx).</span></span>

 

> [!Note]  
> <span data-ttu-id="d2e1a-115">Следующие сведения относятся только к Windows Server 2003 и Windows XP.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-115">The following information only applies to Windows Server 2003 and Windows XP.</span></span>

 

## <a name="registry-backup-using-vss"></a><span data-ttu-id="d2e1a-116">Резервное копирование реестра с помощью VSS</span><span class="sxs-lookup"><span data-stu-id="d2e1a-116">Registry Backup Using VSS</span></span>

<span data-ttu-id="d2e1a-117">Модуль записи реестра экспортирует и сохраняет активные файлы реестра в расположениях, заданных параметром CurrentControlSet Control System раздела **hKey \_ локального \_ компьютера** \\  \\  \\  \\ **хивелист**.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-117">The registry writer will export and save active registry files in the locations defined by the key **HKEY\_LOCAL\_MACHINE**\\**System**\\**CurrentControlSet**\\**Control**\\**hivelist**.</span></span>

<span data-ttu-id="d2e1a-118">Имена значений в этой записи реестра указывают на куст реестра, который необходимо сохранить, а данные значения содержат файл, содержащий файл (файл Hive).</span><span class="sxs-lookup"><span data-stu-id="d2e1a-118">The names of the values under this registry entry identify the registry hive to be saved, and the value's data provides the file containing the file (the hive file).</span></span> <span data-ttu-id="d2e1a-119">Файлы Hive указываются в следующем формате: \\ \\  \\  \\ *имя файла* пути к харддискволумексу устройства.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-119">The hive files are specified with the following format: \\Device\\*HarddiskVolumeX*\\*path*\\*filename*.</span></span>

<span data-ttu-id="d2e1a-120">Например, в разделе **hKey \_ локальный \_ компьютер** \\ **System** \\ **CurrentControlSet** \\ **Control** \\ **хивелист** может появиться **\\ системное \\ \\ программное обеспечение реестра**  =  \\ Device \\ HarddiskVolume1 \\ Windows \\ system32 \\ config \\ Software.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-120">For example, under **HKEY\_LOCAL\_MACHINE**\\**System**\\**CurrentControlSet**\\**Control**\\**hivelist**, you might see **\\REGISTRY\\MACHINE\\SOFTWARE** = \\Device\\HarddiskVolume1\\Windows\\System32\\config\\SOFTWARE.</span></span>

<span data-ttu-id="d2e1a-121">Модуль записи реестра обеспечивает сохранение файлов Hive на диске перед его теневой копией.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-121">The registry writer ensures that hive files are saved to disk prior to its shadow copy.</span></span>

<span data-ttu-id="d2e1a-122">При резервном копировании кустов реестра инициатор запроса заменит \\ \\ *харддискволумекс* устройства строкой [*объекта устройства*](vssgloss-d.md) для теневого копирования тома.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-122">When backing up the registry hives, a requester would replace \\Device\\*HarddiskVolumeX* with the [*device object*](vssgloss-d.md) string of the volume's shadow copy.</span></span>

> [!Note]  
> <span data-ttu-id="d2e1a-123">\\Путь к \\ *харддискволумексу* устройства можно преобразовать в эквивалентный путь Win32 с помощью функции [**куеридосдевице**](/windows/win32/api/fileapi/nf-fileapi-querydosdevicew) .</span><span class="sxs-lookup"><span data-stu-id="d2e1a-123">You can convert the \\Device\\*HarddiskVolumeX* path to an equivalent Win32 path by using the [**QueryDosDevice**](/windows/win32/api/fileapi/nf-fileapi-querydosdevicew) function.</span></span> <span data-ttu-id="d2e1a-124">Дополнительные сведения см. в разделе [Получение имени файла из маркера файла](../memory/obtaining-a-file-name-from-a-file-handle.md) или [Отображение имен путей к томам](../fileio/displaying-volume-paths.md).</span><span class="sxs-lookup"><span data-stu-id="d2e1a-124">For more information, see [Obtaining a File Name From a File Handle](../memory/obtaining-a-file-name-from-a-file-handle.md) or [Displaying Volume Path Names](../fileio/displaying-volume-paths.md).</span></span>

 

## <a name="registry-restore-using-non-vss-win32-apis"></a><span data-ttu-id="d2e1a-125">Восстановление реестра с помощью API-интерфейсов Win32, отличных от VSS</span><span class="sxs-lookup"><span data-stu-id="d2e1a-125">Registry Restore Using Non-VSS Win32 APIs</span></span>

<span data-ttu-id="d2e1a-126">Для восстановления в режиме «в сети» (в защищенном режиме или полной операционной системе) подразделы в разделе **\_ \_** \\  \\ реестра **CurrentControlSet** \\ **управления** сеансами в системе hKey Machine \\ **Manager** \\ **PendingFileRenameOperations** должны быть сохранены.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-126">For an online (safe mode or full operating system) restore, the subkeys in the **HKEY\_LOCAL\_MACHINE**\\**SYSTEM**\\**CurrentControlSet**\\**Control**\\**Session Manager**\\**PendingFileRenameOperations** registry key must be preserved.</span></span>

<span data-ttu-id="d2e1a-127">Функции [**мовефиликс**](/windows/win32/api/winbase/nf-winbase-movefileexa) и [**мовефилетрансактед**](/windows/win32/api/winbase/nf-winbase-movefiletransacteda) используют этот раздел реестра для хранения сведений о файлах, которые были переименованы с помощью \_ параметра MOVEFILE Delay \_ до \_ reboot в параметре *dwFlags* .</span><span class="sxs-lookup"><span data-stu-id="d2e1a-127">The [**MoveFileEx**](/windows/win32/api/winbase/nf-winbase-movefileexa) and [**MoveFileTransacted**](/windows/win32/api/winbase/nf-winbase-movefiletransacteda) functions use this registry key to store information about files that were renamed by using the MOVEFILE\_DELAY\_UNTIL\_REBOOT value in the *dwFlags* parameter.</span></span>

<span data-ttu-id="d2e1a-128">Чтобы сохранить содержимое раздела реестра **PendingFileRenameOperations** , приложение резервного копирования должно вызвать функцию [**реглоадкэй**](/windows/win32/api/winreg/nf-winreg-regloadkeya) , чтобы подключить файл реестра для восстановления в активном реестре.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-128">To preserve the contents of the **PendingFileRenameOperations** registry key, your backup application should call the [**RegLoadKey**](/windows/win32/api/winreg/nf-winreg-regloadkeya) function to connect the registry file to be restored to the active registry.</span></span> <span data-ttu-id="d2e1a-129">Приложение резервного копирования может затем использовать различные функции реестра для копирования нужных ключей и значений в загруженный куст.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-129">Your backup application can then use the various registry functions to copy the desired keys and values into the loaded hive.</span></span> <span data-ttu-id="d2e1a-130">После завершения копирования должны быть вызваны функции [**функция RegFlushKey вернула**](/windows/win32/api/winreg/nf-winreg-regflushkey) и [**регунлоадкэй**](/windows/win32/api/winreg/nf-winreg-regunloadkeya) .</span><span class="sxs-lookup"><span data-stu-id="d2e1a-130">After the copy is complete, the [**RegFlushKey**](/windows/win32/api/winreg/nf-winreg-regflushkey) and [**RegUnloadKey**](/windows/win32/api/winreg/nf-winreg-regunloadkeya) functions should be called.</span></span>

<span data-ttu-id="d2e1a-131">Для восстановления в автономном режиме (среда восстановления Windows или Windows PE) необязательно учитывать раздел реестра **PendingFileRenameOperations** .</span><span class="sxs-lookup"><span data-stu-id="d2e1a-131">For an offline (Windows Recovery Environment or Windows PE) restore, it is not necessary to honor the **PendingFileRenameOperations** registry key.</span></span>

## <a name="registry-restore-using-non-vss-win32-apis-in-windows-server-2003"></a><span data-ttu-id="d2e1a-132">Восстановление реестра с помощью интерфейсов Win32 API, отличных от VSS, в Windows Server 2003</span><span class="sxs-lookup"><span data-stu-id="d2e1a-132">Registry Restore Using Non-VSS Win32 APIs in Windows Server 2003</span></span>

> [!Note]  
> <span data-ttu-id="d2e1a-133">Следующие сведения относятся только к операциям восстановления, связанным с аварийным восстановлением (также известным как восстановление исходного состояния системы), которые выполняются в Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-133">The following information applies only to restore operations related to disaster recovery (also known as bare-metal recovery) that are performed in Windows Server 2003.</span></span>

 

<span data-ttu-id="d2e1a-134">При восстановлении реестра приложению резервного копирования необходимо переместить некоторые подразделы из текущего реестра в реестр, который необходимо восстановить.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-134">When restoring the registry, a backup application needs to move some of the subkeys from the current registry into the registry that is to be restored.</span></span>

<span data-ttu-id="d2e1a-135">Для этого приложение резервного копирования может вызвать **реглоадкэй** , чтобы подключить файл реестра для восстановления в текущем активном реестре.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-135">To do this, a backup application can call **RegLoadKey** to connect the registry file to be restored to the currently active registry.</span></span> <span data-ttu-id="d2e1a-136">Затем он может использовать различные функции реестра для копирования нужных ключей и значений в загруженный куст.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-136">It can then use the various registry functions to copy the desired keys and values into the loaded hive.</span></span> <span data-ttu-id="d2e1a-137">После завершения копирования вызываются **функция RegFlushKey вернула** и **регунлоадкэй** .</span><span class="sxs-lookup"><span data-stu-id="d2e1a-137">After the copy is complete, **RegFlushKey** and **RegUnloadKey** are called.</span></span>

<span data-ttu-id="d2e1a-138">Существует раздел реестра, указывающий на то, что приложение восстановления (инициатор запроса) содержит разделы реестра в **\_ \_ \\ системе hKey Local Machine** , которые не должны перезаписываться во время восстановления:</span><span class="sxs-lookup"><span data-stu-id="d2e1a-138">There is a registry key that indicates to a restore application (requester) the registry keys under **HKEY\_LOCAL\_MACHINE\\SYSTEM** that should not be overwritten at restore time:</span></span>

<span data-ttu-id="d2e1a-139">**HKEY \_ локальный \_ компьютер \\ система \\ CurrentControlSet \\ элемент управления \\ баккупресторе \\ кэйснотторесторе**</span><span class="sxs-lookup"><span data-stu-id="d2e1a-139">**HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\Control\\BackupRestore\\KeysNotToRestore**</span></span>

<span data-ttu-id="d2e1a-140">Часть процесса восстановления состояния системы включает восстановление ранее созданного резервного реестра.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-140">Part of the system state restore process involves restoring a previously backed-up registry.</span></span>

<span data-ttu-id="d2e1a-141">Приложения резервного копирования должны соблюдать особую осторожность при восстановлении куста **\_ локальной \_ \\ системы hKey** , так как при установке временной версии операционной системы Windows в новом кусте System будут установлены ключи, значения которых должны сохраняться после операции восстановления.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-141">Backup applications need to take special care when restoring the **HKEY\_LOCAL\_MACHINE\\SYSTEM** hive because the process of installing a temporary version of the Windows operating system will have established keys in the newly installed system hive whose values must survive the restore operation.</span></span>

<span data-ttu-id="d2e1a-142">Например, если в системе замены имеется сетевая карта, отличающаяся от исходной системы, восстановление исходных ключей для предыдущей карты приведет к непредсказуемым результатам.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-142">For example, when the replacement system has a network interface card different from the original system, restoration of the original keys for the previous card will lead to unpredictable results.</span></span> <span data-ttu-id="d2e1a-143">Это происходит потому, что служба самонастраивающийся обнаружила и поместила в реестр соответствующие записи в реестре служб и драйверов.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-143">This is because the Plug and Play service has detected and placed proper service and driver registry entries into the registry.</span></span> <span data-ttu-id="d2e1a-144">Эти значения должны быть сохранены для правильной загрузки после восстановления системы.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-144">These values must be preserved to properly boot after system restore.</span></span>

<span data-ttu-id="d2e1a-145">В этом разделе описывается, как приложения резервного копирования могут определить, какие ключи и файлы должны сохраняться при выполнении восстановления куста **\_ локальной \_ \\ системы hKey** .</span><span class="sxs-lookup"><span data-stu-id="d2e1a-145">This section describes how backup applications can discover which keys and files are to be preserved when executing a restore of the **HKEY\_LOCAL\_MACHINE\\SYSTEM** hive.</span></span> <span data-ttu-id="d2e1a-146">В некоторых случаях это влечет за собой программное копирование ключей из вновь установленного куста установки в куст, подлежащей восстановлению.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-146">In some cases, this will involve programmatically copying the keys from the newly installed installation hive into the hive to be restored.</span></span> <span data-ttu-id="d2e1a-147">В других случаях обеспечение того, что разделы реестра продукта не заменяются, так же просто, как и при указании таких ключей в INF-файле конфигурации продукта.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-147">In other cases, ensuring that a product's registry keys are not replaced is as simple as specifying such keys in the product's INF configuration file.</span></span>

<span data-ttu-id="d2e1a-148">Ключи (и данные ключей), которые должны быть сохранены, перечисляются в кусте **\_ локальной \_ машины \\ hKey** в разделе</span><span class="sxs-lookup"><span data-stu-id="d2e1a-148">Keys (and key data) that are to be preserved are enumerated in the **HKEY\_LOCAL\_MACHINE\\SYSTEM** hive under the</span></span>

<span data-ttu-id="d2e1a-149">**HKEY \_ локальный \_ компьютер \\ система \\ CurrentControlSet \\ элемент управления \\ баккупресторе \\ кэйснотторесторе**</span><span class="sxs-lookup"><span data-stu-id="d2e1a-149">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\BackupRestore\\KeysNotToRestore**</span></span>

<span data-ttu-id="d2e1a-150">Key в виде наборов \_ строк с несколькими \_ SZами (называемых *ключевыми строками* в этом документе).</span><span class="sxs-lookup"><span data-stu-id="d2e1a-150">key as sets of REG\_MULTI\_SZ strings (called *key strings* in this document).</span></span>

<span data-ttu-id="d2e1a-151">Приложение для резервного копирования (инициатор запроса) должно проверять значения этих ключей в активном реестре и восстановленном реестре, так как любое приложение или служба могут добавлять значения в любое время.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-151">A backup application (requester) must examine the values of these keys in the active registry and the newly restored registry because any application or service can add values at any time.</span></span>

<span data-ttu-id="d2e1a-152">Способ интерпретации ключевых строк приложениями резервного копирования определяется по символам терминала:</span><span class="sxs-lookup"><span data-stu-id="d2e1a-152">How key strings are to be interpreted by backup applications is determined by their terminal character:</span></span>

1.  <span data-ttu-id="d2e1a-153">Строки ключей, заканчивающиеся обратной косой чертой (" \\ "), обрабатываются как подразделы.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-153">Key strings terminated with a backslash ('\\') are interpreted as subkeys.</span></span> <span data-ttu-id="d2e1a-154">При обнаружении такой подстроки приложение резервного копирования должно сохранять все данные и все подчиненные ключи.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-154">When such a substring is encountered, the backup application must preserve all data and all subordinate keys.</span></span>

    <span data-ttu-id="d2e1a-155">Например, следующий параметр указывает, что все подчиненные ключи и данные должны сохраняться в ходе операции восстановления:</span><span class="sxs-lookup"><span data-stu-id="d2e1a-155">For example, the following specifies that all subordinate keys and data are to be preserved across a restore operation:</span></span>

    <span data-ttu-id="d2e1a-156">**\_ \_ Сведения о загрузке (в файле hKey локального компьютера \\ System \\ CurrentControlSet \\ Services \\ Dmio \\ )\\**</span><span class="sxs-lookup"><span data-stu-id="d2e1a-156">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\dmio\\boot info\\**</span></span>

    <span data-ttu-id="d2e1a-157">В этом случае этот ключ и все подразделы и данные должны быть скопированы из существующего реестра (то есть из копии, созданной при установке Windows) в только что восстановленный реестр.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-157">To this end, this key and all subordinate keys and data must be copied from the existing registry (that is, the one created by the installation of Windows) into the newly restored registry.</span></span> <span data-ttu-id="d2e1a-158">Это называется операцией *замены ключа* .</span><span class="sxs-lookup"><span data-stu-id="d2e1a-158">This is called a *key replace* operation.</span></span> <span data-ttu-id="d2e1a-159">Эта операция заменяет соответствующий ключ в восстановленном реестре.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-159">This operation replaces the corresponding key in the restored registry.</span></span>

2.  <span data-ttu-id="d2e1a-160">Строки ключей, символ завершения которых является звездочкой (" \* "), указывает, что все подразделы должны быть объединены.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-160">Key strings whose termination character is an asterisk ('\*') specifies that all subkeys should be merged.</span></span> <span data-ttu-id="d2e1a-161">Например, строка ключа:</span><span class="sxs-lookup"><span data-stu-id="d2e1a-161">For example, the key string:</span></span>

    <span data-ttu-id="d2e1a-162">\**HKey \_ \_ \\ \\ \\ CURRENTCONTROLSET \\ Services \* System на локальном компьютере* _</span><span class="sxs-lookup"><span data-stu-id="d2e1a-162">\**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\\** _</span></span>

    <span data-ttu-id="d2e1a-163">Указывает, что ключ служб в существующем реестре (например, созданные установкой Windows) необходимо объединить с восстановленным реестром.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-163">specifies that the services key in the existing registry (for example those created by the installation of Windows) must be merged into the restored registry.</span></span> <span data-ttu-id="d2e1a-164">Это называется операцией _key MERGE \*, и если подраздел существует как в существующем кусте, так и в восстановленном кусте, ключ в восстановленном каталоге сохраняется со следующими исключениями:</span><span class="sxs-lookup"><span data-stu-id="d2e1a-164">This is called a _key merge\* operation, and if a subkey exists in both the existing hive and the restored hive, the key in the restored directory is preserved with the following exceptions:</span></span>

    -   <span data-ttu-id="d2e1a-165">Если подраздел в существующем кусте содержит значение с именем Start, а подраздел в восстановленном виде — нет.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-165">If the subkey in the existing hive contains a value named "start", and the subkey in the restored does not.</span></span>
    -   <span data-ttu-id="d2e1a-166">Если подраздел в существующем и восстановленном кусте содержит значение с именем "Start", а его числовое значение в существующем Hive меньше.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-166">If the subkey in both the existing and restored hive contain a value named "start", and its numeric value in the existing hive is less.</span></span>

    <span data-ttu-id="d2e1a-167">Значение "Start" в реестре указывает, когда запускается служба или драйвер, и может иметь числовое значение от 0-4.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-167">The "start" value in the registry specifies when a service or driver will start and can have a numeric value from 0-4.</span></span> <span data-ttu-id="d2e1a-168">Чем меньше значение, тем быстрее в процессе загрузки служба запустится.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-168">The lower the value, the sooner in the boot process the service will start.</span></span>

    <span data-ttu-id="d2e1a-169">Если этот ключ существует и в существующем, и в восстановленном каталоге, необходимо проверить значение стартового ключа в каждом кусте.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-169">If this key exists in both the existing and the restored directory, you must examine the value of the start key in each hive.</span></span> <span data-ttu-id="d2e1a-170">Если значение в существующем Hive меньше значения в восстановленном каталоге, то меньшее значение должно быть сохранено.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-170">If the value in the existing hive is lower than the value in the restored directory, the lower value must be preserved.</span></span>

    <span data-ttu-id="d2e1a-171">Опять же, этот ключ используется для определения того, следует ли запускать службу или драйвер во время загрузки, в системное время, вручную, автоматически или быть отключенным.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-171">Once again, this key is used to determine whether a service or driver is to be started at boot time, at system time, manually, automatically, or be disabled.</span></span> <span data-ttu-id="d2e1a-172">Более низкое значение представляет время начала.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-172">The lower value represents an earlier start time.</span></span> <span data-ttu-id="d2e1a-173">Предыдущее время начала должно быть применено к новому реестру, чтобы гарантировать, что служба или драйверы должным образом запускаться при следующей загрузке.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-173">The earlier start time must be applied to the new registry to ensure that the service or drivers are started properly at the next boot.</span></span>

3.  <span data-ttu-id="d2e1a-174">Строки ключей, символ завершения которых не является ни символом обратной косой чертой, ни звездочка, интерпретируется как сохраняемые значения реестра.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-174">Key strings whose termination character is neither a backslash nor an asterisk are interpreted as registry values to be preserved.</span></span>

    <span data-ttu-id="d2e1a-175">Например, строка ключа:</span><span class="sxs-lookup"><span data-stu-id="d2e1a-175">For example, the key string:</span></span>

    <span data-ttu-id="d2e1a-176">**HKEY \_ локальный \_ компьютер \\ система \\ CurrentControlSet \\ Управление \\ сеансом диспетчер сеансов \\ PendingFileRenameOperations**</span><span class="sxs-lookup"><span data-stu-id="d2e1a-176">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\PendingFileRenameOperations**</span></span>

    <span data-ttu-id="d2e1a-177">Механизм, с помощью которого ключи могут быть сохранены программно, включает API реестра Win32.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-177">The mechanism by which keys can be preserved programmatically involves the Win32 registry API.</span></span> <span data-ttu-id="d2e1a-178">Например, один алгоритм перечисляется ниже:</span><span class="sxs-lookup"><span data-stu-id="d2e1a-178">For example, one algorithm is enumerated below:</span></span>

    1.  <span data-ttu-id="d2e1a-179">Восстановите резервную копию файла куста System в файл.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-179">Restore the backed-up system hive file to a file.</span></span> <span data-ttu-id="d2e1a-180">В этом примере дайте имя System. reg.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-180">For this example, let the name be System.reg.</span></span>
    2.  <span data-ttu-id="d2e1a-181">Используйте **реглоадкэй** для загрузки System. reg в раздел **hKey на \_ локальном \_ компьютере** с временным именем.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-181">Use **RegLoadKey** to load System.reg into **HKEY\_LOCAL\_MACHINE** under a temporary name.</span></span> <span data-ttu-id="d2e1a-182">Например, одно из таких имен может быть</span><span class="sxs-lookup"><span data-stu-id="d2e1a-182">For example, one such name might be</span></span>

        <span data-ttu-id="d2e1a-183">**\_ \_ \\ система tmp ЛОКАЛЬНОГО компьютера \_ (hKey)**</span><span class="sxs-lookup"><span data-stu-id="d2e1a-183">**HKEY\_LOCAL\_MACHINE\\TMP\_SYSTEM**</span></span>

    3.  <span data-ttu-id="d2e1a-184">Перечислите значения в подразделе **кэйснотторесторе** из обоих разделов реестра и создайте надмножество списков.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-184">Enumerate the values in the **KeysNotToRestore** subkey from both of the registry copies and create a superset of the lists.</span></span> <span data-ttu-id="d2e1a-185">Скопируйте каждый такой ключ из существующего</span><span class="sxs-lookup"><span data-stu-id="d2e1a-185">Copy each such key from the existing</span></span>

        <span data-ttu-id="d2e1a-186">**система HKEY на \_ локальном \_ компьютере \\**</span><span class="sxs-lookup"><span data-stu-id="d2e1a-186">**HKEY\_LOCAL\_MACHINE\\SYSTEM**</span></span>

        <span data-ttu-id="d2e1a-187">в раздел</span><span class="sxs-lookup"><span data-stu-id="d2e1a-187">key into the</span></span>

        <span data-ttu-id="d2e1a-188">**\_ \_ \\ система tmp ЛОКАЛЬНОГО компьютера \_ (hKey)**</span><span class="sxs-lookup"><span data-stu-id="d2e1a-188">**HKEY\_LOCAL\_MACHINE\\TMP\_SYSTEM**</span></span>

        <span data-ttu-id="d2e1a-189">ключ в соответствии с семантикой, описанной выше.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-189">key according to the semantics described above.</span></span>

    4.  <span data-ttu-id="d2e1a-190">По завершении используйте   &  точки входа функция RegFlushKey вернула **регунлоадкэй** , чтобы сохранить</span><span class="sxs-lookup"><span data-stu-id="d2e1a-190">When complete use the **RegFlushKey** & **RegUnloadKey** entry points to save the</span></span>

        <span data-ttu-id="d2e1a-191">**\_ \_ \\ система tmp ЛОКАЛЬНОГО компьютера \_ (hKey)**</span><span class="sxs-lookup"><span data-stu-id="d2e1a-191">**HKEY\_LOCAL\_MACHINE\\TMP\_SYSTEM**</span></span>

        <span data-ttu-id="d2e1a-192">вернемся к System. reg.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-192">key back to System.reg.</span></span>

    5.  <span data-ttu-id="d2e1a-193">Наконец, используйте **регреплацекэй** , чтобы указать, что System. reg должен заменить</span><span class="sxs-lookup"><span data-stu-id="d2e1a-193">Finally, use **RegReplaceKey** to specify that System.reg is to replace the</span></span>

        <span data-ttu-id="d2e1a-194">**система HKEY на \_ локальном \_ компьютере \\**</span><span class="sxs-lookup"><span data-stu-id="d2e1a-194">**HKEY\_LOCAL\_MACHINE\\SYSTEM**</span></span>

        <span data-ttu-id="d2e1a-195">файл Hive, система.</span><span class="sxs-lookup"><span data-stu-id="d2e1a-195">hive file, SYSTEM.</span></span>

 

 
