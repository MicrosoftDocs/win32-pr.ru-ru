---
title: Сетевая трассировка в архитектуре Windows 7
description: На рисунке ниже показана базовая архитектура трассировки сети в Windows 7.
ms.assetid: b3023469-0f98-451c-b39f-c3eae771eacc
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 41221ebf434c05a8c9b7c8489e861128029b5320
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "105672401"
---
# <a name="network-tracing-in-windows-7-architecture"></a><span data-ttu-id="d47ae-103">Трассировка сети в Windows 7: архитектура</span><span class="sxs-lookup"><span data-stu-id="d47ae-103">Network Tracing in Windows 7: Architecture</span></span>

<span data-ttu-id="d47ae-104">На рисунке ниже показана базовая архитектура трассировки сети в Windows 7.</span><span class="sxs-lookup"><span data-stu-id="d47ae-104">The illustration below shows the basic network tracing architecture in Windows 7.</span></span>

![Схема архитектуры трассировки сети](images/ut1.png)

<span data-ttu-id="d47ae-106">Трассировка сети использует платформу трассировки событий для Windows (ETW), доступную в Windows.</span><span class="sxs-lookup"><span data-stu-id="d47ae-106">Network tracing utilizes the Event Tracing for Windows (ETW) framework available in Windows.</span></span> <span data-ttu-id="d47ae-107">Сетевые компоненты (такие как Winsock, TCP/IP, NDIS, пакетная запись и т. д.) регистрируются как поставщики трассировки событий Windows и выдают события, связанные с работой сети.</span><span class="sxs-lookup"><span data-stu-id="d47ae-107">Network components (such as Winsock, TCP/IP, NDIS, packet-capture, and so on) register as ETW trace providers and emit events related to network activity.</span></span> <span data-ttu-id="d47ae-108">Любое записываемое действие значимости может быть событием, регистрируемым в ETW.</span><span class="sxs-lookup"><span data-stu-id="d47ae-108">Any recordable activity of significance can be an event logged to ETW.</span></span> <span data-ttu-id="d47ae-109">Трассировку для этих сетевых компонентов и захватов пакетов можно включить с помощью контекста **трассировки Netsh** , который выступает в качестве контроллера ETW.</span><span class="sxs-lookup"><span data-stu-id="d47ae-109">Tracing for these network components and packet captures can be enabled using the **netsh trace** context which acts as an ETW controller.</span></span>

<span data-ttu-id="d47ae-110">Созданные трассировки собираются в файле журнала трассировки событий (ETL).</span><span class="sxs-lookup"><span data-stu-id="d47ae-110">The generated traces are collected in an Event Trace Log (ETL) file.</span></span> <span data-ttu-id="d47ae-111">Затем эти ETL-файлы можно проанализировать с помощью ряда средств, таких как сетевой монитор 3,2 и более поздних версий, Просмотр событий, **netsh trace Convert** или Tracerpt.exe.</span><span class="sxs-lookup"><span data-stu-id="d47ae-111">These ETL files can then be analyzed using a number of tools, such as Network Monitor 3.2 and later, Event Viewer, **netsh trace convert**, or Tracerpt.exe.</span></span>

<span data-ttu-id="d47ae-112">Каждое событие ETW имеет общий заголовок, в котором ETW хранит такие сведения, как свойства событий, метки времени и ИДЕНТИФИКАТОРы действий.</span><span class="sxs-lookup"><span data-stu-id="d47ae-112">Each ETW event has a common header where ETW stores information such as the event properties, time stamps, and activity ID.</span></span> <span data-ttu-id="d47ae-113">(Дополнительные сведения об идентификаторах действий см. [в разделе Написание связанных событий в сквозном сценарии](../etw/writing-related-events-in-an-end-to-end-scenario.md)).</span><span class="sxs-lookup"><span data-stu-id="d47ae-113">(For more information about activity IDs, see [Writing Related Events in an End-to-End Scenario](../etw/writing-related-events-in-an-end-to-end-scenario.md)).</span></span> <span data-ttu-id="d47ae-114">Идентификатор действия используется для корреляции событий.</span><span class="sxs-lookup"><span data-stu-id="d47ae-114">The activity ID is used to correlate events.</span></span> <span data-ttu-id="d47ae-115">В пользовательском режиме идентификаторы действий хранятся в потоках, и все события, регистрируемые в одном потоке, автоматически помечаются одним и тем же ИДЕНТИФИКАТОРом действия.</span><span class="sxs-lookup"><span data-stu-id="d47ae-115">In user mode, activity IDs are stored in threads, and all events logged in one thread will automatically be tagged with the same activity ID.</span></span> <span data-ttu-id="d47ae-116">В режиме ядра идентификатор действия должен быть явно передан при записи события в журнал.</span><span class="sxs-lookup"><span data-stu-id="d47ae-116">In kernel mode, the activity ID must be explicitly passed when an event is logged.</span></span> <span data-ttu-id="d47ae-117">По умолчанию ETL-файлы сопоставляются с событиями группировки по конкретным идентификаторам действий.</span><span class="sxs-lookup"><span data-stu-id="d47ae-117">By default, ETL files are correlated to group events together under specific activity IDs.</span></span>

<span data-ttu-id="d47ae-118">Дополнительные сведения о событиях Windows и ETW см. в разделе [события Windows](../events/windows-events.md).</span><span class="sxs-lookup"><span data-stu-id="d47ae-118">For more information about Windows Events and ETW, see [Windows Events](../events/windows-events.md).</span></span>

## <a name="etw-components-in-network-tracing"></a><span data-ttu-id="d47ae-119">Компоненты ETW в трассировке сети</span><span class="sxs-lookup"><span data-stu-id="d47ae-119">ETW Components in Network Tracing</span></span>

<span data-ttu-id="d47ae-120">Трассировка сети использует ETW в качестве основного механизма трассировки, чтобы предоставить сведения о том, что делают сетевые подсистемы.</span><span class="sxs-lookup"><span data-stu-id="d47ae-120">Network tracing uses ETW as its primary tracing mechanism to provide information about what the networking subsystems are doing.</span></span> <span data-ttu-id="d47ae-121">В ETW есть четыре основных компонента: сеансы трассировки событий, поставщики событий, контроллеры событий и потребители событий.</span><span class="sxs-lookup"><span data-stu-id="d47ae-121">There are four main components in ETW: event trace sessions, event providers, event controllers and event consumers.</span></span>

<span data-ttu-id="d47ae-122">Буферизация и ведение журнала происходят в *сеансах трассировки событий*, которые принимают события от поставщиков и создают файлы трассировки.</span><span class="sxs-lookup"><span data-stu-id="d47ae-122">Buffering and logging take place in *event trace sessions*, which accept events from providers and creates trace files.</span></span>

<span data-ttu-id="d47ae-123">*Поставщик событий* — это логическая сущность, которая записывает события в сеансы ETW.</span><span class="sxs-lookup"><span data-stu-id="d47ae-123">An *event provider* is a logical entity that writes events to ETW sessions.</span></span> <span data-ttu-id="d47ae-124">Поставщик событий может быть приложением пользовательского режима, управляемым приложением, драйвером или любой другой сущностью программного обеспечения.</span><span class="sxs-lookup"><span data-stu-id="d47ae-124">An event provider can be a user-mode application, a managed application, a driver, or any other software entity.</span></span> <span data-ttu-id="d47ae-125">Поставщики событий регистрируются в ETW и записывают события из различных точек в коде, вызывая API ведения журнала ETW.</span><span class="sxs-lookup"><span data-stu-id="d47ae-125">Event providers register with ETW and write events from various points in the code by invoking the ETW logging API.</span></span> <span data-ttu-id="d47ae-126">Из-за растущего инструментария событий во многих компонентах операционной системы даже простое приложение или сценарий в Windows будет содержать несколько компонентов, которые являются поставщиками событий.</span><span class="sxs-lookup"><span data-stu-id="d47ae-126">Due to the growing event instrumentation in many operating system components, even a simple application or scenario in Windows will contain several components that are event providers.</span></span>

<span data-ttu-id="d47ae-127">*Контроллер событий* запускает и останавливает сеансы трассировки событий и включает поставщиков.</span><span class="sxs-lookup"><span data-stu-id="d47ae-127">An *event controller* starts and stops event trace sessions and enables providers.</span></span> <span data-ttu-id="d47ae-128">Когда поставщик событий динамически включается приложением контроллера событий, поставщик отправляет события в определенный сеанс трассировки событий, назначенный контроллером событий.</span><span class="sxs-lookup"><span data-stu-id="d47ae-128">When an event provider is enabled dynamically by the event controller application, the provider sends events to a specific event trace session designated by the event controller.</span></span> <span data-ttu-id="d47ae-129">Каждое событие, отправленное поставщиком событий в сеанс трассировки событий, состоит из фиксированного заголовка, который содержит метаданные события и любые дополнительные пользовательские данные, регистрируемые поставщиком.</span><span class="sxs-lookup"><span data-stu-id="d47ae-129">Each event sent by the event provider to the event trace session consists of a fixed header, which includes event metadata and any additional custom data logged by the provider.</span></span>

<span data-ttu-id="d47ae-130">*Потребитель событий* — это приложение, которое считывает файлы журнала или прослушивает сеанс трассировки событий для событий в реальном времени и обрабатывает их.</span><span class="sxs-lookup"><span data-stu-id="d47ae-130">An *event consumer* is an application that reads log files or that listens to an event trace session for real-time events and processes them.</span></span> <span data-ttu-id="d47ae-131">Одним из примеров потребителей событий является Microsoft Network Monitor 3,2, который включает возможность чтения и просмотра файлов журнала, созданных функцией трассировки сети в Windows 7.</span><span class="sxs-lookup"><span data-stu-id="d47ae-131">One example of an event consumer is Microsoft Network Monitor 3.2, which includes the capability to read and display log files produced by network tracing in Windows 7.</span></span>

<span data-ttu-id="d47ae-132">События доставляются потребителям событий в хронологическом порядке, и существуют различные приложения-потребители событий, отображающие события в определенных форматах.</span><span class="sxs-lookup"><span data-stu-id="d47ae-132">Events are delivered to event consumers in chronological order, and there are various event consumer applications that display the events in specific formats.</span></span> <span data-ttu-id="d47ae-133">Когда событие регистрируется в сеансе, ETW добавляет дополнительные сведения в заголовок события, включая метку времени, идентификатор процесса и потока, номер процессора и данные о загрузке ЦП потока ведения журнала.</span><span class="sxs-lookup"><span data-stu-id="d47ae-133">When an event is logged to a session, ETW adds additional information to the event header, including the timestamp, process and thread ID, processor number, and CPU usage data of the logging thread.</span></span> <span data-ttu-id="d47ae-134">Затем эти данные передаются потребителям событий, а также пользовательским данным, включенным в поставщик.</span><span class="sxs-lookup"><span data-stu-id="d47ae-134">This data is then passed on to event consumers, along with any custom data included by the provider.</span></span>

<span data-ttu-id="d47ae-135">Поставщики, использующие новые [API ведения журнала событий](/windows/win32/api/evntprov/nf-evntprov-eventwrite) , должны предоставить XML-файл, который называется [манифестом события](../wes/eventschema-schema.md).</span><span class="sxs-lookup"><span data-stu-id="d47ae-135">Providers using the new [Event Logging APIs](/windows/win32/api/evntprov/nf-evntprov-eventwrite) are expected to supply an XML file called the [event manifest](../wes/eventschema-schema.md).</span></span> <span data-ttu-id="d47ae-136">Этот файл предоставляет метаданные для определения всех пользовательских данных и макета сведений о событиях, записываемых поставщиком.</span><span class="sxs-lookup"><span data-stu-id="d47ae-136">This file provides metadata to define all of the custom data and layout information for the events written by the provider.</span></span> <span data-ttu-id="d47ae-137">Затем потребительское приложение общего назначения использует API [-интерфейсы вспомогательных данных трассировки (TDH)](/windows/win32/api/tdh/) для получения метаданных события, расшифровки событий и их вывода.</span><span class="sxs-lookup"><span data-stu-id="d47ae-137">A general purpose consumer application then uses [Trace Data Helper (TDH)](/windows/win32/api/tdh/) APIs to retrieve the event metadata, decode the events, and display them.</span></span>

<span data-ttu-id="d47ae-138">Благодаря трассировке сети в Windows 7 сервер событий и сторона потребителя включают в себя комплексную поддержку трассировки на основе сценариев, интегрированную с общими возможностями диагностики и поддержки Windows.</span><span class="sxs-lookup"><span data-stu-id="d47ae-138">With network tracing in Windows 7, the event controller/consumer side includes end-to-end scenario-based tracing support integrated with overall Windows diagnostic and support experiences.</span></span> <span data-ttu-id="d47ae-139">Сценарий определяет коллекцию поставщиков событий, участвующих в сценарии.</span><span class="sxs-lookup"><span data-stu-id="d47ae-139">A scenario defines a collection of event providers involved in the scenario.</span></span> <span data-ttu-id="d47ae-140">На стороне "контроллер событий" и "потребитель" определяются сценарии (контексты), где можно использовать трассировку, включая соответствующие поставщики для заданных сценариев в сетевых компонентах.</span><span class="sxs-lookup"><span data-stu-id="d47ae-140">The event controller/consumer side defines the scenarios (contexts) where tracing can be used, including the relevant providers for given scenarios across network components.</span></span> <span data-ttu-id="d47ae-141">Сторона поставщика событий включает стандартизированные события трассировки сети из различных компонентов в сетевом стеке, которые можно связать с помощью идентификаторов действий ETW.</span><span class="sxs-lookup"><span data-stu-id="d47ae-141">The event provider side includes standardized network tracing events from different components in the network stack, which can be correlated via ETW activity IDs.</span></span> <span data-ttu-id="d47ae-142">Поставщики используют общую схему сети, которая стандартизует использование концепций ETW, таких как ключевые слова, уровни, задачи и коды операций.</span><span class="sxs-lookup"><span data-stu-id="d47ae-142">The providers use a common network schema that standardizes the use of ETW concepts such as keywords, levels, tasks, and opcodes.</span></span> <span data-ttu-id="d47ae-143">Схема также определяет события, которые являются общими для многих сетевых компонентов, таких как события ошибок, события удаления пакетов, события схемы и события перехода состояния.</span><span class="sxs-lookup"><span data-stu-id="d47ae-143">The schema also defines events that are common for many network components such as error events, packet drop events, schema events, and state transition events.</span></span>

 

 