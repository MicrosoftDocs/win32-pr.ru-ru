---
description: В этом разделе описано, как клиент использует преобразование Media Foundation (MFT) для обработки данных. Клиент — это все, что напрямую вызывает методы в MFT. Это может быть приложение или конвейер Media Foundation.
ms.assetid: be977d75-999e-4e57-9672-00a89246a2c1
title: Базовая модель обработки MFT
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9ca54df6d9765aaf54456c3d9dc4461a82a93d41
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104072585"
---
# <a name="basic-mft-processing-model"></a><span data-ttu-id="5828f-105">Базовая модель обработки MFT</span><span class="sxs-lookup"><span data-stu-id="5828f-105">Basic MFT Processing Model</span></span>

<span data-ttu-id="5828f-106">В этом разделе описано, как клиент использует преобразование Media Foundation (MFT) для обработки данных.</span><span class="sxs-lookup"><span data-stu-id="5828f-106">This topic describes how a client uses a Media Foundation transform (MFT) to process data.</span></span> <span data-ttu-id="5828f-107">*Клиент* — это все, что напрямую вызывает методы в MFT.</span><span class="sxs-lookup"><span data-stu-id="5828f-107">The *client* is anything that directly calls methods on the MFT.</span></span> <span data-ttu-id="5828f-108">Это может быть приложение или конвейер Media Foundation.</span><span class="sxs-lookup"><span data-stu-id="5828f-108">This might be the application or the Media Foundation pipeline.</span></span>

<span data-ttu-id="5828f-109">Прочтите этот раздел, если вы:</span><span class="sxs-lookup"><span data-stu-id="5828f-109">Read this topic if you are:</span></span>

-   <span data-ttu-id="5828f-110">Написание приложения, выполняющего прямые вызовы к одному или нескольким МФТС.</span><span class="sxs-lookup"><span data-stu-id="5828f-110">Writing an application that makes direct calls to one or more MFTs.</span></span>
-   <span data-ttu-id="5828f-111">Написание настраиваемой таблицы MFT и нужно понимать поведение MFT.</span><span class="sxs-lookup"><span data-stu-id="5828f-111">Writing a custom MFT and want to understand the expected behavior of an MFT.</span></span>

<span data-ttu-id="5828f-112">В этом разделе описывается модель *синхронной* обработки.</span><span class="sxs-lookup"><span data-stu-id="5828f-112">This topic describes a *synchronous* processing model.</span></span> <span data-ttu-id="5828f-113">В этой модели все методы обработки данных блокируются до их завершения.</span><span class="sxs-lookup"><span data-stu-id="5828f-113">In this model, all data-processing methods block until they complete.</span></span> <span data-ttu-id="5828f-114">МФТС также может поддерживать *асинхронную* модель, которая описана в разделе [асинхронная МФТС](asynchronous-mfts.md).</span><span class="sxs-lookup"><span data-stu-id="5828f-114">MFTs can also support an *asynchronous* model, which is described in the topic [Asynchronous MFTs](asynchronous-mfts.md).</span></span>

-   [<span data-ttu-id="5828f-115">Базовая модель обработки</span><span class="sxs-lookup"><span data-stu-id="5828f-115">Basic Processing Model</span></span>](#basic-processing-model)
    -   [<span data-ttu-id="5828f-116">Создание MFT</span><span class="sxs-lookup"><span data-stu-id="5828f-116">Create the MFT</span></span>](#create-the-mft)
    -   [<span data-ttu-id="5828f-117">Получение идентификаторов потоков</span><span class="sxs-lookup"><span data-stu-id="5828f-117">Get Stream Identifiers</span></span>](#get-stream-identifiers)
    -   [<span data-ttu-id="5828f-118">Настройка типов мультимедиа</span><span class="sxs-lookup"><span data-stu-id="5828f-118">Set Media Types</span></span>](#set-media-types)
    -   [<span data-ttu-id="5828f-119">Получение требований к буферу</span><span class="sxs-lookup"><span data-stu-id="5828f-119">Get Buffer Requirements</span></span>](#get-buffer-requirements)
    -   [<span data-ttu-id="5828f-120">Обработка данных</span><span class="sxs-lookup"><span data-stu-id="5828f-120">Process Data</span></span>](#process-data)
-   [<span data-ttu-id="5828f-121">Расширения для базовой модели</span><span class="sxs-lookup"><span data-stu-id="5828f-121">Extensions to the Basic Model</span></span>](#extensions-to-the-basic-model)
-   [<span data-ttu-id="5828f-122">IMF2DBuffer</span><span class="sxs-lookup"><span data-stu-id="5828f-122">IMF2DBuffer</span></span>](#imf2dbuffer)
-   [<span data-ttu-id="5828f-123">Очистка MFT</span><span class="sxs-lookup"><span data-stu-id="5828f-123">Flushing an MFT</span></span>](#flushing-an-mft)
-   [<span data-ttu-id="5828f-124">Очистка MFT</span><span class="sxs-lookup"><span data-stu-id="5828f-124">Draining an MFT</span></span>](#draining-an-mft)
-   [<span data-ttu-id="5828f-125">Примеры атрибутов</span><span class="sxs-lookup"><span data-stu-id="5828f-125">Sample Attributes</span></span>](#sample-attributes)
-   [<span data-ttu-id="5828f-126">Нарушения</span><span class="sxs-lookup"><span data-stu-id="5828f-126">Discontinuities</span></span>](#discontinuities)
-   [<span data-ttu-id="5828f-127">Изменения динамического формата</span><span class="sxs-lookup"><span data-stu-id="5828f-127">Dynamic Format Changes</span></span>](#dynamic-format-changes)
-   [<span data-ttu-id="5828f-128">Потоковые события</span><span class="sxs-lookup"><span data-stu-id="5828f-128">Stream Events</span></span>](#stream-events)
-   [<span data-ttu-id="5828f-129">См. также</span><span class="sxs-lookup"><span data-stu-id="5828f-129">Related topics</span></span>](#related-topics)

## <a name="basic-processing-model"></a><span data-ttu-id="5828f-130">Базовая модель обработки</span><span class="sxs-lookup"><span data-stu-id="5828f-130">Basic Processing Model</span></span>

### <a name="create-the-mft"></a><span data-ttu-id="5828f-131">Создание MFT</span><span class="sxs-lookup"><span data-stu-id="5828f-131">Create the MFT</span></span>

<span data-ttu-id="5828f-132">Существует несколько способов создания таблицы MFT.</span><span class="sxs-lookup"><span data-stu-id="5828f-132">There are several ways to create an MFT:</span></span>

-   <span data-ttu-id="5828f-133">Вызовите функцию [**мфтенум**](/windows/desktop/api/mfapi/nf-mfapi-mftenum) .</span><span class="sxs-lookup"><span data-stu-id="5828f-133">Call the [**MFTEnum**](/windows/desktop/api/mfapi/nf-mfapi-mftenum) function.</span></span>
-   <span data-ttu-id="5828f-134">Вызовите функцию [**мфтенумекс**](/windows/desktop/api/mfapi/nf-mfapi-mftenumex) .</span><span class="sxs-lookup"><span data-stu-id="5828f-134">Call the [**MFTEnumEx**](/windows/desktop/api/mfapi/nf-mfapi-mftenumex) function.</span></span>
-   <span data-ttu-id="5828f-135">Если вы уже знакомы с идентификатором класса MFT, просто вызовите **CoCreateInstance**.</span><span class="sxs-lookup"><span data-stu-id="5828f-135">If you already know the CLSID of the MFT, simply call **CoCreateInstance**.</span></span>

<span data-ttu-id="5828f-136">Некоторые МФТС могут предоставлять другие возможности, например специальную функцию создания.</span><span class="sxs-lookup"><span data-stu-id="5828f-136">Some MFTs might provide other options, such as a specialized creation function.</span></span>

### <a name="get-stream-identifiers"></a><span data-ttu-id="5828f-137">Получение идентификаторов потоков</span><span class="sxs-lookup"><span data-stu-id="5828f-137">Get Stream Identifiers</span></span>

<span data-ttu-id="5828f-138">MFT имеет один или несколько *потоков*.</span><span class="sxs-lookup"><span data-stu-id="5828f-138">An MFT has one or more *streams*.</span></span> <span data-ttu-id="5828f-139">Входные потоки получают входные данные, а выходные потоки создают выходные данные.</span><span class="sxs-lookup"><span data-stu-id="5828f-139">Input streams receive input data, and output streams generate output data.</span></span> <span data-ttu-id="5828f-140">Потоки не представляются как отдельные объекты.</span><span class="sxs-lookup"><span data-stu-id="5828f-140">Streams are not represented as distinct objects.</span></span> <span data-ttu-id="5828f-141">Вместо этого различные методы MFT принимают идентификаторы потоков в качестве параметров.</span><span class="sxs-lookup"><span data-stu-id="5828f-141">Instead, various MFT methods take stream identifiers as parameters.</span></span>

<span data-ttu-id="5828f-142">Некоторые МФТС позволяют клиенту добавлять или удалять входные потоки.</span><span class="sxs-lookup"><span data-stu-id="5828f-142">Some MFTs allow the client to add or remove input streams.</span></span> <span data-ttu-id="5828f-143">Во время потоковой передачи файл MFT может добавлять или удалять выходные потоки.</span><span class="sxs-lookup"><span data-stu-id="5828f-143">During streaming, an MFT can add or remove output streams.</span></span> <span data-ttu-id="5828f-144">(Клиент не может добавлять или удалять выходные потоки.)</span><span class="sxs-lookup"><span data-stu-id="5828f-144">(The client cannot add or remove output streams.)</span></span>

1.  <span data-ttu-id="5828f-145">(Необязательно.) Вызовите [**имфтрансформ:: жетстреамлимитс**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamlimits) , чтобы получить минимальное и максимальное число потоков, которые может поддерживать MFT.</span><span class="sxs-lookup"><span data-stu-id="5828f-145">(Optional.) Call [**IMFTransform::GetStreamLimits**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamlimits) to get the minimum and maximum number of streams that the MFT can support.</span></span> <span data-ttu-id="5828f-146">Если минимальное и максимальное значения совпадают, MFT имеет фиксированное число потоков.</span><span class="sxs-lookup"><span data-stu-id="5828f-146">If the minimum and maximum are the same, the MFT has a fixed number of streams.</span></span>
2.  <span data-ttu-id="5828f-147">Вызовите метод [**имфтрансформ:: жетстреамкаунт**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamcount) , чтобы получить начальное число потоков.</span><span class="sxs-lookup"><span data-stu-id="5828f-147">Call [**IMFTransform::GetStreamCount**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamcount) to get the initial number of streams.</span></span>
3.  <span data-ttu-id="5828f-148">Вызовите метод [**имфтрансформ:: жетстреамидс**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamids) , чтобы получить идентификаторы потоков.</span><span class="sxs-lookup"><span data-stu-id="5828f-148">Call [**IMFTransform::GetStreamIDs**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getstreamids) to get the stream identifiers.</span></span> <span data-ttu-id="5828f-149">Если этот метод возвращает E \_ нотимпл, это означает, что MFT имеет фиксированное число потоков, а идентификаторы потоков начинаются с нуля.</span><span class="sxs-lookup"><span data-stu-id="5828f-149">If this method returns E\_NOTIMPL, it means the MFT has a fixed number of streams, and the stream identifiers are consecutive starting from zero.</span></span>
4.  <span data-ttu-id="5828f-150">(Необязательно.) Если таблица MFT не имеет фиксированного числа потоков, вызовите [**имфтрансформ:: аддинпутстреамс**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-addinputstreams) , чтобы добавить дополнительные входные потоки, или [**Имфтрансформ::D елетеинпутстреам**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-deleteinputstream) для удаления потоков ввода.</span><span class="sxs-lookup"><span data-stu-id="5828f-150">(Optional.) If the MFT does not have a fixed number of streams, call [**IMFTransform::AddInputStreams**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-addinputstreams) to add more input streams, or [**IMFTransform::DeleteInputStream**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-deleteinputstream) to remove input streams.</span></span> <span data-ttu-id="5828f-151">(Нельзя добавлять или удалять выходные потоки.)</span><span class="sxs-lookup"><span data-stu-id="5828f-151">(You cannot add or remove output streams.)</span></span>

### <a name="set-media-types"></a><span data-ttu-id="5828f-152">Настройка типов мультимедиа</span><span class="sxs-lookup"><span data-stu-id="5828f-152">Set Media Types</span></span>

<span data-ttu-id="5828f-153">Прежде чем MFT сможет обработать данные, клиент должен задать типы носителей для каждого потока MFT.</span><span class="sxs-lookup"><span data-stu-id="5828f-153">Before an MFT can process data, the client must set a media types for each of the streams of the MFT.</span></span> <span data-ttu-id="5828f-154">Для MFT может потребоваться, чтобы клиент установил входные типы перед заданием типов выходных данных, или потребовался обратный порядок (типы вывода сначала).</span><span class="sxs-lookup"><span data-stu-id="5828f-154">An MFT might require that the client set the input types before setting the output types, or might require the opposite order (output types first).</span></span> <span data-ttu-id="5828f-155">Некоторые МФТС не имеют требования к заказу.</span><span class="sxs-lookup"><span data-stu-id="5828f-155">Some MFTs do not have a requirement on the order.</span></span>

<span data-ttu-id="5828f-156">Таблица MFT может предоставлять список предпочтительных типов мультимедиа для потока.</span><span class="sxs-lookup"><span data-stu-id="5828f-156">An MFT can provide a list of preferred media types for a stream.</span></span> <span data-ttu-id="5828f-157">Кроме того, МФТС может указывать на общие форматы, которые они поддерживают, добавляя эти сведения в реестр.</span><span class="sxs-lookup"><span data-stu-id="5828f-157">Also, MFTs can indicate the general formats that they support by adding this information to the registry.</span></span>

<span data-ttu-id="5828f-158">Чтобы задать типы носителей, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="5828f-158">To set the media types, do the following:</span></span>

1.  <span data-ttu-id="5828f-159">(Необязательно.) Для каждого входного потока вызовите [**имфтрансформ:: жетинпутаваилаблетипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) , чтобы получить список предпочтительных типов для этого потока.</span><span class="sxs-lookup"><span data-stu-id="5828f-159">(Optional.) For each input stream, call [**IMFTransform::GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) to get the list of preferred types for that stream.</span></span>
    -   <span data-ttu-id="5828f-160">Если этот метод возвращает \_ \_ тип преобразования MF \_ E \_ не \_ задан, необходимо сначала задать выходные типы, перейдите к шагу 3.</span><span class="sxs-lookup"><span data-stu-id="5828f-160">If this method returns MF\_E\_TRANSFORM\_TYPE\_NOT\_SET, you must set the output types first; skip to step 3.</span></span>
    -   <span data-ttu-id="5828f-161">Если метод возвращает E \_ нотимпл, то Таблица MFT не имеет списка предпочтительных входных типов; перейдите к шагу 2.</span><span class="sxs-lookup"><span data-stu-id="5828f-161">If the method returns E\_NOTIMPL, the MFT does not have a list of preferred input types; skip to step 2.</span></span>
2.  <span data-ttu-id="5828f-162">Для каждого входного потока вызовите [**имфтрансформ:: сетинпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) , чтобы задать входной тип.</span><span class="sxs-lookup"><span data-stu-id="5828f-162">For each input stream, call [**IMFTransform::SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) to set the input type.</span></span> <span data-ttu-id="5828f-163">Можно использовать тип носителя из шага 1 или тип, описывающий входные данные.</span><span class="sxs-lookup"><span data-stu-id="5828f-163">You can use a media type from step 1, or a type that describes your input data.</span></span> <span data-ttu-id="5828f-164">Если какой бы то ни было поток возвращает \_ \_ тип преобразования MF E \_ \_ не \_ задан, перейдите к шагу 3.</span><span class="sxs-lookup"><span data-stu-id="5828f-164">If any stream returns MF\_E\_TRANSFORM\_TYPE\_NOT\_SET, skip to step 3.</span></span>
3.  <span data-ttu-id="5828f-165">(Необязательно.) Для каждого выходного потока вызовите [**имфтрансформ:: жетаутпутаваилаблетипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) , чтобы получить список предпочтительных типов для этого потока.</span><span class="sxs-lookup"><span data-stu-id="5828f-165">(Optional.) For each output stream, call [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) to get a list of preferred types for that stream.</span></span>
    -   <span data-ttu-id="5828f-166">Если этот метод возвращает \_ \_ \_ неустановленный тип преобразования MF E \_ \_ , необходимо сначала задать входные типы, а затем вернуться к шагу 1.</span><span class="sxs-lookup"><span data-stu-id="5828f-166">If this method returns MF\_E\_TRANSFORM\_TYPE\_NOT\_SET, you must set the input types first; go back to step 1.</span></span>
    -   <span data-ttu-id="5828f-167">Если какой-либо поток возвращает E \_ нотимпл, то Таблица MFT не имеет списка предпочтительных типов выходных данных; перейдите к шагу 4.</span><span class="sxs-lookup"><span data-stu-id="5828f-167">If any stream returns E\_NOTIMPL, the MFT does not have a list of preferred output types; skip to step 4.</span></span>
4.  <span data-ttu-id="5828f-168">Для каждого выходного потока вызовите [**имфтрансформ:: сетаутпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) , чтобы задать тип выходных данных.</span><span class="sxs-lookup"><span data-stu-id="5828f-168">For each output stream, call [**IMFTransform::SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) to set the output type.</span></span> <span data-ttu-id="5828f-169">Можно использовать тип носителя из шага 3 или тип, описывающий требуемый выходной формат.</span><span class="sxs-lookup"><span data-stu-id="5828f-169">You can use a media type from step 3, or a type that describes your required output format.</span></span>
5.  <span data-ttu-id="5828f-170">Если какие-либо входные потоки не имеют типа мультимедиа, вернитесь к шагу 1.</span><span class="sxs-lookup"><span data-stu-id="5828f-170">If any input streams do not have a media type, go back to step 1.</span></span>

### <a name="get-buffer-requirements"></a><span data-ttu-id="5828f-171">Получение требований к буферу</span><span class="sxs-lookup"><span data-stu-id="5828f-171">Get Buffer Requirements</span></span>

<span data-ttu-id="5828f-172">После того как клиент установит типы носителей, он должен получить требования к буферу для каждого потока:</span><span class="sxs-lookup"><span data-stu-id="5828f-172">After the client sets the media types, it should get the buffer requirements for each stream:</span></span>

-   <span data-ttu-id="5828f-173">Для каждого входного потока вызовите [**имфтрансформ:: жетинпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputstreaminfo).</span><span class="sxs-lookup"><span data-stu-id="5828f-173">For each input stream, call [**IMFTransform::GetInputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputstreaminfo).</span></span>
-   <span data-ttu-id="5828f-174">Для каждого выходного потока вызовите [**имфтрансформ:: жетаутпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo).</span><span class="sxs-lookup"><span data-stu-id="5828f-174">For each output stream, call [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo).</span></span>

### <a name="process-data"></a><span data-ttu-id="5828f-175">Обработка данных</span><span class="sxs-lookup"><span data-stu-id="5828f-175">Process Data</span></span>

<span data-ttu-id="5828f-176">Таблица MFT разработана как надежный конечный автомат.</span><span class="sxs-lookup"><span data-stu-id="5828f-176">An MFT is designed to be a reliable state machine.</span></span> <span data-ttu-id="5828f-177">Он не выполняет обратные вызовы клиенту.</span><span class="sxs-lookup"><span data-stu-id="5828f-177">It does not make any calls back to the client.</span></span>

1.  <span data-ttu-id="5828f-178">Вызовите [**имфтрансформ::P роцессмессаже**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) с сообщением [**\_ \_ о \_ начале \_ потоковой передачи сообщения MFT**](mft-message-notify-begin-streaming.md) .</span><span class="sxs-lookup"><span data-stu-id="5828f-178">Call [**IMFTransform::ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_NOTIFY\_BEGIN\_STREAMING**](mft-message-notify-begin-streaming.md) message.</span></span> <span data-ttu-id="5828f-179">Это сообщение запрашивает основную таблицу файлов, чтобы выделить все необходимые ресурсы во время потоковой передачи.</span><span class="sxs-lookup"><span data-stu-id="5828f-179">This message requests the MFT to allocate any resources it needs during streaming.</span></span>
2.  <span data-ttu-id="5828f-180">Вызовите [**имфтрансформ::P роцессинпут**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput) по крайней мере из одного входного потока для доставки примера входных данных в MFT.</span><span class="sxs-lookup"><span data-stu-id="5828f-180">Call [**IMFTransform::ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput) on at least one input stream to deliver an input sample to the MFT.</span></span>
3.  <span data-ttu-id="5828f-181">(Необязательно.) Вызовите [**имфтрансформ:: жетаутпутстатус**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstatus) , чтобы запросить, может ли MFT создать образец вывода.</span><span class="sxs-lookup"><span data-stu-id="5828f-181">(Optional.) Call [**IMFTransform::GetOutputStatus**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstatus) to query whether the MFT can generate an output sample.</span></span> <span data-ttu-id="5828f-182">Если метод возвращает значение " \_ ОК", проверьте параметр *пдвфлагс* .</span><span class="sxs-lookup"><span data-stu-id="5828f-182">If the method returns S\_OK, check the *pdwFlags* parameter.</span></span> <span data-ttu-id="5828f-183">Если *пдвфлагс* содержит флаг **\_ \_ \_ \_ готовности для образца состояния вывода MFT** , перейдите к шагу 4.</span><span class="sxs-lookup"><span data-stu-id="5828f-183">If *pdwFlags* contains the **MFT\_OUTPUT\_STATUS\_SAMPLE\_READY** flag, go to step 4.</span></span> <span data-ttu-id="5828f-184">Если *пдвфлагс* равен нулю, вернитесь к шагу 2.</span><span class="sxs-lookup"><span data-stu-id="5828f-184">If *pdwFlags* is zero, go back to step 2.</span></span> <span data-ttu-id="5828f-185">Если метод возвращает E \_ нотимпл, перейдите к шагу 4.</span><span class="sxs-lookup"><span data-stu-id="5828f-185">If the method returns E\_NOTIMPL, go to step 4.</span></span>
4.  <span data-ttu-id="5828f-186">Вызовите [**имфтрансформ::P роцессаутпут**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) , чтобы получить выходные данные.</span><span class="sxs-lookup"><span data-stu-id="5828f-186">Call [**IMFTransform::ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) to get output data.</span></span>
    -   <span data-ttu-id="5828f-187">Если метод возвращает для **\_ преобразования MF \_ E \_ требуется \_ больше \_ входных** данных, это означает, что для MFT требуются дополнительные входные данные; вернитесь к шагу 2.</span><span class="sxs-lookup"><span data-stu-id="5828f-187">If the method returns **MF\_E\_TRANSFORM\_NEED\_MORE\_INPUT**, it means the MFT requires more input data; go back to step 2.</span></span>
    -   <span data-ttu-id="5828f-188">Если метод возвращает **\_ \_ \_ \_ изменение потока преобразования MF E**, это означает, что число потоков вывода изменилось или изменился формат вывода.</span><span class="sxs-lookup"><span data-stu-id="5828f-188">If the method returns **MF\_E\_TRANSFORM\_STREAM\_CHANGE**, it means the number of output streams has changed, or the output format has changed.</span></span> <span data-ttu-id="5828f-189">Клиенту может потребоваться запросить новые идентификаторы потоков или задать новые типы носителей.</span><span class="sxs-lookup"><span data-stu-id="5828f-189">The client might need to query for new stream identifiers or set new media types.</span></span> <span data-ttu-id="5828f-190">Дополнительные сведения см. в документации по [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span><span class="sxs-lookup"><span data-stu-id="5828f-190">For more information, see the documentation for [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span></span>
5.  <span data-ttu-id="5828f-191">Если для обработки остались входные данные, перейдите к шагу 2.</span><span class="sxs-lookup"><span data-stu-id="5828f-191">If there is still input data to process, go to step 2.</span></span> <span data-ttu-id="5828f-192">Если таблица MFT использовала все доступные входные данные, перейдите к шагу 6.</span><span class="sxs-lookup"><span data-stu-id="5828f-192">If the MFT has consumed all of the available input data, proceed to step 6.</span></span>
6.  <span data-ttu-id="5828f-193">Вызовите [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) с [**\_ \_ уведомлением о \_ завершении \_ \_ потока сообщения MFT**](mft-message-notify-end-of-stream.md) .</span><span class="sxs-lookup"><span data-stu-id="5828f-193">Call [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_NOTIFY\_END\_OF\_STREAM**](mft-message-notify-end-of-stream.md) message.</span></span>
7.  <span data-ttu-id="5828f-194">Вызовите [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) с сообщением о [**\_ \_ \_ стоке команды сообщения MFT**](mft-message-command-drain.md) .</span><span class="sxs-lookup"><span data-stu-id="5828f-194">Call [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_COMMAND\_DRAIN**](mft-message-command-drain.md) message.</span></span>
8.  <span data-ttu-id="5828f-195">Вызовите [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) , чтобы получить оставшиеся выходные данные.</span><span class="sxs-lookup"><span data-stu-id="5828f-195">Call [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) to get the remaining output.</span></span> <span data-ttu-id="5828f-196">Повторите этот шаг, пока для метода не будет возвращено **\_ Преобразование MF E, \_ \_ требуется \_ больше \_ входных данных**.</span><span class="sxs-lookup"><span data-stu-id="5828f-196">Repeat this step until the method returns **MF\_E\_TRANSFORM\_NEED\_MORE\_INPUT**.</span></span> <span data-ttu-id="5828f-197">Это возвращаемое значение сигнализирует, что все выходные данные были потеряны из MFT.</span><span class="sxs-lookup"><span data-stu-id="5828f-197">This return value signals that all of the output has been drained from the MFT.</span></span> <span data-ttu-id="5828f-198">(Не обрабатывают это как условие ошибки.)</span><span class="sxs-lookup"><span data-stu-id="5828f-198">(Do not treat this as an error condition.)</span></span>

<span data-ttu-id="5828f-199">Описанная здесь последовательность сохраняет как можно меньше данных в MFT.</span><span class="sxs-lookup"><span data-stu-id="5828f-199">The sequence described here keeps as little data as possible in the MFT.</span></span> <span data-ttu-id="5828f-200">После каждого вызова метода [**ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput)клиент пытается получить выходные данные.</span><span class="sxs-lookup"><span data-stu-id="5828f-200">After every call to [**ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput), the client attempts to get output.</span></span> <span data-ttu-id="5828f-201">Для создания одного выходного образца может потребоваться несколько примеров ввода, или один образец ввода может формировать несколько выходных образцов.</span><span class="sxs-lookup"><span data-stu-id="5828f-201">Several input samples might be needed to produce one output sample, or a single input sample might generate several output samples.</span></span> <span data-ttu-id="5828f-202">Оптимальное поведение клиента заключается в вытягивание выходных образцов из MFT до тех пор, пока MFT не потребует больше входных данных.</span><span class="sxs-lookup"><span data-stu-id="5828f-202">The optimal behavior for the client is to pull output samples from the MFT until the MFT requires more input.</span></span>

<span data-ttu-id="5828f-203">Однако таблица MFT должна иметь возможность обрабатывать другой порядок вызовов методов клиентом.</span><span class="sxs-lookup"><span data-stu-id="5828f-203">However, the MFT should be able to handle a different order of method calls by the client.</span></span> <span data-ttu-id="5828f-204">Например, клиент может просто перезвонить между вызовами [**ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput) и [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span><span class="sxs-lookup"><span data-stu-id="5828f-204">For example, the client might simply alternate between calls to [**ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput) and [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span></span> <span data-ttu-id="5828f-205">Таблица MFT должна ограничивать объем вводимых данных, возвращая **MF \_ E \_ нотакцептинг** из **ProcessInput** всякий раз, когда он получает выходные данные для создания.</span><span class="sxs-lookup"><span data-stu-id="5828f-205">The MFT should restrict the amount of input that it gets by returning **MF\_E\_NOTACCEPTING** from **ProcessInput** whenever it has some output to produce.</span></span>

<span data-ttu-id="5828f-206">Порядок вызовов методов, описанных здесь, не является единственной допустимой последовательностью событий.</span><span class="sxs-lookup"><span data-stu-id="5828f-206">The order of method calls described here is not the only valid sequence of events.</span></span> <span data-ttu-id="5828f-207">Например, в шагах 3 и 4 предполагается, что клиент начинается с входных типов, а затем пытается получить типы выходных данных.</span><span class="sxs-lookup"><span data-stu-id="5828f-207">For example, steps 3 and 4 assume that the client starts with the input types and then tries the output types.</span></span> <span data-ttu-id="5828f-208">Клиент также может отменить этот порядок и начать с выходными типами.</span><span class="sxs-lookup"><span data-stu-id="5828f-208">The client can also reverse this order and start with the output types.</span></span> <span data-ttu-id="5828f-209">В любом случае, если таблица MFT требует обратного порядка, она должна вернуть \_ \_ \_ \_ \_ неустановленный тип преобразования с кодом MF E.</span><span class="sxs-lookup"><span data-stu-id="5828f-209">In either case, if the MFT requires the opposite order, it should return the error code MF\_E\_TRANSFORM\_TYPE\_NOT\_SET.</span></span>

<span data-ttu-id="5828f-210">Клиент может в любое время вызывать информационные методы, такие как [**жетинпуткурренттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputcurrenttype) и [**жетаутпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo), в любой момент во время потоковой передачи.</span><span class="sxs-lookup"><span data-stu-id="5828f-210">The client can call informational methods, such as [**GetInputCurrentType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputcurrenttype) and [**GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo), at any time during streaming.</span></span> <span data-ttu-id="5828f-211">Клиент также может попытаться изменить типы носителей в любое время.</span><span class="sxs-lookup"><span data-stu-id="5828f-211">The client can also attempt to change the media types at any time.</span></span> <span data-ttu-id="5828f-212">MFT должен вернуть код ошибки, если это не является допустимой операцией.</span><span class="sxs-lookup"><span data-stu-id="5828f-212">The MFT should return an error code if this is not a valid operation.</span></span> <span data-ttu-id="5828f-213">Короче говоря, МФТС должен очень немного полагаться на порядок операций, Кроме того, что задокументировано в самих вызовах.</span><span class="sxs-lookup"><span data-stu-id="5828f-213">In short, MFTs should assume very little about the order of operations, other than what is documented in the calls themselves.</span></span>

<span data-ttu-id="5828f-214">На следующей диаграмме показана последовательность процедур, описанных в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="5828f-214">The following diagram shows a flow chart of the procedures described in this topic.</span></span>

![Блок-схема, которая ведет от получения идентификаторов потоков посредством циклов, устанавливающих входные типы, получение входных данных и обработку выходных данных.](images/mft-processing.gif)

## <a name="extensions-to-the-basic-model"></a><span data-ttu-id="5828f-216">Расширения для базовой модели</span><span class="sxs-lookup"><span data-stu-id="5828f-216">Extensions to the Basic Model</span></span>

<span data-ttu-id="5828f-217">Кроме того, Таблица MFT может поддерживать некоторые расширения базовой потоковой модели.</span><span class="sxs-lookup"><span data-stu-id="5828f-217">Optionally, an MFT can support some extensions to the basic streaming model.</span></span>

-   <span data-ttu-id="5828f-218">Потоки с отложенным чтением.</span><span class="sxs-lookup"><span data-stu-id="5828f-218">Lazy-read streams.</span></span> <span data-ttu-id="5828f-219">Если метод [**имфтрансформ:: жетаутпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) Возвращает флаг **\_ \_ \_ \_ Lazy Output потока MFT** для выходного потока, клиенту не нужно получать данные из этого потока вывода.</span><span class="sxs-lookup"><span data-stu-id="5828f-219">If the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method returns the **MFT\_OUTPUT\_STREAM\_LAZY\_READ** flag for an output stream, the client does not have to collect data from that output stream.</span></span> <span data-ttu-id="5828f-220">Таблица MFT продолжит принимать входные данные, и в некоторый момент файл MFT будет отбрасывать вывод данных из этого потока.</span><span class="sxs-lookup"><span data-stu-id="5828f-220">The MFT continues to accept input, and at some point the MFT will discard the output data from that stream.</span></span> <span data-ttu-id="5828f-221">Если все выходные потоки имеют этот флаг, MFT никогда не будет принимать входные данные.</span><span class="sxs-lookup"><span data-stu-id="5828f-221">If all of the output streams have this flag, the MFT will never fail to accept input.</span></span> <span data-ttu-id="5828f-222">Примером может быть преобразование визуализации, при котором клиент получает выходные данные только при наличии свободных циклов ЦП для отрисовки визуализации.</span><span class="sxs-lookup"><span data-stu-id="5828f-222">An example might be a visualization transform, where the client gets the output only when it has spare CPU cycles to draw the visualization.</span></span>
-   <span data-ttu-id="5828f-223">Отклоненные потоки.</span><span class="sxs-lookup"><span data-stu-id="5828f-223">Discardable streams.</span></span> <span data-ttu-id="5828f-224">Если метод [**жетаутпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) Возвращает флаг, отмечающий выходной **\_ \_ поток \_ MFT** , для выходного потока, клиент может запрашивать файл MFT для отмены выходных данных, но файл MFT не будет удалять выходные данные, если это не требуется.</span><span class="sxs-lookup"><span data-stu-id="5828f-224">If the [**GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method returns the **MFT\_OUTPUT\_STREAM\_DISCARDABLE** flag for an output stream, the client can request the MFT to discard output, but the MFT will not discard any output unless requested.</span></span> <span data-ttu-id="5828f-225">Когда размер MFT достигает максимального входного буфера, клиент должен либо получить выходные данные, либо запросить удаление файла MFT для отмены выходных данных.</span><span class="sxs-lookup"><span data-stu-id="5828f-225">When the MFT reaches its maximum input buffer, the client must either collect some output data or request the MFT to discard the output.</span></span>
-   <span data-ttu-id="5828f-226">Необязательные потоки.</span><span class="sxs-lookup"><span data-stu-id="5828f-226">Optional streams.</span></span> <span data-ttu-id="5828f-227">Если метод [**жетаутпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) возвращает **\_ \_ \_ необязательный флаг потока вывода MFT** для выходного потока, или метод [**имфтрансформ:: жетинпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputstreaminfo) возвращает необязательный флаг **\_ входного \_ потока \_ MFT** для входного потока, этот поток является необязательным.</span><span class="sxs-lookup"><span data-stu-id="5828f-227">If the [**GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method returns the **MFT\_OUTPUT\_STREAM\_OPTIONAL** flag for an output stream, or the [**IMFTransform::GetInputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputstreaminfo) method returns the **MFT\_INPUT\_STREAM\_OPTIONAL** flag for an input stream, that stream is optional.</span></span> <span data-ttu-id="5828f-228">Клиенту не нужно задавать тип носителя в потоке.</span><span class="sxs-lookup"><span data-stu-id="5828f-228">The client does not have to set a media type on the stream.</span></span> <span data-ttu-id="5828f-229">Если клиент не задает тип, выбирается поток.</span><span class="sxs-lookup"><span data-stu-id="5828f-229">If the client does not set the type, the stream is deselected.</span></span> <span data-ttu-id="5828f-230">В невыбранном потоке вывода не создаются образцы, а клиент не предоставляет буфер для потока при вызове [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span><span class="sxs-lookup"><span data-stu-id="5828f-230">A deselected output stream does not produce samples, and the client does not provide a buffer for the stream when it calls [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span></span> <span data-ttu-id="5828f-231">Невыбранный входной поток не принимает входные данные.</span><span class="sxs-lookup"><span data-stu-id="5828f-231">A deselected input stream does not accept input data.</span></span> <span data-ttu-id="5828f-232">MFT может пометить все входные и выходные потоки как необязательные.</span><span class="sxs-lookup"><span data-stu-id="5828f-232">An MFT can mark all of its input and output streams as optional.</span></span> <span data-ttu-id="5828f-233">Однако ожидается, что для работы MFT необходимо выбрать хотя бы один вход и один выход.</span><span class="sxs-lookup"><span data-stu-id="5828f-233">However, it is expected that at least one input and one output must be selected for the MFT to work.</span></span>
-   <span data-ttu-id="5828f-234">Асинхронная обработка.</span><span class="sxs-lookup"><span data-stu-id="5828f-234">Asynchronous processing.</span></span> <span data-ttu-id="5828f-235">Модель асинхронной обработки была введена в Windows 7.</span><span class="sxs-lookup"><span data-stu-id="5828f-235">The asynchronous processing model was introduced in Windows 7.</span></span> <span data-ttu-id="5828f-236">Он описан в разделе [асинхронная МФТС](asynchronous-mfts.md).</span><span class="sxs-lookup"><span data-stu-id="5828f-236">It is described in the topic [Asynchronous MFTs](asynchronous-mfts.md).</span></span>

## <a name="imf2dbuffer"></a><span data-ttu-id="5828f-237">IMF2DBuffer</span><span class="sxs-lookup"><span data-stu-id="5828f-237">IMF2DBuffer</span></span>

<span data-ttu-id="5828f-238">Если файл MFT обрабатывает несжатые видеоданные, он должен использовать интерфейс [**IMF2DBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imf2dbuffer) для работы с примерами буферов.</span><span class="sxs-lookup"><span data-stu-id="5828f-238">If an MFT processes uncompressed video data, it should use the [**IMF2DBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imf2dbuffer) interface to manipulate the sample buffers.</span></span> <span data-ttu-id="5828f-239">Чтобы получить этот интерфейс, запросите интерфейс [**имфмедиабуффер**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) в любом буфере ввода или вывода.</span><span class="sxs-lookup"><span data-stu-id="5828f-239">To get this interface, query the [**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) interface on any input or output buffer.</span></span> <span data-ttu-id="5828f-240">Не используйте этот интерфейс, если он доступен, может привести к созданию дополнительных буферных копий.</span><span class="sxs-lookup"><span data-stu-id="5828f-240">Not using this interface when it is available may result in additional buffer copies.</span></span> <span data-ttu-id="5828f-241">Чтобы обеспечить правильное использование этого интерфейса, преобразование не должно блокировать буфер с помощью интерфейса **имфмедиабуффер** , если **IMF2DBuffer** доступен.</span><span class="sxs-lookup"><span data-stu-id="5828f-241">To make proper use of this interface, the transform should not lock the buffer using the **IMFMediaBuffer** interface when **IMF2DBuffer** is available.</span></span>

<span data-ttu-id="5828f-242">Дополнительные сведения об обработке видеоданных см. в разделе [несжатые Видеобуферы](uncompressed-video-buffers.md).</span><span class="sxs-lookup"><span data-stu-id="5828f-242">For more information about processing video data, see [Uncompressed Video Buffers](uncompressed-video-buffers.md).</span></span>

## <a name="flushing-an-mft"></a><span data-ttu-id="5828f-243">Очистка MFT</span><span class="sxs-lookup"><span data-stu-id="5828f-243">Flushing an MFT</span></span>

<span data-ttu-id="5828f-244">*Запись* MFT приводит к тому, что MFT удаляет все входные данные.</span><span class="sxs-lookup"><span data-stu-id="5828f-244">*Flushing* an MFT causes the MFT to discard all of its input data.</span></span> <span data-ttu-id="5828f-245">Это может привести к сбою в потоке вывода.</span><span class="sxs-lookup"><span data-stu-id="5828f-245">This can cause a break in the output stream.</span></span> <span data-ttu-id="5828f-246">Как правило, клиент очищает MFT перед переходом к новой точке во входном потоке или при переключении на новый входной поток, когда клиент не заботится о потере данных.</span><span class="sxs-lookup"><span data-stu-id="5828f-246">A client would typically flush an MFT before seeking to a new point in the input stream or switching to a new input stream, when the client does not care about losing data.</span></span>

<span data-ttu-id="5828f-247">Чтобы очистить MFT, вызовите [**имфтрансформ::P роцессмессаже**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) с сообщением о [**\_ \_ команде \_ очистки сообщения MFT**](mft-message-command-flush.md) .</span><span class="sxs-lookup"><span data-stu-id="5828f-247">To flush an MFT, call [**IMFTransform::ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_COMMAND\_FLUSH**](mft-message-command-flush.md) message.</span></span>

## <a name="draining-an-mft"></a><span data-ttu-id="5828f-248">Очистка MFT</span><span class="sxs-lookup"><span data-stu-id="5828f-248">Draining an MFT</span></span>

<span data-ttu-id="5828f-249">*Очистка* MFT приводит к тому, что MFT создает как можно больше выходных данных, так как это может быть уже отправленные входные данные.</span><span class="sxs-lookup"><span data-stu-id="5828f-249">*Draining* an MFT causes the MFT to produce as much output as it can from whatever input data has already been sent.</span></span> <span data-ttu-id="5828f-250">Если MFT не может создать полный образец вывода из доступных входных данных, будут удалены входные данные.</span><span class="sxs-lookup"><span data-stu-id="5828f-250">If the MFT cannot produce a complete output sample from the available input, it will drop input data.</span></span> <span data-ttu-id="5828f-251">Как правило, клиент приводит к стоку MFT при достижении конца исходного потока или непосредственно перед изменением формата в исходном потоке.</span><span class="sxs-lookup"><span data-stu-id="5828f-251">A client would typically drain an MFT when it reached the end of the source stream, or immediately before a format change in the source stream.</span></span> <span data-ttu-id="5828f-252">Чтобы очистить MFT, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="5828f-252">To drain an MFT, do the following:</span></span>

1.  <span data-ttu-id="5828f-253">Вызовите [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) с сообщением о [**\_ \_ \_ стоке команды сообщения MFT**](mft-message-command-drain.md) .</span><span class="sxs-lookup"><span data-stu-id="5828f-253">Call [**ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_COMMAND\_DRAIN**](mft-message-command-drain.md) message.</span></span> <span data-ttu-id="5828f-254">Это сообщение уведомляет основную таблицу файлов о том, что она должна доставлять как можно больше выходных данных, так как это возможно из входных данных, которые уже были отправлены.</span><span class="sxs-lookup"><span data-stu-id="5828f-254">This message notifies the MFT that it should deliver as much output data as it can from the input data that has already been sent.</span></span>
2.  <span data-ttu-id="5828f-255">Вызовите [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) , чтобы получить выходные данные, пока метод не вернет значение **MF \_ E для \_ преобразования \_ требуется \_ больше \_ входных** данных.</span><span class="sxs-lookup"><span data-stu-id="5828f-255">Call [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) to get output data, until the method returns **MF\_E\_TRANSFORM\_NEED\_MORE\_INPUT**.</span></span>

<span data-ttu-id="5828f-256">Пока происходит сток MFT, он не будет принимать дополнительные входные данные.</span><span class="sxs-lookup"><span data-stu-id="5828f-256">While the MFT is being drained, it will not accept any more input.</span></span>

## <a name="sample-attributes"></a><span data-ttu-id="5828f-257">Примеры атрибутов</span><span class="sxs-lookup"><span data-stu-id="5828f-257">Sample Attributes</span></span>

<span data-ttu-id="5828f-258">Входные образцы могут иметь атрибуты, которые должны быть скопированы в соответствующие выходные примеры.</span><span class="sxs-lookup"><span data-stu-id="5828f-258">The input samples might have attributes that must be copied to the corresponding output samples.</span></span>

-   <span data-ttu-id="5828f-259">Если таблица MFT возвращает значение **Variant \_ true** для свойства [**мфпкэй \_ ексаттрибуте \_ Supported**](mfpkey-exattribute-supported-property.md) , MFT должно скопировать атрибуты.</span><span class="sxs-lookup"><span data-stu-id="5828f-259">If the MFT returns **VARIANT\_TRUE** for the [**MFPKEY\_EXATTRIBUTE\_SUPPORTED**](mfpkey-exattribute-supported-property.md) property, the MFT must copy the attributes.</span></span>
-   <span data-ttu-id="5828f-260">Если свойство [**мфпкэй \_ ексаттрибуте \_ Supported**](mfpkey-exattribute-supported-property.md) имеет значение **Variant \_ false** или не задано, клиент должен скопировать атрибуты.</span><span class="sxs-lookup"><span data-stu-id="5828f-260">If the [**MFPKEY\_EXATTRIBUTE\_SUPPORTED**](mfpkey-exattribute-supported-property.md) property is either **VARIANT\_FALSE** or is not set, the client must copy the attributes.</span></span>

<span data-ttu-id="5828f-261">Для MFT с одним входом и одним выходом можно использовать следующее общее правило:</span><span class="sxs-lookup"><span data-stu-id="5828f-261">For an MFT with one input and one output, you can use the following general rule:</span></span>

-   <span data-ttu-id="5828f-262">Если каждый входной образец создает ровно один выходной пример, можно разрешить клиенту копировать атрибуты.</span><span class="sxs-lookup"><span data-stu-id="5828f-262">If each input sample produces exactly one output sample, you can let the client copy the attributes.</span></span> <span data-ttu-id="5828f-263">Оставьте свойство [**мфпкэй \_ ексаттрибуте \_ Supported**](mfpkey-exattribute-supported-property.md) .</span><span class="sxs-lookup"><span data-stu-id="5828f-263">Leave the [**MFPKEY\_EXATTRIBUTE\_SUPPORTED**](mfpkey-exattribute-supported-property.md) property unset.</span></span>
-   <span data-ttu-id="5828f-264">Если между входными примерами и выходными примерами нет соответствия "один к одному", MFT должен определить правильные атрибуты для выходных образцов.</span><span class="sxs-lookup"><span data-stu-id="5828f-264">If there is not a one-to-one correspondence between input samples and output samples, the MFT must determine the correct attributes for output samples.</span></span> <span data-ttu-id="5828f-265">Задайте для свойства [**мфпкэй \_ ексаттрибуте \_ support**](mfpkey-exattribute-supported-property.md) значение **Variant \_ true**.</span><span class="sxs-lookup"><span data-stu-id="5828f-265">Set the [**MFPKEY\_EXATTRIBUTE\_SUPPORTED**](mfpkey-exattribute-supported-property.md) property to **VARIANT\_TRUE**.</span></span>

## <a name="discontinuities"></a><span data-ttu-id="5828f-266">Нарушения</span><span class="sxs-lookup"><span data-stu-id="5828f-266">Discontinuities</span></span>

<span data-ttu-id="5828f-267">Ненепрерывность — это перерыв в потоке аудио или видео.</span><span class="sxs-lookup"><span data-stu-id="5828f-267">A discontinuity is a break in an audio or video stream.</span></span> <span data-ttu-id="5828f-268">Прекращение работы может быть вызвано удалением пакетов в сетевом подключении, повреждением данных файла, переключением из одного исходного потока в другой или широкого ряда других причин.</span><span class="sxs-lookup"><span data-stu-id="5828f-268">Discontinuities can be caused by dropped packets on a network connection, corrupt file data, a switch from one source stream to another, or a wide range of other causes.</span></span> <span data-ttu-id="5828f-269">О прекращении поддержки сообщается путем установки атрибута [**\_ прекращения мфсампликстенсион**](mfsampleextension-discontinuity-attribute.md) в первом примере после прекращения поддержки.</span><span class="sxs-lookup"><span data-stu-id="5828f-269">Discontinuities are signaled by setting the [**MFSampleExtension\_Discontinuity**](mfsampleextension-discontinuity-attribute.md) attribute on the first sample after the discontinuity.</span></span> <span data-ttu-id="5828f-270">Невозможно сообщить о ненепрерывности в середине примера.</span><span class="sxs-lookup"><span data-stu-id="5828f-270">It is not possible to signal a discontinuity in the middle of a sample.</span></span> <span data-ttu-id="5828f-271">Поэтому все ненепрерывные данные должны отправляться в отдельных примерах.</span><span class="sxs-lookup"><span data-stu-id="5828f-271">Therefore, any discontinuous data should be sent in separate samples.</span></span>

<span data-ttu-id="5828f-272">Некоторые преобразования, в частности те, которые обрабатывают несжатые данные, такие как звуковые и видеоэффекты, при обработке входных данных должны игнорировать прекращения.</span><span class="sxs-lookup"><span data-stu-id="5828f-272">Some transforms, especially those that handle uncompressed data, such as audio and video effects, should ignore discontinuities when they process input data.</span></span> <span data-ttu-id="5828f-273">Эти МФТС обычно предназначены для обработки непрерывных данных и должны обрабатывать все получаемые данные как непрерывные, даже после небесперебойности.</span><span class="sxs-lookup"><span data-stu-id="5828f-273">These MFTs are generally designed to handle continuous data, and should treat any data they receive as continuous, even after a discontinuity.</span></span>

<span data-ttu-id="5828f-274">Если файл MFT игнорирует неоднородность входных данных, он по-прежнему должен установить флаг небесперебойности в образце Output, если образец выходных данных имеет ту же метку времени, что и образец input.</span><span class="sxs-lookup"><span data-stu-id="5828f-274">If an MFT ignores a discontinuity on input data, it should still set the discontinuity flag on the output sample, if the output sample has the same time stamp as the input sample.</span></span> <span data-ttu-id="5828f-275">Если образец Output имеет другую отметку времени, то файл MFT не должен распространяться на ненепрерывность.</span><span class="sxs-lookup"><span data-stu-id="5828f-275">If the output sample has a different time stamp, however, the MFT should not propagate the discontinuity.</span></span> <span data-ttu-id="5828f-276">(Например, в некоторых звуковых реобразцах). Ненепрерывность в неправильном месте потока хуже, чем ненепрерывность.</span><span class="sxs-lookup"><span data-stu-id="5828f-276">(This would be the case in some audio resamplers, for example.) A discontinuity at the wrong place in the stream is worse than no discontinuity.</span></span>

<span data-ttu-id="5828f-277">Большинство декодеров не могут игнорировать прекращения, так как ненепрерывность влияет на интерпретацию следующего образца.</span><span class="sxs-lookup"><span data-stu-id="5828f-277">Most decoders cannot ignore discontinuities, because a discontinuity affects the interpretation of the next sample.</span></span> <span data-ttu-id="5828f-278">Любая технология кодирования, использующая сжатие между кадрами, например MPEG-2, попадает в эту категорию.</span><span class="sxs-lookup"><span data-stu-id="5828f-278">Any encoding technology that uses inter-frame compression, such as MPEG-2, falls into this category.</span></span> <span data-ttu-id="5828f-279">Некоторые схемы кодирования используют только сжатие внутри фрейма, например DV и МЖПЕГ.</span><span class="sxs-lookup"><span data-stu-id="5828f-279">Some encoding schemes use only intra-frame compression, such as DV and MJPEG.</span></span> <span data-ttu-id="5828f-280">Эти декодеры могут спокойно игнорировать прекращения.</span><span class="sxs-lookup"><span data-stu-id="5828f-280">These decoders can safely ignore discontinuities.</span></span>

<span data-ttu-id="5828f-281">Преобразования, реагирующие на прекращения работы, должны как обычно выводить большую часть данных до того, как это возможно, и отменять остальные.</span><span class="sxs-lookup"><span data-stu-id="5828f-281">Transforms that respond to discontinuities should generally output as much of the data before the discontinuity as they can, and discard the rest.</span></span> <span data-ttu-id="5828f-282">Входной пример с флагом небесперебойности должен обрабатываться, как будто это первый пример в потоке.</span><span class="sxs-lookup"><span data-stu-id="5828f-282">The input sample with the discontinuity flag should be processed as though it were the first sample in the stream.</span></span> <span data-ttu-id="5828f-283">(Это поведение соответствует значению, указанному для сообщения о [**\_ \_ \_ стоке команды сообщения MFT**](mft-message-command-drain.md) .) Однако точные сведения будут зависеть от формата мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="5828f-283">(This behavior matches what is specified for the [**MFT\_MESSAGE\_COMMAND\_DRAIN**](mft-message-command-drain.md) message.) However, the exact details will depend on the media format.</span></span>

<span data-ttu-id="5828f-284">Если декодер не выполняет никаких действий по устранению небесперебойности, он должен скопировать флаг небесперебойности в выходные данные.</span><span class="sxs-lookup"><span data-stu-id="5828f-284">If a decoder does nothing to mitigate a discontinuity, it should copy the discontinuity flag to the output data.</span></span> <span data-ttu-id="5828f-285">Демультиплексоры и другие МФТС, полностью работающие с сжатыми данными, должны копировать все небесперебойные работы в свои выходные потоки.</span><span class="sxs-lookup"><span data-stu-id="5828f-285">Demultiplexers and other MFTs that work entirely with compressed data must copy any discontinuities to their output streams.</span></span> <span data-ttu-id="5828f-286">В противном случае нисходящие компоненты, возможно, не смогут правильно декодировать сжатые данные.</span><span class="sxs-lookup"><span data-stu-id="5828f-286">Otherwise, the downstream components may not be able to decode the compressed data correctly.</span></span> <span data-ttu-id="5828f-287">Как правило, он почти всегда подходит для передачи непрерывных отработок, если только MFT не содержит явного кода для смягчения небесперебойности.</span><span class="sxs-lookup"><span data-stu-id="5828f-287">In general, it is almost always correct to pass discontinuities downstream, unless the MFT contains explicit code to smooth out discontinuities.</span></span>

## <a name="dynamic-format-changes"></a><span data-ttu-id="5828f-288">Изменения динамического формата</span><span class="sxs-lookup"><span data-stu-id="5828f-288">Dynamic Format Changes</span></span>

<span data-ttu-id="5828f-289">Форматы могут изменяться во время потоковой передачи.</span><span class="sxs-lookup"><span data-stu-id="5828f-289">Formats can change during streaming.</span></span> <span data-ttu-id="5828f-290">Например, пропорции могут меняться в середине потока видео.</span><span class="sxs-lookup"><span data-stu-id="5828f-290">For example, aspect ratio can change in the middle of a video stream.</span></span>

<span data-ttu-id="5828f-291">Дополнительные сведения об обработке изменений потока MFT см. в разделе [Обработка изменений потока](handling-stream-changes.md).</span><span class="sxs-lookup"><span data-stu-id="5828f-291">For details about how stream changes are handled by an MFT, see [Handling Stream Changes](handling-stream-changes.md).</span></span>

## <a name="stream-events"></a><span data-ttu-id="5828f-292">Потоковые события</span><span class="sxs-lookup"><span data-stu-id="5828f-292">Stream Events</span></span>

<span data-ttu-id="5828f-293">Чтобы отправить событие в таблицу MFT, вызовите [**имфтрансформ::P роцессевент**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processevent).</span><span class="sxs-lookup"><span data-stu-id="5828f-293">To send an event to an MFT, call [**IMFTransform::ProcessEvent**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processevent).</span></span> <span data-ttu-id="5828f-294">Если метод возвращает **MF \_ S \_ Transform \_ \_ не \_ распространяет \_ событие**, MFT возвратит событие вызывающему объекту при последующем вызове метода [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span><span class="sxs-lookup"><span data-stu-id="5828f-294">If the method returns **MF\_S\_TRANSFORM\_DO\_NOT\_PROPAGATE\_EVENT**, the MFT will return the event to the caller on a subsequent call to [**ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span></span> <span data-ttu-id="5828f-295">Если метод возвращает любое другое значение **HRESULT** , MFT не будет возвращать событие клиенту в **ProcessOutput**.</span><span class="sxs-lookup"><span data-stu-id="5828f-295">If the method returns any other **HRESULT** value, the MFT will not return the event to the client in **ProcessOutput**.</span></span> <span data-ttu-id="5828f-296">В этом случае клиент несет ответственность за распространение события в следующий компонент конвейера, если это применимо.</span><span class="sxs-lookup"><span data-stu-id="5828f-296">In that case, the client is responsible for propagating the event downstream to the next component in the pipeline, if applicable.</span></span> <span data-ttu-id="5828f-297">Дополнительные сведения см. в разделе [**имфтрансформ::P роцессаутпут**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span><span class="sxs-lookup"><span data-stu-id="5828f-297">For more information, see [**IMFTransform::ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput).</span></span>

## <a name="related-topics"></a><span data-ttu-id="5828f-298">См. также</span><span class="sxs-lookup"><span data-stu-id="5828f-298">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5828f-299">Преобразования Media Foundation</span><span class="sxs-lookup"><span data-stu-id="5828f-299">Media Foundation Transforms</span></span>](media-foundation-transforms.md)
</dt> </dl>

 

 



