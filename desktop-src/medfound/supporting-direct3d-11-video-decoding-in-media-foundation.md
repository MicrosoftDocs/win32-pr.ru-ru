---
description: В этом разделе описывается поддержка Microsoft Direct3D 11 в Microsoft Media Foundation декодере.
ms.assetid: 656556AA-0266-4318-9D3C-AED75BD728F6
title: Поддержка декодирования видео Direct3D 11 в Media Foundation
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 542f7244922dc7947f22e4d33027fdcac1962fe5
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "105664823"
---
# <a name="supporting-direct3d-11-video-decoding-in-media-foundation"></a><span data-ttu-id="4a751-103">Поддержка декодирования видео Direct3D 11 в Media Foundation</span><span class="sxs-lookup"><span data-stu-id="4a751-103">Supporting Direct3D 11 Video Decoding in Media Foundation</span></span>

<span data-ttu-id="4a751-104">В этом разделе описывается поддержка Microsoft Direct3D 11 в Microsoft Media Foundation декодере.</span><span class="sxs-lookup"><span data-stu-id="4a751-104">This topic describes how to support Microsoft Direct3D 11 in a Microsoft Media Foundation decoder.</span></span> <span data-ttu-id="4a751-105">В частности, он описывает взаимодействие между декодером и модулем подготовки видео.</span><span class="sxs-lookup"><span data-stu-id="4a751-105">Specifically, it describes the communication between the decoder and the video renderer.</span></span> <span data-ttu-id="4a751-106">В этом разделе не описывается, как реализовать операции декодирования.</span><span class="sxs-lookup"><span data-stu-id="4a751-106">This topic does not describe how to implement the decoding operations.</span></span>

-   [<span data-ttu-id="4a751-107">Обзор</span><span class="sxs-lookup"><span data-stu-id="4a751-107">Overview</span></span>](#overview)
-   [<span data-ttu-id="4a751-108">Открытие маркера устройства</span><span class="sxs-lookup"><span data-stu-id="4a751-108">Open a Device Handle</span></span>](#open-a-device-handle)
-   [<span data-ttu-id="4a751-109">Поиск конфигурации декодера</span><span class="sxs-lookup"><span data-stu-id="4a751-109">Find a Decoder Configuration</span></span>](#find-a-decoder-configuration)
-   [<span data-ttu-id="4a751-110">Откат к декодированию программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="4a751-110">Fallback to Software Decoding</span></span>](#fallback-to-software-decoding)
-   [<span data-ttu-id="4a751-111">Выделение несжатых буферов</span><span class="sxs-lookup"><span data-stu-id="4a751-111">Allocating Uncompressed Buffers</span></span>](#allocating-uncompressed-buffers)
-   [<span data-ttu-id="4a751-112">Декодирование</span><span class="sxs-lookup"><span data-stu-id="4a751-112">Decoding</span></span>](#supporting-direct3d-11-video-decoding-in-media-foundation)
-   [<span data-ttu-id="4a751-113">См. также</span><span class="sxs-lookup"><span data-stu-id="4a751-113">Related topics</span></span>](#related-topics)

## <a name="overview"></a><span data-ttu-id="4a751-114">Обзор</span><span class="sxs-lookup"><span data-stu-id="4a751-114">Overview</span></span>

<span data-ttu-id="4a751-115">В оставшейся части этого раздела используются следующие термины:</span><span class="sxs-lookup"><span data-stu-id="4a751-115">In the remainder of this topic, the following terms are used:</span></span>

-   <span data-ttu-id="4a751-116">**Программный декодер**.</span><span class="sxs-lookup"><span data-stu-id="4a751-116">**Software decoder**.</span></span> <span data-ttu-id="4a751-117">Программный декодер — это Media Foundation преобразование (MFT), которое получает сжатые образцы видео и выводит несжатые видеокадры.</span><span class="sxs-lookup"><span data-stu-id="4a751-117">The software decoder is the Media Foundation transform (MFT) that receives compressed video samples and outputs uncompressed video frames.</span></span>
-   <span data-ttu-id="4a751-118">**Устройство декодера**.</span><span class="sxs-lookup"><span data-stu-id="4a751-118">**Decoder device**.</span></span> <span data-ttu-id="4a751-119">Устройство декодера — это ускоритель видео, который реализуется графическим драйвером.</span><span class="sxs-lookup"><span data-stu-id="4a751-119">The decoder device is the video accelerator, and is implemented by the graphics driver.</span></span> <span data-ttu-id="4a751-120">Устройство декодера выполняет операции декодирования с ускоренной декодированием.</span><span class="sxs-lookup"><span data-stu-id="4a751-120">The decoder device performs accelerated decoding operations.</span></span>
-   <span data-ttu-id="4a751-121">**Конвейер**.</span><span class="sxs-lookup"><span data-stu-id="4a751-121">**Pipeline**.</span></span> <span data-ttu-id="4a751-122">В конвейере размещается программный декодер и доставляются буферы в программный декодер и из него.</span><span class="sxs-lookup"><span data-stu-id="4a751-122">The pipeline hosts the software decoder and delivers buffers to and from the software decoder.</span></span> <span data-ttu-id="4a751-123">В зависимости от приложения конвейер может быть [сеансом мультимедиа](media-session.md), [модулем чтения исходного](source-reader.md)кода или кодом приложения, который непосредственно вызывает таблицу MFT.</span><span class="sxs-lookup"><span data-stu-id="4a751-123">Depending on the application, the pipeline might be the [Media Session](media-session.md), the [Source Reader](source-reader.md), or application code that directly calls into the MFT.</span></span>

<span data-ttu-id="4a751-124">Чтобы выполнить декодирование с помощью Direct3D 11, программный декодер должен иметь указатель на устройство Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="4a751-124">To perform decoding using Direct3D 11, the software decoder must have a pointer to a Direct3D 11 device.</span></span> <span data-ttu-id="4a751-125">Устройство Direct3D 11 создается извне программного декодера.</span><span class="sxs-lookup"><span data-stu-id="4a751-125">The Direct3D 11 device is created externally to the software decoder.</span></span> <span data-ttu-id="4a751-126">В сценарии [сеанса мультимедиа](media-session.md) модуль подготовки видео создает устройство Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="4a751-126">In a [Media Session](media-session.md) scenario, the video renderer creates the Direct3D 11 device.</span></span> <span data-ttu-id="4a751-127">В сценарии [модуля чтения исходного кода](source-reader.md) обычно приложение создает устройство Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="4a751-127">In a [Source Reader](source-reader.md) scenario, typically the application creates the Direct3D 11 device.</span></span>

<span data-ttu-id="4a751-128">Диспетчер устройств DXGI используется для совместного использования компонентов Direct3D 11 между компонентами.</span><span class="sxs-lookup"><span data-stu-id="4a751-128">The DXGI Device Manager is used to share the Direct3D 11 between components.</span></span> <span data-ttu-id="4a751-129">Диспетчер устройств DXGI предоставляет интерфейс [**имфдксгидевицеманажер**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) .</span><span class="sxs-lookup"><span data-stu-id="4a751-129">The DXGI Device Manager exposes the [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) interface.</span></span> <span data-ttu-id="4a751-130">Конвейер устанавливает указатель **имфдксгидевицеманажер** на программном декодере, отправляя сообщение MFT с указанием сообщения [**\_ \_ \_ \_ диспетчера D3D**](mft-message-set-d3d-manager.md) .</span><span class="sxs-lookup"><span data-stu-id="4a751-130">The pipeline sets the **IMFDXGIDeviceManager** pointer on the software decoder by sending the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message.</span></span>

<span data-ttu-id="4a751-131">На следующей схеме показана связь между программным декодером, Direct3D 11 и конвейером.</span><span class="sxs-lookup"><span data-stu-id="4a751-131">The following diagram shows the relation between the software decoder, the Direct3D 11, and the pipeline.</span></span>

![Схема, на которой показан программный декодер и Диспетчер устройств DXGI.](images/d3d11video01.png)

<span data-ttu-id="4a751-133">Ниже приведены основные шаги, которые должен выполнить программный декодер для поддержки Direct3D 11 в Media Foundation.</span><span class="sxs-lookup"><span data-stu-id="4a751-133">Here are the basic steps that a software decoder must perform to support Direct3D 11 in Media Foundation:</span></span>

1.  <span data-ttu-id="4a751-134">Откройте обработчик для устройства Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="4a751-134">Open a handle to the Direct3D 11 device.</span></span>
2.  <span data-ttu-id="4a751-135">Найдите конфигурацию декодера.</span><span class="sxs-lookup"><span data-stu-id="4a751-135">Find a decoder configuration.</span></span>
3.  <span data-ttu-id="4a751-136">Выделение несжатых буферов.</span><span class="sxs-lookup"><span data-stu-id="4a751-136">Allocate uncompressed buffers.</span></span>
4.  <span data-ttu-id="4a751-137">Декодирование кадров.</span><span class="sxs-lookup"><span data-stu-id="4a751-137">Decode frames.</span></span>

<span data-ttu-id="4a751-138">Эти действия более подробно описаны в оставшейся части этого раздела.</span><span class="sxs-lookup"><span data-stu-id="4a751-138">These steps are described in more detail in the remainder of this topic.</span></span>

## <a name="open-a-device-handle"></a><span data-ttu-id="4a751-139">Открытие маркера устройства</span><span class="sxs-lookup"><span data-stu-id="4a751-139">Open a Device Handle</span></span>

<span data-ttu-id="4a751-140">В MFT для декодера используется диспетчер устройств DXGI для получения маркера на устройство Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="4a751-140">The decoder MFT uses the DXGI device manager to get a handle to the Direct3D 11 device.</span></span> <span data-ttu-id="4a751-141">Чтобы открыть маркер устройства, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="4a751-141">To open the device handle, perform the following steps:</span></span>

1.  <span data-ttu-id="4a751-142">В MFT декодера необходимо предоставить атрибуту [MF \_ SA \_ D3D11 с \_ поддержкой](mf-sa-d3d11-aware.md) значение **true**.</span><span class="sxs-lookup"><span data-stu-id="4a751-142">The decoder MFT must expose the [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md) attribute with the value **TRUE**.</span></span>
2.  <span data-ttu-id="4a751-143">Загрузчик топологии запрашивает этот атрибут путем вызова [**имфтрансформ:: InAttribute**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes).</span><span class="sxs-lookup"><span data-stu-id="4a751-143">The Topology Loader queries this attribute by calling [**IMFTransform::GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes).</span></span> <span data-ttu-id="4a751-144">Значение **true** указывает, что MFT поддерживает Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="4a751-144">The value **TRUE** indicates that the MFT supports Direct3D 11.</span></span>
3.  <span data-ttu-id="4a751-145">Загрузчик топологии вызывает [**имфтрансформ::P роцессмессаже**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) с сообщением из [**таблицы \_ MFT \_ Set \_ D3D Message \_ Manager**](mft-message-set-d3d-manager.md) .</span><span class="sxs-lookup"><span data-stu-id="4a751-145">The Topology Loader calls [**IMFTransform::ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message.</span></span> <span data-ttu-id="4a751-146">Параметр *улпарам* — это указатель [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) на диспетчер устройств DXGI.</span><span class="sxs-lookup"><span data-stu-id="4a751-146">The *ulParam* parameter is an [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) pointer to the DXGI device manager.</span></span> <span data-ttu-id="4a751-147">Запросите этот указатель для интерфейса [**имфдксгидевицеманажер**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) .</span><span class="sxs-lookup"><span data-stu-id="4a751-147">Query this pointer for the [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) interface.</span></span>
4.  <span data-ttu-id="4a751-148">Вызовите [**имфдксгидевицеманажер:: опендевицехандле**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-opendevicehandle) , чтобы получить маркер устройства Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="4a751-148">Call [**IMFDXGIDeviceManager::OpenDeviceHandle**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-opendevicehandle) to get a handle to the Direct3D 11 device.</span></span>
5.  <span data-ttu-id="4a751-149">Чтобы получить указатель на устройство Direct3D 11, вызовите [**имфдксгидевицеманажер:: жетвидеосервице**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span><span class="sxs-lookup"><span data-stu-id="4a751-149">To get a pointer to the Direct3D 11 device, call [**IMFDXGIDeviceManager::GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span></span> <span data-ttu-id="4a751-150">Передайте маркер устройства и значение **IID \_ ID3D11Device**.</span><span class="sxs-lookup"><span data-stu-id="4a751-150">Pass in the device handle and the value **IID\_ID3D11Device**.</span></span> <span data-ttu-id="4a751-151">Метод возвращает указатель на интерфейс [**ID3D11Device**](/windows/win32/api/d3d11/nn-d3d11-id3d11device) .</span><span class="sxs-lookup"><span data-stu-id="4a751-151">The method returns a pointer to the [**ID3D11Device**](/windows/win32/api/d3d11/nn-d3d11-id3d11device) interface.</span></span>
6.  <span data-ttu-id="4a751-152">Чтобы получить указатель на ускоритель видео, вызовите [**имфдксгидевицеманажер:: жетвидеосервице**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice) еще раз.</span><span class="sxs-lookup"><span data-stu-id="4a751-152">To get a pointer to the video accelerator, call [**IMFDXGIDeviceManager::GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice) again.</span></span> <span data-ttu-id="4a751-153">На этот раз передайте маркер устройства и значение **IID \_ ID3D11VideoDevice**.</span><span class="sxs-lookup"><span data-stu-id="4a751-153">This time, pass in the device handle and the value **IID\_ID3D11VideoDevice**.</span></span> <span data-ttu-id="4a751-154">Метод возвращает указатель на интерфейс [**ID3D11VideoDevice**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodevice) .</span><span class="sxs-lookup"><span data-stu-id="4a751-154">The method returns a pointer to the [**ID3D11VideoDevice**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodevice) interface.</span></span>
7.  <span data-ttu-id="4a751-155">Вызовите [**ID3D11Device:: жетиммедиатеконтекст**](/windows/win32/api/d3d11/nf-d3d11-id3d11device-getimmediatecontext) , чтобы получить указатель [**ссылку ID3D11DeviceContext**](/windows/win32/api/d3d11/nn-d3d11-id3d11devicecontext) .</span><span class="sxs-lookup"><span data-stu-id="4a751-155">Call [**ID3D11Device::GetImmediateContext**](/windows/win32/api/d3d11/nf-d3d11-id3d11device-getimmediatecontext) to get an [**ID3D11DeviceContext**](/windows/win32/api/d3d11/nn-d3d11-id3d11devicecontext) pointer.</span></span>
8.  <span data-ttu-id="4a751-156">Вызовите [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) для [**ссылку ID3D11DeviceContext**](/windows/win32/api/d3d11/nn-d3d11-id3d11devicecontext) , чтобы получить указатель [**ID3D11VideoContext**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videocontext) .</span><span class="sxs-lookup"><span data-stu-id="4a751-156">Call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) on the [**ID3D11DeviceContext**](/windows/win32/api/d3d11/nn-d3d11-id3d11devicecontext) to get an [**ID3D11VideoContext**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videocontext) pointer.</span></span>
9.  <span data-ttu-id="4a751-157">Рекомендуется использовать многопотоковую защиту в контексте устройства, чтобы избежать проблем взаимоблокировки, которые иногда могут возникнуть при вызове [**ID3D11VideoContext:: жетдекодербуффер**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-getdecoderbuffer) или [**ID3D11VideoContext:: релеаседекодербуффер**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-releasedecoderbuffer).</span><span class="sxs-lookup"><span data-stu-id="4a751-157">It is recommended that you use multi-thread protection on the device context to prevent deadlock issues that can sometimes happen when you call [**ID3D11VideoContext::GetDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-getdecoderbuffer) or [**ID3D11VideoContext::ReleaseDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-releasedecoderbuffer).</span></span> <span data-ttu-id="4a751-158">Чтобы установить защиту с несколькими потоками, сначала вызовите [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) для [**ID3D11Device**](/windows/win32/api/d3d11/nn-d3d11-id3d11device) , чтобы получить указатель [**ID3D10Multithread**](/windows/win32/api/d3d10/nn-d3d10-id3d10multithread) .</span><span class="sxs-lookup"><span data-stu-id="4a751-158">To set multi-thread protection, first call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) on [**ID3D11Device**](/windows/win32/api/d3d11/nn-d3d11-id3d11device) to get an [**ID3D10Multithread**](/windows/win32/api/d3d10/nn-d3d10-id3d10multithread) pointer.</span></span> <span data-ttu-id="4a751-159">Затем вызовите [**ID3D10Multithread:: сетмултисреадпротектед**](/windows/win32/api/d3d10/nf-d3d10-id3d10multithread-setmultithreadprotected), передав **значение true** для *бмтпротект*.</span><span class="sxs-lookup"><span data-stu-id="4a751-159">Then call [**ID3D10Multithread::SetMultithreadProtected**](/windows/win32/api/d3d10/nf-d3d10-id3d10multithread-setmultithreadprotected), passing in **true** for *bMTProtect*.</span></span>

## <a name="find-a-decoder-configuration"></a><span data-ttu-id="4a751-160">Поиск конфигурации декодера</span><span class="sxs-lookup"><span data-stu-id="4a751-160">Find a Decoder Configuration</span></span>

<span data-ttu-id="4a751-161">Чтобы выполнить декодирование, программный декодер должен найти совместимую конфигурацию, поддерживаемую устройством декодера, включая формат целевого объекта подготовки к просмотру.</span><span class="sxs-lookup"><span data-stu-id="4a751-161">To perform decoding, the software decoder must find a compatible configuration that is supported by the decoder device, including a render-target format.</span></span> <span data-ttu-id="4a751-162">Этот шаг выполняется внутри метода [**имфтрансформ:: сетинпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) , как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="4a751-162">This step occurs inside the [**IMFTransform::SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) method, as follows.</span></span>

1.  <span data-ttu-id="4a751-163">Проверьте тип входного носителя.</span><span class="sxs-lookup"><span data-stu-id="4a751-163">Validate the input media type.</span></span> <span data-ttu-id="4a751-164">Если тип отклонен, пропустите оставшиеся шаги и возвратите код ошибки.</span><span class="sxs-lookup"><span data-stu-id="4a751-164">If the type is rejected, skip the remaining steps and return an error code.</span></span>
2.  <span data-ttu-id="4a751-165">Вызовите [**ID3D11VideoDevice:: жетвидеодекодерпрофилекаунт**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderprofilecount) , чтобы получить количество поддерживаемых профилей.</span><span class="sxs-lookup"><span data-stu-id="4a751-165">Call [**ID3D11VideoDevice::GetVideoDecoderProfileCount**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderprofilecount) to get the number of supported profiles.</span></span>
3.  <span data-ttu-id="4a751-166">Вызовите метод [**ID3D11VideoDevice:: жетвидеодекодерпрофиле**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderprofile) , чтобы перечислить профили и получить идентификаторы GUID профиля.</span><span class="sxs-lookup"><span data-stu-id="4a751-166">Call [**ID3D11VideoDevice::GetVideoDecoderProfile**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderprofile) to enumerate the profiles and get the profile GUIDs.</span></span>
4.  <span data-ttu-id="4a751-167">Найдите идентификатор GUID профиля, который соответствует формату видео и возможностям программного декодера.</span><span class="sxs-lookup"><span data-stu-id="4a751-167">Look for a profile GUID that matches the video format and the capabilities of the software decoder.</span></span> <span data-ttu-id="4a751-168">Например, декодер MPEG-2 будет искать в **D3D11 \_ декодера \_ \_ MPEG2 \_ мокомп**, D3D11,**\_ профиль кодирования \_ \_ MPEG2 \_ идкт** и D3D11 декодера с многоформатным кодировщиком **\_ \_ \_ MPEG2 \_ ВЛД**.</span><span class="sxs-lookup"><span data-stu-id="4a751-168">For example, an MPEG-2 decoder would look for **D3D11\_DECODER\_PROFILE\_MPEG2\_MOCOMP**,**D3D11\_DECODER\_PROFILE\_MPEG2\_IDCT**, and **D3D11\_DECODER\_PROFILE\_MPEG2\_VLD**.</span></span>
5.  <span data-ttu-id="4a751-169">Если найден подходящий GUID декодера, проверьте выходной формат, вызвав метод [**ID3D11VideoDevice:: чекквидеодекодерформат**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-checkvideodecoderformat) .</span><span class="sxs-lookup"><span data-stu-id="4a751-169">If a suitable decoder GUID is found, check the output format by calling the [**ID3D11VideoDevice::CheckVideoDecoderFormat**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-checkvideodecoderformat) method.</span></span> <span data-ttu-id="4a751-170">Передайте GUID декодера и значение **\_ формата DXGI** , которое указывает формат целевого объекта подготовки к просмотру.</span><span class="sxs-lookup"><span data-stu-id="4a751-170">Pass in the decoder GUID and a **DXGI\_FORMAT** value that specifies the render-target format.</span></span>
6.  <span data-ttu-id="4a751-171">Затем найдите подходящую конфигурацию для декодера.</span><span class="sxs-lookup"><span data-stu-id="4a751-171">Next, find a suitable configuration for the decoder.</span></span>
    1.  <span data-ttu-id="4a751-172">Вызовите [**ID3D11VideoDevice:: жетвидеодекодерконфигкаунт**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderconfigcount) , чтобы получить количество конфигураций декодера.</span><span class="sxs-lookup"><span data-stu-id="4a751-172">Call [**ID3D11VideoDevice::GetVideoDecoderConfigCount**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderconfigcount) to get the number of decoder configurations.</span></span> <span data-ttu-id="4a751-173">Передайте тот же GUID устройства декодера вместе с структурой [**D3D11 \_ \_ видеодекодера \_ DESC**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_video_decoder_desc) , описывающей предложенный формат целевого объекта рендеринга.</span><span class="sxs-lookup"><span data-stu-id="4a751-173">Pass in the same decoder device GUID, along with a [**D3D11\_VIDEO\_DECODER\_DESC**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_video_decoder_desc) structure that describes the proposed render-target format.</span></span>
    2.  <span data-ttu-id="4a751-174">Вызовите [**ID3D11VideoDevice:: жетвидеодекодерконфиг**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderconfig) , чтобы перечислить конфигурации декодера.</span><span class="sxs-lookup"><span data-stu-id="4a751-174">Call [**ID3D11VideoDevice::GetVideoDecoderConfig**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getvideodecoderconfig) to enumerate the decoder configurations.</span></span>

<span data-ttu-id="4a751-175">В методе [**имфтрансформ:: жетаутпутаваилаблетипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) Возвращает формат видео без сжатия, основанный на предложенном формате целевого объекта подготовки к просмотру.</span><span class="sxs-lookup"><span data-stu-id="4a751-175">In the [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) method, return an uncompressed video format based on the proposed render-target format.</span></span>

<span data-ttu-id="4a751-176">В методе [**имфтрансформ:: сетаутпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) Проверьте тип носителя в соответствии с форматом целевого объекта прорисовки.</span><span class="sxs-lookup"><span data-stu-id="4a751-176">In the [**IMFTransform::SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) method, check the media type against the render target format.</span></span>

## <a name="fallback-to-software-decoding"></a><span data-ttu-id="4a751-177">Откат к декодированию программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="4a751-177">Fallback to Software Decoding</span></span>

<span data-ttu-id="4a751-178">Возможно, MFT не удается найти конфигурацию.</span><span class="sxs-lookup"><span data-stu-id="4a751-178">The MFT might be unable to find a configuration.</span></span> <span data-ttu-id="4a751-179">Например, графический драйвер может не поддерживать правильные возможности.</span><span class="sxs-lookup"><span data-stu-id="4a751-179">For example, the graphics driver might not support the right capabilities.</span></span> <span data-ttu-id="4a751-180">В этом случае MFT должно возвращаться к программному декодированию, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="4a751-180">In that case, the MFT must fall back to software decoding, as follows.</span></span>

1.  <span data-ttu-id="4a751-181">Методы [**сетинпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) и [**сетаутпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) должны возвращать **MF \_ E \_ неподдерживаемого \_ \_ типа D3D**.</span><span class="sxs-lookup"><span data-stu-id="4a751-181">The [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) and [**SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) methods should both return **MF\_E\_UNSUPPORTED\_D3D\_TYPE**.</span></span>
2.  <span data-ttu-id="4a751-182">В ответ загрузчик топологии будет отправлять сообщение MFT с указанием значения **null** для параметра *улпарам* . [**\_ \_ \_ \_**](mft-message-set-d3d-manager.md)</span><span class="sxs-lookup"><span data-stu-id="4a751-182">In response, the Topology Loader will send the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message with the value **NULL** for the *ulParam* parameter.</span></span>
3.  <span data-ttu-id="4a751-183">Основная таблица освобождает указатель на интерфейс [**имфдксгидевицеманажер**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) .</span><span class="sxs-lookup"><span data-stu-id="4a751-183">The MFT releases its pointer to the [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) interface.</span></span>
4.  <span data-ttu-id="4a751-184">Загрузчик топологии повторно согласовывает тип носителя.</span><span class="sxs-lookup"><span data-stu-id="4a751-184">The Topology Loader renegotiates the media type.</span></span>

<span data-ttu-id="4a751-185">На этом этапе MFT может использовать программное декодирование.</span><span class="sxs-lookup"><span data-stu-id="4a751-185">At this point, the MFT can use software decoding.</span></span>

## <a name="allocating-uncompressed-buffers"></a><span data-ttu-id="4a751-186">Выделение несжатых буферов</span><span class="sxs-lookup"><span data-stu-id="4a751-186">Allocating Uncompressed Buffers</span></span>

<span data-ttu-id="4a751-187">Декодер отвечает за выделение текстур Direct3D 11 для использования в качестве несжатых буферов видео.</span><span class="sxs-lookup"><span data-stu-id="4a751-187">The decoder is responsible for allocating Direct3D 11 textures to use as uncompressed video buffers.</span></span> <span data-ttu-id="4a751-188">Атрибут [ \_ \_ счетчика с минимальным \_ \_ \_ количеством выходных данных для SA](mf-sa-minimum-output-sample-count.md) по протоколу MF в атрибутах выходного потока (см.[**имфтрансформ:: жетаутпутстреаматтрибутес**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreamattributes)) используется для определения количества поверхностей, выделяемых декодером для использования модулем подготовки видео для дечередования.</span><span class="sxs-lookup"><span data-stu-id="4a751-188">The [MF\_SA\_MINIMUM\_OUTPUT\_SAMPLE\_COUNT](mf-sa-minimum-output-sample-count.md) attribute in the output stream attributes (see [**IMFTransform::GetOutputStreamAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreamattributes)) is used to determine how many surfaces the decoder should allocate for the video renderer to use for deinterlacing .</span></span> <span data-ttu-id="4a751-189">Декодер должен использовать это значение, привязанное к некоторым разумным верхним и нижним ограничениям, например 3-32.</span><span class="sxs-lookup"><span data-stu-id="4a751-189">A decoder should use this value bounding it for some reasonable upper and lower limits, for example 3-32.</span></span> <span data-ttu-id="4a751-190">Последовательное содержимое см. в разделе [ \_ \_ минимальное \_ \_ \_ число \_ выборок для учетных данных MF SA](mf-sa-minimum-output-sample-count-progressive.md).</span><span class="sxs-lookup"><span data-stu-id="4a751-190">For progressive content see [MF\_SA\_MINIMUM\_OUTPUT\_SAMPLE\_COUNT\_PROGRESSIVE](mf-sa-minimum-output-sample-count-progressive.md).</span></span>

<span data-ttu-id="4a751-191">В методе [**имфтрансформ:: жетаутпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) Задайте флаг **\_ \_ \_ \_ Samples в выходной поток** MFT в структуре [**\_ \_ \_ сведений потока вывода MFT**](/windows/win32/api/mftransform/ne-mftransform-_mft_output_stream_info_flags) .</span><span class="sxs-lookup"><span data-stu-id="4a751-191">In the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method, set the **MFT\_OUTPUT\_STREAM\_PROVIDES\_SAMPLES** flag in the [**MFT\_OUTPUT\_STREAM\_INFO**](/windows/win32/api/mftransform/ne-mftransform-_mft_output_stream_info_flags) structure.</span></span> <span data-ttu-id="4a751-192">Этот флаг уведомляет сеанс мультимедиа о том, что MFT выделяет свои собственные выходные примеры.</span><span class="sxs-lookup"><span data-stu-id="4a751-192">This flag notifies the Media Session that the MFT allocates its own output samples.</span></span> <span data-ttu-id="4a751-193">Чтобы выделить выходные образцы, MFT выполняет следующие действия:</span><span class="sxs-lookup"><span data-stu-id="4a751-193">To allocate the output samples, the MFT performs the following steps:</span></span>

1.  <span data-ttu-id="4a751-194">Создайте массив двумерных текстур, вызвав [**ID3D11Device:: CreateTexture2D**](/windows/win32/api/d3d11/nf-d3d11-id3d11device-createtexture2d).</span><span class="sxs-lookup"><span data-stu-id="4a751-194">Create a 2D texture array by calling [**ID3D11Device::CreateTexture2D**](/windows/win32/api/d3d11/nf-d3d11-id3d11device-createtexture2d).</span></span> <span data-ttu-id="4a751-195">В структуре [**D3D11 \_ TEXTURE2D \_ DESC**](/windows/win32/api/d3d11/ns-d3d11-d3d11_texture2d_desc) задайте **размера массива** равным количеству поверхностей, которое требуется декодеру.</span><span class="sxs-lookup"><span data-stu-id="4a751-195">In the [**D3D11\_TEXTURE2D\_DESC**](/windows/win32/api/d3d11/ns-d3d11-d3d11_texture2d_desc) structure, set **ArraySize** equal to the number of surfaces that the decoder needs.</span></span> <span data-ttu-id="4a751-196">В том числе:</span><span class="sxs-lookup"><span data-stu-id="4a751-196">This includes:</span></span>
    -   <span data-ttu-id="4a751-197">Поверхности для кадров ссылок.</span><span class="sxs-lookup"><span data-stu-id="4a751-197">Surfaces for reference frames.</span></span>
    -   <span data-ttu-id="4a751-198">Поверхности для разчередования (три поверхности).</span><span class="sxs-lookup"><span data-stu-id="4a751-198">Surfaces for deinterlacing (three surfaces).</span></span>
    -   <span data-ttu-id="4a751-199">Поверхности, необходимые декодеру для буферизации.</span><span class="sxs-lookup"><span data-stu-id="4a751-199">Surfaces that the decoder needs for buffering.</span></span>

    <span data-ttu-id="4a751-200">Флаги привязки (**биндфлагс**) должны включать флаг **\_ \_ декодера привязки D3D11** и все флаги привязки, заданные с помощью атрибута [MF \_ SA \_ D3D11 \_ биндфлагс](mf-sa-d3d11-bindflags.md) в атрибутах потока вывода.</span><span class="sxs-lookup"><span data-stu-id="4a751-200">The binding flags (**BindFlags**) should include the **D3D11\_BIND\_DECODER** flag and any bind flags set through the [MF\_SA\_D3D11\_BINDFLAGS](mf-sa-d3d11-bindflags.md) attribute in the output stream attributes.</span></span>
2.  <span data-ttu-id="4a751-201">Для каждой поверхности в массиве текстуры вызовите [**ID3D11VideoDevice:: креатевидеодекодераутпутвиев**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createvideodecoderoutputview) , чтобы создать представление вывода видеодекодера.</span><span class="sxs-lookup"><span data-stu-id="4a751-201">For each surface in the texture array, call [**ID3D11VideoDevice::CreateVideoDecoderOutputView**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createvideodecoderoutputview) to create a video decoder output view.</span></span> <span data-ttu-id="4a751-202">Во время декодирования эти представления вывода будут переданы методу [**ID3D11VideoContext::D екодербегинфраме**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderbeginframe) .</span><span class="sxs-lookup"><span data-stu-id="4a751-202">During decoding, these output views will be passed to the [**ID3D11VideoContext::DecoderBeginFrame**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderbeginframe) method.</span></span>
3.  <span data-ttu-id="4a751-203">Для каждой поверхности в массиве текстуры создайте пример носителя, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="4a751-203">For each surface in the texture array, create a media sample as follows:</span></span>
    1.  <span data-ttu-id="4a751-204">Создайте буфер мультимедиа DXGI, вызвав функцию [**мфкреатедксгисурфацебуффер**](/windows/desktop/api/mfapi/nf-mfapi-mfcreatedxgisurfacebuffer) .</span><span class="sxs-lookup"><span data-stu-id="4a751-204">Create a DXGI media buffer by calling the [**MFCreateDXGISurfaceBuffer**](/windows/desktop/api/mfapi/nf-mfapi-mfcreatedxgisurfacebuffer) function.</span></span> <span data-ttu-id="4a751-205">Передайте указатель [**ID3D11Texture2D**](/windows/win32/api/d3d11/nn-d3d11-id3d11texture2d) и смещение для каждого элемента в массиве текстуры.</span><span class="sxs-lookup"><span data-stu-id="4a751-205">Pass in the [**ID3D11Texture2D**](/windows/win32/api/d3d11/nn-d3d11-id3d11texture2d) pointer and the offset for each element in the texture array.</span></span> <span data-ttu-id="4a751-206">Функция возвращает указатель [**имфмедиабуффер**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) .</span><span class="sxs-lookup"><span data-stu-id="4a751-206">The function returns an [**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) pointer.</span></span>
    2.  <span data-ttu-id="4a751-207">Создайте пустой образец носителя, вызвав функцию [**мфкреатевидеосамплефромсурфаце**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) .</span><span class="sxs-lookup"><span data-stu-id="4a751-207">Create an empty media sample by calling the [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) function.</span></span> <span data-ttu-id="4a751-208">Установите параметр *пунксурфаце* равным **null**.</span><span class="sxs-lookup"><span data-stu-id="4a751-208">Set the *pUnkSurface* parameter equal to **NULL**.</span></span> <span data-ttu-id="4a751-209">Функция возвращает указатель [**имфсампле**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) .</span><span class="sxs-lookup"><span data-stu-id="4a751-209">The function returns an [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) pointer.</span></span>
    3.  <span data-ttu-id="4a751-210">Вызовите [**имфсампле:: аддбуффер**](/windows/desktop/api/mfobjects/nf-mfobjects-imfsample-addbuffer) , чтобы добавить буфер мультимедиа в образец.</span><span class="sxs-lookup"><span data-stu-id="4a751-210">Call [**IMFSample::AddBuffer**](/windows/desktop/api/mfobjects/nf-mfobjects-imfsample-addbuffer) to add the media buffer to the sample.</span></span>

<span data-ttu-id="4a751-211">Следует уничтожить все созданные текстуры одновременно, а не только некоторые и продолжить использовать напоминание.</span><span class="sxs-lookup"><span data-stu-id="4a751-211">You should destroy all the textures you create at the same time, rather then destroying only some and continuing to use the reminder.</span></span>

## <a name="decoding"></a><span data-ttu-id="4a751-212">Декодирование</span><span class="sxs-lookup"><span data-stu-id="4a751-212">Decoding</span></span>

<span data-ttu-id="4a751-213">Чтобы создать устройство декодера, вызовите метод [**ID3D11VideoDevice:: креатевидеодекодер**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="4a751-213">To create the decoder device, call [**ID3D11VideoDevice::CreateVideoDecoder**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createvideodecoder).</span></span> <span data-ttu-id="4a751-214">Метод возвращает указатель на интерфейс [**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder) .</span><span class="sxs-lookup"><span data-stu-id="4a751-214">The method returns a pointer to the [**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder) interface.</span></span> <span data-ttu-id="4a751-215">Декодирование должно происходить внутри метода [**имфтрансформ::P роцессаутпут**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) .</span><span class="sxs-lookup"><span data-stu-id="4a751-215">Decoding should occur inside the [**IMFTransform::ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) method.</span></span> <span data-ttu-id="4a751-216">В каждом кадре вызовите [**имфдксгидевицеманажер:: тестдевице**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-testdevice) , чтобы проверить доступность DXGI.</span><span class="sxs-lookup"><span data-stu-id="4a751-216">On each frame, call [**IMFDXGIDeviceManager::TestDevice**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-testdevice) to test the availability of the DXGI.</span></span> <span data-ttu-id="4a751-217">Если устройство изменилось, программный декодер должен повторно создать устройство декодера следующим образом:</span><span class="sxs-lookup"><span data-stu-id="4a751-217">If the device has changed, the software decoder must recreate the decoder device, as follows:</span></span>

1.  <span data-ttu-id="4a751-218">Закройте обработчик устройства, вызвав [**имфдксгидевицеманажер:: клоседевицехандле**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-closedevicehandle).</span><span class="sxs-lookup"><span data-stu-id="4a751-218">Close the device handle by calling [**IMFDXGIDeviceManager::CloseDeviceHandle**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-closedevicehandle).</span></span>
2.  <span data-ttu-id="4a751-219">Освободите все ресурсы, связанные с предыдущим устройством Direct3D 11, включая интерфейсы [**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder), [**ID3D11VideoContext**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videocontext), [**ID3D11Texture2D**](/windows/win32/api/d3d11/nn-d3d11-id3d11texture2d)и [**ID3D11VideoDecoderOutputView**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoderoutputview) .</span><span class="sxs-lookup"><span data-stu-id="4a751-219">Release all resources associated with the previous Direct3D 11 device, including the [**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder), [**ID3D11VideoContext**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videocontext), [**ID3D11Texture2D**](/windows/win32/api/d3d11/nn-d3d11-id3d11texture2d), and [**ID3D11VideoDecoderOutputView**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoderoutputview) interfaces.</span></span>
3.  <span data-ttu-id="4a751-220">Откройте новый маркер устройства.</span><span class="sxs-lookup"><span data-stu-id="4a751-220">Open a new device handle.</span></span>
4.  <span data-ttu-id="4a751-221">Согласование новой конфигурации декодера, как описано выше в разделе [Поиск конфигурации декодера](#find-a-decoder-configuration).</span><span class="sxs-lookup"><span data-stu-id="4a751-221">Negotiate a new decoder configuration, as described previously in [Find a Decoder Configuration](#find-a-decoder-configuration).</span></span> <span data-ttu-id="4a751-222">Этот шаг необходим, так как возможности устройства могли измениться.</span><span class="sxs-lookup"><span data-stu-id="4a751-222">This step is necessary because the device capabilities might have changed.</span></span>
5.  <span data-ttu-id="4a751-223">Создайте новое устройство декодера.</span><span class="sxs-lookup"><span data-stu-id="4a751-223">Create a new decoder device.</span></span>

<span data-ttu-id="4a751-224">Предполагая, что маркер устройства является допустимым, процесс декодирования работает следующим образом:</span><span class="sxs-lookup"><span data-stu-id="4a751-224">Assuming that the device handle is valid, the decoding process works as follows:</span></span>

1.  <span data-ttu-id="4a751-225">Получить доступную поверхность, которая сейчас не используется.</span><span class="sxs-lookup"><span data-stu-id="4a751-225">Get an available surface that is not currently in use.</span></span> <span data-ttu-id="4a751-226">Изначально доступны все поверхности.</span><span class="sxs-lookup"><span data-stu-id="4a751-226">Initially, all of the surfaces are available.</span></span>
2.  <span data-ttu-id="4a751-227">Запросите пример носителя для интерфейса [**имфтраккедсампле**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) .</span><span class="sxs-lookup"><span data-stu-id="4a751-227">Query the media sample for the [**IMFTrackedSample**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) interface.</span></span>
3.  <span data-ttu-id="4a751-228">Вызовите метод [**имфтраккедсампле:: сеталлокатор**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) и укажите указатель на интерфейс [**имфасинккаллбакк**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) .</span><span class="sxs-lookup"><span data-stu-id="4a751-228">Call [**IMFTrackedSample::SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) and provide a pointer to the [**IMFAsyncCallback**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) interface.</span></span> <span data-ttu-id="4a751-229">(Этот интерфейс должен быть реализован программным декодером.) Когда модуль подготовки видео освобождает пример, будет вызван обратный вызов.</span><span class="sxs-lookup"><span data-stu-id="4a751-229">(The software decoder must implement this interface.) When the video renderer releases the sample, the callback will be invoked.</span></span> <span data-ttu-id="4a751-230">Используйте этот обратный вызов, чтобы отследить, какие образцы доступны в настоящее время и какие из них используются.</span><span class="sxs-lookup"><span data-stu-id="4a751-230">Use this callback to keep track of which samples are currently available and which are in use.</span></span>
4.  <span data-ttu-id="4a751-231">Вызовите [**ID3D11VideoContext::D екодербегинфраме**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderbeginframe).</span><span class="sxs-lookup"><span data-stu-id="4a751-231">Call [**ID3D11VideoContext::DecoderBeginFrame**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderbeginframe).</span></span> <span data-ttu-id="4a751-232">Передайте указатели на интерфейс [**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder) для устройства декодера и интерфейс [**ID3D11VideoDecoderOutputView**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoderoutputview) для представления выходных данных.</span><span class="sxs-lookup"><span data-stu-id="4a751-232">Pass in the pointers to the [**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder) interface for the decoder device and the [**ID3D11VideoDecoderOutputView**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoderoutputview) interface for the output view.</span></span>
5.  <span data-ttu-id="4a751-233">Сделайте следующее или несколько раз:</span><span class="sxs-lookup"><span data-stu-id="4a751-233">Do the following one or more times:</span></span>
    1.  <span data-ttu-id="4a751-234">Вызовите метод [**ID3D11VideoContext:: жетдекодербуффер**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-getdecoderbuffer) , чтобы получить буфер.</span><span class="sxs-lookup"><span data-stu-id="4a751-234">Call [**ID3D11VideoContext::GetDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-getdecoderbuffer) to get a buffer.</span></span>
    2.  <span data-ttu-id="4a751-235">Заполните буфер.</span><span class="sxs-lookup"><span data-stu-id="4a751-235">Fill the buffer.</span></span>
    3.  <span data-ttu-id="4a751-236">Вызовите [**ID3D11VideoContext:: релеаседекодербуффер**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-releasedecoderbuffer).</span><span class="sxs-lookup"><span data-stu-id="4a751-236">Call [**ID3D11VideoContext::ReleaseDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-releasedecoderbuffer).</span></span>
    4.  <span data-ttu-id="4a751-237">Вызовите [**ID3D11VideoContext:: субмитдекодербуффер**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-submitdecoderbuffers).</span><span class="sxs-lookup"><span data-stu-id="4a751-237">Call [**ID3D11VideoContext::SubmitDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-submitdecoderbuffers).</span></span> <span data-ttu-id="4a751-238">Этот метод указывает устройству декодера выполнить операции декодирования в кадре.</span><span class="sxs-lookup"><span data-stu-id="4a751-238">This method instructs the decoder device to perform the decoding operations on the frame.</span></span>
6.  <span data-ttu-id="4a751-239">Вызовите [**ID3D11VideoContext::D екодерендфраме**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderendframe) , чтобы сообщить о завершении декодирования для текущего кадра.</span><span class="sxs-lookup"><span data-stu-id="4a751-239">Call [**ID3D11VideoContext::DecoderEndFrame**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderendframe) to signal the end of decoding for the current frame.</span></span>

<span data-ttu-id="4a751-240">Direct3D 11 использует те же структуры данных, что и ДКСВА 2,0 для операций декодирования.</span><span class="sxs-lookup"><span data-stu-id="4a751-240">Direct3D 11 uses the same data structures as DXVA 2.0 for decoding operations.</span></span> <span data-ttu-id="4a751-241">Для исходного набора профилей ДКСВА (для H. 261, H. 263 и MPEG-2) эти структуры данных описаны в [спецификации дксва 1,0](/windows-hardware/drivers/display/directx-video-acceleration).</span><span class="sxs-lookup"><span data-stu-id="4a751-241">For the original set of DXVA profiles (for H.261, H.263, and MPEG-2), these data structures are described in the [DXVA 1.0 specification](/windows-hardware/drivers/display/directx-video-acceleration).</span></span>

<span data-ttu-id="4a751-242">Внутри каждой пары вызовов [**декодербегинфраме**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderbeginframe) и [**субмитдекодербуффер**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-submitdecoderbuffers) вы можете вызывать [**жетдекодербуффер**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-getdecoderbuffer) несколько раз, но только один раз для каждого типа буфера.</span><span class="sxs-lookup"><span data-stu-id="4a751-242">Within each pair of [**DecoderBeginFrame**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-decoderbeginframe) and [**SubmitDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-submitdecoderbuffers) calls, you may call [**GetDecoderBuffer**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-getdecoderbuffer) multiple times, but only once for each type of buffer.</span></span> <span data-ttu-id="4a751-243">Если один и тот же тип буфера дважды используется без вызова **субмитдекодербуффер**, данные в буфере будут перезаписаны.</span><span class="sxs-lookup"><span data-stu-id="4a751-243">If you use the same buffer type twice without calling **SubmitDecoderBuffer**, you will overwrite the data in the buffer.</span></span>

## <a name="related-topics"></a><span data-ttu-id="4a751-244">См. также</span><span class="sxs-lookup"><span data-stu-id="4a751-244">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="4a751-245">API-интерфейсы видео Direct3D 11</span><span class="sxs-lookup"><span data-stu-id="4a751-245">Direct3D 11 Video APIs</span></span>](direct3d-11-video-apis.md)
</dt> <dt>

[<span data-ttu-id="4a751-246">Ускорение видео DirectX 2,0</span><span class="sxs-lookup"><span data-stu-id="4a751-246">DirectX Video Acceleration 2.0</span></span>](directx-video-acceleration-2-0.md)
</dt> </dl>

 

 
