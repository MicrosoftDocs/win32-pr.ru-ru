---
description: Использование оконных кодеков Windows в DirectShow
ms.assetid: 5b930447-6bf2-4bb3-8dfb-05f4c1e7cd64
title: Использование оконных кодеков Windows в DirectShow
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: cb521c0e3897dc2415fbd613f97b755a146657d3
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105683076"
---
# <a name="using-the-window-media-codecs-in-directshow"></a><span data-ttu-id="01c28-103">Использование оконных кодеков Windows в DirectShow</span><span class="sxs-lookup"><span data-stu-id="01c28-103">Using the Window Media Codecs in DirectShow</span></span>

<span data-ttu-id="01c28-104">Объекты кодировщика аудио и видео Windows Media и декодера изначально разрабатывались и оптимизированы для работы с форматом контейнера файлов ASF и пакетом SDK Windows Media Format.</span><span class="sxs-lookup"><span data-stu-id="01c28-104">The Windows Media Audio and Video encoder and decoder objects were originally designed and optimized to work with the ASF file container format and the Windows Media Format SDK.</span></span> <span data-ttu-id="01c28-105">Объекты кодека хорошо работают в DirectShow в определенных сценариях, а именно один проход CBR и качество потока видеопотоков с поддержкой VBR.</span><span class="sxs-lookup"><span data-stu-id="01c28-105">The codec objects work well in DirectShow for certain scenarios, namely one-pass CBR and quality based VBR encoding of video streams.</span></span> <span data-ttu-id="01c28-106">Но если вы планируете использовать объекты кодека непосредственно в DirectShow с помощью контейнеров файлов, отличных от ASF, существуют определенные поведения и проблемы, о которых следует помнить заранее.</span><span class="sxs-lookup"><span data-stu-id="01c28-106">But if you are considering using the codec objects directly in DirectShow using file containers other than ASF, there are certain behaviors and issues that you should be aware of in advance.</span></span>

> [!Note]  
> <span data-ttu-id="01c28-107">Если вы собираетесь использовать автономные кодеки с DirectShow, скорее всего, их потребуется использовать как дмос.</span><span class="sxs-lookup"><span data-stu-id="01c28-107">If you are going to use standalone codecs with DirectShow, you will probably want to use them as DMOs only.</span></span> <span data-ttu-id="01c28-108">Иными словами, вы будете использовать интерфейс [**имедиаобжект**](/previous-versions/windows/desktop/api/mediaobj/nn-mediaobj-imediaobject) вместо [**имфтрансформ**](/windows/desktop/api/mftransform/nn-mftransform-imftransform).</span><span class="sxs-lookup"><span data-stu-id="01c28-108">In other words, you will be using the [**IMediaObject**](/previous-versions/windows/desktop/api/mediaobj/nn-mediaobj-imediaobject) interface instead of [**IMFTransform**](/windows/desktop/api/mftransform/nn-mftransform-imftransform).</span></span>

 

## <a name="wm-audio-in-avi-files"></a><span data-ttu-id="01c28-109">Звуковые файлы WM в AVI</span><span class="sxs-lookup"><span data-stu-id="01c28-109">WM Audio in AVI Files</span></span>

<span data-ttu-id="01c28-110">DirectShow можно использовать для кодирования потоков WMA в любой формат контейнера файлов, для которого имеется фильтр мультиплексора.</span><span class="sxs-lookup"><span data-stu-id="01c28-110">You can use DirectShow to encode WMA streams into any file container format for which you have a multiplexer filter.</span></span> <span data-ttu-id="01c28-111">Однако интерфейсы аудиокодеков Windows Media Audio и Video не поддерживают WMA в AVI-файлах, так как их невозможно использовать по умолчанию фильтры воспроизведения AVI, чтобы поддерживать синхронизацию видео в файле AVI с потоком WMA.</span><span class="sxs-lookup"><span data-stu-id="01c28-111">However, the Windows Media Audio and Video codec interfaces do not support WMA in AVI files because it is impossible, using the default DirectShow AVI playback filters, to maintain audio-video sync in an AVI file with a WMA stream.</span></span> <span data-ttu-id="01c28-112">Дополнительные сведения см. [в разделе Хранение сжатых файлов мультимедиа в AVI](storingcompressedmediainavifiles.md).</span><span class="sxs-lookup"><span data-stu-id="01c28-112">For more information, see [Storing Compressed Media in AVI Files](storingcompressedmediainavifiles.md).</span></span>

<span data-ttu-id="01c28-113">В DMO для аудио кодировщика выводятся примеры различной длительности, даже если в режиме постоянной битовой скорости.</span><span class="sxs-lookup"><span data-stu-id="01c28-113">The audio encoder DMO outputs samples of varying duration, even when in "constant bit rate" mode.</span></span> <span data-ttu-id="01c28-114">Поэтому лучше работает с форматами контейнеров файлов, которые используют метки времени.</span><span class="sxs-lookup"><span data-stu-id="01c28-114">It therefore works best with file container formats that use time stamps.</span></span> <span data-ttu-id="01c28-115">AVI-файлы не предоставляют метку времени для каждого звукового примера или группы образцов.</span><span class="sxs-lookup"><span data-stu-id="01c28-115">AVI files do not provide a time stamp for each audio sample or group of samples.</span></span> <span data-ttu-id="01c28-116">В DirectShow фильтр разделителя AVI создает штампы времени для каждой группы выборок (каждый звуковой кадр) на основе значения **навгбитесперсек** в структуре [**вавеформатекс**](/previous-versions/dd757713(v=vs.85)) в заголовке AVI-потока.</span><span class="sxs-lookup"><span data-stu-id="01c28-116">In DirectShow, the AVI Splitter filter manufactures time stamps for each group of samples (each audio frame) based on the **nAvgBytesPerSec** value in the [**WAVEFORMATEX**](/previous-versions/dd757713(v=vs.85)) structure in the AVI stream header.</span></span>

<span data-ttu-id="01c28-117">Исходя из этого вычисления подразумевается, что все звуковые примеры в потоке имеют одинаковую длительность. Однако выходные данные образцов DMO имеют неравную длительность, поэтому метки времени, применяемые разделителем AVI, неточны.</span><span class="sxs-lookup"><span data-stu-id="01c28-117">The assumption underlying this calculation is that all audio samples in the stream are of equal duration; however, the samples output by the DMO are not of equal duration, and so the time stamps applied by the AVI Splitter are not accurate.</span></span> <span data-ttu-id="01c28-118">Таким образом, невозможно без изменения либо разделителя AVI, либо звукового декодера DMO, чтобы использовать приложение на основе DirectShow для воспроизведения AVI-файлов с синхронизацией аудио-и видеопотоков. В некоторых случаях голосовый кодек Windows Media Audio 9 будет работать, но даже в этом случае синхронизация будет потеряна после любой операции поиска, поэтому она не будет считаться приемлемым решением.</span><span class="sxs-lookup"><span data-stu-id="01c28-118">Therefore, it is not possible, without modifying either the AVI Splitter or the audio decoder DMO, to use any DirectShow-based application to play back AVI files with audio and video streams in sync. The Windows Media Audio 9 Voice codec will work in some cases, but even this will lose sync after any seek operation, so it really cannot be considered a viable solution.</span></span>

<span data-ttu-id="01c28-119">Если у вас есть кодировщик MP3, вы можете создавать AVI-файлы с помощью WMV и MP3 для звукового потока.</span><span class="sxs-lookup"><span data-stu-id="01c28-119">If you have an MP3 encoder, you can create AVI files with WMV and MP3 for the audio stream.</span></span> <span data-ttu-id="01c28-120">Такие файлы воспроизводятся и правильно ищутся в проигрывателе Windows Media и других приложениях на основе DirectShow, поскольку разделитель AVI содержит специальный код обработки для потоков MP3.</span><span class="sxs-lookup"><span data-stu-id="01c28-120">Such files will play back and seek correctly in Windows Media Player and other DirectShow-based applications, because the AVI Splitter contains special handling code for MP3 streams.</span></span> <span data-ttu-id="01c28-121">Другой вариант — использовать несжатый звук PCM, хотя, очевидно, размер файла будет значительно больше, чем в сжатом звуковом потоке.</span><span class="sxs-lookup"><span data-stu-id="01c28-121">Another option is to use uncompressed PCM audio, although obviously the resulting file size will be much larger than with a compressed audio stream.</span></span> <span data-ttu-id="01c28-122">Так как пример приложения DirectShow создает AVI-файлы, в нем не демонстрируется использование DMO для аудио-кодировщика.</span><span class="sxs-lookup"><span data-stu-id="01c28-122">Because the DirectShow sample application creates AVI files, it does not demonstrate how to use the audio encoder DMO.</span></span>

## <a name="one-pass-encoding"></a><span data-ttu-id="01c28-123">Однопроходная кодировка</span><span class="sxs-lookup"><span data-stu-id="01c28-123">One-pass Encoding</span></span>

<span data-ttu-id="01c28-124">Технология DMO для видеокодировщика легко работает в DirectShow для двух режимов кодирования: CBR и Quality.</span><span class="sxs-lookup"><span data-stu-id="01c28-124">The video encoder DMO works easily in DirectShow for two encoding modes: CBR and quality based VBR.</span></span> <span data-ttu-id="01c28-125">При условии соблюдения правильного порядка операций при построении графа фильтра, как показано в примере приложения, можно относительно просто поместить содержимое WMV в AVI-файл с помощью AVI-мультиплексора и средства записи файлов.</span><span class="sxs-lookup"><span data-stu-id="01c28-125">As long as you follow the correct order of operations when building the filter graph, as demonstrated in the sample application, it is relatively simple to place WMV content into an AVI file using the AVI Multiplexer and the File Writer.</span></span>

## <a name="two-pass-encoding"></a><span data-ttu-id="01c28-126">2-проходная кодировка</span><span class="sxs-lookup"><span data-stu-id="01c28-126">Two-pass Encoding</span></span>

<span data-ttu-id="01c28-127">Для режимов двусторонней кодировки требуется более сложный подход к построению и потоковой передаче на графе, чтобы предотвратить сброс содержимого с первого прохода DMO до начала второго прохода.</span><span class="sxs-lookup"><span data-stu-id="01c28-127">The two-pass encoding modes require a more complex approach to graph building and streaming in order to prevent the DMO from flushing its contents from the first pass before beginning the second pass.</span></span> <span data-ttu-id="01c28-128">В двухсторонней кодировке необходимо однократно запустить граф, чтобы DMO мог выполнить анализ предварительной обработки данных файла, а затем перемотать диаграмму и запустить ее снова, чтобы объекты DMO могли выполнять фактическую кодировку.</span><span class="sxs-lookup"><span data-stu-id="01c28-128">In two-pass encoding, it is necessary to run the graph once so the DMO can perform its preprocessing analysis of the file data, and then rewind the graph and run it again so that the DMO can do the actual encoding.</span></span>

<span data-ttu-id="01c28-129">Когда граф переходит в состояние выполнения второго прохода, оболочка DMO устанавливает флаг небесперебойности в первом примере, так как отметка времени не является последовательной с последней меткой времени первого прохода.</span><span class="sxs-lookup"><span data-stu-id="01c28-129">When the graph goes into a run state for the second pass, the DMO Wrapper sets the DISCONTINUITY flag on the first sample, because the time stamp is not sequential with the last time stamp on the first pass.</span></span> <span data-ttu-id="01c28-130">Если объекты DMO, которые не предназначены для работы в DirectShow таким образом, получают флаг отключения, он выполняет очистку и теряет данные, хранящиеся на первом проходе.</span><span class="sxs-lookup"><span data-stu-id="01c28-130">When the DMO, which was not designed to work in DirectShow in this way, receives the DISCONTINUITY flag, it performs a flush and loses the data stored from the first pass.</span></span> <span data-ttu-id="01c28-131">Чтобы обойти эту ошибку, лучшим решением, скорее всего, является написание настраиваемого фильтра оболочки DMO, который не устанавливает флаг ненепрерывности при поиске графа после первого прохода.</span><span class="sxs-lookup"><span data-stu-id="01c28-131">To work around this issue, the best solution is probably to write a custom DMO Wrapper filter that does not set the DISCONTINUITY flag when the graph is seeked after the first pass.</span></span> <span data-ttu-id="01c28-132">Образец видео для Windows (VfW) в этом пакете SDK демонстрирует, как выполнить двустороннюю кодировку.</span><span class="sxs-lookup"><span data-stu-id="01c28-132">The Video for Windows (VfW) sample in this SDK demonstrates how to perform two-pass encoding.</span></span>

## <a name="interlaced-content"></a><span data-ttu-id="01c28-133">Содержимое с чередованием</span><span class="sxs-lookup"><span data-stu-id="01c28-133">Interlaced Content</span></span>

<span data-ttu-id="01c28-134">Кодировщик WMV Encoder способен кодировать содержимое с чередованием, сохраняя чересстрочную развертку, что полезно для содержимого, записанного на ТЕЛЕВИЗОРе, а также может воспроизводиться на ТЕЛЕВИЗОРе.</span><span class="sxs-lookup"><span data-stu-id="01c28-134">The WMV encoder DMO is able to encode interlaced content while preserving the interlacing, which is useful for content that is captured from a TV and might also be played back on a TV.</span></span> <span data-ttu-id="01c28-135">Однако невозможно сохранить чересстрочную развертку с помощью оболочки DMO по умолчанию, так как этот фильтр не поддерживает [**инссбуффер**](/previous-versions/windows/desktop/api/wmsbuffer/nn-wmsbuffer-inssbuffer) на входных примерах.</span><span class="sxs-lookup"><span data-stu-id="01c28-135">However, it is not possible to preserve interlacing using the default DMO Wrapper, because that filter does not support [**INSSBuffer**](/previous-versions/windows/desktop/api/wmsbuffer/nn-wmsbuffer-inssbuffer) on its input samples.</span></span>

<span data-ttu-id="01c28-136">DMO использует этот интерфейс для получения параметров с чередованием для каждого получаемого примера.</span><span class="sxs-lookup"><span data-stu-id="01c28-136">The DMO uses that interface to obtain the interlaced settings for each sample that it receives.</span></span> <span data-ttu-id="01c28-137">Если интерфейс не найден, как в случае с оболочкой DMO, DMO просто рассматривает входные образцы как нечересстрочнуюиеся.</span><span class="sxs-lookup"><span data-stu-id="01c28-137">If the interface is not found, as is the case with the DMO Wrapper, the DMO simply treats the input samples as noninterlaced.</span></span> <span data-ttu-id="01c28-138">Для выполнения чередования кодирования в DirectShow существует несколько альтернативных вариантов.</span><span class="sxs-lookup"><span data-stu-id="01c28-138">To perform interlaced encoding in DirectShow, there are several alternatives.</span></span> <span data-ttu-id="01c28-139">Проще всего использовать пакет SDK для серии Windows Media Format 9 либо напрямую, либо используя фильтр DirectShow модуля записи WM ASF, чтобы создать чередующийся ASF-файл.</span><span class="sxs-lookup"><span data-stu-id="01c28-139">The easiest approach is probably to use the Windows Media Format 9 Series SDK either directly or using the WM ASF Writer DirectShow filter, to create an interlaced ASF file.</span></span> <span data-ttu-id="01c28-140">Затем можно перекодировать этот файл в другой формат.</span><span class="sxs-lookup"><span data-stu-id="01c28-140">You can then transcode that file into some other format.</span></span> <span data-ttu-id="01c28-141">При перекодировании в формате AVI будет создан файл с чередованием, но стандартные фильтры воспроизведения AVI в формате DirectShow не будут распознать его как таковые, так как они не поддерживают [**VIDEOINFOHEADER2**](/previous-versions/windows/desktop/api/dvdmedia/ns-dvdmedia-videoinfoheader2).</span><span class="sxs-lookup"><span data-stu-id="01c28-141">If you transcode into AVI, you will have an interlaced file, but the standard DirectShow AVI playback filters will not recognize it as such because they do not support [**VIDEOINFOHEADER2**](/previous-versions/windows/desktop/api/dvdmedia/ns-dvdmedia-videoinfoheader2).</span></span> <span data-ttu-id="01c28-142">Другой подход заключается в написании собственного фильтра оболочки DMO, поддерживающего интерфейс [**инссбуффер**](/previous-versions/windows/desktop/api/wmsbuffer/nn-wmsbuffer-inssbuffer) .</span><span class="sxs-lookup"><span data-stu-id="01c28-142">Another approach is to write your own DMO Wrapper filter that supports the [**INSSBuffer**](/previous-versions/windows/desktop/api/wmsbuffer/nn-wmsbuffer-inssbuffer) interface.</span></span>

## <a name="related-topics"></a><span data-ttu-id="01c28-143">См. также</span><span class="sxs-lookup"><span data-stu-id="01c28-143">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="01c28-144">Работа с кодеками дмос</span><span class="sxs-lookup"><span data-stu-id="01c28-144">Working with Codec DMOs</span></span>](workingwithcodecdmos.md)
</dt> </dl>

 

 
