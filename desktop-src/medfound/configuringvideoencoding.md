---
description: Настройка кодирования видео
ms.assetid: 917600f5-5580-4ca5-bce9-70eadec40df7
title: Настройка кодирования видео (Microsoft Media Foundation)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8bd82240ea9f540f283e0fb6340c06be00336226
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104143201"
---
# <a name="configuring-video-encoding-microsoft-media-foundation"></a><span data-ttu-id="c5f16-103">Настройка кодирования видео (Microsoft Media Foundation)</span><span class="sxs-lookup"><span data-stu-id="c5f16-103">Configuring Video Encoding (Microsoft Media Foundation)</span></span>

<span data-ttu-id="c5f16-104">Чтобы настроить кодировщик видео, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="c5f16-104">To configure the video encoder, perform the following steps:</span></span>

1.  <span data-ttu-id="c5f16-105">Задайте любые свойства в кодировщике DMO с помощью **ипропертибаг:: Write**.</span><span class="sxs-lookup"><span data-stu-id="c5f16-105">Set any properties on the encoder DMO by using **IPropertyBag::Write**.</span></span> <span data-ttu-id="c5f16-106">В следующем списке приводится список минимального набора свойств, необходимых для кодирования видеопотока CBR (все эти значения могут использоваться по умолчанию):</span><span class="sxs-lookup"><span data-stu-id="c5f16-106">The following list summarizes the minimum set of properties that are required to encode a CBR video stream (all of these values have defaults that can be used):</span></span>

    -   <span data-ttu-id="c5f16-107">Свойство[мфпкэй \_ видеовиндов](mfpkey-videowindowproperty.md) указывает окно буфера, используемое для потока.</span><span class="sxs-lookup"><span data-stu-id="c5f16-107">The[MFPKEY\_VIDEOWINDOW](mfpkey-videowindowproperty.md) property specifies the buffer window to use for the stream.</span></span> <span data-ttu-id="c5f16-108">Дополнительные сведения о параметре окна буфера и его влиянии на содержимое см. в разделе [методы кодирования](encodingmethods.md).</span><span class="sxs-lookup"><span data-stu-id="c5f16-108">For more information about the buffer windows setting and how it affects content, see [Encoding Methods](encodingmethods.md).</span></span> <span data-ttu-id="c5f16-109">Окно буфера по умолчанию — три секунды, что подходит для многих сценариев.</span><span class="sxs-lookup"><span data-stu-id="c5f16-109">The default buffer window is three seconds, which is appropriate for many scenarios.</span></span>
    -   <span data-ttu-id="c5f16-110">Сложность видео задается для определения компромисса между качеством закодированного содержимого и временем, необходимым для кодирования.</span><span class="sxs-lookup"><span data-stu-id="c5f16-110">Video complexity is set to determine the tradeoff between the quality of the encoded content and the time that is required to encode.</span></span> <span data-ttu-id="c5f16-111">Если значение не задано, используется значение по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="c5f16-111">If you do not set a value, the default value is used.</span></span> <span data-ttu-id="c5f16-112">Однако рекомендованные режимы для конкретного кодека можно найти, вызвав [ивмкодекпропс:: жеткодекпроп](/windows/desktop/api/wmcodecdsp/nf-wmcodecdsp-iwmcodecprops-getcodecprop) для получения g \_ всзвмвккомплекситексливе, g \_ всзвмвккомплекситексоффлине и g \_ всзвмвккомплекситексмакс.</span><span class="sxs-lookup"><span data-stu-id="c5f16-112">However, you can find the recommended modes for a specific codec by calling [IWMCodecProps::GetCodecProp](/windows/desktop/api/wmcodecdsp/nf-wmcodecdsp-iwmcodecprops-getcodecprop) to retrieve g\_wszWMVCComplexityExLive, g\_wszWMVCComplexityExOffline, and g\_wszWMVCComplexityExMax.</span></span> <span data-ttu-id="c5f16-113">Затем можно задать для параметра [мфпкэй \_ комплекситекс](mfpkey-complexityexproperty.md) значение от 0 до сообщаемой максимальной сложности.</span><span class="sxs-lookup"><span data-stu-id="c5f16-113">Then you can set [MFPKEY\_COMPLEXITYEX](mfpkey-complexityexproperty.md) to a value between 0 and the reported maximum complexity.</span></span>
    -   <span data-ttu-id="c5f16-114">[Мфпкэй \_ ЧЕТКОе](mfpkey-crispproperty.md) указывает относительную важность сглаживания видео и качество изображения закодированных кадров.</span><span class="sxs-lookup"><span data-stu-id="c5f16-114">[MFPKEY\_CRISP](mfpkey-crispproperty.md) specifies the relative importance of video smoothness and the image quality of encoded frames.</span></span> <span data-ttu-id="c5f16-115">В большинстве случаев значение по умолчанию работает нормально.</span><span class="sxs-lookup"><span data-stu-id="c5f16-115">In most cases, the default value works fine.</span></span>
    -   <span data-ttu-id="c5f16-116">Для содержимого видео, хранящегося в контейнере, отличном от ASF, свойство [мфпкэй \_ асфоверхеадперфраме](mfpkey-asfoverheadperframeproperty.md) должно иметь значение 0.</span><span class="sxs-lookup"><span data-stu-id="c5f16-116">For video content stored in a container other than ASF, the [MFPKEY\_ASFOVERHEADPERFRAME](mfpkey-asfoverheadperframeproperty.md) property must be set to 0.</span></span> <span data-ttu-id="c5f16-117">Это значение не является значением по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="c5f16-117">This is not the default value.</span></span>

    <span data-ttu-id="c5f16-118">Сведения о настройке потоков с VBR см. [в разделе Использование кодирования VBR](usingvbrencoding.md).</span><span class="sxs-lookup"><span data-stu-id="c5f16-118">For information about configuring VBR streams, see [Using VBR Encoding](usingvbrencoding.md).</span></span>

2.  <span data-ttu-id="c5f16-119">Настройте структуру [**\_ \_ типа мультимедиа DMO**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) для типа входных данных или, если вы используете Media Foundation SDK, используйте функцию [**мфинитмедиатипефромвидеоинфохеадер**](/windows/desktop/api/mfapi/nf-mfapi-mfinitmediatypefromvideoinfoheader) .</span><span class="sxs-lookup"><span data-stu-id="c5f16-119">Configure the [**DMO\_MEDIA\_TYPE**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) structure for the input type, or if you are using the Media Foundation SDK, use the [**MFInitMediaTypeFromVideoInfoHeader**](/windows/desktop/api/mfapi/nf-mfapi-mfinitmediatypefromvideoinfoheader) function.</span></span> <span data-ttu-id="c5f16-120">Используйте структуру [**видеоинфохеадер**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader) , описывающую несжатое входное содержимое.</span><span class="sxs-lookup"><span data-stu-id="c5f16-120">Use a [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader) structure describing the uncompressed input content.</span></span> <span data-ttu-id="c5f16-121">Кодек не изменяет размер видео или не преобразует цветовое пространство.</span><span class="sxs-lookup"><span data-stu-id="c5f16-121">The codec does not resize video or convert the color space.</span></span>
3.  <span data-ttu-id="c5f16-122">Задайте тип входных данных с помощью [**имедиаобжект:: сетинпуттипе**](/previous-versions/windows/desktop/api/mediaobj/nf-mediaobj-imediaobject-setinputtype) или [**Имфтрансформ:: сетинпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype).</span><span class="sxs-lookup"><span data-stu-id="c5f16-122">Set the input type using [**IMediaObject::SetInputType**](/previous-versions/windows/desktop/api/mediaobj/nf-mediaobj-imediaobject-setinputtype) or [**IMFTransform::SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype).</span></span>
4.  <span data-ttu-id="c5f16-123">Настройте тип выходных данных для кодировщика.</span><span class="sxs-lookup"><span data-stu-id="c5f16-123">Configure the output type for the encoder.</span></span> <span data-ttu-id="c5f16-124">После установки входного типа кодировщик перечисляет типы выходных данных, которые завершаются, за исключением элемента **двбитрате** структуры [**видеоинфохеадер**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader) или атрибута с [**\_ \_ средним \_ скоростью MF MT**](mf-mt-avg-bitrate-attribute.md) в интерфейсе [**имфмедиатипе**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediatype) .</span><span class="sxs-lookup"><span data-stu-id="c5f16-124">After the input type is set, the encoder enumerates output types that are complete except for the **dwBitrate** member of the [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader) structure, or the [**MF\_MT\_AVG\_BITRATE**](mf-mt-avg-bitrate-attribute.md) attribute of the [**IMFMediaType**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediatype) interface.</span></span> <span data-ttu-id="c5f16-125">Если перед настройкой входного типа получен тип вывода, то у доставленной структуры [**\_ \_ типа мультимедиа DMO**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) не будет связанного **видеоинфохеадер**.</span><span class="sxs-lookup"><span data-stu-id="c5f16-125">If you retrieve an output type before setting an input type, the delivered [**DMO\_MEDIA\_TYPE**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) structure will not have an associated **VIDEOINFOHEADER**.</span></span>
5.  <span data-ttu-id="c5f16-126">Извлеките частные данные кодека и добавьте их в структуру [**видеоинфохеадер**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader) , которая передается в структуру [**\_ \_ типа мультимедиа DMO**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) или в [**имфмедиатипе**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediatype).</span><span class="sxs-lookup"><span data-stu-id="c5f16-126">Retrieve the codec private data and append it to the [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader) structure that you pass to the [**DMO\_MEDIA\_TYPE**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) structure or to [**IMFMediaType**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediatype).</span></span> <span data-ttu-id="c5f16-127">Дополнительные сведения см. [в разделе Использование частных данных видеокодека](usingvideocodecprivatedata.md).</span><span class="sxs-lookup"><span data-stu-id="c5f16-127">For more information, see [Using Video Codec Private Data](usingvideocodecprivatedata.md).</span></span>
6.  <span data-ttu-id="c5f16-128">Задайте тип выходных данных, вызвав метод [**имедиаобжект:: сетаутпуттипе**](/previous-versions/windows/desktop/api/mediaobj/nf-mediaobj-imediaobject-setoutputtype) или [**Имфтрансформ:: сетаутпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) .</span><span class="sxs-lookup"><span data-stu-id="c5f16-128">Set the output type by calling the [**IMediaObject::SetOutputType**](/previous-versions/windows/desktop/api/mediaobj/nf-mediaobj-imediaobject-setoutputtype) or [**IMFTransform::SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) method.</span></span> <span data-ttu-id="c5f16-129">Либо передайте [**структуру \_ \_ типа мультимедиа DMO**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) с завершенной структурой [**видеоинфохеадер**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader) (включая добавленные закрытые данные), на которую ссылается член **пбформат** , либо создайте [**имфмедиатипе**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediatype) , вызвав [**мфинитмедиатипефромвидеоинфохеадер**](/windows/desktop/api/mfapi/nf-mfapi-mfinitmediatypefromvideoinfoheader).</span><span class="sxs-lookup"><span data-stu-id="c5f16-129">Either pass the [**DMO\_MEDIA\_TYPE**](/previous-versions/windows/desktop/api/mediaobj/ns-mediaobj-dmo_media_type) structure with the completed [**VIDEOINFOHEADER**](/previous-versions/windows/desktop/api/amvideo/ns-amvideo-videoinfoheader) structure (including appended private data) referenced in the **pbFormat** member, or construct an [**IMFMediaType**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediatype) by calling [**MFInitMediaTypeFromVideoInfoHeader**](/windows/desktop/api/mfapi/nf-mfapi-mfinitmediatypefromvideoinfoheader).</span></span>

> [!Note]  
> <span data-ttu-id="c5f16-130">Объект кодировщика видео поддерживает два выхода.</span><span class="sxs-lookup"><span data-stu-id="c5f16-130">The video encoder object supports two outputs.</span></span> <span data-ttu-id="c5f16-131">Второй выход предназначен для кодировщика "POST View".</span><span class="sxs-lookup"><span data-stu-id="c5f16-131">The second output is for encoder "post view".</span></span> <span data-ttu-id="c5f16-132">Он предоставляет несжатые образцы, так как они будут доставлены из декодера.</span><span class="sxs-lookup"><span data-stu-id="c5f16-132">It delivers the uncompressed samples as they will be delivered from the decoder.</span></span> <span data-ttu-id="c5f16-133">Это позволяет отслеживать качество кодирования, не дожидаясь обработки всего потока.</span><span class="sxs-lookup"><span data-stu-id="c5f16-133">This enables you to monitor the quality of the encoding without having to wait until the entire stream is processed.</span></span> <span data-ttu-id="c5f16-134">Эти выходные данные являются необязательными.</span><span class="sxs-lookup"><span data-stu-id="c5f16-134">This output is optional.</span></span> <span data-ttu-id="c5f16-135">Если вы хотите использовать его, настройте его тип, который следует за тем же процессом, который использовался для задания типа входных данных кодировщика.</span><span class="sxs-lookup"><span data-stu-id="c5f16-135">If you want to use it, configure its type following the same process used to set the encoder input type.</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="c5f16-136">См. также</span><span class="sxs-lookup"><span data-stu-id="c5f16-136">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="c5f16-137">Работа с видео</span><span class="sxs-lookup"><span data-stu-id="c5f16-137">Working with Video</span></span>](workingwithvideo.md)
</dt> </dl>

 

 
