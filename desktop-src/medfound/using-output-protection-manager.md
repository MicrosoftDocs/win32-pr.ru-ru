---
description: 'Дополнительные сведения о: использование диспетчера выходной защиты'
ms.assetid: 01edc17e-e71c-4772-a03c-09c9a2b8400f
title: Использование диспетчера выходной защиты
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 57bf4def3b0575dd706ae5f0c62924b6f1375a05
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105719462"
---
# <a name="using-output-protection-manager"></a><span data-ttu-id="31656-103">Использование диспетчера выходной защиты</span><span class="sxs-lookup"><span data-stu-id="31656-103">Using Output Protection Manager</span></span>

<span data-ttu-id="31656-104">В этом разделе описывается, как использовать диспетчер выходной защиты (ОПМ) для защиты видеосодержимого при перемещении по физическому соединителю на устройство отображения.</span><span class="sxs-lookup"><span data-stu-id="31656-104">This topic describes how to use Output Protection Manager (OPM) to protect video content as it travels over a physical connector to a display device.</span></span> <span data-ttu-id="31656-105">В этом разделе содержатся следующие подразделы.</span><span class="sxs-lookup"><span data-stu-id="31656-105">This topic contains the following sections:</span></span>

-   [<span data-ttu-id="31656-106">Выходные данные видео</span><span class="sxs-lookup"><span data-stu-id="31656-106">Video Outputs</span></span>](#video-outputs)
-   [<span data-ttu-id="31656-107">Инициализация сеанса ОПМ</span><span class="sxs-lookup"><span data-stu-id="31656-107">Initializing an OPM Session</span></span>](#initializing-an-opm-session)
-   [<span data-ttu-id="31656-108">Отправка запросов состояния ОПМ</span><span class="sxs-lookup"><span data-stu-id="31656-108">Sending OPM Status Requests</span></span>](#sending-opm-status-requests)
-   [<span data-ttu-id="31656-109">Отправка команд ОПМ</span><span class="sxs-lookup"><span data-stu-id="31656-109">Sending OPM Commands</span></span>](#sending-opm-commands)
-   [<span data-ttu-id="31656-110">Обработка отключенного вывода видео</span><span class="sxs-lookup"><span data-stu-id="31656-110">Handling a Disabled Video Output</span></span>](#sending-opm-commands)
-   [<span data-ttu-id="31656-111">Защита содержимого с помощью HDCP</span><span class="sxs-lookup"><span data-stu-id="31656-111">Using HDCP to Protect Content</span></span>](#using-hdcp-to-protect-content)

<span data-ttu-id="31656-112">Содержимое видео уровня "Премиум" обычно шифруется для защиты от несанкционированного дублирования.</span><span class="sxs-lookup"><span data-stu-id="31656-112">Premium video content is usually encrypted to protect it from unauthorized duplication.</span></span> <span data-ttu-id="31656-113">Конечно, перед отображением видео необходимо расшифровать.</span><span class="sxs-lookup"><span data-stu-id="31656-113">Of course, the video must be decrypted before it is displayed.</span></span> <span data-ttu-id="31656-114">Расшифрованные, несжатые кадры должны перемещаться по физическому соединителю на устройство дисплея.</span><span class="sxs-lookup"><span data-stu-id="31656-114">The decrypted, uncompressed frames must then travel across a physical connector to the display device.</span></span> <span data-ttu-id="31656-115">Поставщики содержимого могут потребовать, чтобы на этом этапе были защищены кадры видео, так как они перемещаются по физическому соединителю.</span><span class="sxs-lookup"><span data-stu-id="31656-115">Content providers may require the video frames to be protected at this point, as they travel across the physical connector.</span></span>

<span data-ttu-id="31656-116">Для этой цели существуют различные механизмы защиты, включая High-Bandwidth цифровые Защита содержимого (HDCP) и Дисплайпорт Защита содержимого (ДПКП) для цифровых выходов. и система управления созданием копии — аналоговый (CGMS-A) для аналоговых выходов.</span><span class="sxs-lookup"><span data-stu-id="31656-116">Various protection mechanisms exist for this purpose, including High-Bandwidth Digital Content Protection (HDCP) and DisplayPort Content Protection (DPCP) for digital outputs; and Copy Generation Management System - Analog (CGMS-A) for analog outputs.</span></span> <span data-ttu-id="31656-117">Как правило, эти механизмы используют шифрование или кодирование сигнала перед переходом на дисплей.</span><span class="sxs-lookup"><span data-stu-id="31656-117">Generally, these mechanisms involve encrypting or scrambling the signal befores it goes to the display.</span></span>

<span data-ttu-id="31656-118">ОПМ позволяет приложению применять механизмы защиты содержимого к выходным данным видео.</span><span class="sxs-lookup"><span data-stu-id="31656-118">OPM enables an application to enforce content protection mechanisms on the video output.</span></span> <span data-ttu-id="31656-119">С помощью ОПМ приложение отправляет команды и запросы состояния в графический драйвер через надежный защищенный канал.</span><span class="sxs-lookup"><span data-stu-id="31656-119">Using OPM, the application sends commands and status requests to the graphics driver through a trusted, secure channel.</span></span> <span data-ttu-id="31656-120">ОПМ позволяет приложению:</span><span class="sxs-lookup"><span data-stu-id="31656-120">OPM enables an application to:</span></span>

-   <span data-ttu-id="31656-121">Убедитесь, что графический драйвер подписан корпорацией Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="31656-121">Verify that a graphics driver has been signed by Microsoft.</span></span>
-   <span data-ttu-id="31656-122">Настройте доверенный канал связи с драйвером.</span><span class="sxs-lookup"><span data-stu-id="31656-122">Set up a trusted communication channel with the driver.</span></span>
-   <span data-ttu-id="31656-123">Примените механизмы защиты содержимого к физическому выходу.</span><span class="sxs-lookup"><span data-stu-id="31656-123">Enforce content protection mechanisms on the physical output.</span></span>

<span data-ttu-id="31656-124">ОПМ заменяет сертифицированную защиту выхода протокол BGP (Копп) и использует аналогичный API.</span><span class="sxs-lookup"><span data-stu-id="31656-124">OPM replaces Certified Output Protection Protcol (COPP) and uses a similar API.</span></span> <span data-ttu-id="31656-125">Для обеспечения обратной совместимости интерфейс ОПМ может эмулировать интерфейс Копп.</span><span class="sxs-lookup"><span data-stu-id="31656-125">For backward compatibility, the OPM interface can emulate the COPP interface.</span></span> <span data-ttu-id="31656-126">Различия между ОПМ и Копп включают следующее:</span><span class="sxs-lookup"><span data-stu-id="31656-126">Differences between OPM and COPP include the following:</span></span>

-   <span data-ttu-id="31656-127">ОПМ использует сертификаты X. 509, а Копп использует собственный формат сертификата.</span><span class="sxs-lookup"><span data-stu-id="31656-127">OPM uses X.509 certificates, while COPP uses a proprietary certificate format.</span></span>
-   <span data-ttu-id="31656-128">ОПМ поддерживает повторители HDCP.</span><span class="sxs-lookup"><span data-stu-id="31656-128">OPM supports HDCP repeaters.</span></span>
-   <span data-ttu-id="31656-129">Приложения, использующие ОПМ, не должны анализировать сообщения о возобновлении системы HDCP (Срмс).</span><span class="sxs-lookup"><span data-stu-id="31656-129">Applications that use OPM do not have to parse HDCP system renewability messages (SRMs).</span></span>
-   <span data-ttu-id="31656-130">ОПМ можно использовать, если отображение графики использует режим клонирования.</span><span class="sxs-lookup"><span data-stu-id="31656-130">OPM can be used when the graphics display is using clone mode.</span></span> <span data-ttu-id="31656-131">Копп не поддерживает режим клонирования.</span><span class="sxs-lookup"><span data-stu-id="31656-131">COPP does not support clone mode.</span></span>

<span data-ttu-id="31656-132">Если приложение использует путь к защищенному носителю (PMP) для воспроизведения видеосодержимого, вам не нужно использовать API ОПМ, так как PMP делает все необходимые вызовы ОПМ.</span><span class="sxs-lookup"><span data-stu-id="31656-132">If your application uses the protected media path (PMP) to play video content, you do not have to use the OPM API, because the PMP makes all of the required OPM calls.</span></span> <span data-ttu-id="31656-133">API ОПМ доступен для приложений, которые не используют PMP.</span><span class="sxs-lookup"><span data-stu-id="31656-133">The OPM API is available for applications that do not use the PMP.</span></span>

<span data-ttu-id="31656-134">ОПМ доступен в Windows Vista и более поздних версиях, но API не стал общедоступным до Windows 7.</span><span class="sxs-lookup"><span data-stu-id="31656-134">OPM is available in Windows Vista and later, but the API was not made public until Windows 7.</span></span> <span data-ttu-id="31656-135">Чтобы использовать ОПМ в приложении, необходимо иметь заголовки и файлы библиотек из пакета SDK для Windows 7.</span><span class="sxs-lookup"><span data-stu-id="31656-135">To use OPM in an application, you must have the headers and library files from the Windows 7 SDK.</span></span> <span data-ttu-id="31656-136">Не требуется распространять библиотеки DLL для использования ОПМ в Windows Vista или Windows Server 2008.</span><span class="sxs-lookup"><span data-stu-id="31656-136">You do not have to redistribute any DLLs to use OPM in Windows Vista or Windows Server 2008.</span></span>

## <a name="video-outputs"></a><span data-ttu-id="31656-137">Выходные данные видео</span><span class="sxs-lookup"><span data-stu-id="31656-137">Video Outputs</span></span>

<span data-ttu-id="31656-138">Графический адаптер может иметь несколько физических выходных данных, каждый из которых имеет свои собственные возможности.</span><span class="sxs-lookup"><span data-stu-id="31656-138">A graphics adapter can have more than one physical output, each with its own capabilities.</span></span> <span data-ttu-id="31656-139">Прежде чем приложение начнет воспроизводить защищенное содержимое, оно должно установить соответствующие механизмы защиты для каждого видеопотока, связанного с графической картой, которая будет отображать видео.</span><span class="sxs-lookup"><span data-stu-id="31656-139">Before an application plays protected content, it must set the appropriate protection mechanisms on every video output associated with the graphics card that will display the video.</span></span> <span data-ttu-id="31656-140">Применяемые механизмы защиты будут зависеть от правил использования содержимого.</span><span class="sxs-lookup"><span data-stu-id="31656-140">Which protection mechanisms to apply will depend on the usage rules for the content.</span></span>

<span data-ttu-id="31656-141">Каждый выход видео представлен экземпляром интерфейса [**иопмвидеуутпут**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) .</span><span class="sxs-lookup"><span data-stu-id="31656-141">Each video output is represented by an instance of the [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) interface.</span></span> <span data-ttu-id="31656-142">Для получения выходных данных видео можно использовать обработчики устройств или мониторов Direct3D.</span><span class="sxs-lookup"><span data-stu-id="31656-142">You can use a Direct3D device or monitor handles to get the video outputs.</span></span>

<span data-ttu-id="31656-143">Использование устройства Direct3D:</span><span class="sxs-lookup"><span data-stu-id="31656-143">Using a Direct3D device:</span></span>

1.  <span data-ttu-id="31656-144">Получите указатель **IDirect3DDevice9** для устройства Direct3D, которое будет использоваться приложением для создания поверхностей для хранения кадров видео.</span><span class="sxs-lookup"><span data-stu-id="31656-144">Get the **IDirect3DDevice9** pointer for the Direct3D device that your application will use to create surfaces to hold the video frames.</span></span>
2.  <span data-ttu-id="31656-145">Вызовите функцию [**OPMGetVideoOutputsFromIDirect3DDevice9Object**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromidirect3ddevice9object) .</span><span class="sxs-lookup"><span data-stu-id="31656-145">Call the [**OPMGetVideoOutputsFromIDirect3DDevice9Object**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromidirect3ddevice9object) function.</span></span> <span data-ttu-id="31656-146">Эта функция выделяет массив указателей [**иопмвидеуутпут**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) , по одному для каждого выхода.</span><span class="sxs-lookup"><span data-stu-id="31656-146">This function allocates an array of [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) pointers, one for each output.</span></span>

<span data-ttu-id="31656-147">Использование дескрипторов монитора:</span><span class="sxs-lookup"><span data-stu-id="31656-147">Using monitor handles:</span></span>

1.  <span data-ttu-id="31656-148">Вызовите **енумдисплаймониторс** , чтобы получить дескрипторы **хмонитор** , которые соответствуют окну видео.</span><span class="sxs-lookup"><span data-stu-id="31656-148">Call **EnumDisplayMonitors** to get the **HMONITOR** handles that correspond to the video window.</span></span> <span data-ttu-id="31656-149">С одним и тем же окном можно связать несколько мониторов, поэтому вы можете получить несколько дескрипторов **хмонитор** .</span><span class="sxs-lookup"><span data-stu-id="31656-149">Several monitors can be associated with the same window, so you might get several **HMONITOR** handles.</span></span>
2.  <span data-ttu-id="31656-150">Для каждого обработчика монитора вызовите [**опмжетвидеуутпутсфромхмонитор**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromhmonitor).</span><span class="sxs-lookup"><span data-stu-id="31656-150">For each monitor handle, call [**OPMGetVideoOutputsFromHMONITOR**](/windows/desktop/api/opmapi/nf-opmapi-opmgetvideooutputsfromhmonitor).</span></span> <span data-ttu-id="31656-151">Эта функция выделяет массив указателей [**иопмвидеуутпут**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) , по одному для каждого выхода.</span><span class="sxs-lookup"><span data-stu-id="31656-151">This function allocates an array of [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) pointers, one for each output.</span></span>

## <a name="initializing-an-opm-session"></a><span data-ttu-id="31656-152">Инициализация сеанса ОПМ</span><span class="sxs-lookup"><span data-stu-id="31656-152">Initializing an OPM Session</span></span>

<span data-ttu-id="31656-153">Прежде чем приложение отправит команды ОПМ или запросы состояния, оно должно проверить, является ли выходное видео доверенным, и установить сеансовый ключ.</span><span class="sxs-lookup"><span data-stu-id="31656-153">Before the application sends OPM commands or status requests, it must verify that the video output is trusted and establish a session key.</span></span> <span data-ttu-id="31656-154">Ключ сеанса используется для подписывания данных, которыми обмениваются приложение и графический драйвер.</span><span class="sxs-lookup"><span data-stu-id="31656-154">The session key is used to sign the data that is exchanged between the application and the graphics driver.</span></span>

<span data-ttu-id="31656-155">API ОПМ определяет подтверждение, устанавливающее доверие и устанавливающее ключ сеанса.</span><span class="sxs-lookup"><span data-stu-id="31656-155">The OPM API defines a handshake that establishes trust and sets the session key.</span></span> <span data-ttu-id="31656-156">Это подтверждение необходимо выполнить для каждого экземпляра интерфейса [**иопмвидеуутпут**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) следующим образом:</span><span class="sxs-lookup"><span data-stu-id="31656-156">You must perform this handshake for each instance of the [**IOPMVideoOutput**](/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput) interface, as follows:</span></span>

1.  <span data-ttu-id="31656-157">Вызовите [**иопмвидеуутпут:: стартинитиализатион**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-startinitialization).</span><span class="sxs-lookup"><span data-stu-id="31656-157">Call [**IOPMVideoOutput::StartInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-startinitialization).</span></span> <span data-ttu-id="31656-158">Этот метод получает два фрагмента данных:</span><span class="sxs-lookup"><span data-stu-id="31656-158">This method retrieves two pieces of data:</span></span>
    -   <span data-ttu-id="31656-159">Случайное число, созданное драйвером.</span><span class="sxs-lookup"><span data-stu-id="31656-159">A random number, generated by the driver.</span></span> <span data-ttu-id="31656-160">Это число будет использоваться для завершения подтверждения.</span><span class="sxs-lookup"><span data-stu-id="31656-160">You will use this number to complete the handshake.</span></span>
    -   <span data-ttu-id="31656-161">Цепочка сертификатов X. 509 драйвера.</span><span class="sxs-lookup"><span data-stu-id="31656-161">The driver's X.509 certificate chain.</span></span>
2.  <span data-ttu-id="31656-162">Убедитесь, что цепочка сертификатов подписана корпорацией Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="31656-162">Verify that the certificate chain has been signed by Microsoft.</span></span>
    > [!Note]  
    > <span data-ttu-id="31656-163">Отзыв сертификата находится за пределами области действия ОПМ.</span><span class="sxs-lookup"><span data-stu-id="31656-163">Certificate revocation is outside the scope of OPM.</span></span>

     

3.  <span data-ttu-id="31656-164">Получите открытый ключ драйвера из цепочки сертификатов.</span><span class="sxs-lookup"><span data-stu-id="31656-164">Get the driver's public key from the certificate chain.</span></span>
4.  <span data-ttu-id="31656-165">Создайте 128-разрядный ключ сеанса AES.</span><span class="sxs-lookup"><span data-stu-id="31656-165">Generate a 128-bit AES session key.</span></span>
5.  <span data-ttu-id="31656-166">Создание двух случайных 32-разрядных чисел:</span><span class="sxs-lookup"><span data-stu-id="31656-166">Generate two random 32-bit numbers:</span></span>

    -   <span data-ttu-id="31656-167">Начальный порядковый номер для запросов состояния ОПМ.</span><span class="sxs-lookup"><span data-stu-id="31656-167">The starting sequence number for OPM status requests.</span></span>
    -   <span data-ttu-id="31656-168">Начальный порядковый номер для команд ОПМ.</span><span class="sxs-lookup"><span data-stu-id="31656-168">The starting sequence number for OPM commands.</span></span>

    <span data-ttu-id="31656-169">Эти номера должны создаваться с помощью криптографического безопасного генератора случайных чисел, например **CryptGenRandom**.</span><span class="sxs-lookup"><span data-stu-id="31656-169">These numbers must be generated using a cryptographically secure pseudo-random number generator, such as **CryptGenRandom**.</span></span>

6.  <span data-ttu-id="31656-170">Скопируйте случайное число драйвера (полученное на шаге 1), ключ сеанса и два порядковых номера в структуру [**\_ \_ \_ параметров зашифрованной инициализации ОПМ**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) , как описано в [**иопмвидеуутпут:: финишинитиализатион**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span><span class="sxs-lookup"><span data-stu-id="31656-170">Copy the driver's random number (obtained in step 1), the session key, and the two sequence numbers into an [**OPM\_ENCRYPTED\_INITIALIZATION\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) structure, as described in [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span></span>
7.  <span data-ttu-id="31656-171">Зашифруйте структуру [**\_ \_ \_ параметров зашифрованной инициализации ОПМ**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) с помощью рсаес-OAEP, используя открытый ключ драйвера, который находится в сертификате драйвера.</span><span class="sxs-lookup"><span data-stu-id="31656-171">Encrypt the [**OPM\_ENCRYPTED\_INITIALIZATION\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_encrypted_initialization_parameters) structure with RSAES-OAEP, using the driver's public key, which is found in the driver's certificate.</span></span>
8.  <span data-ttu-id="31656-172">Вызовите [**иопмвидеуутпут:: финишинитиализатион**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span><span class="sxs-lookup"><span data-stu-id="31656-172">Call [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization).</span></span>

## <a name="sending-opm-status-requests"></a><span data-ttu-id="31656-173">Отправка запросов состояния ОПМ</span><span class="sxs-lookup"><span data-stu-id="31656-173">Sending OPM Status Requests</span></span>

<span data-ttu-id="31656-174">Запросы состояния ОПМ возвращают сведения о выходных данных видео, например тип физического соединителя и текущий уровень защиты.</span><span class="sxs-lookup"><span data-stu-id="31656-174">OPM status requests return information about the video output, such as the type of physical connector and the current protection level.</span></span> <span data-ttu-id="31656-175">Список типов запросов см. в разделе [ОПМ Status](opm-status-requests.md)requests.</span><span class="sxs-lookup"><span data-stu-id="31656-175">For a list of request types, see [OPM Status Requests](opm-status-requests.md).</span></span>

<span data-ttu-id="31656-176">Чтобы отправить запрос состояния, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="31656-176">To send a status request, perform the following steps.</span></span>

1.  <span data-ttu-id="31656-177">Инициализируйте [**структуру \_ \_ \_ параметров получения сведений ОПМ**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) , как показано в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="31656-177">Initialize an [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure as shown in the following table.</span></span>

    | <span data-ttu-id="31656-178">Член</span><span class="sxs-lookup"><span data-stu-id="31656-178">Member</span></span>               | <span data-ttu-id="31656-179">Описание</span><span class="sxs-lookup"><span data-stu-id="31656-179">Description</span></span>                                                                                                                                                                                                                                                                                                                                                                 |
    |----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | <span data-ttu-id="31656-180">**омак**</span><span class="sxs-lookup"><span data-stu-id="31656-180">**omac**</span></span>             | <span data-ttu-id="31656-181">Пока не пропустите это поле.</span><span class="sxs-lookup"><span data-stu-id="31656-181">Skip this field for now.</span></span>                                                                                                                                                                                                                                                                                                                                                    |
    | <span data-ttu-id="31656-182">**рнрандомнумбер**</span><span class="sxs-lookup"><span data-stu-id="31656-182">**rnRandomNumber**</span></span>   | <span data-ttu-id="31656-183">Криптографически защищенное 128-разрядное случайное число.</span><span class="sxs-lookup"><span data-stu-id="31656-183">A cryptographically secure 128-bit random number.</span></span> <span data-ttu-id="31656-184">Всякий раз при выполнении запроса состояния всегда создавайте новое случайное число, даже если вы создаете тот же запрос.</span><span class="sxs-lookup"><span data-stu-id="31656-184">Whenever you make a status request, always generate a new random number, even if you are making the same request.</span></span> <span data-ttu-id="31656-185">Сохраните номер в переменной, так как вам потребуется позднее обратиться к ней.</span><span class="sxs-lookup"><span data-stu-id="31656-185">Store the number in a variable, because you will need to refer to it later.</span></span>                                                                                                                             |
    | <span data-ttu-id="31656-186">**гуидинформатион**</span><span class="sxs-lookup"><span data-stu-id="31656-186">**guidInformation**</span></span>  | <span data-ttu-id="31656-187">Идентификатор GUID, определяющий запрос состояния.</span><span class="sxs-lookup"><span data-stu-id="31656-187">A GUID that identifies the status request.</span></span> <span data-ttu-id="31656-188">Список запросов состояния см. в разделе [ОПМ Status Requests](opm-status-requests.md).</span><span class="sxs-lookup"><span data-stu-id="31656-188">For a list of status requests, see [OPM Status Requests](opm-status-requests.md).</span></span>                                                                                                                                                                                                                                               |
    | <span data-ttu-id="31656-189">**улсекуенценумбер**</span><span class="sxs-lookup"><span data-stu-id="31656-189">**ulSequenceNumber**</span></span> | <span data-ttu-id="31656-190">Порядковый номер.</span><span class="sxs-lookup"><span data-stu-id="31656-190">The sequence number.</span></span> <span data-ttu-id="31656-191">Для первого запроса состояния используйте начальный порядковый номер, указанный в методе [**иопмвидеуутпут:: финишинитиализатион**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) (шаг 5 [инициализации сеанса ОПМ](#initializing-an-opm-session)). Каждый раз, когда вы вносите еще один запрос о состоянии, увеличивайте это число на 1.</span><span class="sxs-lookup"><span data-stu-id="31656-191">For the first status request, use the starting sequence number that you specified in the [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) method (step 5 of [Initializing an OPM Session](#initializing-an-opm-session).) Each time you make another status request, increment this number by 1.</span></span> |
    | <span data-ttu-id="31656-192">**абпараметерс**</span><span class="sxs-lookup"><span data-stu-id="31656-192">**abParameters**</span></span>     | <span data-ttu-id="31656-193">Массив байтов, который содержит дополнительные входные данные для запроса.</span><span class="sxs-lookup"><span data-stu-id="31656-193">A byte array that contains additional input data for the request.</span></span> <span data-ttu-id="31656-194">Формат входных данных указан в разделе справки по каждому запросу состояния.</span><span class="sxs-lookup"><span data-stu-id="31656-194">The format of the input data is listed in the reference topic for each status request.</span></span>                                                                                                                                                                                                                    |
    | <span data-ttu-id="31656-195">**кбпараметерссизе**</span><span class="sxs-lookup"><span data-stu-id="31656-195">**cbParametersSize**</span></span> | <span data-ttu-id="31656-196">Размер допустимых данных в массиве **абпараметерс** .</span><span class="sxs-lookup"><span data-stu-id="31656-196">The size of the valid data in the **abParameters** array.</span></span> <span data-ttu-id="31656-197">Содержимое остальной части массива не определено.</span><span class="sxs-lookup"><span data-stu-id="31656-197">The contents of the rest of the array are undefined.</span></span>                                                                                                                                                                                                                                                              |

    

     

2.  <span data-ttu-id="31656-198">Вычислите однозначный MAC-адрес CBC (ОМАК-1), чтобы вычислить хэш для блока данных, отображаемого после элемента **ОМАК** , а затем присвоить элементу **ОМАК** это значение.</span><span class="sxs-lookup"><span data-stu-id="31656-198">Calculate the one-key CBC MAC (OMAC-1) to calculate a hash for the block of data that appears after the **omac** member, and then set the **omac** member to this value.</span></span> <span data-ttu-id="31656-199">См. [пример кода ОПМ](opm-example-code.md).</span><span class="sxs-lookup"><span data-stu-id="31656-199">See [OPM Example Code](opm-example-code.md).</span></span>
3.  <span data-ttu-id="31656-200">Вызовите метод [**иопмвидеуутпут::.**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation)</span><span class="sxs-lookup"><span data-stu-id="31656-200">Call the [**IOPMVideoOutput::GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) method.</span></span> <span data-ttu-id="31656-201">Передайте указатель на структуру [**\_ \_ \_ параметров получения сведений ОПМ**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) и указатель на структуру [**\_ запрашиваемой \_ информации ОПМ**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) .</span><span class="sxs-lookup"><span data-stu-id="31656-201">Pass in a pointer to the [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure and a pointer to an [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure.</span></span> <span data-ttu-id="31656-202">Ответ драйвера записывается в структуру **\_ запрошенной \_ информации ОПМ** .</span><span class="sxs-lookup"><span data-stu-id="31656-202">The driver's response is written to the **OPM\_REQUESTED\_INFORMATION** structure.</span></span>
    -   <span data-ttu-id="31656-203">Элемент **ОМАК** этой структуры содержит ОМАК, вычисленный для данных, следующих за этим элементом.</span><span class="sxs-lookup"><span data-stu-id="31656-203">The **omac** member of this structure contains an OMAC computed for the data that follows this member.</span></span>
    -   <span data-ttu-id="31656-204">Элемент **абрекуестединформатион** представляет собой массив байтов, содержащий выходные данные для ответа.</span><span class="sxs-lookup"><span data-stu-id="31656-204">The **abRequestedInformation** member is a byte array that contains output data for the response.</span></span> <span data-ttu-id="31656-205">Формат выходных данных указан в разделе справки по каждому запросу состояния.</span><span class="sxs-lookup"><span data-stu-id="31656-205">The format of the output data is listed in the reference topic for each status request.</span></span>
4.  <span data-ttu-id="31656-206">Вычислите ОМАК для [**структуры \_ запрашиваемой \_ информации ОПМ**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) , не включая элемент **ОМАК** .</span><span class="sxs-lookup"><span data-stu-id="31656-206">Calculate an OMAC for the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure, not including the **omac** member.</span></span> <span data-ttu-id="31656-207">Убедитесь, что ОМАК соответствует значению в члене **ОМАК** .</span><span class="sxs-lookup"><span data-stu-id="31656-207">Verify that the OMAC matches the value in the **omac** member.</span></span>
5.  <span data-ttu-id="31656-208">Убедитесь, что член **кбрекуестединформатионсизе** структуры [**\_ запрашиваемой \_ информации ОПМ**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) предоставляет правильный размер выходных данных.</span><span class="sxs-lookup"><span data-stu-id="31656-208">Make sure the **cbRequestedInformationSize** member of the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure gives the correct size for the output data.</span></span> <span data-ttu-id="31656-209">Например, выходные данные для запроса [**\_ \_ \_ типа соединителя ОПМ Get**](opm-get-connector-type.md) — это [**ОПМ \_ Стандартная \_ информационная**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) структура, поэтому значение **кбрекуестединформатионсизе** должно быть `sizeof(OPM_STANDARD_INFORMATION)` .</span><span class="sxs-lookup"><span data-stu-id="31656-209">For example, the output data for the [**OPM\_GET\_CONNECTOR\_TYPE**](opm-get-connector-type.md) query is an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure, so the value of **cbRequestedInformationSize** should be `sizeof(OPM_STANDARD_INFORMATION)`.</span></span>
6.  <span data-ttu-id="31656-210">Приведите элемент **абрекуестединформатион** структуры [**\_ запрашиваемой \_ информации ОПМ**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) к правильной структуре выходных данных.</span><span class="sxs-lookup"><span data-stu-id="31656-210">Cast the **abRequestedInformation** member of the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure to the correct output data structure.</span></span> <span data-ttu-id="31656-211">Например, если запросом состояния является [**ОПМ \_ Получение \_ \_ типа соединителя**](opm-get-connector-type.md), приведите **абрекуестединформатион** к [**\_ стандартной \_ информационной структуре ОПМ**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="31656-211">For example, if the status request is [**OPM\_GET\_CONNECTOR\_TYPE**](opm-get-connector-type.md), cast **abRequestedInformation** to an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span>
7.  <span data-ttu-id="31656-212">Убедитесь, что элемент **рнрандомнумбер** структуры выходных данных соответствует значению **рнрандомнумбер** из шага 1.</span><span class="sxs-lookup"><span data-stu-id="31656-212">Make sure the **rnRandomNumber** member of the output data structure matches the value of **rnRandomNumber** from step 1.</span></span>
8.  <span data-ttu-id="31656-213">Проверьте элемент **улстатусфлагс** в структуре выходных данных, как описано в разделе [Обработка отключенного](#handling-a-disabled-video-output)видеопотока.</span><span class="sxs-lookup"><span data-stu-id="31656-213">Check the **ulStatusFlags** member of the output data structure, as described in [Handling a Disabled Video Output](#handling-a-disabled-video-output).</span></span>

<span data-ttu-id="31656-214">Если какая-либо из проверок в шагах 5 – 8 завершается сбоем, приложение должно переключиться на отображение защищенного содержимого.</span><span class="sxs-lookup"><span data-stu-id="31656-214">If any of the checks in steps 5–8 fails, the application must stop showing protected content.</span></span>

## <a name="sending-opm-commands"></a><span data-ttu-id="31656-215">Отправка команд ОПМ</span><span class="sxs-lookup"><span data-stu-id="31656-215">Sending OPM Commands</span></span>

<span data-ttu-id="31656-216">Команды ОПМ используются для установки уровня защиты и других параметров в выходных данных видео.</span><span class="sxs-lookup"><span data-stu-id="31656-216">OPM commands are used to set the protection level and other settings on the video output.</span></span> <span data-ttu-id="31656-217">Отправка команды ОПМ аналогична отправке запроса состояния, за исключением отсутствия данных ответа от драйвера.</span><span class="sxs-lookup"><span data-stu-id="31656-217">Sending an OPM command is similar to sending a status request, except there is no response data from the driver.</span></span> <span data-ttu-id="31656-218">Список команд см. в разделе [команды ОПМ](opm-commands.md).</span><span class="sxs-lookup"><span data-stu-id="31656-218">For a list of commands, see [OPM Commands](opm-commands.md).</span></span>

<span data-ttu-id="31656-219">Чтобы отправить команду ОПМ, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="31656-219">To send an OPM command, perform the following steps.</span></span>

1.  <span data-ttu-id="31656-220">Заполните [**структуру \_ \_ параметров ОПМ configure**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) , как показано в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="31656-220">Fill in an [**OPM\_CONFIGURE\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) structure as shown in the following table.</span></span>

    | <span data-ttu-id="31656-221">Член</span><span class="sxs-lookup"><span data-stu-id="31656-221">Member</span></span>                | <span data-ttu-id="31656-222">Описание</span><span class="sxs-lookup"><span data-stu-id="31656-222">Description</span></span>                                                                                                                                                                                                                                                                                                                                                   |
    |-----------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | <span data-ttu-id="31656-223">**омак**</span><span class="sxs-lookup"><span data-stu-id="31656-223">**omac**</span></span>              | <span data-ttu-id="31656-224">Пока не пропустите это поле.</span><span class="sxs-lookup"><span data-stu-id="31656-224">Skip this field for now.</span></span>                                                                                                                                                                                                                                                                                                                                      |
    | <span data-ttu-id="31656-225">**гуидсеттинг**</span><span class="sxs-lookup"><span data-stu-id="31656-225">**guidSetting**</span></span>       | <span data-ttu-id="31656-226">Идентификатор GUID, идентифицирующий команду.</span><span class="sxs-lookup"><span data-stu-id="31656-226">A GUID that identifies the command.</span></span> <span data-ttu-id="31656-227">Список команд см. в разделе [команды ОПМ](opm-commands.md).</span><span class="sxs-lookup"><span data-stu-id="31656-227">For a list of commands, see [OPM Commands](opm-commands.md).</span></span>                                                                                                                                                                                                                                                             |
    | <span data-ttu-id="31656-228">**улсекуенценумбер**</span><span class="sxs-lookup"><span data-stu-id="31656-228">**ulSequenceNumber**</span></span>  | <span data-ttu-id="31656-229">Порядковый номер.</span><span class="sxs-lookup"><span data-stu-id="31656-229">The sequence number.</span></span> <span data-ttu-id="31656-230">Для первой команды используйте начальный порядковый номер, указанный в методе [**иопмвидеуутпут:: финишинитиализатион**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) (шаг 5 [инициализации сеанса ОПМ](#initializing-an-opm-session)). Каждый раз, когда вы отправляете другую команду, увеличивайте это число на 1.</span><span class="sxs-lookup"><span data-stu-id="31656-230">For the first command, use the starting sequence number that you specified in the [**IOPMVideoOutput::FinishInitialization**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-finishinitialization) method (step 5 of [Initializing an OPM Session](#initializing-an-opm-session).) Each time you send another command, increment this number by 1.</span></span> |
    | <span data-ttu-id="31656-231">**абпараметерс**</span><span class="sxs-lookup"><span data-stu-id="31656-231">**abParameters**</span></span>      | <span data-ttu-id="31656-232">Массив байтов, который содержит дополнительные входные данные для команды.</span><span class="sxs-lookup"><span data-stu-id="31656-232">A byte array that contains additional input data for the command.</span></span> <span data-ttu-id="31656-233">Формат входных данных указан в разделе справки по каждой команде.</span><span class="sxs-lookup"><span data-stu-id="31656-233">The format of the input data is listed in the reference topic for each command.</span></span>                                                                                                                                                                                                             |
    | <span data-ttu-id="31656-234">**кбсеттингдатасизе**</span><span class="sxs-lookup"><span data-stu-id="31656-234">**cbSettingDataSize**</span></span> | <span data-ttu-id="31656-235">Размер допустимых данных в массиве **абпараметерс** .</span><span class="sxs-lookup"><span data-stu-id="31656-235">The size of the valid data in the **abParameters** array.</span></span> <span data-ttu-id="31656-236">Содержимое остальной части массива не определено.</span><span class="sxs-lookup"><span data-stu-id="31656-236">The contents of the rest of the array are undefined.</span></span>                                                                                                                                                                                                                                                |

    

     

2.  <span data-ttu-id="31656-237">Вычислите ОМАК для блока данных, который отображается после элемента **ОМАК** , а затем установите для элемента **ОМАК** это значение.</span><span class="sxs-lookup"><span data-stu-id="31656-237">Calculate an OMAC for the block of data that appears after the **omac** member, and then set the **omac** member to this value.</span></span>
3.  <span data-ttu-id="31656-238">Вызовите [**иопмвидеуутпут:: Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure).</span><span class="sxs-lookup"><span data-stu-id="31656-238">Call [**IOPMVideoOutput::Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure).</span></span>

<span data-ttu-id="31656-239">Для большинства команд существует соответствующий запрос состояния, возвращающий состояние команды.</span><span class="sxs-lookup"><span data-stu-id="31656-239">For most commands, there is a corresponding status request that returns the status of the command.</span></span> <span data-ttu-id="31656-240">Например, команда [**ОПМ \_ Set \_ Protection \_ Level**](opm-set-protection-level.md) задает уровень защиты, а команда [**ОПМ \_ получить \_ виртуальную \_ защиту \_**](opm-get-virtual-protection-level.md) возвращает текущий уровень защиты.</span><span class="sxs-lookup"><span data-stu-id="31656-240">For example, the [**OPM\_SET\_PROTECTION\_LEVEL**](opm-set-protection-level.md) command sets the protection level, and the [**OPM\_GET\_VIRTUAL\_PROTECTION\_LEVEL**](opm-get-virtual-protection-level.md) command gets the current protection level.</span></span>

## <a name="handling-a-disabled-video-output"></a><span data-ttu-id="31656-241">Обработка отключенного вывода видео</span><span class="sxs-lookup"><span data-stu-id="31656-241">Handling a Disabled Video Output</span></span>

<span data-ttu-id="31656-242">Выходные данные видео могут быть отключены в любое время, чтобы предотвратить несанкционированное использование видеосодержимого.</span><span class="sxs-lookup"><span data-stu-id="31656-242">A video output might disable itself at any time to prevent the unauthorized use of video content.</span></span> <span data-ttu-id="31656-243">Это может произойти из-за того, что механизм защиты перестанет работать, так как драйвер обнаруживает незаконное изменение, или потому, что дисплей был отключен от физического соединителя.</span><span class="sxs-lookup"><span data-stu-id="31656-243">This might occur because a protection mechanism stops working, because the driver detects tampering, or because the display was disconnected from the physical connector.</span></span> <span data-ttu-id="31656-244">Хотя выходные данные видео отключены, видеокадры не отображаются.</span><span class="sxs-lookup"><span data-stu-id="31656-244">While a video output is disabled, no video frames are displayed.</span></span>

<span data-ttu-id="31656-245">Хотя защита содержимого включена, приложение должно периодически (по крайней мере раз в 2 секунды) выполнить следующие действия.</span><span class="sxs-lookup"><span data-stu-id="31656-245">While content protection is enabled, an application should periodically (at least once every 2 seconds) perform the following steps.</span></span>

1.  <span data-ttu-id="31656-246">Вызовите [**иопмвидеуутпут::**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) Get, чтобы отправить [**ОПМ \_ получить \_ фактический \_ \_ уровень защиты**](opm-get-actual-protection-level.md) или [**ОПМ \_ получить \_ виртуальный \_ \_**](opm-get-virtual-protection-level.md) запрос о состоянии защиты.</span><span class="sxs-lookup"><span data-stu-id="31656-246">Call [**IOPMVideoOutput::GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) to send either the [**OPM\_GET\_ACTUAL\_PROTECTION\_LEVEL**](opm-get-actual-protection-level.md) or [**OPM\_GET\_VIRTUAL\_PROTECTION\_LEVEL**](opm-get-virtual-protection-level.md) status request.</span></span> <span data-ttu-id="31656-247">Возвращаемые данные для обеих команд — это [**\_ Стандартная \_ информационная структура ОПМ**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="31656-247">The return data for both commands is an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span>
2.  <span data-ttu-id="31656-248">Проверьте элемент **улинформатион** [**\_ \_ информационной структуры ОПМ Standard**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="31656-248">Check the **ulInformation** member of the [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="31656-249">Этот элемент содержит флаг, указывающий, включена ли защита содержимого.</span><span class="sxs-lookup"><span data-stu-id="31656-249">This member contains a flag indicating whether content protection is still enabled.</span></span> <span data-ttu-id="31656-250">Если защита содержимого отключена, немедленно остановите воспроизведение видео.</span><span class="sxs-lookup"><span data-stu-id="31656-250">If content protection is off, stop playing the video immediately.</span></span>
3.  <span data-ttu-id="31656-251">Если защита содержимого включена, проверьте элемент **улстатусфлагс** в [**информационной структуре ОПМ \_ Standard \_**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="31656-251">If content protection is on, check the **ulStatusFlags** member of the [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="31656-252">Если флаги не заданы, то выходные данные видео работают правильно.</span><span class="sxs-lookup"><span data-stu-id="31656-252">If no flags are set, the video output is working correctly.</span></span> <span data-ttu-id="31656-253">В противном случае выходные данные видео отключаются.</span><span class="sxs-lookup"><span data-stu-id="31656-253">Otherwise, the video output is disabled.</span></span>

<span data-ttu-id="31656-254">Для **улстатусфлагс** определены следующие флаги.</span><span class="sxs-lookup"><span data-stu-id="31656-254">The following flags are defined for **ulStatusFlags**.</span></span>



<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th><span data-ttu-id="31656-255">Flag</span><span class="sxs-lookup"><span data-stu-id="31656-255">Flag</span></span></th>
<th><span data-ttu-id="31656-256">Описание</span><span class="sxs-lookup"><span data-stu-id="31656-256">Description</span></span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span data-ttu-id="31656-257"><strong>OPM_STATUS_LINK_LOST</strong></span><span class="sxs-lookup"><span data-stu-id="31656-257"><strong>OPM_STATUS_LINK_LOST</strong></span></span></td>
<td><span data-ttu-id="31656-258">По какой бы причине защита выходных данных прекратила работу. Например, устройство вывода может быть отключено от коннтектор.</span><span class="sxs-lookup"><span data-stu-id="31656-258">Output protection stopped working for some reason; for example, the display device might be unplugged from the conntector.</span></span> <span data-ttu-id="31656-259">Останавливает воспроизведение и выключает все механизмы защиты выходных данных.</span><span class="sxs-lookup"><span data-stu-id="31656-259">Stop playback and turn off all output protection mechanisms.</span></span></td>
</tr>
<tr class="even">
<td><span data-ttu-id="31656-260"><strong>OPM_STATUS_RENEGOTIATION_REQUIRED</strong></span><span class="sxs-lookup"><span data-stu-id="31656-260"><strong>OPM_STATUS_RENEGOTIATION_REQUIRED</strong></span></span></td>
<td><span data-ttu-id="31656-261">Приложение должно повторно установить сеанс ОПМ.</span><span class="sxs-lookup"><span data-stu-id="31656-261">The application must reestablish the OPM session.</span></span> <span data-ttu-id="31656-262">Ответьте следующим образом:</span><span class="sxs-lookup"><span data-stu-id="31656-262">Respond as follows:</span></span>
<ol>
<li><span data-ttu-id="31656-263">Останавливает воспроизведение.</span><span class="sxs-lookup"><span data-stu-id="31656-263">Stop playback.</span></span></li>
<li><span data-ttu-id="31656-264">Отключите все механизмы защиты.</span><span class="sxs-lookup"><span data-stu-id="31656-264">Turn off all protection mechanisms.</span></span></li>
<li><span data-ttu-id="31656-265">Освободите интерфейс <a href="/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput"><strong>иопмвидеуутпут</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="31656-265">Release the <a href="/windows/desktop/api/opmapi/nn-opmapi-iopmvideooutput"><strong>IOPMVideoOutput</strong></a> interface.</span></span></li>
<li><span data-ttu-id="31656-266">Повторное создание всех поверхностей видео.</span><span class="sxs-lookup"><span data-stu-id="31656-266">Recreate all video surfaces.</span></span></li>
<li><span data-ttu-id="31656-267">Создайте новый объект ОПМ и попытайтесь восстановить защиту содержимого.</span><span class="sxs-lookup"><span data-stu-id="31656-267">Create a new OPM object and attempt to reestablish content protection.</span></span> <span data-ttu-id="31656-268">Если это не удается, отобразится сообщение об ошибке для пользователя.</span><span class="sxs-lookup"><span data-stu-id="31656-268">If this fails, display an error message to the user.</span></span> <span data-ttu-id="31656-269">Не воспроизводить видеоматериалы.</span><span class="sxs-lookup"><span data-stu-id="31656-269">Do not play any more video content.</span></span></li>
</ol></td>
</tr>
<tr class="odd">
<td><span data-ttu-id="31656-270"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span><span class="sxs-lookup"><span data-stu-id="31656-270"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span></span></td>
<td><span data-ttu-id="31656-271">Этот флаг применяется только при использовании HDCP и указывает на наличие отозванного устройства HDCP.</span><span class="sxs-lookup"><span data-stu-id="31656-271">This flag applies only when HDCP is used, and indicates the presence of a revoked HDCP device.</span></span> <span data-ttu-id="31656-272">Закройте воспроизведение и отключите все механизмы защиты на этом видеоролике.</span><span class="sxs-lookup"><span data-stu-id="31656-272">Stop playback and turn off all protection mechanisms on this video output.</span></span> <span data-ttu-id="31656-273">Если этот флаг установлен, также устанавливается флаг <strong>OPM_STATUS_LINK_LOST</strong> .</span><span class="sxs-lookup"><span data-stu-id="31656-273">When this flag is set, the <strong>OPM_STATUS_LINK_LOST</strong> flag is also set.</span></span></td>
</tr>
<tr class="even">
<td><span data-ttu-id="31656-274"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span><span class="sxs-lookup"><span data-stu-id="31656-274"><strong>OPM_STATUS_REVOKED_HDCP_DEVICE_ATTACHED</strong></span></span></td>
<td><span data-ttu-id="31656-275">Драйвер обнаружил незаконное изменение.</span><span class="sxs-lookup"><span data-stu-id="31656-275">The driver has detected tampering.</span></span> <span data-ttu-id="31656-276">Останавливает воспроизведение и не воспроизводит видео с помощью этих выходных данных видео.</span><span class="sxs-lookup"><span data-stu-id="31656-276">Stop playback, and do not play any more video using this video output.</span></span> <span data-ttu-id="31656-277">Также рекомендуется перестать использовать любые другие видеовыходы, так как система может быть скомпрометирована.</span><span class="sxs-lookup"><span data-stu-id="31656-277">It is also a good idea to stop using any other video outputs, because the system might be compromised.</span></span></td>
</tr>
</tbody>
</table>



 

## <a name="using-hdcp-to-protect-content"></a><span data-ttu-id="31656-278">Защита содержимого с помощью HDCP</span><span class="sxs-lookup"><span data-stu-id="31656-278">Using HDCP to Protect Content</span></span>

<span data-ttu-id="31656-279">В этом разделе описано, как включить защиту выходных данных HDCP с помощью ОПМ.</span><span class="sxs-lookup"><span data-stu-id="31656-279">This section describes how to enable HDCP output protection using OPM.</span></span> <span data-ttu-id="31656-280">Ниже приведена общая структура действий, которые должен выполнить приложение.</span><span class="sxs-lookup"><span data-stu-id="31656-280">Here is a general outline of the steps the application must take.</span></span> <span data-ttu-id="31656-281">Подробные сведения приведены далее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="31656-281">Details are given later in this section.</span></span>

1.  <span data-ttu-id="31656-282">Приложению может потребоваться предоставить СРМ для вывода видео.</span><span class="sxs-lookup"><span data-stu-id="31656-282">The application might have to provide an SRM to the video output.</span></span> <span data-ttu-id="31656-283">Механизм получения Срмс находится за пределами области интерфейса ОПМ.</span><span class="sxs-lookup"><span data-stu-id="31656-283">The mechanism for receiving SRMs is outside the scope of the OPM interface.</span></span> <span data-ttu-id="31656-284">Например, Срмс может доставляться как часть широковещательного потока.</span><span class="sxs-lookup"><span data-stu-id="31656-284">For example, SRMs might be delivered as part of a broadcast stream.</span></span>
2.  <span data-ttu-id="31656-285">Приложение включает защиту выходных данных HDCP.</span><span class="sxs-lookup"><span data-stu-id="31656-285">The application enables HDCP output protection.</span></span>
3.  <span data-ttu-id="31656-286">Приложение воспроизводит видеоматериалы.</span><span class="sxs-lookup"><span data-stu-id="31656-286">The application plays the video content.</span></span> <span data-ttu-id="31656-287">Периодически приложение опрашивает драйвер, чтобы убедиться в том, что HDCP включен.</span><span class="sxs-lookup"><span data-stu-id="31656-287">Periodically, the application polls the driver to make sure HDCP is on.</span></span>
4.  <span data-ttu-id="31656-288">После завершения воспроизведения приложение отключает HDCP.</span><span class="sxs-lookup"><span data-stu-id="31656-288">When playback is complete, the application turns off HDCP.</span></span>

### <a name="setting-the-srm"></a><span data-ttu-id="31656-289">Настройка СРМ</span><span class="sxs-lookup"><span data-stu-id="31656-289">Setting the SRM</span></span>

<span data-ttu-id="31656-290">Чтобы задать СРМ, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="31656-290">To set the SRM, perform the following steps.</span></span>

1.  <span data-ttu-id="31656-291">Инициализируйте [**структуру \_ параметров ОПМ Set \_ HDCP \_ СРМ \_**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) с номером версии СРМ.</span><span class="sxs-lookup"><span data-stu-id="31656-291">Initialize an [**OPM\_SET\_HDCP\_SRM\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) structure with the SRM version number.</span></span>
2.  <span data-ttu-id="31656-292">Сохраните СРМ в переменной.</span><span class="sxs-lookup"><span data-stu-id="31656-292">Store the SRM in a variable.</span></span>
3.  <span data-ttu-id="31656-293">Отправьте команду [**ОПМ \_ Set \_ HDCP \_ СРМ**](opm-set-hdcp-srm.md) к выходным данным видео.</span><span class="sxs-lookup"><span data-stu-id="31656-293">Send an [**OPM\_SET\_HDCP\_SRM**](opm-set-hdcp-srm.md) command to the video output.</span></span> <span data-ttu-id="31656-294">Используйте процедуру, описанную в разделе [Send ОПМ Commands](#sending-opm-commands).</span><span class="sxs-lookup"><span data-stu-id="31656-294">Use the procedure described in [Sending OPM Commands](#sending-opm-commands).</span></span>
    -   <span data-ttu-id="31656-295">Элемент **абпараметерс** структуры [**\_ \_ параметров ОПМ configure**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) содержит структуру [**\_ Parameters ОПМ Set \_ HDCP \_ СРМ \_**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) .</span><span class="sxs-lookup"><span data-stu-id="31656-295">The **abParameters** member of the [**OPM\_CONFIGURE\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_configure_parameters) structure contains the [**OPM\_SET\_HDCP\_SRM\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_hdcp_srm_parameters) structure.</span></span>
    -   <span data-ttu-id="31656-296">Параметр *пбаддитионалпараметерс* метода [**Иопмвидеуутпут:: Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure) указывает на переменную, содержащую СРМ.</span><span class="sxs-lookup"><span data-stu-id="31656-296">The *pbAdditionalParameters* parameter of the [**IOPMVideoOutput::Configure**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-configure) method points to the variable that contains the SRM.</span></span>
4.  <span data-ttu-id="31656-297">Отправка запроса о состоянии [**\_ версии ОПМ Get \_ Current \_ \_ СРМ \_**](opm-get-current-hdcp-srm-version.md) в выходном видео.</span><span class="sxs-lookup"><span data-stu-id="31656-297">Send an [**OPM\_GET\_CURRENT\_HDCP\_SRM\_VERSION**](opm-get-current-hdcp-srm-version.md) status request to the video output.</span></span> <span data-ttu-id="31656-298">Используйте процедуру, описанную в разделе [Отправка запросов состояния ОПМ](#sending-opm-status-requests).</span><span class="sxs-lookup"><span data-stu-id="31656-298">Use the procedure described in [Sending OPM Status Requests](#sending-opm-status-requests).</span></span> <span data-ttu-id="31656-299">Этот запрос состояния не содержит входных данных, поэтому содержимое элемента **абпараметерс** структуры [**\_ параметров ОПМ Get \_ info \_**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) не определено.</span><span class="sxs-lookup"><span data-stu-id="31656-299">This status request has no input data, so the contents of the **abParameters** member of the [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure are undefined.</span></span>
5.  <span data-ttu-id="31656-300">Когда метод [**иопмвидеуутпут::**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) **абрекуестединформатион** возвращает значение, в массиве [**ОПМ \_ запрашиваемой \_ информационной**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) структуры содержится структура [**ОПМ \_ Standard \_ Information**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="31656-300">When the [**IOPMVideoOutput::GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) method returns, the **abRequestedInformation** array in the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure contains an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="31656-301">Элемент **улинформатион** этой структуры содержит номер версии текущего СРМ.</span><span class="sxs-lookup"><span data-stu-id="31656-301">The **ulInformation** member of this structure contains the version number of the current SRM.</span></span> <span data-ttu-id="31656-302">Это значение должно быть равно значению, заданному на шаге 2.</span><span class="sxs-lookup"><span data-stu-id="31656-302">This value must equal the value from step 2.</span></span>

### <a name="enabling-hdcp"></a><span data-ttu-id="31656-303">Включение HDCP</span><span class="sxs-lookup"><span data-stu-id="31656-303">Enabling HDCP</span></span>

<span data-ttu-id="31656-304">Чтобы включить HDCP, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="31656-304">To enable HDCP, perform the following steps.</span></span>

1.  <span data-ttu-id="31656-305">Инициализируйте [**структуру \_ \_ \_ \_ параметров уровня защиты ОПМ**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) , используя следующие значения:</span><span class="sxs-lookup"><span data-stu-id="31656-305">Initialize an [**OPM\_SET\_PROTECTION\_LEVEL\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) structure with the following values:</span></span>
    -   <span data-ttu-id="31656-306">**улпротектионтипе**  =  **ОПМ \_ \_Тип защиты \_ HDCP**</span><span class="sxs-lookup"><span data-stu-id="31656-306">**ulProtectionType** = **OPM\_PROTECTION\_TYPE\_HDCP**</span></span>
    -   <span data-ttu-id="31656-307">**улпротектионлевел**  =  **ОПМ \_ HDCP \_ включен**</span><span class="sxs-lookup"><span data-stu-id="31656-307">**ulProtectionLevel** = **OPM\_HDCP\_ON**</span></span>
    -   <span data-ttu-id="31656-308">**Зарезервировано** = 0</span><span class="sxs-lookup"><span data-stu-id="31656-308">**Reserved** = 0</span></span>
    -   <span data-ttu-id="31656-309">**Reserved2** = 0</span><span class="sxs-lookup"><span data-stu-id="31656-309">**Reserved2** = 0</span></span>
2.  <span data-ttu-id="31656-310">Отправка команды [**ОПМ \_ Set \_ Protection \_ Level**](opm-set-protection-level.md) .</span><span class="sxs-lookup"><span data-stu-id="31656-310">Send an [**OPM\_SET\_PROTECTION\_LEVEL**](opm-set-protection-level.md) command.</span></span> <span data-ttu-id="31656-311">Входными данными в массиве **абпараметерс** является структура [**\_ \_ \_ \_ параметров ОПМ Set Protection**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) .</span><span class="sxs-lookup"><span data-stu-id="31656-311">The input data in the **abParameters** array is the [**OPM\_SET\_PROTECTION\_LEVEL\_PARAMETERS**](/windows/desktop/api/opmapi/ns-opmapi-opm_set_protection_level_parameters) structure.</span></span>
3.  <span data-ttu-id="31656-312">Отправьте запрос о состоянии [**\_ \_ виртуальной \_ защиты \_ ОПМ Get Virtual**](opm-get-virtual-protection-level.md) , чтобы проверить, включена ли защита HDCP.</span><span class="sxs-lookup"><span data-stu-id="31656-312">Send an [**OPM\_GET\_VIRTUAL\_PROTECTION\_LEVEL**](opm-get-virtual-protection-level.md) status request to check whether HDCP is enabled.</span></span> <span data-ttu-id="31656-313">Первые 4 байта элемента **абпараметерс** структуры [**\_ \_ \_ параметров получения сведений ОПМ**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) содержат значение **ОПМ \_ \_ Тип защиты \_ HDCP**.</span><span class="sxs-lookup"><span data-stu-id="31656-313">The first 4 bytes of the **abParameters** member of the [**OPM\_GET\_INFO\_PARAMETERS**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_get_info_parameters) structure contain the value **OPM\_PROTECTION\_TYPE\_HDCP**.</span></span>

<span data-ttu-id="31656-314">Когда метод [](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) **абрекуестединформатион** возвращает, массив ОПМ в структуре [**\_ запрашиваемой \_ информации**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) содержит структуру [**ОПМ со \_ стандартной \_ информацией**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) .</span><span class="sxs-lookup"><span data-stu-id="31656-314">When the [**GetInformation**](/windows/desktop/api/opmapi/nf-opmapi-iopmvideooutput-getinformation) method returns, the **abRequestedInformation** array in the [**OPM\_REQUESTED\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_requested_information) structure contains an [**OPM\_STANDARD\_INFORMATION**](/windows/desktop/api/ksopmapi/ns-ksopmapi-opm_standard_information) structure.</span></span> <span data-ttu-id="31656-315">Элемент **улинформатион** этой структуры содержит значение из перечисления [**\_ \_ \_ уровня защиты HDCP ОПМ**](/windows/desktop/api/opmapi/ne-opmapi-opm_hdcp_protection_level) .</span><span class="sxs-lookup"><span data-stu-id="31656-315">The **ulInformation** member of this structure contains a value from the [**OPM\_HDCP\_PROTECTION\_LEVEL**](/windows/desktop/api/opmapi/ne-opmapi-opm_hdcp_protection_level) enumeration.</span></span> <span data-ttu-id="31656-316">Если значение равно **ОПМ \_ HDCP \_ On**, это означает, что включена поддержка HDCP.</span><span class="sxs-lookup"><span data-stu-id="31656-316">If the value equals **OPM\_HDCP\_ON**, it means HDCP is enabled.</span></span> <span data-ttu-id="31656-317">В противном случае повторите шаги 1 – 2, пока HDCP не будет включен, или произойдет ошибка.</span><span class="sxs-lookup"><span data-stu-id="31656-317">Otherwise, repeat steps 1–2 until HDCP is enabled, or an error occurs.</span></span> <span data-ttu-id="31656-318">(Не забудьте увеличить порядковый номер и создать новое случайное число каждый раз.)</span><span class="sxs-lookup"><span data-stu-id="31656-318">(Remember to increment the sequence number and generate a new random number each time.)</span></span>

<span data-ttu-id="31656-319">Для включения HDCP обычно требуется от 100 до 200 миллисекунд, но может потребоваться больше времени.</span><span class="sxs-lookup"><span data-stu-id="31656-319">It usually takes between 100 and 200 milliseconds to enable HDCP, but it can take longer.</span></span> <span data-ttu-id="31656-320">Не считайте, что HDCP включен, пока вы не подтвердите ее.</span><span class="sxs-lookup"><span data-stu-id="31656-320">Do not assume that HDCP is enabled until you have verified it.</span></span>

<span data-ttu-id="31656-321">Когда приложение завершает воспроизведение защищенного содержимого, отключите HDCP.</span><span class="sxs-lookup"><span data-stu-id="31656-321">When the application finishes playing protected content, turn off HDCP.</span></span> <span data-ttu-id="31656-322">Эти шаги те же, что и при включении HDCP, но на шаге 1 Установите для параметра **улпротектионлевел** значение **ОПМ \_ HDCP \_ Off**.</span><span class="sxs-lookup"><span data-stu-id="31656-322">The steps are the same as for enabling HDCP, but in step 1, set **ulProtectionLevel** to **OPM\_HDCP\_OFF**.</span></span>

> [!Note]  
> <span data-ttu-id="31656-323">Не включайте HDCP, если тип соединителя **ОПМ \_ \_ \_ дисплайпорт \_ Embedded**.</span><span class="sxs-lookup"><span data-stu-id="31656-323">Do not enable HDCP if the connector type is **OPM\_CONNECTOR\_TYPE\_DISPLAYPORT\_EMBEDDED**.</span></span> <span data-ttu-id="31656-324">(См. раздел [**Флаги типа соединителя ОПМ**](opm-connector-type-flags.md).)</span><span class="sxs-lookup"><span data-stu-id="31656-324">(See [**OPM Connector Type Flags**](opm-connector-type-flags.md).)</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="31656-325">См. также</span><span class="sxs-lookup"><span data-stu-id="31656-325">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="31656-326">Диспетчер выходной защиты</span><span class="sxs-lookup"><span data-stu-id="31656-326">Output Protection Manager</span></span>](output-protection-manager.md)
</dt> </dl>

 

 



