---
description: В этом разделе описывается содержимое видео&\# 8211; возможности защиты, которые может предоставить графический драйвер.
ms.assetid: 3FDB4908-C75D-4AE0-B32E-93F840E4F30A
title: GPU-Based Защита содержимого с D3D11 видео
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 78097492d375d50688f2472f5d2de99cc21f8594
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104072562"
---
# <a name="gpu-based-content-protection-with-d3d11-video"></a><span data-ttu-id="04a28-103">GPU-Based Защита содержимого с D3D11 видео</span><span class="sxs-lookup"><span data-stu-id="04a28-103">GPU-Based Content Protection with D3D11 Video</span></span>

<span data-ttu-id="04a28-104">В этом разделе описывается содержимое видео — возможности защиты, которые может предоставить графический драйвер.</span><span class="sxs-lookup"><span data-stu-id="04a28-104">This topic describes video content–protection capabilities that a graphics driver can provide.</span></span>

-   [<span data-ttu-id="04a28-105">Введение</span><span class="sxs-lookup"><span data-stu-id="04a28-105">Introduction</span></span>](#introduction)
-   [<span data-ttu-id="04a28-106">Общие сведения о процессе декодирования</span><span class="sxs-lookup"><span data-stu-id="04a28-106">Overview of the Decoding Process</span></span>](#overview-of-the-decoding-process)
-   [<span data-ttu-id="04a28-107">Шифрование сжатых буферов видео для декодера</span><span class="sxs-lookup"><span data-stu-id="04a28-107">Encrypting Compressed Video Buffers for the Decoder</span></span>](#encrypting-compressed-video-buffers-for-the-decoder)
    -   [<span data-ttu-id="04a28-108">1. запросите Защита содержимого возможности драйвера.</span><span class="sxs-lookup"><span data-stu-id="04a28-108">1. Query the Content Protection Capabilities of the Driver</span></span>](#1-query-the-content-protection-capabilities-of-the-driver)
    -   [<span data-ttu-id="04a28-109">2. Настройка канала, прошедшего проверку подлинности</span><span class="sxs-lookup"><span data-stu-id="04a28-109">2. Configure the Authenticated Channel</span></span>](#2-configure-the-authenticated-channel)
    -   [<span data-ttu-id="04a28-110">3. Настройка сеанса шифрования</span><span class="sxs-lookup"><span data-stu-id="04a28-110">3. Configure the Cryptographic Session</span></span>](#3-configure-the-cryptographic-session)
    -   [<span data-ttu-id="04a28-111">4. Связывание декодера с криптографическим сеансом</span><span class="sxs-lookup"><span data-stu-id="04a28-111">4. Associate the decoder with the Cryptographic Session</span></span>](#4-associate-the-decoder-with-the-cryptographic-session)
-   [<span data-ttu-id="04a28-112">Отправка команд аутентифицированного канала</span><span class="sxs-lookup"><span data-stu-id="04a28-112">Sending Authenticated Channel Commands</span></span>](#sending-authenticated-channel-commands)
-   [<span data-ttu-id="04a28-113">Отправка запросов к каналам с проверкой подлинности</span><span class="sxs-lookup"><span data-stu-id="04a28-113">Sending Authenticated Channel Queries</span></span>](#sending-authenticated-channel-queries)
-   [<span data-ttu-id="04a28-114">См. также</span><span class="sxs-lookup"><span data-stu-id="04a28-114">Related topics</span></span>](#related-topics)

## <a name="introduction"></a><span data-ttu-id="04a28-115">Введение</span><span class="sxs-lookup"><span data-stu-id="04a28-115">Introduction</span></span>

<span data-ttu-id="04a28-116">На следующей диаграмме показано упрощенное представление того, как защищенное видео проходит через конвейер для подготовки к просмотру.</span><span class="sxs-lookup"><span data-stu-id="04a28-116">The following diagram shows a simplified view of how protected video content travels through the pipeline to be rendered.</span></span>

![Схема, на которой показано защищенное видео-содержимое.](images/d3d9video01.png)

> [!Note]
>
> <span data-ttu-id="04a28-118">[Путь к защищенному носителю](protected-media-path.md) (PMP) не показан на этой схеме.</span><span class="sxs-lookup"><span data-stu-id="04a28-118">The [Protected Media Path](protected-media-path.md) (PMP) is not depicted in this diagram.</span></span> <span data-ttu-id="04a28-119">Показанный здесь поток данных может находиться в процессе PMP или в процессе приложения.</span><span class="sxs-lookup"><span data-stu-id="04a28-119">The data flow that is shown here might occur within a PMP process, or within an application process.</span></span>

 

<span data-ttu-id="04a28-120">Декодер получает зашифрованные сжатые данные видео из внешнего источника.</span><span class="sxs-lookup"><span data-stu-id="04a28-120">The decoder receives encrypted, compressed video data from an external source.</span></span> <span data-ttu-id="04a28-121">Предполагается, что декодер также получает криптографический ключ для расшифровки этих данных.</span><span class="sxs-lookup"><span data-stu-id="04a28-121">It is assumed also the decoder also receives a cryptographic key to decrypt this data.</span></span> <span data-ttu-id="04a28-122">В этом разделе не описывается обмен ключами между источником видео и декодером, но PMP определяет один из возможных механизмов.</span><span class="sxs-lookup"><span data-stu-id="04a28-122">This topic does not describe the key exchange between the video source and decoder, but the PMP defines one possible mechanism.</span></span> <span data-ttu-id="04a28-123">На этом этапе не участвует графический процессор.</span><span class="sxs-lookup"><span data-stu-id="04a28-123">The GPU is not involved at this stage.</span></span>

<span data-ttu-id="04a28-124">При декодировании с аппаратным ускорением программный декодер передает сжатое видео-изображение в графический процессор.</span><span class="sxs-lookup"><span data-stu-id="04a28-124">For hardware-accelerated decoding, the software decoder passes compressed video content to the GPU.</span></span> <span data-ttu-id="04a28-125">Чтобы защитить это содержимое, декодер повторно шифрует данные, как правило, с помощью AES-Protector, перед передачей их в аппаратный ускоритель.</span><span class="sxs-lookup"><span data-stu-id="04a28-125">To protect this content, the decoder re-encrypts the data, typically using AES-CTR, before passing it to the hardware accelerator.</span></span> <span data-ttu-id="04a28-126">Механизм обмена ключами определяется между декодером и драйвером графики.</span><span class="sxs-lookup"><span data-stu-id="04a28-126">A key-exchange mechanism is defined between the decoder and the graphics driver.</span></span>

<span data-ttu-id="04a28-127">Декодированные видеоматериалы хранятся в видеопамяти, как правило, в четком виде.</span><span class="sxs-lookup"><span data-stu-id="04a28-127">Decoded video frames are stored in video memory, generally in the clear.</span></span> <span data-ttu-id="04a28-128">На этом этапе кадры обрабатываются, а затем представляются.</span><span class="sxs-lookup"><span data-stu-id="04a28-128">At this point, the frames are processed and then presented.</span></span> <span data-ttu-id="04a28-129">Существует два основных варианта представления.</span><span class="sxs-lookup"><span data-stu-id="04a28-129">There are two main options for presentation.</span></span>

-   <span data-ttu-id="04a28-130">При использовании API D3D9 можно представить фреймы с помощью наложения оборудования.</span><span class="sxs-lookup"><span data-stu-id="04a28-130">When using the D3D9 API, frames can be presented using a hardware overlay.</span></span> <span data-ttu-id="04a28-131">Аппаратное обеспечение не поддерживается в D3D11.</span><span class="sxs-lookup"><span data-stu-id="04a28-131">Hardware overly is not supported in D3D11.</span></span> <span data-ttu-id="04a28-132">Дополнительные сведения см. в разделе [поддержка наложения оборудования](hardware-overlay-support.md).</span><span class="sxs-lookup"><span data-stu-id="04a28-132">For more information, see [Hardware Overlay Support](hardware-overlay-support.md).</span></span>
-   <span data-ttu-id="04a28-133">Фреймы могут быть представлены оконным окном Управление (DWM) с помощью общей поверхности.</span><span class="sxs-lookup"><span data-stu-id="04a28-133">Frames can be presented by the Desktop Window Manage (DWM) using a shared surface.</span></span>

<span data-ttu-id="04a28-134">Последним шагом является отображение кадра на мониторе, для которого может потребоваться защита канала между графической картой и устройством отображения.</span><span class="sxs-lookup"><span data-stu-id="04a28-134">The last step is to display the frame on the monitor, which may require link protection between the graphics card and the display device.</span></span> <span data-ttu-id="04a28-135">Примером защиты канала является High-Bandwidth цифровой Защита содержимого (HDCP).</span><span class="sxs-lookup"><span data-stu-id="04a28-135">An example of link protection is High-Bandwidth Digital Content Protection (HDCP).</span></span> <span data-ttu-id="04a28-136">Защита канала настраивается с помощью [диспетчера выходной защиты](output-protection-manager.md) (ОПМ).</span><span class="sxs-lookup"><span data-stu-id="04a28-136">Link protection is configured using [Output Protection Manager](output-protection-manager.md) (OPM).</span></span> <span data-ttu-id="04a28-137">В этом разделе не описывается ОПМ; Дополнительные сведения см. [в разделе Использование диспетчера выходной защиты](using-output-protection-manager.md).</span><span class="sxs-lookup"><span data-stu-id="04a28-137">This topic does not describe OPM; for more information, see [Using Output Protection Manager](using-output-protection-manager.md).</span></span>

## <a name="overview-of-the-decoding-process"></a><span data-ttu-id="04a28-138">Общие сведения о процессе декодирования</span><span class="sxs-lookup"><span data-stu-id="04a28-138">Overview of the Decoding Process</span></span>

<span data-ttu-id="04a28-139">При декодировании с аппаратным ускорением программный декодер должен передавать на графическую карту сжатые данные видео.</span><span class="sxs-lookup"><span data-stu-id="04a28-139">During hardware-accelerated decoding, the software decoder must pass compressed video data to the graphics card.</span></span> <span data-ttu-id="04a28-140">Для содержимого уровня "Премиум" эти данные обычно должны быть зашифрованы с помощью шифрования с симметричным ключом перед отправкой на GPU.</span><span class="sxs-lookup"><span data-stu-id="04a28-140">For premium content, this data typically must be encrypted, using symmetric-key encryption, before it is sent to the GPU.</span></span>

<span data-ttu-id="04a28-141">Чтобы зашифровать видео для декодирования, программный декодер использует следующие интерфейсы:</span><span class="sxs-lookup"><span data-stu-id="04a28-141">To encrypt the video for decoding, the software decoder uses the following interfaces:</span></span>

-   <span data-ttu-id="04a28-142">[**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder).</span><span class="sxs-lookup"><span data-stu-id="04a28-142">[**ID3D11VideoDecoder**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder).</span></span> <span data-ttu-id="04a28-143">Представляет устройство декодера, также называемое ускорителем.</span><span class="sxs-lookup"><span data-stu-id="04a28-143">Represents the decoder device, also called the accelerator.</span></span>
-   <span data-ttu-id="04a28-144">[**ID3D11CryptoSession**](/windows/desktop/api/d3d11/nn-d3d11-id3d11cryptosession).</span><span class="sxs-lookup"><span data-stu-id="04a28-144">[**ID3D11CryptoSession**](/windows/desktop/api/d3d11/nn-d3d11-id3d11cryptosession).</span></span> <span data-ttu-id="04a28-145">Представляет сеанс шифрования, который предоставляет ключ шифрования.</span><span class="sxs-lookup"><span data-stu-id="04a28-145">Represents a cryptographic session, which provides the encryption key.</span></span>
-   <span data-ttu-id="04a28-146">[**ID3D11AuthenticatedChannel**](/windows/desktop/api/d3d11/nn-d3d11-id3d11authenticatedchannel).</span><span class="sxs-lookup"><span data-stu-id="04a28-146">[**ID3D11AuthenticatedChannel**](/windows/desktop/api/d3d11/nn-d3d11-id3d11authenticatedchannel).</span></span> <span data-ttu-id="04a28-147">Представляет канал, прошедший проверку подлинности, который позволяет декодеру программного обеспечения связывать сеанс шифрования с декодером.</span><span class="sxs-lookup"><span data-stu-id="04a28-147">Represents an authenticated channel, which enables the software decoder to associate the cryptographic session with the decoder.</span></span>

![Схема, на которой показаны интерфейсы декодирования Direct3D9.](images/d3d9video02.png)

<span data-ttu-id="04a28-149">Все эти интерфейсы получаются с устройства Direct3D11 следующим образом:</span><span class="sxs-lookup"><span data-stu-id="04a28-149">All of these interfaces are obtained from the Direct3D11 device, as follows:</span></span>



| <span data-ttu-id="04a28-150">Интерфейс</span><span class="sxs-lookup"><span data-stu-id="04a28-150">Interface</span></span>                                                        | <span data-ttu-id="04a28-151">Создание</span><span class="sxs-lookup"><span data-stu-id="04a28-151">Creation</span></span>                                                                                                                                                |
|------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="04a28-152">**ID3D11VideoDecoder**</span><span class="sxs-lookup"><span data-stu-id="04a28-152">**ID3D11VideoDecoder**</span></span>](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodecoder)                 | <span data-ttu-id="04a28-153">Вызовите [**ID3D11VideoDevice:: креатевидеодекодер**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createvideodecoderoutputview).</span><span class="sxs-lookup"><span data-stu-id="04a28-153">Call [**ID3D11VideoDevice::CreateVideoDecoder**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createvideodecoderoutputview).</span></span> <span data-ttu-id="04a28-154">Тип декодера определяется идентификатором GUID профиля.</span><span class="sxs-lookup"><span data-stu-id="04a28-154">The decoder type is identified by a profile GUID.</span></span> |
| [<span data-ttu-id="04a28-155">**ID3D11CryptoSession**</span><span class="sxs-lookup"><span data-stu-id="04a28-155">**ID3D11CryptoSession**</span></span>](/windows/desktop/api/d3d11/nn-d3d11-id3d11cryptosession)               | <span data-ttu-id="04a28-156">Вызовите [**ID3D11VideoDevice:: креатекриптосессион**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createcryptosession).</span><span class="sxs-lookup"><span data-stu-id="04a28-156">Call [**ID3D11VideoDevice::CreateCryptoSession**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createcryptosession).</span></span>                                                           |
| [<span data-ttu-id="04a28-157">**ID3D11AuthenticatedChannel**</span><span class="sxs-lookup"><span data-stu-id="04a28-157">**ID3D11AuthenticatedChannel**</span></span>](/windows/desktop/api/d3d11/nn-d3d11-id3d11authenticatedchannel) | <span data-ttu-id="04a28-158">Вызовите [**ID3D11VideoDevice:: креатеаусентикатедчаннел**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createauthenticatedchannel).</span><span class="sxs-lookup"><span data-stu-id="04a28-158">Call [**ID3D11VideoDevice::CreateAuthenticatedChannel**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createauthenticatedchannel).</span></span>                                             |



 

> [!Note]  
> <span data-ttu-id="04a28-159">Чтобы получить указатель на интерфейс [**ID3D11VideoDevice**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodevice) , вызовите [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) в интерфейсе [**ID3D11Device**](/windows/win32/api/d3d11/nn-d3d11-id3d11device) .</span><span class="sxs-lookup"><span data-stu-id="04a28-159">To get a pointer to the [**ID3D11VideoDevice**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodevice) interface, call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) on [**ID3D11Device**](/windows/win32/api/d3d11/nn-d3d11-id3d11device) interface.</span></span>

 

<span data-ttu-id="04a28-160">Прошедший проверку подлинности канал предоставляет доверенный канал связи между программным декодером и драйвером.</span><span class="sxs-lookup"><span data-stu-id="04a28-160">The authenticated channel provides a trusted communication channel between the software decoder and the driver.</span></span> <span data-ttu-id="04a28-161">Коммуникационный канал работает следующим образом:</span><span class="sxs-lookup"><span data-stu-id="04a28-161">The communication channel works as follows:</span></span>

-   <span data-ttu-id="04a28-162">Драйвер предоставляет цепочку сертификатов X. 509, корневой сертификат которой подписан корпорацией Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="04a28-162">The driver provides an X.509 certificate chain whose root certificate is signed by Microsoft.</span></span>
-   <span data-ttu-id="04a28-163">Сертификат содержит открытый ключ RSA для драйвера.</span><span class="sxs-lookup"><span data-stu-id="04a28-163">The certificate contains an RSA public key for the driver.</span></span>
-   <span data-ttu-id="04a28-164">Программный декодер использует открытый ключ для отправки драйвера в 128-разрядный сеансовый ключ AES.</span><span class="sxs-lookup"><span data-stu-id="04a28-164">The software decoder uses the public key to send the driver a 128-bit AES session key.</span></span>
-   <span data-ttu-id="04a28-165">Программный декодер отправляет запросы и команды в канал, прошедший проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="04a28-165">The software decoder sends queries and commands to the authenticated channel.</span></span>
-   <span data-ttu-id="04a28-166">Ключ сеанса используется для расчета кодов проверки подлинности сообщений (Mac) для запросов и команд.</span><span class="sxs-lookup"><span data-stu-id="04a28-166">The session key is used to compute message authentication codes (MACs) for the queries and commands.</span></span> <span data-ttu-id="04a28-167">Драйвер использует макинтоши для проверки целостности данных запроса или команды, а программный декодер использует их для проверки целостности данных ответа из драйвера.</span><span class="sxs-lookup"><span data-stu-id="04a28-167">The driver uses the MACs to verify the integrity of the query/command data, and the software decoder uses them to verify the integrity of the response data from the driver.</span></span>

## <a name="encrypting-compressed-video-buffers-for-the-decoder"></a><span data-ttu-id="04a28-168">Шифрование сжатых буферов видео для декодера</span><span class="sxs-lookup"><span data-stu-id="04a28-168">Encrypting Compressed Video Buffers for the Decoder</span></span>

<span data-ttu-id="04a28-169">Ниже приведен общий обзор процесса шифрования и декодирования.</span><span class="sxs-lookup"><span data-stu-id="04a28-169">Here is a high-level overview of the encryption and decoding process:</span></span>

1.  <span data-ttu-id="04a28-170">Программный декодер получает поток зашифрованных данных из источника видео.</span><span class="sxs-lookup"><span data-stu-id="04a28-170">The software decoder receives a stream of encrypted data from the video source.</span></span> <span data-ttu-id="04a28-171">Декодер расшифровывает этот поток.</span><span class="sxs-lookup"><span data-stu-id="04a28-171">The decoder decrypts this stream.</span></span>
2.  <span data-ttu-id="04a28-172">Программный декодер согласовывает сеансовый ключ с сеансом шифрования.</span><span class="sxs-lookup"><span data-stu-id="04a28-172">The software decoder negotiates a session key with the cryptographic session.</span></span>
3.  <span data-ttu-id="04a28-173">Программный декодер использует прошедший проверку подлинности канал для связи криптографического сеанса с устройством декодера.</span><span class="sxs-lookup"><span data-stu-id="04a28-173">The software decoder uses the authenticated channel to associate the cryptographic session with the decoder device.</span></span>
4.  <span data-ttu-id="04a28-174">Программный декодер помещает сжатые данные в буферы, которые он получает с устройства декодера (Accelerator).</span><span class="sxs-lookup"><span data-stu-id="04a28-174">The software decoder puts compressed data in buffers that it gets from the decoder device (accelerator).</span></span> <span data-ttu-id="04a28-175">Для защищенного содержимого кодировщик шифрует данные, помещенные в буферы, используя ключ сеанса для шифрования.</span><span class="sxs-lookup"><span data-stu-id="04a28-175">For protected content, the software encoder encrypts the data that is puts into the buffers, using the session key for the encryption.</span></span>
    > [!Note]  
    > <span data-ttu-id="04a28-176">Некоторые драйверы используют ключ содержимого вместо ключа сеанса для шифрования.</span><span class="sxs-lookup"><span data-stu-id="04a28-176">Some drivers use a content key, instead of the session key, for encryption.</span></span> <span data-ttu-id="04a28-177">Ключ содержимого может меняться от одного кадра к другому.</span><span class="sxs-lookup"><span data-stu-id="04a28-177">The content key could change from one frame to the next.</span></span>

     

5.  <span data-ttu-id="04a28-178">Декодер отправляет зашифрованные сжатые буферы в ускоритель.</span><span class="sxs-lookup"><span data-stu-id="04a28-178">The decoder submits the encrypted compressed buffers to the accelerator.</span></span> <span data-ttu-id="04a28-179">Для алгоритма AES-Ctrl декодер также передает вектор инициализации.</span><span class="sxs-lookup"><span data-stu-id="04a28-179">For AES-CTR, the decoder also passes the initialization vector.</span></span> <span data-ttu-id="04a28-180">Если используется ключ содержимого, декодер передает ключ содержимого, зашифрованный с помощью ключа сеанса.</span><span class="sxs-lookup"><span data-stu-id="04a28-180">If a content key is used, the decoder passes the content key, encrypted using the session key.</span></span>

<span data-ttu-id="04a28-181">Direct3D11 имеет стандартную поддержку для 128-разрядного AES-ориентированного, но он предназначен для расширения дополнительных типов шифрования.</span><span class="sxs-lookup"><span data-stu-id="04a28-181">Direct3D11 has standard support for 128-bit AES-CTR, but is designed to extend to additional encryption types.</span></span>

<span data-ttu-id="04a28-182">Следующие пять разделов содержат более подробные инструкции.</span><span class="sxs-lookup"><span data-stu-id="04a28-182">The next five sections give more detailed steps.</span></span>

-   [<span data-ttu-id="04a28-183">1. запросите Защита содержимого возможности драйвера.</span><span class="sxs-lookup"><span data-stu-id="04a28-183">1. Query the Content Protection Capabilities of the Driver</span></span>](#1-query-the-content-protection-capabilities-of-the-driver)
-   [<span data-ttu-id="04a28-184">2. Настройка канала, прошедшего проверку подлинности</span><span class="sxs-lookup"><span data-stu-id="04a28-184">2. Configure the Authenticated Channel</span></span>](#2-configure-the-authenticated-channel)
-   [<span data-ttu-id="04a28-185">3. Настройка сеанса шифрования</span><span class="sxs-lookup"><span data-stu-id="04a28-185">3. Configure the Cryptographic Session</span></span>](#3-configure-the-cryptographic-session)
-   [<span data-ttu-id="04a28-186">4. Связывание декодера с криптографическим сеансом</span><span class="sxs-lookup"><span data-stu-id="04a28-186">4. Associate the decoder with the Cryptographic Session</span></span>](#4-associate-the-decoder-with-the-cryptographic-session)

### <a name="1-query-the-content-protection-capabilities-of-the-driver"></a><span data-ttu-id="04a28-187">1. запросите Защита содержимого возможности драйвера.</span><span class="sxs-lookup"><span data-stu-id="04a28-187">1. Query the Content Protection Capabilities of the Driver</span></span>

<span data-ttu-id="04a28-188">Прежде чем пытаться применить шифрование, получите возможности защиты содержимого драйвера.</span><span class="sxs-lookup"><span data-stu-id="04a28-188">Before attempting to apply encryption, get the content protection capabilities of the driver.</span></span>

1.  <span data-ttu-id="04a28-189">Получает указатель на интерфейс ID3D11Device.</span><span class="sxs-lookup"><span data-stu-id="04a28-189">Get a pointer to the ID3D11Device interface.</span></span>
2.  <span data-ttu-id="04a28-190">Вызовите [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) для интерфейса [**ID3D11VideoDevice**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodevice) .</span><span class="sxs-lookup"><span data-stu-id="04a28-190">Call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) for the [**ID3D11VideoDevice**](/windows/desktop/api/d3d11/nn-d3d11-id3d11videodevice) interface.</span></span>
3.  <span data-ttu-id="04a28-191">Вызовите [**ID3D11VideoDevice:: жетконтентпротектионкапс**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getcontentprotectioncaps).</span><span class="sxs-lookup"><span data-stu-id="04a28-191">Call [**ID3D11VideoDevice::GetContentProtectionCaps**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-getcontentprotectioncaps).</span></span> <span data-ttu-id="04a28-192">Этот метод заполняет структуру [**D3D11_VIDEO_CONTENT_PROTECTION_CAPS**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_video_content_protection_caps) с помощью возможностей защиты содержимого драйвера.</span><span class="sxs-lookup"><span data-stu-id="04a28-192">This method fills in a [**D3D11_VIDEO_CONTENT_PROTECTION_CAPS**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_video_content_protection_caps) structure with the driver’s content protection capabilities.</span></span>

<span data-ttu-id="04a28-193">В частности, найдите следующие возможности:</span><span class="sxs-lookup"><span data-stu-id="04a28-193">In particular, look for the following capabilities:</span></span>

-   <span data-ttu-id="04a28-194">Если элемент **Caps** содержит флаг **D3D11_CONTENT_PROTECTION_CAPS_SOFTWARE** или **D3D11_CONTENT_PROTECTION_CAPS_HARDWARE** , драйвер может выполнять шифрование.</span><span class="sxs-lookup"><span data-stu-id="04a28-194">If the **Caps** member contains the **D3D11_CONTENT_PROTECTION_CAPS_SOFTWARE** or **D3D11_CONTENT_PROTECTION_CAPS_HARDWARE** flag, the driver can perform encryption.</span></span>
-   <span data-ttu-id="04a28-195">Если элемент **Caps** содержит флаг **D3D11_CONTENT_PROTECTION_CAPS_CONTENT_KEY** , драйвер использует отдельный ключ содержимого для расшифровки.</span><span class="sxs-lookup"><span data-stu-id="04a28-195">If the **Caps** member contains the **D3D11_CONTENT_PROTECTION_CAPS_CONTENT_KEY** flag, the driver uses a separate content key for decryption.</span></span>
-   <span data-ttu-id="04a28-196">Вызовите [**ID3D11VideoDevice:: чекккриптокэйексчанже**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-checkcryptokeyexchange) , чтобы определить типы обмена ключами, которые драйвер поддерживает для создания ключа сеанса.</span><span class="sxs-lookup"><span data-stu-id="04a28-196">Call [**ID3D11VideoDevice::CheckCryptoKeyExchange**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-checkcryptokeyexchange) to determine which types of key exchanges the driver supports for generating the session key.</span></span>

<span data-ttu-id="04a28-197">Дополнительные возможности указываются в элементе « **Caps** ».</span><span class="sxs-lookup"><span data-stu-id="04a28-197">Additional capabilities are indicated in the **Caps** member.</span></span>

### <a name="2-configure-the-authenticated-channel"></a><span data-ttu-id="04a28-198">2. Настройка канала, прошедшего проверку подлинности</span><span class="sxs-lookup"><span data-stu-id="04a28-198">2. Configure the Authenticated Channel</span></span>

<span data-ttu-id="04a28-199">Следующим шагом является настройка канала, прошедшего проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="04a28-199">The next step is to configure the authenticated channel.</span></span>

1.  <span data-ttu-id="04a28-200">Вызовите [**ID3D11VideoDevice:: креатеаусентикатедчаннел**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createauthenticatedchannel) , чтобы создать канал с проверкой подлинности.</span><span class="sxs-lookup"><span data-stu-id="04a28-200">Call [**ID3D11VideoDevice::CreateAuthenticatedChannel**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createauthenticatedchannel) to create the authenticated channel.</span></span> <span data-ttu-id="04a28-201">Для параметра *чаннелтипе* укажите тип канала, соответствующий возможностям драйвера.</span><span class="sxs-lookup"><span data-stu-id="04a28-201">For the *ChannelType* parameter, specify a channel type that matches the capabilities of the driver.</span></span>
    -   <span data-ttu-id="04a28-202">Тип канала **D3D11_AUTHENTICATED_CHANNEL_DRIVER_SOFTWARE** соответствует **D3D11_CONTENT_PROTECTION_CAPS_SOFTWARE**.</span><span class="sxs-lookup"><span data-stu-id="04a28-202">The **D3D11_AUTHENTICATED_CHANNEL_DRIVER_SOFTWARE** channel type corresponds to **D3D11_CONTENT_PROTECTION_CAPS_SOFTWARE**.</span></span>
    -   <span data-ttu-id="04a28-203">Тип канала **D3D11_AUTHENTICATED_CHANNEL_DRIVER_HARDWARE** соответствует **D3D11_CONTENT_PROTECTION_CAPS_HARDWARE**.</span><span class="sxs-lookup"><span data-stu-id="04a28-203">The **D3D11_AUTHENTICATED_CHANNEL_DRIVER_HARDWARE** channel type corresponds to **D3D11_CONTENT_PROTECTION_CAPS_HARDWARE**.</span></span>

    <span data-ttu-id="04a28-204">Метод **креатеаусентикатедчаннел** возвращает указатель на интерфейс [**ID3D11AuthenticatedChannel**](/windows/desktop/api/d3d11/nn-d3d11-id3d11authenticatedchannel) .</span><span class="sxs-lookup"><span data-stu-id="04a28-204">The **CreateAuthenticatedChannel** method returns a pointer to the [**ID3D11AuthenticatedChannel**](/windows/desktop/api/d3d11/nn-d3d11-id3d11authenticatedchannel) interface.</span></span>
2.  <span data-ttu-id="04a28-205">Вызовите [**ID3D11AuthenticatedChannel:: жетцертификатесизе**](/windows/desktop/api/d3d11/nf-d3d11-id3d11authenticatedchannel-getcertificatesize) , чтобы получить размер сертификата X. 509 драйвера.</span><span class="sxs-lookup"><span data-stu-id="04a28-205">Call [**ID3D11AuthenticatedChannel::GetCertificateSize**](/windows/desktop/api/d3d11/nf-d3d11-id3d11authenticatedchannel-getcertificatesize) to get the size of the driver's X.509 certificate.</span></span> <span data-ttu-id="04a28-206">Выделение буфера требуемого размера.</span><span class="sxs-lookup"><span data-stu-id="04a28-206">Allocate a buffer of the required size.</span></span>
3.  <span data-ttu-id="04a28-207">Вызовите [**ID3D11AuthenticatedChannel:: Certificate**](/windows/desktop/api/d3d11/nf-d3d11-id3d11authenticatedchannel-getcertificate) , чтобы получить сертификат.</span><span class="sxs-lookup"><span data-stu-id="04a28-207">Call [**ID3D11AuthenticatedChannel::GetCertificate**](/windows/desktop/api/d3d11/nf-d3d11-id3d11authenticatedchannel-getcertificate) to get the certificate.</span></span> <span data-ttu-id="04a28-208">Метод копирует сертификат в буфер, который был выделен на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="04a28-208">The method copies the certificate into the buffer that was allocated in the previous step.</span></span>
4.  <span data-ttu-id="04a28-209">Убедитесь, что сертификат драйвера был подписан корпорацией Майкрософт и не был отозван.</span><span class="sxs-lookup"><span data-stu-id="04a28-209">Verify that the driver’s certificate was signed by Microsoft and has not been revoked.</span></span>
5.  <span data-ttu-id="04a28-210">Получите открытый ключ из сертификата.</span><span class="sxs-lookup"><span data-stu-id="04a28-210">Get the public key from the certificate.</span></span>
6.  <span data-ttu-id="04a28-211">Создание случайного ключа сеанса RSA.</span><span class="sxs-lookup"><span data-stu-id="04a28-211">Generate a random RSA session key.</span></span> <span data-ttu-id="04a28-212">Этот ключ сеанса используется для подписывания данных, отправляемых в канал, прошедший проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="04a28-212">This session key is used to sign data that is sent to the authenticated channel.</span></span> <span data-ttu-id="04a28-213">Зашифруйте сеансовый ключ с помощью открытого ключа драйвера.</span><span class="sxs-lookup"><span data-stu-id="04a28-213">Encrypt the session key using the driver's public key.</span></span>
7.  <span data-ttu-id="04a28-214">Вызовите метод [**ID3D11VideoContext:: неготиатеаусентикатедчаннелкэйексчанже**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-negotiateauthenticatedchannelkeyexchange) , чтобы отправить зашифрованный ключ сеанса драйверу.</span><span class="sxs-lookup"><span data-stu-id="04a28-214">Call [**ID3D11VideoContext::NegotiateAuthenticatedChannelKeyExchange**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-negotiateauthenticatedchannelkeyexchange) to send the encrypted session key to the driver.</span></span>
8.  <span data-ttu-id="04a28-215">Инициализируйте безопасный канал следующим образом:</span><span class="sxs-lookup"><span data-stu-id="04a28-215">Initialize the secure channel as follows:</span></span>
    1.  <span data-ttu-id="04a28-216">Заполните структуру [**D3D11_AUTHENTICATED_CONFIGURE_INITIALIZE_INPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_initialize_input) , как описано в документации.</span><span class="sxs-lookup"><span data-stu-id="04a28-216">Fill in a [**D3D11_AUTHENTICATED_CONFIGURE_INITIALIZE_INPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_initialize_input) structure as described in the documentation.</span></span>
    2.  <span data-ttu-id="04a28-217">Отправьте команду [**D3D11_AUTHENTICATED_CONFIGURE_INITIALIZE_INPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_initialize_input) , вызвав [**ID3D11VideoContext:: конфигуреаусентикатедчаннел**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-configureauthenticatedchannel) , как описано в разделе [Отправка команд, прошедших проверку подлинности канала](#sending-authenticated-channel-commands).</span><span class="sxs-lookup"><span data-stu-id="04a28-217">Send the [**D3D11_AUTHENTICATED_CONFIGURE_INITIALIZE_INPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_initialize_input) command by calling [**ID3D11VideoContext::ConfigureAuthenticatedChannel**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-configureauthenticatedchannel) as described in the section [Sending Authenticated Channel Commands](#sending-authenticated-channel-commands).</span></span> <span data-ttu-id="04a28-218">Эта команда содержит начальные порядковые номера для команд и запросов, отправляемых в канал, прошедший проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="04a28-218">This command contains the starting sequence numbers for the commands and queries that are sent to the authenticated channel.</span></span>
9.  <span data-ttu-id="04a28-219">Проверьте тип канала, отправив запрос [**D3D11_AUTHENTICATED_QUERY_CHANNEL_TYPE**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_query_channel_type_output) в канал, прошедший проверку подлинности, как описано в разделе [Отправка запросов с проверкой подлинности](#sending-authenticated-channel-queries).</span><span class="sxs-lookup"><span data-stu-id="04a28-219">Verify the channel type by sending a [**D3D11_AUTHENTICATED_QUERY_CHANNEL_TYPE**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_query_channel_type_output) query to the authenticated channel, as described in the section [Sending Authenticated Channel Queries](#sending-authenticated-channel-queries).</span></span> <span data-ttu-id="04a28-220">Убедитесь, что тип канала соответствует тому, что вы указали в методе [**креатеаусентикатедчаннел**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) .</span><span class="sxs-lookup"><span data-stu-id="04a28-220">Check that the channel type matches what you specified in the [**CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) method.</span></span>

### <a name="3-configure-the-cryptographic-session"></a><span data-ttu-id="04a28-221">3. Настройка сеанса шифрования</span><span class="sxs-lookup"><span data-stu-id="04a28-221">3. Configure the Cryptographic Session</span></span>

<span data-ttu-id="04a28-222">Затем настройте сеанс шифрования и установите ключ сеанса.</span><span class="sxs-lookup"><span data-stu-id="04a28-222">Next, configure the cryptographic session and establish the session key.</span></span>

1.  <span data-ttu-id="04a28-223">Вызовите [**ID3D11VideoDevice:: креатекриптосессион**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createcryptosession) , чтобы создать сеанс шифрования.</span><span class="sxs-lookup"><span data-stu-id="04a28-223">Call [**ID3D11VideoDevice::CreateCryptoSession**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodevice-createcryptosession) to create the cryptographic session.</span></span> <span data-ttu-id="04a28-224">Этот метод возвращает указатель на интерфейс [**ID3D11CryptoSession**](/windows/desktop/api/d3d11/nn-d3d11-id3d11cryptosession) .</span><span class="sxs-lookup"><span data-stu-id="04a28-224">This method returns a pointer to the [**ID3D11CryptoSession**](/windows/desktop/api/d3d11/nn-d3d11-id3d11cryptosession) interface.</span></span>
2.  <span data-ttu-id="04a28-225">Вызовите [**ID3D11CryptoSession:: жетцертификатесизе**](/windows/desktop/api/d3d11/nf-d3d11-id3d11cryptosession-getcertificatesize) , чтобы получить размер сертификата X. 509 драйвера.</span><span class="sxs-lookup"><span data-stu-id="04a28-225">Call [**ID3D11CryptoSession::GetCertificateSize**](/windows/desktop/api/d3d11/nf-d3d11-id3d11cryptosession-getcertificatesize) to get the size of the driver's X.509 certificate.</span></span> <span data-ttu-id="04a28-226">Выделение буфера требуемого размера.</span><span class="sxs-lookup"><span data-stu-id="04a28-226">Allocate a buffer of the required size.</span></span>
3.  <span data-ttu-id="04a28-227">Вызовите [**ID3D11CryptoSession:: Certificate**](/windows/desktop/api/d3d11/nf-d3d11-id3d11cryptosession-getcertificate) , чтобы получить сертификат.</span><span class="sxs-lookup"><span data-stu-id="04a28-227">Call [**ID3D11CryptoSession::GetCertificate**](/windows/desktop/api/d3d11/nf-d3d11-id3d11cryptosession-getcertificate) to get the certificate.</span></span> <span data-ttu-id="04a28-228">Метод копирует сертификат в буфер, который был выделен на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="04a28-228">The method copies the certificate into the buffer that was allocated in the previous step.</span></span>
4.  <span data-ttu-id="04a28-229">Убедитесь, что сертификат драйвера был подписан корпорацией Майкрософт и не был отозван.</span><span class="sxs-lookup"><span data-stu-id="04a28-229">Verify that the driver’s certificate was signed by Microsoft and has not been revoked.</span></span>
5.  <span data-ttu-id="04a28-230">Получите открытый ключ из сертификата.</span><span class="sxs-lookup"><span data-stu-id="04a28-230">Get the public key from the certificate.</span></span>
6.  <span data-ttu-id="04a28-231">Создание случайного ключа сеанса RSA.</span><span class="sxs-lookup"><span data-stu-id="04a28-231">Generate a random RSA session key.</span></span> <span data-ttu-id="04a28-232">Это отдельный сеансовый ключ из ключа сеанса прошедшего проверку подлинности канала.</span><span class="sxs-lookup"><span data-stu-id="04a28-232">This is a separate session key from the authenticated channel session key.</span></span> <span data-ttu-id="04a28-233">Зашифруйте сеансовый ключ с помощью открытого ключа драйвера.</span><span class="sxs-lookup"><span data-stu-id="04a28-233">Encrypt the session key using the driver's public key.</span></span>
7.  <span data-ttu-id="04a28-234">Вызовите метод [**ID3D11VideoContext:: неготиатекриптосессионкэйексчанже**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-negotiatecryptosessionkeyexchange) , чтобы отправить зашифрованный ключ сеанса драйверу.</span><span class="sxs-lookup"><span data-stu-id="04a28-234">Call [**ID3D11VideoContext::NegotiateCryptoSessionKeyExchange**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-negotiatecryptosessionkeyexchange) to send the encrypted session key to the driver.</span></span>
8.  <span data-ttu-id="04a28-235">Если возможности защиты содержимого включают **3D11_CONTENT_PROTECTION_CAPS_CONTENT_KEY**, создайте случайный ключ содержимого RSA.</span><span class="sxs-lookup"><span data-stu-id="04a28-235">If the content protection capabilities include **3D11_CONTENT_PROTECTION_CAPS_CONTENT_KEY**, create a random RSA content key.</span></span> <span data-ttu-id="04a28-236">Он будет использоваться позже в процессе декодирования.</span><span class="sxs-lookup"><span data-stu-id="04a28-236">This will be used later in the decoding process.</span></span>

### <a name="4-associate-the-decoder-with-the-cryptographic-session"></a><span data-ttu-id="04a28-237">4. Связывание декодера с криптографическим сеансом</span><span class="sxs-lookup"><span data-stu-id="04a28-237">4. Associate the decoder with the Cryptographic Session</span></span>

<span data-ttu-id="04a28-238">Затем свяжите устройство декодера с устройством Direct3D11 и сеансом шифрования следующим образом:</span><span class="sxs-lookup"><span data-stu-id="04a28-238">Next, associate the decoder device with the Direct3D11 device and the cryptographic session, as follows:</span></span>

1.  <span data-ttu-id="04a28-239">Получите маркер устройства Direct3D11, отправив запрос [**D3D11_AUTHENTICATED_QUERY_DEVICE_HANDLE**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_query_device_handle_output) в канал, прошедший проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="04a28-239">Get a handle to the Direct3D11 device, by sending a [**D3D11_AUTHENTICATED_QUERY_DEVICE_HANDLE**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_query_device_handle_output) query to the authenticated channel.</span></span>
2.  <span data-ttu-id="04a28-240">Заполните структуру [**D3D11_AUTHENTICATED_CONFIGURE_CRYPTO_SESSION_INPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_crypto_session_input) следующими сведениями:</span><span class="sxs-lookup"><span data-stu-id="04a28-240">Fill in a [**D3D11_AUTHENTICATED_CONFIGURE_CRYPTO_SESSION_INPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_crypto_session_input) structure with the following information:</span></span>
    -   <span data-ttu-id="04a28-241">Задайте для элемента **декодехандле** маркер, возвращенный из [**ID3D11VideoDecoder:: жетдриверхандле**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodecoder-getdriverhandle).</span><span class="sxs-lookup"><span data-stu-id="04a28-241">Set the **DecodeHandle** member to the handle returned from [**ID3D11VideoDecoder::GetDriverHandle**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videodecoder-getdriverhandle).</span></span>
    -   <span data-ttu-id="04a28-242">Задайте для элемента **криптосессионхандле** маркер, возвращенный из [**ID3D11CryptoSession:: жеткриптосессионхандле**](/windows/desktop/api/d3d11/nf-d3d11-id3d11cryptosession-getcryptosessionhandle).</span><span class="sxs-lookup"><span data-stu-id="04a28-242">Set the **CryptoSessionHandle** member to the handle returned from [**ID3D11CryptoSession::GetCryptoSessionHandle**](/windows/desktop/api/d3d11/nf-d3d11-id3d11cryptosession-getcryptosessionhandle).</span></span>
    -   <span data-ttu-id="04a28-243">Установите для элемента **девицехандле** маркер устройства Direct3D11.</span><span class="sxs-lookup"><span data-stu-id="04a28-243">Set the **DeviceHandle** member to the Direct3D11 device handle.</span></span>
3.  <span data-ttu-id="04a28-244">Вызовите [**ID3D11VideoContext:: конфигуреаусентикатедчаннел**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-configureauthenticatedchannel) , чтобы отправить команду [**D3D11_AUTHENTICATED_CONFIGURE_CRYPTO_SESSION**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_crypto_session_input) в канал, прошедший проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="04a28-244">Call [**ID3D11VideoContext::ConfigureAuthenticatedChannel**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-configureauthenticatedchannel) to send a [**D3D11_AUTHENTICATED_CONFIGURE_CRYPTO_SESSION**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_crypto_session_input) command to the authenticated channel.</span></span>

<span data-ttu-id="04a28-245">На следующей схеме показан обмен дескрипторами:</span><span class="sxs-lookup"><span data-stu-id="04a28-245">The following diagram illustrates the exchange of handles:</span></span>

![Схема, показывающая, как декодер дксва связан с сеансом шифрования.](images/d3d9video03.png)

<span data-ttu-id="04a28-247">Теперь программный декодер может использовать криптографический ключ сеанса для шифрования сжатых буферов видео.</span><span class="sxs-lookup"><span data-stu-id="04a28-247">The software decoder can now use the cryptographic session key to encrypt the compressed video buffers.</span></span> <span data-ttu-id="04a28-248">Каждый сжатый буфер будет иметь собственный вектор инициализации (IV), заданный в элементе **pIV** структуры [**D3D11_VIDEO_DECODER_BUFFER_DESC**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_video_decoder_buffer_desc) .</span><span class="sxs-lookup"><span data-stu-id="04a28-248">Each compressed buffer will have its own initialization vector (IV) specified in the **pIV** member of the [**D3D11_VIDEO_DECODER_BUFFER_DESC**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_video_decoder_buffer_desc) structure.</span></span>

## <a name="sending-authenticated-channel-commands"></a><span data-ttu-id="04a28-249">Отправка команд аутентифицированного канала</span><span class="sxs-lookup"><span data-stu-id="04a28-249">Sending Authenticated Channel Commands</span></span>

<span data-ttu-id="04a28-250">Набор команд определяется для настройки аутентифицированного канала и настройки различных параметров защиты содержимого.</span><span class="sxs-lookup"><span data-stu-id="04a28-250">A set of commands are defined for configuring the authenticated channel and setting various content protections.</span></span> <span data-ttu-id="04a28-251">Список команд см. в разделе [Защита содержимого Commands](content-protection-commands.md).</span><span class="sxs-lookup"><span data-stu-id="04a28-251">For a list of commands, see [Content Protection Commands](content-protection-commands.md).</span></span>

<span data-ttu-id="04a28-252">Чтобы отправить команду в канал, прошедший проверку подлинности, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="04a28-252">To send a command to the authenticated channel, perform the following steps.</span></span>

1.  <span data-ttu-id="04a28-253">Заполните структуру входных данных.</span><span class="sxs-lookup"><span data-stu-id="04a28-253">Fill in the input data structure.</span></span> <span data-ttu-id="04a28-254">Эта структура данных всегда является структурой [**D3D11_AUTHENTICATED_CONFIGURE_INPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_input) , за которой следуют дополнительные поля.</span><span class="sxs-lookup"><span data-stu-id="04a28-254">This data structure is always a [**D3D11_AUTHENTICATED_CONFIGURE_INPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_input) structure followed by additional fields.</span></span> <span data-ttu-id="04a28-255">Заполните структуру **D3D11_AUTHENTICATED_CONFIGURE_INPUT** , как показано в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="04a28-255">Fill in the **D3D11_AUTHENTICATED_CONFIGURE_INPUT** structure as shown in the following table.</span></span>

    <table>
    <colgroup>
    <col style="width: 50%" />
    <col style="width: 50%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th><span data-ttu-id="04a28-256">Член</span><span class="sxs-lookup"><span data-stu-id="04a28-256">Member</span></span></th>
    <th><span data-ttu-id="04a28-257">Описание</span><span class="sxs-lookup"><span data-stu-id="04a28-257">Description</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><span data-ttu-id="04a28-258"><strong>омак</strong></span><span class="sxs-lookup"><span data-stu-id="04a28-258"><strong>omac</strong></span></span></td>
    <td><span data-ttu-id="04a28-259">Пока не пропустите это поле.</span><span class="sxs-lookup"><span data-stu-id="04a28-259">Skip this field for now.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="04a28-260"><strong>конфигуретипе</strong></span><span class="sxs-lookup"><span data-stu-id="04a28-260"><strong>ConfigureType</strong></span></span></td>
    <td><span data-ttu-id="04a28-261">Идентификатор GUID, идентифицирующий команду.</span><span class="sxs-lookup"><span data-stu-id="04a28-261">GUID that identifies the command.</span></span> <span data-ttu-id="04a28-262">Список команд см. в разделе <a href="content-protection-commands.md">Защита содержимого Commands</a>.</span><span class="sxs-lookup"><span data-stu-id="04a28-262">For a list of commands, see <a href="content-protection-commands.md">Content Protection Commands</a>.</span></span></td>
    </tr>
    <tr class="odd">
    <td><span data-ttu-id="04a28-263"><strong>хчаннел</strong></span><span class="sxs-lookup"><span data-stu-id="04a28-263"><strong>hChannel</strong></span></span></td>
    <td><span data-ttu-id="04a28-264">Маркер для аутентифицированного канала.</span><span class="sxs-lookup"><span data-stu-id="04a28-264">The handle to the authenticated channel.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="04a28-265"><strong>SequenceNumber</strong></span><span class="sxs-lookup"><span data-stu-id="04a28-265"><strong>SequenceNumber</strong></span></span></td>
    <td><span data-ttu-id="04a28-266">Порядковый номер.</span><span class="sxs-lookup"><span data-stu-id="04a28-266">The sequence number.</span></span> <span data-ttu-id="04a28-267">Первый порядковый номер задается путем отправки команды <a href="/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_initialize_input"><strong>D3D11_AUTHENTICATED_CONFIGURE_INITIALIZE</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="04a28-267">The first sequence number is specified by sending a <a href="/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_initialize_input"><strong>D3D11_AUTHENTICATED_CONFIGURE_INITIALIZE</strong></a> command.</span></span> <span data-ttu-id="04a28-268">Каждый раз, когда вы отправляете другую команду, увеличивайте это число на 1.</span><span class="sxs-lookup"><span data-stu-id="04a28-268">Each time you send another command, increment this number by 1.</span></span> <span data-ttu-id="04a28-269">Порядковый номер защищается от атак с использованием воспроизведения.</span><span class="sxs-lookup"><span data-stu-id="04a28-269">The sequence number guards against replay attacks.</span></span>
    <blockquote>
    [!Note]<br />
<span data-ttu-id="04a28-270">Используются два отдельных порядковых номера: один для команд и один для запросов.</span><span class="sxs-lookup"><span data-stu-id="04a28-270">Two separate sequence numbers are used, one for commands and one for queries.</span></span>
    </blockquote>
    <br/> <br/></td>
    </tr>
    </tbody>
    </table>

    

     

2.  <span data-ttu-id="04a28-271">Вычислите тег ОМАК для блока данных, который появляется после элемента **ОМАК** входной структуры.</span><span class="sxs-lookup"><span data-stu-id="04a28-271">Calculate the OMAC tag for the block of data that appears after the **omac** member of the input structure.</span></span> <span data-ttu-id="04a28-272">Затем скопируйте значение этого тега в элемент **ОМАК** .</span><span class="sxs-lookup"><span data-stu-id="04a28-272">Then copy this tag value into the **omac** member.</span></span>
3.  <span data-ttu-id="04a28-273">Вызовите [**ID3D11VideoContext:: конфигуреаусентикатедчаннел**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-configureauthenticatedchannel).</span><span class="sxs-lookup"><span data-stu-id="04a28-273">Call [**ID3D11VideoContext::ConfigureAuthenticatedChannel**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-configureauthenticatedchannel).</span></span>
4.  <span data-ttu-id="04a28-274">Драйвер помещает выходные данные команды в структуру [**D3D11_AUTHENTICATED_CONFIGURE_OUTPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_output) .</span><span class="sxs-lookup"><span data-stu-id="04a28-274">The driver places the output from the command in the [**D3D11_AUTHENTICATED_CONFIGURE_OUTPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_output) structure.</span></span>
5.  <span data-ttu-id="04a28-275">Вычислите тег ОМАК для блока данных, который отображается после элемента **ОМАК** в выходной структуре.</span><span class="sxs-lookup"><span data-stu-id="04a28-275">Calculate the OMAC tag for the block of data that appears after the **omac** member of the output structure.</span></span> <span data-ttu-id="04a28-276">Сравните это со значением элемента **ОМАК** .</span><span class="sxs-lookup"><span data-stu-id="04a28-276">Compare this with the value of the **omac** member.</span></span> <span data-ttu-id="04a28-277">Завершать с ошибкой, если они не совпадают.</span><span class="sxs-lookup"><span data-stu-id="04a28-277">Fail if they do not match.</span></span>
6.  <span data-ttu-id="04a28-278">Сравните значения элементов **конфигуретипе**, **хчаннел** и **SequenceNumber** в выходной структуре со значениями для этих элементов.</span><span class="sxs-lookup"><span data-stu-id="04a28-278">Compare the values of the **ConfigureType**, **hChannel**, and **SequenceNumber** members in the output structure against your values for those members.</span></span> <span data-ttu-id="04a28-279">Завершать с ошибкой, если они не совпадают.</span><span class="sxs-lookup"><span data-stu-id="04a28-279">Fail if they do not match.</span></span>
7.  <span data-ttu-id="04a28-280">Увеличение порядкового номера для следующей команды.</span><span class="sxs-lookup"><span data-stu-id="04a28-280">Increment the sequence number for the next command.</span></span>

## <a name="sending-authenticated-channel-queries"></a><span data-ttu-id="04a28-281">Отправка запросов к каналам с проверкой подлинности</span><span class="sxs-lookup"><span data-stu-id="04a28-281">Sending Authenticated Channel Queries</span></span>

<span data-ttu-id="04a28-282">Набор запросов определяется для получения сведений о канале, прошедшем проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="04a28-282">A set of queries are defined for retrieving information about the authenticated channel.</span></span> <span data-ttu-id="04a28-283">Список запросов см. в разделе [запросы защита содержимого](content-protection-queries.md).</span><span class="sxs-lookup"><span data-stu-id="04a28-283">For a list of queries, see [Content Protection Queries](content-protection-queries.md).</span></span>

<span data-ttu-id="04a28-284">Чтобы отправить команду в канал, прошедший проверку подлинности, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="04a28-284">To send a command to the authenticated channel, perform the following steps.</span></span>

1.  <span data-ttu-id="04a28-285">Заполните структуру входных данных.</span><span class="sxs-lookup"><span data-stu-id="04a28-285">Fill in the input data structure.</span></span> <span data-ttu-id="04a28-286">Эта структура данных всегда является структурой [**D3D11_AUTHENTICATED_QUERY_INPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_query_input) , возможно, за ней следуют дополнительные поля.</span><span class="sxs-lookup"><span data-stu-id="04a28-286">This data structure is always a [**D3D11_AUTHENTICATED_QUERY_INPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_query_input) structure, possibly followed by additional fields.</span></span> <span data-ttu-id="04a28-287">Заполните структуру **D3D11_AUTHENTICATED_QUERY_INPUT** , как показано в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="04a28-287">Fill in the **D3D11_AUTHENTICATED_QUERY_INPUT** structure as shown in the following table.</span></span>

    <table>
    <colgroup>
    <col style="width: 50%" />
    <col style="width: 50%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th><span data-ttu-id="04a28-288">Член</span><span class="sxs-lookup"><span data-stu-id="04a28-288">Member</span></span></th>
    <th><span data-ttu-id="04a28-289">Описание</span><span class="sxs-lookup"><span data-stu-id="04a28-289">Description</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><span data-ttu-id="04a28-290"><strong>QueryType</strong></span><span class="sxs-lookup"><span data-stu-id="04a28-290"><strong>QueryType</strong></span></span></td>
    <td><span data-ttu-id="04a28-291">Идентификатор GUID, определяющий запрос.</span><span class="sxs-lookup"><span data-stu-id="04a28-291">GUID that identifies the query.</span></span> <span data-ttu-id="04a28-292">Список запросов см. в разделе <a href="content-protection-queries.md">запросы защита содержимого</a>.</span><span class="sxs-lookup"><span data-stu-id="04a28-292">For a list of queries, see <a href="content-protection-queries.md">Content Protection Queries</a>.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="04a28-293"><strong>хчаннел</strong></span><span class="sxs-lookup"><span data-stu-id="04a28-293"><strong>hChannel</strong></span></span></td>
    <td><span data-ttu-id="04a28-294">Маркер для аутентифицированного канала.</span><span class="sxs-lookup"><span data-stu-id="04a28-294">The handle to the authenticated channel.</span></span></td>
    </tr>
    <tr class="odd">
    <td><span data-ttu-id="04a28-295"><strong>SequenceNumber</strong></span><span class="sxs-lookup"><span data-stu-id="04a28-295"><strong>SequenceNumber</strong></span></span></td>
    <td><span data-ttu-id="04a28-296">Порядковый номер.</span><span class="sxs-lookup"><span data-stu-id="04a28-296">The sequence number.</span></span> <span data-ttu-id="04a28-297">Первый порядковый номер задается путем отправки команды <a href="/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_initialize_input"><strong>D3D11_AUTHENTICATED_CONFIGURE_INITIALIZE</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="04a28-297">The first sequence number is specified by sending a <a href="/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_configure_initialize_input"><strong>D3D11_AUTHENTICATED_CONFIGURE_INITIALIZE</strong></a> command.</span></span> <span data-ttu-id="04a28-298">Каждый раз, когда вы отправляете другой запрос, увеличивайте это число на 1.</span><span class="sxs-lookup"><span data-stu-id="04a28-298">Each time you send another query, increment this number by 1.</span></span> <span data-ttu-id="04a28-299">Порядковый номер защищается от атак с использованием воспроизведения.</span><span class="sxs-lookup"><span data-stu-id="04a28-299">The sequence number guards against replay attacks.</span></span>
    <blockquote>
    [!Note]<br />
<span data-ttu-id="04a28-300">Используются два отдельных порядковых номера: один для команд и один для запросов.</span><span class="sxs-lookup"><span data-stu-id="04a28-300">Two separate sequence numbers are used, one for commands and one for queries.</span></span>
    </blockquote>
    <br/> <br/></td>
    </tr>
    </tbody>
    </table>

    

     

2.  <span data-ttu-id="04a28-301">Вызовите [**ID3D11VideoContext:: куеряусентикатедчаннел**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-queryauthenticatedchannel).</span><span class="sxs-lookup"><span data-stu-id="04a28-301">Call [**ID3D11VideoContext::QueryAuthenticatedChannel**](/windows/desktop/api/d3d11/nf-d3d11-id3d11videocontext-queryauthenticatedchannel).</span></span>
3.  <span data-ttu-id="04a28-302">Драйвер помещает выходные данные запроса в структуру [**D3D11_AUTHENTICATED_QUERY_OUTPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_query_output) .</span><span class="sxs-lookup"><span data-stu-id="04a28-302">The driver places the output from the query in a [**D3D11_AUTHENTICATED_QUERY_OUTPUT**](/windows/desktop/api/d3d11/ns-d3d11-d3d11_authenticated_query_output) structure.</span></span> <span data-ttu-id="04a28-303">За этой структурой следуют дополнительные поля в зависимости от типа запроса.</span><span class="sxs-lookup"><span data-stu-id="04a28-303">This structure is followed by additional fields, depending on the query type.</span></span>
4.  <span data-ttu-id="04a28-304">Вычислите тег ОМАК для блока данных, который отображается после элемента **ОМАК** в выходной структуре.</span><span class="sxs-lookup"><span data-stu-id="04a28-304">Calculate the OMAC tag for the block of data that appears after the **omac** member of the output structure.</span></span> <span data-ttu-id="04a28-305">Сравните это со значением элемента **ОМАК** .</span><span class="sxs-lookup"><span data-stu-id="04a28-305">Compare this with the value of the **omac** member.</span></span> <span data-ttu-id="04a28-306">Завершать с ошибкой, если они не совпадают.</span><span class="sxs-lookup"><span data-stu-id="04a28-306">Fail if they do not match.</span></span>
5.  <span data-ttu-id="04a28-307">Сравните значения элементов **конфигуретипе**, **хчаннел** и **SequenceNumber** в выходной структуре со значениями для этих элементов.</span><span class="sxs-lookup"><span data-stu-id="04a28-307">Compare the values of the **ConfigureType**, **hChannel**, and **SequenceNumber** members in the output structure against your values for those members.</span></span> <span data-ttu-id="04a28-308">Завершать с ошибкой, если они не совпадают.</span><span class="sxs-lookup"><span data-stu-id="04a28-308">Fail if they do not match.</span></span>
6.  <span data-ttu-id="04a28-309">Увеличение порядкового номера для следующего запроса.</span><span class="sxs-lookup"><span data-stu-id="04a28-309">Increment the sequence number for the next query.</span></span>

## <a name="related-topics"></a><span data-ttu-id="04a28-310">См. также</span><span class="sxs-lookup"><span data-stu-id="04a28-310">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="04a28-311">API-интерфейсы видео Direct3D 11</span><span class="sxs-lookup"><span data-stu-id="04a28-311">Direct3D 11 Video APIs</span></span>](direct3d-11-video-apis.md)
</dt> </dl>

 

 
