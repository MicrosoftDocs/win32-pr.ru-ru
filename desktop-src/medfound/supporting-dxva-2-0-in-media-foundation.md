---
description: Поддержка ДКСВА 2,0 в Media Foundation
ms.assetid: d7330370-adb3-4c6a-962a-7b46c344500c
title: Поддержка ДКСВА 2,0 в Media Foundation
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ce144c24a1aeeda6281ddb423757f3e339903440
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "105664819"
---
# <a name="supporting-dxva-20-in-media-foundation"></a><span data-ttu-id="8cc93-103">Поддержка ДКСВА 2,0 в Media Foundation</span><span class="sxs-lookup"><span data-stu-id="8cc93-103">Supporting DXVA 2.0 in Media Foundation</span></span>

<span data-ttu-id="8cc93-104">В этом разделе описывается, как поддерживать ускорение видео DirectX (ДКСВА) 2,0 в Media Foundation преобразовании (MFT) с помощью Microsoft Direct3D 9, в частности, описывается взаимодействие между декодером и модулем подготовки видео, который исправляется загрузчиком топологии.</span><span class="sxs-lookup"><span data-stu-id="8cc93-104">This topic describes how to support DirectX Video Acceleration (DXVA) 2.0 in a Media Foundation transform (MFT) using Microsoft Direct3D 9 Specifically, it describes the communication between the decoder and the video renderer, which is mediated by the topology loader.</span></span> <span data-ttu-id="8cc93-105">В этом разделе не описывается, как реализовать декодирование ДКСВА.</span><span class="sxs-lookup"><span data-stu-id="8cc93-105">This topic does not describe how to implement DXVA decoding.</span></span>

<span data-ttu-id="8cc93-106">В оставшейся части этого раздела термин *декодера* ОТНОСИТСЯ к MFT декодера, который получает сжатое видео и выводит несжатое видео.</span><span class="sxs-lookup"><span data-stu-id="8cc93-106">In the remainder of this topic, the term *decoder* refers to the decoder MFT, which receives compressed video and outputs uncompressed video.</span></span> <span data-ttu-id="8cc93-107">Термин *устройство декодера* относится к аппаратному ускорителю, реализованному графическим драйвером.</span><span class="sxs-lookup"><span data-stu-id="8cc93-107">The term *decoder device* refers to a hardware video accelerator implemented by the graphics driver.</span></span>

> [!TIP]
> <span data-ttu-id="8cc93-108">Сведения о декодировании видео в Microsoft Direct3D 11 см. [в статье поддержка декодирования видео Direct3D 11 в Media Foundation](supporting-direct3d-11-video-decoding-in-media-foundation.md).</span><span class="sxs-lookup"><span data-stu-id="8cc93-108">For info on Microsoft Direct3D 11 video decoding see, [Supporting Direct3D 11 Video Decoding in Media Foundation](supporting-direct3d-11-video-decoding-in-media-foundation.md).</span></span>

 

> [!Note]  
> <span data-ttu-id="8cc93-109">Приложения для Магазина Windows должны использовать Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="8cc93-109">Windows Store apps must use Direct3D 11.</span></span>

 

<span data-ttu-id="8cc93-110">Ниже приведены основные шаги, которые должен выполнить декодер для поддержки ДКСВА 2,0 в Media Foundation:</span><span class="sxs-lookup"><span data-stu-id="8cc93-110">Here are the basic steps that a decoder must perform to support DXVA 2.0 in Media Foundation:</span></span>

1.  <span data-ttu-id="8cc93-111">Откройте маркер устройства Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="8cc93-111">Open a handle to the Direct3D 9 device.</span></span>
2.  <span data-ttu-id="8cc93-112">Найдите конфигурацию декодера ДКСВА.</span><span class="sxs-lookup"><span data-stu-id="8cc93-112">Find a DXVA decoder configuration.</span></span>
3.  <span data-ttu-id="8cc93-113">Выделение несжатых буферов.</span><span class="sxs-lookup"><span data-stu-id="8cc93-113">Allocate uncompressed Buffers.</span></span>
4.  <span data-ttu-id="8cc93-114">Декодирование кадров.</span><span class="sxs-lookup"><span data-stu-id="8cc93-114">Decode frames.</span></span>

<span data-ttu-id="8cc93-115">Эти действия более подробно описаны в оставшейся части этого раздела.</span><span class="sxs-lookup"><span data-stu-id="8cc93-115">These steps are described in more detail in the remainder of this topic.</span></span>

## <a name="opening-a-direct3d-device-handle"></a><span data-ttu-id="8cc93-116">Открытие обработчика устройства Direct3D</span><span class="sxs-lookup"><span data-stu-id="8cc93-116">Opening a Direct3D Device Handle</span></span>

<span data-ttu-id="8cc93-117">В MFT используется диспетчер устройств Microsoft Direct3D для получения маркера устройства Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="8cc93-117">The MFT uses the Microsoft Direct3D device manager to get a handle to the Direct3D 9 device.</span></span> <span data-ttu-id="8cc93-118">Чтобы открыть маркер устройства, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="8cc93-118">To open the device handle, perform the following steps:</span></span>

1.  <span data-ttu-id="8cc93-119">Предоставьте атрибуту [MF \_ SA с \_ \_ поддержкой D3D](mf-sa-d3d-aware-attribute.md) значение **true**.</span><span class="sxs-lookup"><span data-stu-id="8cc93-119">Expose the [MF\_SA\_D3D\_AWARE](mf-sa-d3d-aware-attribute.md) attribute with the value **TRUE**.</span></span> <span data-ttu-id="8cc93-120">Загрузчик топологии запрашивает этот атрибут путем вызова [**имфтрансформ:: InAttribute**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes).</span><span class="sxs-lookup"><span data-stu-id="8cc93-120">The topology loader queries this attribute by calling [**IMFTransform::GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes).</span></span> <span data-ttu-id="8cc93-121">Присвоение атрибуту значения **true** сообщает загрузчику топологии, что MFT поддерживает дксва.</span><span class="sxs-lookup"><span data-stu-id="8cc93-121">Setting the attribute to **TRUE** notifies the topology loader that the MFT supports DXVA.</span></span>
2.  <span data-ttu-id="8cc93-122">Когда начинается согласование формата, загрузчик топологии вызывает [**имфтрансформ::P роцессмессаже**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) с сообщением из [**таблицы MFT \_ \_ Set D3D Message \_ \_ Manager**](mft-message-set-d3d-manager.md) .</span><span class="sxs-lookup"><span data-stu-id="8cc93-122">When format negotiation begins, the topology loader calls [**IMFTransform::ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message.</span></span> <span data-ttu-id="8cc93-123">Параметр *улпарам* — это указатель **IUnknown** на диспетчер устройств Direct3D модуля подготовки видео.</span><span class="sxs-lookup"><span data-stu-id="8cc93-123">The *ulParam* parameter is an **IUnknown** pointer to the video renderer's Direct3D device manager.</span></span> <span data-ttu-id="8cc93-124">Запросите этот указатель для интерфейса [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) .</span><span class="sxs-lookup"><span data-stu-id="8cc93-124">Query this pointer for the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span>
3.  <span data-ttu-id="8cc93-125">Вызовите [**IDirect3DDeviceManager9:: опендевицехандле**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-opendevicehandle) , чтобы получить маркер устройства Direct3D визуализатора.</span><span class="sxs-lookup"><span data-stu-id="8cc93-125">Call [**IDirect3DDeviceManager9::OpenDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-opendevicehandle) to get a handle to the renderer's Direct3D device.</span></span>
4.  <span data-ttu-id="8cc93-126">Вызовите [**IDirect3DDeviceManager9:: жетвидеосервице**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) и передайте в него маркер устройства.</span><span class="sxs-lookup"><span data-stu-id="8cc93-126">Call [**IDirect3DDeviceManager9::GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) and pass in the device handle.</span></span> <span data-ttu-id="8cc93-127">Этот метод возвращает указатель на интерфейс [**идиректксвидеодекодерсервице**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) .</span><span class="sxs-lookup"><span data-stu-id="8cc93-127">This method returns a pointer to the [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) interface.</span></span>
5.  <span data-ttu-id="8cc93-128">Кэширование указателей и маркера устройства.</span><span class="sxs-lookup"><span data-stu-id="8cc93-128">Cache the pointers and the device handle.</span></span>

## <a name="finding-a-decoder-configuration"></a><span data-ttu-id="8cc93-129">Поиск конфигурации декодера</span><span class="sxs-lookup"><span data-stu-id="8cc93-129">Finding a Decoder Configuration</span></span>

<span data-ttu-id="8cc93-130">MFT должен найти совместимую конфигурацию для устройства декодера ДКСВА.</span><span class="sxs-lookup"><span data-stu-id="8cc93-130">The MFT must find a compatible configuration for the DXVA decoder device.</span></span> <span data-ttu-id="8cc93-131">Выполните следующие действия в методе [**имфтрансформ:: сетинпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) после проверки входного типа:</span><span class="sxs-lookup"><span data-stu-id="8cc93-131">Perform the following steps inside the [**IMFTransform::SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) method, after validating the input type:</span></span>

1.  <span data-ttu-id="8cc93-132">Вызовите [**идиректксвидеодекодерсервице:: жетдекодердевицегуидс**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderdeviceguids).</span><span class="sxs-lookup"><span data-stu-id="8cc93-132">Call [**IDirectXVideoDecoderService::GetDecoderDeviceGuids**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderdeviceguids).</span></span> <span data-ttu-id="8cc93-133">Этот метод возвращает массив идентификаторов GUID устройства декодера.</span><span class="sxs-lookup"><span data-stu-id="8cc93-133">This method returns an array of decoder device GUIDs.</span></span>
2.  <span data-ttu-id="8cc93-134">Пройдите по массиву идентификаторов GUID декодера, чтобы найти те, которые поддерживает декодер.</span><span class="sxs-lookup"><span data-stu-id="8cc93-134">Loop through the array of decoder GUIDs to find the ones that the decoder supports.</span></span> <span data-ttu-id="8cc93-135">Например, для декодера MPEG-2 необходимо найти **DXVA2 \_ ModeMPEG2 \_ мокомп**, **DXVA2 \_ ModeMPEG2 \_ идкт** или **DXVA2 \_ ModeMPEG2 \_ ВЛД**.</span><span class="sxs-lookup"><span data-stu-id="8cc93-135">For example, for an MPEG-2 decoder, you would look for **DXVA2\_ModeMPEG2\_MOCOMP**, **DXVA2\_ModeMPEG2\_IDCT**, or **DXVA2\_ModeMPEG2\_VLD**.</span></span>

3.  <span data-ttu-id="8cc93-136">При обнаружении идентификатора GUID устройства-кандидата передайте GUID в метод [**идиректксвидеодекодерсервице:: жетдекодеррендертаржетс**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderrendertargets) .</span><span class="sxs-lookup"><span data-stu-id="8cc93-136">When you find a candidate decoder device GUID, pass the GUID to the [**IDirectXVideoDecoderService::GetDecoderRenderTargets**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderrendertargets) method.</span></span> <span data-ttu-id="8cc93-137">Этот метод возвращает массив форматов целевого объекта прорисовки, указанных как значения **D3DFORMAT** .</span><span class="sxs-lookup"><span data-stu-id="8cc93-137">This method returns an array of render target formats, specified as **D3DFORMAT** values.</span></span>
4.  <span data-ttu-id="8cc93-138">Пройдите по форматам целевого объекта рендеринга и найдите формат, поддерживаемый декодером.</span><span class="sxs-lookup"><span data-stu-id="8cc93-138">Loop through the render target formats and look for a format supported by the decoder.</span></span>
5.  <span data-ttu-id="8cc93-139">Вызовите [**идиректксвидеодекодерсервице:: жетдекодерконфигуратионс**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderconfigurations).</span><span class="sxs-lookup"><span data-stu-id="8cc93-139">Call [**IDirectXVideoDecoderService::GetDecoderConfigurations**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderconfigurations).</span></span> <span data-ttu-id="8cc93-140">Передайте тот же GUID устройства декодера вместе с структурой [**\_ видеодеск DXVA2**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videodesc) , описывающей предложенный выходной формат.</span><span class="sxs-lookup"><span data-stu-id="8cc93-140">Pass in the same decoder device GUID, along with a [**DXVA2\_VideoDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videodesc) structure that describes the proposed output format.</span></span> <span data-ttu-id="8cc93-141">Метод возвращает массив структур [**DXVA2 \_ конфигпиктуредекоде**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_configpicturedecode) .</span><span class="sxs-lookup"><span data-stu-id="8cc93-141">The method returns an array of [**DXVA2\_ConfigPictureDecode**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_configpicturedecode) structures.</span></span> <span data-ttu-id="8cc93-142">Каждая структура описывает одну возможную конфигурацию для устройства декодера.</span><span class="sxs-lookup"><span data-stu-id="8cc93-142">Each structure describes one possible configuration for the decoder device.</span></span> <span data-ttu-id="8cc93-143">Найдите конфигурацию, которую поддерживает декодер.</span><span class="sxs-lookup"><span data-stu-id="8cc93-143">Look for a configuration that the decoder supports.</span></span>
6.  <span data-ttu-id="8cc93-144">Сохраните формат целевого объекта прорисовки и конфигурацию.</span><span class="sxs-lookup"><span data-stu-id="8cc93-144">Store the render target format and configuration.</span></span>

<span data-ttu-id="8cc93-145">В методе [**имфтрансформ:: жетаутпутаваилаблетипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) возвращает несжатый видеоформат на основе предполагаемого формата целевого объекта прорисовки.</span><span class="sxs-lookup"><span data-stu-id="8cc93-145">In the [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) method, return an uncompressed video format, based on the proposed render target format.</span></span>

<span data-ttu-id="8cc93-146">В методе [**имфтрансформ:: сетаутпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) Проверьте тип носителя в соответствии с форматом целевого объекта прорисовки.</span><span class="sxs-lookup"><span data-stu-id="8cc93-146">In the [**IMFTransform::SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) method, check the media type against the render target format.</span></span>

### <a name="fallback-to-software-decoding"></a><span data-ttu-id="8cc93-147">Откат к декодированию программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="8cc93-147">Fallback to Software Decoding</span></span>

<span data-ttu-id="8cc93-148">Если MFT не удается найти конфигурацию ДКСВА (например, если графический драйвер не имеет нужных возможностей), он должен вернуть код ошибки **MF \_ E \_ неподдерживаемый \_ \_ тип D3D** из методов [**сетинпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) и [**сетаутпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) .</span><span class="sxs-lookup"><span data-stu-id="8cc93-148">If the MFT cannot find a DXVA configuration (for example, if the graphics driver does not have the right capabilities), it should return the error code **MF\_E\_UNSUPPORTED\_D3D\_TYPE** from the [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) and [**SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) methods.</span></span> <span data-ttu-id="8cc93-149">Загрузчик топологии будет отвечать, отправляя сообщение [**MFT \_ \_ \_ \_ диспетчера D3D**](mft-message-set-d3d-manager.md) в виде значения **null** для параметра *улпарам* .</span><span class="sxs-lookup"><span data-stu-id="8cc93-149">The topology loader will respond by sending the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message with the value **NULL** for the *ulParam* parameter.</span></span> <span data-ttu-id="8cc93-150">Таблица MFT должна освободить указатель на интерфейс [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) .</span><span class="sxs-lookup"><span data-stu-id="8cc93-150">The MFT should release its pointer to the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span> <span data-ttu-id="8cc93-151">Затем загрузчик топологии повторно согласовывает тип носителя, и MFT может использовать программное декодирование.</span><span class="sxs-lookup"><span data-stu-id="8cc93-151">The topology loader will then renegotiate the media type, and the MFT can use software decoding.</span></span>

## <a name="allocating-uncompressed-buffers"></a><span data-ttu-id="8cc93-152">Выделение несжатых буферов</span><span class="sxs-lookup"><span data-stu-id="8cc93-152">Allocating Uncompressed Buffers</span></span>

<span data-ttu-id="8cc93-153">В ДКСВА 2,0 декодер отвечает за выделение поверхностей Direct3D для использования в качестве несжатых буферов видео.</span><span class="sxs-lookup"><span data-stu-id="8cc93-153">In DXVA 2.0, the decoder is responsible for allocating Direct3D surfaces to use as uncompressed video buffers.</span></span> <span data-ttu-id="8cc93-154">Декодер должен выделить 3 поверхности, чтобы Евр использовать для дечередования.</span><span class="sxs-lookup"><span data-stu-id="8cc93-154">The decoder should allocate 3 surfaces for the EVR to use for deinterlacing.</span></span> <span data-ttu-id="8cc93-155">Это число является фиксированным, так как Media Foundation не дает возможности Евр указать, сколько поверхностей графический драйвер требует для дечередования.</span><span class="sxs-lookup"><span data-stu-id="8cc93-155">This number is fixed, because Media Foundation does not provide a way for the EVR to specify how many surfaces the graphics driver requires for deinterlacing.</span></span> <span data-ttu-id="8cc93-156">Для любого драйвера должен быть достаточно трех поверхностей.</span><span class="sxs-lookup"><span data-stu-id="8cc93-156">Three surfaces should be sufficient for any driver.</span></span>

<span data-ttu-id="8cc93-157">В методе [**имфтрансформ:: жетаутпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) Задайте флаг **\_ \_ \_ \_ Samples в выходной поток** MFT в структуре [**\_ \_ \_ сведений потока вывода MFT**](/windows/desktop/api/mftransform/ns-mftransform-mft_output_stream_info) .</span><span class="sxs-lookup"><span data-stu-id="8cc93-157">In the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method, set the **MFT\_OUTPUT\_STREAM\_PROVIDES\_SAMPLES** flag in the [**MFT\_OUTPUT\_STREAM\_INFO**](/windows/desktop/api/mftransform/ns-mftransform-mft_output_stream_info) structure.</span></span> <span data-ttu-id="8cc93-158">Этот флаг уведомляет сеанс мультимедиа о том, что MFT выделяет свои собственные выходные примеры.</span><span class="sxs-lookup"><span data-stu-id="8cc93-158">This flag notifies the Media Session that the MFT allocates its own output samples.</span></span>

<span data-ttu-id="8cc93-159">Чтобы создать поверхности, вызовите метод [**идиректксвидеоакцелератионсервице:: креатесурфаце**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoaccelerationservice-createsurface).</span><span class="sxs-lookup"><span data-stu-id="8cc93-159">To create the surfaces, call [**IDirectXVideoAccelerationService::CreateSurface**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoaccelerationservice-createsurface).</span></span> <span data-ttu-id="8cc93-160">(Интерфейс [**идиректксвидеодекодерсервице**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) наследует этот метод от [**идиректксвидеоакцелератионсервице**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoaccelerationservice).) Это можно сделать в [**сетинпуттипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype)после поиска формата целевого объекта прорисовки.</span><span class="sxs-lookup"><span data-stu-id="8cc93-160">(The [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) interface inherits this method from [**IDirectXVideoAccelerationService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoaccelerationservice).) You can do this in [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype), after finding the render target format.</span></span>

<span data-ttu-id="8cc93-161">Для каждой поверхности вызовите [**мфкреатевидеосамплефромсурфаце**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) , чтобы создать пример мультимедиа для размещения поверхности.</span><span class="sxs-lookup"><span data-stu-id="8cc93-161">For each surface, call [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) to create a media sample to hold the surface.</span></span> <span data-ttu-id="8cc93-162">Метод возвращает указатель на интерфейс [**имфсампле**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) .</span><span class="sxs-lookup"><span data-stu-id="8cc93-162">The method returns a pointer to the [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) interface.</span></span>

## <a name="decoding"></a><span data-ttu-id="8cc93-163">Декодирование</span><span class="sxs-lookup"><span data-stu-id="8cc93-163">Decoding</span></span>

<span data-ttu-id="8cc93-164">Чтобы создать устройство декодера, вызовите метод [**идиректксвидеодекодерсервице:: креатевидеодекодер**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="8cc93-164">To create the decoder device, call [**IDirectXVideoDecoderService::CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span></span> <span data-ttu-id="8cc93-165">Метод возвращает указатель на интерфейс [**идиректксвидеодекодер**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) устройства декодера.</span><span class="sxs-lookup"><span data-stu-id="8cc93-165">The method returns a pointer to the [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) interface of the decoder device.</span></span>

<span data-ttu-id="8cc93-166">Декодирование должно происходить внутри метода [**имфтрансформ::P роцессаутпут**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) .</span><span class="sxs-lookup"><span data-stu-id="8cc93-166">Decoding should occur inside the [**IMFTransform::ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) method.</span></span> <span data-ttu-id="8cc93-167">Для проверки маркера устройства в каждом кадре вызовите [**IDirect3DDeviceManager9:: тестдевице**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-testdevice) .</span><span class="sxs-lookup"><span data-stu-id="8cc93-167">On each frame, call [**IDirect3DDeviceManager9::TestDevice**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-testdevice) to test the device handle.</span></span> <span data-ttu-id="8cc93-168">Если устройство изменилось, метод возвращает **DXVA2 \_ E \_ новое \_ видео \_ устройство**.</span><span class="sxs-lookup"><span data-stu-id="8cc93-168">If the device has changed, the method returns **DXVA2\_E\_NEW\_VIDEO\_DEVICE**.</span></span> <span data-ttu-id="8cc93-169">Если это происходит, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="8cc93-169">If this occurs, do the following:</span></span>

1.  <span data-ttu-id="8cc93-170">Закройте обработчик устройства, вызвав [**IDirect3DDeviceManager9:: клоседевицехандле**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-closedevicehandle).</span><span class="sxs-lookup"><span data-stu-id="8cc93-170">Close the device handle by calling [**IDirect3DDeviceManager9::CloseDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-closedevicehandle).</span></span>
2.  <span data-ttu-id="8cc93-171">Освободите указатели [**идиректксвидеодекодерсервице**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) и [**идиректксвидеодекодер**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) .</span><span class="sxs-lookup"><span data-stu-id="8cc93-171">Release the [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) and [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) pointers.</span></span>
3.  <span data-ttu-id="8cc93-172">Откройте новый маркер устройства.</span><span class="sxs-lookup"><span data-stu-id="8cc93-172">Open a new device handle.</span></span>
4.  <span data-ttu-id="8cc93-173">Согласование новой конфигурации декодера, как описано в разделе "Поиск конфигурации декодера" выше на этой странице.</span><span class="sxs-lookup"><span data-stu-id="8cc93-173">Negotiate a new decoder configuration, as described in "Finding a Decoder Configuration" earlier on this page.</span></span>
5.  <span data-ttu-id="8cc93-174">Создайте новое устройство декодера.</span><span class="sxs-lookup"><span data-stu-id="8cc93-174">Create a new decoder device.</span></span>

<span data-ttu-id="8cc93-175">Предполагая, что маркер устройства является допустимым, процесс декодирования работает следующим образом:</span><span class="sxs-lookup"><span data-stu-id="8cc93-175">Assuming that the device handle is valid, the decoding process works as follows:</span></span>

1.  <span data-ttu-id="8cc93-176">Получить доступную поверхность, которая сейчас не используется.</span><span class="sxs-lookup"><span data-stu-id="8cc93-176">Get an available surface that is not currently in use.</span></span> <span data-ttu-id="8cc93-177">(Изначально доступны все поверхности.)</span><span class="sxs-lookup"><span data-stu-id="8cc93-177">(Initially all of the surfaces are available.)</span></span>
2.  <span data-ttu-id="8cc93-178">Запросите пример носителя для интерфейса [**имфтраккедсампле**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) .</span><span class="sxs-lookup"><span data-stu-id="8cc93-178">Query the media sample for the [**IMFTrackedSample**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) interface.</span></span>
3.  <span data-ttu-id="8cc93-179">Вызовите метод [**имфтраккедсампле:: сеталлокатор**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) и укажите указатель на интерфейс [**имфасинккаллбакк**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) , реализованный декодером.</span><span class="sxs-lookup"><span data-stu-id="8cc93-179">Call [**IMFTrackedSample::SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) and provide a pointer to the [**IMFAsyncCallback**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) interface, implemented by the decoder.</span></span> <span data-ttu-id="8cc93-180">Когда модуль подготовки видео освобождает пример, будет вызван обратный вызов декодера.</span><span class="sxs-lookup"><span data-stu-id="8cc93-180">When the video renderer releases the sample, the decoder's callback will be invoked.</span></span>
4.  <span data-ttu-id="8cc93-181">Вызовите [**идиректксвидеодекодер:: бегинфраме**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe).</span><span class="sxs-lookup"><span data-stu-id="8cc93-181">Call [**IDirectXVideoDecoder::BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe).</span></span>
5.  <span data-ttu-id="8cc93-182">Сделайте следующее или несколько раз:</span><span class="sxs-lookup"><span data-stu-id="8cc93-182">Do the following one or more times:</span></span>
    1.  <span data-ttu-id="8cc93-183">Вызовите [**идиректксвидеодекодер::-buffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) , чтобы получить буфер декодера дксва.</span><span class="sxs-lookup"><span data-stu-id="8cc93-183">Call [**IDirectXVideoDecoder::GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) to get a DXVA decoder buffer.</span></span>
    2.  <span data-ttu-id="8cc93-184">Заполните буфер.</span><span class="sxs-lookup"><span data-stu-id="8cc93-184">Fill the buffer.</span></span>
    3.  <span data-ttu-id="8cc93-185">Вызовите [**идиректксвидеодекодер:: релеасебуффер**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-releasebuffer).</span><span class="sxs-lookup"><span data-stu-id="8cc93-185">Call [**IDirectXVideoDecoder::ReleaseBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-releasebuffer).</span></span>
    4.  <span data-ttu-id="8cc93-186">Вызовите метод [**идиректксвидеодекодер:: Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) , чтобы выполнить операции декодирования в кадре.</span><span class="sxs-lookup"><span data-stu-id="8cc93-186">Call [**IDirectXVideoDecoder::Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) to perform the decoding operations on the frame.</span></span>

<span data-ttu-id="8cc93-187">ДКСВА 2,0 использует те же структуры данных, что и ДКСВА 1,0, для операций декодирования.</span><span class="sxs-lookup"><span data-stu-id="8cc93-187">DXVA 2.0 uses the same data structures as DXVA 1.0 for decoding operations.</span></span> <span data-ttu-id="8cc93-188">Для исходного набора профилей ДКСВА (для H. 261, H. 263 и MPEG-2) эти структуры данных описаны в [спецификации дксва 1,0](/windows-hardware/drivers/display/directx-video-acceleration).</span><span class="sxs-lookup"><span data-stu-id="8cc93-188">For the original set of DXVA profiles (for H.261, H.263, and MPEG-2), these data structures are described in the [DXVA 1.0 specification](/windows-hardware/drivers/display/directx-video-acceleration).</span></span>

<span data-ttu-id="8cc93-189">В каждой паре вызовов [](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe) / [**выполнения**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) бегинфраме можно вызвать метод несколько [](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) раз, но только один раз для каждого типа буфера дксва.</span><span class="sxs-lookup"><span data-stu-id="8cc93-189">Within each pair of [**BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe)/[**Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) calls, you may call [**GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) multiple times, but only once for each type of DXVA buffer.</span></span> <span data-ttu-id="8cc93-190">Если вызвать его дважды с тем же типом буфера, данные будут перезаписаны.</span><span class="sxs-lookup"><span data-stu-id="8cc93-190">If you call it twice with the same buffer type, you will overwrite the data.</span></span>

<span data-ttu-id="8cc93-191">Используйте обратный вызов из метода [**сеталлокатор**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) (шаг 3), чтобы отследить, какие образцы доступны в данный момент и какие используются.</span><span class="sxs-lookup"><span data-stu-id="8cc93-191">Use the callback from the [**SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) method (step 3) to keep track of which samples are currently available and which are in use.</span></span>

## <a name="related-topics"></a><span data-ttu-id="8cc93-192">См. также</span><span class="sxs-lookup"><span data-stu-id="8cc93-192">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="8cc93-193">Ускорение видео DirectX 2,0</span><span class="sxs-lookup"><span data-stu-id="8cc93-193">DirectX Video Acceleration 2.0</span></span>](directx-video-acceleration-2-0.md)
</dt> <dt>

[<span data-ttu-id="8cc93-194">Преобразования Media Foundation</span><span class="sxs-lookup"><span data-stu-id="8cc93-194">Media Foundation Transforms</span></span>](media-foundation-transforms.md)
</dt> </dl>

 

 
