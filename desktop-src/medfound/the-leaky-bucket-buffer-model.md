---
description: '&\# 0034;&\# 0034; Model — это способ моделирования требований к буферизации для плавного воспроизведения.'
ms.assetid: 2f7f80d6-3abb-462f-a571-b223a1d59da6
title: Модель буфера для контейнера утечки (Microsoft Media Foundation)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0f5a99932fb121808f6a49323360c47c09d0acbb
ms.sourcegitcommit: de72a1294df274b0a71dc0fdc42d757e5f6df0f3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "105713319"
---
# <a name="the-leaky-bucket-buffer-model-microsoft-media-foundation"></a><span data-ttu-id="5069e-103">Модель буфера для контейнера утечки (Microsoft Media Foundation)</span><span class="sxs-lookup"><span data-stu-id="5069e-103">The Leaky Bucket Buffer Model (Microsoft Media Foundation)</span></span>

<span data-ttu-id="5069e-104">При потоковой передаче мультимедиа по сети декодер получает закодированные данные через теоретическую постоянную частоту (скорость передачи данных).</span><span class="sxs-lookup"><span data-stu-id="5069e-104">When you stream media over a network, the decoder receives encoded data at a theoretically constant rate (the transmission rate).</span></span> <span data-ttu-id="5069e-105">Декодер использует эти данные для создания раскодированных выходных данных.</span><span class="sxs-lookup"><span data-stu-id="5069e-105">The decoder consumes this data to produce decoded output.</span></span> <span data-ttu-id="5069e-106">Однако в общем случае декодер использует данные с *переменной* частотой, поскольку кодировщик может использовать переменную скорость кодирования.</span><span class="sxs-lookup"><span data-stu-id="5069e-106">In the general case, however, the decoder consumes the data at a *variable* rate, because then encoder can use a variable encoding rate.</span></span>

<span data-ttu-id="5069e-107">Модель "сегмент утечки" — это способ моделирования требований к буферизации для плавного воспроизведения.</span><span class="sxs-lookup"><span data-stu-id="5069e-107">The "leaky bucket" model is a way to model the buffering requirements for smooth playback.</span></span> <span data-ttu-id="5069e-108">В этой модели декодер поддерживает буфер.</span><span class="sxs-lookup"><span data-stu-id="5069e-108">In this model, the decoder maintains a buffer.</span></span> <span data-ttu-id="5069e-109">Закодированные данные переходят из сети в буфер и из буфера в декодер.</span><span class="sxs-lookup"><span data-stu-id="5069e-109">Encoded data goes from the network into the buffer, and from the buffer into the decoder.</span></span> <span data-ttu-id="5069e-110">Если буфер недостаточен, это означает, что декодер удаляет данные из буфера быстрее, чем доставляется сеть.</span><span class="sxs-lookup"><span data-stu-id="5069e-110">If the buffer underflows, it means the decoder is removing data from the buffer faster than the network is delivering it.</span></span> <span data-ttu-id="5069e-111">Если буфер переполнен, это означает, что сеть доставляет данные быстрее, чем используется декодером.</span><span class="sxs-lookup"><span data-stu-id="5069e-111">If the buffer overflows, it means the network is delivering data faster than the decoder consumes it.</span></span>

<span data-ttu-id="5069e-112">В этом разделе описывается модель "сегмент утечки" буферов для кодирования и декодирования.</span><span class="sxs-lookup"><span data-stu-id="5069e-112">This topic describes the "leaky bucket" model of buffers for encoding and decoding.</span></span>

-   [<span data-ttu-id="5069e-113">Сегмент утечки</span><span class="sxs-lookup"><span data-stu-id="5069e-113">The Leaky Bucket</span></span>](#the-leaky-bucket)
-   [<span data-ttu-id="5069e-114">Используемый контейнер</span><span class="sxs-lookup"><span data-stu-id="5069e-114">The Bucket in Use</span></span>](#the-bucket-in-use)
-   [<span data-ttu-id="5069e-115">Настройка значений сегментов с утечкой для потоков ASF</span><span class="sxs-lookup"><span data-stu-id="5069e-115">Setting Leaky Bucket Values for ASF Streams</span></span>](#setting-leaky-bucket-values-for-asf-streams)
-   [<span data-ttu-id="5069e-116">Значения сегментов с утечкой в мультиплексоре ASF</span><span class="sxs-lookup"><span data-stu-id="5069e-116">Leaky Bucket Values in the ASF Multiplexer</span></span>](#leaky-bucket-values-in-the-asf-multiplexer)
-   [<span data-ttu-id="5069e-117">Обновление значений сегментов с утечкой в приемнике мультимедиа ASF</span><span class="sxs-lookup"><span data-stu-id="5069e-117">Updating Leaky Bucket Values in the ASF Media Sink</span></span>](#updating-leaky-bucket-values-in-the-asf-media-sink)
-   [<span data-ttu-id="5069e-118">См. также</span><span class="sxs-lookup"><span data-stu-id="5069e-118">Related topics</span></span>](#related-topics)

## <a name="the-leaky-bucket"></a><span data-ttu-id="5069e-119">Сегмент утечки</span><span class="sxs-lookup"><span data-stu-id="5069e-119">The Leaky Bucket</span></span>

<span data-ttu-id="5069e-120">Чтобы разобраться в модели контейнеров с утечками, рассмотрим контейнер с небольшим отверстием в нижней части.</span><span class="sxs-lookup"><span data-stu-id="5069e-120">To understand the leaky bucket model, consider a bucket with a small hole at the bottom.</span></span> <span data-ttu-id="5069e-121">Контейнер определяется тремя параметрами:</span><span class="sxs-lookup"><span data-stu-id="5069e-121">Three parameters define the bucket:</span></span>

-   <span data-ttu-id="5069e-122">Емкость (B)</span><span class="sxs-lookup"><span data-stu-id="5069e-122">The capacity (B)</span></span>
-   <span data-ttu-id="5069e-123">Скорость, с которой вода выходит из сегмента (R)</span><span class="sxs-lookup"><span data-stu-id="5069e-123">The rate at which water flows out of the bucket (R)</span></span>
-   <span data-ttu-id="5069e-124">Начальная заполненность контейнера (F)</span><span class="sxs-lookup"><span data-stu-id="5069e-124">The initial fullness of the bucket (F)</span></span>

<span data-ttu-id="5069e-125">В этой метафоре контейнер является буфером:</span><span class="sxs-lookup"><span data-stu-id="5069e-125">In this metaphor, the bucket is the buffer:</span></span>

![Иллюстрация, показывающая буфер в качестве контейнера, скорость ввода как вода, поступающего в сегмент, и скорость вывода в виде воды, проходящего через отверстие в контейнере](images/asf-components03.png)

<span data-ttu-id="5069e-127">Если вода перемещается в контейнер с точностью *R*, контейнер останется в F, так как скорость ввода равна выходной ставке.</span><span class="sxs-lookup"><span data-stu-id="5069e-127">If water is poured into the bucket at exactly rate *R*, the bucket will remain at F, because the input rate equals the output rate.</span></span> <span data-ttu-id="5069e-128">Если скорость ввода увеличивается, а *R* остается постоянным, контейнер накапливает воду.</span><span class="sxs-lookup"><span data-stu-id="5069e-128">If the input rate increases while *R* remains constant, the bucket accumulates water.</span></span> <span data-ttu-id="5069e-129">Если скорость ввода превышает *R* в течение длительного периода, в конечном итоге происходит перенаправление контейнеров.</span><span class="sxs-lookup"><span data-stu-id="5069e-129">If the input rate is larger than *R* for a sustained period, eventually the bucket overflows.</span></span> <span data-ttu-id="5069e-130">Однако скорость ввода может различаться для *R* без перетекания контейнера, при условии, что средняя скорость ввода не превышает емкость контейнера.</span><span class="sxs-lookup"><span data-stu-id="5069e-130">However, the input rate can vary around *R* without overflowing the bucket, as long as the average input rate does not exceed the capacity of the bucket.</span></span> <span data-ttu-id="5069e-131">Чем больше емкость, тем больше скорость ввода может варьироваться в пределах заданного окна времени.</span><span class="sxs-lookup"><span data-stu-id="5069e-131">The larger the capacity, the more the input rate can vary within a given window of time.</span></span>

<span data-ttu-id="5069e-132">В формате ASF контейнер утечки определяется тремя параметрами:</span><span class="sxs-lookup"><span data-stu-id="5069e-132">In ASF, the leaky bucket is defined by three parameters:</span></span>

-   <span data-ttu-id="5069e-133">Средняя скорость потока в байтах в секунду, соответствующая скорости вывода (*R*)</span><span class="sxs-lookup"><span data-stu-id="5069e-133">The average bit rate, in bytes per second, which corresponds to the output rate (*R*)</span></span>
-   <span data-ttu-id="5069e-134">Окно буфера, измеряемое в миллисекундах, соответствующее емкости контейнера (*B*).</span><span class="sxs-lookup"><span data-stu-id="5069e-134">The buffer window, measured in milliseconds, which corresponds to the bucket capacity (*B*).</span></span>
-   <span data-ttu-id="5069e-135">Заполнение первоначального буфера, обычно равное нулю.</span><span class="sxs-lookup"><span data-stu-id="5069e-135">The initial buffer fullness, which is generally set to zero.</span></span>

<span data-ttu-id="5069e-136">Скорость потока измеряет среднее число бит в секунду в закодированном потоке.</span><span class="sxs-lookup"><span data-stu-id="5069e-136">The bit rate measures the average number of bits per second in the encoded stream.</span></span> <span data-ttu-id="5069e-137">В окне буфера измеряется время в миллисекундах, которое может вместить данные в буфер.</span><span class="sxs-lookup"><span data-stu-id="5069e-137">The buffer window measures the number of milliseconds of data at that bit rate that can fit in the buffer.</span></span> <span data-ttu-id="5069e-138">Размер буфера в битах равен R \* (B/1000).</span><span class="sxs-lookup"><span data-stu-id="5069e-138">The size of the buffer in bits is equal to R \* (B / 1000).</span></span>

<span data-ttu-id="5069e-139">Полезные данные ASF могут ошибочно входить в сегмент утечки и в непостоянном объеме, но должны выходить из контейнера на постоянную положительную скорость.</span><span class="sxs-lookup"><span data-stu-id="5069e-139">ASF payload data may enter the leaky bucket at irregular times and in irregular amounts, but must leave the bucket at a constant positive bit rate.</span></span> <span data-ttu-id="5069e-140">Из-за окна буфера возможны задержки между моментом, когда полезные данные попадают в контейнер и когда он остается.</span><span class="sxs-lookup"><span data-stu-id="5069e-140">Because of the buffer window, there is a possible delay between the time that payload enters the bucket and when it leaves.</span></span> <span data-ttu-id="5069e-141">Максимальная задержка, которая может произойти, — *B* / *R*.</span><span class="sxs-lookup"><span data-stu-id="5069e-141">The maximum delay that can occur is *B*/*R*.</span></span> <span data-ttu-id="5069e-142">Полезные данные, которые вводятся в контейнер, зависят от времени презентации и никогда не должны переполнить контейнер.</span><span class="sxs-lookup"><span data-stu-id="5069e-142">The payload data that enters into the bucket is according to the presentation time and must never overflow the bucket.</span></span> <span data-ttu-id="5069e-143">Помимо времени презентации, каждая полезная нагрузка также имеет время отправки — время, когда полезные данные покидает контейнер в соответствии с скоростью.</span><span class="sxs-lookup"><span data-stu-id="5069e-143">In addition to the presentation time, each payload also has a send time—the time at which the payload data leaves the bucket according to the bit rate.</span></span> <span data-ttu-id="5069e-144">Время отправки должно быть раньше времени презентации, чтобы гарантировать, что когда поврежденный контейнер становится полным, все полезные данные остаются в контейнере до или во время презентации.</span><span class="sxs-lookup"><span data-stu-id="5069e-144">Send time must be earlier than the presentation time to ensure that, when the leaky bucket gets close to being full, every payload leaves the bucket before or at its presentation time.</span></span> <span data-ttu-id="5069e-145">Для этого время презентации смещается вперед на значение *B* / *R* (Предварительная), а время отправки начинается с нуля.</span><span class="sxs-lookup"><span data-stu-id="5069e-145">To accomplish this, the presentation times are shifted ahead by the *B*/*R* value (the *preroll*), and the send times get a head start starting at zero.</span></span> <span data-ttu-id="5069e-146">Время отправки должно быть не позже времени презентации, так как это указывает на то, что полезные данные, которые были введены в контейнер слишком поздно и не могут быть добавлены в объект данных.</span><span class="sxs-lookup"><span data-stu-id="5069e-146">The send time must be no later than the presentation time because that would indicate that the payload entered the bucket too late and cannot be included in the data object.</span></span> <span data-ttu-id="5069e-147">Значение предрулона включено в [объект заголовка ASF](asf-file-structure.md) .</span><span class="sxs-lookup"><span data-stu-id="5069e-147">The preroll value is included in the [ASF Header Object](asf-file-structure.md) .</span></span>

<span data-ttu-id="5069e-148">Для потоковой передачи без сбоев по сети, сжатые потоки в содержимом носителя должны поддерживать постоянную скорость потока в течение всего времени воспроизведения.</span><span class="sxs-lookup"><span data-stu-id="5069e-148">For glitch-free streaming over the network, compressed streams within the media content must maintain a constant bit rate throughout the playback duration.</span></span> <span data-ttu-id="5069e-149">Модель "утечка данных" в формате ASF гарантирует, что данные мультимедиа передаются по сети с постоянной скоростью.</span><span class="sxs-lookup"><span data-stu-id="5069e-149">The ASF leaky bucket model ensures that media data is sent across the network at a constant bit rate.</span></span> <span data-ttu-id="5069e-150">Параметры сегмента утечки указываются в объекте свойств расширенного потока [объекта заголовка ASF](asf-file-structure.md).</span><span class="sxs-lookup"><span data-stu-id="5069e-150">The parameters of the leaky bucket are specified in the Extended Stream Properties Object of the [ASF Header Object](asf-file-structure.md).</span></span> <span data-ttu-id="5069e-151">В Microsoft Media Foundation они задаются в качестве атрибутов типа носителя, представляющего поток.</span><span class="sxs-lookup"><span data-stu-id="5069e-151">In Microsoft Media Foundation, they are set as attributes on the media type that represents the stream.</span></span>

<span data-ttu-id="5069e-152">Значения сегментов с утечкой определяются как в приемнике файлов ASF, так и в базовом объекте мультиплексора ASF, а также в кодировщике Windows Media.</span><span class="sxs-lookup"><span data-stu-id="5069e-152">The leaky bucket values are defined both in the ASF file sink and the underlying ASF multiplexer object, and the Windows Media encoder.</span></span> <span data-ttu-id="5069e-153">Эти значения могут быть одинаковыми или разными.</span><span class="sxs-lookup"><span data-stu-id="5069e-153">These values could be same or different.</span></span> <span data-ttu-id="5069e-154">Например, рассмотрим сценарий потоковой передачи, который требует, чтобы образцы звука были доставлены позже, чем образцы видео, чтобы файл можно было передавать без задержки.</span><span class="sxs-lookup"><span data-stu-id="5069e-154">For example, consider a streaming scenario, which requires the audio samples to be delivered later than the video samples so that the file can be streamed without latency.</span></span> <span data-ttu-id="5069e-155">Для этого в приемнике носителя может быть задано значение, превышающее значение, заданное в кодировщике Windows Media Audio.</span><span class="sxs-lookup"><span data-stu-id="5069e-155">To achieve this, the audio stream's leaky bucket in the media sink can be set to a value higher than the value set in the Windows Media audio encoder.</span></span>

<span data-ttu-id="5069e-156">Чтобы задать значения B/R в кодировщике, приложение должно задать свойства [**мфпкэй \_ равг**](mfpkey-ravgproperty.md), [**мфпкэй \_ Бавг**](mfpkey-bavgproperty.md), [**мфпкэй \_ рмакс**](mfpkey-rmaxproperty.md)и [**мфпкэй \_ бмакс**](mfpkey-bmaxproperty.md) .</span><span class="sxs-lookup"><span data-stu-id="5069e-156">To set B/R values in the encoder, the application must set the [**MFPKEY\_RAVG**](mfpkey-ravgproperty.md), [**MFPKEY\_BAVG**](mfpkey-bavgproperty.md), [**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md), and [**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) properties.</span></span> <span data-ttu-id="5069e-157">Дополнительные сведения о настройке свойств в кодировщике см. в разделе [Свойства кодировки](configuring-the-encoder.md).</span><span class="sxs-lookup"><span data-stu-id="5069e-157">For information about setting properties in the encoder, see [Encoding Properties](configuring-the-encoder.md).</span></span>

## <a name="the-bucket-in-use"></a><span data-ttu-id="5069e-158">Используемый контейнер</span><span class="sxs-lookup"><span data-stu-id="5069e-158">The Bucket in Use</span></span>

<span data-ttu-id="5069e-159">Целью кодировщика является обеспечение того, что содержимое никогда не переполняет буфер.</span><span class="sxs-lookup"><span data-stu-id="5069e-159">The goal of an encoder is to ensure that the content never overflows the buffer.</span></span> <span data-ttu-id="5069e-160">Кодировщик использует скорость потока и значения окна буфера в качестве направляющих.</span><span class="sxs-lookup"><span data-stu-id="5069e-160">The encoder uses the bit rate and buffer window values as guides.</span></span> <span data-ttu-id="5069e-161">Фактическое число бит, передаваемых за любой период времени, равное окну буфера, никогда не может превышать размер буфера в два раза больше.</span><span class="sxs-lookup"><span data-stu-id="5069e-161">The actual number of bits passed over any period of time equal to the buffer window can never be greater than twice the size of the buffer.</span></span>

<span data-ttu-id="5069e-162">Рассмотрим следующий пример: у вас есть 3-галлонный контейнер с отверстием, с помощью которого 1 галлон может поступать в минуту.</span><span class="sxs-lookup"><span data-stu-id="5069e-162">Consider the following example: You have a 3-gallon bucket with a hole in it through which 1 gallon can flow per minute.</span></span> <span data-ttu-id="5069e-163">Вы поместили контейнер в спигот и откроете клапан, чтобы предоставить вода с частотой 1 галлона в минуту.</span><span class="sxs-lookup"><span data-stu-id="5069e-163">You put the bucket under a spigot and open the valve to let out water at a rate of 1 gallon per minute.</span></span> <span data-ttu-id="5069e-164">Вода переносится из контейнера так быстро, как это происходит, и не приводит к появлению лишних элементов в контейнере.</span><span class="sxs-lookup"><span data-stu-id="5069e-164">The water flows out of the bucket as quickly as it enters, leaving no extra in the bucket.</span></span> <span data-ttu-id="5069e-165">Затем вы увеличиваете число потоков с спигот до 2 галлонов в минуту.</span><span class="sxs-lookup"><span data-stu-id="5069e-165">Then you increase the flow from the spigot to 2 gallons per minute.</span></span> <span data-ttu-id="5069e-166">Каждую минуту, на которую направляется вода, две галлона попадают в сегмент и 1 утечек галлонов, в сегменте остается 1 галлон.</span><span class="sxs-lookup"><span data-stu-id="5069e-166">Each minute that the water flows at this rate, 2 gallons go into the bucket and 1 gallon leaks out, leaving 1 gallon in the bucket.</span></span> <span data-ttu-id="5069e-167">По истечении 3 минут в сегмент попадают шесть галлонов, 3 галлоны были потеряны, а контейнер полон.</span><span class="sxs-lookup"><span data-stu-id="5069e-167">At the end of 3 minutes, 6 gallons of water have gone into the bucket, 3 gallons have leaked out, and the bucket is full.</span></span>

<span data-ttu-id="5069e-168">На практике теоретическая максимальная скорость передачи данных через интервал, равную окну буфера, никогда не достигается.</span><span class="sxs-lookup"><span data-stu-id="5069e-168">In practice, the theoretical maximum data rate over an interval equal to the buffer window is never achieved.</span></span> <span data-ttu-id="5069e-169">В предыдущем примере предполагается постоянная скорость передачи данных.</span><span class="sxs-lookup"><span data-stu-id="5069e-169">The previous example assumed a constant data rate.</span></span> <span data-ttu-id="5069e-170">Учитывая один и тот же 3-галлонный сегмент, можно увеличить частоту потока от спигот до 6 галлонов в минуту в течение одной минуты, а затем отключить спигот в течение двух минут.</span><span class="sxs-lookup"><span data-stu-id="5069e-170">Given the same 3-gallon bucket, you could increase the flow rate from the spigot to 6 gallons per minute for one minute and then turn the spigot off for two minutes.</span></span> <span data-ttu-id="5069e-171">Несмотря на то, что общий объем воды, помещаемых в сегмент, находится в пределах теоретического максимума окна буфера, концентрация этого числа в одной части окна приводит к переполнению контейнера.</span><span class="sxs-lookup"><span data-stu-id="5069e-171">Even though the total amount of water put into the bucket is within the theoretical maximum for the buffer window, the concentration of that amount into one part of the window causes the bucket to overflow.</span></span> <span data-ttu-id="5069e-172">В 6 галлонов в минуту, 3-галлонный контейнер переполняется вскоре за 30 секунд.</span><span class="sxs-lookup"><span data-stu-id="5069e-172">At 6 gallons per minute, the 3-gallon bucket overflows shortly after 30 seconds pass.</span></span> <span data-ttu-id="5069e-173">Таким образом, фактический максимальный объем данных, которые могут быть доставлены в буфер, в течение любого интервала, равного параметру окна буфера, зависит от размера отдельных выборок и времени доставки.</span><span class="sxs-lookup"><span data-stu-id="5069e-173">Therefore, the actual maximum amount of data that can be delivered to the buffer over the duration of any interval equal to the buffer window setting depends upon the size of individual samples and when they are delivered.</span></span>

<span data-ttu-id="5069e-174">До сих пор в примерах рассматривался только буфер, используемый декодером, но буфер контейнеров с утечкой также используется кодировщиком, который создает сжатое содержимое.</span><span class="sxs-lookup"><span data-stu-id="5069e-174">So far the examples have only discussed the buffer used by the decoder, but a leaky bucket buffer is also used by the encoder which creates the compressed content.</span></span> <span data-ttu-id="5069e-175">Кодировщик выполняет любые корректировки, необходимые для алгоритмов сжатия, чтобы хранить скорость сжатых образцов в пределах границ, описанных в разделе скорость потока и окно буфера, предполагая, что образцы будут доставляться в декодер с постоянной скоростью.</span><span class="sxs-lookup"><span data-stu-id="5069e-175">The encoder makes whatever adjustments are necessary to the compression algorithms to keep the bit rate of the compressed samples within the boundaries described by the bit rate and buffer window, assuming that the samples will be delivered to the decoder at a constant rate.</span></span> <span data-ttu-id="5069e-176">Контейнер кодировщика можно представить как зеркальное отображение контейнера декодера.</span><span class="sxs-lookup"><span data-stu-id="5069e-176">You can think of the encoder bucket as mirroring the decoder bucket.</span></span> <span data-ttu-id="5069e-177">Контейнер кодировщика заполняется по переменной частоте, определяемой размером отдельных выборок и утечек с постоянной скоростью, равной среднему значению скорости.</span><span class="sxs-lookup"><span data-stu-id="5069e-177">The encoder bucket is filled at a variable rate determined by the size of the individual samples and leaks at a constant rate equal to the average bit rate.</span></span>

<span data-ttu-id="5069e-178">Рассмотрим следующий пример кодировщика и декодера, Соединенных по сети.</span><span class="sxs-lookup"><span data-stu-id="5069e-178">Consider the following example of an encoder and decoder connected together over a network.</span></span> <span data-ttu-id="5069e-179">Файл видео кодируется в 30 кадров в секунду со скоростью в 6 000 бит/с и окном буфера 3 секунды (общий размер буфера составляет 18 000 бит).</span><span class="sxs-lookup"><span data-stu-id="5069e-179">You encode a video file at 30 frames per second with a bit rate of 6,000 bits per second and a buffer window of 3 seconds (a total buffer size of 18,000 bits).</span></span> <span data-ttu-id="5069e-180">Первый пример кодируется как ключевой кадр и занимает 7 000 бит.</span><span class="sxs-lookup"><span data-stu-id="5069e-180">The first sample is encoded as a key frame and takes up 7,000 bits.</span></span> <span data-ttu-id="5069e-181">Буфер кодировщика теперь содержит 7 000 бит.</span><span class="sxs-lookup"><span data-stu-id="5069e-181">The encoder buffer now contains 7,000 bits.</span></span> <span data-ttu-id="5069e-182">Следующие 29 кадров — это все разностные кадры общего числа 3 000 бит.</span><span class="sxs-lookup"><span data-stu-id="5069e-182">The next 29 frames are all delta frames that total 3,000 bits.</span></span> <span data-ttu-id="5069e-183">Таким образом, первая секунда содержимого (30 кадров) поместит заполнение буфера в 10 000 бит, если утечка не выполнялась. Мы понимаем, что скорость потока в потоке составляет 6 000 бит в секунду, поэтому после того, как первая секунда закодированного содержимого помещается в буфер кодировщика, заполнение сбрасывается на 4 000 бит.</span><span class="sxs-lookup"><span data-stu-id="5069e-183">So the first second of content (30 frames) would put the buffer fullness at 10,000 bits if nothing were leaking out. We know that the bit rate of the stream is 6,000 bits per second, so after the first second of encoded content is put in the encoder buffer, the fullness drops to 4,000 bits.</span></span> <span data-ttu-id="5069e-184">В приложении декодирования этот поток доставляется в буфер декодера с частотой 6 000 бит/сек.</span><span class="sxs-lookup"><span data-stu-id="5069e-184">In the decoding application, this stream is delivered to the decoder buffer at 6,000 bits per second.</span></span> <span data-ttu-id="5069e-185">Через одну секунду буфер содержит 6 000 бит.</span><span class="sxs-lookup"><span data-stu-id="5069e-185">After one second, the buffer contains 6,000 bits.</span></span> <span data-ttu-id="5069e-186">Первый пример содержит 7 000 бит, поэтому буфер декодера должен быть заполнен более, прежде чем декодер начнет удалять образцы.</span><span class="sxs-lookup"><span data-stu-id="5069e-186">The first sample contains 7,000 bits, so the decoder buffer must be filled more before the decoder begins removing samples.</span></span>

## <a name="setting-leaky-bucket-values-for-asf-streams"></a><span data-ttu-id="5069e-187">Настройка значений сегментов с утечкой для потоков ASF</span><span class="sxs-lookup"><span data-stu-id="5069e-187">Setting Leaky Bucket Values for ASF Streams</span></span>

<span data-ttu-id="5069e-188">В сценарии кодирования файлов приложение может задать значения сегментов утечки при настройке потоков в [профиле ASF](asf-profile.md).</span><span class="sxs-lookup"><span data-stu-id="5069e-188">In a file-encoding scenario, an application can set the leaky bucket values while configuring the streams in the [ASF Profile](asf-profile.md).</span></span>

<span data-ttu-id="5069e-189">После создания потока и ссылки на интерфейс [**имфасфстреамконфиг**](/windows/desktop/api/wmcontainer/nn-wmcontainer-imfasfstreamconfig) потока можно задать значения с помощью следующих атрибутов:</span><span class="sxs-lookup"><span data-stu-id="5069e-189">After you have created the stream and have a reference to the stream's [**IMFASFStreamConfig**](/windows/desktop/api/wmcontainer/nn-wmcontainer-imfasfstreamconfig) interface, you can set the values by using the following attributes:</span></span>

-   <span data-ttu-id="5069e-190">[**MF \_ АСФСТРЕАМКОНФИГ \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) (средние значения сегментов с утечкой)</span><span class="sxs-lookup"><span data-stu-id="5069e-190">[**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) (average leaky bucket values)</span></span>
-   <span data-ttu-id="5069e-191">[**MF \_ АСФСТРЕАМКОНФИГ \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (максимальное значение в контейнере с утечкой)</span><span class="sxs-lookup"><span data-stu-id="5069e-191">[**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (maximum leaky bucket values)</span></span>

<span data-ttu-id="5069e-192">Дополнительные сведения о добавлении потоков и получении указателя **имфасфстреамконфиг** см. в разделе [Добавление потоковых данных в приемник файлов ASF](adding-stream-information-to-the-asf-file-sink.md).</span><span class="sxs-lookup"><span data-stu-id="5069e-192">For information about adding streams and getting the **IMFASFStreamConfig** pointer, see [Adding Stream Information to the ASF File Sink](adding-stream-information-to-the-asf-file-sink.md).</span></span>

<span data-ttu-id="5069e-193">Эти значения содержат следующий набор данных:</span><span class="sxs-lookup"><span data-stu-id="5069e-193">These values contain the following set of information:</span></span>

-   <span data-ttu-id="5069e-194">Средняя скорость потока: Возвращает среднюю скорость потока из типа выходного носителя, выбранного во время согласования типа носителя.</span><span class="sxs-lookup"><span data-stu-id="5069e-194">Average bit rate: Get the average bit rate from the output media type that is selected during media type negotiation.</span></span> <span data-ttu-id="5069e-195">Используйте атрибут [**" \_ \_ \_ средний байт в \_ \_ \_ секунду**](mf-mt-audio-avg-bytes-per-second-attribute.md) " (для звуковых потоков) или атрибут " [**\_ \_ Средняя \_ скорость MF MT**](mf-mt-avg-bitrate-attribute.md) " (для видеопотоков).</span><span class="sxs-lookup"><span data-stu-id="5069e-195">Use the [**MF\_MT\_AUDIO\_AVG\_BYTES\_PER\_SECOND**](mf-mt-audio-avg-bytes-per-second-attribute.md) attribute (for audio streams) or the [**MF\_MT\_AVG\_BITRATE**](mf-mt-avg-bitrate-attribute.md) attribute (for video streams).</span></span>
-   <span data-ttu-id="5069e-196">Окно буфера. Если у вас есть экземпляр кодировщика с согласованными выходными типами носителей, это значение можно обновить позже, запросив кодировщик для интерфейса [**ивмкодеклеакибуккет**](/windows/desktop/api/wmcodecdsp/nn-wmcodecdsp-iwmcodecleakybucket) и затем вызвав [**Ивмкодеклеакибуккет:: жетбуфферсизебитс**](../wmformat/iwmcodecleakybucket-getbuffersizebits.md) (вмкодеЦифацес. h, вмкодекдспууид. lib).</span><span class="sxs-lookup"><span data-stu-id="5069e-196">Buffer window: If you have an instance of the encoder and have negotiated output media types, you can update this value later by querying the encoder for the [**IWMCodecLeakyBucket**](/windows/desktop/api/wmcodecdsp/nn-wmcodecdsp-iwmcodecleakybucket) interface and then calling [**IWMCodecLeakyBucket::GetBufferSizeBits**](../wmformat/iwmcodecleakybucket-getbuffersizebits.md) (wmcodecifaces.h, wmcodecdspuuid.lib).</span></span> <span data-ttu-id="5069e-197">В противном случае используйте значение по умолчанию 3000 миллисекунд.</span><span class="sxs-lookup"><span data-stu-id="5069e-197">Otherwise, Use the default value of 3000 milliseconds.</span></span>
-   <span data-ttu-id="5069e-198">Начальный размер буфера: значение 0.</span><span class="sxs-lookup"><span data-stu-id="5069e-198">Initial buffer size: Set to 0.</span></span>

<span data-ttu-id="5069e-199">Значения, предоставляемые приложением, зависят от типа кодировки и типа носителя потока.</span><span class="sxs-lookup"><span data-stu-id="5069e-199">The values provided by the application depend on the type of encoding and the media type of the stream.</span></span> <span data-ttu-id="5069e-200">Например, для [кодирования постоянной скорости потока](constant-bit-rate-encoding.md) требуется предварительно определенная фиксированная скорость потока и окно буфера.</span><span class="sxs-lookup"><span data-stu-id="5069e-200">For example, [Constant Bit Rate Encoding](constant-bit-rate-encoding.md) requires a predetermined fixed bit rate and a buffer window.</span></span> <span data-ttu-id="5069e-201">Приложение может указать эти значения сегментов утечки, задав свойство Encoding [**мфпкэй \_ видеовиндов**](mfpkey-videowindowproperty.md) и атрибут [**MF \_ асфстреамконфиг \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) в потоке.</span><span class="sxs-lookup"><span data-stu-id="5069e-201">The application can specify these leaky bucket values by setting the [**MFPKEY\_VIDEOWINDOW**](mfpkey-videowindowproperty.md) encoding property and the [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) attribute on the stream.</span></span> <span data-ttu-id="5069e-202">Указанные значения окна буфера используются, чтобы убедиться, что в закодированном файле задано правильное время отправки в пакетах данных, а в объекте заголовка ASF отображается значение предкоррекции.</span><span class="sxs-lookup"><span data-stu-id="5069e-202">The specified buffer window values are used to make sure that the encoded file has the correct send times marked on the data packets and the preroll value appears in the ASF Header Object.</span></span> <span data-ttu-id="5069e-203">Достаточно установить **MF \_ асфстреамконфиг \_ LEAKYBUCKET1** , так как указанные значения копируются в атрибут [**MF \_ асфстреамконфиг \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) .</span><span class="sxs-lookup"><span data-stu-id="5069e-203">It is sufficient to set **MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1** because these specified values are copied into the [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) attribute.</span></span>

<span data-ttu-id="5069e-204">Для режима 2-проходного кодирования необходимо задать оба этих атрибута, чтобы указать среднее и максимальное значения.</span><span class="sxs-lookup"><span data-stu-id="5069e-204">For 2-pass encoding modes you need to set both of these attributes to specify the average and maximum values.</span></span>

<span data-ttu-id="5069e-205">Для кодирования VBR приложение может запросить значения сегментов утечки, используемые кодировщиком, только после завершения этапа кодирования.</span><span class="sxs-lookup"><span data-stu-id="5069e-205">For VBR encoding, the application can query for the leaky bucket values used by the encoder only after the encoding pass is complete.</span></span> <span data-ttu-id="5069e-206">Таким образом, при настройке приемника мультимедиа приложение может не задавать атрибуты или свойства, связанные с сегментами утечки.</span><span class="sxs-lookup"><span data-stu-id="5069e-206">Therefore, while configuring the media sink, the application can choose not to set the attributes or properties related to leaky buckets.</span></span> <span data-ttu-id="5069e-207">После кодирования приложение должно запрашивать кодировщик для свойств [**мфпкэй \_ равг**](mfpkey-ravgproperty.md), [**мфпкэй \_ Бавг**](mfpkey-bavgproperty.md), [**мфпкэй \_ рмакс**](mfpkey-rmaxproperty.md)и [**мфпкэй \_ бмакс**](mfpkey-bmaxproperty.md) и задавать их в приемнике носителей, чтобы точные значения отражались в объекте заголовка.</span><span class="sxs-lookup"><span data-stu-id="5069e-207">After encoding, the application must query the encoder for the [**MFPKEY\_RAVG**](mfpkey-ravgproperty.md), [**MFPKEY\_BAVG**](mfpkey-bavgproperty.md), [**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md), and [**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) properties and set them in the media sink so that the accurate values are reflected in the Header Object.</span></span> <span data-ttu-id="5069e-208">Пример кода, посвященного обновлению значений для кодирования VBR, см. в разделе "Обновление свойств кодировки в приемнике файлов" раздела [Учебник: 1. передача кодировки Windows Media](tutorial--1-pass-windows-media-encoding.md).</span><span class="sxs-lookup"><span data-stu-id="5069e-208">For code example about how to update the values for VBR encoding, see "Update Encoding Properties in the File Sink" in [Tutorial: 1-Pass Windows Media Encoding](tutorial--1-pass-windows-media-encoding.md).</span></span>

<span data-ttu-id="5069e-209">При копировании содержимого Windows Media из источника в приемник мультимедиа без кодирования значения сегментов утечки должны быть установлены в приемнике мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="5069e-209">If you are copying Windows Media content from source to media sink without encoding, the leaky bucket values must be set in the media sink.</span></span>

## <a name="leaky-bucket-values-in-the-asf-multiplexer"></a><span data-ttu-id="5069e-210">Значения сегментов с утечкой в мультиплексоре ASF</span><span class="sxs-lookup"><span data-stu-id="5069e-210">Leaky Bucket Values in the ASF Multiplexer</span></span>

<span data-ttu-id="5069e-211">В Media Foundation значения контейнеров утечки используются [мультиплексором ASF](asf-multiplexer.md) для настройки внутренних значений сегментов утечки, которые используются для создания пакетов данных.</span><span class="sxs-lookup"><span data-stu-id="5069e-211">In Media Foundation, the leaky bucket values are used by the [ASF Multiplexer](asf-multiplexer.md) to set up the internal leaky bucket values that it uses to generate data packets.</span></span> <span data-ttu-id="5069e-212">Полезные данные содержатся в образце носителя, а ряд образцов носителей — в виде пакета данных ASF.</span><span class="sxs-lookup"><span data-stu-id="5069e-212">The payload is contained within a media sample and a series of media samples constitutes an ASF data packet.</span></span> <span data-ttu-id="5069e-213">Основываясь на значениях сегментов утечки и времени презентации, мультиплексор назначает время отправки для каждого примера носителя, чтобы скорость передачи пакетов по сети была постоянной (*R*).</span><span class="sxs-lookup"><span data-stu-id="5069e-213">Based on the leaky bucket values and the presentation time, the multiplexer assigns a send time for each media sample so that the bit rates of the packets being sent across the network is at a constant bit rate (*R*).</span></span>

<span data-ttu-id="5069e-214">Приложение не может напрямую задавать значения сегментов утечки в мультиплексоре.</span><span class="sxs-lookup"><span data-stu-id="5069e-214">An application cannot set leaky bucket values in the multiplexer directly.</span></span> <span data-ttu-id="5069e-215">Значения должны быть указаны в приемнике ASF Media, который задает соответствующие значения для мультиплексора.</span><span class="sxs-lookup"><span data-stu-id="5069e-215">The values must be provided on the ASF media sink, which sets the appropriate values on the multiplexer.</span></span> <span data-ttu-id="5069e-216">Значения, заданные в [**MF \_ асфстреамконфиг \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) и [**MF \_ асфстреамконфиг \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) , используются мультиплексором для проверки того, что образцы, отправляемые в приемник мультимедиа ASF, создаются с использованием указанных значений.</span><span class="sxs-lookup"><span data-stu-id="5069e-216">The values set in [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) and [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) are used by the multiplexer to validate the samples sent to the ASF media sink are generated by using the specified values.</span></span>

## <a name="updating-leaky-bucket-values-in-the-asf-media-sink"></a><span data-ttu-id="5069e-217">Обновление значений сегментов с утечкой в приемнике мультимедиа ASF</span><span class="sxs-lookup"><span data-stu-id="5069e-217">Updating Leaky Bucket Values in the ASF Media Sink</span></span>

<span data-ttu-id="5069e-218">Приложение может перезаписать значения контейнеров утечки на уровне потока (заданные в профиле ASF во время создания потока), установив свойство [**мфпкэй \_ асфстреамсинк \_ Исправлено \_ леакибуккет**](mfpkey-asfstreamsink-corrected-leakybucket-property.md) в хранилище свойств приемника мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="5069e-218">An application can overwrite the stream-level leaky bucket values (set in the ASF profile during stream creation) by setting the [**MFPKEY\_ASFSTREAMSINK\_CORRECTED\_LEAKYBUCKET**](mfpkey-asfstreamsink-corrected-leakybucket-property.md) property in the media sink's property store.</span></span> <span data-ttu-id="5069e-219">Чтобы получить ссылку на хранилище свойств, используйте объект Контентинфо, реализованный приемником мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="5069e-219">To get a reference to the property store, use the ContentInfo object implemented by the media sink.</span></span> <span data-ttu-id="5069e-220">Дополнительные сведения см. [в разделе Установка свойств в приемнике файла](setting-properties-in-the-file-sink.md).</span><span class="sxs-lookup"><span data-stu-id="5069e-220">For more information, see [Setting Properties in the File Sink](setting-properties-in-the-file-sink.md).</span></span>

<span data-ttu-id="5069e-221">**Примечание**  .  Эта операция разрешена только для звуковых потоков.</span><span class="sxs-lookup"><span data-stu-id="5069e-221">**Note**  This operation is only allowed for audio streams.</span></span>

<span data-ttu-id="5069e-222">Это свойство должно быть задано после установки типа выходных данных кодировщика.</span><span class="sxs-lookup"><span data-stu-id="5069e-222">This property must be set after you have set the output type on the encoder.</span></span> <span data-ttu-id="5069e-223">В зависимости от скорости потока, заданной в типе носителя, кодировщик вычисляет размер буфера, чтобы убедиться, что созданные примеры мультимедиа никогда не перечисляют буфер.</span><span class="sxs-lookup"><span data-stu-id="5069e-223">Based on the bit rate set in the media type, the encoder calculates the buffer size to ensure that the generated media samples never overflow the buffer.</span></span> <span data-ttu-id="5069e-224">Кодировщик вносит необходимые изменения во время сжатия для сохранения скорости сжатых образцов в пределах границ, описанных в разделе скорость потока и окно буфера.</span><span class="sxs-lookup"><span data-stu-id="5069e-224">The encoder makes necessary adjustments during compression to keep the bit rate of the compressed samples within the boundaries described by the bit rate and buffer window.</span></span>

<span data-ttu-id="5069e-225">Как и атрибуты конфигурации потока для сегментов утечки, установите среднюю скорость и размер буфера, а также заполнение исходного буфера в массиве DWORD.</span><span class="sxs-lookup"><span data-stu-id="5069e-225">Similar to the stream configuration attributes for leaky buckets, set the average bit rate and the buffer size, and the initial buffer fullness in an array of DWORDs.</span></span> <span data-ttu-id="5069e-226">Дополнительные сведения см. в подразделе «Установка значений сегмента утечки для потоков ASF» этого раздела.</span><span class="sxs-lookup"><span data-stu-id="5069e-226">For more information, see "Setting Leaky Bucket Values for ASF Streams" section in this topic.</span></span>

## <a name="related-topics"></a><span data-ttu-id="5069e-227">См. также</span><span class="sxs-lookup"><span data-stu-id="5069e-227">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5069e-228">Поддержка ASF в Media Foundation</span><span class="sxs-lookup"><span data-stu-id="5069e-228">ASF Support in Media Foundation</span></span>](asf-support-in-media-foundation.md)
</dt> <dt>

[<span data-ttu-id="5069e-229">Кодеки Windows Media</span><span class="sxs-lookup"><span data-stu-id="5069e-229">Windows Media Codecs</span></span>](windows-media-codecs.md)
</dt> </dl>

 

 
