---
description: Описание содержимого видео&\# 8211, возможностей защиты, которые может предоставить графический драйвер.
ms.assetid: FD0625BB-484A-43E6-8931-DB635D4F017F
title: GPU-Based Защита содержимого
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6bbc1a0f88cae199b9aab38e5ec429ea5427f44b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104550431"
---
# <a name="gpu-based-content-protection"></a><span data-ttu-id="c5c4f-103">GPU-Based Защита содержимого</span><span class="sxs-lookup"><span data-stu-id="c5c4f-103">GPU-Based Content Protection</span></span>

<span data-ttu-id="c5c4f-104">В этом разделе описывается содержимое видео — возможности защиты, которые может предоставить графический драйвер.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-104">This topic describes video content–protection capabilities that a graphics driver can provide.</span></span>

-   [<span data-ttu-id="c5c4f-105">Введение</span><span class="sxs-lookup"><span data-stu-id="c5c4f-105">Introduction</span></span>](#introduction)
-   [<span data-ttu-id="c5c4f-106">Общие сведения о процессе декодирования</span><span class="sxs-lookup"><span data-stu-id="c5c4f-106">Overview of the Decoding Process</span></span>](#overview-of-the-decoding-process)
-   [<span data-ttu-id="c5c4f-107">Шифрование сжатых буферов видео для декодера</span><span class="sxs-lookup"><span data-stu-id="c5c4f-107">Encrypting Compressed Video Buffers for the Decoder</span></span>](#encrypting-compressed-video-buffers-for-the-decoder)
    -   [<span data-ttu-id="c5c4f-108">1. запросите Защита содержимого возможности драйвера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-108">1. Query the Content Protection Capabilities of the Driver</span></span>](#1-query-the-content-protection-capabilities-of-the-driver)
    -   [<span data-ttu-id="c5c4f-109">2. Настройка канала, прошедшего проверку подлинности</span><span class="sxs-lookup"><span data-stu-id="c5c4f-109">2. Configure the Authenticated Channel</span></span>](#2-configure-the-authenticated-channel)
    -   [<span data-ttu-id="c5c4f-110">3. Настройка сеанса шифрования</span><span class="sxs-lookup"><span data-stu-id="c5c4f-110">3. Configure the Cryptographic Session</span></span>](#3-configure-the-cryptographic-session)
    -   [<span data-ttu-id="c5c4f-111">4. получение маркера для устройства декодера ДКСВА</span><span class="sxs-lookup"><span data-stu-id="c5c4f-111">4. Get a Handle to the DXVA Decoder Device</span></span>](#4-get-a-handle-to-the-dxva-decoder-device)
    -   [<span data-ttu-id="c5c4f-112">5. Связывание декодера ДКСВА с криптографическим сеансом</span><span class="sxs-lookup"><span data-stu-id="c5c4f-112">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>](#5-associate-the-dxva-decoder-with-the-cryptographic-session)
-   [<span data-ttu-id="c5c4f-113">Отправка команд аутентифицированного канала</span><span class="sxs-lookup"><span data-stu-id="c5c4f-113">Sending Authenticated Channel Commands</span></span>](#sending-authenticated-channel-commands)
-   [<span data-ttu-id="c5c4f-114">Отправка запросов к каналам с проверкой подлинности</span><span class="sxs-lookup"><span data-stu-id="c5c4f-114">Sending Authenticated Channel Queries</span></span>](#sending-authenticated-channel-queries)
-   [<span data-ttu-id="c5c4f-115">См. также</span><span class="sxs-lookup"><span data-stu-id="c5c4f-115">Related topics</span></span>](#related-topics)

## <a name="introduction"></a><span data-ttu-id="c5c4f-116">Введение</span><span class="sxs-lookup"><span data-stu-id="c5c4f-116">Introduction</span></span>

<span data-ttu-id="c5c4f-117">На следующей диаграмме показано упрощенное представление того, как защищенное видео проходит через конвейер для подготовки к просмотру.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-117">The following diagram shows a simplified view of how protected video content travels through the pipeline to be rendered.</span></span>

![Схема, на которой показано защищенное видео-содержимое.](images/d3d9video01.png)

> [!Note]  
> <span data-ttu-id="c5c4f-119">[Путь к защищенному носителю](protected-media-path.md) (PMP) не показан на этой схеме.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-119">The [Protected Media Path](protected-media-path.md) (PMP) is not depicted in this diagram.</span></span> <span data-ttu-id="c5c4f-120">Показанный здесь поток данных может находиться в процессе PMP или в процессе приложения.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-120">The data flow that is shown here might occur within a PMP process, or within an application process.</span></span>

 

<span data-ttu-id="c5c4f-121">Декодер получает зашифрованные сжатые данные видео из внешнего источника.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-121">The decoder receives encrypted, compressed video data from an external source.</span></span> <span data-ttu-id="c5c4f-122">Предполагается, что декодер также получает криптографический ключ для расшифровки этих данных.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-122">It is assumed also the decoder also receives a cryptographic key to decrypt this data.</span></span> <span data-ttu-id="c5c4f-123">В этом разделе не описывается обмен ключами между источником видео и декодером, но PMP определяет один из возможных механизмов.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-123">This topic does not describe the key exchange between the video source and decoder, but the PMP defines one possible mechanism.</span></span> <span data-ttu-id="c5c4f-124">На этом этапе не участвует графический процессор.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-124">The GPU is not involved at this stage.</span></span>

<span data-ttu-id="c5c4f-125">При декодировании с аппаратным ускорением программный декодер передает сжатое видео-изображение в графический процессор.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-125">For hardware-accelerated decoding, the software decoder passes compressed video content to the GPU.</span></span> <span data-ttu-id="c5c4f-126">Чтобы защитить это содержимое, декодер повторно шифрует данные, как правило, с помощью AES-Protector, перед передачей их в аппаратный ускоритель.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-126">To protect this content, the decoder re-encrypts the data, typically using AES-CTR, before passing it to the hardware accelerator.</span></span> <span data-ttu-id="c5c4f-127">Механизм обмена ключами определяется между декодером и драйвером графики.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-127">A key-exchange mechanism is defined between the decoder and the graphics driver.</span></span>

<span data-ttu-id="c5c4f-128">Декодированные видеоматериалы хранятся в видеопамяти, как правило, в четком виде.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-128">Decoded video frames are stored in video memory, generally in the clear.</span></span> <span data-ttu-id="c5c4f-129">На этом этапе кадры обрабатываются, а затем представляются.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-129">At this point, the frames are processed and then presented.</span></span> <span data-ttu-id="c5c4f-130">Существует два основных варианта представления.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-130">There are two main options for presentation.</span></span>

-   <span data-ttu-id="c5c4f-131">Фреймы можно представить с помощью наложения оборудования.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-131">Frames can be presented using a hardware overlay.</span></span> <span data-ttu-id="c5c4f-132">Дополнительные сведения см. в разделе [поддержка наложения оборудования](hardware-overlay-support.md).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-132">For more information, see [Hardware Overlay Support](hardware-overlay-support.md).</span></span>
-   <span data-ttu-id="c5c4f-133">Фреймы могут быть представлены оконным окном Управление (DWM) с помощью общей поверхности.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-133">Frames can be presented by the Desktop Window Manage (DWM) using a shared surface.</span></span>

<span data-ttu-id="c5c4f-134">Последним шагом является отображение кадра на мониторе, для которого может потребоваться защита канала между графической картой и устройством отображения.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-134">The last step is to display the frame on the monitor, which may require link protection between the graphics card and the display device.</span></span> <span data-ttu-id="c5c4f-135">Примером защиты канала является High-Bandwidth цифровой Защита содержимого (HDCP).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-135">An example of link protection is High-Bandwidth Digital Content Protection (HDCP).</span></span> <span data-ttu-id="c5c4f-136">Защита канала настраивается с помощью [диспетчера выходной защиты](output-protection-manager.md) (ОПМ).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-136">Link protection is configured using [Output Protection Manager](output-protection-manager.md) (OPM).</span></span> <span data-ttu-id="c5c4f-137">В этом разделе не описывается ОПМ; Дополнительные сведения см. [в разделе Использование диспетчера выходной защиты](using-output-protection-manager.md).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-137">This topic does not describe OPM; for more information, see [Using Output Protection Manager](using-output-protection-manager.md).</span></span>

## <a name="overview-of-the-decoding-process"></a><span data-ttu-id="c5c4f-138">Общие сведения о процессе декодирования</span><span class="sxs-lookup"><span data-stu-id="c5c4f-138">Overview of the Decoding Process</span></span>

<span data-ttu-id="c5c4f-139">При декодировании с аппаратным ускорением программный декодер должен передавать на графическую карту сжатые данные видео.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-139">During hardware-accelerated decoding, the software decoder must pass compressed video data to the graphics card.</span></span> <span data-ttu-id="c5c4f-140">Для содержимого уровня "Премиум" эти данные обычно должны быть зашифрованы с помощью шифрования с симметричным ключом перед отправкой на GPU.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-140">For premium content, this data typically must be encrypted, using symmetric-key encryption, before it is sent to the GPU.</span></span>

<span data-ttu-id="c5c4f-141">Чтобы зашифровать видео для декодирования, программный декодер использует следующие интерфейсы:</span><span class="sxs-lookup"><span data-stu-id="c5c4f-141">To encrypt the video for decoding, the software decoder uses the following interfaces:</span></span>

-   <span data-ttu-id="c5c4f-142">[**Идиректксвидеодекодер**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-142">[**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder).</span></span> <span data-ttu-id="c5c4f-143">Представляет устройство декодера ДКСВА, также называемое ускорителем.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-143">Represents the DXVA decoder device, also called the accelerator.</span></span>
-   <span data-ttu-id="c5c4f-144">[**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-144">[**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9).</span></span> <span data-ttu-id="c5c4f-145">Представляет сеанс шифрования, который предоставляет ключ шифрования.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-145">Represents a cryptographic session, which provides the encryption key.</span></span>
-   <span data-ttu-id="c5c4f-146">[**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-146">[**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9).</span></span> <span data-ttu-id="c5c4f-147">Представляет канал, прошедший проверку подлинности, который позволяет декодеру программного обеспечения связывать сеанс шифрования с декодером ДКСВА.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-147">Represents an authenticated channel, which enables the software decoder to associate the cryptographic session with the DXVA decoder.</span></span>

![Схема, на которой показаны интерфейсы декодирования Direct3D9.](images/d3d9video02.png)

<span data-ttu-id="c5c4f-149">Все эти интерфейсы получаются с устройства Direct3D следующим образом:</span><span class="sxs-lookup"><span data-stu-id="c5c4f-149">All of these interfaces are obtained from the Direct3D device, as follows:</span></span>



| <span data-ttu-id="c5c4f-150">Интерфейс</span><span class="sxs-lookup"><span data-stu-id="c5c4f-150">Interface</span></span>                                                                | <span data-ttu-id="c5c4f-151">Создание</span><span class="sxs-lookup"><span data-stu-id="c5c4f-151">Creation</span></span>                                                                                                                                                                      |
|--------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="c5c4f-152">**идиректксвидеодекодер**</span><span class="sxs-lookup"><span data-stu-id="c5c4f-152">**IDirectXVideoDecoder**</span></span>](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder)                     | <span data-ttu-id="c5c4f-153">Вызовите [**идиректксвидеодекодерсервице:: креатевидеодекодер**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-153">Call [**IDirectXVideoDecoderService::CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span></span> <span data-ttu-id="c5c4f-154">Устройство декодера ДКСВА определяется идентификатором GUID профиля ДКСВА.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-154">The DXVA decoder device is identified by a DXVA profile GUID.</span></span> |
| [<span data-ttu-id="c5c4f-155">**IDirect3DCryptoSession9**</span><span class="sxs-lookup"><span data-stu-id="c5c4f-155">**IDirect3DCryptoSession9**</span></span>](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9)               | <span data-ttu-id="c5c4f-156">Вызовите [**IDirect3DDevice9Video:: креатекриптосессион**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-156">Call [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession).</span></span>                                                                         |
| [<span data-ttu-id="c5c4f-157">**IDirect3DAuthenticatedChannel9**</span><span class="sxs-lookup"><span data-stu-id="c5c4f-157">**IDirect3DAuthenticatedChannel9**</span></span>](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) | <span data-ttu-id="c5c4f-158">Вызовите [**IDirect3DDevice9Video:: креатеаусентикатедчаннел**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-158">Call [**IDirect3DDevice9Video::CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel).</span></span>                                                           |



 

> [!Note]  
> <span data-ttu-id="c5c4f-159">Чтобы получить указатель на интерфейс [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) , вызовите метод [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) на устройстве D3D9Ex.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-159">To get a pointer to the [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) interface, call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) on a D3D9Ex device.</span></span>

 

<span data-ttu-id="c5c4f-160">Прошедший проверку подлинности канал предоставляет доверенный канал связи между программным декодером и драйвером.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-160">The authenticated channel provides a trusted communication channel between the software decoder and the driver.</span></span> <span data-ttu-id="c5c4f-161">Коммуникационный канал работает следующим образом:</span><span class="sxs-lookup"><span data-stu-id="c5c4f-161">The communication channel works as follows:</span></span>

-   <span data-ttu-id="c5c4f-162">Драйвер предоставляет цепочку сертификатов X. 509, корневой сертификат которой подписан корпорацией Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-162">The driver provides an X.509 certificate chain whose root certificate is signed by Microsoft.</span></span>
-   <span data-ttu-id="c5c4f-163">Сертификат содержит открытый ключ RSA для драйвера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-163">The certificate contains an RSA public key for the driver.</span></span>
-   <span data-ttu-id="c5c4f-164">Программный декодер использует открытый ключ для отправки драйвера в 128-разрядный сеансовый ключ AES.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-164">The software decoder uses the public key to send the driver a 128-bit AES session key.</span></span>
-   <span data-ttu-id="c5c4f-165">Программный декодер отправляет запросы и команды в канал, прошедший проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-165">The software decoder sends queries and commands to the authenticated channel.</span></span>
-   <span data-ttu-id="c5c4f-166">Ключ сеанса используется для расчета кодов проверки подлинности сообщений (Mac) для запросов и команд.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-166">The session key is used to compute message authentication codes (MACs) for the queries and commands.</span></span> <span data-ttu-id="c5c4f-167">Драйвер использует макинтоши для проверки целостности данных запроса или команды, а программный декодер использует их для проверки целостности данных ответа из драйвера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-167">The driver uses the MACs to verify the integrity of the query/command data, and the software decoder uses them to verify the integrity of the response data from the driver.</span></span>

## <a name="encrypting-compressed-video-buffers-for-the-decoder"></a><span data-ttu-id="c5c4f-168">Шифрование сжатых буферов видео для декодера</span><span class="sxs-lookup"><span data-stu-id="c5c4f-168">Encrypting Compressed Video Buffers for the Decoder</span></span>

<span data-ttu-id="c5c4f-169">Ниже приведен общий обзор процесса шифрования и декодирования.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-169">Here is a high-level overview of the encryption and decoding process:</span></span>

1.  <span data-ttu-id="c5c4f-170">Программный декодер получает поток зашифрованных данных из источника видео.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-170">The software decoder receives a stream of encrypted data from the video source.</span></span> <span data-ttu-id="c5c4f-171">Декодер расшифровывает этот поток.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-171">The decoder decrypts this stream.</span></span>
2.  <span data-ttu-id="c5c4f-172">Программный декодер согласовывает сеансовый ключ с сеансом шифрования.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-172">The software decoder negotiates a session key with the cryptographic session.</span></span>
3.  <span data-ttu-id="c5c4f-173">Программный декодер использует прошедший проверку подлинности канал для связи криптографического сеанса с устройством декодера ДКСВА.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-173">The software decoder uses the authenticated channel to associate the cryptographic session with the DXVA decoder device.</span></span>
4.  <span data-ttu-id="c5c4f-174">Программный декодер помещает сжатые данные в буферы ДКСВА, которые он получает с устройства декодера ДКСВА (Ускоритель).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-174">The software decoder puts compressed data in DXVA buffers that it gets from the DXVA decoder device (accelerator).</span></span> <span data-ttu-id="c5c4f-175">Для защищенного содержимого кодировщик шифрует данные, помещенные в буферы ДКСВА, используя ключ сеанса для шифрования.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-175">For protected content, the software encoder encrypts the data that is puts into the DXVA buffers, using the session key for the encryption.</span></span>
    > [!Note]  
    > <span data-ttu-id="c5c4f-176">Некоторые драйверы используют ключ содержимого вместо ключа сеанса для шифрования.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-176">Some drivers use a content key, instead of the session key, for encryption.</span></span> <span data-ttu-id="c5c4f-177">Ключ содержимого может меняться от одного кадра к другому.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-177">The content key could change from one frame to the next.</span></span>

     

5.  <span data-ttu-id="c5c4f-178">Декодер отправляет зашифрованные сжатые буферы в ускоритель.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-178">The decoder submits the encrypted compressed buffers to the accelerator.</span></span> <span data-ttu-id="c5c4f-179">Для алгоритма AES-Ctrl декодер также передает вектор инициализации.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-179">For AES-CTR, the decoder also passes the initialization vector.</span></span> <span data-ttu-id="c5c4f-180">Если используется ключ содержимого, декодер передает ключ содержимого, зашифрованный с помощью ключа сеанса.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-180">If a content key is used, the decoder passes content key, encrypted using the session key.</span></span>

<span data-ttu-id="c5c4f-181">В Direct3D предусмотрена стандартная поддержка 128-разрядного алгоритма AES-CTRL, но она предназначена для расширения дополнительных типов шифрования.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-181">Direct3D has standard support for 128-bit AES-CTR, but is designed to extend to additional encryption types.</span></span>

<span data-ttu-id="c5c4f-182">Следующие пять разделов содержат более подробные инструкции.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-182">The next five sections give more detailed steps.</span></span>

-   [<span data-ttu-id="c5c4f-183">1. запросите Защита содержимого возможности драйвера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-183">1. Query the Content Protection Capabilities of the Driver</span></span>](#1-query-the-content-protection-capabilities-of-the-driver)
-   [<span data-ttu-id="c5c4f-184">2. Настройка канала, прошедшего проверку подлинности</span><span class="sxs-lookup"><span data-stu-id="c5c4f-184">2. Configure the Authenticated Channel</span></span>](#2-configure-the-authenticated-channel)
-   [<span data-ttu-id="c5c4f-185">3. Настройка сеанса шифрования</span><span class="sxs-lookup"><span data-stu-id="c5c4f-185">3. Configure the Cryptographic Session</span></span>](#3-configure-the-cryptographic-session)
-   [<span data-ttu-id="c5c4f-186">4. получение маркера для устройства декодера ДКСВА</span><span class="sxs-lookup"><span data-stu-id="c5c4f-186">4. Get a Handle to the DXVA Decoder Device</span></span>](#4-get-a-handle-to-the-dxva-decoder-device)
-   [<span data-ttu-id="c5c4f-187">5. Связывание декодера ДКСВА с криптографическим сеансом</span><span class="sxs-lookup"><span data-stu-id="c5c4f-187">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>](#5-associate-the-dxva-decoder-with-the-cryptographic-session)

### <a name="1-query-the-content-protection-capabilities-of-the-driver"></a><span data-ttu-id="c5c4f-188">1. запросите Защита содержимого возможности драйвера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-188">1. Query the Content Protection Capabilities of the Driver</span></span>

<span data-ttu-id="c5c4f-189">Прежде чем пытаться применить шифрование, получите возможности защиты содержимого драйвера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-189">Before attempting to apply encryption, get the content protection capabilities of the driver.</span></span>

1.  <span data-ttu-id="c5c4f-190">Получение указателя на устройство Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-190">Get a pointer to the Direct3D 9 device.</span></span>
2.  <span data-ttu-id="c5c4f-191">Вызовите [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) для интерфейса [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-191">Call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) for the [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) interface.</span></span>
3.  <span data-ttu-id="c5c4f-192">Вызовите [**IDirect3DDevice9Video:: жетконтентпротектионкапс**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-getcontentprotectioncaps).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-192">Call [**IDirect3DDevice9Video::GetContentProtectionCaps**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-getcontentprotectioncaps).</span></span> <span data-ttu-id="c5c4f-193">Этот метод заполняет структуру [**D3DCONTENTPROTECTIONCAPS**](/windows/desktop/api/d3d9caps/ns-d3d9caps-d3dcontentprotectioncaps) с помощью возможностей защиты содержимого драйвера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-193">This method fills in a [**D3DCONTENTPROTECTIONCAPS**](/windows/desktop/api/d3d9caps/ns-d3d9caps-d3dcontentprotectioncaps) structure with the driver’s content protection capabilities.</span></span>

<span data-ttu-id="c5c4f-194">В частности, найдите следующие возможности:</span><span class="sxs-lookup"><span data-stu-id="c5c4f-194">In particular, look for the following capabilities:</span></span>

-   <span data-ttu-id="c5c4f-195">Если элемент **Caps** содержит флаг **D3DCPCAPS_SOFTWARE** или **D3DCPCAPS_HARDWARE** , драйвер может выполнять шифрование.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-195">If the **Caps** member contains the **D3DCPCAPS_SOFTWARE** or **D3DCPCAPS_HARDWARE** flag, the driver can perform encryption.</span></span>
-   <span data-ttu-id="c5c4f-196">Член **кэйексчанжетипе** задает способ выполнения обмена ключами для ключа сеанса.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-196">The **KeyExchangeType** member specifies how to perform key exchange for the session key.</span></span>
-   <span data-ttu-id="c5c4f-197">Если элемент **Caps** содержит флаг **D3DCPCAPS_CONTENTKEY** , драйвер использует для шифрования отдельный ключ содержимого.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-197">If the **Caps** member contains the **D3DCPCAPS_CONTENTKEY** flag, the driver uses a separate content key for encryption.</span></span> <span data-ttu-id="c5c4f-198">Это важно при создании ключа сеанса.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-198">This is important when you generate the session key.</span></span>

<span data-ttu-id="c5c4f-199">Дополнительные возможности указываются в элементе « **Caps** ».</span><span class="sxs-lookup"><span data-stu-id="c5c4f-199">Additional capabilities are indicated in the **Caps** member.</span></span>

### <a name="2-configure-the-authenticated-channel"></a><span data-ttu-id="c5c4f-200">2. Настройка канала, прошедшего проверку подлинности</span><span class="sxs-lookup"><span data-stu-id="c5c4f-200">2. Configure the Authenticated Channel</span></span>

<span data-ttu-id="c5c4f-201">Следующим шагом является настройка канала, прошедшего проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-201">The next step is to configure the authenticated channel.</span></span>

1.  <span data-ttu-id="c5c4f-202">Вызовите [**IDirect3DDevice9Video:: креатеаусентикатедчаннел**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) , чтобы создать канал с проверкой подлинности.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-202">Call [**IDirect3DDevice9Video::CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) to create the authenticated channel.</span></span> <span data-ttu-id="c5c4f-203">Для параметра *чаннелтипе* укажите тип канала, соответствующий возможностям драйвера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-203">For the *ChannelType* parameter, specify a channel type that matches the capabilities of the driver.</span></span>
    -   <span data-ttu-id="c5c4f-204">Тип канала **D3DAUTHENTICATEDCHANNEL_DRIVER_SOFTWARE** соответствует **D3DCPCAPS_SOFTWARE**.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-204">The **D3DAUTHENTICATEDCHANNEL_DRIVER_SOFTWARE** channel type corresponds to **D3DCPCAPS_SOFTWARE**.</span></span>
    -   <span data-ttu-id="c5c4f-205">Тип канала **D3DAUTHENTICATEDCHANNEL_DRIVER_HARDWARE** соответствует **D3DCPCAPS_HARDWARE**.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-205">The **D3DAUTHENTICATEDCHANNEL_DRIVER_HARDWARE** channel type corresponds to **D3DCPCAPS_HARDWARE**.</span></span>

    <span data-ttu-id="c5c4f-206">Метод **креатеаусентикатедчаннел** возвращает указатель на интерфейс [**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) вместе с маркером для канала.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-206">The **CreateAuthenticatedChannel** method returns a pointer to the [**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) interface along with a handle to the channel.</span></span> <span data-ttu-id="c5c4f-207">Этот маркер используется позже для связывания сеанса шифрования с аутентифицированным каналом.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-207">The handle is used later to associate the cryptographic session with the authenticated channel.</span></span>
2.  <span data-ttu-id="c5c4f-208">Вызовите [**IDirect3DAuthenticatedChannel9:: жетцертификатесизе**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificatesize) , чтобы получить размер сертификата X. 509 драйвера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-208">Call [**IDirect3DAuthenticatedChannel9::GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificatesize) to get the size of the driver's X.509 certificate.</span></span> <span data-ttu-id="c5c4f-209">Выделение буфера требуемого размера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-209">Allocate a buffer of the required size.</span></span>
3.  <span data-ttu-id="c5c4f-210">Вызовите [**IDirect3DAuthenticatedChannel9:: Certificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificate) , чтобы получить сертификат.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-210">Call [**IDirect3DAuthenticatedChannel9::GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificate) to get the certificate.</span></span> <span data-ttu-id="c5c4f-211">Метод копирует сертификат в буфер, который был выделен на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-211">The method copies the certificate into the buffer that was allocated in the previous step.</span></span>
4.  <span data-ttu-id="c5c4f-212">Убедитесь, что сертификат драйвера был подписан корпорацией Майкрософт и не был отозван.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-212">Verify that the driver’s certificate was signed by Microsoft and has not been revoked.</span></span>
5.  <span data-ttu-id="c5c4f-213">Получите открытый ключ из сертификата.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-213">Get the public key from the certificate.</span></span>
6.  <span data-ttu-id="c5c4f-214">Создание случайного ключа сеанса RSA.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-214">Generate a random RSA session key.</span></span> <span data-ttu-id="c5c4f-215">Этот ключ сеанса используется для подписывания данных, отправляемых в канал, прошедший проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-215">This session key is used to sign data that is sent to the authenticated channel.</span></span> <span data-ttu-id="c5c4f-216">Зашифруйте сеансовый ключ с помощью открытого ключа драйвера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-216">Encrypt the session key using the driver's public key.</span></span>
7.  <span data-ttu-id="c5c4f-217">Вызовите метод [**IDirect3DAuthenticatedChannel9:: неготиатекэйексчанже**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) , чтобы отправить зашифрованный ключ сеанса драйверу.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-217">Call [**IDirect3DAuthenticatedChannel9::NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) to send the encrypted session key to the driver.</span></span>
8.  <span data-ttu-id="c5c4f-218">Инициализируйте безопасный канал следующим образом:</span><span class="sxs-lookup"><span data-stu-id="c5c4f-218">Initialize the secure channel as follows:</span></span>
    1.  <span data-ttu-id="c5c4f-219">Заполните структуру [**D3DAUTHENTICATEDCHANNEL_CONFIGUREINITIALIZE**](d3dauthenticatedchannel-configureinitialize.md) , как описано в документации.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-219">Fill in a [**D3DAUTHENTICATEDCHANNEL_CONFIGUREINITIALIZE**](d3dauthenticatedchannel-configureinitialize.md) structure as described in the documentation.</span></span>
    2.  <span data-ttu-id="c5c4f-220">Отправьте команду [**D3DAUTHENTICATEDCONFIGURE_INITIALIZE**](d3dauthenticatedconfigure-initialize.md) , вызвав [**IDirect3DAuthenticatedChannel9:: Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) , как описано в разделе [Отправка команд, прошедших проверку подлинности канала](#sending-authenticated-channel-commands).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-220">Send the [**D3DAUTHENTICATEDCONFIGURE_INITIALIZE**](d3dauthenticatedconfigure-initialize.md) command by calling [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) as described in the section [Sending Authenticated Channel Commands](#sending-authenticated-channel-commands).</span></span> <span data-ttu-id="c5c4f-221">Эта команда содержит начальные порядковые номера для команд и запросов, отправляемых в канал, прошедший проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-221">This command contains the starting sequence numbers for the commands and queries that are sent to the authenticated channel.</span></span>
9.  <span data-ttu-id="c5c4f-222">Проверьте тип канала, отправив запрос [**D3DAUTHENTICATEDQUERY_CHANNELTYPE**](d3dauthenticatedquery-channeltype.md) в канал, прошедший проверку подлинности, как описано в разделе [Отправка запросов с проверкой подлинности](#sending-authenticated-channel-queries).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-222">Verify the channel type by sending a [**D3DAUTHENTICATEDQUERY_CHANNELTYPE**](d3dauthenticatedquery-channeltype.md) query to the authenticated channel, as described in the section [Sending Authenticated Channel Queries](#sending-authenticated-channel-queries).</span></span> <span data-ttu-id="c5c4f-223">Убедитесь, что тип канала соответствует тому, что вы указали в методе [**креатеаусентикатедчаннел**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-223">Check that the channel type matches what you specified in the [**CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) method.</span></span>

### <a name="3-configure-the-cryptographic-session"></a><span data-ttu-id="c5c4f-224">3. Настройка сеанса шифрования</span><span class="sxs-lookup"><span data-stu-id="c5c4f-224">3. Configure the Cryptographic Session</span></span>

<span data-ttu-id="c5c4f-225">Затем настройте сеанс шифрования и установите ключ сеанса.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-225">Next, configure the cryptographic session and establish the session key.</span></span>

1.  <span data-ttu-id="c5c4f-226">Вызовите [**IDirect3DDevice9Video:: креатекриптосессион**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) , чтобы создать сеанс шифрования.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-226">Call [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) to create the cryptographic session.</span></span> <span data-ttu-id="c5c4f-227">Этот метод возвращает указатель на интерфейс [**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9) , а также на обработку сеанса шифрования.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-227">This method returns a pointer to the [**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9) interface and along with a handle to the cryptographic session.</span></span>
2.  <span data-ttu-id="c5c4f-228">Вызовите [**IDirect3DCryptoSession9:: жетцертификатесизе**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificatesize) , чтобы получить размер сертификата X. 509 драйвера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-228">Call [**IDirect3DCryptoSession9::GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificatesize) to get the size of the driver's X.509 certificate.</span></span> <span data-ttu-id="c5c4f-229">Выделение буфера требуемого размера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-229">Allocate a buffer of the required size.</span></span>
3.  <span data-ttu-id="c5c4f-230">Вызовите [**IDirect3DCryptoSession9:: Certificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificate) , чтобы получить сертификат.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-230">Call [**IDirect3DCryptoSession9::GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificate) to get the certificate.</span></span> <span data-ttu-id="c5c4f-231">Метод копирует сертификат в буфер, который был выделен на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-231">The method copies the certificate into the buffer that was allocated in the previous step.</span></span>
4.  <span data-ttu-id="c5c4f-232">Убедитесь, что сертификат драйвера был подписан корпорацией Майкрософт и не был отозван.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-232">Verify that the driver’s certificate was signed by Microsoft and has not been revoked.</span></span>
5.  <span data-ttu-id="c5c4f-233">Получите открытый ключ из сертификата.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-233">Get the public key from the certificate.</span></span>
6.  <span data-ttu-id="c5c4f-234">Создание случайного ключа сеанса RSA.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-234">Generate a random RSA session key.</span></span> <span data-ttu-id="c5c4f-235">Это отдельный сеансовый ключ из ключа сеанса прошедшего проверку подлинности канала.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-235">This is a separate session key from the authenticated channel session key.</span></span> <span data-ttu-id="c5c4f-236">Зашифруйте сеансовый ключ с помощью открытого ключа драйвера.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-236">Encrypt the session key using the driver's public key.</span></span>
7.  <span data-ttu-id="c5c4f-237">Вызовите метод [**IDirect3DCryptoSession9:: неготиатекэйексчанже**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) , чтобы отправить зашифрованный ключ сеанса драйверу.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-237">Call [**IDirect3DCryptoSession9::NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) to send the encrypted session key to the driver.</span></span>
8.  <span data-ttu-id="c5c4f-238">Если возможности защиты содержимого включают **D3DCPCAPS_CONTENTKEY**, создайте случайный ключ содержимого RSA.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-238">If the content protection capabilities include **D3DCPCAPS_CONTENTKEY**, create a random RSA content key.</span></span> <span data-ttu-id="c5c4f-239">Он будет использоваться позже в процессе декодирования.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-239">This will be used later in the decoding process.</span></span>

### <a name="4-get-a-handle-to-the-dxva-decoder-device"></a><span data-ttu-id="c5c4f-240">4. получение маркера для устройства декодера ДКСВА</span><span class="sxs-lookup"><span data-stu-id="c5c4f-240">4. Get a Handle to the DXVA Decoder Device</span></span>

<span data-ttu-id="c5c4f-241">Для следующего шага потребуется обработчик для устройства декодера ДКСВА.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-241">For the next step, you will need a handle to the DXVA decoder device.</span></span> <span data-ttu-id="c5c4f-242">Чтобы получить этот маркер, заполните структуру DXVA2_DecodeExecuteParams следующим образом:</span><span class="sxs-lookup"><span data-stu-id="c5c4f-242">To get this handle, fill in a DXVA2_DecodeExecuteParams structure as follows:</span></span>


```C++
HANDLE hDecodeDeviceHandle;

DXVA2_DecodeExecuteParams execParams = {0};
DXVA2_DecodeExtensionData ExtensionExecute = {0};
    
execParams.NumCompBuffers = 0;
execParams.pCompressedBuffers = NULL;
execParams.pExtensionData = &ExtensionExecute;

ExtensionExecute.Function = DXVA2_DECODE_GET_DRIVER_HANDLE;
ExtensionExecute.pPrivateInputData = NULL;
ExtensionExecute.PrivateInputDataSize = 0;
ExtensionExecute.pPrivateOutputData = &hDecodeDeviceHandle;
ExtensionExecute.PrivateOutputDataSize = sizeof(HANDLE);
```



<span data-ttu-id="c5c4f-243">Задайте для элемента **пекстенсиондата** структуры [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) адрес структуры [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-243">Set the **pExtensionData** member of the [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) structure to the address of a [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) structure.</span></span>

<span data-ttu-id="c5c4f-244">В структуре [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) задайте для члена **функции** значение **DXVA2_DECODE_GET_DRIVER_HANDLE**.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-244">In the [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) structure, set the **Function** member to **DXVA2_DECODE_GET_DRIVER_HANDLE**.</span></span> <span data-ttu-id="c5c4f-245">Задайте **пприватеаутпутдата** в качестве адреса буфера, достаточного размера для хранения значения **Handle** .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-245">Set **pPrivateOutputData** to the address of a buffer that is large enough to store a **HANDLE** value.</span></span> <span data-ttu-id="c5c4f-246">(В предыдущем примере этот буфер является переменной *хдекодедевицехандле* .)</span><span class="sxs-lookup"><span data-stu-id="c5c4f-246">(In the previous example, this buffer is the *hDecodeDeviceHandle* variable.)</span></span>

<span data-ttu-id="c5c4f-247">Затем вызовите [**идиректксвидеодекодер:: Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) и передайте адрес структуры [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-247">Then call [**IDirectXVideoDecoder::Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) and pass in the address of the [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) structure.</span></span> <span data-ttu-id="c5c4f-248">Обработчик для декодера ДКСВА возвращается в **пприватеаутпутдата**.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-248">The handle to the DXVA decoder is returned in **pPrivateOutputData**.</span></span>

### <a name="5-associate-the-dxva-decoder-with-the-cryptographic-session"></a><span data-ttu-id="c5c4f-249">5. Связывание декодера ДКСВА с криптографическим сеансом</span><span class="sxs-lookup"><span data-stu-id="c5c4f-249">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>

<span data-ttu-id="c5c4f-250">Затем свяжите устройство декодера ДКСВА с устройством Direct3D и сеансом шифрования следующим образом:</span><span class="sxs-lookup"><span data-stu-id="c5c4f-250">Next, associate the DXVA decoder device with the Direct3D device and the cryptographic session, as follows:</span></span>

1.  <span data-ttu-id="c5c4f-251">Получите маркер устройства декодера ДКСВА, как описано в предыдущем разделе.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-251">Get a handle to the DXVA decoder device, as described in the previous section.</span></span>
2.  <span data-ttu-id="c5c4f-252">Получите маркер устройства Direct3D, отправив запрос [**D3DAUTHENTICATEDQUERY_DEVICEHANDLE**](d3dauthenticatedquery-devicehandle.md) в канал, прошедший проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-252">Get a handle to the Direct3D device, by sending a [**D3DAUTHENTICATEDQUERY_DEVICEHANDLE**](d3dauthenticatedquery-devicehandle.md) query to the authenticated channel.</span></span>
3.  <span data-ttu-id="c5c4f-253">Заполните структуру [**D3DAUTHENTICATEDCHANNEL_CONFIGURECRYPTOSESSION**](d3dauthenticatedchannel-configurecryptosession.md) следующими сведениями:</span><span class="sxs-lookup"><span data-stu-id="c5c4f-253">Fill in a [**D3DAUTHENTICATEDCHANNEL_CONFIGURECRYPTOSESSION**](d3dauthenticatedchannel-configurecryptosession.md) structure with the following information:</span></span>
    -   <span data-ttu-id="c5c4f-254">Задайте для элемента **DXVA2DecodeHandle** маркер устройства декодера дксва.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-254">Set the **DXVA2DecodeHandle** member to the handle to the DXVA decoder device.</span></span>
    -   <span data-ttu-id="c5c4f-255">Задайте для элемента **криптосессионхандле** маркер сеанса шифрования.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-255">Set the **CryptoSessionHandle** member to the handle to the cryptographic session.</span></span> <span data-ttu-id="c5c4f-256">Этот маркер возвращается методом [**IDirect3DDevice9Video:: креатекриптосессион**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-256">This handle is returned by the [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) method.</span></span>
    -   <span data-ttu-id="c5c4f-257">Задайте для элемента **девицехандле** маркер устройства Direct3D.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-257">Set the **DeviceHandle** member to the Direct3D device handle.</span></span>
4.  <span data-ttu-id="c5c4f-258">Вызовите [**IDirect3DAuthenticatedChannel9:: Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) , чтобы отправить в канал, прошедший проверку подлинности, [**D3DAUTHENTICATEDCONFIGURE_CRYPTOSESSION**](d3dauthenticatedconfigure-cryptosession.md) команду.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-258">Call [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) to send a [**D3DAUTHENTICATEDCONFIGURE_CRYPTOSESSION**](d3dauthenticatedconfigure-cryptosession.md) command to the authenticated channel.</span></span>

<span data-ttu-id="c5c4f-259">На следующей схеме показан обмен дескрипторами:</span><span class="sxs-lookup"><span data-stu-id="c5c4f-259">The following diagram illustrates the exchange of handles:</span></span>

![Схема, показывающая, как декодер дксва связан с сеансом шифрования.](images/d3d9video03.png)

<span data-ttu-id="c5c4f-261">Теперь программный декодер может использовать криптографический ключ сеанса для шифрования сжатых буферов видео.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-261">The software decoder can now use the cryptographic session key to encrypt the compressed video buffers.</span></span> <span data-ttu-id="c5c4f-262">Каждый сжатый буфер будет иметь собственный вектор инициализации (IV), заданный в элементе **пвпвпстате** структуры [**DXVA2_DecodeBufferDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodebufferdesc) .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-262">Each compressed buffer will have its own initialization vector (IV) specified in the **pvPVPState** member of the [**DXVA2_DecodeBufferDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodebufferdesc) structure.</span></span>

## <a name="sending-authenticated-channel-commands"></a><span data-ttu-id="c5c4f-263">Отправка команд аутентифицированного канала</span><span class="sxs-lookup"><span data-stu-id="c5c4f-263">Sending Authenticated Channel Commands</span></span>

<span data-ttu-id="c5c4f-264">Набор команд определяется для настройки аутентифицированного канала и настройки различных параметров защиты содержимого.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-264">A set of commands are defined for configuring the authenticated channel and setting various content protections.</span></span> <span data-ttu-id="c5c4f-265">Список команд см. в разделе [Защита содержимого Commands](content-protection-commands.md).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-265">For a list of commands, see [Content Protection Commands](content-protection-commands.md).</span></span>

<span data-ttu-id="c5c4f-266">Чтобы отправить команду в канал, прошедший проверку подлинности, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-266">To send a command to the authenticated channel, perform the following steps.</span></span>

1.  <span data-ttu-id="c5c4f-267">Заполните структуру входных данных.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-267">Fill in the input data structure.</span></span> <span data-ttu-id="c5c4f-268">Эта структура данных всегда является структурой [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT**](d3dauthenticatedchannel-configure-input.md) , за которой следуют дополнительные поля.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-268">This data structure is always a [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT**](d3dauthenticatedchannel-configure-input.md) structure followed by additional fields.</span></span> <span data-ttu-id="c5c4f-269">Заполните структуру **D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT** , как показано в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-269">Fill in the **D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT** structure as shown in the following table.</span></span>

    <table>
    <colgroup>
    <col style="width: 50%" />
    <col style="width: 50%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th><span data-ttu-id="c5c4f-270">Член</span><span class="sxs-lookup"><span data-stu-id="c5c4f-270">Member</span></span></th>
    <th><span data-ttu-id="c5c4f-271">Описание</span><span class="sxs-lookup"><span data-stu-id="c5c4f-271">Description</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><span data-ttu-id="c5c4f-272"><strong>омак</strong></span><span class="sxs-lookup"><span data-stu-id="c5c4f-272"><strong>omac</strong></span></span></td>
    <td><span data-ttu-id="c5c4f-273">Пока не пропустите это поле.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-273">Skip this field for now.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="c5c4f-274"><strong>конфигуретипе</strong></span><span class="sxs-lookup"><span data-stu-id="c5c4f-274"><strong>ConfigureType</strong></span></span></td>
    <td><span data-ttu-id="c5c4f-275">Идентификатор GUID, идентифицирующий команду.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-275">GUID that identifies the command.</span></span> <span data-ttu-id="c5c4f-276">Список команд см. в разделе <a href="content-protection-commands.md">Защита содержимого Commands</a>.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-276">For a list of commands, see <a href="content-protection-commands.md">Content Protection Commands</a>.</span></span></td>
    </tr>
    <tr class="odd">
    <td><span data-ttu-id="c5c4f-277"><strong>хчаннел</strong></span><span class="sxs-lookup"><span data-stu-id="c5c4f-277"><strong>hChannel</strong></span></span></td>
    <td><span data-ttu-id="c5c4f-278">Маркер для аутентифицированного канала.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-278">The handle to the authenticated channel.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="c5c4f-279"><strong>SequenceNumber</strong></span><span class="sxs-lookup"><span data-stu-id="c5c4f-279"><strong>SequenceNumber</strong></span></span></td>
    <td><span data-ttu-id="c5c4f-280">Порядковый номер.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-280">The sequence number.</span></span> <span data-ttu-id="c5c4f-281">Первый порядковый номер задается путем отправки команды <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-281">The first sequence number is specified by sending a <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> command.</span></span> <span data-ttu-id="c5c4f-282">Каждый раз, когда вы отправляете другую команду, увеличивайте это число на 1.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-282">Each time you send another command, increment this number by 1.</span></span> <span data-ttu-id="c5c4f-283">Порядковый номер защищается от атак с использованием воспроизведения.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-283">The sequence number guards against replay attacks.</span></span>
    <blockquote>
    [!Note]<br />
<span data-ttu-id="c5c4f-284">Используются два отдельных порядковых номера: один для команд и один для запросов.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-284">Two separate sequence numbers are used, one for commands and one for queries.</span></span>
    </blockquote>
    <br/> <br/></td>
    </tr>
    </tbody>
    </table>

    

     

2.  <span data-ttu-id="c5c4f-285">Вычислите тег ОМАК для блока данных, который появляется после элемента **ОМАК** входной структуры.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-285">Calculate the OMAC tag for the block of data that appears after the **omac** member of the input structure.</span></span> <span data-ttu-id="c5c4f-286">Затем скопируйте значение этого тега в элемент **ОМАК** .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-286">Then copy this tag value into the **omac** member.</span></span>
3.  <span data-ttu-id="c5c4f-287">Вызовите [**IDirect3DAuthenticatedChannel9:: Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-287">Call [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure).</span></span>
4.  <span data-ttu-id="c5c4f-288">Драйвер помещает выходные данные команды в структуру [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_OUTPUT**](d3dauthenticatedchannel-configure-output.md) .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-288">The driver places the output from the command in the [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_OUTPUT**](d3dauthenticatedchannel-configure-output.md) structure.</span></span>
5.  <span data-ttu-id="c5c4f-289">Вычислите тег ОМАК для блока данных, который отображается после элемента **ОМАК** в выходной структуре.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-289">Calculate the OMAC tag for the block of data that appears after the **omac** member of the output structure.</span></span> <span data-ttu-id="c5c4f-290">Сравните это со значением элемента **ОМАК** .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-290">Compare this with the value of the **omac** member.</span></span> <span data-ttu-id="c5c4f-291">Завершать с ошибкой, если они не совпадают.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-291">Fail if they do not match.</span></span>
6.  <span data-ttu-id="c5c4f-292">Сравните значения элементов **конфигуретипе**, **хчаннел** и **SequenceNumber** в выходной структуре со значениями для этих элементов.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-292">Compare the values of the **ConfigureType**, **hChannel**, and **SequenceNumber** members in the output structure against your values for those members.</span></span> <span data-ttu-id="c5c4f-293">Завершать с ошибкой, если они не совпадают.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-293">Fail if they do not match.</span></span>
7.  <span data-ttu-id="c5c4f-294">Увеличение порядкового номера для следующей команды.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-294">Increment the sequence number for the next command.</span></span>

## <a name="sending-authenticated-channel-queries"></a><span data-ttu-id="c5c4f-295">Отправка запросов к каналам с проверкой подлинности</span><span class="sxs-lookup"><span data-stu-id="c5c4f-295">Sending Authenticated Channel Queries</span></span>

<span data-ttu-id="c5c4f-296">Набор запросов определяется для получения сведений о канале, прошедшем проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-296">A set of queries are defined for retrieving information about the authenticated channel.</span></span> <span data-ttu-id="c5c4f-297">Список запросов см. в разделе [запросы защита содержимого](content-protection-queries.md).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-297">For a list of queries, see [Content Protection Queries](content-protection-queries.md).</span></span>

<span data-ttu-id="c5c4f-298">Чтобы отправить команду в канал, прошедший проверку подлинности, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-298">To send a command to the authenticated channel, perform the following steps.</span></span>

1.  <span data-ttu-id="c5c4f-299">Заполните структуру входных данных.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-299">Fill in the input data structure.</span></span> <span data-ttu-id="c5c4f-300">Эта структура данных всегда является структурой [**D3DAUTHENTICATEDCHANNEL_QUERY_INPUT**](d3dauthenticatedchannel-query-input.md) , возможно, за ней следуют дополнительные поля.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-300">This data structure is always a [**D3DAUTHENTICATEDCHANNEL_QUERY_INPUT**](d3dauthenticatedchannel-query-input.md) structure, possibly followed by additional fields.</span></span> <span data-ttu-id="c5c4f-301">Заполните структуру **D3DAUTHENTICATEDCHANNEL_QUERY_INPUT** , как показано в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-301">Fill in the **D3DAUTHENTICATEDCHANNEL_QUERY_INPUT** structure as shown in the following table.</span></span>

    <table>
    <colgroup>
    <col style="width: 50%" />
    <col style="width: 50%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th><span data-ttu-id="c5c4f-302">Член</span><span class="sxs-lookup"><span data-stu-id="c5c4f-302">Member</span></span></th>
    <th><span data-ttu-id="c5c4f-303">Описание</span><span class="sxs-lookup"><span data-stu-id="c5c4f-303">Description</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><span data-ttu-id="c5c4f-304"><strong>QueryType</strong></span><span class="sxs-lookup"><span data-stu-id="c5c4f-304"><strong>QueryType</strong></span></span></td>
    <td><span data-ttu-id="c5c4f-305">Идентификатор GUID, определяющий запрос.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-305">GUID that identifies the query.</span></span> <span data-ttu-id="c5c4f-306">Список запросов см. в разделе <a href="content-protection-queries.md">запросы защита содержимого</a>.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-306">For a list of queries, see <a href="content-protection-queries.md">Content Protection Queries</a>.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="c5c4f-307"><strong>хчаннел</strong></span><span class="sxs-lookup"><span data-stu-id="c5c4f-307"><strong>hChannel</strong></span></span></td>
    <td><span data-ttu-id="c5c4f-308">Маркер для аутентифицированного канала.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-308">The handle to the authenticated channel.</span></span></td>
    </tr>
    <tr class="odd">
    <td><span data-ttu-id="c5c4f-309"><strong>SequenceNumber</strong></span><span class="sxs-lookup"><span data-stu-id="c5c4f-309"><strong>SequenceNumber</strong></span></span></td>
    <td><span data-ttu-id="c5c4f-310">Порядковый номер.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-310">The sequence number.</span></span> <span data-ttu-id="c5c4f-311">Первый порядковый номер задается путем отправки команды <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-311">The first sequence number is specified by sending a <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> command.</span></span> <span data-ttu-id="c5c4f-312">Каждый раз, когда вы отправляете другой запрос, увеличивайте это число на 1.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-312">Each time you send another query, increment this number by 1.</span></span> <span data-ttu-id="c5c4f-313">Порядковый номер защищается от атак с использованием воспроизведения.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-313">The sequence number guards against replay attacks.</span></span>
    <blockquote>
    [!Note]<br />
<span data-ttu-id="c5c4f-314">Используются два отдельных порядковых номера: один для команд и один для запросов.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-314">Two separate sequence numbers are used, one for commands and one for queries.</span></span>
    </blockquote>
    <br/> <br/></td>
    </tr>
    </tbody>
    </table>

    

     

2.  <span data-ttu-id="c5c4f-315">Вызовите [**IDirect3DAuthenticatedChannel9:: Query**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-query).</span><span class="sxs-lookup"><span data-stu-id="c5c4f-315">Call [**IDirect3DAuthenticatedChannel9::Query**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-query).</span></span>
3.  <span data-ttu-id="c5c4f-316">Драйвер помещает выходные данные запроса в структуру [**D3DAUTHENTICATEDCHANNEL_QUERY_OUTPUT**](d3dauthenticatedchannel-query-output.md) .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-316">The driver places the output from the query in a [**D3DAUTHENTICATEDCHANNEL_QUERY_OUTPUT**](d3dauthenticatedchannel-query-output.md) structure.</span></span> <span data-ttu-id="c5c4f-317">За этой структурой следуют дополнительные поля в зависимости от типа запроса.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-317">This structure is followed by additional fields, depending on the query type.</span></span>
4.  <span data-ttu-id="c5c4f-318">Вычислите тег ОМАК для блока данных, который отображается после элемента **ОМАК** в выходной структуре.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-318">Calculate the OMAC tag for the block of data that appears after the **omac** member of the output structure.</span></span> <span data-ttu-id="c5c4f-319">Сравните это со значением элемента **ОМАК** .</span><span class="sxs-lookup"><span data-stu-id="c5c4f-319">Compare this with the value of the **omac** member.</span></span> <span data-ttu-id="c5c4f-320">Завершать с ошибкой, если они не совпадают.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-320">Fail if they do not match.</span></span>
5.  <span data-ttu-id="c5c4f-321">Сравните значения элементов **конфигуретипе**, **хчаннел** и **SequenceNumber** в выходной структуре со значениями для этих элементов.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-321">Compare the values of the **ConfigureType**, **hChannel**, and **SequenceNumber** members in the output structure against your values for those members.</span></span> <span data-ttu-id="c5c4f-322">Завершать с ошибкой, если они не совпадают.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-322">Fail if they do not match.</span></span>
6.  <span data-ttu-id="c5c4f-323">Увеличение порядкового номера для следующего запроса.</span><span class="sxs-lookup"><span data-stu-id="c5c4f-323">Increment the sequence number for the next query.</span></span>

## <a name="related-topics"></a><span data-ttu-id="c5c4f-324">См. также</span><span class="sxs-lookup"><span data-stu-id="c5c4f-324">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="c5c4f-325">API-интерфейсы видео Direct3D 9</span><span class="sxs-lookup"><span data-stu-id="c5c4f-325">Direct3D 9 Video APIs</span></span>](direct3d-video-apis.md)
</dt> </dl>

 

 
