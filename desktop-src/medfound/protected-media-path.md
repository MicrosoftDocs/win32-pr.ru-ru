---
description: 'В этом разделе обсуждаются три взаимосвязанные темы: защищенная среда, шлюз взаимодействия с мультимедиа, а также отзыв и обновление.'
ms.assetid: e88806ae-0041-4b4a-a8df-69718a651e82
title: Путь к защищенному носителю
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7304edadf1623d41bc2f1f5c6b2b4cda2dd5f598
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "104555630"
---
# <a name="protected-media-path"></a><span data-ttu-id="e2872-103">Путь к защищенному носителю</span><span class="sxs-lookup"><span data-stu-id="e2872-103">Protected Media Path</span></span>

<span data-ttu-id="e2872-104">В этом разделе обсуждаются три взаимосвязанные темы: защищенная среда, шлюз взаимодействия с мультимедиа, а также отзыв и обновление.</span><span class="sxs-lookup"><span data-stu-id="e2872-104">This topic discusses three interrelated topics: protected environment, media interoperability gateway, and revocation and renewal.</span></span>

-   <span data-ttu-id="e2872-105">Защищенная среда (PE) — это набор технологий, которые позволяют защищенному содержимому передаваться из системы Windows Vista и обратно.</span><span class="sxs-lookup"><span data-stu-id="e2872-105">A protected environment (PE) is a set of technologies that enables protected content to flow from and through Windows Vista in a protected fashion.</span></span> <span data-ttu-id="e2872-106">Все компоненты в защищенной среде являются доверенными, и процесс защищен от несанкционированного доступа.</span><span class="sxs-lookup"><span data-stu-id="e2872-106">All components inside a protected environment are trusted and the process is protected against tampering.</span></span>
-   <span data-ttu-id="e2872-107">Путь к защищенному носителю (PMP) — это исполняемый файл, который выполняется в защищенной среде.</span><span class="sxs-lookup"><span data-stu-id="e2872-107">The protected media path (PMP) is an executable that runs in a protected environment.</span></span>
-   <span data-ttu-id="e2872-108">Если доверенный компонент в PE становится скомпрометированным, после завершения процесса он будет отозван.</span><span class="sxs-lookup"><span data-stu-id="e2872-108">If a trusted component in the PE becomes compromised, after due process it will be revoked.</span></span> <span data-ttu-id="e2872-109">Однако корпорация Майкрософт предоставляет механизм продления для установки более новой доверенной версии компонента, когда он станет доступным.</span><span class="sxs-lookup"><span data-stu-id="e2872-109">However, Microsoft provides a renewal mechanism to install a newer trusted version of the component when one becomes available.</span></span>

<span data-ttu-id="e2872-110">Дополнительные сведения о подписывания кода для компонентов защищенного носителя см. в техническом документе [о подписывании компонентов защищенного мультимедиа в Windows Vista](/windows-hardware/test/hlk/).</span><span class="sxs-lookup"><span data-stu-id="e2872-110">For information about code signing protected media components, see the white paper [Code Signing for Protected Media Components in Windows Vista](/windows-hardware/test/hlk/).</span></span>

<span data-ttu-id="e2872-111">В этом разделе содержатся следующие подразделы.</span><span class="sxs-lookup"><span data-stu-id="e2872-111">This topic contains the following sections:</span></span>

-   [<span data-ttu-id="e2872-112">Защищенная среда</span><span class="sxs-lookup"><span data-stu-id="e2872-112">Protected Environment</span></span>](#protected-environment)
-   [<span data-ttu-id="e2872-113">Структура защищенной среды</span><span class="sxs-lookup"><span data-stu-id="e2872-113">Design of the Protected Environment</span></span>](#design-of-the-protected-environment)
-   [<span data-ttu-id="e2872-114">Путь к защищенному носителю</span><span class="sxs-lookup"><span data-stu-id="e2872-114">Protected Media Path</span></span>](#protected-media-path)
    -   [<span data-ttu-id="e2872-115">Входные доверенные центры</span><span class="sxs-lookup"><span data-stu-id="e2872-115">Input Trust Authorities</span></span>](#input-trust-authorities)
    -   [<span data-ttu-id="e2872-116">Выходные данные доверенных центров</span><span class="sxs-lookup"><span data-stu-id="e2872-116">Output Trust Authorities</span></span>](#output-trust-authorities)
    -   [<span data-ttu-id="e2872-117">Объекты политики</span><span class="sxs-lookup"><span data-stu-id="e2872-117">Policy Objects</span></span>](#policy-objects)
    -   [<span data-ttu-id="e2872-118">Создание объектов в PMP</span><span class="sxs-lookup"><span data-stu-id="e2872-118">Creating Objects in the PMP</span></span>](#creating-objects-in-the-pmp)
-   [<span data-ttu-id="e2872-119">Общие сведения о согласовании политик</span><span class="sxs-lookup"><span data-stu-id="e2872-119">Overview of Policy Negotiation</span></span>](#overview-of-policy-negotiation)
-   [<span data-ttu-id="e2872-120">Отзыв и продление</span><span class="sxs-lookup"><span data-stu-id="e2872-120">Revocation and Renewal</span></span>](#revocation-and-renewal)
-   [<span data-ttu-id="e2872-121">Защита выходной ссылки</span><span class="sxs-lookup"><span data-stu-id="e2872-121">Output Link Protection</span></span>](#output-link-protection)
-   [<span data-ttu-id="e2872-122">См. также</span><span class="sxs-lookup"><span data-stu-id="e2872-122">Related topics</span></span>](#related-topics)

## <a name="protected-environment"></a><span data-ttu-id="e2872-123">Защищенная среда</span><span class="sxs-lookup"><span data-stu-id="e2872-123">Protected Environment</span></span>

<span data-ttu-id="e2872-124">Защита содержимого охватывает несколько технологий, каждая из которых пытается гарантировать, что содержимое не может использоваться способом, который не согласуется с намерением владельца содержимого или поставщика.</span><span class="sxs-lookup"><span data-stu-id="e2872-124">Content protection encompasses multiple technologies, each of which attempts to ensure that content cannot be used in a way that is inconsistent with the intent of the content owner or provider.</span></span> <span data-ttu-id="e2872-125">К таким технологиям относятся защита от копирования, защита канала, условный доступ и управление цифровыми правами (DRM).</span><span class="sxs-lookup"><span data-stu-id="e2872-125">These technologies include copy protection, link protection, conditional access, and digital rights management (DRM).</span></span> <span data-ttu-id="e2872-126">Основой каждого из них является доверие: доступ к содержимому предоставляется только программным компонентам, которые соответствуют условиям использования, назначенным этому содержимому.</span><span class="sxs-lookup"><span data-stu-id="e2872-126">The foundation of each is trust: Access to the content is granted only to software components that adhere to the terms of use assigned to that content.</span></span>

<span data-ttu-id="e2872-127">Чтобы избежать угроз защиты защищенного содержимого, Windows Vista и Media Foundation Software позволяют доверенному коду выполняться в защищенной среде.</span><span class="sxs-lookup"><span data-stu-id="e2872-127">To minimize threats against protected content, Windows Vista and Media Foundation Software enable trusted code to run in a protected environment.</span></span> <span data-ttu-id="e2872-128">PE — это набор компонентов, руководств и средств, предназначенных для повышения защиты от пиратства содержимого.</span><span class="sxs-lookup"><span data-stu-id="e2872-128">A PE is a set of components, guidelines, and tools designed to increase protection against content piracy.</span></span>

<span data-ttu-id="e2872-129">Прежде чем тщательно изучить PE, важно понимать, какие угрозы он разрабатывает для уменьшения.</span><span class="sxs-lookup"><span data-stu-id="e2872-129">Before examining the PE more closely, it is important to understand the threats it is designed to minimize.</span></span> <span data-ttu-id="e2872-130">Предположим, что вы используете приложение мультимедиа в процессе пользовательского режима.</span><span class="sxs-lookup"><span data-stu-id="e2872-130">Suppose you are running a media application in a user-mode process.</span></span> <span data-ttu-id="e2872-131">Приложение связывается с различными динамическими библиотеками (DLL), которые содержат подключаемые модули мультимедиа, такие как декодеры.</span><span class="sxs-lookup"><span data-stu-id="e2872-131">The application is linked to the various dynamic link libraries (DLLs) that contain media plug-ins, such as decoders.</span></span> <span data-ttu-id="e2872-132">Другие процессы также выполняются в пользовательском режиме, и в ядре загружаются различные драйверы.</span><span class="sxs-lookup"><span data-stu-id="e2872-132">Other processes are also running in user mode, and various drivers are loaded in the kernel.</span></span> <span data-ttu-id="e2872-133">Если механизм доверия отсутствует, существуют следующие угрозы.</span><span class="sxs-lookup"><span data-stu-id="e2872-133">If no trust mechanism is in place, the following threats exist:</span></span>

-   <span data-ttu-id="e2872-134">Приложение может получить доступ к защищенному носителю напрямую или взломать память процесса.</span><span class="sxs-lookup"><span data-stu-id="e2872-134">The application can access protected media directly or hack the process memory.</span></span>
-   <span data-ttu-id="e2872-135">Подключаемые модули могут получить доступ к содержимому напрямую или взломать память процесса.</span><span class="sxs-lookup"><span data-stu-id="e2872-135">Plug-ins can access the content directly or hack the process memory.</span></span>
-   <span data-ttu-id="e2872-136">Другие процессы могут взломать память процесса мультимедиа либо напрямую, либо путем внедрения кода.</span><span class="sxs-lookup"><span data-stu-id="e2872-136">Other processes can hack the media process memory either directly or by injecting code.</span></span>
-   <span data-ttu-id="e2872-137">Драйверы ядра могут заломать память процесса мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="e2872-137">Kernel drivers can hack the media process memory.</span></span>
-   <span data-ttu-id="e2872-138">Содержимое может быть отправлено за пределы системы с незащищенным носителем.</span><span class="sxs-lookup"><span data-stu-id="e2872-138">Content might be sent outside the system over an unprotected medium.</span></span> <span data-ttu-id="e2872-139">(Защита ссылок разработана для устранения этой угрозы.)</span><span class="sxs-lookup"><span data-stu-id="e2872-139">(Link protection is designed to mitigate against this threat.)</span></span>

## <a name="design-of-the-protected-environment"></a><span data-ttu-id="e2872-140">Структура защищенной среды</span><span class="sxs-lookup"><span data-stu-id="e2872-140">Design of the Protected Environment</span></span>

<span data-ttu-id="e2872-141">Защищенная среда выполняется в отдельном защищенном процессе из приложения мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="e2872-141">A protected environment runs in a separate protected process from the media application.</span></span> <span data-ttu-id="e2872-142">Функция защищенного процесса Windows Vista останавливает доступ других процессов к защищенному процессу.</span><span class="sxs-lookup"><span data-stu-id="e2872-142">The protected process feature of Windows Vista stops other processes from accessing the protected process.</span></span>

<span data-ttu-id="e2872-143">При создании защищенного процесса основные компоненты ядра определяют ненадежные компоненты и подключаемые модули, чтобы защищенная среда могла отказаться от их загрузки.</span><span class="sxs-lookup"><span data-stu-id="e2872-143">When a protected process is created, core kernel components identify untrusted components and plug-ins so that the protected environment can refuse to load them.</span></span> <span data-ttu-id="e2872-144">Доверенный компонент — это тот, который подписан корпорацией Майкрософт соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="e2872-144">A trusted component is one that has been appropriately signed by Microsoft.</span></span> <span data-ttu-id="e2872-145">Ядро также отслеживает модули, которые загружают в него, что позволяет защищенной среде прекращать воспроизведение защищенного содержимого при загрузке ненадежного модуля.</span><span class="sxs-lookup"><span data-stu-id="e2872-145">The kernel also tracks modules that load into it, enabling the protected environment to stop playback of protected content if an untrusted module is loaded.</span></span> <span data-ttu-id="e2872-146">Перед загрузкой компонента ядра ядро проверяет, является ли он доверенным.</span><span class="sxs-lookup"><span data-stu-id="e2872-146">Before a kernel component is loaded, the kernel checks to determine whether it is trusted.</span></span> <span data-ttu-id="e2872-147">В противном случае доверенные компоненты, уже наявляющиеся в PE, отказывается обрабатывать защищенное содержимое.</span><span class="sxs-lookup"><span data-stu-id="e2872-147">If it is not, trusted components already in the PE refuse to process protected content.</span></span> <span data-ttu-id="e2872-148">Чтобы включить эту функцию, компоненты PE периодически выполняют шифрование с помощью криптографического шифрования с ядром.</span><span class="sxs-lookup"><span data-stu-id="e2872-148">To enable this, PE components periodically perform a cryptographically-protected handshake with the kernel.</span></span> <span data-ttu-id="e2872-149">При наличии ненадежного компонента режима ядра подтверждение соединения завершается неудачей и сообщает PE, что ненадежный компонент существует.</span><span class="sxs-lookup"><span data-stu-id="e2872-149">If an untrusted kernel mode component is present, the handshake fails and indicates to the PE that an untrusted component exists.</span></span>

<span data-ttu-id="e2872-150">Если доверенный компонент станет скомпрометированным, после завершения процесса его можно отозвать.</span><span class="sxs-lookup"><span data-stu-id="e2872-150">If a trusted component becomes compromised, after due process it can be revoked.</span></span> <span data-ttu-id="e2872-151">Корпорация Майкрософт предоставляет механизм продления для установки более новой доверенной версии, если она доступна.</span><span class="sxs-lookup"><span data-stu-id="e2872-151">Microsoft provides a renewal mechanism to install a newer trusted version when available.</span></span>

## <a name="protected-media-path"></a><span data-ttu-id="e2872-152">Путь к защищенному носителю</span><span class="sxs-lookup"><span data-stu-id="e2872-152">Protected Media Path</span></span>

<span data-ttu-id="e2872-153">Путь к защищенному носителю (PMP) — это основной исполняемый файл PE для Media Foundation.</span><span class="sxs-lookup"><span data-stu-id="e2872-153">The protected media path (PMP) is the primary PE executable for Media Foundation.</span></span> <span data-ttu-id="e2872-154">PMP является расширяемой, поэтому можно поддерживать сторонние механизмы защиты содержимого.</span><span class="sxs-lookup"><span data-stu-id="e2872-154">The PMP is extensible, so that third-party content protection mechanisms can be supported.</span></span>

<span data-ttu-id="e2872-155">PMP принимает защищенное содержимое и связанные политики из любого источника Media Foundation с помощью любой системы защиты содержимого, включая те, которые предоставляются сторонними производителями.</span><span class="sxs-lookup"><span data-stu-id="e2872-155">The PMP accepts protected content and associated policies from any Media Foundation source using any content protection system, including those provided by third parties.</span></span> <span data-ttu-id="e2872-156">Он отправляет содержимое в любой приемник Media Foundation, если приемник соответствует политикам, указанным в источнике.</span><span class="sxs-lookup"><span data-stu-id="e2872-156">It sends content to any Media Foundation sink, as long as the sink complies with the policies specified by the source.</span></span> <span data-ttu-id="e2872-157">Он также поддерживает преобразование между источником и приемником, включая преобразования сторонних производителей, если они являются доверенными.</span><span class="sxs-lookup"><span data-stu-id="e2872-157">It also supports transforms between the source and the sink, including third-party transforms, as long as they are trusted.</span></span>

<span data-ttu-id="e2872-158">PMP выполняется в защищенном процессе, изолированном от приложения мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="e2872-158">The PMP runs in a protected process isolated from the media application.</span></span> <span data-ttu-id="e2872-159">Приложение имеет возможность обмениваться сообщениями команды и управления с PMP, но не имеет доступа к содержимому после его передачи в PMP.</span><span class="sxs-lookup"><span data-stu-id="e2872-159">The application only has the ability to exchange command and control messages with the PMP, but does not have access to content after it is passed to the PMP.</span></span> <span data-ttu-id="e2872-160">Этот процесс представлен на схеме ниже.</span><span class="sxs-lookup"><span data-stu-id="e2872-160">The following diagram illustrates this process.</span></span>

![Схема пути к защищенному носителю](images/pmp04.png)

<span data-ttu-id="e2872-162">Затененные поля представляют компоненты, которые могут быть предоставлены третьими сторонами.</span><span class="sxs-lookup"><span data-stu-id="e2872-162">Shaded boxes represent components that might be provided by third parties.</span></span> <span data-ttu-id="e2872-163">Все компоненты, созданные внутри защищенного процесса, должны быть подписаны и доверены.</span><span class="sxs-lookup"><span data-stu-id="e2872-163">All components created inside the protected process must be signed and trusted.</span></span>

<span data-ttu-id="e2872-164">Приложение создает экземпляр сеанса мультимедиа внутри защищенного процесса и получает указатель на сеанс службы прокси-сервера, который маршалирует указатели интерфейса в пределах границ процесса.</span><span class="sxs-lookup"><span data-stu-id="e2872-164">The application creates an instance of the Media Session inside the protected process and receives a pointer to a proxy Media Session, which marshals interface pointers across the process boundary.</span></span>

<span data-ttu-id="e2872-165">Источник мультимедиа можно создать в рамках процесса приложения, как показано ниже, или внутри защищенного процесса.</span><span class="sxs-lookup"><span data-stu-id="e2872-165">The media source can be created either within the application process, as shown here, or inside the protected process.</span></span> <span data-ttu-id="e2872-166">Если источник мультимедиа создается внутри процесса приложения, источник создает прокси-сервер для самого себя в защищенном процессе.</span><span class="sxs-lookup"><span data-stu-id="e2872-166">If the media source is created inside the application process, the source creates a proxy for itself in the protected process.</span></span>

<span data-ttu-id="e2872-167">Все остальные компоненты конвейера, такие как декодеры и приемники мультимедиа, создаются в защищенном процессе.</span><span class="sxs-lookup"><span data-stu-id="e2872-167">All other pipeline components, such as decoders and media sinks, are created in the protected process.</span></span> <span data-ttu-id="e2872-168">Если эти объекты предоставляют пользовательские интерфейсы для приложений, они должны предоставить прокси-сервер или заглушку DCOM для маршалирования интерфейса.</span><span class="sxs-lookup"><span data-stu-id="e2872-168">If these objects expose any custom interfaces for applications, they must provide a DCOM proxy/stub to marshal the interface.</span></span>

<span data-ttu-id="e2872-169">Чтобы применить политику к защищенному содержимому при передаче через конвейер, PMP использует три типа компонентов: входные центры сертификации (ИТАС), выходные центры доверия (Отас) и объекты политик.</span><span class="sxs-lookup"><span data-stu-id="e2872-169">To enforce policy on protected content as it flows through the pipeline, the PMP uses three types of components: input trust authorities (ITAs), output trust authorities (OTAs), and policy objects.</span></span> <span data-ttu-id="e2872-170">Эти компоненты взаимодействуют для предоставления или ограничения прав на использование содержимого, а также для указания защиты ссылок, которые должны применяться при воспроизведении содержимого, например цифровой Защита содержимого с высокой пропускной способностью.</span><span class="sxs-lookup"><span data-stu-id="e2872-170">These components work together to grant or restrict rights to use content, and to specify the link protections that must be employed when playing content, such as High-bandwidth Digital Content Protection (HDCP).</span></span>

### <a name="input-trust-authorities"></a><span data-ttu-id="e2872-171">Входные доверенные центры</span><span class="sxs-lookup"><span data-stu-id="e2872-171">Input Trust Authorities</span></span>

<span data-ttu-id="e2872-172">Значение ITA создается доверенным источником мультимедиа и выполняет несколько функций:</span><span class="sxs-lookup"><span data-stu-id="e2872-172">An ITA is created by a trusted media source, and performs several functions:</span></span>

-   <span data-ttu-id="e2872-173">Указывает права на использование содержимого.</span><span class="sxs-lookup"><span data-stu-id="e2872-173">Specifies rights to use content.</span></span> <span data-ttu-id="e2872-174">Права могут включать в себя право на воспроизведение содержимого, их перенос на устройство и т. д.</span><span class="sxs-lookup"><span data-stu-id="e2872-174">Rights can include the right to play content, transfer it to a device, and so on.</span></span> <span data-ttu-id="e2872-175">Он определяет упорядоченный список утвержденных систем защиты выходных данных и соответствующие политики вывода для каждой системы.</span><span class="sxs-lookup"><span data-stu-id="e2872-175">It defines an ordered list of approved output protection systems and the corresponding output policies for each system.</span></span> <span data-ttu-id="e2872-176">Объект ITA хранит эти сведения в объекте политики.</span><span class="sxs-lookup"><span data-stu-id="e2872-176">The ITA stores this information in a policy object.</span></span>
-   <span data-ttu-id="e2872-177">Предоставляет расшифровку, необходимую для расшифровки содержимого.</span><span class="sxs-lookup"><span data-stu-id="e2872-177">Provides the decryptor needed to decrypt the content.</span></span>
-   <span data-ttu-id="e2872-178">Устанавливает отношение доверия с модулем ядра в защищенной среде, чтобы обеспечить выполнение ITA в доверенной среде.</span><span class="sxs-lookup"><span data-stu-id="e2872-178">Establishes trust with the kernel module in the protected environment, to ensure that the ITA is running inside a trusted environment.</span></span>

<span data-ttu-id="e2872-179">ITA связывается с отдельным потоком, содержащим защищенное содержимое.</span><span class="sxs-lookup"><span data-stu-id="e2872-179">An ITA is associated with an individual stream containing protected content.</span></span> <span data-ttu-id="e2872-180">Поток может иметь только одно значение ITA, а экземпляр ITA может быть связан только с одним потоком.</span><span class="sxs-lookup"><span data-stu-id="e2872-180">A stream can have only one ITA, and an instance of an ITA can be associated with only one stream.</span></span>

### <a name="output-trust-authorities"></a><span data-ttu-id="e2872-181">Выходные данные доверенных центров</span><span class="sxs-lookup"><span data-stu-id="e2872-181">Output Trust Authorities</span></span>

<span data-ttu-id="e2872-182">OTA связан с надежным выходом.</span><span class="sxs-lookup"><span data-stu-id="e2872-182">An OTA is associated with a trusted output.</span></span> <span data-ttu-id="e2872-183">OTA предоставляет действие, которое может выполняться доверенным выходом для содержимого, например воспроизведением или копированием.</span><span class="sxs-lookup"><span data-stu-id="e2872-183">The OTA exposes an action that the trusted output can perform on the content, such as playback or copying.</span></span> <span data-ttu-id="e2872-184">Его роль заключается в применении одной или нескольких систем защиты выходных данных, необходимых для ITA.</span><span class="sxs-lookup"><span data-stu-id="e2872-184">Its role is to enforce one or more output protection systems that are required by the ITA.</span></span> <span data-ttu-id="e2872-185">OTA запрашивает объект политики, предоставленный ITA, чтобы определить, какую систему защиты необходимо применить.</span><span class="sxs-lookup"><span data-stu-id="e2872-185">The OTA queries the policy object provided by ITA to determine which protection system it must enforce.</span></span>

### <a name="policy-objects"></a><span data-ttu-id="e2872-186">Объекты политики</span><span class="sxs-lookup"><span data-stu-id="e2872-186">Policy Objects</span></span>

<span data-ttu-id="e2872-187">Объект политики инкапсулирует требования к защите содержимого от ITA.</span><span class="sxs-lookup"><span data-stu-id="e2872-187">A policy object encapsulates the content protection requirements of an ITA.</span></span> <span data-ttu-id="e2872-188">Он используется ядром политики для согласования поддержки защиты содержимого с OTA.</span><span class="sxs-lookup"><span data-stu-id="e2872-188">It is used by the policy engine to negotiate content protection support with an OTA.</span></span> <span data-ttu-id="e2872-189">Отас объекты политики запросов, чтобы определить, какие системы защиты должны быть применены к каждому выходному содержимому текущего содержимого.</span><span class="sxs-lookup"><span data-stu-id="e2872-189">OTAs query policy objects to determine what protection systems they must enforce on each output of the current content.</span></span>

### <a name="creating-objects-in-the-pmp"></a><span data-ttu-id="e2872-190">Создание объектов в PMP</span><span class="sxs-lookup"><span data-stu-id="e2872-190">Creating Objects in the PMP</span></span>

<span data-ttu-id="e2872-191">Чтобы создать объект в защищенном пути носителя (PMP), [**имфмедиасаурце**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasource) вызывает [**Имфпмфостапп:: активатеклассбид**](/windows/desktop/api/mfidl/nf-mfidl-imfpmphostapp-activateclassbyid)с указанным входным параметром **IStream** , форматированным следующим образом:</span><span class="sxs-lookup"><span data-stu-id="e2872-191">To create an object in the protected media path (PMP), the [**IMFMediaSource**](/windows/desktop/api/mfidl/nn-mfidl-imfmediasource) calls [**IMFPMPHostApp::ActivateClassById**](/windows/desktop/api/mfidl/nf-mfidl-imfpmphostapp-activateclassbyid), with the specified input **IStream** formatted in the following way:</span></span>

``` syntax
Format: (All DWORD values are serialized in little-endian order)
[GUID (content protection system guid, obtained from Windows.Media.Protection.MediaProtectionSystemId)]
[DWORD (track count, use the actual track count even if all tracks are encrypted using the same data, note that zero is invalid)]
[DWORD (next track ID, use -1 if all remaining tracks are encrypted using the same data)]
[DWORD (next track's binary data size)]
[BYTE* (next track's binary data)]
{ Repeat from "next track ID" above for each stream }
```

## <a name="overview-of-policy-negotiation"></a><span data-ttu-id="e2872-192">Общие сведения о согласовании политик</span><span class="sxs-lookup"><span data-stu-id="e2872-192">Overview of Policy Negotiation</span></span>

<span data-ttu-id="e2872-193">Чтобы защищенное содержимое можно было обрабатывать в PMP, необходимо выполнить три фундаментальных требования.</span><span class="sxs-lookup"><span data-stu-id="e2872-193">There are three fundamental requirements that must be met before protected content can be processed in the PMP.</span></span> <span data-ttu-id="e2872-194">Во первых, защищенное содержимое должно отправляться только в доверенные выходные данные.</span><span class="sxs-lookup"><span data-stu-id="e2872-194">First, protected content must be sent only to trusted outputs.</span></span> <span data-ttu-id="e2872-195">Во-вторых, только разрешенные действия должны быть применены к потоку.</span><span class="sxs-lookup"><span data-stu-id="e2872-195">Second, only permitted actions must be applied to a stream.</span></span> <span data-ttu-id="e2872-196">В-третьих, для воспроизведения потока необходимо использовать только утвержденные системы защиты выходных данных.</span><span class="sxs-lookup"><span data-stu-id="e2872-196">Third, only approved output protection systems must be used to play a stream.</span></span> <span data-ttu-id="e2872-197">Подсистема политик координирует между ИТАС и Отас, чтобы обеспечить соблюдение этих требований.</span><span class="sxs-lookup"><span data-stu-id="e2872-197">The policy engine coordinates between ITAs and OTAs to ensure that these requirements are met.</span></span>

<span data-ttu-id="e2872-198">Самый простой способ понять процесс — проанализировать упрощенный пример, который определяет шаги, необходимые для воспроизведения содержимого ASF, защищенного цифровыми Rights Management Windows Media (WMDRM).</span><span class="sxs-lookup"><span data-stu-id="e2872-198">The easiest way to understand process is to walk through a simplified example that identifies the steps necessary to play Advanced System Format (ASF) content protected by Windows Media Digital Rights Management (WMDRM).</span></span>

<span data-ttu-id="e2872-199">Когда пользователь запускает приложение проигрывателя и открывает ASF-файл с защищенным звуковым потоком и защищенным видеопотоком, необходимо выполнить следующие действия.</span><span class="sxs-lookup"><span data-stu-id="e2872-199">When a user launches a player application and opens an ASF file that has a protected audio stream and a protected video stream, the following steps must be performed:</span></span>

1.  <span data-ttu-id="e2872-200">Приложение создает источник носителя ASF и сеанс защищенного пути к носителю (PMP).</span><span class="sxs-lookup"><span data-stu-id="e2872-200">The application creates the ASF media source and the protected media path (PMP) session.</span></span> <span data-ttu-id="e2872-201">Media Foundation создает процесс PMP.</span><span class="sxs-lookup"><span data-stu-id="e2872-201">Media Foundation creates a PMP process.</span></span>
2.  <span data-ttu-id="e2872-202">Приложение создает частичную топологию, содержащую узел источника аудио, подключенный к модулю подготовки звука, и узел источника видео, подключенный к расширенному модулю обработки видео (Евр).</span><span class="sxs-lookup"><span data-stu-id="e2872-202">The application creates a partial topology that contains an audio source node connected to the audio renderer, and a video source node connected to the enhanced video renderer (EVR).</span></span> <span data-ttu-id="e2872-203">Для модулей подготовки отчетов приложение не создает модуль подготовки отчетов напрямую.</span><span class="sxs-lookup"><span data-stu-id="e2872-203">For the renderers, the application does not directly create the renderer.</span></span> <span data-ttu-id="e2872-204">Вместо этого приложение создает в незащищенном процессе объект, известный как *объект активации*.</span><span class="sxs-lookup"><span data-stu-id="e2872-204">Instead, the application creates in the unprotected process an object known as an *activation object*.</span></span> <span data-ttu-id="e2872-205">PMP использует объект активации для создания модулей подготовки отчетов в защищенном процессе.</span><span class="sxs-lookup"><span data-stu-id="e2872-205">The PMP uses the activation object to create the renderers in the protected process.</span></span> <span data-ttu-id="e2872-206">(Дополнительные сведения об объектах активации см. в разделе [объекты активации](activation-objects.md).)</span><span class="sxs-lookup"><span data-stu-id="e2872-206">(For more information about activation objects, see [Activation Objects](activation-objects.md).)</span></span>
3.  <span data-ttu-id="e2872-207">Приложение задает частичную топологию в сеансе PMP.</span><span class="sxs-lookup"><span data-stu-id="e2872-207">The application sets the partial topology on the PMP session.</span></span>
4.  <span data-ttu-id="e2872-208">Сеанс PMP сериализует топологию и передает ее в узел PMP в защищенном процессе.</span><span class="sxs-lookup"><span data-stu-id="e2872-208">The PMP session serializes the topology and passes it to the PMP host in the protected process.</span></span> <span data-ttu-id="e2872-209">Узел PMP отправляет топологию в модуль политики.</span><span class="sxs-lookup"><span data-stu-id="e2872-209">The PMP host sends the topology to the policy engine.</span></span>
5.  <span data-ttu-id="e2872-210">Загрузчик топологии вызывает [**имфинпуттрустаусорити::**](/windows/desktop/api/mfidl/nf-mfidl-imfinputtrustauthority-getdecrypter) ИТАС в и вставляет его в топологию сразу же после подчинения соответствующих исходных узлов.</span><span class="sxs-lookup"><span data-stu-id="e2872-210">The topology loader calls [**IMFInputTrustAuthority::GetDecrypter**](/windows/desktop/api/mfidl/nf-mfidl-imfinputtrustauthority-getdecrypter) on the ITAs and inserts the decrypters into the topology immediately downstream of the corresponding source nodes.</span></span>
6.  <span data-ttu-id="e2872-211">Загрузчик топологии вставляет аудио и видеодекодеры, расположенные перед узлами дешифратора.</span><span class="sxs-lookup"><span data-stu-id="e2872-211">The topology loader inserts the audio and video decoders downstream of the decrypter nodes.</span></span>
7.  <span data-ttu-id="e2872-212">Модуль политики сканирует вставленные узлы, чтобы определить, реализуют ли они интерфейс [**имфтрустедаутпут**](/windows/desktop/api/mfidl/nn-mfidl-imftrustedoutput) .</span><span class="sxs-lookup"><span data-stu-id="e2872-212">The policy engine scans the inserted nodes to determine whether any implement the [**IMFTrustedOutput**](/windows/desktop/api/mfidl/nn-mfidl-imftrustedoutput) interface.</span></span> <span data-ttu-id="e2872-213">Евр и модуль подготовки звука реализуют **имфтрустедаутпут**, так как они отправляют данные за пределами PMP.</span><span class="sxs-lookup"><span data-stu-id="e2872-213">The EVR and the audio renderer both implement **IMFTrustedOutput**, because they send data outside the PMP.</span></span>
8.  <span data-ttu-id="e2872-214">Каждый объект ITA подтверждает, что он выполняется внутри защищенного процесса, выполняя согласование криптографического соединения с модулем ядра защищенной среды.</span><span class="sxs-lookup"><span data-stu-id="e2872-214">Each ITA confirms that it is running inside a protected process by performing a cryptographic handshake with a protected environment kernel module.</span></span>
9.  <span data-ttu-id="e2872-215">Для каждого потока модуль политики согласовывает политику путем получения объекта политики из ITA и передачи его в OTA.</span><span class="sxs-lookup"><span data-stu-id="e2872-215">For each stream, the policy engine negotiates policy by getting a policy object from the ITA and passing it to the OTA.</span></span> <span data-ttu-id="e2872-216">OTA предоставляет список систем защиты, которые она поддерживает, а объект политики указывает, какие системы защиты должны быть применены вместе с правильными параметрами.</span><span class="sxs-lookup"><span data-stu-id="e2872-216">The OTA provides a list of the protection systems that it supports, and the policy object indicates which protection systems must be applied, along with the correct settings.</span></span> <span data-ttu-id="e2872-217">Затем OTA применяет эти параметры.</span><span class="sxs-lookup"><span data-stu-id="e2872-217">The OTA then applies these settings.</span></span> <span data-ttu-id="e2872-218">Если это невозможно, содержимое блокируется.</span><span class="sxs-lookup"><span data-stu-id="e2872-218">If it cannot do so, the content is blocked.</span></span>

## <a name="revocation-and-renewal"></a><span data-ttu-id="e2872-219">Отзыв и продление</span><span class="sxs-lookup"><span data-stu-id="e2872-219">Revocation and Renewal</span></span>

<span data-ttu-id="e2872-220">Доверенный компонент может быть отозван, если он подвергается компрометации или обнаруживается, чтобы нарушать лицензионные соглашения, с которым она была изначально доверенной.</span><span class="sxs-lookup"><span data-stu-id="e2872-220">A trusted component can be revoked if it becomes compromised or is discovered to be violating the license agreements under which it was initially trusted.</span></span> <span data-ttu-id="e2872-221">Для установки более новой, более надежной версии компонента существует механизм продления.</span><span class="sxs-lookup"><span data-stu-id="e2872-221">A renewal mechanism exists to install a newer, more trusted version of the component.</span></span>

<span data-ttu-id="e2872-222">Надежные компоненты подписываются с помощью криптографического сертификата.</span><span class="sxs-lookup"><span data-stu-id="e2872-222">Trusted components are signed using a cryptographic certificate.</span></span> <span data-ttu-id="e2872-223">Корпорация Майкрософт публикует Глобальный список отзыва (GRL), который определяет отозванные компоненты.</span><span class="sxs-lookup"><span data-stu-id="e2872-223">Microsoft publishes a global revocation list (GRL) which identifies components that have been revoked.</span></span> <span data-ttu-id="e2872-224">GRL имеет цифровую подпись, чтобы обеспечить его подлинность.</span><span class="sxs-lookup"><span data-stu-id="e2872-224">The GRL is digitally signed to ensure its authenticity.</span></span> <span data-ttu-id="e2872-225">Владельцы содержимого могут гарантировать, что в механизме политики текущая версия GRL установлена на компьютере пользователя.</span><span class="sxs-lookup"><span data-stu-id="e2872-225">Content owners can ensure, through the policy mechanism, that the current version of the GRL is present on the user's computer.</span></span>

## <a name="output-link-protection"></a><span data-ttu-id="e2872-226">Защита выходной ссылки</span><span class="sxs-lookup"><span data-stu-id="e2872-226">Output Link Protection</span></span>

<span data-ttu-id="e2872-227">При просмотре содержимого видео уровня "Премиум" расшифрованные несжатые кадры перемещаются по физическому соединителю на устройство отображения.</span><span class="sxs-lookup"><span data-stu-id="e2872-227">When premium video content is viewed, the decrypted, uncompressed frames travel across a physical connector to the display device.</span></span> <span data-ttu-id="e2872-228">Поставщики содержимого могут потребовать, чтобы на этом этапе были защищены кадры видео, так как они перемещаются по физическому соединителю.</span><span class="sxs-lookup"><span data-stu-id="e2872-228">Content providers may require the video frames to be protected at this point, as they travel across the physical connector.</span></span> <span data-ttu-id="e2872-229">Для этой цели существуют различные механизмы защиты, в том числе High-Bandwidth цифровые Защита содержимого (HDCP) и Дисплайпорт Защита содержимого (ДПКП).</span><span class="sxs-lookup"><span data-stu-id="e2872-229">Various protection mechanisms exist for this purpose, including High-Bandwidth Digital Content Protection (HDCP) and DisplayPort Content Protection (DPCP).</span></span> <span data-ttu-id="e2872-230">Видеоадаптер беспроводной связи применяет эти средства защиты с помощью [Output Protection Manager](output-protection-manager.md) (ОПМ).</span><span class="sxs-lookup"><span data-stu-id="e2872-230">The video OTA enforces these protections by using the [Output Protection Manager](output-protection-manager.md) (OPM).</span></span> <span data-ttu-id="e2872-231">Диспетчер выходной защиты отправляет команды драйверу графики, а графический драйвер применяет все механизмы защиты ссылок, необходимые для политики.</span><span class="sxs-lookup"><span data-stu-id="e2872-231">The Output Protection Manager sends commands to the graphics driver, and the graphics driver enforces whatever link protection mechanisms are required by the policy.</span></span>

![Схема, показывающая отношение между видео OTA и ОПМ.](images/pmp05.png)

## <a name="related-topics"></a><span data-ttu-id="e2872-233">См. также</span><span class="sxs-lookup"><span data-stu-id="e2872-233">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="e2872-234">О Media Foundation</span><span class="sxs-lookup"><span data-stu-id="e2872-234">About Media Foundation</span></span>](about-the-media-foundation-sdk.md)
</dt> <dt>

[<span data-ttu-id="e2872-235">Архитектура Media Foundation</span><span class="sxs-lookup"><span data-stu-id="e2872-235">Media Foundation Architecture</span></span>](media-foundation-architecture.md)
</dt> <dt>

[<span data-ttu-id="e2872-236">Защита содержимого на основе GPU</span><span class="sxs-lookup"><span data-stu-id="e2872-236">GPU-Based Content Protection</span></span>](gpu-based-content-protection.md)
</dt> <dt>

[<span data-ttu-id="e2872-237">Диспетчер выходной защиты</span><span class="sxs-lookup"><span data-stu-id="e2872-237">Output Protection Manager</span></span>](output-protection-manager.md)
</dt> <dt>

[<span data-ttu-id="e2872-238">Сеанс PMP мультимедиа</span><span class="sxs-lookup"><span data-stu-id="e2872-238">PMP Media Session</span></span>](pmp-media-session.md)
</dt> </dl>

 

 
