---
description: В этом разделе описывается написание пользовательского обработчика свойств оболочки для Microsoft Media Foundation источника мультимедиа.
ms.assetid: f8cf70ff-8324-4308-8adf-a145aa351ca9
title: Пользовательские поставщики метаданных для файлов мультимедиа
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a2ded77492d03f7b802f6b2f9c25e1009ef97f50
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "105720039"
---
# <a name="custom-metadata-providers-for-media-files"></a><span data-ttu-id="f2624-103">Пользовательские поставщики метаданных для файлов мультимедиа</span><span class="sxs-lookup"><span data-stu-id="f2624-103">Custom Metadata Providers for Media Files</span></span>

<span data-ttu-id="f2624-104">В этом разделе описывается написание пользовательского обработчика свойств оболочки для Microsoft Media Foundation источника мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="f2624-104">This topic describes how to write a custom Shell property handler for a Microsoft Media Foundation media source.</span></span>

> [!Note]  
> <span data-ttu-id="f2624-105">Общие сведения о поставщиках метаданных в Media Foundation см. в разделе [метаданные носителя](media-metadata.md).</span><span class="sxs-lookup"><span data-stu-id="f2624-105">For background information about metadata providers in Media Foundation, see [Media Metadata](media-metadata.md).</span></span> <span data-ttu-id="f2624-106">В этом разделе обсуждаются обработчики свойств оболочки. Он не описывает интерфейс метаданных версии 1, [**имфметадата**](/windows/desktop/api/mfidl/nn-mfidl-imfmetadata).</span><span class="sxs-lookup"><span data-stu-id="f2624-106">This topic discusses Shell property handlers; it does not describe the version 1 metadata interface, [**IMFMetadata**](/windows/desktop/api/mfidl/nn-mfidl-imfmetadata).</span></span>

 

<span data-ttu-id="f2624-107">Метаданные тесно связаны с форматом файла.</span><span class="sxs-lookup"><span data-stu-id="f2624-107">Metadata is closely tied to the format of the file.</span></span> <span data-ttu-id="f2624-108">В Media Foundation форматы файлов представлены источниками мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="f2624-108">In Media Foundation, file formats are represented by media sources.</span></span> <span data-ttu-id="f2624-109">Если требуется поддержка метаданных для формата, который не поддерживается изначально в Media Foundation, необходимо реализовать пользовательский источник мультимедиа с помощью обработчика свойств.</span><span class="sxs-lookup"><span data-stu-id="f2624-109">If you want to support metadata for a format that is not supported natively in Media Foundation, you must implement a custom media source with a property handler.</span></span> <span data-ttu-id="f2624-110">Обработчик свойств позволяет системе свойств оболочки эффективно считывать и записывать метаданные.</span><span class="sxs-lookup"><span data-stu-id="f2624-110">The property handler enables the Shell property system to read and write metadata efficiently.</span></span>

<span data-ttu-id="f2624-111">Обработчик свойства — это COM-объект, реализующий следующие интерфейсы:</span><span class="sxs-lookup"><span data-stu-id="f2624-111">A property handler is a COM object that implements the following interfaces:</span></span>

-   [<span data-ttu-id="f2624-112">**IInitializeWithStream**</span><span class="sxs-lookup"><span data-stu-id="f2624-112">**IInitializeWithStream**</span></span>](/windows/win32/api/propsys/nn-propsys-iinitializewithstream)
-   [<span data-ttu-id="f2624-113">**ипропертисторе**</span><span class="sxs-lookup"><span data-stu-id="f2624-113">**IPropertyStore**</span></span>](/windows/win32/api/propsys/nn-propsys-ipropertystore)

<span data-ttu-id="f2624-114">При необходимости он также может предоставить следующий интерфейс:</span><span class="sxs-lookup"><span data-stu-id="f2624-114">Optionally, it can also expose the following interface:</span></span>

-   [<span data-ttu-id="f2624-115">**ипропертисторекапабилитиес**</span><span class="sxs-lookup"><span data-stu-id="f2624-115">**IPropertyStoreCapabilities**</span></span>](/windows/win32/api/propsys/nn-propsys-ipropertystorecapabilities)

<span data-ttu-id="f2624-116">Если системе свойств оболочки необходимо получить метаданные для файла, он вызывает [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) для создания обработчика свойств, а затем вызывает соответствующие методы чтения и записи в интерфейсе [**ипропертисторе**](/windows/win32/api/propsys/nn-propsys-ipropertystore) .</span><span class="sxs-lookup"><span data-stu-id="f2624-116">If the Shell property system needs to get metadata for a file, it calls [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) to create the property handler and then calls the appropriate read and write methods on the [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) interface.</span></span>

<span data-ttu-id="f2624-117">Конвейер Media Foundation использует несколько иной механизм, так как конвейер получает обработчик свойств непосредственно из источника мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="f2624-117">The Media Foundation pipeline uses a slightly different mechanism, because the pipeline gets the property handler directly from the media source.</span></span> <span data-ttu-id="f2624-118">Вместо вызова [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) для создания обработчика свойств конвейер вызывает [**Имфжетсервице:: WebService**](/windows/desktop/api/mfidl/nf-mfidl-imfgetservice-getservice) в источнике мультимедиа, как описано в разделе [поставщики метаданных оболочки](shell-metadata-providers.md).</span><span class="sxs-lookup"><span data-stu-id="f2624-118">Instead of calling [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) to create the property handler, the pipeline calls [**IMFGetService::GetService**](/windows/desktop/api/mfidl/nf-mfidl-imfgetservice-getservice) on the media source, as described in the topic [Shell Metadata Providers](shell-metadata-providers.md).</span></span>

<span data-ttu-id="f2624-119">Чтобы создать пользовательский обработчик свойства, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="f2624-119">To create a custom property handler, do the following:</span></span>

-   <span data-ttu-id="f2624-120">Реализуйте интерфейс [**имфжетсервице**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice) , чтобы предоставить [**ипропертисторе**](/windows/win32/api/propsys/nn-propsys-ipropertystore).</span><span class="sxs-lookup"><span data-stu-id="f2624-120">Implement the [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice) interface to expose [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore).</span></span> <span data-ttu-id="f2624-121">GUID службы — это **\_ \_ \_ Служба обработчика свойств MF**.</span><span class="sxs-lookup"><span data-stu-id="f2624-121">The service GUID is **MF\_PROPERTY\_HANDLER\_SERVICE**.</span></span>
-   <span data-ttu-id="f2624-122">Если источник мультимедиа будет использоваться удаленно, он должен также предоставлять интерфейс [**ипропертисторе**](/windows/win32/api/propsys/nn-propsys-ipropertystore) через метод **QueryInterface** источника мультимедиа в дополнение к [**имфжетсервице**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice).</span><span class="sxs-lookup"><span data-stu-id="f2624-122">If the media source will be used remotely, it must also expose the [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) interface through the media source's **QueryInterface** method, in addition to [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice).</span></span>
-   <span data-ttu-id="f2624-123">Чтобы сделать обработчик свойств доступным системе свойств оболочки, зарегистрируйте библиотеку DLL для обработчика свойства, как описано в статье [Регистрация и распространение обработчиков свойств](../properties/prophand-reg-dist.md).</span><span class="sxs-lookup"><span data-stu-id="f2624-123">To make the property handler available to the Shell property system, register the DLL for the property handler as described in [Registering and Distributing Property Handlers](../properties/prophand-reg-dist.md).</span></span>
-   <span data-ttu-id="f2624-124">Источник мультимедиа регистрируется отдельно, как описано в разделе [обработчики схем и обработчики Byte-Stream](scheme-handlers-and-byte-stream-handlers.md).</span><span class="sxs-lookup"><span data-stu-id="f2624-124">The media source is registered separately, as described in [Scheme Handlers and Byte-Stream Handlers](scheme-handlers-and-byte-stream-handlers.md).</span></span>

### <a name="implementation-tips"></a><span data-ttu-id="f2624-125">Советы по реализации</span><span class="sxs-lookup"><span data-stu-id="f2624-125">Implementation Tips</span></span>

<span data-ttu-id="f2624-126">Список ключей свойств метаданных см. в разделе [Свойства метаданных для файлов мультимедиа](metadata-properties-for-media-files.md).</span><span class="sxs-lookup"><span data-stu-id="f2624-126">For a list of metadata property keys, see [Metadata Properties for Media Files](metadata-properties-for-media-files.md).</span></span>

<span data-ttu-id="f2624-127">Обработчики свойств должны быть быстрыми; они должны предоставлять эффективный доступ для чтения и записи к метаданным.</span><span class="sxs-lookup"><span data-stu-id="f2624-127">Property handlers must be fast; they must provide efficient read and write access to the metadata.</span></span> <span data-ttu-id="f2624-128">(Рассмотрим, что оболочка может извлекать метаданные из сотен файлов.) Поэтому не вызывайте [**мфстартуп**](/windows/desktop/api/mfapi/nf-mfapi-mfstartup) из обработчика свойств.</span><span class="sxs-lookup"><span data-stu-id="f2624-128">(Consider that the Shell may retrieve metadata from hundreds of files.) Therefore, do not call [**MFStartup**](/windows/desktop/api/mfapi/nf-mfapi-mfstartup) from your property handler.</span></span> <span data-ttu-id="f2624-129">Функция **мфстартуп** вводит задержку при запуске, так как создает несколько потоков рабочей очереди и выделяет глобальную память.</span><span class="sxs-lookup"><span data-stu-id="f2624-129">The **MFStartup** function introduces startup latency, because it creates multiple work-queue threads and allocates global memory.</span></span>

<span data-ttu-id="f2624-130">В типичной реализации обработчик свойств и источник мультимедиа будут совместно использовать один и тот же код анализа.</span><span class="sxs-lookup"><span data-stu-id="f2624-130">In a typical implementation, the property handler and the media source will share some of the same parsing code.</span></span> <span data-ttu-id="f2624-131">Однако источник мультимедиа использует асинхронные вызовы [**имфбитестреам**](/windows/desktop/api/mfobjects/nn-mfobjects-imfbytestream) для операций ввода-вывода, тогда как обработчик свойств использует интерфейс [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) .</span><span class="sxs-lookup"><span data-stu-id="f2624-131">However, a media source uses asynchronous [**IMFByteStream**](/windows/desktop/api/mfobjects/nn-mfobjects-imfbytestream) calls for I/O, whereas the property handler uses the [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) interface.</span></span> <span data-ttu-id="f2624-132">Media Foundation предоставляет вспомогательный объект, который создает оболочку для потока на основе **IStream** и предоставляет его в виде потока **имфбитестреам** .</span><span class="sxs-lookup"><span data-stu-id="f2624-132">Media Foundation provides a helper object that wraps an **IStream**-based stream and exposes it as an **IMFByteStream** stream.</span></span> <span data-ttu-id="f2624-133">Чтобы создать оболочку, вызовите [**мфкреатемфбитестреамонстреам**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatemfbytestreamonstream).</span><span class="sxs-lookup"><span data-stu-id="f2624-133">To create the wrapper, call [**MFCreateMFByteStreamOnStream**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatemfbytestreamonstream).</span></span>

<span data-ttu-id="f2624-134">При обновлении метаданных рекомендуется записывать данные непосредственно в исходный поток.</span><span class="sxs-lookup"><span data-stu-id="f2624-134">When updating metadata, it is recommended to write the data directly to the original stream.</span></span> <span data-ttu-id="f2624-135">Эта рекомендация отличается от поведения *копирования при записи* большинства обработчиков свойств, в которых изменяется копия данных.</span><span class="sxs-lookup"><span data-stu-id="f2624-135">This recommendation differs from the *copy-on-write* behavior of most property handlers, in which a copy of the data is modified.</span></span> <span data-ttu-id="f2624-136">Файлы мультимедиа могут быть очень большими, поэтому операция копирования при записи обычно слишком мала для эффективной реализации.</span><span class="sxs-lookup"><span data-stu-id="f2624-136">Media files can be very large, so copy-on-write is typically too slow for an efficient implementation.</span></span> <span data-ttu-id="f2624-137">Чтобы отключить копирование при записи, задайте параметр реестра **мануалсафесаве** , как описано в статье [Регистрация и распространение обработчиков свойств](../properties/prophand-reg-dist.md).</span><span class="sxs-lookup"><span data-stu-id="f2624-137">To disable copy-on-write, set the **ManualSafeSave** registry setting, as described in [Registering and Distributing Property Handlers](../properties/prophand-reg-dist.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="f2624-138">См. также</span><span class="sxs-lookup"><span data-stu-id="f2624-138">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="f2624-139">Метаданные мультимедиа</span><span class="sxs-lookup"><span data-stu-id="f2624-139">Media Metadata</span></span>](media-metadata.md)
</dt> <dt>

[<span data-ttu-id="f2624-140">Источники мультимедиа</span><span class="sxs-lookup"><span data-stu-id="f2624-140">Media Sources</span></span>](media-sources.md)
</dt> <dt>

[<span data-ttu-id="f2624-141">Запись пользовательского источника мультимедиа</span><span class="sxs-lookup"><span data-stu-id="f2624-141">Writing a Custom Media Source</span></span>](writing-a-custom-media-source.md)
</dt> </dl>

 

 
