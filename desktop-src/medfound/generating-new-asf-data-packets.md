---
description: Создание новых пакетов данных ASF
ms.assetid: 7afa9694-c965-40e2-8549-e32ff48def2a
title: Создание новых пакетов данных ASF
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 78f3432ecf34c58247a1533adb202b75f59d770c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104496806"
---
# <a name="generating-new-asf-data-packets"></a><span data-ttu-id="5081f-103">Создание новых пакетов данных ASF</span><span class="sxs-lookup"><span data-stu-id="5081f-103">Generating New ASF Data Packets</span></span>

<span data-ttu-id="5081f-104">*МУЛЬТИПЛЕКСОР* ASF — это компонент уровня вмконтаинер, который работает с [объектом данных ASF](asf-file-structure.md) и дает приложению возможность создавать пакеты данных ASF для потока, соответствующие требованиям, определенным в объекте контентинфо.</span><span class="sxs-lookup"><span data-stu-id="5081f-104">The ASF *multiplexer* is a WMContainer layer component that works with the [ASF Data Object](asf-file-structure.md) and gives an application the ability to generate ASF data packets for a stream that match the requirements defined in the ContentInfo object.</span></span>

<span data-ttu-id="5081f-105">Мультиплексор имеет один вход и один выход.</span><span class="sxs-lookup"><span data-stu-id="5081f-105">The multiplexer has one input and one output.</span></span> <span data-ttu-id="5081f-106">Он получает пример потока, который содержит цифровые данные мультимедиа и создает один или несколько пакетов данных, которые могут быть записаны в контейнер ASF.</span><span class="sxs-lookup"><span data-stu-id="5081f-106">It receives a stream sample that contains digital media data and produces one or more data packet that can be written to an ASF container.</span></span>

<span data-ttu-id="5081f-107">В следующем списке обобщены процессы создания пакетов данных ASF.</span><span class="sxs-lookup"><span data-stu-id="5081f-107">The following list summarizes the process of generating ASF data packets:</span></span>

1.  <span data-ttu-id="5081f-108">Передайте входные данные в мультиплексор в [**имфасфмултиплексер::P роцесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="5081f-108">Pass input data to the multiplexer in [**IMFASFMultiplexer::ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span>
2.  <span data-ttu-id="5081f-109">Собирайте пакеты данных путем вызова [**имфасфмултиплексер:: жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) в цикле до тех пор, пока не будут получены все полные пакеты.</span><span class="sxs-lookup"><span data-stu-id="5081f-109">Collect the data packets by calling [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop until all the complete packets have been retrieved.</span></span>
3.  <span data-ttu-id="5081f-110">После преобразования входных данных в полные пакеты в мультиплексоре могут быть ожидающие данные, которые не были получены [**жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span><span class="sxs-lookup"><span data-stu-id="5081f-110">After the input data has been converted into complete packets there might be some pending data in the multiplexer, which was not retrieved by [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span></span> <span data-ttu-id="5081f-111">Вызовите [**имфасфмултиплексер:: Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) , чтобы паккетизе ожидающие выборки и получить их из мультиплексора, вызвав **жетнекстпаккет** еще раз.</span><span class="sxs-lookup"><span data-stu-id="5081f-111">Call [**IMFASFMultiplexer::Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) to packetize the pending samples and collect them from the multiplexer by calling **GetNextPacket** again.</span></span>
4.  <span data-ttu-id="5081f-112">Обновите соответствующие объекты заголовка ASF, вызвав [**имфасфмултиплексер:: end**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) , чтобы отразить изменения, внесенные мультиплексором во время создания пакета данных.</span><span class="sxs-lookup"><span data-stu-id="5081f-112">Update the associated ASF Header Objects by calling [**IMFASFMultiplexer::End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) to reflect changes made by the multiplexer during data packet generation.</span></span>

<span data-ttu-id="5081f-113">На следующей схеме показана генерация пакетов данных для ASF-файла с помощью мультиплексора.</span><span class="sxs-lookup"><span data-stu-id="5081f-113">The following diagram illustrates data packet generation for an ASF file through the multiplexer.</span></span>

![Диаграмма, показывающая создание пакетов данных для файла ASF](images/packet.gif)

## <a name="asf-data-packet-creation"></a><span data-ttu-id="5081f-115">Создание пакета данных ASF</span><span class="sxs-lookup"><span data-stu-id="5081f-115">ASF Data Packet Creation</span></span>

<span data-ttu-id="5081f-116">После создания и инициализации мультиплексора, как описано в разделе [Создание объекта мультиплексора](creating-the-multiplexer-object.md), вызовите [**Имфасфмултиплексер::P роцесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) , чтобы передать входные данные мультиплексору для обработки в пакеты данных.</span><span class="sxs-lookup"><span data-stu-id="5081f-116">After creating and initializing the multiplexer as described in [Creating the Multiplexer Object](creating-the-multiplexer-object.md), call [**IMFASFMultiplexer::ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) to pass input data to the multiplexer for processing into data packets.</span></span> <span data-ttu-id="5081f-117">Указанные входные данные должны находиться в образце носителя (интерфейс [**имфсампле**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) ), который может иметь один или несколько буферов мультимедиа (интерфейс [**имфмедиабуффер**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) ), содержащих данные для потока.</span><span class="sxs-lookup"><span data-stu-id="5081f-117">The specified input must be in a media sample ([**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) interface) that can have one or more media buffers ([**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) interface) containing the data for a stream.</span></span> <span data-ttu-id="5081f-118">В случае перекодировки ASF-в ASF пример входного носителя можно создать из разделителя, который создает пакетные образцы потока.</span><span class="sxs-lookup"><span data-stu-id="5081f-118">In case of ASF-to-ASF transcoding, the input media sample can be generated from the splitter that creates packetized stream samples.</span></span> <span data-ttu-id="5081f-119">Дополнительные сведения см. в статье [Разделитель ASF](asf-splitter.md).</span><span class="sxs-lookup"><span data-stu-id="5081f-119">For more information, see [ASF Splitter](asf-splitter.md).</span></span>

<span data-ttu-id="5081f-120">Перед вызовом [**процесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample)убедитесь, что метка времени примера входного носителя является допустимым временем презентации. в противном случае **процесссампле** завершается с ошибкой и возвращает \_ \_ \_ \_ код отметок времени в виде MF E без примера.</span><span class="sxs-lookup"><span data-stu-id="5081f-120">Before calling [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample), make sure that the time stamp of the input media sample is a valid presentation time; otherwise **ProcessSample** fails and returns the MF\_E\_NO\_SAMPLE\_TIMESTAMP code.</span></span>

<span data-ttu-id="5081f-121">Мультиплексор может принимать входные данные в виде сжатых или несжатых примеров мультимедиа через [**процесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="5081f-121">The multiplexer can accept input as compressed or uncompressed media samples through [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span> <span data-ttu-id="5081f-122">Мультиплексор назначает время отправки этим образцам в зависимости от использования пропускной способности потока.</span><span class="sxs-lookup"><span data-stu-id="5081f-122">The multiplexer assigns send times to these samples depending on the bandwidth usage of the stream.</span></span> <span data-ttu-id="5081f-123">Во время этого процесса мультиплексор проверяет параметры сегмента утечки (скорость потока и использование окна буфера) и может отклонить выборки, которые не соответствуют этим значениям.</span><span class="sxs-lookup"><span data-stu-id="5081f-123">During this process, the multiplexer checks the leaky bucket parameters (bit rate and buffer window utilization) and can reject samples that do not adhere to those values.</span></span> <span data-ttu-id="5081f-124">Пример входного носителя может привести к сбою проверки пропускной способности по одной из следующих причин:</span><span class="sxs-lookup"><span data-stu-id="5081f-124">The input media sample can fail the bandwidth check for either of the following reasons:</span></span>

-   <span data-ttu-id="5081f-125">Если пример входного носителя поступил в конец, так как время последней назначенной отправки превышает метку времени на этом примере носителя.</span><span class="sxs-lookup"><span data-stu-id="5081f-125">If the input media sample arrived late because the last-assigned send time is greater than the time stamp on this media sample.</span></span> <span data-ttu-id="5081f-126">[**Процесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) завершается сбоем и возвращает код ошибки **MF \_ E \_ \_ опоздания** .</span><span class="sxs-lookup"><span data-stu-id="5081f-126">[**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) fails and returns the **MF\_E\_LATE\_SAMPLE** error code.</span></span>
-   <span data-ttu-id="5081f-127">Если метка времени на примере входного носителя предшествует назначенному времени отправки (это указывает на переполнение буфера).</span><span class="sxs-lookup"><span data-stu-id="5081f-127">If the time stamp on the input media sample is earlier than the assigned send time (this indicates buffer overflow).</span></span> <span data-ttu-id="5081f-128">Мультиплексор может игнорировать эту ситуацию, если она настроена для корректировки скорости, задав флаг **\_ \_ автонастройки \_ мультиплексора мфасф** в процессе инициализации мультиплексора.</span><span class="sxs-lookup"><span data-stu-id="5081f-128">The multiplexer can ignore this situation if it is configured to adjust the bit rate by setting the **MFASF\_MULTIPLEXER\_AUTOADJUST\_BITRATE** flag during multiplexer initialization.</span></span> <span data-ttu-id="5081f-129">Дополнительные сведения см. в разделе "Инициализация мультиплексора и параметры сегмента утечки" раздела [Создание объекта мультиплексора](creating-the-multiplexer-object.md).</span><span class="sxs-lookup"><span data-stu-id="5081f-129">For more information, see "Multiplexer Initialization and Leaky Bucket Settings" in [Creating the Multiplexer Object](creating-the-multiplexer-object.md).</span></span> <span data-ttu-id="5081f-130">Если этот флаг не установлен и мультиплексор встречает перерасход полосы пропускания, [**процесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) завершается сбоем и возвращает код ошибки **\_ \_ \_ переполнения пропускной способности MF E** .</span><span class="sxs-lookup"><span data-stu-id="5081f-130">If this flag is not set and the multiplexer encounters bandwidth overrun, [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) fails and returns the **MF\_E\_BANDWIDTH\_OVERRUN** error code.</span></span>

<span data-ttu-id="5081f-131">После того как мультиплексор назначает время отправки, пример входного носителя добавляется в *окно отправки*— список примеров входного носителя, упорядоченный по времени отправки и готовых к обработке в пакетах данных.</span><span class="sxs-lookup"><span data-stu-id="5081f-131">After the multiplexer assigns the send time, the input media sample is added to the *send window*—a list of input media samples ordered by send times and ready to be processed into data packets.</span></span> <span data-ttu-id="5081f-132">Во время создания пакета данных пример входного носителя анализируется, и соответствующие данные записываются в пакет данных в качестве полезных данных.</span><span class="sxs-lookup"><span data-stu-id="5081f-132">During data packet construction, the input media sample is parsed and relevant data is written to a data packet as payload.</span></span> <span data-ttu-id="5081f-133">Полный пакет данных может содержать данные из одного или нескольких примеров входного носителя.</span><span class="sxs-lookup"><span data-stu-id="5081f-133">A complete data packet can contain data from one or more input media samples.</span></span>

<span data-ttu-id="5081f-134">Когда новые образцы входных данных поступают в окно отправки, они добавляются в очередь до тех пор, пока не появится достаточное количество образцов носителя для формирования одного полного пакета.</span><span class="sxs-lookup"><span data-stu-id="5081f-134">When new input media samples arrive in the send window, they are added to a queue until there are enough media samples to form one complete packet.</span></span> <span data-ttu-id="5081f-135">Данные в буферах мультимедиа, содержащиеся в примере входного носителя, не копируются в созданный пакет данных.</span><span class="sxs-lookup"><span data-stu-id="5081f-135">The data in media buffers contained by the input media sample are not copied to the generated data packet.</span></span> <span data-ttu-id="5081f-136">Пакет данных хранит ссылки на входные буферы носителей до тех пор, пока не будет полностью Пакетирован пример входного носителя и не будет получен полный пакет из мультиплексора.</span><span class="sxs-lookup"><span data-stu-id="5081f-136">The data packet hold references to the input media buffers until the input media sample has been fully packetized and the complete packet have been collected from the multiplexer.</span></span>

<span data-ttu-id="5081f-137">Если доступен полный пакет данных, его можно получить, вызвав [**имфасфмултиплексер:: жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span><span class="sxs-lookup"><span data-stu-id="5081f-137">When a complete data packet is available, it can be retrieved by calling [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span></span> <span data-ttu-id="5081f-138">Если вы вызовите [**процесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) , когда готовые пакеты будут подготовлены к извлечению, происходит сбой и возвращается код ошибки **MF \_ E \_ нотакцептинг** .</span><span class="sxs-lookup"><span data-stu-id="5081f-138">If you call [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) while there are complete packets ready for retrieval, it fails and returns the **MF\_E\_NOTACCEPTING** error code.</span></span> <span data-ttu-id="5081f-139">Это означает, что мультиплексор не может принимать больше входных данных, и для получения ожидающих пакетов необходимо вызвать **жетнекстпаккет** .</span><span class="sxs-lookup"><span data-stu-id="5081f-139">This indicates that the multiplexer cannot accept more input and you must call **GetNextPacket** to retrieve the waiting packets.</span></span> <span data-ttu-id="5081f-140">В идеале, за каждым вызовом **процесссампле** должен следовать один или несколько вызовов **жетнекстпаккет** для получения полных пакетов данных.</span><span class="sxs-lookup"><span data-stu-id="5081f-140">Ideally, every **ProcessSample** call should be followed by one or more **GetNextPacket** calls to get the complete data packets.</span></span> <span data-ttu-id="5081f-141">Для создания полного пакета данных может потребоваться несколько примеров входного носителя.</span><span class="sxs-lookup"><span data-stu-id="5081f-141">It may take more than one input media sample to create a complete data packet.</span></span> <span data-ttu-id="5081f-142">И наоборот, данные в одном входном носителе могут охватывать несколько пакетов.</span><span class="sxs-lookup"><span data-stu-id="5081f-142">Conversely, data in one input media sample might span multiple packets.</span></span> <span data-ttu-id="5081f-143">Таким образом, не все вызовы **процесссампле** будут выдавать примеры выходных носителей.</span><span class="sxs-lookup"><span data-stu-id="5081f-143">Therefore, not all calls to **ProcessSample** will yield output media samples.</span></span>

<span data-ttu-id="5081f-144">Если пример входного носителя содержит ключевой кадр, указанный атрибутом [**мфсампликстенсион \_ клеанпоинт**](mfsampleextension-cleanpoint-attribute.md) , мультиплексор копирует атрибут в пакет.</span><span class="sxs-lookup"><span data-stu-id="5081f-144">If the input media sample contains a key frame indicated by the [**MFSampleExtension\_CleanPoint**](mfsampleextension-cleanpoint-attribute.md) attribute, the multiplexer copies the attribute to the packet.</span></span>

## <a name="getting-asf-data-packets"></a><span data-ttu-id="5081f-145">Получение пакетов данных ASF</span><span class="sxs-lookup"><span data-stu-id="5081f-145">Getting ASF Data Packets</span></span>

<span data-ttu-id="5081f-146">Чтобы получить примеры выходных носителей для полного пакета данных, созданного мультиплексором, вызовите [**имфасфмултиплексер:: жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) в цикле до тех пор, пока не будут оставлены выходные примеры выходных данных для пакета.</span><span class="sxs-lookup"><span data-stu-id="5081f-146">To collect the output media samples for a complete data packet generated by the multiplexer, call [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop until there are no more output media samples left for the packet.</span></span> <span data-ttu-id="5081f-147">Ниже перечислены варианты успеха.</span><span class="sxs-lookup"><span data-stu-id="5081f-147">The following lists the success cases:</span></span>

-   <span data-ttu-id="5081f-148">Если доступен полный пакет данных, [**жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) получает флаг **\_ \_ \_ неполного состояния ASF** в параметре *пдвстатусфлагс* ; параметр *ппипаккет* получает указатель на первый пакет данных.</span><span class="sxs-lookup"><span data-stu-id="5081f-148">If there is a complete data packet available, [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) receives the **ASF\_STATUS\_FLAGS\_INCOMPLETE** flag in the *pdwStatusFlags* parameter; the *ppIPacket* parameter receives a pointer to the first data packet.</span></span> <span data-ttu-id="5081f-149">Этот метод следует вызывать, если он получает этот флаг.</span><span class="sxs-lookup"><span data-stu-id="5081f-149">You must call this method as long it receives this flag.</span></span> <span data-ttu-id="5081f-150">При каждой итерации *ппипаккет* указывает на следующий пакет в очереди.</span><span class="sxs-lookup"><span data-stu-id="5081f-150">With every iteration, *ppIPacket* points to the next packet in the queue.</span></span>
-   <span data-ttu-id="5081f-151">Если имеется только один пакет данных, *ппипаккет* указывает на него, а флаг **\_ \_ \_ неполный флаг состояния ASF** не получен в *пдвстатусфлагс*.</span><span class="sxs-lookup"><span data-stu-id="5081f-151">If there is only one data packet, *ppIPacket* points to it and the **ASF\_STATUS\_FLAGS\_INCOMPLETE** flag is not received in *pdwStatusFlags*.</span></span>
-   <span data-ttu-id="5081f-152">[**Жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) может быть выполнена без передачи пакетов данных, если мультиплексор по-прежнему находится в процессе паккетизинг и добавления пакетов данных.</span><span class="sxs-lookup"><span data-stu-id="5081f-152">[**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) can succeed without yielding any data packets if the multiplexer is still in the process of packetizing and adding data packets.</span></span> <span data-ttu-id="5081f-153">В этом случае *ппипаккет* указывает на **значение NULL**.</span><span class="sxs-lookup"><span data-stu-id="5081f-153">In this case, *ppIPacket* points to **NULL**.</span></span> <span data-ttu-id="5081f-154">Чтобы продолжить, необходимо предоставить мультиплексору дополнительные примеры входных носителей, вызвав [**процесссампле**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="5081f-154">To proceed, you must provide the multiplexer with more input media samples by calling [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span>

<span data-ttu-id="5081f-155">В следующем примере кода показана функция, которая создает пакеты данных с помощью мультиплексора.</span><span class="sxs-lookup"><span data-stu-id="5081f-155">The following example code shows a function that generates data packets by using the multiplexer.</span></span> <span data-ttu-id="5081f-156">Содержимое сформированного пакета данных будет записано в поток байтов данных, выделенный вызывающим объектом.</span><span class="sxs-lookup"><span data-stu-id="5081f-156">The generated data packet contents will be written to the data byte stream allocated by the caller.</span></span>


```C++
//-------------------------------------------------------------------
// GenerateASFDataPackets
// 
// Gets data packets from the mux. This function is called after 
// calling IMFASFMultiplexer::ProcessSample. 
//-------------------------------------------------------------------

HRESULT GenerateASFDataPackets( 
    IMFASFMultiplexer *pMux, 
    IMFByteStream *pDataStream
    )
{
    HRESULT hr = S_OK;

    IMFSample *pOutputSample = NULL;
    IMFMediaBuffer *pDataPacketBuffer = NULL;

    DWORD dwMuxStatus = ASF_STATUSFLAGS_INCOMPLETE;

    while (dwMuxStatus & ASF_STATUSFLAGS_INCOMPLETE)
    {
        hr = pMux->GetNextPacket(&dwMuxStatus, &pOutputSample);

        if (FAILED(hr))
        {
            break;
        }

        if (pOutputSample)
        {
            //Convert to contiguous buffer
            hr = pOutputSample->ConvertToContiguousBuffer(&pDataPacketBuffer);
            
            if (FAILED(hr))
            {
                break;
            }

            //Write buffer to byte stream
            hr = WriteBufferToByteStream(pDataStream, pDataPacketBuffer, NULL);

            if (FAILED(hr))
            {
                break;
            }
        }

        SafeRelease(&pDataPacketBuffer);
        SafeRelease(&pOutputSample);
    }

    SafeRelease(&pOutputSample);
    SafeRelease(&pDataPacketBuffer);
    return hr;
}
```



<span data-ttu-id="5081f-157">`WriteBufferToByteStream`Функция показана в разделе [**имфбитестреам:: Write**](/windows/desktop/api/mfobjects/nf-mfobjects-imfbytestream-write).</span><span class="sxs-lookup"><span data-stu-id="5081f-157">The `WriteBufferToByteStream` function is shown in the topic [**IMFByteStream::Write**](/windows/desktop/api/mfobjects/nf-mfobjects-imfbytestream-write).</span></span>

<span data-ttu-id="5081f-158">Чтобы просмотреть полное приложение, использующее этот пример кода, см. раздел [учебник. копирование потоков ASF из одного файла в другой](tutorial--copying-asf-streams-from-one-file-to-another.md).</span><span class="sxs-lookup"><span data-stu-id="5081f-158">To see a complete application that uses this code example, see [Tutorial: Copying ASF Streams from One File to Another](tutorial--copying-asf-streams-from-one-file-to-another.md).</span></span>

## <a name="post-packet-generation-calls"></a><span data-ttu-id="5081f-159">Вызовы post Packet-Generation</span><span class="sxs-lookup"><span data-stu-id="5081f-159">Post Packet-Generation Calls</span></span>

<span data-ttu-id="5081f-160">Чтобы убедиться в отсутствии полных пакетов данных, ожидающих мультиплексора, вызовите [**имфасфмултиплексер:: Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush).</span><span class="sxs-lookup"><span data-stu-id="5081f-160">To make sure that there are no complete data packets waiting in the multiplexer, call [**IMFASFMultiplexer::Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush).</span></span> <span data-ttu-id="5081f-161">Это заставляет мультиплексор паккетизе все выполняемые примеры мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="5081f-161">This forces the multiplexer to packetize all the media samples that are in progress.</span></span> <span data-ttu-id="5081f-162">Приложение может получать эти пакеты в виде образцов мультимедиа через **жетнекстпаккет** в цикле до тех пор, пока не будут получены оставшиеся пакеты.</span><span class="sxs-lookup"><span data-stu-id="5081f-162">The application can collect these packets in form of media samples through **GetNextPacket** in a loop until there are no more packets left to be retrieved.</span></span>

<span data-ttu-id="5081f-163">После создания всех примеров носителей вызовите метод [**имфасфмултиплексер:: end**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) , чтобы обновить объект заголовка ASF, связанный с этими пакетами данных.</span><span class="sxs-lookup"><span data-stu-id="5081f-163">After all the media samples are generated, call [**IMFASFMultiplexer::End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) to update the ASF Header Object that is associated with these data packets.</span></span> <span data-ttu-id="5081f-164">Объект заголовка задается путем передачи объекта Контентинфо, который использовался для инициализации мультиплексора.</span><span class="sxs-lookup"><span data-stu-id="5081f-164">The Header Object is specified by passing the ContentInfo object that was used to initialize the multiplexer.</span></span> <span data-ttu-id="5081f-165">Этот вызов обновляет различные объекты заголовка для отражения изменений, сделанных мультиплексором во время создания пакета данных.</span><span class="sxs-lookup"><span data-stu-id="5081f-165">This call updates various Header Objects to reflect changes made by the multiplexer during data packet generation.</span></span> <span data-ttu-id="5081f-166">Эти сведения включают число пакетов, длительность отправки, длительность воспроизведения и номера потоков всех потоков.</span><span class="sxs-lookup"><span data-stu-id="5081f-166">This information includes packet count, send duration, play duration, and stream numbers of all the streams.</span></span> <span data-ttu-id="5081f-167">Общий размер заголовка также обновляется.</span><span class="sxs-lookup"><span data-stu-id="5081f-167">The overall header size is also updated.</span></span>

<span data-ttu-id="5081f-168">Необходимо убедиться, что метод [**End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) вызывается после получения всех пакетов данных.</span><span class="sxs-lookup"><span data-stu-id="5081f-168">You must ensure that [**End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) is called after all the data packets have been retrieved.</span></span> <span data-ttu-id="5081f-169">Если в мультиплексоре находятся пакеты, ожидающие мультиплексирования **,** завершится ошибкой и будет возвращен код ошибки **MF \_ E \_ \_** .</span><span class="sxs-lookup"><span data-stu-id="5081f-169">If there are any packets waiting in the multiplexer, **End** will fail and return the **MF\_E\_FLUSH\_NEEDED** error code.</span></span> <span data-ttu-id="5081f-170">В этом случае получите ожидающий пакет, вызвав [**flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) и [**жетнекстпаккет**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) в цикле.</span><span class="sxs-lookup"><span data-stu-id="5081f-170">In this case, get the waiting packet by calling [**Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) and [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop.</span></span>

> [!Note]  
> <span data-ttu-id="5081f-171">Для кодирования VBR после вызова **End** необходимо задать статистику кодировки в свойствах кодировки объекта контентинфо.</span><span class="sxs-lookup"><span data-stu-id="5081f-171">For VBR encoding, after calling **End**, you must set the encoding statistics in the ContentInfo object's encoding properties.</span></span> <span data-ttu-id="5081f-172">Дополнительные сведения об этом процессе см. в разделе "Настройка объекта Контентинфо с помощью параметров кодировщика" раздела [Настройка свойств в объекте контентинфо](setting-properties-in-the-contentinfo-object.md).</span><span class="sxs-lookup"><span data-stu-id="5081f-172">For information about this process, see "Configuring the ContentInfo Object with Encoder Settings" in [Setting Properties in the ContentInfo Object](setting-properties-in-the-contentinfo-object.md).</span></span> <span data-ttu-id="5081f-173">В следующем списке перечислены конкретные свойства, которые необходимо задать.</span><span class="sxs-lookup"><span data-stu-id="5081f-173">The following list shows the specific properties to set:</span></span>
>
> -   <span data-ttu-id="5081f-174">[**Мфпкэй \_ РАВГ**](mfpkey-ravgproperty.md) — это средняя скорость потока содержимого VBR.</span><span class="sxs-lookup"><span data-stu-id="5081f-174">[**MFPKEY\_RAVG**](mfpkey-ravgproperty.md) is the average bit rate of the VBR content.</span></span>
> -   <span data-ttu-id="5081f-175">[**Мфпкэй \_ БАВГ**](mfpkey-bavgproperty.md) — это окно буфера для средней скорости потока.</span><span class="sxs-lookup"><span data-stu-id="5081f-175">[**MFPKEY\_BAVG**](mfpkey-bavgproperty.md) is the buffer window for the average bit rate.</span></span>
> -   <span data-ttu-id="5081f-176">[**Мфпкэй \_ РМАКС**](mfpkey-rmaxproperty.md) — это Пиковая скорость содержимого VBR.</span><span class="sxs-lookup"><span data-stu-id="5081f-176">[**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md) is the peak bit rate of the VBR content.</span></span>
> -   <span data-ttu-id="5081f-177">[**Мфпкэй \_ БМАКС**](mfpkey-bmaxproperty.md) — пиковое окно буфера.</span><span class="sxs-lookup"><span data-stu-id="5081f-177">[**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) is the peak buffer window.</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="5081f-178">См. также</span><span class="sxs-lookup"><span data-stu-id="5081f-178">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5081f-179">Мультиплексор ASF</span><span class="sxs-lookup"><span data-stu-id="5081f-179">ASF Multiplexer</span></span>](asf-multiplexer.md)
</dt> <dt>

[<span data-ttu-id="5081f-180">Учебник. копирование потоков ASF из одного файла в другой</span><span class="sxs-lookup"><span data-stu-id="5081f-180">Tutorial: Copying ASF Streams from One File to Another</span></span>](tutorial--copying-asf-streams-from-one-file-to-another.md)
</dt> <dt>

[<span data-ttu-id="5081f-181">Руководство. запись файла WMA с помощью CBR Encoding</span><span class="sxs-lookup"><span data-stu-id="5081f-181">Tutorial: Writing a WMA File by Using CBR Encoding</span></span>](tutorial--writing-a-wma-file-by-using-cbr-encoding.md)
</dt> </dl>

 

 



