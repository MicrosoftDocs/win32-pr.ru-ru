---
description: В некоторых кодировщиках Windows Media поддерживаются режимы кодирования с двумя проходами и Media Foundation на уровне конвейера.
ms.assetid: 3fd5baff-142f-453e-bb97-b355ee6678fc
title: Создание топологии для Two-Pass кодирования Windows Media
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7c813b9a3c31fafaa3efbea83180c997bc46079d
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "103999895"
---
# <a name="how-to-create-a-topology-for-two-pass-windows-media-encoding"></a><span data-ttu-id="5b243-103">Создание топологии для Two-Pass кодирования Windows Media</span><span class="sxs-lookup"><span data-stu-id="5b243-103">How to Create a Topology for Two-Pass Windows Media Encoding</span></span>

<span data-ttu-id="5b243-104">В некоторых кодировщиках Windows Media поддерживаются режимы кодирования с двумя проходами и Media Foundation на уровне конвейера.</span><span class="sxs-lookup"><span data-stu-id="5b243-104">Two-pass encoding modes are supported by certain Windows Media encoders and Media Foundation at the pipeline layer.</span></span> <span data-ttu-id="5b243-105">Приложение должно настроить и настроить топологию кодирования так же, как в однопроходной кодировке, но в режиме 2-проходного кодирования приложение должно запускать сеанс кодирования дважды.</span><span class="sxs-lookup"><span data-stu-id="5b243-105">The application must configure and set up the encoding topology similar to that in single-pass encoding but in the 2-pass encoding mode, the application must run the encoding session twice.</span></span> <span data-ttu-id="5b243-106">При первом прохождении кодировщик собирает сведения о содержимом потока.</span><span class="sxs-lookup"><span data-stu-id="5b243-106">On the first pass, the encoder gathers information about the content of the stream.</span></span> <span data-ttu-id="5b243-107">На втором этапе, используя сведения, собранные на первом этапе, создается окончательный выходной файл.</span><span class="sxs-lookup"><span data-stu-id="5b243-107">On the second pass, by using the information gathered on the first pass, the final output file is generated.</span></span> <span data-ttu-id="5b243-108">Обрабатывая образцы для потока дважды, две проходные кодировки оптимизируют процесс кодирования и создают файлы с кодировкой более высокого качества.</span><span class="sxs-lookup"><span data-stu-id="5b243-108">By processing the samples for the stream twice, two-pass encoding optimizes the encoding process and produces higher quality encoded files.</span></span> <span data-ttu-id="5b243-109">В динамических потоках нельзя использовать режимы кодирования с двумя проходами.</span><span class="sxs-lookup"><span data-stu-id="5b243-109">Two-pass encoding modes cannot be used on live streams.</span></span>

<span data-ttu-id="5b243-110">Media Foundation поддерживает следующие режимы кодирования с двумя проходами:</span><span class="sxs-lookup"><span data-stu-id="5b243-110">Media Foundation supports the following two-pass encoding modes:</span></span>

-   [<span data-ttu-id="5b243-111">Кодирование переменной скорости с неограниченным битом</span><span class="sxs-lookup"><span data-stu-id="5b243-111">Unconstrained Variable Bit Rate Encoding</span></span>](unconstrained-variable-bit-rate--vbr--encoding.md)
-   [<span data-ttu-id="5b243-112">Пиковое кодирование с переменным ограничением скорости</span><span class="sxs-lookup"><span data-stu-id="5b243-112">Peak-Constrained Variable Bit Rate Encoding</span></span>](peak-constrained-variable-bit-rate--vbr--encoding.md)

<span data-ttu-id="5b243-113">Создание топологии кодирования для двусторонней кодировки аналогично однопроходным режимам.</span><span class="sxs-lookup"><span data-stu-id="5b243-113">Building an encoding topology for two-pass encoding is similar to single pass modes.</span></span> <span data-ttu-id="5b243-114">В следующем списке приведены основные различия.</span><span class="sxs-lookup"><span data-stu-id="5b243-114">The following list shows the key differences.</span></span>

-   <span data-ttu-id="5b243-115">Конфигурация кодировщика должна включать свойство [**мфпкэй \_ пассесусед**](mfpkey-passesusedproperty.md) , для которого задано значение 2, а для свойства [**мфпкэй \_ вбренаблед**](mfpkey-vbrenabledproperty.md) — \_ значение true.</span><span class="sxs-lookup"><span data-stu-id="5b243-115">Encoder configuration must include the [**MFPKEY\_PASSESUSED**](mfpkey-passesusedproperty.md) property that is set to 2 and the [**MFPKEY\_VBRENABLED**](mfpkey-vbrenabledproperty.md) property to VARIANT\_TRUE.</span></span> <span data-ttu-id="5b243-116">Это позволит отфильтровать возможности кодировщика в двух-проходных режимах.</span><span class="sxs-lookup"><span data-stu-id="5b243-116">This filters the encoder’s capabilities to two-pass modes.</span></span> <span data-ttu-id="5b243-117">Если вы используете объекты активации, передайте эти свойства в [**мфкреатевмаенкодерактивате**](/windows/desktop/api/wmcontainer/nf-wmcontainer-mfcreatewmaencoderactivate) или [**мфкреатевмвенкодерактивате**](/windows/desktop/api/wmcontainer/nf-wmcontainer-mfcreatewmvencoderactivate).</span><span class="sxs-lookup"><span data-stu-id="5b243-117">If you are using activation objects, pass these properties to [**MFCreateWMAEncoderActivate**](/windows/desktop/api/wmcontainer/nf-wmcontainer-mfcreatewmaencoderactivate) or [**MFCreateWMVEncoderActivate**](/windows/desktop/api/wmcontainer/nf-wmcontainer-mfcreatewmvencoderactivate).</span></span>
-   <span data-ttu-id="5b243-118">Для первого прохода используйте фиктивный приемник мультимедиа в выходном узле, так как образцы, созданные в этом проходе, не добавляются в окончательный файл.</span><span class="sxs-lookup"><span data-stu-id="5b243-118">For the first pass, use a dummy media sink in the output node because the samples that are generated in this pass are not added to the final file.</span></span>
-   <span data-ttu-id="5b243-119">Для второго прохода запросите кодировщик на наличие требуемых свойств после кодирования и замените фиктивный узел приемника мультимедиа приемником ASF Media, заданными свойствами.</span><span class="sxs-lookup"><span data-stu-id="5b243-119">For the second pass, query the encoder for the required post-encoding properties and replace the dummy media sink node with the ASF media sink with these properties set.</span></span>

<span data-ttu-id="5b243-120">Дополнительные сведения о настройке топологии кодирования см. в разделе [учебник. однопроходное кодирование Windows Media](tutorial--1-pass-windows-media-encoding.md).</span><span class="sxs-lookup"><span data-stu-id="5b243-120">For more information about setting up an encoding topology see, [Tutorial: Single Pass Windows Media Encoding](tutorial--1-pass-windows-media-encoding.md).</span></span>

<span data-ttu-id="5b243-121">Следующая процедура описывает действия по кодированию содержимого мультимедиа Windows в контейнере ASF с помощью режима двухсторонней кодировки.</span><span class="sxs-lookup"><span data-stu-id="5b243-121">The following procedure summarizes the steps for encoding Windows Media content in an ASF container by using a two-pass encoding mode.</span></span>

1.  <span data-ttu-id="5b243-122">Создайте источник мультимедиа для указанного с помощью сопоставителя источников.</span><span class="sxs-lookup"><span data-stu-id="5b243-122">Create a media source for the specified by using the source resolver.</span></span>
2.  <span data-ttu-id="5b243-123">Перечисление потоков в источнике мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="5b243-123">Enumerate the streams in the media source.</span></span>
3.  <span data-ttu-id="5b243-124">Создайте приемник мультимедиа ASF и добавьте приемники потоков в зависимости от потоков в источнике носителя, который необходимо закодировать.</span><span class="sxs-lookup"><span data-stu-id="5b243-124">Create the ASF media sink and add stream sinks depending on the streams in the media source that need to be encoded.</span></span>
4.  <span data-ttu-id="5b243-125">Создайте приемник мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="5b243-125">Create the media sink.</span></span>
5.  <span data-ttu-id="5b243-126">Создайте кодировщики Windows Media для потоков в выходном файле.</span><span class="sxs-lookup"><span data-stu-id="5b243-126">Create the Windows Media encoders for the streams in the output file.</span></span>
6.  <span data-ttu-id="5b243-127">Настройте кодировщики с помощью 2-проходных свойств кодировки.</span><span class="sxs-lookup"><span data-stu-id="5b243-127">Configure the encoders with the 2-pass encoding properties.</span></span>
7.  <span data-ttu-id="5b243-128">Создайте топологию частичной кодировки, подключив источник, кодировщики и приемник мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="5b243-128">Build a partial encoding topology by connecting the source, encoders, and the media sink.</span></span>
8.  <span data-ttu-id="5b243-129">Создайте экземпляр сеанса мультимедиа и задайте топологию для сеанса мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="5b243-129">Instantiate the Media Session and set the topology on the Media Session.</span></span>
9.  <span data-ttu-id="5b243-130">Запустите первый проход кодирования, управляя сеансом мультимедиа и получением всех соответствующих событий из сеанса мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="5b243-130">Run the first encoding pass by controlling the Media Session and getting all the relevant events from the Media Session.</span></span>
10. <span data-ttu-id="5b243-131">Закройте и завершите сеанс кодирования.</span><span class="sxs-lookup"><span data-stu-id="5b243-131">Close and shutdown the encoding session.</span></span>
11. <span data-ttu-id="5b243-132">Запросите в кодировщике следующие свойства в зависимости от типа кодировки:</span><span class="sxs-lookup"><span data-stu-id="5b243-132">Query the encoder for the following properties depending on the type of encoding:</span></span> 

    | <span data-ttu-id="5b243-133">Тип кодировки</span><span class="sxs-lookup"><span data-stu-id="5b243-133">Encoding type</span></span>                                                                                        | <span data-ttu-id="5b243-134">Имя свойства</span><span class="sxs-lookup"><span data-stu-id="5b243-134">Property name</span></span>                                                                                                                                                                                                                                                                                                                                                     |
    |------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | [<span data-ttu-id="5b243-135">Кодирование переменной скорости с неограниченным битом</span><span class="sxs-lookup"><span data-stu-id="5b243-135">Unconstrained Variable Bit Rate Encoding</span></span>](unconstrained-variable-bit-rate--vbr--encoding.md)       | [<span data-ttu-id="5b243-136">**МФПКЭЙ \_ пассесусед**</span><span class="sxs-lookup"><span data-stu-id="5b243-136">**MFPKEY\_PASSESUSED**</span></span>](mfpkey-passesusedproperty.md)<br/> [<span data-ttu-id="5b243-137">**МФПКЭЙ \_ вбренаблед**</span><span class="sxs-lookup"><span data-stu-id="5b243-137">**MFPKEY\_VBRENABLED**</span></span>](mfpkey-vbrenabledproperty.md)<br/> [<span data-ttu-id="5b243-138">**МФПКЭЙ \_ бавг**</span><span class="sxs-lookup"><span data-stu-id="5b243-138">**MFPKEY\_BAVG**</span></span>](mfpkey-bavgproperty.md)<br/> [<span data-ttu-id="5b243-139">**МФПКЭЙ \_ равг**</span><span class="sxs-lookup"><span data-stu-id="5b243-139">**MFPKEY\_RAVG**</span></span>](mfpkey-ravgproperty.md)<br/>                                                                                                               |
    | [<span data-ttu-id="5b243-140">Пиковое кодирование с переменным ограничением скорости</span><span class="sxs-lookup"><span data-stu-id="5b243-140">Peak-Constrained Variable Bit Rate Encoding</span></span>](peak-constrained-variable-bit-rate--vbr--encoding.md) | [<span data-ttu-id="5b243-141">**МФПКЭЙ \_ пассесусед**</span><span class="sxs-lookup"><span data-stu-id="5b243-141">**MFPKEY\_PASSESUSED**</span></span>](mfpkey-passesusedproperty.md)<br/> [<span data-ttu-id="5b243-142">**МФПКЭЙ \_ вбренаблед**</span><span class="sxs-lookup"><span data-stu-id="5b243-142">**MFPKEY\_VBRENABLED**</span></span>](mfpkey-vbrenabledproperty.md)<br/> [<span data-ttu-id="5b243-143">**МФПКЭЙ \_ бавг**</span><span class="sxs-lookup"><span data-stu-id="5b243-143">**MFPKEY\_BAVG**</span></span>](mfpkey-bavgproperty.md)<br/> [<span data-ttu-id="5b243-144">**МФПКЭЙ \_ равг**</span><span class="sxs-lookup"><span data-stu-id="5b243-144">**MFPKEY\_RAVG**</span></span>](mfpkey-ravgproperty.md)<br/> [<span data-ttu-id="5b243-145">**МФПКЭЙ \_ бмакс**</span><span class="sxs-lookup"><span data-stu-id="5b243-145">**MFPKEY\_BMAX**</span></span>](mfpkey-bmaxproperty.md)<br/> [<span data-ttu-id="5b243-146">**МФПКЭЙ \_ рмакс**</span><span class="sxs-lookup"><span data-stu-id="5b243-146">**MFPKEY\_RMAX**</span></span>](mfpkey-rmaxproperty.md)<br/> |

    

     

12. <span data-ttu-id="5b243-147">Создайте приемник файлов ASF и добавьте необходимые приемники потоков в зависимости от потоков, которые необходимо включить в окончательный выходной файл.</span><span class="sxs-lookup"><span data-stu-id="5b243-147">Create the ASF file sink and add the required stream sinks depending on the streams you want to include in the final output file.</span></span>
13. <span data-ttu-id="5b243-148">Задайте свойства кодировщика, полученные на шаге 11, в приемнике файла.</span><span class="sxs-lookup"><span data-stu-id="5b243-148">Set the encoder properties retrieved in step 11 on the file sink.</span></span>
14. <span data-ttu-id="5b243-149">Замените приемник мультимедиа в выходном узле вновь созданным приемником файлов.</span><span class="sxs-lookup"><span data-stu-id="5b243-149">Replace the media sink in the output node with the newly created file sink.</span></span>
15. <span data-ttu-id="5b243-150">Создайте экземпляр сеанса мультимедиа и настройте обновленную топологию в сеансе мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="5b243-150">Instantiate the Media Session and set the updated topology on the Media Session.</span></span>
16. <span data-ttu-id="5b243-151">Выполните второй проход кодирования, управляя сеансом мультимедиа и получением всех соответствующих событий из сеанса мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="5b243-151">Run second encoding pass by controlling the Media Session and getting all the relevant events from the Media Session.</span></span>
17. <span data-ttu-id="5b243-152">Дождитесь события [миндофпресентатион](meendofpresentation.md) из сеанса мультимедиа и обработчика событий получите значения свойств кодировки из кодировщика и задайте их в приемнике файла.</span><span class="sxs-lookup"><span data-stu-id="5b243-152">Wait for the [MEEndOfPresentation](meendofpresentation.md) event from the Media Session and in the event handler get the encoding property values from the encoder and set them on the file sink.</span></span> <span data-ttu-id="5b243-153">Дополнительные сведения см. в разделе "Обновление свойств кодировки в приемнике файлов" раздела [учебник. однопроходное кодирование Windows Media](tutorial--1-pass-windows-media-encoding.md).</span><span class="sxs-lookup"><span data-stu-id="5b243-153">For more information, see "Update Encoding Properties in the File Sink" in [Tutorial: Single Pass Windows Media Encoding](tutorial--1-pass-windows-media-encoding.md).</span></span>
18. <span data-ttu-id="5b243-154">Закройте и завершите сеанс кодирования.</span><span class="sxs-lookup"><span data-stu-id="5b243-154">Close and shutdown the encoding session.</span></span>

## <a name="related-topics"></a><span data-ttu-id="5b243-155">См. также</span><span class="sxs-lookup"><span data-stu-id="5b243-155">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5b243-156">Компоненты ASF уровня конвейера</span><span class="sxs-lookup"><span data-stu-id="5b243-156">Pipeline Layer ASF Components</span></span>](pipeline-layer-asf-components.md)
</dt> </dl>

 

 




