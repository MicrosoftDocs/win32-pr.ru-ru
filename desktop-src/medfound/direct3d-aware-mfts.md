---
description: В этом разделе описывается реализация преобразования Media Foundation с поддержкой Direct3D (MFT) для видео.
ms.assetid: 8ec7e678-8477-41fa-9726-54df5ed187cd
title: Direct3D-Aware МФТС
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ad50438250c0ee1627cc20aebb49262ec8eec9ac
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104539572"
---
# <a name="direct3d-aware-mfts"></a><span data-ttu-id="5e8e2-103">Direct3D-Aware МФТС</span><span class="sxs-lookup"><span data-stu-id="5e8e2-103">Direct3D-Aware MFTs</span></span>

<span data-ttu-id="5e8e2-104">В этом разделе описывается реализация преобразования Media Foundation с *поддержкой Direct3D* (MFT) для видео.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-104">This topic describes how to implement a *Direct3D-aware* Media Foundation transform (MFT) for video.</span></span>

<span data-ttu-id="5e8e2-105">Видеофайл MFT считается *совместимым с Direct3D* , если он может обрабатывать образцы, содержащие поверхности Direct3D.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-105">An video MFT is considered *Direct3D-aware* if it can process samples that contain Direct3D surfaces.</span></span> <span data-ttu-id="5e8e2-106">Типичная причина поддержки Direct3D в видеофайловых ТАБЛИЦАх — включение декодирования с аппаратным ускорением с использованием ускорения DirectX Video (ДКСВА).</span><span class="sxs-lookup"><span data-stu-id="5e8e2-106">The typical reason for supporting Direct3D in a video MFT is to enable hardware-accelerated decoding, using DirectX Video Acceleration (DXVA).</span></span>

<span data-ttu-id="5e8e2-107">В этом разделе описаны шаги, необходимые для создания MFT-совместимого с Direct3D.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-107">This topic describes the steps that are required to make your MFT Direct3D-aware.</span></span> <span data-ttu-id="5e8e2-108">В этом разделе не рассматривается механизм декодирования ДКСВА.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-108">This topic does not cover the mechanics of DXVA decoding.</span></span> <span data-ttu-id="5e8e2-109">Дополнительные сведения о ДКСВА см. в статье [DirectX Video Acceleration 2,0](directx-video-acceleration-2-0.md).</span><span class="sxs-lookup"><span data-stu-id="5e8e2-109">For information about DXVA, see [DirectX Video Acceleration 2.0](directx-video-acceleration-2-0.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="5e8e2-110">Начиная с Windows 8, вместо [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9)можно использовать [**имфдксгидевицеманажер**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) .</span><span class="sxs-lookup"><span data-stu-id="5e8e2-110">Beginning in Windows 8, [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) can be used instead of the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9).</span></span> <span data-ttu-id="5e8e2-111">Для приложений Магазина Windows необходимо использовать **имфдксгидевицеманажер** и Microsoft Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-111">For Windows Store apps, you must use **IMFDXGIDeviceManager** and Microsoft Direct3D 11.</span></span> <span data-ttu-id="5e8e2-112">Дополнительные сведения см. в статье [API-интерфейсы видео Direct3D 11](direct3d-11-video-apis.md).</span><span class="sxs-lookup"><span data-stu-id="5e8e2-112">For more info, see the [Direct3D 11 Video APIs](direct3d-11-video-apis.md).</span></span>

 

1.  <span data-ttu-id="5e8e2-113">Реализуйте метод [**имфтрансформ:: OutAttribute**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes) .</span><span class="sxs-lookup"><span data-stu-id="5e8e2-113">Implement the [**IMFTransform::GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes) method.</span></span> <span data-ttu-id="5e8e2-114">Этот метод возвращает указатель на хранилище атрибутов.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-114">This method returns a pointer to an attribute store.</span></span>
2.  <span data-ttu-id="5e8e2-115">MFT должно установить значение **true** для атрибута [**MF \_ SA с \_ \_ поддержкой D3D**](mf-sa-d3d-aware-attribute.md) в собственном хранилище атрибутов.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-115">The MFT must set the value of the [**MF\_SA\_D3D\_AWARE**](mf-sa-d3d-aware-attribute.md) attribute to **TRUE** on its own attribute store.</span></span> <span data-ttu-id="5e8e2-116">Начиная с Windows 8, при использовании Direct3D 11 используйте протокол [MF \_ SA D3D11 с \_ \_ поддержкой](mf-sa-d3d11-aware.md).</span><span class="sxs-lookup"><span data-stu-id="5e8e2-116">Beginning in Windows 8, if using Direct3D 11 use [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md).</span></span>
3.  <span data-ttu-id="5e8e2-117">Во время согласования формата, если атрибут [**MF \_ SA \_ \_**](mf-sa-d3d-aware-attribute.md) (или [MF \_ SA \_ D3D11, \_ осведомленный](mf-sa-d3d11-aware.md) об использовании Direct3D 11) имеет **значение true**, клиент может отправить в основную таблицу MFT сообщение из [**таблицы MFT \_ \_ Set D3D Message \_ \_ Manager**](mft-message-set-d3d-manager.md) .</span><span class="sxs-lookup"><span data-stu-id="5e8e2-117">During format negotiation, if the [**MF\_SA\_D3D\_AWARE**](mf-sa-d3d-aware-attribute.md) (or [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md) if using Direct3D 11) attribute is **TRUE**, the client may send the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message to the MFT.</span></span> <span data-ttu-id="5e8e2-118">Параметр события *улпарам* является указателем на интерфейс [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) .</span><span class="sxs-lookup"><span data-stu-id="5e8e2-118">The *ulParam* event parameter is a pointer to the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span> <span data-ttu-id="5e8e2-119">Начиная с Windows 8, вместо **IDirect3DDeviceManager9** можно использовать [**имфдксгидевицеманажер**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) .</span><span class="sxs-lookup"><span data-stu-id="5e8e2-119">Beginning in Windows 8, you can use [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) instead of **IDirect3DDeviceManager9**.</span></span> <span data-ttu-id="5e8e2-120">Клиенту не требуется отсылать это сообщение.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-120">The client is not required to send this message.</span></span>
4.  <span data-ttu-id="5e8e2-121">MFT вызывает [**IDirect3DDeviceManager9:: жетвидеосервице**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) для запроса необходимых служб дксва.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-121">The MFT calls [**IDirect3DDeviceManager9::GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) to query for the DXVA service it needs.</span></span> <span data-ttu-id="5e8e2-122">Начиная с Windows 8, если [**имфдксгидевицеманажер**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) использовался в MFT, вызывается [**Имфдксгидевицеманажер:: жетвидеосервице**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span><span class="sxs-lookup"><span data-stu-id="5e8e2-122">Beginning in Windows 8, if [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) was used the MFT calls [**IMFDXGIDeviceManager::GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span></span> <span data-ttu-id="5e8e2-123">Обычно декодер запрашивает [**идиректксвидеодекодерсервице**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice), а обработчик видео запрашивает [**идиректксвидеопроцессорсервице**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice).</span><span class="sxs-lookup"><span data-stu-id="5e8e2-123">Typically a decoder would query for [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice), and a video processor would query for [**IDirectXVideoProcessorService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice).</span></span>
5.  <span data-ttu-id="5e8e2-124">При условии успешного выполнения предыдущего шага методы [**имфтрансформ:: жетинпутаваилаблетипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) и [**Имфтрансформ:: жетаутпутаваилаблетипе**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) должны возвращать дксва совместимые форматы.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-124">Assuming the previous step is successful, the [**IMFTransform::GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) and [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) methods must return DXVA-compatible formats.</span></span>
6.  <span data-ttu-id="5e8e2-125">Клиент настраивает типы носителей в MFT.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-125">The client configures the media types on the MFT.</span></span> <span data-ttu-id="5e8e2-126">Если тип мультимедиа несовместим с ДКСВА, MFT должен вернуть код ошибки **MF \_ E \_ неподдерживаемый \_ \_ тип D3D**.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-126">If a media type is not compatible with DXVA, the MFT must return the error code **MF\_E\_UNSUPPORTED\_D3D\_TYPE**.</span></span>
7.  <span data-ttu-id="5e8e2-127">На этом этапе есть два варианта, в зависимости от того, находит ли клиент подходящий формат ДКСВА.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-127">At this point, there are two options, depending on whether the client finds a suitable DXVA format.</span></span>
    -   <span data-ttu-id="5e8e2-128">Если клиент успешно настроил формат ДКСВА, он может начать обработку.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-128">If the client successfully configures a DXVA format, it may begin processing.</span></span> <span data-ttu-id="5e8e2-129">На этом этапе MFT может использовать ДКСВА для обработки или вернуться к обработке программного обеспечения.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-129">At this point, the MFT can use DXVA for processing, or fall back to software processing.</span></span>
    -   <span data-ttu-id="5e8e2-130">Кроме того, если клиент не находит приемлемый формат ДКСВА, клиент может отправить еще одно сообщение [**MFT \_ \_ Manager Set \_ D3D \_**](mft-message-set-d3d-manager.md) Message, при этом параметру *улпарам* будет присвоено **значение NULL**.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-130">Alternatively, if the client does not find an acceptable DXVA format, the client may send another [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message, this time setting *ulParam* to **NULL**.</span></span> <span data-ttu-id="5e8e2-131">MFT должен освободить указатель [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) (указатель [**имфдксгидевицеманажер**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) , если использовался **ИМФДКСГИДЕВИЦЕМАНАЖЕР** ) и другие интерфейсы дксва, а также вернуться к обработке программного обеспечения.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-131">The MFT must release the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) pointer (the [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) pointer, if **IMFDXGIDeviceManager** was used) and any other DXVA interfaces, and revert to software processing.</span></span> <span data-ttu-id="5e8e2-132">На этом этапе MFT не должно использовать обработку ДКСВА.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-132">At this point, the MFT must not use DXVA processing.</span></span>

<span data-ttu-id="5e8e2-133">Таблица MFT, поддерживающая Direct3D, должна быть подготовлена к обработке образцов, содержащих поверхность Direct3D.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-133">A Direct3D-aware MFT must be prepared to handle samples that contain a Direct3D surface.</span></span> <span data-ttu-id="5e8e2-134">Пример будет содержать ровно один буфер мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-134">The sample will contain exactly one media buffer.</span></span> <span data-ttu-id="5e8e2-135">Чтобы получить поверхность Direct3D из буфера, вызовите функцию [**мфжетсервице**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) и укажите службу **\_ \_ службы буфера MR** .</span><span class="sxs-lookup"><span data-stu-id="5e8e2-135">To get the Direct3D surface from the buffer, call the [**MFGetService**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) function and specify the **MR\_BUFFER\_SERVICE** service.</span></span> <span data-ttu-id="5e8e2-136">Дополнительные сведения см. в разделе [буфер поверхности DirectX](directx-surface-buffer.md).</span><span class="sxs-lookup"><span data-stu-id="5e8e2-136">For more information, see [DirectX Surface Buffer](directx-surface-buffer.md).</span></span>

<span data-ttu-id="5e8e2-137">Файл MFT, использующий ДКСВА, должен выделить свои собственные выходные примеры следующим образом:</span><span class="sxs-lookup"><span data-stu-id="5e8e2-137">An MFT that uses DXVA must allocate its own output samples, as follows:</span></span>

1.  <span data-ttu-id="5e8e2-138">В методе [**имфтрансформ:: жетаутпутстреаминфо**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) Задайте флаг **\_ \_ \_ \_ Samples в потоке вывода MFT** .</span><span class="sxs-lookup"><span data-stu-id="5e8e2-138">In the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method, set the **MFT\_OUTPUT\_STREAM\_PROVIDES\_SAMPLES** flag.</span></span>
2.  <span data-ttu-id="5e8e2-139">Создайте пул поверхностей ДКСВА, как описано в спецификации ДКСВА.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-139">Create a pool of DXVA surfaces, as described in the DXVA specification.</span></span>
3.  <span data-ttu-id="5e8e2-140">Создайте примеры носителей, вызвав [**мфкреатевидеосамплефромсурфаце**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface).</span><span class="sxs-lookup"><span data-stu-id="5e8e2-140">Create media samples by calling [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface).</span></span>

<span data-ttu-id="5e8e2-141">MFT всегда должно поддерживать обработку программного обеспечения в качестве резерва, так как обработка ДКСВА может быть недоступна по нескольким причинам:</span><span class="sxs-lookup"><span data-stu-id="5e8e2-141">The MFT should always support software processing as a fallback, because DXVA processing might not available, for several reasons:</span></span>

-   <span data-ttu-id="5e8e2-142">GPU может не поддерживать ДКСВА.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-142">The GPU might not support DXVA.</span></span>
-   <span data-ttu-id="5e8e2-143">Клиент может не использовать Direct3D.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-143">The client might not use Direct3D.</span></span>
-   <span data-ttu-id="5e8e2-144">Профили ДКСВА не определяются для каждого видеоформата.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-144">DXVA profiles are not defined for every video format.</span></span>

<span data-ttu-id="5e8e2-145">Файловая таблица, поддерживающая Direct3D, должна иметь один выходной поток.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-145">A Direct3D-aware MFT must have a single output stream.</span></span> <span data-ttu-id="5e8e2-146">Он не может иметь несколько выходов.</span><span class="sxs-lookup"><span data-stu-id="5e8e2-146">It cannot have multiple outputs.</span></span>

## <a name="related-topics"></a><span data-ttu-id="5e8e2-147">См. также</span><span class="sxs-lookup"><span data-stu-id="5e8e2-147">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5e8e2-148">Запись пользовательского MFT</span><span class="sxs-lookup"><span data-stu-id="5e8e2-148">Writing a Custom MFT</span></span>](writing-a-custom-mft.md)
</dt> </dl>

 

 



