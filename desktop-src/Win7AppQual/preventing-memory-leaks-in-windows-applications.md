---
description: Узнайте, как предотвратить утечки памяти в приложениях Windows для платформ Windows 7 и Windows Server 2008 R2.
ms.assetid: c5dedcab-3e6f-433f-95de-d741321c683e
title: Предотвращение утечек памяти в приложениях Windows
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e973da19d075ac94824df340d1741fd9cefb3486
ms.sourcegitcommit: af9983bab40fe0b042f177ce7ca79f2eb0f9d0e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "104567502"
---
# <a name="preventing-memory-leaks-in-windows-applications"></a><span data-ttu-id="ef3de-103">Предотвращение утечек памяти в приложениях Windows</span><span class="sxs-lookup"><span data-stu-id="ef3de-103">Preventing Memory Leaks in Windows Applications</span></span>

## <a name="affected-platforms"></a><span data-ttu-id="ef3de-104">Затронутые платформы</span><span class="sxs-lookup"><span data-stu-id="ef3de-104">Affected Platforms</span></span>

<span data-ttu-id="ef3de-105">**Клиенты** — Windows 7</span><span class="sxs-lookup"><span data-stu-id="ef3de-105">**Clients** - Windows 7</span></span>  
<span data-ttu-id="ef3de-106">**Серверы** — Windows Server 2008 R2</span><span class="sxs-lookup"><span data-stu-id="ef3de-106">**Servers** - Windows Server 2008 R2</span></span>  

## <a name="description"></a><span data-ttu-id="ef3de-107">Описание</span><span class="sxs-lookup"><span data-stu-id="ef3de-107">Description</span></span>

<span data-ttu-id="ef3de-108">Утечки памяти — это класс ошибок, в которых приложение не может освободить память, если она больше не нужна.</span><span class="sxs-lookup"><span data-stu-id="ef3de-108">Memory leaks are a class of bugs where the application fails to release memory when no longer needed.</span></span> <span data-ttu-id="ef3de-109">Со временем утечки памяти влияют на производительность как конкретного приложения, так и операционной системы.</span><span class="sxs-lookup"><span data-stu-id="ef3de-109">Over time, memory leaks affect the performance of both the particular application as well as the operating system.</span></span> <span data-ttu-id="ef3de-110">Большая утечка может привести к неприемлемому времени отклика из-за чрезмерного разбиения на страницы.</span><span class="sxs-lookup"><span data-stu-id="ef3de-110">A large leak might result in unacceptable response times due to excessive paging.</span></span> <span data-ttu-id="ef3de-111">В конечном итоге приложение, а также другие части операционной системы будут испытывать сбои.</span><span class="sxs-lookup"><span data-stu-id="ef3de-111">Eventually the application as well as other parts of the operating system will experience failures.</span></span>

<span data-ttu-id="ef3de-112">Windows освобождает всю память, выделенную приложением при завершении процесса, поэтому кратковременные приложения не будут существенно влиять на общую производительность системы.</span><span class="sxs-lookup"><span data-stu-id="ef3de-112">Windows will free all memory allocated by the application on process termination, so short-running applications will not affect overall system performance significantly.</span></span> <span data-ttu-id="ef3de-113">Однако утечки в долгосрочных процессах, таких как службы или даже подключаемые модули обозревателя, могут значительно повлиять на надежность системы и могут заставить пользователя перезагрузить Windows, чтобы система могла снова использовать систему.</span><span class="sxs-lookup"><span data-stu-id="ef3de-113">However, leaks in long-running processes like services or even Explorer plug-ins can greatly impact system reliability and might force the user to reboot Windows in order to make the system usable again.</span></span>

<span data-ttu-id="ef3de-114">Приложения могут выделить память от своего имени несколькими способами.</span><span class="sxs-lookup"><span data-stu-id="ef3de-114">Applications can allocate memory on their behalf by multiple means.</span></span> <span data-ttu-id="ef3de-115">Каждый тип выделения может привести к утечке, если они не освобождаются после использования.</span><span class="sxs-lookup"><span data-stu-id="ef3de-115">Each type of allocation can result in a leak if not freed after use.</span></span> <span data-ttu-id="ef3de-116">Ниже приведены некоторые примеры распространенных шаблонов выделения.</span><span class="sxs-lookup"><span data-stu-id="ef3de-116">Here are some examples of common allocation patterns:</span></span>

-   <span data-ttu-id="ef3de-117">Память кучи с помощью функции [**хеапаллок**](/windows/win32/api/heapapi/nf-heapapi-heapalloc) или среды выполнения C/C++ эквивалента **malloc** или **New**</span><span class="sxs-lookup"><span data-stu-id="ef3de-117">Heap memory via the [**HeapAlloc**](/windows/win32/api/heapapi/nf-heapapi-heapalloc) function or its C/C++ runtime equivalents **malloc** or **new**</span></span>
-   <span data-ttu-id="ef3de-118">Прямые выделения из операционной системы с помощью функции [**VirtualAlloc**](/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) .</span><span class="sxs-lookup"><span data-stu-id="ef3de-118">Direct allocations from the operating system via the [**VirtualAlloc**](/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) function.</span></span>
-   <span data-ttu-id="ef3de-119">Дескрипторы ядра, созданные через API kernel32, такие как [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea), [**CreateEvent**](/windows/win32/api/synchapi/nf-synchapi-createeventa)или [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread), хранят память ядра от имени приложения.</span><span class="sxs-lookup"><span data-stu-id="ef3de-119">Kernel handles created via Kernel32 APIs such as [**CreateFile**](/windows/win32/api/fileapi/nf-fileapi-createfilea), [**CreateEvent**](/windows/win32/api/synchapi/nf-synchapi-createeventa), or [**CreateThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread), hold kernel memory on behalf of the application</span></span>
-   <span data-ttu-id="ef3de-120">GDI и пользовательские дескрипторы, созданные с помощью интерфейсов API user32 и GDI32 (по умолчанию каждый процесс имеет квоту 10 000 дескрипторов).</span><span class="sxs-lookup"><span data-stu-id="ef3de-120">GDI and USER handles created via User32 and Gdi32 APIs (by default, each process has a quota of 10,000 handles)</span></span>

## <a name="best-practices"></a><span data-ttu-id="ef3de-121">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="ef3de-121">Best Practices</span></span>

<span data-ttu-id="ef3de-122">Мониторинг потребления ресурсов приложением с течением времени — это первый шаг в определении и диагностике утечек памяти.</span><span class="sxs-lookup"><span data-stu-id="ef3de-122">Monitoring the resource consumption of your application over time is the first step in detecting and diagnosing memory leaks.</span></span> <span data-ttu-id="ef3de-123">Используйте диспетчер задач Windows и добавьте следующие столбцы: "размер фиксации", "дескрипторы", "объекты пользователя" и "объекты GDI".</span><span class="sxs-lookup"><span data-stu-id="ef3de-123">Use Windows Task Manager and add the following columns: "Commit Size", "Handles", "User Objects", and "GDI Objects".</span></span> <span data-ttu-id="ef3de-124">Это позволит вам создавать базовые показатели для приложения и отслеживать использование ресурсов с течением времени.</span><span class="sxs-lookup"><span data-stu-id="ef3de-124">This will allow you to establish a baseline for your application and monitor resource usage over time.</span></span>

![Снимок экрана, показывающий страницу "процессы" в диспетчере задач Windows.](images/preventingmemoryleaks-windowstaskmanager.gif)

<span data-ttu-id="ef3de-126">Следующие средства Майкрософт предоставляют более подробную информацию и позволяют обнаруживать и диагностировать утечки для различных типов распределения в приложении:</span><span class="sxs-lookup"><span data-stu-id="ef3de-126">The following Microsoft tools provide more-detailed information and can help to detect and diagnose leaks for the various allocation types in your application:</span></span>

-   <span data-ttu-id="ef3de-127">Системный монитор и монитор ресурсов являются частью Windows 7 и могут отслеживать использование ресурсов и работать с ними на диаграмме с течением времени</span><span class="sxs-lookup"><span data-stu-id="ef3de-127">Performance Monitor and Resource Monitor are part of Windows 7 and can monitor and graph resource use over time</span></span>
-   <span data-ttu-id="ef3de-128">Последняя версия средство проверки приложений может диагностировать утечки кучи в Windows 7</span><span class="sxs-lookup"><span data-stu-id="ef3de-128">The latest version of Application Verifier can diagnose heap leaks on Windows 7</span></span>
-   <span data-ttu-id="ef3de-129">УМДХ, который является частью средств отладки для Windows, анализирует выделение памяти кучи для данного процесса и может помочь найти утечки и другие необычные шаблоны использования</span><span class="sxs-lookup"><span data-stu-id="ef3de-129">UMDH, which is part of the Debugging Tools for Windows, analyzes the heap memory allocations for a given process and can help find leaks and other unusual usage patterns</span></span>
-   <span data-ttu-id="ef3de-130">XPerf — это сложное средство анализа производительности с поддержкой трассировок выделения кучи.</span><span class="sxs-lookup"><span data-stu-id="ef3de-130">Xperf is a sophisticated performance analysis tool with support for heap allocation traces</span></span>
-   <span data-ttu-id="ef3de-131">Отладочная куча CRT отслеживает выделение кучи и может помочь в построении собственных функций отладки кучи.</span><span class="sxs-lookup"><span data-stu-id="ef3de-131">CRT Debug Heap tracks heap allocations and can help build your own heap debugging features</span></span>

<span data-ttu-id="ef3de-132">Некоторые рекомендации по написанию кода и проектированию могут ограничивать количество утечек в коде.</span><span class="sxs-lookup"><span data-stu-id="ef3de-132">Certain coding and design practices can limit the number of leaks in your code.</span></span>

-   <span data-ttu-id="ef3de-133">Используйте смарт-указатели в коде C++ как для выделения кучи, так и для ресурсов Win32, таких как **маркер** ядра s.</span><span class="sxs-lookup"><span data-stu-id="ef3de-133">Use smart pointers in C++ code both for heap allocations as well as for Win32 resources like kernel **HANDLE** s.</span></span> <span data-ttu-id="ef3de-134">Стандартная библиотека C++ предоставляет автоматический класс **\_ ptr** для выделения кучи.</span><span class="sxs-lookup"><span data-stu-id="ef3de-134">The C++ Standard library provides the **auto\_ptr** class for heap allocations.</span></span> <span data-ttu-id="ef3de-135">Для других типов выделения потребуется написать собственные классы.</span><span class="sxs-lookup"><span data-stu-id="ef3de-135">For other allocation types you will need to write your own classes.</span></span> <span data-ttu-id="ef3de-136">Библиотека ATL предоставляет широкий набор классов для автоматического управления ресурсами как для объектов кучи, так и для дескрипторов ядра.</span><span class="sxs-lookup"><span data-stu-id="ef3de-136">The ATL library provides a rich set of classes for automatic resource management for both heap objects and kernel handles</span></span>
-   <span data-ttu-id="ef3de-137">Используйте встроенные функции компилятора, такие как **\_ COM \_ ptr \_ t** , для инкапсуляции указателей COM-интерфейса в "интеллектуальные указатели" и помощи при подсчете ссылок.</span><span class="sxs-lookup"><span data-stu-id="ef3de-137">Use compiler intrinsic features like **\_com\_ptr\_t** to encapsulate your COM interface pointers into "smart pointers" and assist with reference counting.</span></span> <span data-ttu-id="ef3de-138">Существуют похожие классы для других типов данных COM: **\_ BSTR \_ t** и **\_ Variant \_ t**</span><span class="sxs-lookup"><span data-stu-id="ef3de-138">There are similar classes for other COM data types: **\_bstr\_t** and **\_variant\_t**</span></span>
-   <span data-ttu-id="ef3de-139">Отслеживайте необычное использование памяти в коде .NET.</span><span class="sxs-lookup"><span data-stu-id="ef3de-139">Monitor your .NET code unusual memory usage.</span></span> <span data-ttu-id="ef3de-140">Управляемый код не является незащищенным от утечек памяти.</span><span class="sxs-lookup"><span data-stu-id="ef3de-140">Managed code is not immune to memory leaks.</span></span> <span data-ttu-id="ef3de-141">Сведения о поиске утечек GC см. в разделе ["Отслеживание утечек памяти в управляемом виде"](/archive/blogs/ricom/) .</span><span class="sxs-lookup"><span data-stu-id="ef3de-141">See ["Tracking down managed memory leaks"](/archive/blogs/ricom/) on how to find GC leaks</span></span>
-   <span data-ttu-id="ef3de-142">Помните о шаблонах утечек в коде на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="ef3de-142">Be aware of leak patterns in web client-side code.</span></span> <span data-ttu-id="ef3de-143">Циклические ссылки между COM-объектами и обработчиками сценариев, такими как JScript, могут привести к большим утечкам в приложениях.</span><span class="sxs-lookup"><span data-stu-id="ef3de-143">Circular references between COM objects and scripting engines like JScript can cause large leaks in web applications.</span></span> <span data-ttu-id="ef3de-144">["Основные сведения и решение проблем с утечками Internet Explorer"](/previous-versions/ms976398(v=msdn.10)) содержит больше информации об этих типах утечек.</span><span class="sxs-lookup"><span data-stu-id="ef3de-144">["Understanding and Solving Internet Explorer Leak Patterns"](/previous-versions/ms976398(v=msdn.10)) has more information on these kinds of leaks.</span></span> <span data-ttu-id="ef3de-145">Для отладки утечек памяти в коде можно использовать средство обнаружения утечек памяти JavaScript.</span><span class="sxs-lookup"><span data-stu-id="ef3de-145">You can use the JavaScript Memory Leak Detector to debug memory leaks in your code.</span></span> <span data-ttu-id="ef3de-146">Хотя Windows Internet Explorer 8, поставляемый с Windows 7, устраняет большую часть этих проблем, старые браузеры остаются уязвимыми для этих ошибок.</span><span class="sxs-lookup"><span data-stu-id="ef3de-146">While Windows Internet Explorer 8, which is shipping with Windows 7, mitigates most of these issues, older browsers are still vulnerable to these bugs</span></span>
-   <span data-ttu-id="ef3de-147">Избегайте использования нескольких путей выхода из функции.</span><span class="sxs-lookup"><span data-stu-id="ef3de-147">Avoid using multiple exit paths from a function.</span></span> <span data-ttu-id="ef3de-148">Выделения, назначенные переменным в области видимости функции, должны освобождаться в одном конкретном блоке в конце функции.</span><span class="sxs-lookup"><span data-stu-id="ef3de-148">Allocations assigned to variables at function scope should be freed in one particular block at the end of the function</span></span>
-   <span data-ttu-id="ef3de-149">Не используйте исключения в коде без высвобождения всех локальных переменных в функциях.</span><span class="sxs-lookup"><span data-stu-id="ef3de-149">Do not use exceptions in your code without freeing all local variables in functions.</span></span> <span data-ttu-id="ef3de-150">При использовании собственных исключений Освободите все выделенные ресурсы внутри \_ \_ блока finally.</span><span class="sxs-lookup"><span data-stu-id="ef3de-150">If you use native exceptions, free all your allocations inside the \_\_finally block.</span></span> <span data-ttu-id="ef3de-151">При использовании исключений C++ все кучи и обработку выделений должны быть заключены в интеллектуальные указатели.</span><span class="sxs-lookup"><span data-stu-id="ef3de-151">If you use C++ exceptions, all your heap and handle allocations need to be wrapped in smart pointers</span></span>
-   <span data-ttu-id="ef3de-152">Не отменяйте или не инициализируйте объект [**пропвариант**](/windows/win32/api/propidlbase/ns-propidlbase-propvariant) без вызова функции [**пропвариантклеар**](/windows/win32/api/combaseapi/nf-combaseapi-propvariantclear)</span><span class="sxs-lookup"><span data-stu-id="ef3de-152">Do not discard or reinitialize a [**PROPVARIANT**](/windows/win32/api/propidlbase/ns-propidlbase-propvariant) object without calling the [**PropVariantClear**](/windows/win32/api/combaseapi/nf-combaseapi-propvariantclear) function</span></span>

## <a name="links-to-resources"></a><span data-ttu-id="ef3de-153">Ссылки на ресурсы</span><span class="sxs-lookup"><span data-stu-id="ef3de-153">Links to Resources</span></span>

<span data-ttu-id="ef3de-154">*Распространенные шаблоны выделения:*</span><span class="sxs-lookup"><span data-stu-id="ef3de-154">*Common Allocation Patterns:*</span></span>

-   [<span data-ttu-id="ef3de-155">**Функция выделения кучи**</span><span class="sxs-lookup"><span data-stu-id="ef3de-155">**Heap Allocation Function**</span></span>](/windows/win32/api/heapapi/nf-heapapi-heapalloc)
-   <span data-ttu-id="ef3de-156">[**Функция выделения памяти**](https://msdn.microsoft.com/library/6ewkz86d(v=VS.71).aspx)</span><span class="sxs-lookup"><span data-stu-id="ef3de-156">[**Memory Allocation Function**](https://msdn.microsoft.com/library/6ewkz86d(v=VS.71).aspx)</span></span>
-   <span data-ttu-id="ef3de-157">[**Оператор New (C++)**](https://msdn.microsoft.com/library/kewsb8ba(v=VS.71).aspx)</span><span class="sxs-lookup"><span data-stu-id="ef3de-157">[**New Operator (C++)**](https://msdn.microsoft.com/library/kewsb8ba(v=VS.71).aspx)</span></span>
-   [<span data-ttu-id="ef3de-158">**Виртуальная функция выделения**</span><span class="sxs-lookup"><span data-stu-id="ef3de-158">**Virtual Allocation Function**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc)
-   [<span data-ttu-id="ef3de-159">Объекты ядра</span><span class="sxs-lookup"><span data-stu-id="ef3de-159">Kernel Objects</span></span>](../sysinfo/kernel-objects.md)
-   [<span data-ttu-id="ef3de-160">Дескрипторы объектов GDI</span><span class="sxs-lookup"><span data-stu-id="ef3de-160">GDI Object Handles</span></span>](../sysinfo/gdi-objects.md)
-   [<span data-ttu-id="ef3de-161">Дескрипторы объектов пользовательского интерфейса</span><span class="sxs-lookup"><span data-stu-id="ef3de-161">User Interface Object Handles</span></span>](../sysinfo/user-objects.md)

<span data-ttu-id="ef3de-162">*Средства Майкрософт:*</span><span class="sxs-lookup"><span data-stu-id="ef3de-162">*Microsoft Tools:*</span></span>

-   [<span data-ttu-id="ef3de-163">средство проверки приложений</span><span class="sxs-lookup"><span data-stu-id="ef3de-163">Application Verifier</span></span>](application-verifier.md)
-   [<span data-ttu-id="ef3de-164">Средства отладки для Windows</span><span class="sxs-lookup"><span data-stu-id="ef3de-164">Debugging Tools for Windows</span></span>](/windows-hardware/drivers/debugger/)
-   [<span data-ttu-id="ef3de-165">Куча дампа пользовательского режима</span><span class="sxs-lookup"><span data-stu-id="ef3de-165">User-Mode Dump Heap</span></span>](/windows-hardware/drivers/debugger/umdh)
-   [<span data-ttu-id="ef3de-166">Средство отслеживания трассировки, обработки и анализа</span><span class="sxs-lookup"><span data-stu-id="ef3de-166">Trace Capture, Processing, and Analysis Tool</span></span>](https://msdn.microsoft.com/performance/cc825801.aspx)
-   [<span data-ttu-id="ef3de-167">Куча отладки CRT</span><span class="sxs-lookup"><span data-stu-id="ef3de-167">CRT Debug Heap</span></span>](/visualstudio/debugger/crt-debug-heap-details?view=vs-2015)

<span data-ttu-id="ef3de-168">*Дополнительные ссылки:*</span><span class="sxs-lookup"><span data-stu-id="ef3de-168">*Additional Links:*</span></span>

-   <span data-ttu-id="ef3de-169">[**Автоматический \_ класс PTR**](https://msdn.microsoft.com/library/ew3fk483(v=VS.71).aspx)</span><span class="sxs-lookup"><span data-stu-id="ef3de-169">[**auto\_ptr Class**](https://msdn.microsoft.com/library/ew3fk483(v=VS.71).aspx)</span></span>
-   <span data-ttu-id="ef3de-170">[Классы памяти библиотеки активных шаблонов (ATL)](https://msdn.microsoft.com/library/44yh1z4f(v=VS.71).aspx)</span><span class="sxs-lookup"><span data-stu-id="ef3de-170">[Active Template Library (ATL) Memory Classes](https://msdn.microsoft.com/library/44yh1z4f(v=VS.71).aspx)</span></span>
-   <span data-ttu-id="ef3de-171">[**\_\_объект COM PTR \_ t**](https://msdn.microsoft.com/library/417w8b3b(v=VS.71).aspx)</span><span class="sxs-lookup"><span data-stu-id="ef3de-171">[**\_com\_ptr\_t Object**](https://msdn.microsoft.com/library/417w8b3b(v=VS.71).aspx)</span></span>
-   <span data-ttu-id="ef3de-172">[**\_\_класс BSTR t**](https://msdn.microsoft.com/library/zthfhkd6(v=VS.71).aspx)</span><span class="sxs-lookup"><span data-stu-id="ef3de-172">[**\_bstr\_t Class**](https://msdn.microsoft.com/library/zthfhkd6(v=VS.71).aspx)</span></span>
-   <span data-ttu-id="ef3de-173">[**\_\_класс Variant YT**](https://msdn.microsoft.com/library/x295h94e(v=VS.71).aspx)</span><span class="sxs-lookup"><span data-stu-id="ef3de-173">[**\_variant\_yt Class**](https://msdn.microsoft.com/library/x295h94e(v=VS.71).aspx)</span></span>
-   [<span data-ttu-id="ef3de-174">"Отслеживание утечек памяти в управляемом виде"</span><span class="sxs-lookup"><span data-stu-id="ef3de-174">"Tracking down managed memory leaks"</span></span>](/archive/blogs/ricom/)
-   <span data-ttu-id="ef3de-175">[«Основные сведения и разрешение шаблонов утечек Internet Explorer»](/previous-versions/ms976398(v=msdn.10))</span><span class="sxs-lookup"><span data-stu-id="ef3de-175">["Understanding and Solving Internet Explorer Leak Patterns"](/previous-versions/ms976398(v=msdn.10))</span></span>
-   [<span data-ttu-id="ef3de-176">"Детектор утечки памяти JavaScript"</span><span class="sxs-lookup"><span data-stu-id="ef3de-176">"JavaScript Memory Leak Detector"</span></span>](/archive/blogs/gpde/new-javascript-memory-leak-detector-from-our-team)
-   <span data-ttu-id="ef3de-177">[Циклическая утечка памяти (в браузерах):](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/dd361842(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="ef3de-177">[Circular Memory Leak Mitigation (in browsers):](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/dd361842(v=vs.85))</span></span>
-   <span data-ttu-id="ef3de-178">[**Оператор try-finally**](https://msdn.microsoft.com/library/yb3kz605(v=VS.71).aspx)</span><span class="sxs-lookup"><span data-stu-id="ef3de-178">[**try-finally statement**](https://msdn.microsoft.com/library/yb3kz605(v=VS.71).aspx)</span></span>
-   [<span data-ttu-id="ef3de-179">**Структура ПРОПВАРИАНТ**</span><span class="sxs-lookup"><span data-stu-id="ef3de-179">**PROPVARIANT Structure**</span></span>](/windows/win32/api/propidlbase/ns-propidlbase-propvariant)
-   [<span data-ttu-id="ef3de-180">**Функция Пропвариантклеар**</span><span class="sxs-lookup"><span data-stu-id="ef3de-180">**PropVariantClear Function**</span></span>](/windows/win32/api/combaseapi/nf-combaseapi-propvariantclear)

 

 
