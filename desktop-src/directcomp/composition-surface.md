---
title: Область композиции
description: В этом разделе описываются типы типов поверхностей, которые поддерживает Microsoft DirectComposition.
ms.assetid: E19B4F0E-1CFA-4E93-BB6A-BFB701BC72CA
keywords:
- область композиции
- Логическая поверхность DirectComposition
- Виртуальная поверхность DirectComposition
- Обновление логической поверхности
- логическая поверхность, обновление
- Обрезка виртуальной поверхности
- Виртуальная поверхность, усечение
- обрезать виртуальную поверхность
- изменение размера виртуальной поверхности
- виртуальные сурейса, изменение размера
- изменить размер виртуальной поверхности
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9f4bd30bfbd1de91444b7076184db597cd7a8c82
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "104070181"
---
# <a name="composition-surface"></a>Область композиции

> [!NOTE]
> Для приложений в Windows 10 рекомендуется использовать интерфейсы API Windows. UI. компоновки вместо DirectComposition. Дополнительные сведения см. в разделе [модернизировать The классическое приложение с использованием визуального слоя](/windows/uwp/composition/visual-layer-in-desktop-apps).

В этом разделе описываются типы типов поверхностей, которые поддерживает Microsoft DirectComposition.

-   [Логическая поверхность DirectComposition](#directcomposition-logical-surface)
    -   [Обновление логической поверхности](#updating-a-logical-surface)
    -   [Приостановка обновлений на логическую поверхность](#suspending-updates-to-a-logical-surface)
    -   [Возобновление работы обновлений на логическую поверхность](#resuming-updates-to-a-logical-surface)
    -   [Завершение обновлений на логическую поверхность](#suspending-updates-to-a-logical-surface)
    -   [Пример использования логической поверхности](#example-of-using-a-logical-surface)
-   [Виртуальная поверхность DirectComposition](#directcomposition-virtual-surface)
    -   [Изменение размера виртуальной поверхности](#resizing-a-virtual-surface)
    -   [Обрезка виртуальной поверхности](#trimming-a-virtual-surface)
-   [См. также](#related-topics)

## <a name="directcomposition-logical-surface"></a>Логическая поверхность DirectComposition

DirectComposition предоставляет объект [**идкомпоситионсурфаце**](/windows/win32/api/dcomp/nn-dcomp-idcompositionsurface) для представления логической области композиции. DirectComposition предоставляет интерфейсы API, которые можно использовать для создания, обновления и удаления этих логических поверхностей. Каждая поверхность может быть связана с одним или несколькими визуальными элементами. Приложение отвечает за управление жизненным циклом логических поверхностей.

### <a name="updating-a-logical-surface"></a>Обновление логической поверхности

Приложение может обновить логическую поверхность, вызвав [**бегиндрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-begindraw) и указав размер и смещение прямоугольника на логической поверхности, которую приложение желает обновить. DirectComposition выделяет прямоугольник указанного размера, а затем возвращает поверхность и соответствующее смещение, которое приложение должно нарисовать или обновить. Ограничения прямоугольника обновления связаны размером поверхности. Например, прямоугольник обновления для поверхности с 40 на 100 пикселей может иметь значение до (0, 0, 40100). Кроме того, обновляемая область обеспечивается ограничивающим прямоугольником. Так как в каждый момент времени может быть только один прямоугольник защиты, одновременно может обновляться только одна логическая область. **Бегиндрав** возвращает код ошибки, если [**EndDraw**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-enddraw) или [**суспенддрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-suspenddraw) не вызывался после предыдущего вызова **бегиндрав**. Приложение может добавить зафиксированный вызов **бегиндрав** в пакет, но не вступит в силу, пока **EndDraw** не будет вызван и зафиксирован.

### <a name="suspending-updates-to-a-logical-surface"></a>Приостановка обновлений на логическую поверхность

Приложение, нуждающееся в обновлении разных поверхностей, может вызвать [**суспенддрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-suspenddraw) для текущего обновления, а затем вызвать [**бегиндрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-begindraw) , чтобы начать новое обновление. Microsoft DirectComposition допускает несколько обновлений, но только один может быть активным за раз. Это означает, что необходимо вызвать **суспенддрав** или [**EndDraw**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-enddraw) на одной поверхности перед вызовом **бегиндрав** для следующего. В отличие от **EndDraw**, зафиксированный пакет может содержать поверхность, которая находится в **суспенддрав** состоянии, но такие обновления не будут отображаться на экране, пока не будет вызван **EndDraw** .

### <a name="resuming-updates-to-a-logical-surface"></a>Возобновление работы обновлений на логическую поверхность

Приложение может возобновить обновление до поверхности в [**суспенддрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-suspenddraw) состоянии путем вызова [**ресумедрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-resumedraw). Этот метод может быть вызван только на приостановленной поверхности.

### <a name="ending-updates-to-a-logical-surface"></a>Завершение обновлений на логическую поверхность

Вызов [**EndDraw**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-enddraw) и [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) является единственным способом просмотра изменений точечных рисунков на экране. Каждый вызов **EndDraw** должен иметь соответствующий вызов [**бегиндрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-begindraw) для удаления прямоугольника защиты. Логическая поверхность сохраняет все обновления до тех пор, пока не будет вызвана **фиксация** . Можно также вызвать **EndDraw** на поверхности, которая находится в состоянии [**суспенддрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-suspenddraw) , так как **EndDraw** является подразумеваемым возобновлением/окончанием. После вызова **EndDraw** обновленное содержимое отображается на экране и удаляется, чтобы память для обновления могла повторно использоваться для последующего обновления.

### <a name="example-of-using-a-logical-surface"></a>Пример использования логической поверхности

В следующем примере описываются шаги, которые может предпринять приложение при создании визуального дерева, состоящего из двух визуальных элементов, а затем требуется обновить определенные регионы двух логических поверхностей, связанных с визуальными элементами.

1.  Создайте устройство DirectComposition.
2.  Создайте визуальное дерево, состоящее из корневого узла и визуальных элементов 1 и 2.
3.  Создайте логические поверхности 1 и 2.
4.  Вызовите [**сетконтент**](/windows/win32/api/dcomp/nf-dcomp-idcompositionvisual-setcontent) , чтобы связать логическую поверхность с визуальными элементами 1 и 2.
5.  Вызовите [**бегиндрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-begindraw) в подпрямоугольнике логической поверхности 1.
6.  Обновление поверхности в смещении, возвращенном DirectComposition.
7.  Другие возможные шаги.
    1.  Вызовите [**суспенддрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-suspenddraw) на логической поверхности 1.
    2.  Вызовите [**бегиндрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-begindraw) для подпрямоугольника логической поверхности 2.
    3.  Обновление поверхности в смещении, возвращенном DirectComposition.
    4.  Вызовите [**EndDraw**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-enddraw) на логической поверхности 2.
    5.  Вызовите [**ресумедрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-resumedraw) на логической поверхности 1.
8.  Обновление поверхности в смещении, возвращенном DirectComposition.
9.  Вызовите [**EndDraw**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-enddraw) на логической поверхности 1.
10. Вызов [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit).

## <a name="directcomposition-virtual-surface"></a>Виртуальная поверхность DirectComposition

DirectComposition предоставляет интерфейс [**идкомпоситионвиртуалсурфаце**](/windows/win32/api/dcomp/nn-dcomp-idcompositionvirtualsurface) для представления виртуальной поверхности, которая представляет собой коллекцию логических поверхностей (плиток), расположенных в фиксированной сетке с плитками фиксированного размера. Приложение задает размер виртуальной текстуры во время создания. Размер определяет границы виртуальной поверхности. Поверхность может быть связана с одним или несколькими визуальными элементами.

При инициализации виртуальной поверхности она не поддерживается фактическими выделениями. Иными словами, он не хранит никаких битов. DirectComposition выделяет плитки (т. е. объекты поверхности композиции) после того, как приложение запустит обновление поверхности. Приложение обновляет виртуальную поверхность, вызывая [**бегиндрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-begindraw) и указывая интересующую область относительно координат виртуальной поверхности. Затем DirectComposition выделяет необходимые плитки для размещения обновления и возвращает поверхность композиции и смещение для обновления.

Как и для логических поверхностей, вы можете вызывать [**бегиндрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-begindraw), [**суспенддрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-suspenddraw), [**ресумедрав**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-resumedraw) и [**EndDraw**](/windows/win32/api/dcomp/nf-dcomp-idcompositionsurface-enddraw) на виртуальной поверхности. Кроме того, DirectComposition предоставляет методы, которые можно использовать для изменения размера и обрезки существующей виртуальной поверхности.

### <a name="resizing-a-virtual-surface"></a>Изменение размера виртуальной поверхности

Метод изменения [**размера**](/windows/win32/api/dcomp/nf-dcomp-idcompositionvirtualsurface-resize) изменяет границы виртуальной поверхности, что означает, что новые обновления или выделения должны попадать в границы, заданные новым размером. Приложение использует **Размер** , чтобы сообщить DirectComposition, что определенный регион виртуальной поверхности больше не нужен и его можно освободить. Если **изменить размер** сжимает виртуальную поверхность, приложение больше не сможет обновлять регионы за пределами новых границ.

На следующем рисунке показано, что размер виртуальной поверхности с 3 по 3 изменен на 2. Красная область представляет плитки, которые отбрасываются в ходе операции изменения размера, и память освобождается DirectComposition. После изменения размера приложение не сможет вносить обновления в красный регион без изменения размера виртуальной поверхности.

![изменение размера виртуальной поверхности ](images/resize-virtual-surface.png)

Операция изменения размера вступает в силу немедленно. DirectComposition не ждет, пока приложение вызовет [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) для внесения изменений в размер. Например, предположим, что приложение выполняет следующую последовательность вызовов.


```
pVirtualSurface->Resize(0, 0);
pVirtualSurface->Resize(INT_MAX, INT_MAX);
pDevice->Commit();
```



В этом примере приложение теряет все содержимое при первом изменении размера. Второй размер не действует, несмотря на то, что он был вызван перед [**фиксацией**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit). В этом случае на экране ничего не отображается.

### <a name="trimming-a-virtual-surface"></a>Обрезка виртуальной поверхности

Метод [**Trim**](/windows/win32/api/dcomp/nf-dcomp-idcompositionvirtualsurface-trim) определяет регион виртуальной поверхности, который требуется приложению. Она не изменяет размер границ виртуальной поверхности, но она сообщает DirectComposition, какие логические поверхности в данный момент необходимо выделить.

На следующем рисунке зеленый квадрат — это окно просмотра приложения. Сначала приложение подготавливается к первым шести плиткам (синим) виртуальной поверхности (светло-серым), которые находятся в окне просмотра. По мере прокрутки страницы, представленной виртуальной поверхностью, приложению необходимо визуализировать последние шесть плиток. Приложение вызывает [**Trim**](/windows/win32/api/dcomp/nf-dcomp-idcompositionvirtualsurface-trim) , чтобы указать, что область, определенная последними шести плитками, является местом, где находится содержимое, а остальное не требуется в данный момент. DirectComposition может затем перезапустить логические поверхности, которые изначально представляли первые шесть плиток (темно-серый цвет).

![Обрезка виртуальной поверхности](images/trim-virtual-surface.png)

## <a name="related-topics"></a>См. также

<dl> <dt>

[Основные понятия DirectComposition](directcomposition-concepts.md)
</dt> </dl>

 

 