---
title: Архитектура и компоненты
description: В этом разделе описываются компоненты, составляющие Microsoft DirectComposition.
ms.assetid: 7C79B330-41EA-4BA0-9103-BB5A0C3D4CE2
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fb2de495aa170560b1e7082cacf1893a8c94905a
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "104070438"
---
# <a name="architecture-and-components"></a>Архитектура и компоненты

> [!NOTE]
> Для приложений в Windows 10 рекомендуется использовать интерфейсы API Windows. UI. компоновки вместо DirectComposition. Дополнительные сведения см. в разделе [модернизировать The классическое приложение с использованием визуального слоя](/windows/uwp/composition/visual-layer-in-desktop-apps).

В этом разделе описываются компоненты, составляющие Microsoft DirectComposition. Он состоит из следующих разделов.

-   [Компоненты программного обеспечения](#software-components)
-   [Библиотека приложений](#application-library)
-   [Механизм композиции](#composition-engine)
-   [См. также](#related-topics)

## <a name="software-components"></a>Компоненты программного обеспечения

DirectComposition состоит из следующих основных компонентов программного обеспечения.

-   Библиотека приложений пользовательского режима (dcomp.dll), которая реализует общедоступный API-интерфейс на основе модели объектов.
-   Механизм композиции пользовательского режима (dwmcore.dll), который размещается в процессе диспетчер окон рабочего стола (DWM) (dwm.exe) и выполняет фактическую композицию рабочего стола.
-   База данных объектов режима ядра (часть win32k.sys), которая маршалирует команды из приложения в механизм композиции.

Один экземпляр механизма композиции обрабатывает деревья композиции DirectComposition для всех приложений и дерева композиции DWM, которое представляет весь рабочий стол. Как база данных объектов режима ядра, так и механизм композиции пользовательского режима создаются один раз для каждого сеанса, поэтому компьютер сервера терминалов с несколькими пользователями имеет несколько экземпляров этих компонентов.

На следующей диаграмме показаны основные компоненты DirectComposition и их связь друг с другом.

![архитектура верхнего уровня directcomposition](images/directcomposition-top-level-architecture.png)

## <a name="application-library"></a>Библиотека приложений

Библиотека приложений DirectComposition является общедоступным API-интерфейсом на основе COM с единой плоской точкой входа, которая экспортируется из dcomp.dll и возвращает указатель интерфейса на объект устройства. Объект устройства, в свою очередь, имеет методы для создания всех остальных объектов, каждый из которых представлен указателем интерфейса. Все интерфейсы DirectComposition наследуют от и полностью реализуют интерфейс [**IUnknown**](/windows/desktop/api/unknwn/nn-unknwn-iunknown) . Все методы, принимающие интерфейсы DirectComposition, проверяют, реализован ли интерфейс внутри dcomp.dll или он реализуется другим компонентом. Поскольку DirectComposition не является расширяемым, методы, принимающие интерфейсы в качестве параметров, возвращают E \_ INVALIDARG, если интерфейсы не реализованы в dcomp.dll. API не требует специальных прав; Он может вызываться процессами, работающими на самом низком уровне доступа. Однако, поскольку API не работает в сеансе 0, он не подходит для служб. В связи с этим API DirectComposition аналогичен другим интерфейсам API Microsoft DirectX, особенно Direct2D, Microsoft Direct3D и Microsoft DirectWrite.

Поскольку механизм композиции предназначен исключительно для асинхронного выполнения, свойства объекта в API DirectComposition доступны только для записи. Все свойства имеют методы задания, но не имеют методов Get. Чтение свойств не только требует ресурсов, но и может быть неточным, так как любое значение, возвращаемое ядром композиции, сразу становится недействительным. Это может произойти, например, если независимая анимация привязана к свойству, которое считывается.

API является потокобезопасным. Приложение может вызывать любой метод из любого потока в любое время. Однако, поскольку многие методы API должны вызываться в определенной последовательности без синхронизации, приложение может столкнуться с непредсказуемым поведением в зависимости от того, как потоки находятся в чередовании. Например, если два потока меняют одинаковое свойство одного и того же объекта на разные значения одновременно, приложение не сможет предсказать, какое из двух значений будет конечным значением свойства. Аналогично, если два потока вызывают [**фиксацию**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) на одном и том же устройстве, ни один из потоков не получит транзакционное поведение, так как вызов **commit** в одном потоке отправляет пакет всех команд, выданных обоими потоками, а не только тот, который назывался **commit**.

Система обслуживает все внутреннее состояние каждого объекта устройства. Если приложение создает два или более объектов устройств DirectComposition, приложение может поддерживать независимые пакеты и другое состояние между ними.

Все объекты DirectComposition имеют сходство объектов устройств; объекты, созданные определенным объектом устройства, могут использоваться только с этим объектом устройства и могут быть связаны только с другими объектами, созданными одним и тем же объектом устройства. Иными словами, каждый объект устройства является отдельным несвязанным островом функциональности. Единственным исключением является визуальный класс, который позволяет создавать визуальные деревья, в которых визуальный элемент может принадлежать другому объекту устройства, отличному от родительского. Это позволяет использовать сценарии, в которых приложение и элемент управления могут управлять одним деревом компоновки, не требуя совместного использования одного объекта устройства DirectComposition.

## <a name="composition-engine"></a>Механизм композиции

Подсистема композиции DirectComposition выполняется в выделенном процессе отдельно от любого процесса приложения. Один процесс композиции, dwm.exe, поддерживает каждое приложение в сеансе. Каждое приложение может создавать два визуальных дерева для каждого окна, которое оно владеет. Все деревья фактически реализуются как поддеревья более крупного визуального дерева, которые также охватывают структуры композиции DWM. DWM формирует одно крупное визуальное дерево для каждого рабочего стола в сеансе. Ниже приведены основные преимущества этой архитектуры.

-   Механизм композиции имеет доступ ко всем точечным рисункам приложений и визуальным деревьям, что обеспечивает взаимодействие и компоновку межпроцессного окна.
-   Механизм композиции выполняется в доверенном системном процессе, отдельном от любого процесса приложения, что позволяет приложениям с низкими правами доступа безопасно создавать защищенное содержимое.
-   Механизм композиции может определить, когда конкретное окно полностью перекрыто и избежать расхода ресурсов ЦП и графического процессора, составленного для окна.
-   Механизм композиции может составляться непосредственно в буфере экрана, что позволяет избежать необходимости в дополнительной копии, необходимой для обработчиков композиции каждого процесса.
-   Все приложения совместно используют одно устройство Direct3D для объединения, что обеспечивает значительную экономию памяти.

Визуальное дерево является сохраняемой структурой. API DirectComposition предоставляет методы для изменения структуры в пакетах, которые обрабатываются атомарно. Корневым объектом в API DirectComposition является объект Device, который служит фабрикой для всех остальных объектов DirectComposition и содержит метод [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit). Механизм композиции не отражает изменения, которые приложение делает в визуальном дереве до тех пор, пока приложение не вызовет **фиксацию**, после чего все изменения с момента последней **фиксации** обрабатываются как одна транзакция.

Требование вызова функции [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) аналогично концепции "Frame" за исключением того, что механизм композиции выполняется асинхронно, и он может представлять несколько различных кадров между вызовами для **фиксации**. В DirectComposition *кадр* — это одна итерация механизма композиции, а интервал времени, затраченный приложением между двумя вызовами **commit** , называется *пакетом*.

DirectComposition выполняет пакетную обработку всех вызовов приложений к API DirectComposition. База данных объектов ядра, реализованная в драйвере сеанса win32k.sys, хранит все сведения о состоянии, связанные с вызовами API.

Механизм композиции создает по одному кадру для каждого вертикально пустого значения в окне просмотра. Кадр начинается с пустой вертикальной рамки и наследуется на последующий вертикальный пробел. При запуске кадра подсистема композиции выбирает все ожидающие пакеты и включает их команды в этот кадр. Пакеты помещаются в очередь ожидания, когда приложение вызывает [**фиксацию**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit), а очередь ожидания очищается атомарно в начале кадра. Таким образом, существует один момент времени, обозначающий начало кадра. Все пакеты, отправленные до этой точки, включаются в кадр, а все пакеты, отправленные после, должны дожидаться обработки следующего кадра. Полный цикл композиции выглядит следующим образом:

1.  Оцените время следующего вертикального пробела.
2.  Получение всех ожидающих пакетов.
3.  Обработка полученных пакетов.
4.  Обновите все анимации, используя время, заданное на шаге 1.
5.  Определите области экрана, которые необходимо повторно составить.
6.  Повторное Составление "грязных" регионов.
7.  Представьте фрейм, переустановив задний и передний буфер для каждого экрана.
8.  Если ничего не состояло и было представлено в шагах 6 и 7, дождитесь фиксации пакета.
9.  Ожидание следующего вертикального пробела.

При наличии нескольких мониторов, подключенных к одному видеоадаптеру, механизм композиции использует вертикальную пустую часть основного монитора, чтобы выполнить цикл композиции и задать время выборки анимации. Каждый монитор представлен отдельной цепочкой перелистывания в полноэкранном режиме. механизм композиции повторяет шаги 6 и 7 для каждого монитора в циклической манере, используя одно устройство Direct3D. При наличии нескольких видеоадаптеров механизм композиции использует отдельное устройство Direct3D для каждого видеоадаптера в шагах 6 и 7.

Кадры композиции по расписанию всегда начинаются с вертикального пробела, как показано на следующем рисунке.

![планирование кадров композиции](images/composition-frame-scheduling.png)

Если механизм композиции не работает, так как дерево композиции не изменилось, поток композиции задействуется в ожидании нового пакета. Когда отправляется новый пакет, поток композиции выходит из спящего режима, но сразу же возвращается в режим сна до следующего пустого значения по вертикали. Такое поведение обеспечивает предсказуемое время начала и окончания кадров для приложений и для механизма композиции.

Механизм композиции публикует время презентации кадра и текущую частоту кадров. Публикация этих сведений позволяет приложениям оценивать время презентации для собственных пакетов, что в своюмся позволяет синхронизировать анимацию. В частности, приложение может использовать сочетание статистики кадров из механизма композиции, а также историческую модель того, как долго поток пользовательского интерфейса занимается созданием пакета, чтобы определить время выборки для собственных анимаций.

Например, в начале пакета приложения, показанного на предыдущем рисунке, приложение может запросить механизм композиции, чтобы определить точное время презентации для следующего кадра. Затем приложение может использовать текущее время, а также сведения о предыдущих пакетах, которые он создал, чтобы определить, может ли приложение выполнить текущий пакет до следующего пустого вертикального. Таким образом, приложение использует время представления кадров в качестве времени выборки для собственных анимаций. Если приложение определяет, что вряд ли завершит свою работу в текущей вертикальной области, приложение может использовать последующее время кадра как время выборки, используя сведения о частоте кадров, возвращенные механизмом композиции для расчета этого времени.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Основные понятия DirectComposition](directcomposition-concepts.md)
</dt> </dl>

 

 