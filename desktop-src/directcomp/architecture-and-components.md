---
title: Архитектура и компоненты
description: В этом разделе описываются компоненты, составляющие Microsoft DirectComposition.
ms.assetid: 7C79B330-41EA-4BA0-9103-BB5A0C3D4CE2
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fb2de495aa170560b1e7082cacf1893a8c94905a
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "104070438"
---
# <a name="architecture-and-components"></a><span data-ttu-id="ad100-103">Архитектура и компоненты</span><span class="sxs-lookup"><span data-stu-id="ad100-103">Architecture and components</span></span>

> [!NOTE]
> <span data-ttu-id="ad100-104">Для приложений в Windows 10 рекомендуется использовать интерфейсы API Windows. UI. компоновки вместо DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="ad100-104">For apps on Windows 10, we recommend using Windows.UI.Composition APIs instead of DirectComposition.</span></span> <span data-ttu-id="ad100-105">Дополнительные сведения см. в разделе [модернизировать The классическое приложение с использованием визуального слоя](/windows/uwp/composition/visual-layer-in-desktop-apps).</span><span class="sxs-lookup"><span data-stu-id="ad100-105">For more info, see [Modernize your desktop app using the Visual layer](/windows/uwp/composition/visual-layer-in-desktop-apps).</span></span>

<span data-ttu-id="ad100-106">В этом разделе описываются компоненты, составляющие Microsoft DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="ad100-106">This topic describes the components that make up Microsoft DirectComposition.</span></span> <span data-ttu-id="ad100-107">Он состоит из следующих разделов.</span><span class="sxs-lookup"><span data-stu-id="ad100-107">It consists of the following sections.</span></span>

-   [<span data-ttu-id="ad100-108">Компоненты программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="ad100-108">Software components</span></span>](#software-components)
-   [<span data-ttu-id="ad100-109">Библиотека приложений</span><span class="sxs-lookup"><span data-stu-id="ad100-109">Application library</span></span>](#application-library)
-   [<span data-ttu-id="ad100-110">Механизм композиции</span><span class="sxs-lookup"><span data-stu-id="ad100-110">Composition engine</span></span>](#composition-engine)
-   [<span data-ttu-id="ad100-111">См. также</span><span class="sxs-lookup"><span data-stu-id="ad100-111">Related topics</span></span>](#related-topics)

## <a name="software-components"></a><span data-ttu-id="ad100-112">Компоненты программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="ad100-112">Software components</span></span>

<span data-ttu-id="ad100-113">DirectComposition состоит из следующих основных компонентов программного обеспечения.</span><span class="sxs-lookup"><span data-stu-id="ad100-113">DirectComposition consists of the following main software components.</span></span>

-   <span data-ttu-id="ad100-114">Библиотека приложений пользовательского режима (dcomp.dll), которая реализует общедоступный API-интерфейс на основе модели объектов.</span><span class="sxs-lookup"><span data-stu-id="ad100-114">A user-mode application library (dcomp.dll) that implements the Component Object Model (COM)-based public API.</span></span>
-   <span data-ttu-id="ad100-115">Механизм композиции пользовательского режима (dwmcore.dll), который размещается в процессе диспетчер окон рабочего стола (DWM) (dwm.exe) и выполняет фактическую композицию рабочего стола.</span><span class="sxs-lookup"><span data-stu-id="ad100-115">A user-mode composition engine (dwmcore.dll) that is hosted in the Desktop Window Manager (DWM) process (dwm.exe), and performs the actual desktop composition.</span></span>
-   <span data-ttu-id="ad100-116">База данных объектов режима ядра (часть win32k.sys), которая маршалирует команды из приложения в механизм композиции.</span><span class="sxs-lookup"><span data-stu-id="ad100-116">A kernel-mode object database (part of win32k.sys) that marshals commands from the application to the composition engine.</span></span>

<span data-ttu-id="ad100-117">Один экземпляр механизма композиции обрабатывает деревья композиции DirectComposition для всех приложений и дерева композиции DWM, которое представляет весь рабочий стол.</span><span class="sxs-lookup"><span data-stu-id="ad100-117">A single instance of the composition engine handles the DirectComposition composition trees for all applications and the DWM composition tree, which represents the entire desktop.</span></span> <span data-ttu-id="ad100-118">Как база данных объектов режима ядра, так и механизм композиции пользовательского режима создаются один раз для каждого сеанса, поэтому компьютер сервера терминалов с несколькими пользователями имеет несколько экземпляров этих компонентов.</span><span class="sxs-lookup"><span data-stu-id="ad100-118">Both the kernel-mode object database and the user-mode composition engine are instantiated once per session, so a Terminal Server machine with multiple users has multiple instances of both of those components.</span></span>

<span data-ttu-id="ad100-119">На следующей диаграмме показаны основные компоненты DirectComposition и их связь друг с другом.</span><span class="sxs-lookup"><span data-stu-id="ad100-119">The following diagram shows the main DirectComposition components and how they relate to one another.</span></span>

![архитектура верхнего уровня directcomposition](images/directcomposition-top-level-architecture.png)

## <a name="application-library"></a><span data-ttu-id="ad100-121">Библиотека приложений</span><span class="sxs-lookup"><span data-stu-id="ad100-121">Application library</span></span>

<span data-ttu-id="ad100-122">Библиотека приложений DirectComposition является общедоступным API-интерфейсом на основе COM с единой плоской точкой входа, которая экспортируется из dcomp.dll и возвращает указатель интерфейса на объект устройства.</span><span class="sxs-lookup"><span data-stu-id="ad100-122">The DirectComposition application library is a public COM-based API with a single flat entry-point that is exported from dcomp.dll and returns an interface pointer to a device object.</span></span> <span data-ttu-id="ad100-123">Объект устройства, в свою очередь, имеет методы для создания всех остальных объектов, каждый из которых представлен указателем интерфейса.</span><span class="sxs-lookup"><span data-stu-id="ad100-123">The device object, in turn, has methods for creating all other objects, each of which is represented by an interface pointer.</span></span> <span data-ttu-id="ad100-124">Все интерфейсы DirectComposition наследуют от и полностью реализуют интерфейс [**IUnknown**](/windows/desktop/api/unknwn/nn-unknwn-iunknown) .</span><span class="sxs-lookup"><span data-stu-id="ad100-124">All DirectComposition interfaces inherit from and fully implement the [**IUnknown**](/windows/desktop/api/unknwn/nn-unknwn-iunknown) interface.</span></span> <span data-ttu-id="ad100-125">Все методы, принимающие интерфейсы DirectComposition, проверяют, реализован ли интерфейс внутри dcomp.dll или он реализуется другим компонентом.</span><span class="sxs-lookup"><span data-stu-id="ad100-125">All methods that accept DirectComposition interfaces check whether the interface is implemented inside of dcomp.dll or whether it is implemented by another component.</span></span> <span data-ttu-id="ad100-126">Поскольку DirectComposition не является расширяемым, методы, принимающие интерфейсы в качестве параметров, возвращают E \_ INVALIDARG, если интерфейсы не реализованы в dcomp.dll.</span><span class="sxs-lookup"><span data-stu-id="ad100-126">Because DirectComposition is not extensible, methods that take interfaces as parameters return E\_INVALIDARG if the interfaces are not implemented in dcomp.dll.</span></span> <span data-ttu-id="ad100-127">API не требует специальных прав; Он может вызываться процессами, работающими на самом низком уровне доступа.</span><span class="sxs-lookup"><span data-stu-id="ad100-127">The API requires no special privileges; it can be called by processes running at the lowest level of access.</span></span> <span data-ttu-id="ad100-128">Однако, поскольку API не работает в сеансе 0, он не подходит для служб.</span><span class="sxs-lookup"><span data-stu-id="ad100-128">However, because the API does not operate in session 0, it is not suitable for services.</span></span> <span data-ttu-id="ad100-129">В связи с этим API DirectComposition аналогичен другим интерфейсам API Microsoft DirectX, особенно Direct2D, Microsoft Direct3D и Microsoft DirectWrite.</span><span class="sxs-lookup"><span data-stu-id="ad100-129">In these respects, the DirectComposition API is similar to other Microsoft DirectX APIs, most notably Direct2D, Microsoft Direct3D, and Microsoft DirectWrite.</span></span>

<span data-ttu-id="ad100-130">Поскольку механизм композиции предназначен исключительно для асинхронного выполнения, свойства объекта в API DirectComposition доступны только для записи.</span><span class="sxs-lookup"><span data-stu-id="ad100-130">Because the composition engine is designed exclusively for asynchronous execution, object properties in the DirectComposition API are write-only.</span></span> <span data-ttu-id="ad100-131">Все свойства имеют методы задания, но не имеют методов Get.</span><span class="sxs-lookup"><span data-stu-id="ad100-131">All properties have setter methods, but not getter methods.</span></span> <span data-ttu-id="ad100-132">Чтение свойств не только требует ресурсов, но и может быть неточным, так как любое значение, возвращаемое ядром композиции, сразу становится недействительным.</span><span class="sxs-lookup"><span data-stu-id="ad100-132">Reading properties is not only resource intensive, but can also be inaccurate because any value that the composition engine returns can immediately become invalid.</span></span> <span data-ttu-id="ad100-133">Это может произойти, например, если независимая анимация привязана к свойству, которое считывается.</span><span class="sxs-lookup"><span data-stu-id="ad100-133">This can happen if, for example, an independent animation is bound to the property that is being read.</span></span>

<span data-ttu-id="ad100-134">API является потокобезопасным.</span><span class="sxs-lookup"><span data-stu-id="ad100-134">The API is thread-safe.</span></span> <span data-ttu-id="ad100-135">Приложение может вызывать любой метод из любого потока в любое время.</span><span class="sxs-lookup"><span data-stu-id="ad100-135">An application can call any method from any thread at any time.</span></span> <span data-ttu-id="ad100-136">Однако, поскольку многие методы API должны вызываться в определенной последовательности без синхронизации, приложение может столкнуться с непредсказуемым поведением в зависимости от того, как потоки находятся в чередовании.</span><span class="sxs-lookup"><span data-stu-id="ad100-136">However, because many API methods must be called in a particular sequence, without any synchronization an application can experience unpredictable behavior depending on how the threads interleave.</span></span> <span data-ttu-id="ad100-137">Например, если два потока меняют одинаковое свойство одного и того же объекта на разные значения одновременно, приложение не сможет предсказать, какое из двух значений будет конечным значением свойства.</span><span class="sxs-lookup"><span data-stu-id="ad100-137">For example, if two threads change the same property of the same object to different values at the same time, the application cannot predict which of the two values will be the final value of the property.</span></span> <span data-ttu-id="ad100-138">Аналогично, если два потока вызывают [**фиксацию**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) на одном и том же устройстве, ни один из потоков не получит транзакционное поведение, так как вызов **commit** в одном потоке отправляет пакет всех команд, выданных обоими потоками, а не только тот, который назывался **commit**.</span><span class="sxs-lookup"><span data-stu-id="ad100-138">Similarly, if two threads call [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) on the same device, neither thread gets truly transactional behavior because a call to **Commit** on one thread will submit the batch of all commands issued by both threads, not just the one that called **Commit**.</span></span>

<span data-ttu-id="ad100-139">Система обслуживает все внутреннее состояние каждого объекта устройства.</span><span class="sxs-lookup"><span data-stu-id="ad100-139">The system maintains all internal state per device object.</span></span> <span data-ttu-id="ad100-140">Если приложение создает два или более объектов устройств DirectComposition, приложение может поддерживать независимые пакеты и другое состояние между ними.</span><span class="sxs-lookup"><span data-stu-id="ad100-140">If an application creates two or more DirectComposition device objects, the application can maintain independent batches and other state between the two.</span></span>

<span data-ttu-id="ad100-141">Все объекты DirectComposition имеют сходство объектов устройств; объекты, созданные определенным объектом устройства, могут использоваться только с этим объектом устройства и могут быть связаны только с другими объектами, созданными одним и тем же объектом устройства.</span><span class="sxs-lookup"><span data-stu-id="ad100-141">All DirectComposition objects have device object affinity; objects created by a particular device object can be used only with that device object, and can be associated only with other objects created by the same device object.</span></span> <span data-ttu-id="ad100-142">Иными словами, каждый объект устройства является отдельным несвязанным островом функциональности.</span><span class="sxs-lookup"><span data-stu-id="ad100-142">In other words, each device object is a separate disjoint island of functionality.</span></span> <span data-ttu-id="ad100-143">Единственным исключением является визуальный класс, который позволяет создавать визуальные деревья, в которых визуальный элемент может принадлежать другому объекту устройства, отличному от родительского.</span><span class="sxs-lookup"><span data-stu-id="ad100-143">The one exception is the visual class, which permits the building of visual trees where a visual can belong to a different device object than its parent.</span></span> <span data-ttu-id="ad100-144">Это позволяет использовать сценарии, в которых приложение и элемент управления могут управлять одним деревом компоновки, не требуя совместного использования одного объекта устройства DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="ad100-144">This enables scenarios where an application and a control can manage a single composition tree without also needing to share a single DirectComposition device object.</span></span>

## <a name="composition-engine"></a><span data-ttu-id="ad100-145">Механизм композиции</span><span class="sxs-lookup"><span data-stu-id="ad100-145">Composition engine</span></span>

<span data-ttu-id="ad100-146">Подсистема композиции DirectComposition выполняется в выделенном процессе отдельно от любого процесса приложения.</span><span class="sxs-lookup"><span data-stu-id="ad100-146">The DirectComposition composition engine runs on a dedicated process, separate from any application process.</span></span> <span data-ttu-id="ad100-147">Один процесс композиции, dwm.exe, поддерживает каждое приложение в сеансе.</span><span class="sxs-lookup"><span data-stu-id="ad100-147">A single composition process, dwm.exe, supports every application in a session.</span></span> <span data-ttu-id="ad100-148">Каждое приложение может создавать два визуальных дерева для каждого окна, которое оно владеет.</span><span class="sxs-lookup"><span data-stu-id="ad100-148">Each application can create two visual trees for each window that it owns.</span></span> <span data-ttu-id="ad100-149">Все деревья фактически реализуются как поддеревья более крупного визуального дерева, которые также охватывают структуры композиции DWM.</span><span class="sxs-lookup"><span data-stu-id="ad100-149">All of the trees are actually implemented as subtrees of a larger visual tree that also encompasses the composition structures of DWM.</span></span> <span data-ttu-id="ad100-150">DWM формирует одно крупное визуальное дерево для каждого рабочего стола в сеансе.</span><span class="sxs-lookup"><span data-stu-id="ad100-150">The DWM constructs one large visual tree for each desktop in a session.</span></span> <span data-ttu-id="ad100-151">Ниже приведены основные преимущества этой архитектуры.</span><span class="sxs-lookup"><span data-stu-id="ad100-151">Here are the key advantages to this architecture:</span></span>

-   <span data-ttu-id="ad100-152">Механизм композиции имеет доступ ко всем точечным рисункам приложений и визуальным деревьям, что обеспечивает взаимодействие и компоновку межпроцессного окна.</span><span class="sxs-lookup"><span data-stu-id="ad100-152">The composition engine has access to all application bitmaps and visual trees, which enables cross-process window interoperability and composition.</span></span>
-   <span data-ttu-id="ad100-153">Механизм композиции выполняется в доверенном системном процессе, отдельном от любого процесса приложения, что позволяет приложениям с низкими правами доступа безопасно создавать защищенное содержимое.</span><span class="sxs-lookup"><span data-stu-id="ad100-153">The composition engine runs in a trusted system process that is separate from any application process, enabling applications that have low access rights to securely compose protected content.</span></span>
-   <span data-ttu-id="ad100-154">Механизм композиции может определить, когда конкретное окно полностью перекрыто и избежать расхода ресурсов ЦП и графического процессора, составленного для окна.</span><span class="sxs-lookup"><span data-stu-id="ad100-154">The composition engine can detect when a particular window is fully occluded and avoid wasting CPU and graphics processing unit (GPU) resources composing for the window.</span></span>
-   <span data-ttu-id="ad100-155">Механизм композиции может составляться непосредственно в буфере экрана, что позволяет избежать необходимости в дополнительной копии, необходимой для обработчиков композиции каждого процесса.</span><span class="sxs-lookup"><span data-stu-id="ad100-155">The composition engine can compose directly to the screen back buffer, avoiding the need for an extra copy that is required for per-process composition engines.</span></span>
-   <span data-ttu-id="ad100-156">Все приложения совместно используют одно устройство Direct3D для объединения, что обеспечивает значительную экономию памяти.</span><span class="sxs-lookup"><span data-stu-id="ad100-156">All applications share a single Direct3D device for composition, which offers considerable memory savings</span></span>

<span data-ttu-id="ad100-157">Визуальное дерево является сохраняемой структурой.</span><span class="sxs-lookup"><span data-stu-id="ad100-157">The visual tree is a retained structure.</span></span> <span data-ttu-id="ad100-158">API DirectComposition предоставляет методы для изменения структуры в пакетах, которые обрабатываются атомарно.</span><span class="sxs-lookup"><span data-stu-id="ad100-158">The DirectComposition API exposes methods to edit the structure in batches of changes that are processed atomically.</span></span> <span data-ttu-id="ad100-159">Корневым объектом в API DirectComposition является объект Device, который служит фабрикой для всех остальных объектов DirectComposition и содержит метод [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit).</span><span class="sxs-lookup"><span data-stu-id="ad100-159">The root object in the DirectComposition API is the device object, which serves as the factory for all other DirectComposition objects and contains a method called [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit).</span></span> <span data-ttu-id="ad100-160">Механизм композиции не отражает изменения, которые приложение делает в визуальном дереве до тех пор, пока приложение не вызовет **фиксацию**, после чего все изменения с момента последней **фиксации** обрабатываются как одна транзакция.</span><span class="sxs-lookup"><span data-stu-id="ad100-160">The composition engine does not reflect any changes that the application makes to the visual tree until the application calls **Commit**, at which point all changes since the last **Commit** are processed as a single transaction.</span></span>

<span data-ttu-id="ad100-161">Требование вызова функции [**commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) аналогично концепции "Frame" за исключением того, что механизм композиции выполняется асинхронно, и он может представлять несколько различных кадров между вызовами для **фиксации**.</span><span class="sxs-lookup"><span data-stu-id="ad100-161">The requirement to call [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) is similar to the concept of a "frame" except that, because the composition engine runs asynchronously, it can present several different frames between calls to **Commit**.</span></span> <span data-ttu-id="ad100-162">В DirectComposition *кадр* — это одна итерация механизма композиции, а интервал времени, затраченный приложением между двумя вызовами **commit** , называется *пакетом*.</span><span class="sxs-lookup"><span data-stu-id="ad100-162">In DirectComposition, a *frame* is a single iteration of the composition engine, and the interval spent by an application between two calls to **Commit** is called a *batch*.</span></span>

<span data-ttu-id="ad100-163">DirectComposition выполняет пакетную обработку всех вызовов приложений к API DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="ad100-163">DirectComposition batches all application calls to the DirectComposition API.</span></span> <span data-ttu-id="ad100-164">База данных объектов ядра, реализованная в драйвере сеанса win32k.sys, хранит все сведения о состоянии, связанные с вызовами API.</span><span class="sxs-lookup"><span data-stu-id="ad100-164">The kernel object database, which is implemented in the win32k.sys session driver, stores all state information that is associated with the API calls.</span></span>

<span data-ttu-id="ad100-165">Механизм композиции создает по одному кадру для каждого вертикально пустого значения в окне просмотра.</span><span class="sxs-lookup"><span data-stu-id="ad100-165">The composition engine produces one frame for each vertical blank in the display.</span></span> <span data-ttu-id="ad100-166">Кадр начинается с пустой вертикальной рамки и наследуется на последующий вертикальный пробел.</span><span class="sxs-lookup"><span data-stu-id="ad100-166">The frame is started at a vertical blank and targets the subsequent vertical blank.</span></span> <span data-ttu-id="ad100-167">При запуске кадра подсистема композиции выбирает все ожидающие пакеты и включает их команды в этот кадр.</span><span class="sxs-lookup"><span data-stu-id="ad100-167">When the frame starts, the composition engine picks up all pending batches and includes their commands in that frame.</span></span> <span data-ttu-id="ad100-168">Пакеты помещаются в очередь ожидания, когда приложение вызывает [**фиксацию**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit), а очередь ожидания очищается атомарно в начале кадра.</span><span class="sxs-lookup"><span data-stu-id="ad100-168">Batches are placed in a pending queue when the application calls [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit), and the pending queue is flushed atomically at the beginning of the frame.</span></span> <span data-ttu-id="ad100-169">Таким образом, существует один момент времени, обозначающий начало кадра.</span><span class="sxs-lookup"><span data-stu-id="ad100-169">Therefore, there is a single point in time that marks the beginning of a frame.</span></span> <span data-ttu-id="ad100-170">Все пакеты, отправленные до этой точки, включаются в кадр, а все пакеты, отправленные после, должны дожидаться обработки следующего кадра.</span><span class="sxs-lookup"><span data-stu-id="ad100-170">Any batches submitted before this point are included in the frame, while any batches submitted after must wait until the next frame to be processed.</span></span> <span data-ttu-id="ad100-171">Полный цикл композиции выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="ad100-171">The full composition loop is as follows:</span></span>

1.  <span data-ttu-id="ad100-172">Оцените время следующего вертикального пробела.</span><span class="sxs-lookup"><span data-stu-id="ad100-172">Estimate the time of the next vertical blank.</span></span>
2.  <span data-ttu-id="ad100-173">Получение всех ожидающих пакетов.</span><span class="sxs-lookup"><span data-stu-id="ad100-173">Retrieve all pending batches.</span></span>
3.  <span data-ttu-id="ad100-174">Обработка полученных пакетов.</span><span class="sxs-lookup"><span data-stu-id="ad100-174">Process the retrieved batches.</span></span>
4.  <span data-ttu-id="ad100-175">Обновите все анимации, используя время, заданное на шаге 1.</span><span class="sxs-lookup"><span data-stu-id="ad100-175">Update all animations using the time estimated in step 1.</span></span>
5.  <span data-ttu-id="ad100-176">Определите области экрана, которые необходимо повторно составить.</span><span class="sxs-lookup"><span data-stu-id="ad100-176">Determine the regions of the screen that need to be re-composed.</span></span>
6.  <span data-ttu-id="ad100-177">Повторное Составление "грязных" регионов.</span><span class="sxs-lookup"><span data-stu-id="ad100-177">Re-compose the dirty regions.</span></span>
7.  <span data-ttu-id="ad100-178">Представьте фрейм, переустановив задний и передний буфер для каждого экрана.</span><span class="sxs-lookup"><span data-stu-id="ad100-178">Present the frame by flipping the back and front buffers for each screen.</span></span>
8.  <span data-ttu-id="ad100-179">Если ничего не состояло и было представлено в шагах 6 и 7, дождитесь фиксации пакета.</span><span class="sxs-lookup"><span data-stu-id="ad100-179">If nothing was composed and presented in steps 6 and 7, wait for a batch to be committed.</span></span>
9.  <span data-ttu-id="ad100-180">Ожидание следующего вертикального пробела.</span><span class="sxs-lookup"><span data-stu-id="ad100-180">Wait for the next vertical blank.</span></span>

<span data-ttu-id="ad100-181">При наличии нескольких мониторов, подключенных к одному видеоадаптеру, механизм композиции использует вертикальную пустую часть основного монитора, чтобы выполнить цикл композиции и задать время выборки анимации.</span><span class="sxs-lookup"><span data-stu-id="ad100-181">If there are multiple monitors attached to a single video adapter, the composition engine uses the vertical blank of the primary monitor to drive the composition loop and set the animation sampling times.</span></span> <span data-ttu-id="ad100-182">Каждый монитор представлен отдельной цепочкой перелистывания в полноэкранном режиме. механизм композиции повторяет шаги 6 и 7 для каждого монитора в циклической манере, используя одно устройство Direct3D.</span><span class="sxs-lookup"><span data-stu-id="ad100-182">Each monitor is represented by a separate full-screen flip chain; the composition engine repeats steps 6 and 7 for each monitor, in a round-robin fashion, using a single Direct3D device.</span></span> <span data-ttu-id="ad100-183">При наличии нескольких видеоадаптеров механизм композиции использует отдельное устройство Direct3D для каждого видеоадаптера в шагах 6 и 7.</span><span class="sxs-lookup"><span data-stu-id="ad100-183">If there are also multiple video adapters, the composition engine uses a separate Direct3D device for each video adapter in steps 6 and 7.</span></span>

<span data-ttu-id="ad100-184">Кадры композиции по расписанию всегда начинаются с вертикального пробела, как показано на следующем рисунке.</span><span class="sxs-lookup"><span data-stu-id="ad100-184">Composition frames are scheduled to always start at a vertical blank, as the following illustration shows.</span></span>

![планирование кадров композиции](images/composition-frame-scheduling.png)

<span data-ttu-id="ad100-186">Если механизм композиции не работает, так как дерево композиции не изменилось, поток композиции задействуется в ожидании нового пакета.</span><span class="sxs-lookup"><span data-stu-id="ad100-186">If the composition engine has no work to do because the composition tree has not changed, the composition thread sleeps while waiting for a new batch.</span></span> <span data-ttu-id="ad100-187">Когда отправляется новый пакет, поток композиции выходит из спящего режима, но сразу же возвращается в режим сна до следующего пустого значения по вертикали.</span><span class="sxs-lookup"><span data-stu-id="ad100-187">When a new batch is submitted, the composition thread wakes up but immediately goes back to sleep until the next vertical blank.</span></span> <span data-ttu-id="ad100-188">Такое поведение обеспечивает предсказуемое время начала и окончания кадров для приложений и для механизма композиции.</span><span class="sxs-lookup"><span data-stu-id="ad100-188">This behavior ensures predictable frame start and end times for applications and for the composition engine.</span></span>

<span data-ttu-id="ad100-189">Механизм композиции публикует время презентации кадра и текущую частоту кадров.</span><span class="sxs-lookup"><span data-stu-id="ad100-189">The composition engine publishes the frame presentation times and the current frame rate.</span></span> <span data-ttu-id="ad100-190">Публикация этих сведений позволяет приложениям оценивать время презентации для собственных пакетов, что в своюмся позволяет синхронизировать анимацию.</span><span class="sxs-lookup"><span data-stu-id="ad100-190">Publishing this information enables applications to estimate the presentation time for their own batches, which in turns enables animations to be synchronized.</span></span> <span data-ttu-id="ad100-191">В частности, приложение может использовать сочетание статистики кадров из механизма композиции, а также историческую модель того, как долго поток пользовательского интерфейса занимается созданием пакета, чтобы определить время выборки для собственных анимаций.</span><span class="sxs-lookup"><span data-stu-id="ad100-191">In particular, an application can use a combination of frame statistics from the composition engine, and a historical model of how long its UI thread takes to produce a batch, to determine the sampling time for its own animations.</span></span>

<span data-ttu-id="ad100-192">Например, в начале пакета приложения, показанного на предыдущем рисунке, приложение может запросить механизм композиции, чтобы определить точное время презентации для следующего кадра.</span><span class="sxs-lookup"><span data-stu-id="ad100-192">For example, at the beginning of the application batch shown in the previous illustration, the application can query the composition engine to determine the exact presentation time of the next frame.</span></span> <span data-ttu-id="ad100-193">Затем приложение может использовать текущее время, а также сведения о предыдущих пакетах, которые он создал, чтобы определить, может ли приложение выполнить текущий пакет до следующего пустого вертикального.</span><span class="sxs-lookup"><span data-stu-id="ad100-193">The application can then use the current time, along with information about previous batches that it has produced, to determine whether the application can complete the current batch before the next vertical blank.</span></span> <span data-ttu-id="ad100-194">Таким образом, приложение использует время представления кадров в качестве времени выборки для собственных анимаций.</span><span class="sxs-lookup"><span data-stu-id="ad100-194">Therefore, the application uses the frame presentation time as the sampling time for its own animations.</span></span> <span data-ttu-id="ad100-195">Если приложение определяет, что вряд ли завершит свою работу в текущей вертикальной области, приложение может использовать последующее время кадра как время выборки, используя сведения о частоте кадров, возвращенные механизмом композиции для расчета этого времени.</span><span class="sxs-lookup"><span data-stu-id="ad100-195">If the application determines that it is unlikely to complete its work in the current vertical blank, the application can use the subsequent frame time as the sampling time instead, using the frame rate information returned by the composition engine to compute that time.</span></span>

## <a name="related-topics"></a><span data-ttu-id="ad100-196">См. также</span><span class="sxs-lookup"><span data-stu-id="ad100-196">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="ad100-197">Основные понятия DirectComposition</span><span class="sxs-lookup"><span data-stu-id="ad100-197">DirectComposition Concepts</span></span>](directcomposition-concepts.md)
</dt> </dl>

 

 