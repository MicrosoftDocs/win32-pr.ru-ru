---
title: Рекомендации для приложений
description: Приложения, работающие в Windows Vista и Windows Server 2008, должны соблюдать эти рекомендации, чтобы диспетчер перезапуска мог завершить работу и перезапустить приложения, если это необходимо для установки обновлений.
ms.assetid: 97b1df63-65a9-47b4-891b-e4a754882b89
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3ebace21e09956c68d34c90775c5ea646a8b2dd0
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "103793369"
---
# <a name="guidelines-for-applications"></a><span data-ttu-id="f153c-103">Рекомендации для приложений</span><span class="sxs-lookup"><span data-stu-id="f153c-103">Guidelines for Applications</span></span>

<span data-ttu-id="f153c-104">Приложения, работающие в Windows Vista и Windows Server 2008, должны соблюдать эти рекомендации, чтобы диспетчер перезапуска мог завершить работу и перезапустить приложения, если это необходимо для установки обновлений.</span><span class="sxs-lookup"><span data-stu-id="f153c-104">Applications running on Windows Vista and Windows Server 2008 should adhere to these guidelines to ensure that the Restart Manager can shut down and restart applications if necessary to install updates.</span></span> <span data-ttu-id="f153c-105">Службы могут использовать рекомендации, описанные в разделе [рекомендации по службам](guidelines-for-services.md).</span><span class="sxs-lookup"><span data-stu-id="f153c-105">Services can use the guidelines that are described in [Guidelines for Services](guidelines-for-services.md).</span></span>

-   <span data-ttu-id="f153c-106">Диспетчер перезапуска запрашивает завершение работы приложений GUI, отправляя уведомление [**WM \_ куерендсессион**](/windows/desktop/Shutdown/wm-queryendsession) с параметром *lParam* , равным **ENDSESSION \_ клосеапп** (0x1).</span><span class="sxs-lookup"><span data-stu-id="f153c-106">The Restart Manager queries GUI applications for shutdown by sending a [**WM\_QUERYENDSESSION**](/windows/desktop/Shutdown/wm-queryendsession) notification that has the *lParam* parameter set to **ENDSESSION\_CLOSEAPP** (0x1).</span></span> <span data-ttu-id="f153c-107">Приложения не должны завершать работу при получении сообщения **WM \_ куерендсессион** , поскольку другое приложение может быть не готово к завершению работы.</span><span class="sxs-lookup"><span data-stu-id="f153c-107">Applications should not shut down when they receive a **WM\_QUERYENDSESSION** message because another application may not be ready to shut down.</span></span> <span data-ttu-id="f153c-108">Приложения GUI должны прослушивать сообщение **\_ куерендсессион WM** и возвращать значение **true** , если приложение готово к завершению работы и перезапуску.</span><span class="sxs-lookup"><span data-stu-id="f153c-108">GUI applications should listen for the **WM\_QUERYENDSESSION** message and return a value of **TRUE** if the application is prepared to shut down and restart.</span></span> <span data-ttu-id="f153c-109">Если приложение не возвращает значение **false**, диспетчер перезапуска отправляет сообщение [**WM \_ ENDSESSION**](/windows/desktop/Shutdown/wm-endsession) с параметром *lParam* , установленным в значение **ENDSESSION \_ клосеапп** (0x1), а параметр *wParam* имеет значение **true**.</span><span class="sxs-lookup"><span data-stu-id="f153c-109">If no application returns a value of **FALSE**, the Restart Manager sends a [**WM\_ENDSESSION**](/windows/desktop/Shutdown/wm-endsession) message with the *lParam* parameter set to **ENDSESSION\_CLOSEAPP** (0x1) and the *wparam* parameter set to **TRUE**.</span></span> <span data-ttu-id="f153c-110">Приложения должны завершать работу только при получении сообщения **WM \_ ENDSESSION** .</span><span class="sxs-lookup"><span data-stu-id="f153c-110">Applications should shut down only when they receive the **WM\_ENDSESSION** message.</span></span> <span data-ttu-id="f153c-111">Диспетчер перезапуска также отправляет сообщение [**о \_ закрытии WM**](../winmsg/wm-close.md) для приложений графического пользовательского интерфейса, которые не завершают работу при получении **WM \_ ENDSESSION**.</span><span class="sxs-lookup"><span data-stu-id="f153c-111">The Restart Manager also sends a [**WM\_CLOSE**](../winmsg/wm-close.md) message for GUI applications that do not shut down on receiving **WM\_ENDSESSION**.</span></span> <span data-ttu-id="f153c-112">Если любое приложение графического пользовательского интерфейса отвечает на сообщение **WM \_ куерендсессион** , возвращая значение **false**, завершение работы отменяется.</span><span class="sxs-lookup"><span data-stu-id="f153c-112">If any GUI application responds to a **WM\_QUERYENDSESSION** message by returning a value of **FALSE**, the shutdown is canceled.</span></span> <span data-ttu-id="f153c-113">Однако при принудительном завершении работы приложение завершается независимо.</span><span class="sxs-lookup"><span data-stu-id="f153c-113">However, if the shutdown is forced, the application is terminated regardless.</span></span>
-   <span data-ttu-id="f153c-114">Когда приложение GUI получает сообщение [**WM \_ ENDSESSION**](/windows/desktop/Shutdown/wm-endsession) , оно должно подготовиться к завершению работы в течение заданного периода ожидания.</span><span class="sxs-lookup"><span data-stu-id="f153c-114">When a GUI application receives a [**WM\_ENDSESSION**](/windows/desktop/Shutdown/wm-endsession) message, the application should prepare itself to shut down within the specified timeout period.</span></span> <span data-ttu-id="f153c-115">Как минимум, приложения должны подготовиться, сохранив данные пользователя и сведения о состоянии, необходимые после перезагрузки.</span><span class="sxs-lookup"><span data-stu-id="f153c-115">At a minimum, applications should prepare by saving any user data and state information that is needed after a restart.</span></span> <span data-ttu-id="f153c-116">Рекомендуется периодически сохранять данные пользователей и их состояние.</span><span class="sxs-lookup"><span data-stu-id="f153c-116">It is recommended that applications periodically save the user data and state.</span></span>
-   <span data-ttu-id="f153c-117">Диспетчер перезапуска отправляет уведомление **о \_ \_ событии CTRL C** в консольные приложения, которые должны быть выключены и перезапущены.</span><span class="sxs-lookup"><span data-stu-id="f153c-117">The Restart Manager sends a **CTRL\_C\_EVENT** notification to console applications that must be shut down and restarted.</span></span> <span data-ttu-id="f153c-118">Когда консольное приложение получает уведомление **о \_ \_ событии CTRL C** , приложение должно предпринять действия, необходимые для подготовки к завершению работы в течение заданного периода ожидания.</span><span class="sxs-lookup"><span data-stu-id="f153c-118">When a console application receives a **CTRL\_C\_EVENT** notification, the application should take actions necessary to prepare for a shutdown within the specified timeout period.</span></span> <span data-ttu-id="f153c-119">Как минимум, консольные приложения должны определить функцию [*хандлерраутине*](/windows/console/handlerroutine) для управления уведомлением **о \_ \_ событии CTRL C** и сохранить все данные пользователя и сведения о состоянии, которые понадобятся после перезагрузки.</span><span class="sxs-lookup"><span data-stu-id="f153c-119">At a minimum, console applications should define a [*HandlerRoutine*](/windows/console/handlerroutine) function to handle the **CTRL\_C\_EVENT** notification and should save any user data and state information that is going to be needed after a restart.</span></span> <span data-ttu-id="f153c-120">Рекомендуется периодически сохранять данные пользователей и их состояние.</span><span class="sxs-lookup"><span data-stu-id="f153c-120">It is recommended that applications periodically save the user data and state.</span></span>
-   <span data-ttu-id="f153c-121">Если какие бы то ни было приложения не завершаются в ответ на сообщения о завершении работы, установщики могут использовать параметр **рмфорцешутдовн** функции [**рмшутдовн**](/windows/desktop/api/RestartManager/nf-restartmanager-rmshutdown) для принудительного завершения работы приложений.</span><span class="sxs-lookup"><span data-stu-id="f153c-121">If any applications do not shut down in response to the shutdown messages, installers can use the **RmForceShutdown** option of the [**RmShutdown**](/windows/desktop/api/RestartManager/nf-restartmanager-rmshutdown) function to force the applications to shut down.</span></span> <span data-ttu-id="f153c-122">Когда установщик задает принудительное завершение работы, диспетчер перезапуска пытается очистить приложения, отправляя сообщения о завершении работы, но принудительно завершит их работу в случае сбоя.</span><span class="sxs-lookup"><span data-stu-id="f153c-122">When the installer specifies a forced shutdown, Restart Manager attempts to shut down the applications cleanly by sending the shutdown messages, but will force them shut if this fails.</span></span> <span data-ttu-id="f153c-123">Приложения GUI и консольные приложения можно принудительно завершить, чтобы обеспечить установку критического обновления для системы безопасности.</span><span class="sxs-lookup"><span data-stu-id="f153c-123">GUI applications and console applications can be forced to shut down to enable the installation of a critical security update.</span></span> <span data-ttu-id="f153c-124">Так как это может привести к утере данных, приложения должны выполнять обработку сообщений о завершении работы и завершать работу при необходимости.</span><span class="sxs-lookup"><span data-stu-id="f153c-124">Because this can result in data loss, applications should handle the shutdown messages and shut down cleanly when required.</span></span>
-   <span data-ttu-id="f153c-125">Приложения должны зарегистрироваться для перезапуска с помощью функции [**регистераппликатионрестарт**](/windows/desktop/api/winbase/nf-winbase-registerapplicationrestart) .</span><span class="sxs-lookup"><span data-stu-id="f153c-125">Applications should register for a restart by using the [**RegisterApplicationRestart**](/windows/desktop/api/winbase/nf-winbase-registerapplicationrestart) function.</span></span> <span data-ttu-id="f153c-126">Диспетчер перезапуска может перезапустить только те приложения, которые были зарегистрированы для перезапуска.</span><span class="sxs-lookup"><span data-stu-id="f153c-126">Restart Manager can only restart applications that have been registered for restart.</span></span> <span data-ttu-id="f153c-127">Это единственный способ, с помощью которого диспетчер перезапуска может определить команду командной строки, которая будет использоваться при перезапуске приложения.</span><span class="sxs-lookup"><span data-stu-id="f153c-127">This is the only way that the Restart Manager can determine the command-line command to use when restarting the application.</span></span> <span data-ttu-id="f153c-128">Если приложение должно повторно открываться с некоторым сохраненным состоянием или данными, эти сведения должны быть добавлены в команду командной строки, зарегистрированную для приложения.</span><span class="sxs-lookup"><span data-stu-id="f153c-128">If the application must reopen with some saved state or data, that information must be included in the command-line command that is registered for the application.</span></span>
    > [!Note]  
    > <span data-ttu-id="f153c-129">Если перезапущенное приложение должно выполняться в том же каталоге, в котором он выполнялся до завершения работы, приложение должно сохранить сведения о каталоге, а затем перейти к каталогу после перезапуска.</span><span class="sxs-lookup"><span data-stu-id="f153c-129">If the restarted application must run in the same directory it ran in before being shut down, the application must save the directory information and then change to the directory after restarting.</span></span>

     

    > [!Note]  
    > <span data-ttu-id="f153c-130">Функция [**рмрестарт**](/windows/desktop/api/RestartManager/nf-restartmanager-rmrestart) не перезапускает приложения, которые не выполняются в качестве пользователя, выполнившего вход в систему.</span><span class="sxs-lookup"><span data-stu-id="f153c-130">The [**RmRestart**](/windows/desktop/api/RestartManager/nf-restartmanager-rmrestart) function does not restart applications that do not run as the currently-logged on user.</span></span> <span data-ttu-id="f153c-131">Например, функция **рмрестарт** не перезапускает приложения, запущенные с помощью команды **запуска от имени** , которая не выполняется как пользователь, выполнивший вход в систему.</span><span class="sxs-lookup"><span data-stu-id="f153c-131">For example, the **RmRestart** function does not restart applications started with the **Run As** command that do not run as the currently-logged on user.</span></span> <span data-ttu-id="f153c-132">Эти приложения необходимо перезапустить вручную.</span><span class="sxs-lookup"><span data-stu-id="f153c-132">These applications must be manually restarted.</span></span>

     

-   <span data-ttu-id="f153c-133">Когда диспетчер перезапуска определяет, что для установки обновления требуется перезагрузка системы, она не завершает работу приложений и служб.</span><span class="sxs-lookup"><span data-stu-id="f153c-133">When Restart Manager determines that a system restart is required to install an update, it does not shut down any applications and services.</span></span> <span data-ttu-id="f153c-134">Вместо этого он оставляет установщик, чтобы решить, когда следует запланировать перезагрузку системы и установить обновление.</span><span class="sxs-lookup"><span data-stu-id="f153c-134">Instead, it leaves this to the installer to decide when to schedule a system restart and install the update.</span></span> <span data-ttu-id="f153c-135">Установщики могут снизить нагрузку на пользователей, вызванные обновлениями, требующими перезагрузки системы, с помощью функции [**ExitWindowsEx**](/windows/desktop/api/winuser/nf-winuser-exitwindowsex) с флагом **евкс \_ рестартаппс** или функции [**инитиатешутдовн**](/windows/desktop/api/winreg/nf-winreg-initiateshutdowna) с флагом **Shutdown \_ рестартаппс** .</span><span class="sxs-lookup"><span data-stu-id="f153c-135">Installers can reduce the disruption to users caused by updates that require a system restart by using the [**ExitWindowsEx**](/windows/desktop/api/winuser/nf-winuser-exitwindowsex) function with the **EWX\_RESTARTAPPS** flag or the [**InitiateShutdown**](/windows/desktop/api/winreg/nf-winreg-initiateshutdowna) function with the **SHUTDOWN\_RESTARTAPPS** flag.</span></span> <span data-ttu-id="f153c-136">Использование этих флагов гарантирует, что приложения, зарегистрированные для перезапуска, перезапускаются после перезагрузки системы, что снижает влияние на пользователя.</span><span class="sxs-lookup"><span data-stu-id="f153c-136">Using these flags ensures that applications registered for restart are restarted after a system reboot, which minimizes the impact on the user.</span></span>

 

 