---
title: Лицензирование и IClassFactory2
description: Лицензирование и IClassFactory2
ms.assetid: 2bead555-8c62-4f48-a4c6-6f0942ec75f8
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9376d5187588ba14da434161309409bf1d189a8f
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2020
ms.locfileid: "104413841"
---
# <a name="licensing-and-iclassfactory2"></a><span data-ttu-id="93a9f-103">Лицензирование и IClassFactory2</span><span class="sxs-lookup"><span data-stu-id="93a9f-103">Licensing and IClassFactory2</span></span>

<span data-ttu-id="93a9f-104">Интерфейс [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory) в объекте класса предоставляет базовый механизм создания объектов COM.</span><span class="sxs-lookup"><span data-stu-id="93a9f-104">The [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory) interface on a class object provides the basic object creation mechanism of COM.</span></span> <span data-ttu-id="93a9f-105">С помощью **IClassFactory** сервер может управлять созданием объектов на уровне компьютера.</span><span class="sxs-lookup"><span data-stu-id="93a9f-105">Using **IClassFactory**, a server can control object creation on a machine basis.</span></span> <span data-ttu-id="93a9f-106">Реализация метода [**IClassFactory:: CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance) может разрешать или запрещать создание объектов на основе наличия лицензии компьютера.</span><span class="sxs-lookup"><span data-stu-id="93a9f-106">The implementation of the [**IClassFactory::CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance) method can allow or disallow object creation based on the existence of a machine license.</span></span> <span data-ttu-id="93a9f-107">Лицензия компьютера — это часть сведений, отделяющая от приложения, которое существует на компьютере, чтобы указать, что программное обеспечение было установлено из допустимого источника, например установочных дисков поставщика.</span><span class="sxs-lookup"><span data-stu-id="93a9f-107">A machine license is a piece of information separate from the application that exists on a machine to indicate that the software was installed from a valid source, such as the vendor's installation disks.</span></span> <span data-ttu-id="93a9f-108">Если лицензия компьютера не существует, сервер может запретить создание объектов.</span><span class="sxs-lookup"><span data-stu-id="93a9f-108">If the machine license does not exist, the server can disallow object creation.</span></span> <span data-ttu-id="93a9f-109">Лицензирование компьютера предотвращает пиратство в случаях, когда пользователь пытается скопировать программное обеспечение с одного компьютера на другой, так как сведения о лицензии не копируются вместе с программным обеспечением, а компьютер, получивший копию, не лицензирован.</span><span class="sxs-lookup"><span data-stu-id="93a9f-109">Machine licensing prevents piracy in cases where a user attempts to copy the software from one machine to another, because the license information is not copied with the software and the machine that receives the copy is not licensed.</span></span>

<span data-ttu-id="93a9f-110">Однако в отрасли программного обеспечения поставщики нуждаются в более тонком уровне контроля над лицензированием.</span><span class="sxs-lookup"><span data-stu-id="93a9f-110">However, in a component software industry, vendors need a finer level of control over licensing.</span></span> <span data-ttu-id="93a9f-111">Помимо управления лицензиями компьютера, поставщику необходимо разрешить некоторым клиентам создавать объект компонента, одновременно запретив другим клиентам такую же возможность.</span><span class="sxs-lookup"><span data-stu-id="93a9f-111">In addition to machine license control, a vendor needs to allow some clients to create a component object while denying other clients the same capability.</span></span> <span data-ttu-id="93a9f-112">Для этого клиентское приложение должно получить лицензионный ключ от компонента, пока клиентское приложение все еще находится в разработке.</span><span class="sxs-lookup"><span data-stu-id="93a9f-112">This requires that the client application obtain a license key from the component while the client application is still under development.</span></span> <span data-ttu-id="93a9f-113">Клиентское приложение использует лицензионный ключ во время выполнения для создания объектов на нелицензированном компьютере.</span><span class="sxs-lookup"><span data-stu-id="93a9f-113">The client application uses the license key at run time to create objects on an unlicensed machine.</span></span>

<span data-ttu-id="93a9f-114">Например, если поставщик предоставляет библиотеку элементов управления для разработчиков, у разработчика, который приобрели библиотеку, будет полноценная лицензия на компьютер, позволяющая создавать объекты на компьютере разработки.</span><span class="sxs-lookup"><span data-stu-id="93a9f-114">For example, if a vendor provides a library of controls to developers, the developer who purchases the library will have a full machine license, allowing the objects to be created on the development machine.</span></span> <span data-ttu-id="93a9f-115">Затем разработчик может создать клиентское приложение на Лицензированном компьютере, включающем один или несколько элементов управления.</span><span class="sxs-lookup"><span data-stu-id="93a9f-115">The developer can then build a client application on the licensed machine incorporating one or more of the controls.</span></span> <span data-ttu-id="93a9f-116">Когда полученное клиентское приложение запускается на другом компьютере, элементы управления, используемые в клиентском приложении, должны быть созданы на другом компьютере, даже если этот компьютер не владеет лицензией компьютера для элементов управления от исходного поставщика.</span><span class="sxs-lookup"><span data-stu-id="93a9f-116">When the resulting client application is run on another machine, the controls used in the client application must be created on the other machine even if that machine does not possess a machine license for the controls from the original vendor.</span></span>

<span data-ttu-id="93a9f-117">Интерфейс [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) обеспечивает этот уровень управления.</span><span class="sxs-lookup"><span data-stu-id="93a9f-117">The [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) interface provides this level of control.</span></span> <span data-ttu-id="93a9f-118">Чтобы обеспечить лицензирование на основе ключей для любого конкретного компонента, необходимо реализовать **IClassFactory2** в объекте фабрики класса для этого компонента.</span><span class="sxs-lookup"><span data-stu-id="93a9f-118">To allow key-based licensing for any given component, you implement **IClassFactory2** on the class factory object for that component.</span></span> <span data-ttu-id="93a9f-119">**IClassFactory2** является производным от [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory), поэтому, реализуя **IClassFactory2**, объект фабрики класса удовлетворяет базовым требованиям COM.</span><span class="sxs-lookup"><span data-stu-id="93a9f-119">**IClassFactory2** is derived from [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory), so by implementing **IClassFactory2**, the class factory object fulfills the basic COM requirements.</span></span>

<span data-ttu-id="93a9f-120">Чтобы включить лицензированный компонент в клиентское приложение, используйте следующие методы в [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2):</span><span class="sxs-lookup"><span data-stu-id="93a9f-120">To incorporate a licensed component into your client application, use the following methods in [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2):</span></span>

-   <span data-ttu-id="93a9f-121">Метод [**жетлиЦинфо**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) заполняет структуру [**лиЦинфо**](/windows/win32/api/ocidl/ns-ocidl-licinfo) данными, описывающими поведение лицензирования фабрики класса.</span><span class="sxs-lookup"><span data-stu-id="93a9f-121">The [**GetLicInfo**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) method fills a [**LICINFO**](/windows/win32/api/ocidl/ns-ocidl-licinfo) structure with information describing the licensing behavior of the class factory.</span></span> <span data-ttu-id="93a9f-122">Например, фабрика класса может предоставлять лицензионные ключи для лицензирования времени выполнения, если член **фрунтимекэйаваил** имеет **значение true**.</span><span class="sxs-lookup"><span data-stu-id="93a9f-122">For example, the class factory can provide license keys for run-time licensing if the **fRunTimeKeyAvail** member is **TRUE**.</span></span>
-   <span data-ttu-id="93a9f-123">Метод [**рекуестликкэй**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) предоставляет лицензионный ключ для компонента.</span><span class="sxs-lookup"><span data-stu-id="93a9f-123">The [**RequestLicKey**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) method provides a license key for the component.</span></span> <span data-ttu-id="93a9f-124">Если клиент вызывает этот метод, должна быть доступна лицензия компьютера.</span><span class="sxs-lookup"><span data-stu-id="93a9f-124">A machine license must be available when the client calls this method.</span></span>
-   <span data-ttu-id="93a9f-125">Метод [**креатеинстанцелик**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) создает экземпляр лицензированного компонента, если параметр лицензионного ключа (бстрâ бстркэй) является допустимым.</span><span class="sxs-lookup"><span data-stu-id="93a9f-125">The [**CreateInstanceLic**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) method creates an instance of the licensed component if the license key parameter (BSTRÂ bstrKey) is valid.</span></span>

> [!Note]  
> <span data-ttu-id="93a9f-126">В сведениях о типе компонент использует атрибут Licensed, чтобы пометить coclass, поддерживающий лицензирование, через [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2).</span><span class="sxs-lookup"><span data-stu-id="93a9f-126">In its type information, a component uses the attribute licensed to mark the coclass that supports licensing through [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2).</span></span>

 

<span data-ttu-id="93a9f-127">Во-первых, вам понадобится отдельное средство разработки, которое также является клиентом лицензированного компонента.</span><span class="sxs-lookup"><span data-stu-id="93a9f-127">First, you need a separate development tool that is also a client of the licensed component.</span></span> <span data-ttu-id="93a9f-128">Назначение этого средства — получить лицензионный ключ и сохранить его в клиентском приложении.</span><span class="sxs-lookup"><span data-stu-id="93a9f-128">The purpose of this tool is to obtain the run-time license key and save it in your client application.</span></span> <span data-ttu-id="93a9f-129">Это средство выполняется только на компьютере, где есть лицензия на компьютер для компонента.</span><span class="sxs-lookup"><span data-stu-id="93a9f-129">This tool runs only on a machine that possesses a machine license for the component.</span></span> <span data-ttu-id="93a9f-130">Средство вызывает методы [**жетлиЦинфо**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) и [**рекуестликкэй**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) для получения лицензионного ключа, а затем сохраняет лицензионный ключ в клиентском приложении.</span><span class="sxs-lookup"><span data-stu-id="93a9f-130">The tool calls the [**GetLicInfo**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) and [**RequestLicKey**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) methods to obtain the run-time license key and then saves the license key in your client application.</span></span> <span data-ttu-id="93a9f-131">Например, средство разработки может создать файл заголовка (h), содержащий ключ лицензии BSTR, а затем включить этот h-файл в клиентское приложение.</span><span class="sxs-lookup"><span data-stu-id="93a9f-131">For example, the development tool could create a header (.h) file containing the BSTR license key, and then you would include that .h file in your client application.</span></span>

<span data-ttu-id="93a9f-132">Чтобы создать экземпляр компонента в клиентском приложении, сначала попытайтесь создать экземпляр объекта напрямую с помощью [**IClassFactory:: CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance).</span><span class="sxs-lookup"><span data-stu-id="93a9f-132">To instantiate the component within your client application, first try to instantiate the object directly with [**IClassFactory::CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance).</span></span> <span data-ttu-id="93a9f-133">Если **CreateInstance** выполняется, второй компьютер лицензируется для компонента, и объекты могут быть созданы в.</span><span class="sxs-lookup"><span data-stu-id="93a9f-133">If **CreateInstance** succeeds, the second machine is licensed for the component and objects can be created at will.</span></span> <span data-ttu-id="93a9f-134">Если **CreateInstance** завершается с ошибкой с кодом \_ возврата \_ нотлиценсед, единственным способом создания объекта является передача ключа времени выполнения методу [**креатеинстанцелик**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) .</span><span class="sxs-lookup"><span data-stu-id="93a9f-134">If **CreateInstance** fails with the return code CLASS\_E\_NOTLICENSED, the only way to create the object is to pass the run-time key to the [**CreateInstanceLic**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) method.</span></span> <span data-ttu-id="93a9f-135">**Креатеинстанцелик** проверяет ключ и создает объект, если ключ является допустимым.</span><span class="sxs-lookup"><span data-stu-id="93a9f-135">**CreateInstanceLic** verifies the key and creates the object if the key is valid.</span></span>

<span data-ttu-id="93a9f-136">Таким образом, приложение, созданное с помощью компонентов (например, элементов управления), может выполняться на компьютере, не имеющем другой лицензии — для создания объектов компонентов можно использовать только клиентское приложение, содержащее лицензию времени выполнения.</span><span class="sxs-lookup"><span data-stu-id="93a9f-136">In this way, an application built with components (such as controls) can run on a machine that has no other license—only the client application containing the run-time license is allowed to create the component objects in question.</span></span>

<span data-ttu-id="93a9f-137">Интерфейс [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) поддерживает гибкость в схемах лицензирования.</span><span class="sxs-lookup"><span data-stu-id="93a9f-137">The [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) interface supports flexibility in licensing schemes.</span></span> <span data-ttu-id="93a9f-138">Например, разработчик сервера может зашифровать лицензионные ключи в компоненте для обеспечения дополнительной безопасности.</span><span class="sxs-lookup"><span data-stu-id="93a9f-138">For example, the server implementor can encrypt license keys in the component for added security.</span></span> <span data-ttu-id="93a9f-139">Разработчики сервера могут также включать или отключать уровни функциональности в своих объектах, предоставляя разные лицензионные ключи для разных функций.</span><span class="sxs-lookup"><span data-stu-id="93a9f-139">Server implementers can also enable or disable levels of functionality in their objects by providing different license keys for different functions.</span></span> <span data-ttu-id="93a9f-140">Например, один ключ может обеспечить базовый уровень функциональности, а другой — базовую и расширенную функциональность и т. д.</span><span class="sxs-lookup"><span data-stu-id="93a9f-140">For example, one key might allow a base level of functionality while another allows basic and advanced functionality, and so on.</span></span>

## <a name="related-topics"></a><span data-ttu-id="93a9f-141">См. также</span><span class="sxs-lookup"><span data-stu-id="93a9f-141">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="93a9f-142">Обязанности сервера COM</span><span class="sxs-lookup"><span data-stu-id="93a9f-142">COM Server Responsibilities</span></span>](com-server-responsibilities.md)
</dt> </dl>

 

 