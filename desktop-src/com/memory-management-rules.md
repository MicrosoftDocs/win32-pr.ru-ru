---
title: Правила управления памятью
description: Правила управления памятью
ms.assetid: 769127a1-1a14-4ed4-9d38-7cf3e571b661
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 56e7ad2483b794ec5c2e9c325bca8e469ff4ae0b
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2020
ms.locfileid: "104134674"
---
# <a name="memory-management-rules"></a>Правила управления памятью

Время существования указателей на интерфейсы всегда управляется с помощью методов [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) и [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) для каждого COM-интерфейса. Дополнительные сведения см. в разделе [правила управления счетчиками ссылок](rules-for-managing-reference-counts.md).

Для всех остальных параметров важно соблюдать определенные правила для управления памятью. Следующие правила применяются ко всем параметрам интерфейса месодсâ € ", включая Return валуеâ €", которые не передаются по значению:

-   В параметрах должны выделяться и освобождаться вызывающим объектом.
-   Out — параметры должны выделяться одним из вызываемых; они освобождаются вызывающим объектом с помощью механизма выделения памяти для задачи COM уровня "Стандартный". Дополнительные сведения см. [в разделе распределитель памяти OLE](the-ole-memory-allocator.md) .
-   Входные и выходные параметры изначально выделяются вызывающим объектом, а затем освобождаются и повторно выделяются при необходимости. Как справедливо для параметров out, вызывающий отвечает за освобождение окончательного возвращаемого значения. Необходимо использовать стандартный распределитель памяти COM.

В двух последних случаях, когда один фрагмент кода выделяет память, а другой фрагмент кода освобождает его, использование распределителя COM гарантирует, что два фрагмента кода используют одни и те же методы выделения.

Еще одной областью, требующей особого внимания, является обработка параметров out и out в условиях сбоя. Если функция возвращает код ошибки, у вызывающего объекта обычно нет способа очистить параметры out или out. Это приводит к следующим дополнительным правилам.

-   В случае ошибки параметры всегда должны быть надежно установлены в значение, которое будет очищено без каких-либо действий вызывающим.
-   Все параметры указателя out должны быть явно установлены в **значение NULL**. Обычно они передаются в параметре указателя на указатель, но также могут передаваться как члены структуры, выделенной вызывающим объектом, и вызываемый код заполняется. Самый простой способ убедиться, что этот параметр (в части) присвоить этим значениям значение **null** при вводе функции. Это правило важно, так как оно повышает надежность взаимодействия приложений.
-   В условиях ошибки все параметры out должны быть оставлены по отдельности в коде (таким образом, остается в значении, для которого они были инициализированы вызывающим объектом) или явно заданы, как в случае с параметром out Error.

Помните, что эти соглашения об управлении памятью для COM-приложений применяются только к открытым интерфейсам и Аписâ € "нет необходимости в том, чтобы выделение памяти, строго внутреннее для COM-приложения, было выполнено с помощью этих механизмов.

COM внутренне использует удаленные вызовы процедур (RPC) для обмена данными между клиентами и серверами. Дополнительные сведения об управлении памятью в заглушках RPC-сервера см. в разделе [сервер-заглушка управления памятью](../rpc/server-stub-memory-management.md) .

## <a name="related-topics"></a>См. также

<dl> <dt>

[Управление выделением памяти](managing-memory-allocation.md)
</dt> </dl>

 

 