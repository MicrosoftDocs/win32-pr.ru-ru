---
title: Сведения о маршалировании
description: Если вы используете стандартную упаковку, COM обрабатывает все описанные здесь сведения.
ms.assetid: bf3fe212-648e-4d00-ad1d-43d2e5e6a7ae
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f4d0fd46ee29c712c6f2b5b286df76a30f1047e6
ms.sourcegitcommit: d39e82e232f6510f843fdb8d55d25b4e9e02e880
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "105713223"
---
# <a name="marshaling-details"></a><span data-ttu-id="9ad43-103">Сведения о маршалировании</span><span class="sxs-lookup"><span data-stu-id="9ad43-103">Marshaling Details</span></span>

<span data-ttu-id="9ad43-104">Если вы используете стандартную упаковку, COM обрабатывает все описанные здесь сведения.</span><span class="sxs-lookup"><span data-stu-id="9ad43-104">If you use standard marshaling, COM handles all of the details described here for you.</span></span> <span data-ttu-id="9ad43-105">Однако существует несколько программистов, которым требуются эти сведения, и для тех, кто заинтересован в базовой информации.</span><span class="sxs-lookup"><span data-stu-id="9ad43-105">However, there are those few programmers who need these details and for those interested in the underlying information.</span></span> <span data-ttu-id="9ad43-106">Маршалирование — это процесс упаковки и распаковки параметров, позволяющий выполнять удаленный вызов процедур.</span><span class="sxs-lookup"><span data-stu-id="9ad43-106">Marshaling is the process of packaging and unpackaging parameters so a remote procedure call can take place.</span></span>

<span data-ttu-id="9ad43-107">Различные типы параметров маршалируются различными способами.</span><span class="sxs-lookup"><span data-stu-id="9ad43-107">Different parameter types are marshaled in different ways.</span></span> <span data-ttu-id="9ad43-108">Например, упаковка целочисленного параметра подразумевает простое копирование значения в буфер сообщения.</span><span class="sxs-lookup"><span data-stu-id="9ad43-108">For example, marshaling an integer parameter involves simply copying the value into the message buffer.</span></span> <span data-ttu-id="9ad43-109">(Хотя даже в этом простом случае существуют проблемы, например порядок байтов для обработки вызовов между компьютерами). Однако маршалирование массива является более сложным процессом.</span><span class="sxs-lookup"><span data-stu-id="9ad43-109">(Although even in this simple case, there are issues such as byte ordering to deal with in cross-computer calls.) Marshaling an array, however, is a more complex process.</span></span> <span data-ttu-id="9ad43-110">Элементы массива копируются в определенном порядке, чтобы другая сторона могла точно воссоздать массив.</span><span class="sxs-lookup"><span data-stu-id="9ad43-110">Array members are copied in a specific order so that the other side can reconstruct the array exactly.</span></span> <span data-ttu-id="9ad43-111">При маршалировании указателя данные, на которые указывает указатель, копируются после правил и соглашений, связанных с вложенными указателями в структурах.</span><span class="sxs-lookup"><span data-stu-id="9ad43-111">When a pointer is marshaled, the data that the pointer is pointing to is copied following rules and conventions for dealing with nested pointers in structures.</span></span> <span data-ttu-id="9ad43-112">Для управления упаковкой каждого типа параметра существуют уникальные функции.</span><span class="sxs-lookup"><span data-stu-id="9ad43-112">Unique functions exist to handle the marshaling of each parameter type.</span></span>

<span data-ttu-id="9ad43-113">При стандартном маршалировании прокси-серверы и заглушки являются ресурсами для интерфейса на уровне системы и взаимодействуют с каналом по стандартному протоколу.</span><span class="sxs-lookup"><span data-stu-id="9ad43-113">With standard marshaling, the proxies and stubs are systemwide resources for the interface and they interact with the channel through a standard protocol.</span></span> <span data-ttu-id="9ad43-114">Стандартную упаковку можно использовать как в стандартных интерфейсах, определяемых моделью COM, так и в пользовательских интерфейсах следующим образом.</span><span class="sxs-lookup"><span data-stu-id="9ad43-114">Standard marshaling can be used both by standard COM-defined interfaces and by custom interfaces, as follows:</span></span>

-   <span data-ttu-id="9ad43-115">В случае с большинством COM-интерфейсов прокси-серверы и заглушки для стандартной упаковки — это объекты внутрипроцессного компонента, загружаемые из общесистемной библиотеки DLL, предоставляемой COM в Ole32.dll.</span><span class="sxs-lookup"><span data-stu-id="9ad43-115">In the case of most COM interfaces, the proxies and stubs for standard marshaling are in-process component objects which are loaded from a systemwide DLL provided by COM in Ole32.dll.</span></span>
-   <span data-ttu-id="9ad43-116">В случае пользовательских интерфейсов прокси-серверы и заглушки для стандартного маршалирования создаются конструктором интерфейса, обычно с помощью MIDL.</span><span class="sxs-lookup"><span data-stu-id="9ad43-116">In the case of custom interfaces, the proxies and stubs for standard marshaling are generated by the interface designer, typically with MIDL.</span></span> <span data-ttu-id="9ad43-117">Эти прокси-серверы и заглушки статически настроены в реестре, поэтому любой потенциальный клиент может использовать пользовательский интерфейс через границы процесса.</span><span class="sxs-lookup"><span data-stu-id="9ad43-117">These proxies and stubs are statically configured in the registry, so any potential client can use the custom interface across process boundaries.</span></span> <span data-ttu-id="9ad43-118">Эти прокси-серверы и заглушки загружаются из библиотеки DLL, расположенной в системном реестре, с использованием идентификатора интерфейса (IID) для настраиваемого интерфейса, который они маршалируются.</span><span class="sxs-lookup"><span data-stu-id="9ad43-118">These proxies and stubs are loaded from a DLL that is located via the system registry, using the interface ID (IID) for the custom interface they marshal.</span></span>
-   <span data-ttu-id="9ad43-119">В качестве альтернативы использованию MIDL для создания прокси-серверов и заглушек для настраиваемых интерфейсов вместо этого можно создать библиотеку типов, а предоставляемая система, Type-либрариâ €, будет маршалировать интерфейс.</span><span class="sxs-lookup"><span data-stu-id="9ad43-119">An alternative to using MIDL to generate proxies and stubs for custom interfaces, a type library can be generated instead and the system provided, type-libraryâ€“driven marshaling engine will marshal the interface.</span></span>

<span data-ttu-id="9ad43-120">В качестве альтернативы стандартному упаковке интерфейс (стандартный или настраиваемый) может использовать настраиваемое маршалирование.</span><span class="sxs-lookup"><span data-stu-id="9ad43-120">As an alternative to standard marshaling, an interface (standard or custom) can use custom marshaling.</span></span> <span data-ttu-id="9ad43-121">При пользовательском маршалировании объект динамически реализует прокси-серверы во время выполнения для каждого интерфейса, который он поддерживает.</span><span class="sxs-lookup"><span data-stu-id="9ad43-121">With custom marshaling, an object dynamically implements the proxies at run time for each interface that it supports.</span></span> <span data-ttu-id="9ad43-122">Для любого заданного интерфейса объект может выбрать предоставленный моделью COM стандартную упаковку или настраиваемую упаковку.</span><span class="sxs-lookup"><span data-stu-id="9ad43-122">For any given interface, the object can select COM-provided standard marshaling or custom marshaling.</span></span> <span data-ttu-id="9ad43-123">Этот вариант сделан объектом на основе интерфейса.</span><span class="sxs-lookup"><span data-stu-id="9ad43-123">This choice is made by the object on an interface-by-interface basis.</span></span> <span data-ttu-id="9ad43-124">После выбора для данного интерфейса он остается в силе во время существования объекта.</span><span class="sxs-lookup"><span data-stu-id="9ad43-124">Once the choice is made for a given interface, it remains in effect during the object's lifetime.</span></span> <span data-ttu-id="9ad43-125">Однако один интерфейс для объекта может использовать настраиваемую упаковку, а другой — стандартную упаковку.</span><span class="sxs-lookup"><span data-stu-id="9ad43-125">However, one interface on an object can use custom marshaling while another uses standard marshaling.</span></span>

<span data-ttu-id="9ad43-126">Пользовательский маршалирование по сути является уникальным для объекта, который его реализует.</span><span class="sxs-lookup"><span data-stu-id="9ad43-126">Custom marshaling is inherently unique to the object that implements it.</span></span> <span data-ttu-id="9ad43-127">Он использует прокси-серверы, реализованные объектом, и предоставляется системе по запросу во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="9ad43-127">It uses proxies implemented by the object and provided to the system on request at run time.</span></span> <span data-ttu-id="9ad43-128">Объекты, реализующие пользовательский маршалирование, должны реализовывать интерфейс [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal) , тогда как объекты, поддерживающие стандартную упаковку, — нет.</span><span class="sxs-lookup"><span data-stu-id="9ad43-128">Objects that implement custom marshaling must implement the [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal) interface, whereas objects that support standard marshaling do not.</span></span>

<span data-ttu-id="9ad43-129">Если вы решили написать пользовательский интерфейс, необходимо предоставить для него поддержку упаковки.</span><span class="sxs-lookup"><span data-stu-id="9ad43-129">If you decide to write a custom interface, you must provide marshaling support for it.</span></span> <span data-ttu-id="9ad43-130">Как правило, вы будете предоставлять стандартную библиотеку DLL для маршалирования для создаваемого интерфейса.</span><span class="sxs-lookup"><span data-stu-id="9ad43-130">Typically, you will provide a standard marshaling DLL for the interface you design.</span></span> <span data-ttu-id="9ad43-131">Можно создать код прокси-сервера или заглушки, а также БИБЛИОТЕКУ прокси-сервера или заглушки, или создать библиотеку типов, которую COM будет использовать для выполнения маршалирования на основе данных (с использованием данных в библиотеке типов).</span><span class="sxs-lookup"><span data-stu-id="9ad43-131">You can create the proxy/stub code and the proxy/stub DLL, or you can create a type library that COM will use to do data-driven marshaling (using the data in the type library).</span></span>

<span data-ttu-id="9ad43-132">Чтобы клиент вызывал метод интерфейса в объекте другого процесса, требуется взаимодействие нескольких компонентов.</span><span class="sxs-lookup"><span data-stu-id="9ad43-132">For a client to make a call to an interface method in an object in another process involves the cooperation of several components.</span></span> <span data-ttu-id="9ad43-133">Стандартный прокси-сервер — это фрагмент кода, зависящего от интерфейса, который находится в пространстве процесса клиента и подготавливает параметры интерфейса для передачи.</span><span class="sxs-lookup"><span data-stu-id="9ad43-133">The standard proxy is a piece of interface-specific code that resides in the client's process space and prepares the interface parameters for transmittal.</span></span> <span data-ttu-id="9ad43-134">ИТ-пакеты, или маршалирует, таким образом, чтобы их можно было повторно создать и понять в процессе получения.</span><span class="sxs-lookup"><span data-stu-id="9ad43-134">It packages, or marshals, them in such a way that they can be re-created and understood in the receiving process.</span></span> <span data-ttu-id="9ad43-135">Стандартная заглушка, а также часть кода, зависящего от интерфейса, находится в пространстве процесса сервера и отменяет работу прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="9ad43-135">The standard stub, also a piece of interface-specific code, resides in the server's process space and reverses the work of the proxy.</span></span> <span data-ttu-id="9ad43-136">Заглушка распаковать или распаковать передаваемые параметры и пересылает их приложению объекта.</span><span class="sxs-lookup"><span data-stu-id="9ad43-136">The stub unpackages, or unmarshals, the sent parameters and forwards them to the object application.</span></span> <span data-ttu-id="9ad43-137">Он также упаковывает ответные данные для отправки обратно клиенту.</span><span class="sxs-lookup"><span data-stu-id="9ad43-137">It also packages reply information to send back to the client.</span></span>

> [!Note]  
> <span data-ttu-id="9ad43-138">Читатели, более знакомые с RPC, чем COM, могут использовать для просмотра терминов клиентскую заглушку и заглушку сервера.</span><span class="sxs-lookup"><span data-stu-id="9ad43-138">Readers more familiar with RPC than COM may be used to seeing the terms client stub and server stub.</span></span> <span data-ttu-id="9ad43-139">Эти термины аналогичны прокси и заглушке.</span><span class="sxs-lookup"><span data-stu-id="9ad43-139">These terms are analogous to proxy and stub.</span></span>

 

## <a name="components-of-interprocess-communications"></a><span data-ttu-id="9ad43-140">Компоненты взаимодействия между процессами</span><span class="sxs-lookup"><span data-stu-id="9ad43-140">Components of Interprocess Communications</span></span>

<span data-ttu-id="9ad43-141">На следующей схеме показан поток обмена данными между компонентами.</span><span class="sxs-lookup"><span data-stu-id="9ad43-141">The following diagram shows the flow of communication between the components involved.</span></span> <span data-ttu-id="9ad43-142">На стороне клиента границы процесса вызов метода клиента проходит через прокси-сервер, а затем на канал, который является частью библиотеки COM.</span><span class="sxs-lookup"><span data-stu-id="9ad43-142">On the client side of the process boundary, the client's method call goes through the proxy and then onto the channel, which is part of the COM library.</span></span> <span data-ttu-id="9ad43-143">Канал отправляет буфер, содержащий Упакованные параметры, в библиотеку времени выполнения RPC, которая передает ее через границу процесса.</span><span class="sxs-lookup"><span data-stu-id="9ad43-143">The channel sends the buffer containing the marshaled parameters to the RPC run-time library, which transmits it across the process boundary.</span></span> <span data-ttu-id="9ad43-144">Время выполнения RPC и библиотеки COM существуют на обеих сторонах процесса.</span><span class="sxs-lookup"><span data-stu-id="9ad43-144">The RPC run time and the COM libraries exist on both sides of the process.</span></span> <span data-ttu-id="9ad43-145">Различие между каналом и временем выполнения RPC является характеристикой этой реализации и не является частью модели программирования или концептуальной модели для COM-объектов Client/Server.</span><span class="sxs-lookup"><span data-stu-id="9ad43-145">The distinction between the channel and the RPC run time is a characteristic of this implementation and is not part of the programming model or the conceptual model for COM client/server objects.</span></span> <span data-ttu-id="9ad43-146">Серверы COM видят только прокси-сервер или заглушку, а также непрямой канал.</span><span class="sxs-lookup"><span data-stu-id="9ad43-146">COM servers see only the proxy or stub and, indirectly, the channel.</span></span> <span data-ttu-id="9ad43-147">В будущих реализациях могут использоваться разные слои, расположенные под каналом или без слоев.</span><span class="sxs-lookup"><span data-stu-id="9ad43-147">Future implementations may use different layers below the channel or no layers.</span></span>

![Схема, на которой показаны Client.exe и Server.exe потоки на каждой стороне в границах процесса.](images/457036c1-98b8-4f35-aebe-70de38112b83.png)

## <a name="related-topics"></a><span data-ttu-id="9ad43-149">См. также</span><span class="sxs-lookup"><span data-stu-id="9ad43-149">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="9ad43-150">Канал</span><span class="sxs-lookup"><span data-stu-id="9ad43-150">Channel</span></span>](channel.md)
</dt> <dt>

[<span data-ttu-id="9ad43-151">Обмен данными между объектами</span><span class="sxs-lookup"><span data-stu-id="9ad43-151">Inter-Object Communication</span></span>](inter-object-communication.md)
</dt> <dt>

[<span data-ttu-id="9ad43-152">Microsoft RPC</span><span class="sxs-lookup"><span data-stu-id="9ad43-152">Microsoft RPC</span></span>](microsoft-rpc.md)
</dt> <dt>

[<span data-ttu-id="9ad43-153">Прокси</span><span class="sxs-lookup"><span data-stu-id="9ad43-153">Proxy</span></span>](proxy.md)
</dt> <dt>

[<span data-ttu-id="9ad43-154">Заглушка</span><span class="sxs-lookup"><span data-stu-id="9ad43-154">Stub</span></span>](stub.md)
</dt> </dl>

 

 