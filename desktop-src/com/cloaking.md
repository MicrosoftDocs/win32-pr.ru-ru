---
title: Маскировка (COM)
description: Маскировка — это возможность обеспечения безопасности COM, которая определяет, какие идентификаторы клиентские проекты применяют к серверу во время олицетворения.
ms.assetid: 5b97d9d6-8fa9-4da2-8351-64772227d9a2
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 588651cfa37def4e174ef0f2fdba9b79b0c60ca8
ms.sourcegitcommit: d39e82e232f6510f843fdb8d55d25b4e9e02e880
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "103913935"
---
# <a name="cloaking-com"></a><span data-ttu-id="8c1f3-103">Маскировка (COM)</span><span class="sxs-lookup"><span data-stu-id="8c1f3-103">Cloaking (COM)</span></span>

<span data-ttu-id="8c1f3-104">Маскировка — это возможность обеспечения безопасности COM, которая определяет, какие идентификаторы клиентские проекты применяют к серверу во время олицетворения.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-104">Cloaking is a COM security capability that determines what identity the client projects toward the server during impersonation.</span></span> <span data-ttu-id="8c1f3-105">Когда задается маскировка, промежуточный сервер маскирует свое собственное удостоверение и передает удостоверение клиента серверу, который он вызывает от имени клиента.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-105">When cloaking is set, the intermediate server masks its own identity and presents the client's identity to the server that it calls on the client's behalf.</span></span> <span data-ttu-id="8c1f3-106">Практически удостоверение клиента, отображаемое сервером, — это удостоверение, связанное с прокси.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-106">Basically; the client identity that is seen by the server is the identity associated with the proxy.</span></span> <span data-ttu-id="8c1f3-107">Удостоверение прокси-сервера определяется несколькими факторами, одним из которых является заданный тип маскировки (если таковой имеется).</span><span class="sxs-lookup"><span data-stu-id="8c1f3-107">The proxy's identity is determined by several factors, one of which is the type of cloaking that is set (if any).</span></span> <span data-ttu-id="8c1f3-108">В поставщике безопасности SChannel не поддерживается маскировка.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-108">Cloaking is not supported by the Schannel security provider.</span></span>

<span data-ttu-id="8c1f3-109">В следующих разделах приводятся дополнительные сведения о маскировке.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-109">The following topics provide more information about cloaking:</span></span>

-   [<span data-ttu-id="8c1f3-110">Типы маскировки</span><span class="sxs-lookup"><span data-stu-id="8c1f3-110">Types of Cloaking</span></span>](#types-of-cloaking)
-   [<span data-ttu-id="8c1f3-111">Влияние маскировки на удостоверение клиента</span><span class="sxs-lookup"><span data-stu-id="8c1f3-111">How Cloaking Affects Client Identity</span></span>](#how-cloaking-affects-client-identity)
-   [<span data-ttu-id="8c1f3-112">Настройка маскировки</span><span class="sxs-lookup"><span data-stu-id="8c1f3-112">Setting Cloaking</span></span>](#setting-cloaking)
-   [<span data-ttu-id="8c1f3-113">Уровни маскировки и олицетворения</span><span class="sxs-lookup"><span data-stu-id="8c1f3-113">Cloaking and Impersonation Levels</span></span>](#cloaking-and-impersonation-levels)
-   [<span data-ttu-id="8c1f3-114">Сценарии маскировки</span><span class="sxs-lookup"><span data-stu-id="8c1f3-114">Cloaking Scenarios</span></span>](#cloaking-scenarios)
-   [<span data-ttu-id="8c1f3-115">См. также</span><span class="sxs-lookup"><span data-stu-id="8c1f3-115">Related topics</span></span>](#related-topics)

## <a name="types-of-cloaking"></a><span data-ttu-id="8c1f3-116">Типы маскировки</span><span class="sxs-lookup"><span data-stu-id="8c1f3-116">Types of Cloaking</span></span>

<span data-ttu-id="8c1f3-117">Существует два типа маскировки: *статическая* маскировка и *Динамическая* маскировка:</span><span class="sxs-lookup"><span data-stu-id="8c1f3-117">There are two types of cloaking: *static* cloaking and *dynamic* cloaking:</span></span>

-   <span data-ttu-id="8c1f3-118">При статическом скрытии (ЕОАК \_ static \_ маскировка) сервер видит маркер потока от первого вызова клиента серверу.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-118">With static cloaking (EOAC\_STATIC\_CLOAKING), the server sees the thread token from the first call from a client to the server.</span></span> <span data-ttu-id="8c1f3-119">Для первого вызова, если удостоверение прокси-сервера было ранее задано во время вызова [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket), используется удостоверение прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-119">For the first call, if the proxy identity was previously set during a call to [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket), that proxy identity is used.</span></span> <span data-ttu-id="8c1f3-120">Однако если удостоверение прокси-сервера не было задано ранее, используется токен потока.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-120">However, if the proxy identity was not previously set, the thread token is used.</span></span> <span data-ttu-id="8c1f3-121">Если токен потока отсутствует, используется токен процесса.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-121">If no thread token is present, the process token is used.</span></span> <span data-ttu-id="8c1f3-122">Для всех будущих вызовов используется удостоверение, заданное при первом вызове.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-122">For all future calls, the identity set on the first call is used.</span></span>
-   <span data-ttu-id="8c1f3-123">При динамическом маскировке (ЕОАК \_ Dynamic \_ маскировка) при каждом вызове для определения удостоверения клиента используется текущий маркер потока (если имеется токен потока).</span><span class="sxs-lookup"><span data-stu-id="8c1f3-123">With dynamic cloaking (EOAC\_DYNAMIC\_CLOAKING), on each call the current thread token (if there is a thread token) is used to determine the client's identity.</span></span> <span data-ttu-id="8c1f3-124">Если токен потока отсутствует, используется токен процесса.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-124">If there is no thread token, the process token is used.</span></span> <span data-ttu-id="8c1f3-125">Это означает, что серверы, вызываемые от имени клиента во время олицетворения, видят идентификатор клиента COM, который вызвал вызов, что обычно является требуемым поведением.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-125">This means that servers called on the client's behalf during impersonation see the identity of the COM client that originated the call, which is generally the desired behavior.</span></span> <span data-ttu-id="8c1f3-126">(Конечно, чтобы олицетворение завершилось успешно, клиент должен был предоставить ему право на олицетворение, установив соответствующий уровень олицетворения.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-126">(Of course, for impersonation to succeed, the client must have given the server authority to impersonate by setting an appropriate impersonation level.</span></span> <span data-ttu-id="8c1f3-127">Дополнительные сведения см. в разделе [уровни олицетворения](impersonation-levels.md).) Этот тип маскировки является дорогостоящим.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-127">For more information, see [Impersonation Levels](impersonation-levels.md).) This type of cloaking is expensive.</span></span>

## <a name="how-cloaking-affects-client-identity"></a><span data-ttu-id="8c1f3-128">Влияние маскировки на удостоверение клиента</span><span class="sxs-lookup"><span data-stu-id="8c1f3-128">How Cloaking Affects Client Identity</span></span>

<span data-ttu-id="8c1f3-129">Когда выполняется зашифрованный вызов и сервер запрашивает у клиента удостоверение, обычно он получает удостоверение, привязанное к прокси-серверу.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-129">When an encrypted call is made and the server asks the client for its identity, it usually gets the identity tied to the proxy.</span></span> <span data-ttu-id="8c1f3-130">(Иногда служба проверки подлинности выполняет перевод из реальной идентификации, но обычно удостоверение прокси-сервера — это удостоверение, которое видит сервер.) Прокси-сервер предоставляет удостоверение серверу, который зависит от типа заданной маскировки и других факторов.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-130">(Sometimes the authentication service performs a translation from the real identity, but generally the proxy identity is the identity the server sees.) The proxy presents an identity to the server that depends on the type of cloaking that is set and other factors.</span></span>

<span data-ttu-id="8c1f3-131">Для суммирования удостоверение клиента является функцией флага маскировки, маркером процесса, присутствием или отсутствием маркера потока, а также от того, было ли ранее задано удостоверение прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-131">To summarize, the identity of the client is a function of the cloaking flag set, the process token, the presence or absence of a thread token, and whether the proxy identity has been previously set.</span></span> <span data-ttu-id="8c1f3-132">В следующей таблице показана результирующая идентификация прокси-сервера (удостоверение клиента), если эти факторы различаются.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-132">The following table shows the resulting proxy identity (client identity) when these factors vary.</span></span>



| <span data-ttu-id="8c1f3-133">Флаги маскировки</span><span class="sxs-lookup"><span data-stu-id="8c1f3-133">Cloaking Flags</span></span>                     | <span data-ttu-id="8c1f3-134">Присутствие токена потока</span><span class="sxs-lookup"><span data-stu-id="8c1f3-134">Thread Token Presence</span></span>  | <span data-ttu-id="8c1f3-135">Удостоверение прокси-сервера задано ранее</span><span class="sxs-lookup"><span data-stu-id="8c1f3-135">Proxy Identity Previously Set</span></span> | <span data-ttu-id="8c1f3-136">Удостоверение прокси-сервера (удостоверение клиента)</span><span class="sxs-lookup"><span data-stu-id="8c1f3-136">Proxy Identity (Client Identity)</span></span>                    |
|------------------------------------|------------------------|-------------------------------|-----------------------------------------------------|
| <span data-ttu-id="8c1f3-137">Маскировка не задана</span><span class="sxs-lookup"><span data-stu-id="8c1f3-137">Cloaking not set</span></span><br/>        | <span data-ttu-id="8c1f3-138">Не заботиться</span><span class="sxs-lookup"><span data-stu-id="8c1f3-138">Don't care</span></span><br/>  | <span data-ttu-id="8c1f3-139">Не заботиться</span><span class="sxs-lookup"><span data-stu-id="8c1f3-139">Don't care</span></span><br/>         | <span data-ttu-id="8c1f3-140">Маркер процесса или удостоверение проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="8c1f3-140">Process token or authentication identity</span></span><br/> |
| <span data-ttu-id="8c1f3-141">ЕОАК \_ статическая \_ маскировка</span><span class="sxs-lookup"><span data-stu-id="8c1f3-141">EOAC\_STATIC\_CLOAKING</span></span><br/>  | <span data-ttu-id="8c1f3-142">Присутствует</span><span class="sxs-lookup"><span data-stu-id="8c1f3-142">Present</span></span><br/>     | <span data-ttu-id="8c1f3-143">Нет</span><span class="sxs-lookup"><span data-stu-id="8c1f3-143">No</span></span><br/>                 | <span data-ttu-id="8c1f3-144">Токен потока</span><span class="sxs-lookup"><span data-stu-id="8c1f3-144">Thread token</span></span><br/>                             |
| <span data-ttu-id="8c1f3-145">ЕОАК \_ статическая \_ маскировка</span><span class="sxs-lookup"><span data-stu-id="8c1f3-145">EOAC\_STATIC\_CLOAKING</span></span><br/>  | <span data-ttu-id="8c1f3-146">Присутствует</span><span class="sxs-lookup"><span data-stu-id="8c1f3-146">Present</span></span><br/>     | <span data-ttu-id="8c1f3-147">Да</span><span class="sxs-lookup"><span data-stu-id="8c1f3-147">Yes</span></span><br/>                | <span data-ttu-id="8c1f3-148">Текущее удостоверение прокси-сервера</span><span class="sxs-lookup"><span data-stu-id="8c1f3-148">Current proxy identity</span></span><br/>                   |
| <span data-ttu-id="8c1f3-149">ЕОАК \_ статическая \_ маскировка</span><span class="sxs-lookup"><span data-stu-id="8c1f3-149">EOAC\_STATIC\_CLOAKING</span></span><br/>  | <span data-ttu-id="8c1f3-150">Отсутствует</span><span class="sxs-lookup"><span data-stu-id="8c1f3-150">Not present</span></span><br/> | <span data-ttu-id="8c1f3-151">Нет</span><span class="sxs-lookup"><span data-stu-id="8c1f3-151">No</span></span><br/>                 | <span data-ttu-id="8c1f3-152">Токен процесса</span><span class="sxs-lookup"><span data-stu-id="8c1f3-152">Process token</span></span><br/>                            |
| <span data-ttu-id="8c1f3-153">ЕОАК \_ статическая \_ маскировка</span><span class="sxs-lookup"><span data-stu-id="8c1f3-153">EOAC\_STATIC\_CLOAKING</span></span><br/>  | <span data-ttu-id="8c1f3-154">Отсутствует</span><span class="sxs-lookup"><span data-stu-id="8c1f3-154">Not present</span></span><br/> | <span data-ttu-id="8c1f3-155">Да</span><span class="sxs-lookup"><span data-stu-id="8c1f3-155">Yes</span></span><br/>                | <span data-ttu-id="8c1f3-156">Текущее удостоверение прокси-сервера</span><span class="sxs-lookup"><span data-stu-id="8c1f3-156">Current proxy identity</span></span><br/>                   |
| <span data-ttu-id="8c1f3-157">\_динамическое \_ МАСКИРОВКа еоак</span><span class="sxs-lookup"><span data-stu-id="8c1f3-157">EOAC\_DYNAMIC\_CLOAKING</span></span><br/> | <span data-ttu-id="8c1f3-158">Присутствует</span><span class="sxs-lookup"><span data-stu-id="8c1f3-158">Present</span></span><br/>     | <span data-ttu-id="8c1f3-159">Не заботиться</span><span class="sxs-lookup"><span data-stu-id="8c1f3-159">Don't care</span></span><br/>         | <span data-ttu-id="8c1f3-160">Токен потока</span><span class="sxs-lookup"><span data-stu-id="8c1f3-160">Thread token</span></span><br/>                             |
| <span data-ttu-id="8c1f3-161">\_динамическое \_ МАСКИРОВКа еоак</span><span class="sxs-lookup"><span data-stu-id="8c1f3-161">EOAC\_DYNAMIC\_CLOAKING</span></span><br/> | <span data-ttu-id="8c1f3-162">Отсутствует</span><span class="sxs-lookup"><span data-stu-id="8c1f3-162">Not present</span></span><br/> | <span data-ttu-id="8c1f3-163">Не заботиться</span><span class="sxs-lookup"><span data-stu-id="8c1f3-163">Don't care</span></span> <br/>        | <span data-ttu-id="8c1f3-164">Токен процесса</span><span class="sxs-lookup"><span data-stu-id="8c1f3-164">Process token</span></span><br/>                            |



 

<span data-ttu-id="8c1f3-165">В следующей блок-схеме показано, как удостоверение прокси определяется в различных ситуациях.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-165">The following flowchart illustrates how the proxy identity is determined in different situations.</span></span>

![Схема, показывающая последовательность для определения удостоверения прокси-сервера.](images/9e8409b7-8475-4824-bdff-cf6b09c139c5.png)

## <a name="setting-cloaking"></a><span data-ttu-id="8c1f3-167">Настройка маскировки</span><span class="sxs-lookup"><span data-stu-id="8c1f3-167">Setting Cloaking</span></span>

<span data-ttu-id="8c1f3-168">Маскировка устанавливается как флаг возможности в вызове [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), который задает маскировку для всего процесса.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-168">Cloaking is set as a capability flag in a call to [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), which sets cloaking for the entire process.</span></span> <span data-ttu-id="8c1f3-169">Затем функция маскировки устанавливается до тех пор, пока клиент не изменит его с помощью вызова Иклиентсекурити::[**сетбланкет**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) (или для [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket)), который задает маскировку для прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-169">The cloaking capability is then set until the client changes it through a call to IClientSecurity::[**SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) (or to [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket)), which sets cloaking for the proxy.</span></span>

<span data-ttu-id="8c1f3-170">По умолчанию маскировка не задана.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-170">By default, cloaking is not set.</span></span> <span data-ttu-id="8c1f3-171">Чтобы задать его, передайте \_ еоак \_ статическую маскировку или еоак \_ динамическую \_ маскировку в параметр *пкапабилитиес* в [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) или [**сетбланкет**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket).</span><span class="sxs-lookup"><span data-stu-id="8c1f3-171">To set it, pass EOAC\_STATIC\_CLOAKING or EOAC\_DYNAMIC\_CLOAKING to the *pCapabilities* parameter in [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) or [**SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket).</span></span>

<span data-ttu-id="8c1f3-172">Если статическая Маскировка включена с помощью [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), каждый прокси-сервер принимает маркер (поток или процесс) при первом вызове на прокси-сервере.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-172">When static cloaking is enabled using [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), each proxy picks up a token (thread or process) the first time you make a call on the proxy.</span></span> <span data-ttu-id="8c1f3-173">Если статическая Маскировка включена с помощью [**сетбланкет**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket), прокси-сервер выбирает в это время маркер в потоке.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-173">When static cloaking is enabled using [**SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket), the proxy picks up the token on the thread at that time.</span></span> <span data-ttu-id="8c1f3-174">Если маркер потока недоступен при вызове **сетбланкет** , маркер процесса используется для удостоверения прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-174">If no thread token is available when **SetBlanket** is called, the process token is used for the proxy's identity.</span></span> <span data-ttu-id="8c1f3-175">По сути, **сетбланкет** исправляет удостоверение прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-175">Basically, **SetBlanket** fixes the identity of the proxy.</span></span>

<span data-ttu-id="8c1f3-176">При динамическом маскировке удостоверение прокси-сервера определяется таким же образом независимо от того, задано ли динамическое маскировка с помощью [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) или [**сетбланкет**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket).</span><span class="sxs-lookup"><span data-stu-id="8c1f3-176">With dynamic cloaking, the proxy's identity is determined the same way regardless of whether dynamic cloaking is set using [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) or with [**SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket).</span></span> <span data-ttu-id="8c1f3-177">Текущий токен потока используется при его наличии; в противном случае используется токен процесса.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-177">The current thread token is used if there is one; otherwise, the process token is used.</span></span>

<span data-ttu-id="8c1f3-178">Если маскировка задана для всего процесса с помощью вызова [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) и необходимо выполнить вызовы с маркером процесса, не олицетворять во время вызовов.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-178">If cloaking is set for the entire process through a call to [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) and you want to make calls with the process token, do not impersonate while making calls.</span></span>

## <a name="cloaking-and-impersonation-levels"></a><span data-ttu-id="8c1f3-179">Уровни маскировки и олицетворения</span><span class="sxs-lookup"><span data-stu-id="8c1f3-179">Cloaking and Impersonation Levels</span></span>

<span data-ttu-id="8c1f3-180">Как упоминалось ранее, функция маскировки определяет, какое удостоверение будет представлено серверу во время олицетворения.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-180">As mentioned previously, the cloaking capability determines what identity is presented to a server during impersonation.</span></span> <span data-ttu-id="8c1f3-181">Маскировка позволяет серверу проецировать идентификатор, отличный от собственного, на другой сервер, который вызывается от имени клиента.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-181">Cloaking provides a way for a server to project an identity other than its own to another server it is calling on behalf of the client.</span></span> <span data-ttu-id="8c1f3-182">Уровень олицетворения указывает, сколько полномочий клиент предоставил серверу.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-182">The impersonation level indicates how much authority the client has given the server.</span></span>

<span data-ttu-id="8c1f3-183">Олицетворение без маскировки работает, но может быть не лучшим выбором, так как в некоторых случаях окончательный сервер должен идентифицировать удостоверение начального вызывающего.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-183">Impersonation without cloaking works, but it may not be the best choice because, in some cases, the final server needs to know the identity of the initial caller.</span></span> <span data-ttu-id="8c1f3-184">Это невозможно сделать без использования маскировки, так как трудно убедиться, что доступ к удаленному компьютеру имеют только полномочные клиенты.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-184">This cannot be achieved without using cloaking because it is difficult to ensure that only authorized clients can access a remote computer.</span></span> <span data-ttu-id="8c1f3-185">Если олицетворение используется без маскировки, то удостоверение, представленное для подчиненного сервера, заключается в том, что вызывает немедленно вызывающий процесс.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-185">When impersonation is used without cloaking, the identity presented to a downstream server is that of the immediate calling process.</span></span>

<span data-ttu-id="8c1f3-186">Однако маскировка не полезна без олицетворения.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-186">However, cloaking is not useful without impersonation.</span></span> <span data-ttu-id="8c1f3-187">Маскировка имеет смысл только в том случае, если клиент установил уровень олицетворения олицетворения или делегата.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-187">Cloaking makes sense only when the client has set an impersonation level of impersonate or delegate.</span></span> <span data-ttu-id="8c1f3-188">(С более низким уровнем олицетворения сервер не может делать немаскированные вызовы.) Успешная маскировка зависит от количества перекрестных границ компьютеров и от уровня олицетворения, который указывает, какой уровень полномочий должен выполнять сервер от имени клиента.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-188">(With lower impersonation levels, the server cannot make cloaked calls.) Whether cloaking is successful depends on the number of computer boundaries crossed and on the impersonation level, which indicates how much authority the server has to act on behalf of the client.</span></span>

<span data-ttu-id="8c1f3-189">В некоторых ситуациях сервер имеет смысл установить маскировку, когда клиент устанавливает уровень олицетворения на уровне RPC C, выполняющего \_ \_ \_ \_ олицетворение.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-189">In some situations, it makes sense for the server to set cloaking when the client sets the impersonation level to RPC\_C\_IMP\_LEVEL\_IMPERSONATE.</span></span> <span data-ttu-id="8c1f3-190">Однако действуют некоторые ограничения.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-190">However, certain limitations are in effect.</span></span> <span data-ttu-id="8c1f3-191">Если исходный клиент устанавливает уровень олицетворения для \_ \_ олицетворения на уровне RPC C \_ \_ , промежуточный сервер (действующий как клиент на том же компьютере) может быть замаскирован только на один компьютер.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-191">If the original client sets the impersonation level to RPC\_C\_IMP\_LEVEL\_IMPERSONATE, the intermediate server (acting as a client on the same computer) can cloak across only one computer boundary.</span></span> <span data-ttu-id="8c1f3-192">Это обусловлено тем, что токен олицетворения на уровне олицетворения может передаваться только на один компьютер.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-192">This is because an impersonate-level impersonation token can be passed across only one computer boundary.</span></span> <span data-ttu-id="8c1f3-193">После перекрестной границы компьютера доступ к локальным ресурсам возможен только для локальных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-193">After the computer boundary has been crossed, only local resources can be accessed.</span></span> <span data-ttu-id="8c1f3-194">Удостоверение, представленное серверу, зависит от типа заданной маскировки.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-194">The identity presented to the server depends on the type of cloaking that is set.</span></span> <span data-ttu-id="8c1f3-195">Если маскировка не задана, удостоверение, представленное серверу, будет таким же, как и процесс, выполняющий немедленное обращение.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-195">If no cloaking is set, the identity presented to a server will be that of the process making the immediate call.</span></span>

<span data-ttu-id="8c1f3-196">Для маскировки на нескольких компьютерах необходимо указать как соответствующий флаг возможностей маскировки, так и олицетворение на уровне делегата.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-196">To cloak over multiple computer boundaries, you must specify both an appropriate cloaking capability flag and delegate-level impersonation.</span></span> <span data-ttu-id="8c1f3-197">При таком типе олицетворения как локальные, так и сетевые учетные данные клиента предоставляются серверу, поэтому маркер олицетворения может пересекать любое количество компьютеров.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-197">With this type of impersonation, both the local and network credentials of the client are given to the server, so the impersonation token can cross any number of computer boundaries.</span></span> <span data-ttu-id="8c1f3-198">Опять же, удостоверение, представленное серверу, зависит от типа заданной маскировки.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-198">Again, the identity presented to the server depends on the type of cloaking that is set.</span></span> <span data-ttu-id="8c1f3-199">Если для олицетворения на уровне делегата не задана маскировка, удостоверение, представленное на сервере, состоит в том, что процесс, выполняющий вызов.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-199">If no cloaking is set with delegate-level impersonation, the identity presented to a server is that of the process making the call.</span></span>

<span data-ttu-id="8c1f3-200">Например, предположим, что обработка вызовов B, а B вызывает C. B, установила маскировку, а параметр олицетворения имеет значение IMPERSONATE.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-200">For example, suppose Process A calls B, and B calls C. B has set cloaking and A has set the impersonation level to impersonate.</span></span> <span data-ttu-id="8c1f3-201">Если A, B и C находятся на одном и том же компьютере, передача токена олицетворения из A в B и затем в C будет работать.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-201">If A, B, and C are on the same computer, passing the impersonation token from A to B and then to C will work.</span></span> <span data-ttu-id="8c1f3-202">Но если A и C находятся на одном и том же компьютере, а B — нет, передача маркера будет работать между A и B, но не с B на C. Вызов из B в C будет невозможен, так как B не может вызвать C во время маскировки.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-202">But if A and C are on the same computer, and B is not, passing the token will work between A and B, but not from B to C. The call from B to C will fail because B cannot call C while cloaking.</span></span> <span data-ttu-id="8c1f3-203">Однако если объект устанавливает уровень олицетворения, он может быть передан из B в C, а вызов может быть выполнен успешно.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-203">However, if A sets the impersonation level to delegate, the token can be passed from B to C and the call may succeed.</span></span>

## <a name="cloaking-scenarios"></a><span data-ttu-id="8c1f3-204">Сценарии маскировки</span><span class="sxs-lookup"><span data-stu-id="8c1f3-204">Cloaking Scenarios</span></span>

<span data-ttu-id="8c1f3-205">На следующем рисунке обработка вызова B вызывает C, вызывает D, если маскировка не задана.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-205">In the following illustration, Process A calls B, calls C, calls D when cloaking is not set.</span></span> <span data-ttu-id="8c1f3-206">В результате каждый промежуточный процесс видит удостоверение процесса, вызвавшего его.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-206">As a result, each intermediate process sees the identity of the process that called it.</span></span>

![Схема, показывающая процесс, когда скрытие не задано.](images/0d2eb6cf-97d6-4c4e-b97e-abad854b1120.png)

<span data-ttu-id="8c1f3-208">При статической маскировке сервер видит удостоверение прокси-сервера, которое было задано при первом вызове от клиента к серверу.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-208">With static cloaking, the server sees the proxy identity that was set during the first call from the client to the server.</span></span> <span data-ttu-id="8c1f3-209">На следующем рисунке показан пример удостоверения прокси-сервера, устанавливаемого во время вызова из B в C. При последующем вызове Process D видит удостоверение B, если статическая маскировка задана в B и C.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-209">The following figure shows an example of the proxy identity being set during a call from B to C. On a subsequent call, Process D sees B's identity when static cloaking is set by B and C.</span></span>

![Схема, на которой показан процесс статического маскирования.](images/520938e0-c4a6-4ac1-937d-02baf2007a27.png)

<span data-ttu-id="8c1f3-211">При использовании динамической маскировки удостоверение вызывающего объекта во время олицетворения основано на текущем маркере потока, если таковой имеется.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-211">With dynamic cloaking, the identity of the caller during impersonation is based on the current thread token, if there is one.</span></span> <span data-ttu-id="8c1f3-212">На следующем рисунке показана ситуация, когда B и C Set Dynamic маскировка и D видят удостоверение объекта, несмотря на более ранний вызов из B в C.</span><span class="sxs-lookup"><span data-stu-id="8c1f3-212">The following illustration shows the situation where B and C set dynamic cloaking and D sees the identity of A, despite an earlier call from B to C.</span></span>

![Схема, на которой показан процесс динамической маскировки.](images/d0848465-82f3-4d5a-851e-566d7800ada0.png)

## <a name="related-topics"></a><span data-ttu-id="8c1f3-214">См. также</span><span class="sxs-lookup"><span data-stu-id="8c1f3-214">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="8c1f3-215">Делегирование и олицетворение</span><span class="sxs-lookup"><span data-stu-id="8c1f3-215">Delegation and Impersonation</span></span>](delegation-and-impersonation.md)
</dt> </dl>

 

