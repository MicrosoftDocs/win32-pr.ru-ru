---
title: Реализация и активация обработчика без дополнительных данных сервера
description: Реализация и активация обработчика без дополнительных данных сервера
ms.assetid: 9d91260a-4cec-4a10-bb57-d02999efae47
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6866b40e1257a865aa5068ffd46611c411498877
ms.sourcegitcommit: d39e82e232f6510f843fdb8d55d25b4e9e02e880
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "103999803"
---
# <a name="implementing-and-activating-a-handler-with-no-extra-server-data"></a><span data-ttu-id="251f8-103">Реализация и активация обработчика без дополнительных данных сервера</span><span class="sxs-lookup"><span data-stu-id="251f8-103">Implementing and Activating a Handler with No Extra Server Data</span></span>

<span data-ttu-id="251f8-104">Чтобы создать экземпляр обработчика, если он не получает лишних данных сервера, сервер должен реализовать [**истдмаршалинфо**](/windows/win32/api/objidlbase/nn-objidlbase-istdmarshalinfo) , но не [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal).</span><span class="sxs-lookup"><span data-stu-id="251f8-104">To create an instance of your handler, if it is one that gets no extra server data, the server must implement [**IStdMarshalInfo**](/windows/win32/api/objidlbase/nn-objidlbase-istdmarshalinfo) but not [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal).</span></span> <span data-ttu-id="251f8-105">**Истдмаршалинфо** имеет один метод [**жетклассфорхандлер**](/windows/win32/api/objidlbase/nf-objidlbase-istdmarshalinfo-getclassforhandler), который извлекает идентификатор CLSID обработчика объекта, который будет использоваться в процессе назначения.</span><span class="sxs-lookup"><span data-stu-id="251f8-105">**IStdMarshalInfo** has one method, [**GetClassForHandler**](/windows/win32/api/objidlbase/nf-objidlbase-istdmarshalinfo-getclassforhandler), which retrieves the CLSID of the object handler to be used in the destination process.</span></span> <span data-ttu-id="251f8-106">COM вызывает это, когда вызывает [**комаршалинтерфаце**](/windows/desktop/api/combaseapi/nf-combaseapi-comarshalinterface) и активирует обработчик на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="251f8-106">COM calls this when it calls [**CoMarshalInterface**](/windows/desktop/api/combaseapi/nf-combaseapi-comarshalinterface) for you and activates the handler on the client side.</span></span>

<span data-ttu-id="251f8-107">Затем обе реализации сервера и обработчика должны вызывать функцию [**кожетстдмаршалекс**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetstdmarshalex) .</span><span class="sxs-lookup"><span data-stu-id="251f8-107">Next, both the server and handler implementations must call the [**CoGetStdMarshalEx**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetstdmarshalex) function.</span></span> <span data-ttu-id="251f8-108">Эта функция создает стандартный модуль упаковки на каждой стороне (который называется диспетчером прокси-сервера на стороне клиента и диспетчером заглушек на стороне сервера).</span><span class="sxs-lookup"><span data-stu-id="251f8-108">This function creates a standard marshaler on each side (called a proxy manager on the client side and a stub manager on the server side).</span></span>

<span data-ttu-id="251f8-109">Сервер вызывает [**кожетстдмаршалекс**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetstdmarshalex), передавая серверу флаг смексф \_ .</span><span class="sxs-lookup"><span data-stu-id="251f8-109">The server calls [**CoGetStdMarshalEx**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetstdmarshalex), passing in the flag SMEXF\_SERVER.</span></span> <span data-ttu-id="251f8-110">Это приведет к созданию стандартного модуля упаковки (диспетчера заглушек) на стороне сервера.</span><span class="sxs-lookup"><span data-stu-id="251f8-110">This creates a server-side standard marshaler (stub manager).</span></span> <span data-ttu-id="251f8-111">Структура на стороне сервера показана на следующем рисунке:</span><span class="sxs-lookup"><span data-stu-id="251f8-111">The server-side structure is shown in the following illustration:</span></span>

![Схема, на которой показана структура на стороне сервера.](images/b47b3bc0-3e7d-4be4-9767-7ae436bd1b21.png)

## <a name="server-side-structure"></a><span data-ttu-id="251f8-113">Структура Server-Side</span><span class="sxs-lookup"><span data-stu-id="251f8-113">Server-Side Structure</span></span>

<span data-ttu-id="251f8-114">Обработчик вызывает [**кожетстдмаршалекс**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetstdmarshalex), передавая обработчику флага смексф \_ .</span><span class="sxs-lookup"><span data-stu-id="251f8-114">The handler calls [**CoGetStdMarshalEx**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetstdmarshalex), passing in the flag SMEXF\_HANDLER.</span></span> <span data-ttu-id="251f8-115">Это создает клиентский модуль упаковки (прокси-диспетчер) на стороне клиента и объединяет его с обработчиком на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="251f8-115">This creates a client-side standard marshaler (proxy manager) and aggregates it with the handler on the client side.</span></span> <span data-ttu-id="251f8-116">Время существования обоих объектов управляется управляющим объектом Identity (реализующим [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown)), который реализуется системой, когда обработчик вызывает **кожетстдмаршалекс**.</span><span class="sxs-lookup"><span data-stu-id="251f8-116">The lifetime of both are managed by the controlling identity object (implementing [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown)) that the system implements when the handler calls **CoGetStdMarshalEx**.</span></span> <span data-ttu-id="251f8-117">Структура на стороне клиента показана на следующем рисунке.</span><span class="sxs-lookup"><span data-stu-id="251f8-117">The client-side structure is shown in the following illustration.</span></span>

![Схема, на которой показана структура на стороне клиента.](images/24ae70ef-dfa8-4784-90ac-dc6cfb043ee5.png)

## <a name="client-side-structure"></a><span data-ttu-id="251f8-119">Структура Client-Side</span><span class="sxs-lookup"><span data-stu-id="251f8-119">Client-Side Structure</span></span>

<span data-ttu-id="251f8-120">Как показано на предыдущем рисунке, обработчик на самом деле Южны между диспетчером прокси-сервера и идентификатором и контролем неизвестных данных.</span><span class="sxs-lookup"><span data-stu-id="251f8-120">As shown in the preceding illustration, the handler is actually sandwiched between the proxy manager and the identity/controlling unknown.</span></span> <span data-ttu-id="251f8-121">Это дает системному элементу управления время существования объекта при предоставлении управления обработчиком для предоставляемых интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="251f8-121">This gives the system control over the lifetime of the object while giving the handler control over the exposed interfaces.</span></span> <span data-ttu-id="251f8-122">Пунктирная линия между диспетчером удостоверений и прокси-сервера указывает на то, что две тесные интеграции через внутренние частные интерфейсы.</span><span class="sxs-lookup"><span data-stu-id="251f8-122">The dashed line between the Identity and Proxy Manager indicates that the two share tight integration through internal private interfaces.</span></span>

<span data-ttu-id="251f8-123">Когда COM вызывает [**каунмаршалинтерфаце**](/windows/desktop/api/combaseapi/nf-combaseapi-counmarshalinterface) для клиента, он создает экземпляр обработчика и выполняет его статистическую обработку с удостоверением.</span><span class="sxs-lookup"><span data-stu-id="251f8-123">When COM calls [**CoUnmarshalInterface**](/windows/desktop/api/combaseapi/nf-combaseapi-counmarshalinterface) for the client, it creates the handler instance, aggregating it with the Identity.</span></span> <span data-ttu-id="251f8-124">Обработчик создаст стандартный модуль упаковки (через вызов [**кожетстдмаршалекс**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetstdmarshalex), передав ему неизвестный при создании элемент управления.)</span><span class="sxs-lookup"><span data-stu-id="251f8-124">The handler will create the standard marshaler (through the call to [**CoGetStdMarshalEx**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetstdmarshalex), passing in the controlling unknown it received when it was created).</span></span> <span data-ttu-id="251f8-125">Обработчик не реализует [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal) , но просто возвращает **IMarshal** из стандартного модуля упаковки.</span><span class="sxs-lookup"><span data-stu-id="251f8-125">The handler does not implement [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal) but just returns **IMarshal** from the standard marshaler.</span></span> <span data-ttu-id="251f8-126">Даже если обработчик реализует **IMarshal**, он не будет вызываться во время распаковки.</span><span class="sxs-lookup"><span data-stu-id="251f8-126">Even if the handler does implement **IMarshal**, it will not get called during an unmarshal.</span></span>

<span data-ttu-id="251f8-127">Если два потока одновременно демаршалируются один и тот же объект в первый раз, можно временно создать два обработчика.</span><span class="sxs-lookup"><span data-stu-id="251f8-127">If two threads simultaneously unmarshal the same object for the first time, it is possible for two handlers to get created temporarily.</span></span> <span data-ttu-id="251f8-128">Затем один из них будет освобожден.</span><span class="sxs-lookup"><span data-stu-id="251f8-128">One will subsequently be released.</span></span>

## <a name="related-topics"></a><span data-ttu-id="251f8-129">См. также</span><span class="sxs-lookup"><span data-stu-id="251f8-129">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="251f8-130">Упрощенный обработчик Client-Side</span><span class="sxs-lookup"><span data-stu-id="251f8-130">The Lightweight Client-Side Handler</span></span>](the-lightweight-client-side-handler.md)
</dt> </dl>

 

 