---
title: Реализация и активация обработчика с дополнительными данными, предоставляемыми сервером
description: Реализация и активация обработчика с дополнительными данными, предоставляемыми сервером
ms.assetid: 5bbf81bd-430d-4008-b1cc-9ea91bb3b1e7
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: db78a3e39c85c37c52dfa3f09ef41f0a71b5f431
ms.sourcegitcommit: d39e82e232f6510f843fdb8d55d25b4e9e02e880
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "104350865"
---
# <a name="implementing-and-activating-a-handler-with-extra-data-supplied-by-server"></a><span data-ttu-id="d152c-103">Реализация и активация обработчика с дополнительными данными, предоставляемыми сервером</span><span class="sxs-lookup"><span data-stu-id="d152c-103">Implementing and Activating a Handler with Extra Data Supplied by Server</span></span>

<span data-ttu-id="d152c-104">Если сервер хочет включить в пакет некоторые дополнительные данные для использования обработчика, на сервере должны быть реализованы интерфейсы [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal) и [**истдмаршалинфо**](/windows/win32/api/objidlbase/nn-objidlbase-istdmarshalinfo) .</span><span class="sxs-lookup"><span data-stu-id="d152c-104">If the server wants to include some extra data in the packet for the handler to use, the server must implement both the [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal) and the [**IStdMarshalInfo**](/windows/win32/api/objidlbase/nn-objidlbase-istdmarshalinfo) interfaces.</span></span> <span data-ttu-id="d152c-105">Сервер должен выполнить статистическую обработку стандартного модуля упаковки и делегировать первую часть упаковки в агрегированный стандартный модуль упаковки, включая [**IMarshal:: жетунмаршалкласс**](/windows/desktop/api/ObjIdl/nf-objidl-imarshal-getunmarshalclass), и должен добавить свой собственный размер данных в размер, возвращенный [**IMarshal:: GetMarshalSizeMax**](/windows/desktop/api/ObjIdl/nf-objidl-imarshal-getmarshalsizemax)стандартного маршалером.</span><span class="sxs-lookup"><span data-stu-id="d152c-105">The server must aggregate the standard marshaler and must delegate the first part of the marshaling to the aggregated standard marshaler, including [**IMarshal::GetUnmarshalClass**](/windows/desktop/api/ObjIdl/nf-objidl-imarshal-getunmarshalclass), and must add its own data size to the size returned by the standard marshaler's [**IMarshal::GetMarshalSizeMax**](/windows/desktop/api/ObjIdl/nf-objidl-imarshal-getmarshalsizemax).</span></span> <span data-ttu-id="d152c-106">Стандартный модуль упаковки вызывает [**истдмаршалинфо:: жетклассфорхандлер**](/windows/win32/api/objidlbase/nf-objidlbase-istdmarshalinfo-getclassforhandler) , чтобы получить идентификатор CLSID создаваемого обработчика.</span><span class="sxs-lookup"><span data-stu-id="d152c-106">The standard marshaler calls [**IStdMarshalInfo::GetClassForHandler**](/windows/win32/api/objidlbase/nf-objidlbase-istdmarshalinfo-getclassforhandler) to get the CLSID of the handler to be created.</span></span> <span data-ttu-id="d152c-107">После завершения маршалирования стандартного модуля упаковки сервер записывает в поток собственные дополнительные данные.</span><span class="sxs-lookup"><span data-stu-id="d152c-107">After the standard marshaler has done its marshaling, the server then writes its own extra data into the stream.</span></span> <span data-ttu-id="d152c-108">Итоговые структуры с дополнительными данными в потоке показаны на следующем рисунке:</span><span class="sxs-lookup"><span data-stu-id="d152c-108">The resulting structures, with extra data in the stream, are shown in the following illustration:</span></span>

![Схема, в которой показаны структуры с дополнительными данными в потоке.](images/4cff306b-bb82-4c05-8e64-7ca73731f265.png)

## <a name="server-side-structures-with-extra-data-in-stream"></a><span data-ttu-id="d152c-110">Server-Side структур с дополнительными данными в потоке</span><span class="sxs-lookup"><span data-stu-id="d152c-110">Server-Side Structures with Extra Data in Stream</span></span>

<span data-ttu-id="d152c-111">Это позволяет вызову из COM [**каунмаршалинтерфаце**](/windows/desktop/api/combaseapi/nf-combaseapi-counmarshalinterface) на стороне клиента возможность пропустить все непрочитанные данные и оставить поток в соответствующей строке после всех данных упакованного интерфейса, если обработчик не может быть создан.</span><span class="sxs-lookup"><span data-stu-id="d152c-111">This allows the call from COM to [**CoUnmarshalInterface**](/windows/desktop/api/combaseapi/nf-combaseapi-counmarshalinterface) on the client side the ability to skip over any unread data and leave the stream in the appropriate position following all the marshaled interface data if the handler cannot be created.</span></span>

## <a name="client-side-structures-with-extra-data-in-stream"></a><span data-ttu-id="d152c-112">Client-Side структур с дополнительными данными в потоке</span><span class="sxs-lookup"><span data-stu-id="d152c-112">Client-Side Structures with Extra Data in Stream</span></span>

<span data-ttu-id="d152c-113">Как и в случае, когда в потоке нет дополнительных данных сервера, вызов COM на стороне клиента в [**каунмаршалинтерфаце**](/windows/desktop/api/combaseapi/nf-combaseapi-counmarshalinterface) создаст удостоверение и обработчик.</span><span class="sxs-lookup"><span data-stu-id="d152c-113">As in the case where there is no extra server data in the stream, the client-side COM call to [**CoUnmarshalInterface**](/windows/desktop/api/combaseapi/nf-combaseapi-counmarshalinterface) will create the identity and handler.</span></span> <span data-ttu-id="d152c-114">Обработчик должен реализовать [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal) и должен сначала делегировать вызовы **IMarshal** агрегированному стандартному маршалеру, а затем маршалировать или распаковать любые дополнительные данные, предоставленные сервером.</span><span class="sxs-lookup"><span data-stu-id="d152c-114">The handler must implement [**IMarshal**](/windows/win32/api/objidlbase/nn-objidlbase-imarshal) and must delegate the **IMarshal** calls to the aggregated standard marshaler first and then marshal or unmarshal any extra data that the server provided.</span></span> <span data-ttu-id="d152c-115">[**Унмаршалинтерфаце**](/windows/win32/api/objidlbase/nf-objidlbase-imarshal-unmarshalinterface) обработчика будет вызываться для каждого распаковки, независимо от того, был ли он размаршалирован перед или нет.</span><span class="sxs-lookup"><span data-stu-id="d152c-115">The handler's [**UnmarshalInterface**](/windows/win32/api/objidlbase/nf-objidlbase-imarshal-unmarshalinterface) will be called for every unmarshal, regardless of whether it has unmarshaled the interface before or not.</span></span> <span data-ttu-id="d152c-116">В этом случае сервер не вызывает [**кожетстдмаршалекс**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetstdmarshalex) , но обработчик должен.</span><span class="sxs-lookup"><span data-stu-id="d152c-116">In this case, the server does not call [**CoGetStdMarshalEx**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetstdmarshalex) but the handler must.</span></span> <span data-ttu-id="d152c-117">Итоговая структура на стороне клиента показана на следующем рисунке.</span><span class="sxs-lookup"><span data-stu-id="d152c-117">The resulting client-side structure is shown in the following illustration.</span></span>

![Схема, на которой показана структура на стороне клиента.](images/053411c7-9d54-4ae5-bcb6-778454b1d86f.png)

## <a name="related-topics"></a><span data-ttu-id="d152c-119">См. также</span><span class="sxs-lookup"><span data-stu-id="d152c-119">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="d152c-120">Упрощенный обработчик Client-Side</span><span class="sxs-lookup"><span data-stu-id="d152c-120">The Lightweight Client-Side Handler</span></span>](the-lightweight-client-side-handler.md)
</dt> </dl>

 

 