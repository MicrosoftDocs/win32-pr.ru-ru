---
description: CNG предоставляет модель для хранения закрытых ключей, которая позволяет адаптироваться к текущим и будущим потребностям создания приложений, использующих криптографические функции, такие как шифрование с открытым или закрытым ключом, а также требования к хранению материала ключа.
ms.assetid: 95e5750f-fdc5-41f3-a4ce-9593a7081e95
title: Хранение ключей и их получение
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5abfd6319353440c580d53990075a71613a1eba9
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104347755"
---
# <a name="key-storage-and-retrieval"></a><span data-ttu-id="ce1d5-103">Хранение ключей и их получение</span><span class="sxs-lookup"><span data-stu-id="ce1d5-103">Key Storage and Retrieval</span></span>

-   [<span data-ttu-id="ce1d5-104">Архитектура хранилища ключей</span><span class="sxs-lookup"><span data-stu-id="ce1d5-104">Key Storage Architecture</span></span>](#key-storage-architecture)
-   [<span data-ttu-id="ce1d5-105">Типы ключей</span><span class="sxs-lookup"><span data-stu-id="ce1d5-105">Key Types</span></span>](#key-types)
-   [<span data-ttu-id="ce1d5-106">Поддерживаемые алгоритмы</span><span class="sxs-lookup"><span data-stu-id="ce1d5-106">Supported Algorithms</span></span>](#supported-algorithms)
-   [<span data-ttu-id="ce1d5-107">Ключевые каталоги и файлы</span><span class="sxs-lookup"><span data-stu-id="ce1d5-107">Key Directories and Files</span></span>](#key-directories-and-files)

## <a name="key-storage-architecture"></a><span data-ttu-id="ce1d5-108">Архитектура хранилища ключей</span><span class="sxs-lookup"><span data-stu-id="ce1d5-108">Key Storage Architecture</span></span>

<span data-ttu-id="ce1d5-109">CNG предоставляет модель для хранения закрытых ключей, которая позволяет адаптироваться к текущим и будущим потребностям создания приложений, использующих криптографические функции, такие как шифрование с открытым или закрытым ключом, а также требования к хранению материала ключа.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-109">CNG provides a model for private key storage that allows adapting to the current and future demands of creating applications that use cryptography features such as public or private key encryption, as well as the demands of the storage of key material.</span></span> <span data-ttu-id="ce1d5-110">Основной подпрограммы в этой модели является маршрутизатор хранилища ключей и реализован в Ncrypt.dll.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-110">The key storage router is the central routine in this model and is implemented in Ncrypt.dll.</span></span> <span data-ttu-id="ce1d5-111">Приложение обращается к поставщикам хранилища ключей (KSP) в системе через маршрутизатор хранилища ключей, который скрывает сведения, такие как изоляция ключей, от приложения и самого поставщика хранилища.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-111">An application accesses the key storage providers (KSPs) on the system through the key storage router, which conceals details, such as key isolation, from both the application and the storage provider itself.</span></span> <span data-ttu-id="ce1d5-112">На следующем рисунке показана структура и функция архитектуры изоляции ключей CNG.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-112">The following illustration shows the design and function of the CNG key isolation architecture.</span></span>

![поставщик хранилища ключей CNG](images/cng-key-storage-provider.png)

<span data-ttu-id="ce1d5-114">Чтобы обеспечить соответствие требованиям общих критериев (CC), долгосрочные ключи должны быть изолированы, чтобы они никогда не присутствовали в процессе приложения.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-114">To comply with common criteria (CC) requirements, the long-lived keys must be isolated so that they are never present in the application process.</span></span> <span data-ttu-id="ce1d5-115">В настоящее время CNG поддерживает хранение асимметричных закрытых ключей с помощью программного средства Microsoft Software provider, которое входит в состав Windows Server 2008 и Windows Vista и устанавливается по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-115">CNG currently supports the storage of asymmetric private keys by using the Microsoft software KSP that is included with Windows Server 2008 and Windows Vista and installed by default.</span></span>

<span data-ttu-id="ce1d5-116">Изоляция ключей включена по умолчанию в Windows Server 2008 и Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-116">Key isolation is enabled by default in Windows Server 2008 and Windows Vista.</span></span> <span data-ttu-id="ce1d5-117">Функция изоляции ключей недоступна на платформах, предшествовавших этих.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-117">The key isolation feature is not available on platforms prior to these.</span></span> <span data-ttu-id="ce1d5-118">Кроме того, сторонние KSP не загружаются в службу изоляции ключей (LSA Process).</span><span class="sxs-lookup"><span data-stu-id="ce1d5-118">Also, third party KSPs are not loaded in the key isolation service (LSA process).</span></span> <span data-ttu-id="ce1d5-119">В службу изоляции ключей загружается только KSP Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-119">Only the Microsoft KSP is loaded in the key isolation service.</span></span>

<span data-ttu-id="ce1d5-120">Процесс LSA используется в качестве изоляции ключей для повышения производительности.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-120">The LSA process is used as the key isolation process to maximize performance.</span></span> <span data-ttu-id="ce1d5-121">Все права доступа к закрытым ключам проходят через маршрутизатор хранилища ключей, который предоставляет исчерпывающий набор функций для управления и использования закрытых ключей.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-121">All access to private keys goes through the key storage router, which exposes a comprehensive set of functions for managing and using private keys.</span></span>

<span data-ttu-id="ce1d5-122">CNG сохраняет открытую часть хранимого ключа отдельно от закрытой части.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-122">CNG stores the public portion of the stored key separately from the private portion.</span></span> <span data-ttu-id="ce1d5-123">Открытая часть пары ключей также поддерживается в службе изоляции ключей и доступна с помощью локального удаленного вызова процедур (ЛРПК).</span><span class="sxs-lookup"><span data-stu-id="ce1d5-123">The public portion of a key pair is also maintained in the key isolation service and is accessed by using local remote procedure call (LRPC).</span></span> <span data-ttu-id="ce1d5-124">Маршрутизатор хранилища ключей использует ЛРПК при вызове процесса изоляции ключей.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-124">The key storage router uses LRPC when calling into the key isolation process.</span></span> <span data-ttu-id="ce1d5-125">Все права доступа к закрытым ключам проходят через маршрутизатор закрытого ключа и проходят аудит с помощью CNG.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-125">All access to private keys goes through the private key router and is audited by CNG.</span></span>

<span data-ttu-id="ce1d5-126">Как описано выше, можно поддерживать широкий спектр устройств хранения оборудования.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-126">As described above, a wide range of hardware storage devices can be supported.</span></span> <span data-ttu-id="ce1d5-127">В каждом случае интерфейс для всех этих устройств хранения идентичен.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-127">In each case, the interface to all of these storage devices is identical.</span></span> <span data-ttu-id="ce1d5-128">Она включает функции для выполнения различных операций с закрытым ключом, а также функции, относящиеся к хранению и управлению ключами.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-128">It includes functions to perform various private key operations as well as functions that pertain to key storage and management.</span></span>

<span data-ttu-id="ce1d5-129">CNG предоставляет набор интерфейсов API, которые используются для создания, хранения и извлечения криптографических ключей.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-129">CNG provides a set of APIs that are used to create, store, and retrieve cryptographic keys.</span></span> <span data-ttu-id="ce1d5-130">Список этих API-интерфейсов см. в разделе [функции хранилища ключей CNG](cng-key-storage-functions.md).</span><span class="sxs-lookup"><span data-stu-id="ce1d5-130">For a list of these APIs, see [CNG Key Storage Functions](cng-key-storage-functions.md).</span></span>

## <a name="key-types"></a><span data-ttu-id="ce1d5-131">Типы ключей</span><span class="sxs-lookup"><span data-stu-id="ce1d5-131">Key Types</span></span>

<span data-ttu-id="ce1d5-132">CNG поддерживает следующие типы ключей:</span><span class="sxs-lookup"><span data-stu-id="ce1d5-132">CNG supports the following key types:</span></span>

-   <span data-ttu-id="ce1d5-133">Diffie-Hellman открытые и закрытые ключи.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-133">Diffie-Hellman public and private keys.</span></span>
-   <span data-ttu-id="ce1d5-134">Открытый и закрытый ключи алгоритма цифровых подписей (DSA, FIPS 186-2).</span><span class="sxs-lookup"><span data-stu-id="ce1d5-134">Digital Signature Algorithm (DSA, FIPS 186-2) public and private keys.</span></span>
-   <span data-ttu-id="ce1d5-135">\#Открытые и закрытые ключи RSA (PKCS 1).</span><span class="sxs-lookup"><span data-stu-id="ce1d5-135">RSA (PKCS \#1) public and private keys.</span></span>
-   <span data-ttu-id="ce1d5-136">Несколько устаревших открытых и закрытых ключей CryptoAPI.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-136">Several legacy (CryptoAPI) public and private keys.</span></span>
-   <span data-ttu-id="ce1d5-137">Открытые и закрытые ключи шифрования на основе эллиптических кривых.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-137">Elliptic Curve Cryptography public and private keys.</span></span>

## <a name="supported-algorithms"></a><span data-ttu-id="ce1d5-138">Поддерживаемые алгоритмы</span><span class="sxs-lookup"><span data-stu-id="ce1d5-138">Supported Algorithms</span></span>

<span data-ttu-id="ce1d5-139">CNG поддерживает следующие алгоритмы ключей.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-139">CNG supports the following key algorithms.</span></span>

| <span data-ttu-id="ce1d5-140">Алгоритм</span><span class="sxs-lookup"><span data-stu-id="ce1d5-140">Algorithm</span></span> | <span data-ttu-id="ce1d5-141">Длина ключа или хэша (бит)</span><span class="sxs-lookup"><span data-stu-id="ce1d5-141">Key/hash length (bits)</span></span>             |
|-----------|------------------------------------|
| <span data-ttu-id="ce1d5-142">RSA</span><span class="sxs-lookup"><span data-stu-id="ce1d5-142">RSA</span></span>       | <span data-ttu-id="ce1d5-143">от 512 до 16384, с шагом в 64 бит</span><span class="sxs-lookup"><span data-stu-id="ce1d5-143">512 to 16384, in 64 bit increments</span></span> |
| <span data-ttu-id="ce1d5-144">ХЕЛМАНА</span><span class="sxs-lookup"><span data-stu-id="ce1d5-144">DH</span></span>        | <span data-ttu-id="ce1d5-145">от 512 до 16384, с шагом в 64 бит</span><span class="sxs-lookup"><span data-stu-id="ce1d5-145">512 to 16384, in 64 bit increments</span></span> |
| <span data-ttu-id="ce1d5-146">DSA</span><span class="sxs-lookup"><span data-stu-id="ce1d5-146">DSA</span></span>       | <span data-ttu-id="ce1d5-147">от 512 до 1024, с шагом в 64 бит</span><span class="sxs-lookup"><span data-stu-id="ce1d5-147">512 to 1024, in 64 bit increments</span></span>  |
| <span data-ttu-id="ce1d5-148">ECDSA</span><span class="sxs-lookup"><span data-stu-id="ce1d5-148">ECDSA</span></span>     | <span data-ttu-id="ce1d5-149">P-256, P-384, P-521 (NIST)</span><span class="sxs-lookup"><span data-stu-id="ce1d5-149">P-256, P-384, P-521 (NIST Curves)</span></span>  |
| <span data-ttu-id="ce1d5-150">ECDH</span><span class="sxs-lookup"><span data-stu-id="ce1d5-150">ECDH</span></span>      | <span data-ttu-id="ce1d5-151">P-256, P-384, P-521 (NIST)</span><span class="sxs-lookup"><span data-stu-id="ce1d5-151">P-256, P-384, P-521 (NIST Curves)</span></span>  |
| <span data-ttu-id="ce1d5-152">MD2</span><span class="sxs-lookup"><span data-stu-id="ce1d5-152">MD2</span></span>       | <span data-ttu-id="ce1d5-153">128</span><span class="sxs-lookup"><span data-stu-id="ce1d5-153">128</span></span>                                |
| <span data-ttu-id="ce1d5-154">MD4</span><span class="sxs-lookup"><span data-stu-id="ce1d5-154">MD4</span></span>       | <span data-ttu-id="ce1d5-155">128</span><span class="sxs-lookup"><span data-stu-id="ce1d5-155">128</span></span>                                |
| <span data-ttu-id="ce1d5-156">MD5</span><span class="sxs-lookup"><span data-stu-id="ce1d5-156">MD5</span></span>       | <span data-ttu-id="ce1d5-157">128</span><span class="sxs-lookup"><span data-stu-id="ce1d5-157">128</span></span>                                |
| <span data-ttu-id="ce1d5-158">SHA-1</span><span class="sxs-lookup"><span data-stu-id="ce1d5-158">SHA-1</span></span>     | <span data-ttu-id="ce1d5-159">160</span><span class="sxs-lookup"><span data-stu-id="ce1d5-159">160</span></span>                                |
| <span data-ttu-id="ce1d5-160">SHA-256</span><span class="sxs-lookup"><span data-stu-id="ce1d5-160">SHA-256</span></span>   | <span data-ttu-id="ce1d5-161">256</span><span class="sxs-lookup"><span data-stu-id="ce1d5-161">256</span></span>                                |
| <span data-ttu-id="ce1d5-162">SHA-384</span><span class="sxs-lookup"><span data-stu-id="ce1d5-162">SHA-384</span></span>   | <span data-ttu-id="ce1d5-163">384</span><span class="sxs-lookup"><span data-stu-id="ce1d5-163">384</span></span>                                |
| <span data-ttu-id="ce1d5-164">SHA-512</span><span class="sxs-lookup"><span data-stu-id="ce1d5-164">SHA-512</span></span>   | <span data-ttu-id="ce1d5-165">512</span><span class="sxs-lookup"><span data-stu-id="ce1d5-165">512</span></span>                                |



 

## <a name="key-directories-and-files"></a><span data-ttu-id="ce1d5-166">Ключевые каталоги и файлы</span><span class="sxs-lookup"><span data-stu-id="ce1d5-166">Key Directories and Files</span></span>

<span data-ttu-id="ce1d5-167">В службах Microsoft Legacy CryptoAPI CSP хранятся закрытые ключи в следующих каталогах.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-167">The Microsoft legacy CryptoAPI CSPs store private keys in the following directories.</span></span>

| <span data-ttu-id="ce1d5-168">Тип ключа</span><span class="sxs-lookup"><span data-stu-id="ce1d5-168">Key type</span></span>                | <span data-ttu-id="ce1d5-169">Каталоги</span><span class="sxs-lookup"><span data-stu-id="ce1d5-169">Directories</span></span>                                                                                                                                                 |
|-------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="ce1d5-170">Частный пользователь</span><span class="sxs-lookup"><span data-stu-id="ce1d5-170">User private</span></span>            | <span data-ttu-id="ce1d5-171">% APPDATA% \\ \\ \\ \\ *идентификатор безопасности пользователя* Microsoft Crypto RSA</span><span class="sxs-lookup"><span data-stu-id="ce1d5-171">%APPDATA%\\Microsoft\\Crypto\\RSA\\*User SID*</span></span>\\<br/><span data-ttu-id="ce1d5-172">% APPDATA% \\ \\ \\ \\ *идентификатор безопасности пользователя* Microsoft Crypto DSS</span><span class="sxs-lookup"><span data-stu-id="ce1d5-172">%APPDATA%\\Microsoft\\Crypto\\DSS\\*User SID*</span></span>\\<br/>                                                   |
| <span data-ttu-id="ce1d5-173">Частная локальная система</span><span class="sxs-lookup"><span data-stu-id="ce1d5-173">Local system private</span></span>    | <span data-ttu-id="ce1d5-174">% ALLUSERSPROFILE% \\ Application Data \\ \\ \\ RSA \\ S-1-5-18</span><span class="sxs-lookup"><span data-stu-id="ce1d5-174">%ALLUSERSPROFILE%\\Application Data\\Microsoft\\Crypto\\RSA\\S-1-5-18</span></span>\\<br/><span data-ttu-id="ce1d5-175">% ALLUSERSPROFILE% \\ данных приложений \\ Microsoft \\ Crypto \\ DSS \\ S — 1-5-18</span><span class="sxs-lookup"><span data-stu-id="ce1d5-175">%ALLUSERSPROFILE%\\Application Data\\Microsoft\\Crypto\\DSS\\S-1-5-18</span></span>\\<br/>   |
| <span data-ttu-id="ce1d5-176">Частная локальная служба</span><span class="sxs-lookup"><span data-stu-id="ce1d5-176">Local service private</span></span>   | <span data-ttu-id="ce1d5-177">% ALLUSERSPROFILE% \\ Application Data \\ \\ \\ RSA \\ S-1-5-19</span><span class="sxs-lookup"><span data-stu-id="ce1d5-177">%ALLUSERSPROFILE%\\Application Data\\Microsoft\\Crypto\\RSA\\S-1-5-19</span></span>\\<br/><span data-ttu-id="ce1d5-178">% ALLUSERSPROFILE% \\ данных приложений \\ Microsoft \\ Crypto \\ DSS \\ S — 1-5-19</span><span class="sxs-lookup"><span data-stu-id="ce1d5-178">%ALLUSERSPROFILE%\\Application Data\\Microsoft\\Crypto\\DSS\\S-1-5-19</span></span>\\<br/>   |
| <span data-ttu-id="ce1d5-179">Частная сетевая служба</span><span class="sxs-lookup"><span data-stu-id="ce1d5-179">Network service private</span></span> | <span data-ttu-id="ce1d5-180">% ALLUSERSPROFILE% \\ Application Data \\ \\ \\ RSA \\ S-1-5-20</span><span class="sxs-lookup"><span data-stu-id="ce1d5-180">%ALLUSERSPROFILE%\\Application Data\\Microsoft\\Crypto\\RSA\\S-1-5-20</span></span>\\<br/><span data-ttu-id="ce1d5-181">% ALLUSERSPROFILE% \\ данных приложений \\ Microsoft \\ Crypto \\ DSS \\ S — 1-5-20</span><span class="sxs-lookup"><span data-stu-id="ce1d5-181">%ALLUSERSPROFILE%\\Application Data\\Microsoft\\Crypto\\DSS\\S-1-5-20</span></span>\\<br/>   |
| <span data-ttu-id="ce1d5-182">Общий закрытый</span><span class="sxs-lookup"><span data-stu-id="ce1d5-182">Shared private</span></span>          | <span data-ttu-id="ce1d5-183">% ALLUSERSPROFILE% \\ данных приложений \\ Microsoft \\ Crypto \\ RSA \\ MachineKeys</span><span class="sxs-lookup"><span data-stu-id="ce1d5-183">%ALLUSERSPROFILE%\\Application Data\\Microsoft\\Crypto\\RSA\\MachineKeys</span></span><br/><span data-ttu-id="ce1d5-184">% ALLUSERSPROFILE% \\ данных приложений \\ Microsoft \\ Crypto \\ DSS \\ MachineKeys</span><span class="sxs-lookup"><span data-stu-id="ce1d5-184">%ALLUSERSPROFILE%\\Application Data\\Microsoft\\Crypto\\DSS\\MachineKeys</span></span><br/> |



 

<span data-ttu-id="ce1d5-185">CNG хранит закрытые ключи в следующих каталогах.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-185">CNG stores private keys in the following directories.</span></span>

| <span data-ttu-id="ce1d5-186">Тип ключа</span><span class="sxs-lookup"><span data-stu-id="ce1d5-186">Key type</span></span>                | <span data-ttu-id="ce1d5-187">Каталог</span><span class="sxs-lookup"><span data-stu-id="ce1d5-187">Directory</span></span>                                                          |
|-------------------------|--------------------------------------------------------------------|
| <span data-ttu-id="ce1d5-188">Частный пользователь</span><span class="sxs-lookup"><span data-stu-id="ce1d5-188">User private</span></span>            | <span data-ttu-id="ce1d5-189">% APPDATA% \\ \\ криптографические \\ ключи Майкрософт</span><span class="sxs-lookup"><span data-stu-id="ce1d5-189">%APPDATA%\\Microsoft\\Crypto\\Keys</span></span>                                 |
| <span data-ttu-id="ce1d5-190">Частная локальная система</span><span class="sxs-lookup"><span data-stu-id="ce1d5-190">Local system private</span></span>    | <span data-ttu-id="ce1d5-191">% ALLUSERSPROFILE% \\ Application Data \\ Майкрософт \\ \\ системкэйс</span><span class="sxs-lookup"><span data-stu-id="ce1d5-191">%ALLUSERSPROFILE%\\Application Data\\Microsoft\\Crypto\\SystemKeys</span></span> |
| <span data-ttu-id="ce1d5-192">Частная локальная служба</span><span class="sxs-lookup"><span data-stu-id="ce1d5-192">Local service private</span></span>   | <span data-ttu-id="ce1d5-193">% WINDIR% \\ сервицепрофилес \\ LocalService</span><span class="sxs-lookup"><span data-stu-id="ce1d5-193">%WINDIR%\\ServiceProfiles\\LocalService</span></span>                            |
| <span data-ttu-id="ce1d5-194">Частная сетевая служба</span><span class="sxs-lookup"><span data-stu-id="ce1d5-194">Network service private</span></span> | <span data-ttu-id="ce1d5-195">% WINDIR% \\ сервицепрофилес \\ NetworkService</span><span class="sxs-lookup"><span data-stu-id="ce1d5-195">%WINDIR%\\ServiceProfiles\\NetworkService</span></span>                          |
| <span data-ttu-id="ce1d5-196">Общий закрытый</span><span class="sxs-lookup"><span data-stu-id="ce1d5-196">Shared private</span></span>          | <span data-ttu-id="ce1d5-197">% ALLUSERSPROFILE% \\ Application Data \\ \\ ключи шифрования \\ Майкрософт</span><span class="sxs-lookup"><span data-stu-id="ce1d5-197">%ALLUSERSPROFILE%\\Application Data\\Microsoft\\Crypto\\Keys</span></span>       |



 

<span data-ttu-id="ce1d5-198">Ниже приведены некоторые различия между контейнерами CryptoAPI и CNG.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-198">The following are some of the differences between the CryptoAPI and CNG key containers.</span></span>

-   <span data-ttu-id="ce1d5-199">CNG использует разные имена файлов ключей по сравнению с файлами ключей, созданными Rsaenh.dll и Dssenh.dll устаревших CSP.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-199">CNG uses different file names for key files than key files that are created by the Rsaenh.dll and Dssenh.dll legacy CSPs.</span></span> <span data-ttu-id="ce1d5-200">Устаревшие файлы ключей также имеют расширение. key, но файлы ключей CNG не имеют расширения. key.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-200">The legacy key files also have the .key extension, but CNG key files do not have the .key extension.</span></span>
-   <span data-ttu-id="ce1d5-201">CNG полностью поддерживает имена контейнеров ключей Юникода. CNG использует хэш имени контейнера в Юникоде, тогда как CryptoAPI использует хэш имени контейнера в формате ANSI.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-201">CNG fully supports Unicode key container names; CNG uses a hash of the Unicode container name, whereas CryptoAPI uses a hash of the ANSI container name.</span></span>
-   <span data-ttu-id="ce1d5-202">CNG является более гибкой с точки зрения пар ключей RSA.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-202">CNG is more flexible with regard to RSA key pairs.</span></span> <span data-ttu-id="ce1d5-203">Например, CNG поддерживает общедоступные экспоненты размером более 32 бит и поддерживает ключи, в которых p и q имеют разную длину.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-203">For example, CNG supports public exponents larger than 32-bits in length, and it supports keys in which p and q are different lengths.</span></span>
-   <span data-ttu-id="ce1d5-204">В CryptoAPI файл контейнера ключей хранится в каталоге, имя которого является текстовым эквивалентом идентификатора безопасности пользователя.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-204">In CryptoAPI, the key container file is stored in a directory whose name is the textual equivalent of the user's SID.</span></span> <span data-ttu-id="ce1d5-205">Это больше не так в CNG, что устраняет трудности при перемещении пользователей из одного домена в другой без потери их закрытых ключей.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-205">This is no longer the case in CNG, which removes the difficulty of moving users from one domain to another without losing all of their private keys.</span></span>
-   <span data-ttu-id="ce1d5-206">Имя поставщика хранилища CNG и имена ключей ограничены **максимальным числом \_** символов Юникода.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-206">The CNG KSP and key names are limited to **MAX\_PATH** Unicode characters.</span></span> <span data-ttu-id="ce1d5-207">Имя поставщика службы CryptoAPI и имена ключей ограничены **максимальным числом \_** символов ANSI.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-207">The CryptoAPI CSP and key names are limited to **MAX\_PATH** ANSI characters.</span></span>
-   <span data-ttu-id="ce1d5-208">CNG предлагает возможности определяемых пользователем ключевых свойств.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-208">CNG offers the capability of user-defined key properties.</span></span> <span data-ttu-id="ce1d5-209">Пользователи могут создавать и связывать пользовательские свойства с ключами и хранить их с постоянными ключами.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-209">Users can create and associate custom properties with keys, and have them stored with persisted keys.</span></span>

<span data-ttu-id="ce1d5-210">При сохранении ключа CNG может создать два файла.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-210">When persisting a key, CNG can create two files.</span></span> <span data-ttu-id="ce1d5-211">Первый файл содержит закрытый ключ в новом формате CNG и всегда создается.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-211">The first file contains the private key in the new CNG format and is always created.</span></span> <span data-ttu-id="ce1d5-212">Этот файл не может использоваться устаревшими CSP CryptoAPI.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-212">This file is not usable by the legacy CryptoAPI CSPs.</span></span> <span data-ttu-id="ce1d5-213">Второй файл содержит тот же закрытый ключ в старом контейнере ключей CryptoAPI.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-213">The second file contains the same private key in the legacy CryptoAPI key container.</span></span> <span data-ttu-id="ce1d5-214">Второй файл соответствует формату и расположению, используемому Rsaenh.dll.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-214">The second file conforms to the format and location used by Rsaenh.dll.</span></span> <span data-ttu-id="ce1d5-215">Создание второго файла происходит только в том случае, если при вызове функции [**нкриптфинализекэй**](/windows/desktop/api/Ncrypt/nf-ncrypt-ncryptfinalizekey) для завершения ключа RSA был задан флаг **NCRYPT \_ записи \_ в флаг \_ \_ \_ \_ отметки хранилища прежних версий** .</span><span class="sxs-lookup"><span data-stu-id="ce1d5-215">Creation of the second file only occurs if the **NCRYPT\_WRITE\_KEY\_TO\_LEGACY\_STORE\_FLAG** flag is specified when the [**NCryptFinalizeKey**](/windows/desktop/api/Ncrypt/nf-ncrypt-ncryptfinalizekey) function is called to finalize an RSA key.</span></span> <span data-ttu-id="ce1d5-216">Эта функция не поддерживается для ключей DSA и DH.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-216">This feature is not supported for DSA and DH keys.</span></span>

<span data-ttu-id="ce1d5-217">Когда приложение пытается открыть существующий постоянный ключ, CNG сначала пытается открыть собственный файл CNG.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-217">When an application attempts to open an existing persisted key, CNG first attempts to open the native CNG file.</span></span> <span data-ttu-id="ce1d5-218">Если этот файл не существует, CNG пытается нахождение совпадающего ключа в устаревшем контейнере ключей CryptoAPI.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-218">If this file does not exist, then CNG attempts to locate a matching key in the legacy CryptoAPI key container.</span></span>

<span data-ttu-id="ce1d5-219">При перемещении или копировании ключей CryptoAPI с исходного компьютера на целевой компьютер с помощью средство миграции пользовательской среды Windows (USMT) CNG не сможет получить доступ к ключам на целевом компьютере.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-219">When you move or copy CryptoAPI keys from a source machine to a target machine with Windows User State Migration Tool (USMT), CNG will fail to access the keys on the target machine.</span></span> <span data-ttu-id="ce1d5-220">Для доступа к таким переносимым ключам необходимо использовать интерфейс CryptoAPI.</span><span class="sxs-lookup"><span data-stu-id="ce1d5-220">To access such migrated keys, you must use the CryptoAPI.</span></span>

 

 




