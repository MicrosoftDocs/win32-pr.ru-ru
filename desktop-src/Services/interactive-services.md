---
description: Обычно службы — это консольные приложения, предназначенные для автоматического запуска без графического пользовательского интерфейса.
ms.assetid: 3d6e090a-00b1-47d8-a4fb-620f3db8ba9c
title: Интерактивные службы
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 57dda3018b4b37e8c5ee56d67cd1db2c56da9b67
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103912228"
---
# <a name="interactive-services"></a>Интерактивные службы

Обычно службы — это консольные приложения, предназначенные для автоматического запуска без графического пользовательского интерфейса. Однако некоторым службам может потребоваться случайное взаимодействие с пользователем. На этой странице обсуждаются лучшие способы взаимодействия с пользователем из службы.

> [!IMPORTANT]
> Службы не могут напрямую взаимодействовать с пользователем в Windows Vista. Поэтому методы, упомянутые в разделе Использование интерактивной службы, не должны использоваться в новом коде.

 

## <a name="interacting-with-a-user-from-a-service-indirectly"></a>Взаимодействие с пользователем из службы косвенно

Для взаимодействия с пользователем из службы во всех поддерживаемых версиях Windows можно использовать следующие методы:

-   Отображение диалогового окна в сеансе пользователя с помощью функции [**втссендмессаже**](/windows/desktop/api/wtsapi32/nf-wtsapi32-wtssendmessagea) .
-   Создайте отдельное скрытое приложение GUI и используйте функцию [**параметр CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) для запуска приложения в контексте интерактивного пользователя. Разработайте приложение GUI для взаимодействия со службой с помощью какого-либо метода межпроцессного взаимодействия (IPC), например именованных каналов. Служба взаимодействует с приложением GUI, чтобы сообщить ему о том, когда следует отображать графический интерфейс пользователя. Приложение передает результаты взаимодействия пользователя обратно в службу, чтобы служба могла предпринять соответствующие действия. Обратите внимание, что IPC может предоставлять интерфейсы службы по сети, если не используется соответствующий список управления доступом (ACL).

    Если эта служба работает в многопользовательской системе, добавьте приложение в следующий раздел, чтобы он выполнялся в каждом сеансе: **hKey \_ Local \_ Machine \\ Software \\ Microsoft \\ Windows \\ CurrentVersion \\ Run**. Если приложение использует именованные каналы для IPC, сервер может различать несколько пользовательских процессов, присваивая каждому каналу уникальное имя на основе идентификатора сеанса.

Для Windows Server 2003 и Windows XP также доступен следующий метод:

-   Отобразите окно сообщения, вызвав функцию [**MessageBox**](/windows/win32/api/winuser/nf-winuser-messagebox) с **\_ \_ уведомлением о службе (МБ**). Это рекомендуется для отображения простых сообщений о состоянии. Не вызывайте **MessageBox** во время инициализации службы или из подпрограммы [**хандлерекс**](/windows/desktop/api/WinSvc/nc-winsvc-lphandler_function_ex) , если она не вызвана из отдельного потока, чтобы своевременно возвращаться к SCM.

## <a name="using-an-interactive-service"></a>Использование интерактивной службы

По умолчанию службы используют неинтерактивную [станцию окон](/windows/desktop/winstation/window-stations) и не могут взаимодействовать с пользователем. Однако *интерактивная служба* может отображать пользовательский интерфейс и принимать вводимые пользователем данные.

> [!Caution]  
> Службы, работающие в контексте безопасности с повышенными правами, например учетная запись LocalSystem, не должны создавать окно на интерактивном рабочем столе, так как любое другое приложение, работающее на интерактивном рабочем столе, может взаимодействовать с этим окном. Это обеспечивает доступ к службе любому приложению, которое выполняет вошедший в систему пользователь. Кроме того, службы, работающие под учетной записью LocalSystem, не должны получать доступ к интерактивному рабочему столу путем вызова функции [**опенвиндовстатион**](/windows/desktop/api/winuser/nf-winuser-openwindowstationa) или [**жетсреаддесктоп**](/windows/desktop/api/winuser/nf-winuser-getthreaddesktop) .

 

Чтобы создать интерактивную службу, выполните следующие действия при вызове функции [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) :

1.  Укажите значение NULL для параметра *лпсервицестартнаме* , чтобы запустить службу в контексте [учетной записи LocalSystem](localsystem-account.md).
2.  Укажите флаг **\_ интерактивного \_ процесса службы** .

Чтобы определить, работает ли служба как интерактивная служба, вызовите функцию [**жетпроцессвиндовстатион**](/windows/desktop/api/winuser/nf-winuser-getprocesswindowstation) для получения маркера на оконную станцию, а функцию [**жетусеробжектинформатион**](/windows/desktop/api/winuser/nf-winuser-getuserobjectinformationa) — для проверки того, имеет ли станция окна атрибут **\_ Visible** .

Однако обратите внимание, что следующий раздел реестра содержит значение **параметра nointeractiveservices**, которое управляет результатом \_ интерактивного \_ процесса службы:

**\_ \_ \\ \\ \\ Окна системного управления CurrentControlSet \\ локального компьютера hKey**

Значение **параметра nointeractiveservices** по умолчанию равно 1. Это означает, что ни одна служба не может выполняться в интерактивном режиме, независимо от того, есть ли у нее автономный **\_ \_ процесс службы**. Если для **параметра nointeractiveservices** задано значение 0, службы с **\_ интерактивным \_ процессом службы** могут работать в интерактивном режиме.

**Windows 7, Windows server 2008 R2, Windows XP и Windows server 2003:** Значение **параметра nointeractiveservices** по умолчанию равно 0. Это означает, что службы **с \_ интерактивным \_ процессом службы** разрешено запускать в режиме «в работе». Если для **параметра nointeractiveservices** задано ненулевое значение, служба не будет запущена в интерактивном режиме, независимо от того, есть ли у нее **\_ интерактивная \_ Обработка**.

> [!IMPORTANT]
> Все службы выполняются в сеансе 0 служб терминалов. Таким образом, если интерактивная служба отображает пользовательский интерфейс, она отображается только для пользователя, который подключился к сеансу 0. Поскольку нет способа гарантировать, что интерактивный пользователь подключен к сеансу 0, не следует настраивать службу для запуска в качестве интерактивной службы в службах терминалов или в системе, которая поддерживает быстрое переключение пользователей (быстрое переключение пользователей реализуется с помощью служб терминалов).

 

 

 
