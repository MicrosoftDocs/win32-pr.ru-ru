---
description: Обычно службы — это консольные приложения, предназначенные для автоматического запуска без графического пользовательского интерфейса.
ms.assetid: 3d6e090a-00b1-47d8-a4fb-620f3db8ba9c
title: Интерактивные службы
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 57dda3018b4b37e8c5ee56d67cd1db2c56da9b67
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103912228"
---
# <a name="interactive-services"></a><span data-ttu-id="661a2-103">Интерактивные службы</span><span class="sxs-lookup"><span data-stu-id="661a2-103">Interactive Services</span></span>

<span data-ttu-id="661a2-104">Обычно службы — это консольные приложения, предназначенные для автоматического запуска без графического пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="661a2-104">Typically, services are console applications that are designed to run unattended without a graphical user interface (GUI).</span></span> <span data-ttu-id="661a2-105">Однако некоторым службам может потребоваться случайное взаимодействие с пользователем.</span><span class="sxs-lookup"><span data-stu-id="661a2-105">However, some services may require occasional interaction with a user.</span></span> <span data-ttu-id="661a2-106">На этой странице обсуждаются лучшие способы взаимодействия с пользователем из службы.</span><span class="sxs-lookup"><span data-stu-id="661a2-106">This page discusses the best ways to interact with the user from a service.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="661a2-107">Службы не могут напрямую взаимодействовать с пользователем в Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="661a2-107">Services cannot directly interact with a user as of Windows Vista.</span></span> <span data-ttu-id="661a2-108">Поэтому методы, упомянутые в разделе Использование интерактивной службы, не должны использоваться в новом коде.</span><span class="sxs-lookup"><span data-stu-id="661a2-108">Therefore, the techniques mentioned in the section titled Using an Interactive Service should not be used in new code.</span></span>

 

## <a name="interacting-with-a-user-from-a-service-indirectly"></a><span data-ttu-id="661a2-109">Взаимодействие с пользователем из службы косвенно</span><span class="sxs-lookup"><span data-stu-id="661a2-109">Interacting with a User from a Service Indirectly</span></span>

<span data-ttu-id="661a2-110">Для взаимодействия с пользователем из службы во всех поддерживаемых версиях Windows можно использовать следующие методы:</span><span class="sxs-lookup"><span data-stu-id="661a2-110">You can use the following techniques to interact with the user from a service on all supported versions of Windows:</span></span>

-   <span data-ttu-id="661a2-111">Отображение диалогового окна в сеансе пользователя с помощью функции [**втссендмессаже**](/windows/desktop/api/wtsapi32/nf-wtsapi32-wtssendmessagea) .</span><span class="sxs-lookup"><span data-stu-id="661a2-111">Display a dialog box in the user's session using the [**WTSSendMessage**](/windows/desktop/api/wtsapi32/nf-wtsapi32-wtssendmessagea) function.</span></span>
-   <span data-ttu-id="661a2-112">Создайте отдельное скрытое приложение GUI и используйте функцию [**параметр CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) для запуска приложения в контексте интерактивного пользователя.</span><span class="sxs-lookup"><span data-stu-id="661a2-112">Create a separate hidden GUI application and use the [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) function to run the application within the context of the interactive user.</span></span> <span data-ttu-id="661a2-113">Разработайте приложение GUI для взаимодействия со службой с помощью какого-либо метода межпроцессного взаимодействия (IPC), например именованных каналов.</span><span class="sxs-lookup"><span data-stu-id="661a2-113">Design the GUI application to communicate with the service through some method of interprocess communication (IPC), for example, named pipes.</span></span> <span data-ttu-id="661a2-114">Служба взаимодействует с приложением GUI, чтобы сообщить ему о том, когда следует отображать графический интерфейс пользователя.</span><span class="sxs-lookup"><span data-stu-id="661a2-114">The service communicates with the GUI application to tell it when to display the GUI.</span></span> <span data-ttu-id="661a2-115">Приложение передает результаты взаимодействия пользователя обратно в службу, чтобы служба могла предпринять соответствующие действия.</span><span class="sxs-lookup"><span data-stu-id="661a2-115">The application communicates the results of the user interaction back to the service so that the service can take the appropriate action.</span></span> <span data-ttu-id="661a2-116">Обратите внимание, что IPC может предоставлять интерфейсы службы по сети, если не используется соответствующий список управления доступом (ACL).</span><span class="sxs-lookup"><span data-stu-id="661a2-116">Note that IPC can expose your service interfaces over the network unless you use an appropriate access control list (ACL).</span></span>

    <span data-ttu-id="661a2-117">Если эта служба работает в многопользовательской системе, добавьте приложение в следующий раздел, чтобы он выполнялся в каждом сеансе: **hKey \_ Local \_ Machine \\ Software \\ Microsoft \\ Windows \\ CurrentVersion \\ Run**.</span><span class="sxs-lookup"><span data-stu-id="661a2-117">If this service runs on a multiuser system, add the application to the following key so that it is run in each session: **HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run**.</span></span> <span data-ttu-id="661a2-118">Если приложение использует именованные каналы для IPC, сервер может различать несколько пользовательских процессов, присваивая каждому каналу уникальное имя на основе идентификатора сеанса.</span><span class="sxs-lookup"><span data-stu-id="661a2-118">If the application uses named pipes for IPC, the server can distinguish between multiple user processes by giving each pipe a unique name based on the session ID.</span></span>

<span data-ttu-id="661a2-119">Для Windows Server 2003 и Windows XP также доступен следующий метод:</span><span class="sxs-lookup"><span data-stu-id="661a2-119">The following technique is also available for Windows Server 2003 and Windows XP:</span></span>

-   <span data-ttu-id="661a2-120">Отобразите окно сообщения, вызвав функцию [**MessageBox**](/windows/win32/api/winuser/nf-winuser-messagebox) с **\_ \_ уведомлением о службе (МБ**).</span><span class="sxs-lookup"><span data-stu-id="661a2-120">Display a message box by calling the [**MessageBox**](/windows/win32/api/winuser/nf-winuser-messagebox) function with **MB\_SERVICE\_NOTIFICATION**.</span></span> <span data-ttu-id="661a2-121">Это рекомендуется для отображения простых сообщений о состоянии.</span><span class="sxs-lookup"><span data-stu-id="661a2-121">This is recommended for displaying simple status messages.</span></span> <span data-ttu-id="661a2-122">Не вызывайте **MessageBox** во время инициализации службы или из подпрограммы [**хандлерекс**](/windows/desktop/api/WinSvc/nc-winsvc-lphandler_function_ex) , если она не вызвана из отдельного потока, чтобы своевременно возвращаться к SCM.</span><span class="sxs-lookup"><span data-stu-id="661a2-122">Do not call **MessageBox** during service initialization or from the [**HandlerEx**](/windows/desktop/api/WinSvc/nc-winsvc-lphandler_function_ex) routine, unless you call it from a separate thread, so that you return to the SCM in a timely manner.</span></span>

## <a name="using-an-interactive-service"></a><span data-ttu-id="661a2-123">Использование интерактивной службы</span><span class="sxs-lookup"><span data-stu-id="661a2-123">Using an Interactive Service</span></span>

<span data-ttu-id="661a2-124">По умолчанию службы используют неинтерактивную [станцию окон](/windows/desktop/winstation/window-stations) и не могут взаимодействовать с пользователем.</span><span class="sxs-lookup"><span data-stu-id="661a2-124">By default, services use a noninteractive [window station](/windows/desktop/winstation/window-stations) and cannot interact with the user.</span></span> <span data-ttu-id="661a2-125">Однако *интерактивная служба* может отображать пользовательский интерфейс и принимать вводимые пользователем данные.</span><span class="sxs-lookup"><span data-stu-id="661a2-125">However, an *interactive service* can display a user interface and receive user input.</span></span>

> [!Caution]  
> <span data-ttu-id="661a2-126">Службы, работающие в контексте безопасности с повышенными правами, например учетная запись LocalSystem, не должны создавать окно на интерактивном рабочем столе, так как любое другое приложение, работающее на интерактивном рабочем столе, может взаимодействовать с этим окном.</span><span class="sxs-lookup"><span data-stu-id="661a2-126">Services running in an elevated security context, such as the LocalSystem account, should not create a window on the interactive desktop because any other application that is running on the interactive desktop can interact with this window.</span></span> <span data-ttu-id="661a2-127">Это обеспечивает доступ к службе любому приложению, которое выполняет вошедший в систему пользователь.</span><span class="sxs-lookup"><span data-stu-id="661a2-127">This exposes the service to any application that a logged-on user executes.</span></span> <span data-ttu-id="661a2-128">Кроме того, службы, работающие под учетной записью LocalSystem, не должны получать доступ к интерактивному рабочему столу путем вызова функции [**опенвиндовстатион**](/windows/desktop/api/winuser/nf-winuser-openwindowstationa) или [**жетсреаддесктоп**](/windows/desktop/api/winuser/nf-winuser-getthreaddesktop) .</span><span class="sxs-lookup"><span data-stu-id="661a2-128">Also, services that are running as LocalSystem should not access the interactive desktop by calling the [**OpenWindowStation**](/windows/desktop/api/winuser/nf-winuser-openwindowstationa) or [**GetThreadDesktop**](/windows/desktop/api/winuser/nf-winuser-getthreaddesktop) function.</span></span>

 

<span data-ttu-id="661a2-129">Чтобы создать интерактивную службу, выполните следующие действия при вызове функции [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) :</span><span class="sxs-lookup"><span data-stu-id="661a2-129">To create an interactive service, do the following when calling the [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) function:</span></span>

1.  <span data-ttu-id="661a2-130">Укажите значение NULL для параметра *лпсервицестартнаме* , чтобы запустить службу в контексте [учетной записи LocalSystem](localsystem-account.md).</span><span class="sxs-lookup"><span data-stu-id="661a2-130">Specify NULL for the *lpServiceStartName* parameter to run the service in the context of the [LocalSystem account](localsystem-account.md).</span></span>
2.  <span data-ttu-id="661a2-131">Укажите флаг **\_ интерактивного \_ процесса службы** .</span><span class="sxs-lookup"><span data-stu-id="661a2-131">Specify the **SERVICE\_INTERACTIVE\_PROCESS** flag.</span></span>

<span data-ttu-id="661a2-132">Чтобы определить, работает ли служба как интерактивная служба, вызовите функцию [**жетпроцессвиндовстатион**](/windows/desktop/api/winuser/nf-winuser-getprocesswindowstation) для получения маркера на оконную станцию, а функцию [**жетусеробжектинформатион**](/windows/desktop/api/winuser/nf-winuser-getuserobjectinformationa) — для проверки того, имеет ли станция окна атрибут **\_ Visible** .</span><span class="sxs-lookup"><span data-stu-id="661a2-132">To determine whether a service is running as an interactive service, call the [**GetProcessWindowStation**](/windows/desktop/api/winuser/nf-winuser-getprocesswindowstation) function to retrieve a handle to the window station, and the [**GetUserObjectInformation**](/windows/desktop/api/winuser/nf-winuser-getuserobjectinformationa) function to test whether the window station has the **WSF\_VISIBLE** attribute.</span></span>

<span data-ttu-id="661a2-133">Однако обратите внимание, что следующий раздел реестра содержит значение **параметра nointeractiveservices**, которое управляет результатом \_ интерактивного \_ процесса службы:</span><span class="sxs-lookup"><span data-stu-id="661a2-133">However, note that the following registry key contains a value, **NoInteractiveServices**, that controls the effect of SERVICE\_INTERACTIVE\_PROCESS:</span></span>

<span data-ttu-id="661a2-134">**\_ \_ \\ \\ \\ Окна системного управления CurrentControlSet \\ локального компьютера hKey**</span><span class="sxs-lookup"><span data-stu-id="661a2-134">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Windows**</span></span>

<span data-ttu-id="661a2-135">Значение **параметра nointeractiveservices** по умолчанию равно 1. Это означает, что ни одна служба не может выполняться в интерактивном режиме, независимо от того, есть ли у нее автономный **\_ \_ процесс службы**.</span><span class="sxs-lookup"><span data-stu-id="661a2-135">The **NoInteractiveServices** value defaults to 1, which means that no service is allowed to run interactively, regardless of whether it has **SERVICE\_INTERACTIVE\_PROCESS**.</span></span> <span data-ttu-id="661a2-136">Если для **параметра nointeractiveservices** задано значение 0, службы с **\_ интерактивным \_ процессом службы** могут работать в интерактивном режиме.</span><span class="sxs-lookup"><span data-stu-id="661a2-136">When **NoInteractiveServices** is set to a 0, services with **SERVICE\_INTERACTIVE\_PROCESS** are allowed to run interactively.</span></span>

<span data-ttu-id="661a2-137">**Windows 7, Windows server 2008 R2, Windows XP и Windows server 2003:** Значение **параметра nointeractiveservices** по умолчанию равно 0. Это означает, что службы **с \_ интерактивным \_ процессом службы** разрешено запускать в режиме «в работе».</span><span class="sxs-lookup"><span data-stu-id="661a2-137">**Windows 7, Windows Server 2008 R2, Windows XP and Windows Server 2003:** The **NoInteractiveServices** value defaults to 0, which means that services with **SERVICE\_INTERACTIVE\_PROCESS** are allowed to run interactively.</span></span> <span data-ttu-id="661a2-138">Если для **параметра nointeractiveservices** задано ненулевое значение, служба не будет запущена в интерактивном режиме, независимо от того, есть ли у нее **\_ интерактивная \_ Обработка**.</span><span class="sxs-lookup"><span data-stu-id="661a2-138">When **NoInteractiveServices** is set to a nonzero value, no service started thereafter is allowed to run interactively, regardless of whether it has **SERVICE\_INTERACTIVE\_PROCESS**.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="661a2-139">Все службы выполняются в сеансе 0 служб терминалов.</span><span class="sxs-lookup"><span data-stu-id="661a2-139">All services run in Terminal Services session 0.</span></span> <span data-ttu-id="661a2-140">Таким образом, если интерактивная служба отображает пользовательский интерфейс, она отображается только для пользователя, который подключился к сеансу 0.</span><span class="sxs-lookup"><span data-stu-id="661a2-140">Therefore, if an interactive service displays a user interface, it is visible only to the user who connected to session 0.</span></span> <span data-ttu-id="661a2-141">Поскольку нет способа гарантировать, что интерактивный пользователь подключен к сеансу 0, не следует настраивать службу для запуска в качестве интерактивной службы в службах терминалов или в системе, которая поддерживает быстрое переключение пользователей (быстрое переключение пользователей реализуется с помощью служб терминалов).</span><span class="sxs-lookup"><span data-stu-id="661a2-141">Because there is no way to guarantee that the interactive user is connected to session 0, do not configure a service to run as an interactive service under Terminal Services or on a system that supports fast user switching (fast user switching is implemented using Terminal Services).</span></span>

 

 

 
