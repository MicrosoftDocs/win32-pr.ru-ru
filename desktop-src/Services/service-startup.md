---
description: Чтобы запустить службу или службу драйвера, программа управления службами использует функцию StartService.
ms.assetid: 7d2ee779-1554-436a-a65c-f0322745f46a
title: Запуск службы
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0f5fcd9ee820357e75bf07649da8e6c5445d3f42
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105664370"
---
# <a name="service-startup"></a><span data-ttu-id="3997c-103">Запуск службы</span><span class="sxs-lookup"><span data-stu-id="3997c-103">Service Startup</span></span>

<span data-ttu-id="3997c-104">Чтобы запустить службу или службу драйвера, программа управления службами использует функцию [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) .</span><span class="sxs-lookup"><span data-stu-id="3997c-104">To start a service or driver service, the service control program uses the [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) function.</span></span> <span data-ttu-id="3997c-105">Функция **StartService** завершается ошибкой, если база данных заблокирована.</span><span class="sxs-lookup"><span data-stu-id="3997c-105">The **StartService** function fails if the database is locked.</span></span> <span data-ttu-id="3997c-106">В этом случае программа управления службой должна подождать несколько секунд и вызвать функцию **StartService** еще раз.</span><span class="sxs-lookup"><span data-stu-id="3997c-106">If this occurs, the service control program should wait a few seconds and call **StartService** again.</span></span> <span data-ttu-id="3997c-107">Он может проверить текущее состояние блокировки базы данных, вызвав функцию [**куерисервицелоккстатус**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicelockstatusa) .</span><span class="sxs-lookup"><span data-stu-id="3997c-107">It can check the current lock status of the database by calling the [**QueryServiceLockStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicelockstatusa) function.</span></span>

<span data-ttu-id="3997c-108">Если программа управления службами запускает службу, она может использовать функцию [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) для указания массива аргументов, передаваемых в функцию [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) службы.</span><span class="sxs-lookup"><span data-stu-id="3997c-108">If the service control program is starting a service, it can use the [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) function to specify an array of arguments to be passed to the service's [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function.</span></span> <span data-ttu-id="3997c-109">Функция **StartService** возвращает после создания нового потока для выполнения функции **ServiceMain** .</span><span class="sxs-lookup"><span data-stu-id="3997c-109">The **StartService** function returns after a new thread is created to execute the **ServiceMain** function.</span></span> <span data-ttu-id="3997c-110">Программа управления службами может получить состояние недавно запущенной службы в структуре [**\_ состояния службы**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) , вызвав функцию [**куерисервицестатус**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) .</span><span class="sxs-lookup"><span data-stu-id="3997c-110">The service control program can retrieve the status of the newly started service in a [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure by calling the [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) function.</span></span> <span data-ttu-id="3997c-111">Во время инициализации элемент **двкуррентстате** должен находиться \_ \_ в состоянии ожидания запуска службы.</span><span class="sxs-lookup"><span data-stu-id="3997c-111">During initialization, the **dwCurrentState** member should be SERVICE\_START\_PENDING.</span></span> <span data-ttu-id="3997c-112">Элемент **двваисинт** — это интервал времени в миллисекундах, указывающий, как долго программа управления службами должна ожидать перед вызовом **куерисервицестатус** .</span><span class="sxs-lookup"><span data-stu-id="3997c-112">The **dwWaitHint** member is a time interval, in milliseconds, that indicates how long the service control program should wait before calling **QueryServiceStatus** again.</span></span> <span data-ttu-id="3997c-113">Когда инициализация завершится, служба изменится **двкуррентстате** на "Служба \_ запущена".</span><span class="sxs-lookup"><span data-stu-id="3997c-113">When the initialization is complete, the service changes **dwCurrentState** to SERVICE\_RUNNING.</span></span>

<span data-ttu-id="3997c-114">Диспетчер управления службами не поддерживает передачу пользовательских переменных среды в службу при запуске.</span><span class="sxs-lookup"><span data-stu-id="3997c-114">The service control manager does not support passing custom environment variables to a service at startup.</span></span> <span data-ttu-id="3997c-115">Кроме того, диспетчер управления службами не обнаруживает и не передает изменения переменных среды, так как служба выполняется.</span><span class="sxs-lookup"><span data-stu-id="3997c-115">Also, the service control manager does not detect and pass on changes to environment variables as the service is running.</span></span> <span data-ttu-id="3997c-116">Вместо того, чтобы сделать службу зависимой от переменной среды, используйте значения реестра или аргументы [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) .</span><span class="sxs-lookup"><span data-stu-id="3997c-116">Instead of making a service dependent on an environment variable, use registry values or [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) arguments.</span></span>

<span data-ttu-id="3997c-117">Ниже приведен упрощенный обзор того, что происходит при запуске обычной службы диспетчером управления службами.</span><span class="sxs-lookup"><span data-stu-id="3997c-117">The following is a simplified overview of what happens when a typical service is started by the service control manager:</span></span>

-   <span data-ttu-id="3997c-118">SCM считывает путь службы из реестра и готовится к запуску службы.</span><span class="sxs-lookup"><span data-stu-id="3997c-118">The SCM reads the service path from the registry and prepares to start the service.</span></span> <span data-ttu-id="3997c-119">Это включает в себя получение блокировки службы.</span><span class="sxs-lookup"><span data-stu-id="3997c-119">This includes acquiring the service lock.</span></span> <span data-ttu-id="3997c-120">Любая попытка запуска другой службы во время удержания блокировки службы будет заблокирована до тех пор, пока не будет снята блокировка службы.</span><span class="sxs-lookup"><span data-stu-id="3997c-120">Any attempt to start another service while the service lock is held will block until the service lock is released.</span></span>
-   <span data-ttu-id="3997c-121">SCM запускает процесс и ожидает, пока не завершится завершение работы дочернего процесса (что указывает на сбой), или сообщает о \_ состоянии запуска службы.</span><span class="sxs-lookup"><span data-stu-id="3997c-121">The SCM starts the process and waits until either the child process exits (indicating a failure) or reports the SERVICE\_RUNNING status.</span></span>
-   <span data-ttu-id="3997c-122">Приложение выполняет очень простую инициализацию и вызывает функцию [**сбой StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) .</span><span class="sxs-lookup"><span data-stu-id="3997c-122">The application performs its very simple initialization and calls the [**StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) function.</span></span>
-   <span data-ttu-id="3997c-123">[**Сбой StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) подключается к диспетчеру управления службами и запускает второй поток, который вызывает функцию [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) для службы.</span><span class="sxs-lookup"><span data-stu-id="3997c-123">[**StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) connects to the service control manager and starts a second thread that calls the [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function for the service.</span></span> <span data-ttu-id="3997c-124">**ServiceMain** должен как можно быстрее сообщить о том, что служба \_ работает.</span><span class="sxs-lookup"><span data-stu-id="3997c-124">**ServiceMain** should report SERVICE\_RUNNING as soon as possible.</span></span>
-   <span data-ttu-id="3997c-125">Когда диспетчер управления службами уведомляется о том, что служба запущена, она освобождает блокировку службы.</span><span class="sxs-lookup"><span data-stu-id="3997c-125">When the service control manager is notified that the service is running, it releases the service lock.</span></span>

<span data-ttu-id="3997c-126">Если служба не обновляет состояние в течение 80 секунд, а также Последнее указание Wait, диспетчер управления службами определит, что служба перестала отвечать на запросы.</span><span class="sxs-lookup"><span data-stu-id="3997c-126">If service does not update its status within 80 seconds, plus the last wait hint, the service control manager determines that the service has stopped responding.</span></span> <span data-ttu-id="3997c-127">Диспетчер управления службами регистрирует событие и останавливает службу.</span><span class="sxs-lookup"><span data-stu-id="3997c-127">The service control manager will log an event and stop the service.</span></span>

<span data-ttu-id="3997c-128">Если программа запускает службу драйвера, функция [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) возвращает значение после завершения инициализации драйвера устройства.</span><span class="sxs-lookup"><span data-stu-id="3997c-128">If the program is starting a driver service, [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) returns after the device driver has completed its initialization.</span></span>

<span data-ttu-id="3997c-129">Дополнительные сведения см. в разделе [Запуск службы](starting-a-service.md).</span><span class="sxs-lookup"><span data-stu-id="3997c-129">For more information, see [Starting a Service](starting-a-service.md).</span></span>

 

 
