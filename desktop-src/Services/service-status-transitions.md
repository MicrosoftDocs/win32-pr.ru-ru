---
description: Служба отвечает за отправку отчетов об изменениях состояния в диспетчер управления службами (SCM).
ms.assetid: 74a85730-6667-46fe-ae12-26561ccedb73
title: Переходы состояния службы
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8df7684b1ebc04aa1116b09a3ae4321f2552d7b6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104565406"
---
# <a name="service-state-transitions"></a><span data-ttu-id="76d70-103">Переходы состояния службы</span><span class="sxs-lookup"><span data-stu-id="76d70-103">Service State Transitions</span></span>

<span data-ttu-id="76d70-104">Служба отвечает за отправку отчетов об изменениях состояния в диспетчер управления службами (SCM).</span><span class="sxs-lookup"><span data-stu-id="76d70-104">A service is responsible for reporting changes in its state to the service control manager (SCM).</span></span> <span data-ttu-id="76d70-105">Программы управления службами и система могут определить состояние службы только из SCM, поэтому важно, чтобы служба правильно вымогла сообщить о своем состоянии.</span><span class="sxs-lookup"><span data-stu-id="76d70-105">Service control programs and the system can find out the state of a service only from the SCM, so it is important that a service report its state correctly.</span></span> <span data-ttu-id="76d70-106">Служба сообщает свое состояние, вызывая функцию [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) с указателем на полностью инициализированную структуру [**\_ состояния службы**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="76d70-106">A service reports its state by calling the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function with a pointer to a fully initialized [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="76d70-107">Элемент **двкуррентстате** структуры содержит состояние службы, которое необходимо сообщить.</span><span class="sxs-lookup"><span data-stu-id="76d70-107">The **dwCurrentState** member of the structure contains the service state to be reported.</span></span>

<span data-ttu-id="76d70-108">Начальное состояние службы — "Служба \_ остановлена".</span><span class="sxs-lookup"><span data-stu-id="76d70-108">The initial state of a service is SERVICE\_STOPPED.</span></span> <span data-ttu-id="76d70-109">Когда SCM запускает службу, он устанавливает для состояния службы значение \_ Ожидание запуска службы \_ и вызывает функцию [*ServiceMain*](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) службы.</span><span class="sxs-lookup"><span data-stu-id="76d70-109">When the SCM starts the service, it sets the service state to SERVICE\_START\_PENDING and calls the service's [*ServiceMain*](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function.</span></span> <span data-ttu-id="76d70-110">Затем служба завершает свою инициализацию, используя один из методов, описанных в разделе [Service ServiceMain Function](service-servicemain-function.md).</span><span class="sxs-lookup"><span data-stu-id="76d70-110">The service then completes its initialization using one of the techniques described in [Service ServiceMain Function](service-servicemain-function.md).</span></span> <span data-ttu-id="76d70-111">После того как служба завершит свою инициализацию и готова начать получение управляющих запросов, служба вызывает [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) для службы отчетов \_ и указывает управляющие запросы, которые служба готова принять.</span><span class="sxs-lookup"><span data-stu-id="76d70-111">After the service completes its initialization and is ready to start receiving control requests, the service calls [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to report SERVICE\_RUNNING and specify the control requests the service is prepared to accept.</span></span> <span data-ttu-id="76d70-112">Переход от начала службы \_ в \_ ожидании службы \_ указывает на средства SCM и наблюдения за службами, которые были успешно запущены службой.</span><span class="sxs-lookup"><span data-stu-id="76d70-112">The transition from SERVICE\_START\_PENDING to SERVICE\_RUNNING indicates to the SCM and service-monitoring tools that the service has started successfully.</span></span> <span data-ttu-id="76d70-113">Если служба сообщает о состоянии, отличном от \_ запущенной службы, средства SCM или наблюдения за службами могут пометить службу как неудачную.</span><span class="sxs-lookup"><span data-stu-id="76d70-113">If the service reports a state other than SERVICE\_RUNNING, the SCM or service-monitoring tools might mark the service as having failed to start.</span></span>

<span data-ttu-id="76d70-114">SCM отправляет в службу только указанные управляющие запросы (за исключением \_ запроса на контроль службы \_ , который всегда отправляется).</span><span class="sxs-lookup"><span data-stu-id="76d70-114">The SCM sends only the specified control requests to the service (except for the SERVICE\_CONTROL\_INTERROGATE request, which is always sent).</span></span> <span data-ttu-id="76d70-115">Список запросов Control, которые может принять служба, см. в разделе **двконтролсакцептед** элемента структуры [**\_ состояния службы**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="76d70-115">For a list of the control requests that a service can accept, see the **dwControlsAccepted** member of the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="76d70-116">Сведения о регистрации для получения событий устройства см. в описании функции [**регистердевиценотификатион**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) .</span><span class="sxs-lookup"><span data-stu-id="76d70-116">For information about registering to receive device events, see the [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) function.</span></span>

<span data-ttu-id="76d70-117">Состояние службы обычно изменяется в результате обработки управляющего запроса.</span><span class="sxs-lookup"><span data-stu-id="76d70-117">The service state typically changes as a result of handling a control request.</span></span> <span data-ttu-id="76d70-118">Управляющие запросы, которые приводят к изменению состояния \_ службы \_ , включают остановку управления службами, \_ \_ приостановку управления службами, а также \_ продолжение управления службами \_ .</span><span class="sxs-lookup"><span data-stu-id="76d70-118">Control requests that cause the service state to change include SERVICE\_CONTROL\_STOP, SERVICE\_CONTROL\_PAUSE, and SERVICE\_CONTROL\_CONTINUE.</span></span> <span data-ttu-id="76d70-119">Если служба должна выполнить длительную обработку для обработки любого из этих запросов, она должна создать дополнительный поток для выполнения длительной обработки и сообщить соответствующему состоянию ожидания в SCM.</span><span class="sxs-lookup"><span data-stu-id="76d70-119">If the service must do lengthy processing to handle any of these requests, it should create a secondary thread to perform the lengthy processing and report the corresponding pending state to the SCM.</span></span> <span data-ttu-id="76d70-120">(Для обеспечения лучшей производительности в Windows Vista и более поздних версиях Windows для этой цели служба должна использовать рабочий поток из [пула потоков](/windows/desktop/ProcThread/thread-pools) .) После завершения длительной обработки служба должна сообщить о завершенном переходе состояния.</span><span class="sxs-lookup"><span data-stu-id="76d70-120">(For best performance on Windows Vista and later versions of Windows, the service should use a worker thread from a [thread pool](/windows/desktop/ProcThread/thread-pools) for this purpose.) The service should then report the completed state transition when the lengthy processing is finished.</span></span> <span data-ttu-id="76d70-121">Дополнительные сведения об обработке управляющих запросов см. в разделе [функция обработчика управления службами](service-control-handler-function.md).</span><span class="sxs-lookup"><span data-stu-id="76d70-121">For more information about handling control requests, see [Service Control Handler Function](service-control-handler-function.md).</span></span>

<span data-ttu-id="76d70-122">Допустимы только определенные переходы состояния службы.</span><span class="sxs-lookup"><span data-stu-id="76d70-122">Only certain service state transitions are valid.</span></span> <span data-ttu-id="76d70-123">На следующей диаграмме показаны допустимые переходы.</span><span class="sxs-lookup"><span data-stu-id="76d70-123">The following diagram shows the valid transitions.</span></span>

![допустимые переходы состояния службы](images/service-status-transitions.png)

<span data-ttu-id="76d70-125">Состояние службы, сообщаемое SCM, определяет, как SCM взаимодействует со службой.</span><span class="sxs-lookup"><span data-stu-id="76d70-125">The service state reported to the SCM determines how the SCM interacts with the service.</span></span> <span data-ttu-id="76d70-126">Например, если служба сообщает о \_ \_ ожидании остановки службы, SCM не передает дальнейшие управляющие запросы службе, так как это состояние указывает на завершение работы службы.</span><span class="sxs-lookup"><span data-stu-id="76d70-126">For example, if a service reports SERVICE\_STOP\_PENDING, the SCM does not transmit further control requests to the service because this state indicates that the service is shutting down.</span></span> <span data-ttu-id="76d70-127">Следующее состояние, сообщаемое службой, должно быть \_ остановлено, так как это единственное допустимое состояние после \_ ожидания остановки службы \_ .</span><span class="sxs-lookup"><span data-stu-id="76d70-127">The next state reported by the service should be SERVICE\_STOPPED because that is the only valid state after SERVICE\_STOP\_PENDING.</span></span> <span data-ttu-id="76d70-128">Однако если служба сообщает о недействительном переходе, SCM не завершает вызов.</span><span class="sxs-lookup"><span data-stu-id="76d70-128">However, if a service reports a transition that is not valid, the SCM does not fail the call.</span></span>

<span data-ttu-id="76d70-129">На следующей диаграмме приведены более подробные сведения о переходах состояния службы, включая запросы элементов управления, инициированные программой управления службами (клиентом службы), и [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) вызовы, которые служба делает для передачи изменений состояния в SCM.</span><span class="sxs-lookup"><span data-stu-id="76d70-129">The following diagram shows service state transitions in more detail, including the control requests initiated by a service control program (the service client) and the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) calls that a service makes to report state changes to the SCM.</span></span> <span data-ttu-id="76d70-130">Как упоминалось ранее, SCM отправляет только управляющие запросы, которые она указала, поэтому служба может не получить все запросы, показанные на схеме.</span><span class="sxs-lookup"><span data-stu-id="76d70-130">As mentioned earlier, the SCM sends only control requests that the service has specified it will accept, so a service might not receive all of the requests shown in the diagram.</span></span>

![<span data-ttu-id="76d70-131">Подробности о переходах состояния службы</span><span class="sxs-lookup"><span data-stu-id="76d70-131">service status transitions in detail</span></span> ](images/service-status-flow-diagram.png)

## <a name="related-topics"></a><span data-ttu-id="76d70-132">См. также</span><span class="sxs-lookup"><span data-stu-id="76d70-132">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="76d70-133">**ControlService**</span><span class="sxs-lookup"><span data-stu-id="76d70-133">**ControlService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-controlservice)
</dt> <dt>

[<span data-ttu-id="76d70-134">**контролсервицеекс**</span><span class="sxs-lookup"><span data-stu-id="76d70-134">**ControlServiceEx**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-controlserviceexa)
</dt> <dt>

[<span data-ttu-id="76d70-135">**Сбой SetServiceStatus**</span><span class="sxs-lookup"><span data-stu-id="76d70-135">**SetServiceStatus**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus)
</dt> </dl>

 

 
