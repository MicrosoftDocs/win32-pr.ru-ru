---
description: Когда программа управления службой запрашивает выполнение новой службы, диспетчер управления службами (SCM) запускает службу и отправляет запрос на запуск диспетчеру управления.
ms.assetid: e55e056f-7628-4e3d-9aea-b55c371b4287
title: Функция ServiceMain службы
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ed50f0f378f348415e56827a09fcf17eea7fc330
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103999391"
---
# <a name="service-servicemain-function"></a><span data-ttu-id="ea4c4-103">Функция ServiceMain службы</span><span class="sxs-lookup"><span data-stu-id="ea4c4-103">Service ServiceMain Function</span></span>

<span data-ttu-id="ea4c4-104">Когда программа управления службой запрашивает выполнение новой службы, диспетчер управления службами (SCM) запускает службу и отправляет запрос на запуск диспетчеру управления.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-104">When a service control program requests that a new service run, the Service Control Manager (SCM) starts the service and sends a start request to the control dispatcher.</span></span> <span data-ttu-id="ea4c4-105">Диспетчер управления создает новый поток для выполнения функции [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) для службы.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-105">The control dispatcher creates a new thread to execute the [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function for the service.</span></span> <span data-ttu-id="ea4c4-106">Пример см. в разделе [написание функции ServiceMain](writing-a-servicemain-function.md).</span><span class="sxs-lookup"><span data-stu-id="ea4c4-106">For an example, see [Writing a ServiceMain Function](writing-a-servicemain-function.md).</span></span>

<span data-ttu-id="ea4c4-107">Функция [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) должна выполнять следующие задачи:</span><span class="sxs-lookup"><span data-stu-id="ea4c4-107">The [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function should perform the following tasks:</span></span>

1.  <span data-ttu-id="ea4c4-108">Инициализируйте все глобальные переменные.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-108">Initialize all global variables.</span></span>
2.  <span data-ttu-id="ea4c4-109">Немедленно вызовите функцию [**регистерсервицектрлхандлер**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) , чтобы зарегистрировать функцию [**обработчика**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) для обработки управляющих запросов для службы.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-109">Call the [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) function immediately to register a [**Handler**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) function to handle control requests for the service.</span></span> <span data-ttu-id="ea4c4-110">Возвращаемое значение **регистерсервицектрлхандлер** — это *обработчик состояния службы* , который будет использоваться в вызовах для уведомления SCM о состоянии службы.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-110">The return value of **RegisterServiceCtrlHandler** is a *service status handle* that will be used in calls to notify the SCM of the service status.</span></span>
3.  <span data-ttu-id="ea4c4-111">Выполните инициализацию.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-111">Perform initialization.</span></span> <span data-ttu-id="ea4c4-112">Если время выполнения кода инициализации должно быть очень коротким (менее одной секунды), инициализацию можно выполнить непосредственно в [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona).</span><span class="sxs-lookup"><span data-stu-id="ea4c4-112">If the execution time of the initialization code is expected to be very short (less than one second), initialization can be performed directly in [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona).</span></span>

    <span data-ttu-id="ea4c4-113">Если время инициализации должно быть длиннее одной секунды, служба должна использовать один из следующих методов инициализации:</span><span class="sxs-lookup"><span data-stu-id="ea4c4-113">If the initialization time is expected to be longer than one second, the service should use one of the following initialization techniques:</span></span>

    -   <span data-ttu-id="ea4c4-114">Вызовите функцию [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) , чтобы сообщить службе о запуске службы, \_ но не принимать элементы управления, пока не завершится инициализация.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-114">Call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function to report SERVICE\_RUNNING but accept no controls until initialization is finished.</span></span> <span data-ttu-id="ea4c4-115">Эта служба делает это, вызывая **сбой SetServiceStatus** с параметром **ДВКУРРЕНТСТАТЕ** , чтобы служба \_ выполнялась, а **двконтролсакцептед** — значение 0 в структуре [**\_ состояния службы**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="ea4c4-115">The service does this by calling **SetServiceStatus** with **dwCurrentState** set to SERVICE\_RUNNING and **dwControlsAccepted** set to 0 in the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="ea4c4-116">Это гарантирует, что SCM не будет отсылать управляющие запросы службе, прежде чем она будет готова и освободит SCM для управления другими службами.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-116">This ensures that the SCM will not send any control requests to the service before it is ready and frees the SCM to manage other services.</span></span> <span data-ttu-id="ea4c4-117">Этот подход к инициализации рекомендуется для повышения производительности, особенно для служб автозапуска.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-117">This approach to initialization is recommended for performance, especially for autostart services.</span></span>
    -   <span data-ttu-id="ea4c4-118">Служба отчетов \_ \_ ожидает запуска, не принимает элементы управления и укажите указание ожидания.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-118">Report SERVICE\_START\_PENDING, accept no controls, and specify a wait hint.</span></span> <span data-ttu-id="ea4c4-119">Если код инициализации службы выполняет задачи, которые должны занимать больше времени, чем начальное значение указания Wait, код должен периодически вызывать функцию [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) (возможно, с измененным указанием о дождитесь), чтобы указать, что выполняется.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-119">If your service's initialization code performs tasks that are expected to take longer than the initial wait hint value, your code must call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function periodically (possibly with a revised wait hint) to indicate that progress is being made.</span></span> <span data-ttu-id="ea4c4-120">Не забудьте вызвать **сбой SetServiceStatus** только в том случае, если инициализация продвигается.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-120">Be sure to call **SetServiceStatus** only if the initialization is making progress.</span></span> <span data-ttu-id="ea4c4-121">В противном случае SCM может ожидать перехода службы в \_ состояние выполнения, предполагая, что служба выполняется и блокирует запуск других служб.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-121">Otherwise the SCM can wait for your service to enter the SERVICE\_RUNNING state assuming that your service is making progress and block other services from starting.</span></span> <span data-ttu-id="ea4c4-122">Не вызывайте **сбой SetServiceStatus** из отдельного потока, если вы не уверены, что поток, выполняющий инициализацию, действительно делает ход выполнения.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-122">Do not call **SetServiceStatus** from a separate thread unless you are sure the thread performing the initialization is truly making progress.</span></span>

        <span data-ttu-id="ea4c4-123">Служба, использующая такой подход, также может задавать значение контрольной точки и периодически увеличивать значение при продолжительной инициализации.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-123">A service that uses this approach can also specify a check-point value and increment the value periodically during a lengthy initialization.</span></span> <span data-ttu-id="ea4c4-124">Программа, запускающая службу, может вызвать [**куерисервицестатус**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) или [**куерисервицестатусекс**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) , чтобы получить Последнее значение контрольной точки из SCM и использовать значение для передачи пользователю добавочного хода выполнения.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-124">The program that started the service can call [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) or [**QueryServiceStatusEx**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) to obtain the latest check-point value from the SCM and use the value to report incremental progress to the user.</span></span>

4.  <span data-ttu-id="ea4c4-125">По завершении инициализации вызовите [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) , чтобы настроить состояние службы на "Служба \_ запущена" и указать элементы управления, которые служба должна принять.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-125">When initialization is complete, call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_RUNNING and specify the controls that the service is prepared to accept.</span></span> <span data-ttu-id="ea4c4-126">Список элементов управления см. в разделе Структура [**\_ состояния службы**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="ea4c4-126">For a list of controls, see the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span>
5.  <span data-ttu-id="ea4c4-127">Выполните задачи службы или, если нет ожидающих задач, верните управление вызывающему объекту.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-127">Perform the service tasks, or, if there are no pending tasks, return control to the caller.</span></span> <span data-ttu-id="ea4c4-128">Любые изменения в состоянии службы гарантируют вызов [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) для сообщения о новых сведениях о состоянии.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-128">Any change in the service state warrants a call to [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to report new status information.</span></span>
6.  <span data-ttu-id="ea4c4-129">Если во время инициализации или запуска службы произошла ошибка, служба должна вызвать [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) , чтобы настроить состояние службы на \_ Ожидание службы, \_ Если очистка будет длительной.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-129">If an error occurs while the service is initializing or running, the service should call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_STOP\_PENDING if cleanup will be lengthy.</span></span> <span data-ttu-id="ea4c4-130">После завершения очистки вызовите **сбой SetServiceStatus** , чтобы установить состояние службы \_ остановлено с последнего потока для завершения.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-130">After cleanup is complete, call **SetServiceStatus** to set the service state to SERVICE\_STOPPED from the last thread to terminate.</span></span> <span data-ttu-id="ea4c4-131">Не забудьте задать члены **двсервицеспеЦифицекситкоде** и **DwWin32ExitCode** структуры [**\_ состояния службы**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) , чтобы определить ошибку.</span><span class="sxs-lookup"><span data-stu-id="ea4c4-131">Be sure to set the **dwServiceSpecificExitCode** and **dwWin32ExitCode** members of the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure to identify the error.</span></span>

## <a name="related-topics"></a><span data-ttu-id="ea4c4-132">См. также</span><span class="sxs-lookup"><span data-stu-id="ea4c4-132">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="ea4c4-133">Написание функции ServiceMain</span><span class="sxs-lookup"><span data-stu-id="ea4c4-133">Writing a ServiceMain Function</span></span>](writing-a-servicemain-function.md)
</dt> </dl>

 

 
