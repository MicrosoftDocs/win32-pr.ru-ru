---
description: Узнайте о защите служб защиты от вредоносных программ (AM) и о том, как можно включить эту функцию в службу защиты от вредоносных программ.
ms.assetid: 88875a0d-9027-43f2-8411-34f9ff428fe5
title: Защита служб защиты от вредоносных программ
ms.topic: article
ms.date: 08/02/2018
ms.openlocfilehash: 5e7783eb307381d368900332b5e761ad62785913
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "104081479"
---
# <a name="protecting-anti-malware-services"></a><span data-ttu-id="33665-103">Защита служб защиты от вредоносных программ</span><span class="sxs-lookup"><span data-stu-id="33665-103">Protecting Anti-Malware Services</span></span>

<span data-ttu-id="33665-104">В Windows 8.1 появилась новая концепция защищенных служб для защиты служб защиты от вредоносных программ, которая часто является целью атак вредоносных программ.</span><span class="sxs-lookup"><span data-stu-id="33665-104">Windows 8.1 introduced a new concept of protected services to protect anti-malware services, which are a frequent target of attack by malware.</span></span>

<span data-ttu-id="33665-105">Узнайте о защите служб защиты от вредоносных программ (AM) и о том, как можно включить эту функцию в службу защиты от вредоносных программ.</span><span class="sxs-lookup"><span data-stu-id="33665-105">Learn about protecting anti-malware (AM) user mode services and how you can opt to include this feature in your anti-malware service.</span></span>

<span data-ttu-id="33665-106">Эти сведения относятся к следующим операционным системам и их последователям:</span><span class="sxs-lookup"><span data-stu-id="33665-106">This information applies to the following operating systems and their successors:</span></span>

-   <span data-ttu-id="33665-107">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="33665-107">Windows 8.1</span></span>
-   <span data-ttu-id="33665-108">Windows Server 2012 R2</span><span class="sxs-lookup"><span data-stu-id="33665-108">Windows Server 2012 R2</span></span>

<span data-ttu-id="33665-109">Ссылки и материалы, описанные здесь, перечислены в конце этого раздела.</span><span class="sxs-lookup"><span data-stu-id="33665-109">References and resources discussed here are listed at the end of this topic.</span></span>

## <a name="introduction"></a><span data-ttu-id="33665-110">Введение</span><span class="sxs-lookup"><span data-stu-id="33665-110">Introduction</span></span>

<span data-ttu-id="33665-111">Большинство решений для защиты от вредоносных программ включает в себя службу пользовательского режима, которая выполняет специализированные операции по обнаружению и удалению вредоносных программ из системы.</span><span class="sxs-lookup"><span data-stu-id="33665-111">Most anti-malware solutions include a user-mode service that performs specialized operations to detect and remove malware from the system.</span></span> <span data-ttu-id="33665-112">Эта служба пользовательского режима также часто отвечает за загрузку последних определений и сигнатур вирусов.</span><span class="sxs-lookup"><span data-stu-id="33665-112">This user-mode service is also frequently responsible for downloading the latest virus definitions and signatures.</span></span> <span data-ttu-id="33665-113">Эта служба пользовательского режима станет частой целью вредоносных программ, так как это единственная точка отказа от отключения защиты в системе.</span><span class="sxs-lookup"><span data-stu-id="33665-113">This user-mode service becomes a frequent target of malware because it’s the single point of failure to disable protection on a system.</span></span> <span data-ttu-id="33665-114">Для защиты от атак в службе пользовательского режима поставщики антивредоносного по должны добавить к их программному обеспечению множество функций и эвристику.</span><span class="sxs-lookup"><span data-stu-id="33665-114">To defend against attacks on the user-mode service, anti-malware vendors have to add a lot of functionality and heuristics to their software.</span></span> <span data-ttu-id="33665-115">Однако такие методы не полностью надежны и, как правило, подвержены ошибкам, так как они должны определять функциональные возможности, выполняемые Windows в своей службе, и выборочно включать эти функции.</span><span class="sxs-lookup"><span data-stu-id="33665-115">However, such techniques are not completely foolproof and tend to be error prone because they have to identify functionality that Windows performs on their service and selectively enable that functionality.</span></span>

<span data-ttu-id="33665-116">В Windows 8.1 появилась новая концепция защищенной службы, позволяющая запускать службы пользовательского режима защиты от вредоносных программ в качестве защищенной службы.</span><span class="sxs-lookup"><span data-stu-id="33665-116">In Windows 8.1, a new concept of protected service has been introduced to allow anti-malware user-mode services to be launched as a protected service.</span></span> <span data-ttu-id="33665-117">После запуска службы в качестве защищенной система Windows использует целостность кода, чтобы разрешить загрузку только доверенного кода в защищенную службу.</span><span class="sxs-lookup"><span data-stu-id="33665-117">After the service is launched as protected, Windows uses code integrity to only allow trusted code to load into the protected service.</span></span> <span data-ttu-id="33665-118">Windows также защищает эти процессы от внедрения кода и других атак из процессов администрирования.</span><span class="sxs-lookup"><span data-stu-id="33665-118">Windows also protects these processes from code injection and other attacks from admin processes.</span></span>

<span data-ttu-id="33665-119">В этом документе описывается, как поставщик антивредоносной программы с драйвером раннего запуска от вредоносных программ (ELAM) может принять участие в этой функции и запустить службу защиты от вредоносных программ как защищенную службу.</span><span class="sxs-lookup"><span data-stu-id="33665-119">This document describes how an anti-malware vendor with an Early Launch Anti-Malware (ELAM) driver can opt-in to this feature and launch their anti-malware service as a protected service.</span></span>

## <a name="system-protected-process"></a><span data-ttu-id="33665-120">Защищенный системный процесс</span><span class="sxs-lookup"><span data-stu-id="33665-120">System protected process</span></span>

<span data-ttu-id="33665-121">Начиная с Windows 8.1, в ядре была реализована новая модель безопасности для повышения защиты от атак злоумышленников на критически важные для системы компоненты.</span><span class="sxs-lookup"><span data-stu-id="33665-121">Starting with Windows 8.1, a new security model has been put in place in the kernel to better defend against malicious attacks on system-critical components.</span></span> <span data-ttu-id="33665-122">Эта новая модель безопасности расширяет инфраструктуру защищенных процессов предыдущих версий Windows, используемых для конкретных сценариев, таких как воспроизведение содержимого DRM, в модель общего назначения, которая может использоваться сторонними поставщиками защиты от вредоносных программ.</span><span class="sxs-lookup"><span data-stu-id="33665-122">This new security model extends the protected process infrastructure previous versions of Windows used for specific scenarios, such as playing DRM content, into a general-purpose model that can be used by 3rd party anti-malware vendors.</span></span> <span data-ttu-id="33665-123">Инфраструктура защищенных процессов допускает только надежный подписанный код для загрузки и имеет встроенную защиту от атак путем внедрения кода.</span><span class="sxs-lookup"><span data-stu-id="33665-123">The protected process infrastructure only allows trusted, signed code to load and has built-in defense against code injection attacks.</span></span>

<span data-ttu-id="33665-124">Дополнительные сведения о защищенных процессах см. [в разделе защищенные процессы в Windows Vista](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) .</span><span class="sxs-lookup"><span data-stu-id="33665-124">See [Protected Processes in Windows Vista](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) for more information on protected processes.</span></span>

<span data-ttu-id="33665-125">Новая модель безопасности использует немного другой вариант инфраструктуры процесса защиты, именуемый системным защищенным процессом, который более подходит для этой функции, так как это позволяет отдельно защитить содержимое DRM.</span><span class="sxs-lookup"><span data-stu-id="33665-125">The new security model uses a slightly different variant of the protection process infrastructure called system protected process, which is more suitable for this feature as this keeps the DRM content separate.</span></span> <span data-ttu-id="33665-126">Каждый защищенный системный процесс имеет связанный уровень или атрибут, указывающий политику подписи подписанного кода, которая может загружаться в процессе.</span><span class="sxs-lookup"><span data-stu-id="33665-126">Each system protected process has an associated level or attribute, which indicates the signature policy of the signed code allowed to load within the process.</span></span> <span data-ttu-id="33665-127">После того как службы защиты от вредоносных программ переведены в режим защищенной службы, в этот процесс могут быть загружены только подписанный на Windows код или код, подписанный с помощью сертификатов поставщика защиты от вредоносных программ.</span><span class="sxs-lookup"><span data-stu-id="33665-127">After the anti-malware services have opted into the protected service mode, only Windows signed code or code signed with the anti-malware vendor’s certificates are allowed to load in that process.</span></span> <span data-ttu-id="33665-128">Аналогичным образом, другие уровни защищенных процессов используют разные политики кода, реализованные Windows.</span><span class="sxs-lookup"><span data-stu-id="33665-128">Similarly, other protected process levels have different code policies enforced by Windows.</span></span>

## <a name="requirements"></a><span data-ttu-id="33665-129">Требования</span><span class="sxs-lookup"><span data-stu-id="33665-129">Requirements</span></span>

<span data-ttu-id="33665-130">Чтобы служба пользовательского режима защиты от вредоносных программ выполнялась в качестве защищенной службы, у поставщика антивредоносной программы должен быть установлен драйвер ELAM на компьютере Windows.</span><span class="sxs-lookup"><span data-stu-id="33665-130">For an anti-malware user-mode service to run as a protected service, the anti-malware vendor must have an ELAM driver installed on the Windows machine.</span></span> <span data-ttu-id="33665-131">Помимо существующих требований к сертификации драйвера ELAM драйвер должен иметь раздел внедренного ресурса, содержащий сведения о сертификатах, используемых для подписания двоичных файлов службы пользовательского режима.</span><span class="sxs-lookup"><span data-stu-id="33665-131">In addition to the existing ELAM driver certification requirements, the driver must have an embedded resource section containing the information of the certificates used to sign the user mode service binaries.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="33665-132">В Windows 8.1 цепочка сертификации должна быть известен как известная корневая папка, определенная с помощью проверки драйверов, либо должен быть добавлен корневой сертификат.</span><span class="sxs-lookup"><span data-stu-id="33665-132">In Windows 8.1, the certification chain either has to be a known root as determined by driver verification, or the root certificate must be included.</span></span>

 

<span data-ttu-id="33665-133">В процессе загрузки этот раздел ресурсов будет извлечен из драйвера ELAM для проверки сведений о сертификате и регистрации службы защиты от вредоносных программ.</span><span class="sxs-lookup"><span data-stu-id="33665-133">During the boot process, this resource section will be extracted from the ELAM driver to validate the certificate information and register the anti-malware service.</span></span> <span data-ttu-id="33665-134">Службу защиты от вредоносных программ можно также зарегистрировать во время процесса установки антивредоносного по, вызвав специальный API, как описано далее в этом документе.</span><span class="sxs-lookup"><span data-stu-id="33665-134">The anti-malware service can also be registered during the anti-malware software installation process by calling a special API, as described later in this document.</span></span>

<span data-ttu-id="33665-135">После того как раздел ресурсов успешно извлечен из драйвера ELAM и зарегистрирована служба пользовательского режима, служба может запуститься в качестве защищенной службы.</span><span class="sxs-lookup"><span data-stu-id="33665-135">After the resource section is successfully extracted from the ELAM driver and the user-mode service is registered, the service is allowed to launch as protected service.</span></span> <span data-ttu-id="33665-136">Когда служба запускается как защищенная, другие незащищенные процессы в системе не смогут внедрять потоки, и им не будет разрешено записывать в виртуальную память защищенного процесса.</span><span class="sxs-lookup"><span data-stu-id="33665-136">After the service is launched as protected, other non-protected processes on the system won't be able to inject threads, and they wont' be allowed to write into the virtual memory of the protected process.</span></span>

<span data-ttu-id="33665-137">Кроме того, любые библиотеки DLL, не относящиеся к Windows, которые загружаются в защищенный процесс, должны быть подписаны соответствующим сертификатом.</span><span class="sxs-lookup"><span data-stu-id="33665-137">In addition, any non-Windows DLLs that get loaded into the protected process must be signed with an appropriate certificate.</span></span>

<span data-ttu-id="33665-138">Дополнительные сведения о драйверах ELAM см. в разделе [ранний запуск антивредоносной программы](/windows/desktop/w8cookbook/secured-boot) .</span><span class="sxs-lookup"><span data-stu-id="33665-138">See [Early launch antimalware](/windows/desktop/w8cookbook/secured-boot) for more information on ELAM drivers.</span></span>

### <a name="anti-malware-service-signing-requirements"></a><span data-ttu-id="33665-139">Требования к подписывания службы защиты от вредоносных программ</span><span class="sxs-lookup"><span data-stu-id="33665-139">Anti-malware service signing requirements</span></span>

<span data-ttu-id="33665-140">Служба пользовательского режима, которую необходимо запустить как защищенную, должна быть подписана с помощью действительных сертификатов.</span><span class="sxs-lookup"><span data-stu-id="33665-140">The user-mode service that needs to be launched as protected must be signed with valid certificates.</span></span> <span data-ttu-id="33665-141">EXE-файл службы должен быть подписан в виде хэша страницы, а все DLL-библиотеки, не относящиеся к Windows, которые загружаются в службу, должны также подписываться теми же сертификатами.</span><span class="sxs-lookup"><span data-stu-id="33665-141">The service EXE must be page hash signed, and any non-Windows DLLs that get loaded into the service must be also signed with the same certificates.</span></span> <span data-ttu-id="33665-142">Хэш этих сертификатов должен быть добавлен в файл ресурсов, который будет связан с драйвером ELAM.</span><span class="sxs-lookup"><span data-stu-id="33665-142">The hash of these certificates must be added into the resource file, which will be linked into the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="33665-143">Необходимо использовать хэши файлов и страниц SHA256, хотя сертификаты могут по-прежнему иметь значение SHA1.</span><span class="sxs-lookup"><span data-stu-id="33665-143">SHA256 file/page hashes must be used, though certificates may continue to be SHA1.</span></span>

 

### <a name="primary-signature-recommended"></a><span data-ttu-id="33665-144">Основная подпись (рекомендуется)</span><span class="sxs-lookup"><span data-stu-id="33665-144">Primary signature (recommended)</span></span>

<span data-ttu-id="33665-145">Рекомендуется, чтобы поставщики антивредоносного по использовали существующий сертификат Authenticode для подписи своих двоичных файлов службы защиты от вредоносных программ и хэш-код этого сертификата Authenticode в разделе ресурсов, чтобы указать сертификат, используемый для подписи двоичных файлов службы.</span><span class="sxs-lookup"><span data-stu-id="33665-145">We recommend that anti-malware vendors use their existing Authenticode certificate to sign their anti-malware service binaries, and that the hash of this Authenticode certificate be included in the resource section to indicate the certificate that's used to sign the service binaries.</span></span> <span data-ttu-id="33665-146">При обновлении этого сертификата необходимо освободить более новую версию драйвера ELAM с обновленными хэшами сертификатов.</span><span class="sxs-lookup"><span data-stu-id="33665-146">If you update this certificate, a newer version of the ELAM driver must be released with the updated certificate hashes.</span></span>

### <a name="secondary-signature-optional"></a><span data-ttu-id="33665-147">Вторичная подпись (необязательно)</span><span class="sxs-lookup"><span data-stu-id="33665-147">Secondary signature (optional)</span></span>

<span data-ttu-id="33665-148">Поставщики антивредоносных программ имеют возможность настроить частный ЦС и использовать сертификаты из этого ЦС для подписания двоичных файлов службы защиты от вредоносных программ как вторичной подписи.</span><span class="sxs-lookup"><span data-stu-id="33665-148">Anti-malware vendors have the option to set up a private CA and use certificates from this CA to code sign the anti-malware service binaries as a secondary signature.</span></span> <span data-ttu-id="33665-149">Основное преимущество использования частного ЦС заключается в том, что он позволяет поставщикам создавать сертификаты со специализированным свойством EKU, которое можно использовать для различения нескольких продуктов одного поставщика.</span><span class="sxs-lookup"><span data-stu-id="33665-149">The main advantage of using the private CA is that it enables vendors to create certificates with a specialized EKU property, which can be used to differentiate between multiple products from the same vendor.</span></span> <span data-ttu-id="33665-150">Это также сокращает необходимость обновления драйвера ELAM из-за истечения срока действия сертификата, так как сертификаты частного ЦС обычно имеют более длинные даты окончания срока действия.</span><span class="sxs-lookup"><span data-stu-id="33665-150">It also reduces the need to update your ELAM driver due to certificate expiry, as the private CA certs typically have longer expiry dates.</span></span>

<span data-ttu-id="33665-151">Обратите внимание, что если двоичные файлы службы подписаны частными сертификатами ЦС, двоичные файлы должны также иметь двойную подпись с существующими сертификатами Authenticode.</span><span class="sxs-lookup"><span data-stu-id="33665-151">Note that if the service binaries are signed with the private CA certs, the binaries must also be dual signed with the existing Authenticode certificates.</span></span> <span data-ttu-id="33665-152">Если двоичные файлы не подписаны хорошо известным доверенным центром сертификации (например, VeriSign), пользователь компьютера не имеет уверенности в двоичных файлах, так как не может доверять частному центру сертификации.</span><span class="sxs-lookup"><span data-stu-id="33665-152">If the binaries are not signed by a well-known trusted CA (for example VeriSign), the user of the machine has no confidence in the binaries because they cannot trust the private CA.</span></span> <span data-ttu-id="33665-153">Двойное подписывание двоичных файлов с помощью существующего сертификата Authenticode также позволяет запускать двоичные файлы в операционных системах нижнего уровня.</span><span class="sxs-lookup"><span data-stu-id="33665-153">Dual signing the binaries with the existing Authenticode certificate also allows the binaries to run on down-level operating systems.</span></span>

<span data-ttu-id="33665-154">Дополнительные сведения о настройке и установке центра сертификации см. в статье о настройке центра [сертификатов](/previous-versions/windows/desktop/ms755466(v=vs.85)) и [установке](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))ЦС.</span><span class="sxs-lookup"><span data-stu-id="33665-154">For more info about how to set up and install the Certificate Authority, see [Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85)) and [Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11)).</span></span>

> [!Note]  
> <span data-ttu-id="33665-155">Для обеспечения совместимости с Windows Vista или Windows XP (или Windows 7 без исправления SHA2) можно использовать параметр "/АС" при подписывании двоичных файлов с [SignTool.exe](/windows/desktop/SecCrypto/signtool) с помощью хэшей файлов и страниц SHA256.</span><span class="sxs-lookup"><span data-stu-id="33665-155">For compatibility with Windows Vista or Windows XP (or Windows 7 without the SHA2 patch), you can use the "/as" switch when signing your binaries with [SignTool.exe](/windows/desktop/SecCrypto/signtool) with the SHA256 file/page hashes.</span></span> <span data-ttu-id="33665-156">При этом подпись будет добавлена в файл в качестве дополнительной подписи.</span><span class="sxs-lookup"><span data-stu-id="33665-156">This will add the signature as a secondary signature to the file.</span></span> <span data-ttu-id="33665-157">SHA1. Сначала подпишите файл, так как Windows XP, Windows Vista и Windows 7 увидят только первую подпись.</span><span class="sxs-lookup"><span data-stu-id="33665-157">SHA1 sign the file first, since Windows XP, Windows Vista, and Windows 7 will only see the first signature.</span></span>

 

### <a name="dll-signing-requirements"></a><span data-ttu-id="33665-158">Требования к подписывания библиотек DLL</span><span class="sxs-lookup"><span data-stu-id="33665-158">DLL signing requirements</span></span>

<span data-ttu-id="33665-159">Как упоминалось ранее, все библиотеки DLL, не относящиеся к Windows, которые загружаются в защищенную службу, должны быть подписаны тем же сертификатом, который использовался для подписания службы защиты от вредоносных программ.</span><span class="sxs-lookup"><span data-stu-id="33665-159">As mentioned earlier, any non-Windows DLLs that get loaded into the protected service must be signed with the same certificate that was used to sign the anti-malware service.</span></span>

### <a name="catalog-signing"></a><span data-ttu-id="33665-160">Подписывание каталога</span><span class="sxs-lookup"><span data-stu-id="33665-160">Catalog Signing</span></span>

<span data-ttu-id="33665-161">Поставщики борьбы с вредоносными программами могут включать пакеты, разработанные другими компаниями, без обновления двоичных сигнатур.</span><span class="sxs-lookup"><span data-stu-id="33665-161">Anti-malware vendors can include packages developed by other companies without updating the binary signatures.</span></span> <span data-ttu-id="33665-162">Это можно сделать, включив в каталог двоичные файлы, подписанные с помощью сертификата Authenticode. для этого необходимо выполнить следующие действия.</span><span class="sxs-lookup"><span data-stu-id="33665-162">This can be achieved by including the binaries in a catalog which is signed with their Authenticode certificate, accomplished by following these steps:</span></span>

1. <span data-ttu-id="33665-163">Создание каталога с помощью [макекат](/windows/desktop/SecCrypto/makecat)</span><span class="sxs-lookup"><span data-stu-id="33665-163">Generate a catalog using [MakeCat](/windows/desktop/SecCrypto/makecat)</span></span>
2. <span data-ttu-id="33665-164">Добавление всех двоичных файлов без соответствующей подписи в каталог</span><span class="sxs-lookup"><span data-stu-id="33665-164">Add all of the binaries without an appropriate signature to the catalog</span></span>
3. <span data-ttu-id="33665-165">Подпишите каталог с помощью сертификата Authenticode, как и любой другой двоичный файл.</span><span class="sxs-lookup"><span data-stu-id="33665-165">Sign the catalog with the Authenticode certificate, as you would any other binary</span></span>
4. <span data-ttu-id="33665-166">Используйте функцию [добавления каталога](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) , чтобы включить каталог в приложение.</span><span class="sxs-lookup"><span data-stu-id="33665-166">Use the [add catalog](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) function to include the catalog with the application.</span></span>

<span data-ttu-id="33665-167">Если целостность кода распространяется на пакеты без соответствующей сигнатуры, она будет искать каталог с утвержденной подписью.</span><span class="sxs-lookup"><span data-stu-id="33665-167">When code integrity comes across the packages without an appropriate signature, it will search for a catalog with an approved signature.</span></span> <span data-ttu-id="33665-168">Этот каталог будет найден при условии, что эти шаги выполнены и устанавливаются вместе с приложением.</span><span class="sxs-lookup"><span data-stu-id="33665-168">It will find this catalog as long as these steps are followed and it is installed with the application.</span></span>


## <a name="resource-file-info"></a><span data-ttu-id="33665-169">Сведения о файле ресурсов</span><span class="sxs-lookup"><span data-stu-id="33665-169">Resource file info</span></span>

<span data-ttu-id="33665-170">Файл ресурсов должен быть создан и связан с драйвером ELAM.</span><span class="sxs-lookup"><span data-stu-id="33665-170">A resource file must be created and linked into the ELAM driver.</span></span> <span data-ttu-id="33665-171">Хэш сертификата вместе с другими сведениями о сертификате необходимо добавить в файл ресурсов.</span><span class="sxs-lookup"><span data-stu-id="33665-171">The hash of the certificate, along with other certificate information, must be added in the resource file.</span></span>

<span data-ttu-id="33665-172">Раздел ресурсов должен быть в следующем макете, чтобы система успешно извлека ресурсы из двоичного образа и проверяла сведения о внедренном сертификате.</span><span class="sxs-lookup"><span data-stu-id="33665-172">The resource section must be in the following layout for the system to successfully extract the resources from the binary image and validate the embedded certificate information.</span></span>

``` syntax
MicrosoftElamCertificateInfo  MSElamCertInfoID
{
      3, // count of entries
      L”CertHash1\0”,
      Algorithm,
      L”EKU1\0”,
      L”CertHash2\0”,
      Algorithm,
      L”\0”, //No EKU for cert hash 2
      L”CertHash3\0”,
      Algorithm,
      L”EKU3a;EKU3b;EKU3c\0”,  //multiple EKU entries supported (max: 3)
}
```

<span data-ttu-id="33665-173">Дополнительные сведения о файле ресурсов, определяемом пользователем, см. в разделе [определяемый пользователем ресурс](/windows/desktop/menurc/user-defined-resource).</span><span class="sxs-lookup"><span data-stu-id="33665-173">For more info about user-defined resource file, see [User-Defined Resource](/windows/desktop/menurc/user-defined-resource).</span></span>

### <a name="certhash"></a><span data-ttu-id="33665-174">CertHash</span><span class="sxs-lookup"><span data-stu-id="33665-174">CertHash</span></span>

<span data-ttu-id="33665-175">Хэш сертификата, который используется для подписи службы защиты от вредоносных программ.</span><span class="sxs-lookup"><span data-stu-id="33665-175">The hash of the certificate that's used to sign the anti-malware service.</span></span> <span data-ttu-id="33665-176">Для получения хэша можно использовать средство CertMgr.exe, которое поставляется в Windows SDK.</span><span class="sxs-lookup"><span data-stu-id="33665-176">The CertMgr.exe tool, which ships in the Windows SDK, can be used to obtain the hash.</span></span>

``` syntax
certmgr.exe –v <path to the signed file>
```

<span data-ttu-id="33665-177">Пример:</span><span class="sxs-lookup"><span data-stu-id="33665-177">For example:</span></span>

![хэш сертификата службы с защитой от вредоносных программ (certhash)](images/cert-hash-example.png)

### <a name="algorithm"></a><span data-ttu-id="33665-179">Алгоритм</span><span class="sxs-lookup"><span data-stu-id="33665-179">Algorithm</span></span>

<span data-ttu-id="33665-180">Значение алгоритма представляет собой алгоритм сертификата.</span><span class="sxs-lookup"><span data-stu-id="33665-180">The algorithm value represents the algorithm of the certificate.</span></span> <span data-ttu-id="33665-181">Поддерживаются следующие значения алгоритма:</span><span class="sxs-lookup"><span data-stu-id="33665-181">These algorithm values are supported:</span></span>

<dl> <span data-ttu-id="33665-182">0x8004 — SHA1</span><span class="sxs-lookup"><span data-stu-id="33665-182">0x8004 – SHA1</span></span>  
<span data-ttu-id="33665-183">0x800c – SHA256</span><span class="sxs-lookup"><span data-stu-id="33665-183">0x800c – SHA256</span></span>  
<span data-ttu-id="33665-184">0X800d — SHA384</span><span class="sxs-lookup"><span data-stu-id="33665-184">0X800d – SHA384</span></span>  
<span data-ttu-id="33665-185">0x800e — SHA512</span><span class="sxs-lookup"><span data-stu-id="33665-185">0x800e – SHA512</span></span>  
</dl>

<span data-ttu-id="33665-186">Не забудьте включить значение алгоритма (как показано выше), а не фактическое имя алгоритма.</span><span class="sxs-lookup"><span data-stu-id="33665-186">Remember to include the value of the algorithm (as shown above) and not the actual name of the algorithm.</span></span> <span data-ttu-id="33665-187">Например, если сертификат основан на алгоритме SHA256, включите 0x800c в раздел Resource.</span><span class="sxs-lookup"><span data-stu-id="33665-187">For example, if the cert is based on the SHA256 algorithm, include 0x800c in the resource section.</span></span>

### <a name="eku"></a><span data-ttu-id="33665-188">EKU</span><span class="sxs-lookup"><span data-stu-id="33665-188">EKU</span></span>

<span data-ttu-id="33665-189">Объект EKU представляет одно свойство расширенного использования ключа (EKU) сертификата.</span><span class="sxs-lookup"><span data-stu-id="33665-189">The EKU object represents a single extended key usage (EKU) property of a certificate.</span></span> <span data-ttu-id="33665-190">Это необязательный параметр. \\ Если с сертификатом не связано ни одного EKU, необходимо указать "0". Если существует несколько продуктов и служб от одного поставщика антивредоносного по, работающего в одной системе, поставщик антивредоносного по может использовать свойство EKU сертификата частного ЦС, чтобы отличать одну службу от другой.</span><span class="sxs-lookup"><span data-stu-id="33665-190">This is optional and “\\0” should be specified if no EKUs are associated with the cert. In a case where there are multiple products and services from a single anti-malware vendor running on the same system, the anti-malware vendor can use the EKU property of the private CA certificate to differentiate one service from another.</span></span> <span data-ttu-id="33665-191">Например, если в системе запущены две службы из одного поставщика антивредоносного по и они подписаны одним и тем же центром сертификации, то служба, которая должна быть запущена как защищенная, может быть подписана с помощью сертификата, выданного центром сертификации, который содержит специальное EKU.</span><span class="sxs-lookup"><span data-stu-id="33665-191">For example, if there are two services running on the system from the same anti-malware vendor and signed by the same CA, the service that needs to be launched as protected can be signed with a cert issued by CA that contains a special EKU.</span></span> <span data-ttu-id="33665-192">Это EKU необходимо добавить в раздел ресурсов.</span><span class="sxs-lookup"><span data-stu-id="33665-192">This EKU must be added to the resource section.</span></span> <span data-ttu-id="33665-193">Затем EKU регистрируется системой и связывается с хэшем сертификата для проверки и запуска службы в качестве защищенной.</span><span class="sxs-lookup"><span data-stu-id="33665-193">The EKU is then registered by the system and paired with the certificate hash for validating and launching the service as protected.</span></span>

<span data-ttu-id="33665-194">Обратите внимание, что цепочка сертификатов должна включать EKU для подписывания кода (1.3.6.1.5.5.7.3.3), но это EKU не должно включаться в раздел ресурсов драйвера ELAM.</span><span class="sxs-lookup"><span data-stu-id="33665-194">Note that the certificate chain must include the Code Signing EKU (1.3.6.1.5.5.7.3.3), but this EKU must not be included in the resource section of the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="33665-195">Если сведения о EKU содержатся в сведениях о сертификате для драйвера ELAM, то при подписывании двоичных файлов необходимо использовать одно и то же EKU.</span><span class="sxs-lookup"><span data-stu-id="33665-195">If EKU information is included in certificate information for the ELAM driver, then the same EKU must be used when signing your binaries.</span></span>

 

### <a name="count"></a><span data-ttu-id="33665-196">Count</span><span class="sxs-lookup"><span data-stu-id="33665-196">Count</span></span>

<span data-ttu-id="33665-197">Если двоичный файл службы защиты от вредоносных программ подписан с помощью сертификата Authenticode, а также сертификата частного ЦС, в раздел ресурсов необходимо добавить только сведения о сертификате частного ЦС.</span><span class="sxs-lookup"><span data-stu-id="33665-197">If the anti-malware service binary is signed with the Authenticode certificate as well as the private CA certificate, only the private CA certificate information must be added in the resource section.</span></span>

## <a name="launching-anti-malware-services-as-protected"></a><span data-ttu-id="33665-198">Запуск служб защиты от вредоносных программ в качестве защищенных</span><span class="sxs-lookup"><span data-stu-id="33665-198">Launching anti-malware services as protected</span></span>

### <a name="registering-the-service"></a><span data-ttu-id="33665-199">Регистрация службы</span><span class="sxs-lookup"><span data-stu-id="33665-199">Registering the service</span></span>

<span data-ttu-id="33665-200">Служба защиты от вредоносных программ должна быть зарегистрирована в системе, прежде чем ее можно будет запустить как защищенную.</span><span class="sxs-lookup"><span data-stu-id="33665-200">The anti-malware service must be registered with the system before it can be started as protected.</span></span> <span data-ttu-id="33665-201">Во время установки программного обеспечения для защиты от вредоносных программ установщик может установить драйвер ELAM и перезагрузить систему для автоматической регистрации службы.</span><span class="sxs-lookup"><span data-stu-id="33665-201">During the installation of the anti-malware software, the installer can install the ELAM driver and reboot the system to automatically register the service.</span></span> <span data-ttu-id="33665-202">Система зарегистрирует службу во время загрузки, извлекая сведения о сертификате из упомянутого выше файла ресурсов, связанного с драйвером ELAM.</span><span class="sxs-lookup"><span data-stu-id="33665-202">The system will register the service at boot time by extracting the certificate information from the aforementioned resource file that is linked into the ELAM driver.</span></span>

<span data-ttu-id="33665-203">На этапе установки настоятельно рекомендуется перезапустить систему для того, чтобы драйвер ELAM загружался и проверял состояние системы.</span><span class="sxs-lookup"><span data-stu-id="33665-203">During the installation phase, it is highly recommended that the system is restarted in order for the ELAM driver to get loaded and validate the state of the system.</span></span> <span data-ttu-id="33665-204">Однако в случаях, когда следует избегать перезагрузки, Windows также предоставляет механизм для установщика защиты от вредоносных программ, который регистрирует службу как защищенную с помощью API.</span><span class="sxs-lookup"><span data-stu-id="33665-204">However, for cases where a reboot must be avoided, Windows also exposes a mechanism for the anti-malware installer to register the service as protected using an API.</span></span>

### <a name="registering-the-service-without-rebooting-the-system"></a><span data-ttu-id="33665-205">Регистрация службы без перезагрузки системы</span><span class="sxs-lookup"><span data-stu-id="33665-205">Registering the service without rebooting the system</span></span>

<span data-ttu-id="33665-206">Во время установки установщик по борьбе с вредоносными программами может вызвать API [**инсталлеламцертификатеинфо**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) и предоставить обработчик для файла драйвера ELAM.</span><span class="sxs-lookup"><span data-stu-id="33665-206">During the installation, an anti-malware software installer can call the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API and provide a handle to the ELAM driver file.</span></span> <span data-ttu-id="33665-207">Система открывает драйвер ELAM, вызывает внутренние подпрограммы, чтобы убедиться, что драйвер ELAM правильно подписан, и извлекает сведения о сертификате из раздела ресурсов, связанного с драйвером ELAM.</span><span class="sxs-lookup"><span data-stu-id="33665-207">The system opens the ELAM driver, calls internal routines to make sure the ELAM driver is signed properly, and extracts the certificate information from the resource section associated with the ELAM driver.</span></span> <span data-ttu-id="33665-208">Синтаксис функции см. в разделе [**инсталлеламцертификатеинфо**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo).</span><span class="sxs-lookup"><span data-stu-id="33665-208">For function syntax see [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo).</span></span>

<span data-ttu-id="33665-209">Пример кода:</span><span class="sxs-lookup"><span data-stu-id="33665-209">Code example:</span></span>


```C++
HANDLE FileHandle = NULL;

FileHandle = CreateFile(<Insert Elam driver file name>,
                        FILE_READ_DATA,
                        FILE_SHARE_READ,
                        NULL,
                        OPEN_EXISTING,
                        FILE_ATTRIBUTE_NORMAL,
                        NULL
                        );

if (InstallElamCertificateInfo(FileHandle) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



### <a name="starting-the-service-as-protected"></a><span data-ttu-id="33665-210">Запуск службы как защищенной</span><span class="sxs-lookup"><span data-stu-id="33665-210">Starting the service as protected</span></span>

<span data-ttu-id="33665-211">Установщик может выполнить следующие действия, чтобы создать, настроить и запустить службу как защищенную:</span><span class="sxs-lookup"><span data-stu-id="33665-211">The installer can follow these steps to create, configure, and start the service as protected:</span></span>

1.  <span data-ttu-id="33665-212">Вызовите API [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) , чтобы создать объект службы и добавить его в базу данных диспетчера управления СЛУЖБАМИ (SCM).</span><span class="sxs-lookup"><span data-stu-id="33665-212">Call the [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) API to create a service object and add it to the service control manager (SCM) database.</span></span>
2.  <span data-ttu-id="33665-213">Вызовите API [**сетсервицеобжектсекурити**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) , чтобы задать дескриптор безопасности объекта службы, созданного на шаге 1.</span><span class="sxs-lookup"><span data-stu-id="33665-213">Call the [**SetServiceObjectSecurity**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) API to set the security descriptor of the service object created in step 1.</span></span>
3.  <span data-ttu-id="33665-214">Вызовите API [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) , чтобы пометить службу как защищенную, указав новое значение **\_ \_ \_ защищенного перечисления для настройки службы** , которое было добавлено в винсвк. h (начиная с Windows 8.1).</span><span class="sxs-lookup"><span data-stu-id="33665-214">Call the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API to mark the service as protected, specifying the new **SERVICE\_CONFIG\_LAUNCH\_PROTECTED** enumeration value, which has been added in Winsvc.h (as of Windows 8.1).</span></span>

    <span data-ttu-id="33665-215">Пример кода:</span><span class="sxs-lookup"><span data-stu-id="33665-215">Code example:</span></span>

    ```C++
    SERVICE_LAUNCH_PROTECTED_INFO Info;
    SC_HANDLE hService;

    Info.dwLaunchProtected = SERVICE_LAUNCH_PROTECTED_ANTIMALWARE_LIGHT;

    hService = CreateService (/* ... */);

    if (ChangeServiceConfig2(hService,
                             SERVICE_CONFIG_LAUNCH_PROTECTED,
                             &Info) == FALSE)
    {
        Result = GetLastError();
    }
    ```

    

4.  <span data-ttu-id="33665-216">Вызовите API [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) , чтобы запустить службу.</span><span class="sxs-lookup"><span data-stu-id="33665-216">Call the [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) API to start the service.</span></span> <span data-ttu-id="33665-217">При запуске службы как защищенной служба SCM проверяет наличие подсистемы целостности кода (CI), чтобы проверить сведения о сертификате.</span><span class="sxs-lookup"><span data-stu-id="33665-217">When starting the service as protected, SCM checks with Code Integrity (CI) subsystem to validate the certificate information.</span></span> <span data-ttu-id="33665-218">После проверки сведений о сертификате CI службы SCM запускают службу как защищенную.</span><span class="sxs-lookup"><span data-stu-id="33665-218">After the certificate information is validated by CI, SCM launches the service as protected.</span></span>
    1.  <span data-ttu-id="33665-219">Обратите внимание, что этот шаг завершается ошибкой, если вы не зарегистрировали службу путем вызова API [**инсталлеламцертификатеинфо**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) .</span><span class="sxs-lookup"><span data-stu-id="33665-219">Note that this step fails if you haven’t registered the service by calling the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API.</span></span>
    2.  <span data-ttu-id="33665-220">Если служба настроена на автоматический запуск на этапе запуска системы, этот шаг можно избежать и просто перезагрузить систему.</span><span class="sxs-lookup"><span data-stu-id="33665-220">If the service has been configured to start automatically during the system startup phase, you can avoid this step and simply reboot the system.</span></span> <span data-ttu-id="33665-221">Во время перезагрузки система автоматически регистрирует службу (если драйвер ELAM запускается успешно) и запускает службу в защищенном режиме.</span><span class="sxs-lookup"><span data-stu-id="33665-221">During a reboot, the system automatically registers the service (if the ELAM driver starts successfully) and starts the service in protected mode.</span></span>

### <a name="launching-a-child-process-as-protected"></a><span data-ttu-id="33665-222">Запуск дочернего процесса в качестве защищенного</span><span class="sxs-lookup"><span data-stu-id="33665-222">Launching a child process as protected</span></span>

<span data-ttu-id="33665-223">Новая модель безопасности также позволяет службам защиты от вредоносных программ запускать дочерние процессы в качестве защищенных.</span><span class="sxs-lookup"><span data-stu-id="33665-223">The new security model also allows the anti-malware protected services to launch child processes as protected.</span></span> <span data-ttu-id="33665-224">Эти дочерние процессы будут выполняться на том же уровне защиты, что и родительская служба, а их двоичные файлы должны быть подписаны тем же сертификатом, который был зарегистрирован через раздел ресурсов ELAM.</span><span class="sxs-lookup"><span data-stu-id="33665-224">These child processes will run at the same protection level as the parent service and their binaries must be signed with the same certificate that has been registered via ELAM resource section.</span></span>

<span data-ttu-id="33665-225">Чтобы служба защиты от вредоносных программ запускала дочерний процесс как защищенный, был предоставлен новый ключ расширенного ключа атрибута, **\_ \_ \_ \_ уровень защиты атрибута** обрабатывающего потока, и его необходимо использовать с API [**упдатепроксреадаттрибуте**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) .</span><span class="sxs-lookup"><span data-stu-id="33665-225">In order to allow anti-malware protected service to launch child process as protected, a new extended attribute key, **PROC\_THREAD\_ATTRIBUTE\_PROTECTION\_LEVEL**, has been exposed and must be used with the [**UpdateProcThreadAttribute**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) API.</span></span> <span data-ttu-id="33665-226">Указатель на значение атрибута **\_ уровня \_ защиты** должен быть передан в API **упдатепроксреадаттрибуте** .</span><span class="sxs-lookup"><span data-stu-id="33665-226">A pointer to the attribute value of **PROTECTION\_LEVEL\_SAME** must be passed into the **UpdateProcThreadAttribute** API.</span></span>

<span data-ttu-id="33665-227">Примечания.</span><span class="sxs-lookup"><span data-stu-id="33665-227">Notes:</span></span>

-   <span data-ttu-id="33665-228">Чтобы использовать этот новый атрибут, служба также должна указать в параметре "флаг создания [**процесса" в вызове**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa) функции " **создать \_ защищенный \_ процесс** ".</span><span class="sxs-lookup"><span data-stu-id="33665-228">In order to use this new attribute, the service must also specify **CREATE\_PROTECTED\_PROCESS** in the process creation flags parameter of the [**CreateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa) call.</span></span>
-   <span data-ttu-id="33665-229">Необходимо, чтобы двоичные файлы службы были подписаны с помощью параметра/АК, чтобы включить перекрестные сертификаты, чтобы связать его с известным центром сертификации.</span><span class="sxs-lookup"><span data-stu-id="33665-229">You need to have your service binaries signed using the /ac switch to include the cross-certificate to chain it up to a known CA.</span></span> <span data-ttu-id="33665-230">Самозаверяющий сертификат без надлежащей цепочки для известного корневого ЦС не будет работать.</span><span class="sxs-lookup"><span data-stu-id="33665-230">Self-signed cert without proper chaining to a known root CA will not work.</span></span>

<span data-ttu-id="33665-231">Пример кода:</span><span class="sxs-lookup"><span data-stu-id="33665-231">Code example:</span></span>


```C++
DWORD ProtectionLevel = PROTECTION_LEVEL_SAME;
SIZE_T AttributeListSize;

STARTUPINFOEXW StartupInfoEx = { 0 };

StartupInfoEx.StartupInfo.cb = sizeof(StartupInfoEx);

if (InitializeProcThreadAttributeList(NULL,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

StartupInfoEx.lpAttributeList = (LPPROC_THREAD_ATTRIBUTE_LIST) HeapAlloc(
    GetProcessHeap(),
    0,
    AttributeListSize
    );

if (InitializeProcThreadAttributeList(StartupInfoEx.lpAttributeList,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

if (UpdateProcThreadAttribute(StartupInfoEx.lpAttributeList,
                              0,
                              PROC_THREAD_ATTRIBUTE_PROTECTION_LEVEL,
                              &ProtectionLevel,
                              sizeof(ProtectionLevel),
                              NULL,
                              NULL) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

PROCESS_INFORMATION ProcessInformation = { 0 };

if (CreateProcessW(ApplicationName,
                   CommandLine,
                   ProcessAttributes,
                   ThreadAttributes,
                   InheritHandles,
                   EXTENDED_STARTUPINFO_PRESENT | CREATE_PROTECTED_PROCESS,
                   Environment,
                   CurrentDirectory,
                   (LPSTARTUPINFOW)&StartupInfoEx,
                   &ProcessInformation) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



## <a name="updates-and-servicing"></a><span data-ttu-id="33665-232">Обновления и обслуживание</span><span class="sxs-lookup"><span data-stu-id="33665-232">Updates and servicing</span></span>

<span data-ttu-id="33665-233">После запуска службы защиты от вредоносных программ в качестве защищенных другие незащищенные процессы (и даже администраторы) не могут прекращать работу службы.</span><span class="sxs-lookup"><span data-stu-id="33665-233">After the anti-malware service is launched as protected, other non-protected processes (and even admins) aren't able to stop the service.</span></span> <span data-ttu-id="33665-234">В случае обновления двоичных файлов службы Служба защиты от вредоносных программ должна получить обратный вызов от установщика, чтобы его можно было обслуживать самостоятельно.</span><span class="sxs-lookup"><span data-stu-id="33665-234">In the case of updates to the service binaries, the anti-malware service needs to receive a callback from the installer to stop itself so that it can be serviced.</span></span> <span data-ttu-id="33665-235">После остановки службы установщик защиты от вредоносных программ может выполнить обновления, а затем выполнить описанные выше действия в разделе [Регистрация службы](https://www.bing.com/search?q=Registering+the+service) и [Запуск службы в качестве защищенных](#starting-the-service-as-protected) разделов для регистрации сертификата и запуска службы в качестве защищенной.</span><span class="sxs-lookup"><span data-stu-id="33665-235">After the service is stopped, the anti-malware installer can perform upgrades and then follow the steps described above in the [Registering the service](https://www.bing.com/search?q=Registering+the+service) and [Starting the service as protected](#starting-the-service-as-protected) sections to register the certificate and start the service as protected.</span></span>

<span data-ttu-id="33665-236">Обратите внимание, что служба должна гарантировать, что только доверенные вызывающие объекты могут прекращать работу службы.</span><span class="sxs-lookup"><span data-stu-id="33665-236">Note that the service should ensure that only trusted callers can stop the service.</span></span> <span data-ttu-id="33665-237">Разрешение ненадежных вызывающих объектов делает это не позволяет защитить службу.</span><span class="sxs-lookup"><span data-stu-id="33665-237">Allowing untrusted callers to do so defeats the purpose of protecting the service.</span></span>

### <a name="unregistering-the-service"></a><span data-ttu-id="33665-238">Отмена регистрации службы</span><span class="sxs-lookup"><span data-stu-id="33665-238">Unregistering the service</span></span>

<span data-ttu-id="33665-239">При удалении защищенной службы она должна пометить себя как незащищенную, вызвав API [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) .</span><span class="sxs-lookup"><span data-stu-id="33665-239">When you uninstall a protected service, the service must mark itself as unprotected by calling the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API.</span></span> <span data-ttu-id="33665-240">Обратите внимание, что поскольку система не позволяет любому незащищенному процессу изменять конфигурацию защищенной службы, вызов [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) должен выполняться самой защищенной службой.</span><span class="sxs-lookup"><span data-stu-id="33665-240">Note that because the system doesn't allow any non-protected process to alter the configuration of a protected service, the call to [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) must be made by the protected service itself.</span></span> <span data-ttu-id="33665-241">После того как служба будет перенастроена для запуска от имени без защиты, программа удаления может просто предпринять соответствующие действия для удаления программного обеспечения для защиты от вредоносных программ из системы.</span><span class="sxs-lookup"><span data-stu-id="33665-241">After the service has been reconfigured to run as unprotected, the uninstaller can simply take appropriate steps to remove the anti-malware software from the system.</span></span>

## <a name="debugging-an-anti-malware-protected-service"></a><span data-ttu-id="33665-242">Отладка защищенной службы защиты от вредоносных программ</span><span class="sxs-lookup"><span data-stu-id="33665-242">Debugging an anti-malware protected service</span></span>

<span data-ttu-id="33665-243">В рамках модели безопасности защищенного процесса другие незащищенные процессы не могут внедрять потоки или записывать в виртуальную память защищенного процесса.</span><span class="sxs-lookup"><span data-stu-id="33665-243">As part of the protected process security model, other non-protected processes aren't able to inject threads or write into the virtual memory of the protected process.</span></span> <span data-ttu-id="33665-244">Однако отладчик ядра (KD) разрешен для отладки любых процессов, защищенных от вредоносных программ.</span><span class="sxs-lookup"><span data-stu-id="33665-244">However a kernel debugger (KD) is allowed for debugging any anti-malware protected processes.</span></span> <span data-ttu-id="33665-245">KD также можно использовать для проверки того, работает ли служба защиты от вредоносных программ как защищенная.</span><span class="sxs-lookup"><span data-stu-id="33665-245">The KD can also be used to check if the anti-malware service is running as protected or not:</span></span>

``` syntax
dt –r1 nt!_EPROCESS <Process Address>
+0x67a Protection       : _PS_PROTECTION
      +0x000 Level            : 0x31 '1'
      +0x000 Type             : 0y0001
      +0x000 Signer           : 0y0011
```

<span data-ttu-id="33665-246">Если значение члена *типа* — 0y0001, служба работает как защищенная.</span><span class="sxs-lookup"><span data-stu-id="33665-246">If the value of the *Type* member is 0y0001, the service is running as protected.</span></span>

<span data-ttu-id="33665-247">Кроме того, в службе защиты от вредоносных программ разрешены только следующие команды SC:</span><span class="sxs-lookup"><span data-stu-id="33665-247">In addition, only the following SC commands are allowed on anti-malware protected service:</span></span>

-   `sc config start=Auto`
-   `sc qc`
-   `sc start`
-   `sc interrogate`
-   `sc sdshow`

<span data-ttu-id="33665-248">Если отладчик присоединен, используйте следующий флаг в реестре для прерывания работы отладчика при загрузке двоичных файлов без знака (или несоответствующих подписанных) в защищенную службу защиты от вредоносных программ.</span><span class="sxs-lookup"><span data-stu-id="33665-248">If the debugger is attached, use the following flag in the registry to break in the debugger when unsigned (or inappropriately signed) binaries are loaded into the anti-malware protected service.</span></span>

``` syntax
Key:   HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CI
Value: DebugFlags      REG_DWORD
```

<span data-ttu-id="33665-249">Установите значение **00000400** для прерывания в отладчике при сбое проверки подписи.</span><span class="sxs-lookup"><span data-stu-id="33665-249">Set the value to **00000400** to break in the debugger when the signature validation fails.</span></span>

> [!Note]  
> <span data-ttu-id="33665-250">Ограничения защищенных процессов:</span><span class="sxs-lookup"><span data-stu-id="33665-250">Protected Process limitations:</span></span>
>
> 1.  <span data-ttu-id="33665-251">Процессы, имеющие пользовательский интерфейс или графический интерфейс пользователя, не могут быть защищены из-за способа, которым ядро блокирует процесс в памяти и не допускает записи в него.</span><span class="sxs-lookup"><span data-stu-id="33665-251">Processes that have UI or a GUI cannot be protected because of the way the kernel locks a process in memory and does not allow writes to it.</span></span>
> 2.  <span data-ttu-id="33665-252">До Windows 10, версия 1703 (авторское обновление), защищенные процессы не могут использовать протоколы связи TLS или SSL из-за ограничений совместного использования сертификатов между локальным центром безопасности (LSA) и защищенным процессом.</span><span class="sxs-lookup"><span data-stu-id="33665-252">Prior to Windows 10, version 1703 (the Creators update), protected processes cannot use the TLS or SSL communication protocols due to limitations of certificate sharing between the Local Security Authority (LSA) and a protected process.</span></span>

 

## <a name="resources"></a><span data-ttu-id="33665-253">Ресурсы</span><span class="sxs-lookup"><span data-stu-id="33665-253">Resources</span></span>

<span data-ttu-id="33665-254">См. также:</span><span class="sxs-lookup"><span data-stu-id="33665-254">For more info, see:</span></span>

-   [<span data-ttu-id="33665-255">Ранний запуск антивредоносного ПО</span><span class="sxs-lookup"><span data-stu-id="33665-255">Early launch antimalware</span></span>](/windows/desktop/w8cookbook/secured-boot)
-   <span data-ttu-id="33665-256">[Защищенные процессы в Windows Vista](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="33665-256">[Protected Processes in Windows Vista](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span></span>
-   <span data-ttu-id="33665-257">[Настройка центра сертификации](/previous-versions/windows/desktop/ms755466(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="33665-257">[Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85))</span></span>
-   <span data-ttu-id="33665-258">[Установка центра сертификации](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span><span class="sxs-lookup"><span data-stu-id="33665-258">[Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span></span>
-   [<span data-ttu-id="33665-259">Определяемый пользователем ресурс</span><span class="sxs-lookup"><span data-stu-id="33665-259">User-Defined Resource</span></span>](/windows/desktop/menurc/user-defined-resource)

<span data-ttu-id="33665-260">В этой статье содержатся ссылки на эти функции Windows API:</span><span class="sxs-lookup"><span data-stu-id="33665-260">These Windows API functions are referenced in this article:</span></span>

-   [<span data-ttu-id="33665-261">**ChangeServiceConfig2**</span><span class="sxs-lookup"><span data-stu-id="33665-261">**ChangeServiceConfig2**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a)
-   [<span data-ttu-id="33665-262">**CreateProcess**</span><span class="sxs-lookup"><span data-stu-id="33665-262">**CreateProcess**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa)
-   [<span data-ttu-id="33665-263">**CreateService**</span><span class="sxs-lookup"><span data-stu-id="33665-263">**CreateService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-createservicea)
-   [<span data-ttu-id="33665-264">**инитиализепроксреадаттрибутелист**</span><span class="sxs-lookup"><span data-stu-id="33665-264">**InitializeProcThreadAttributeList**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-initializeprocthreadattributelist)
-   [<span data-ttu-id="33665-265">**инсталлеламцертификатеинфо**</span><span class="sxs-lookup"><span data-stu-id="33665-265">**InstallELAMCertificateInfo**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo)
-   [<span data-ttu-id="33665-266">**сетсервицеобжектсекурити**</span><span class="sxs-lookup"><span data-stu-id="33665-266">**SetServiceObjectSecurity**</span></span>](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity)
-   [<span data-ttu-id="33665-267">**StartService**</span><span class="sxs-lookup"><span data-stu-id="33665-267">**StartService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-startservicea)
-   [<span data-ttu-id="33665-268">**упдатепроксреадаттрибуте**</span><span class="sxs-lookup"><span data-stu-id="33665-268">**UpdateProcThreadAttribute**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute)

 

 
