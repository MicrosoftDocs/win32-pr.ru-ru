---
description: Каждая служба имеет обработчик управления, функцию обработчика, которая вызывается диспетчером управления, когда процесс службы получает управляющий запрос от программы управления службами.
ms.assetid: 437334ed-05fa-4ab6-aab3-dc2739113e19
title: Функция обработчика управления службой
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1303bff45421ee7206d02be9ee30066324648823
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105662354"
---
# <a name="service-control-handler-function"></a><span data-ttu-id="8572f-103">Функция обработчика управления службой</span><span class="sxs-lookup"><span data-stu-id="8572f-103">Service Control Handler Function</span></span>

<span data-ttu-id="8572f-104">Каждая служба имеет обработчик управления, функцию [**обработчика**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) , которая вызывается диспетчером управления, когда процесс службы получает управляющий запрос от программы управления службами.</span><span class="sxs-lookup"><span data-stu-id="8572f-104">Each service has a control handler, the [**Handler**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) function, that is invoked by the control dispatcher when the service process receives a control request from a service control program.</span></span> <span data-ttu-id="8572f-105">Поэтому эта функция выполняется в контексте диспетчера управления.</span><span class="sxs-lookup"><span data-stu-id="8572f-105">Therefore, this function executes in the context of the control dispatcher.</span></span> <span data-ttu-id="8572f-106">Пример см. в разделе [написание функции обработчика элемента управления](writing-a-control-handler-function.md).</span><span class="sxs-lookup"><span data-stu-id="8572f-106">For an example, see [Writing a Control Handler Function](writing-a-control-handler-function.md).</span></span>

<span data-ttu-id="8572f-107">Служба вызывает функцию [**регистерсервицектрлхандлер**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) или [**регистерсервицектрлхандлерекс**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlerexa) для регистрации функции обработчика управления службой.</span><span class="sxs-lookup"><span data-stu-id="8572f-107">A service calls the [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) or [**RegisterServiceCtrlHandlerEx**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlerexa) function to register its service control handler function.</span></span>

<span data-ttu-id="8572f-108">При вызове обработчика управления службами Служба должна вызвать функцию [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) , чтобы сообщить о своем состоянии SCM только в том случае, если обработка управляющего кода приводит к изменению состояния службы.</span><span class="sxs-lookup"><span data-stu-id="8572f-108">When the service control handler is invoked, the service must call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function to report its status to the SCM only if handling the control code causes the service status to change.</span></span> <span data-ttu-id="8572f-109">Если обработка управляющего кода не приводит к изменению состояния службы, нет необходимости вызывать **сбой SetServiceStatus**.</span><span class="sxs-lookup"><span data-stu-id="8572f-109">If handling the control code does not cause the service status to change, it is not necessary to call **SetServiceStatus**.</span></span>

<span data-ttu-id="8572f-110">Программа управления службами может отсылать управляющие запросы с помощью функции [**ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice) .</span><span class="sxs-lookup"><span data-stu-id="8572f-110">A service control program can send control requests using the [**ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice) function.</span></span> <span data-ttu-id="8572f-111">Все службы должны принять и обработать Управление службой, чтобы выполнить **\_ \_ опрос** управляющего кода.</span><span class="sxs-lookup"><span data-stu-id="8572f-111">All services must accept and process the **SERVICE\_CONTROL\_INTERROGATE** control code.</span></span> <span data-ttu-id="8572f-112">Вы можете включить или отключить принятие других управляющих кодов, вызвав [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span><span class="sxs-lookup"><span data-stu-id="8572f-112">You can enable or disable acceptance of the other control codes by calling [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span></span> <span data-ttu-id="8572f-113">Чтобы получить управляющий код **\_ \_ девицеевент управления службой** , необходимо вызвать функцию [**регистердевиценотификатион**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) .</span><span class="sxs-lookup"><span data-stu-id="8572f-113">To receive the **SERVICE\_CONTROL\_DEVICEEVENT** control code, you must call the [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) function.</span></span> <span data-ttu-id="8572f-114">Службы также могут выполнять дополнительные определяемые пользователем управляющие коды.</span><span class="sxs-lookup"><span data-stu-id="8572f-114">Services can also handle additional user-defined control codes.</span></span>

<span data-ttu-id="8572f-115">Если служба принимает **\_ управляющий код \_ остановки управления службой** , она должна остановиться при получении, перейдя в режим **\_ \_ ожидания остановки службы** или **\_ остановленное состояние службы** .</span><span class="sxs-lookup"><span data-stu-id="8572f-115">If a service accepts the **SERVICE\_CONTROL\_STOP** control code, it must stop upon receipt, going to either the **SERVICE\_STOP\_PENDING** or **SERVICE\_STOPPED** state.</span></span> <span data-ttu-id="8572f-116">После того как SCM отправит Этот управляющий код, он не будет отправлять другие управляющие коды.</span><span class="sxs-lookup"><span data-stu-id="8572f-116">After the SCM sends this control code, it will not send other control codes.</span></span>

<span data-ttu-id="8572f-117">**Windows XP:** Если служба не возвращает **\_ сообщение об ошибке и не** запускается, она по мере продолжения получает управляющие коды.</span><span class="sxs-lookup"><span data-stu-id="8572f-117">**Windows XP:** If the service returns **NO\_ERROR** and continues to run, it continues to receive control codes.</span></span> <span data-ttu-id="8572f-118">Это поведение изменилось начиная с Windows Server 2003 и Windows XP с пакетом обновления 2 (SP2).</span><span class="sxs-lookup"><span data-stu-id="8572f-118">This behavior changed starting with Windows Server 2003 and Windows XP with Service Pack 2 (SP2).</span></span>

<span data-ttu-id="8572f-119">Обработчик управления должен возвращать значение в течение 30 секунд, или SCM возвращает ошибку.</span><span class="sxs-lookup"><span data-stu-id="8572f-119">The control handler must return within 30 seconds, or the SCM returns an error.</span></span> <span data-ttu-id="8572f-120">Если служба должна выполнить длительную обработку, когда служба выполняет обработчик управления, он должен создать дополнительный поток для выполнения длительной обработки, а затем вернуться из обработчика управления.</span><span class="sxs-lookup"><span data-stu-id="8572f-120">If a service must do lengthy processing when the service is executing the control handler, it should create a secondary thread to perform the lengthy processing, and then return from the control handler.</span></span> <span data-ttu-id="8572f-121">Это предотвращает привязки к диспетчеру управления для службы.</span><span class="sxs-lookup"><span data-stu-id="8572f-121">This prevents the service from tying up the control dispatcher.</span></span> <span data-ttu-id="8572f-122">Например, при обработке запроса на завершение для службы, которая занимает много времени, создайте другой поток для обработки процесса завершения.</span><span class="sxs-lookup"><span data-stu-id="8572f-122">For example, when handling the stop request for a service that takes a long time, create another thread to handle the stop process.</span></span> <span data-ttu-id="8572f-123">Обработчик управления должен просто вызвать [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) с сообщением **о \_ \_ завершении ожидания службы** и вернуть.</span><span class="sxs-lookup"><span data-stu-id="8572f-123">The control handler should simply call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_STOP\_PENDING** message and return.</span></span>

<span data-ttu-id="8572f-124">Когда пользователь завершает работу системы, все обработчики управления, которые вызвали [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) со **службой, \_ принимают \_** код управления для предварительного завершения работы **службы \_ управления \_ службами** .</span><span class="sxs-lookup"><span data-stu-id="8572f-124">When the user shuts down the system, all control handlers that have called [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_ACCEPT\_PRESHUTDOWN** control code receive the **SERVICE\_CONTROL\_PRESHUTDOWN** control code.</span></span> <span data-ttu-id="8572f-125">Диспетчер управления службами ждет, пока служба не остановится или не истечет указанное значение времени ожидания для предварительного завершения (это значение можно задать с помощью функции [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) ).</span><span class="sxs-lookup"><span data-stu-id="8572f-125">The service control manager waits until the service stops or the specified preshutdown time-out value expires (this value can be set with the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) function).</span></span> <span data-ttu-id="8572f-126">Этот управляющий код следует использовать только в особых обстоятельствах, так как служба, которая обрабатывает это уведомление, блокирует завершение работы системы до тех пор, пока служба не прекратит работу или не истечет время ожидания перед завершением.</span><span class="sxs-lookup"><span data-stu-id="8572f-126">This control code should be used only in special circumstances, because a service that handles this notification blocks system shutdown until the service stops or the preshutdown time-out interval expires.</span></span>

<span data-ttu-id="8572f-127">После завершения уведомлений о завершении работы все обработчики управления, которые вызвали [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) с кодом управления " **\_ принять \_ Завершение работы службы** ", получают управляющий код **\_ \_ завершения работы управления службой** .</span><span class="sxs-lookup"><span data-stu-id="8572f-127">After the preshutdown notifications have been completed, all control handlers that have called [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_ACCEPT\_SHUTDOWN** control code receive the **SERVICE\_CONTROL\_SHUTDOWN** control code.</span></span> <span data-ttu-id="8572f-128">Они получают уведомления в том порядке, в котором они отображаются в базе данных установленных служб.</span><span class="sxs-lookup"><span data-stu-id="8572f-128">They are notified in the order that they appear in the database of installed services.</span></span> <span data-ttu-id="8572f-129">По умолчанию служба имеет приблизительно 20 секунд на выполнение задач очистки до завершения работы системы.</span><span class="sxs-lookup"><span data-stu-id="8572f-129">By default, a service has approximately 20 seconds to perform cleanup tasks before the system shuts down.</span></span> <span data-ttu-id="8572f-130">По истечении этого времени завершение работы системы продолжается независимо от того, завершено ли завершение работы службы.</span><span class="sxs-lookup"><span data-stu-id="8572f-130">After this time expires, system shutdown proceeds regardless of whether service shutdown is complete.</span></span> <span data-ttu-id="8572f-131">Обратите внимание, что если система остается в состоянии завершения работы (не перезапускается или не отключено), служба продолжит работу.</span><span class="sxs-lookup"><span data-stu-id="8572f-131">Note that if the system is left in the shutdown state (not restarted or powered down), the service continues to run.</span></span>

<span data-ttu-id="8572f-132">Если службе требуется больше времени для очистки, она отправляет **\_ ожидающие** сообщения о состоянии, а также указание ожидания, поэтому контроллеру службы известно, как долго следует ожидать перед отправкой отчетов в систему о завершении завершения работы службы.</span><span class="sxs-lookup"><span data-stu-id="8572f-132">If the service requires more time to cleanup, it sends **STOP\_PENDING** status messages, along with a wait hint, so the service controller knows how long to wait before reporting to the system that service shutdown is complete.</span></span> <span data-ttu-id="8572f-133">Однако, чтобы предотвратить остановку завершения работы службы, существует ограничение на время ожидания в контроллере службы.</span><span class="sxs-lookup"><span data-stu-id="8572f-133">However, to prevent a service from stopping shutdown, there is a limit to how long the service controller waits.</span></span> <span data-ttu-id="8572f-134">Если служба завершает работу через оснастку "службы", ограничение составляет 125 секунд или 125 000 миллисекунд.</span><span class="sxs-lookup"><span data-stu-id="8572f-134">If the service is being shut down through the Services snap-in, the limit is 125 seconds, or 125,000 milliseconds.</span></span> <span data-ttu-id="8572f-135">При перезагрузке операционной системы предельное значение времени указывается в значении **ваиттокиллсервицетимеаут** (в миллисекундах) следующего раздела реестра:</span><span class="sxs-lookup"><span data-stu-id="8572f-135">If the operating system is rebooting, the time limit is specified in the **WaitToKillServiceTimeout** value (in milliseconds) of the following registry key:</span></span>

<span data-ttu-id="8572f-136">**\_ \_ \\ \\ Элемент управления CurrentControlSet системы hKey локального компьютера \\**</span><span class="sxs-lookup"><span data-stu-id="8572f-136">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control**</span></span>

> [!IMPORTANT]
> <span data-ttu-id="8572f-137">Служба не должна пытаться увеличить предельное время, изменив это значение.</span><span class="sxs-lookup"><span data-stu-id="8572f-137">A service should not attempt to increase the time limit by modifying this value.</span></span> <span data-ttu-id="8572f-138">Если необходимо задать **ваиттокиллсервицетимеаут** вручную, значение должно быть в миллисекундах.</span><span class="sxs-lookup"><span data-stu-id="8572f-138">If you do need to set **WaitToKillServiceTimeout** by hand, the value should be in milliseconds.</span></span>

<span data-ttu-id="8572f-139">Клиентам требуется быстрое завершение работы операционной системы.</span><span class="sxs-lookup"><span data-stu-id="8572f-139">Customers require fast shutdown of the operating system.</span></span> <span data-ttu-id="8572f-140">Например, если компьютер, работающий под управлением ИБП, не может завершить работу до того, как ИБП выполнит питание, данные могут быть потеряны.</span><span class="sxs-lookup"><span data-stu-id="8572f-140">For example, if a computer running on UPS power cannot complete shutdown before the UPS runs out of power, data can be lost.</span></span> <span data-ttu-id="8572f-141">Поэтому службы должны выполнять свои задачи по очистке как можно быстрее.</span><span class="sxs-lookup"><span data-stu-id="8572f-141">Therefore, services should complete their cleanup tasks as quickly as possible.</span></span> <span data-ttu-id="8572f-142">Рекомендуется уменьшить объем несохраненных данных путем регулярного сохранения данных, отслеживания данных, сохраняемых на диске, и сохранения несохраненных данных при завершении работы.</span><span class="sxs-lookup"><span data-stu-id="8572f-142">It is a good practice to minimize unsaved data by saving data on a regular basis, keeping track of the data that is saved to disk, and only saving your unsaved data on shutdown.</span></span> <span data-ttu-id="8572f-143">Так как работа компьютера завершается, не следует тратить время на освобождение выделенной памяти или других системных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="8572f-143">Because the computer is being shut down, do not spend time releasing allocated memory or other system resources.</span></span> <span data-ttu-id="8572f-144">Если необходимо уведомить сервер о выходе из системы, сократите время, затрачиваемое на ожидание ответа, так как сетевые проблемы могут задержать завершение работы службы.</span><span class="sxs-lookup"><span data-stu-id="8572f-144">If you need to notify a server that you are exiting, minimize the time spent waiting for a reply, because network problems could delay the shutdown of your service.</span></span>

<span data-ttu-id="8572f-145">Обратите внимание, что во время завершения работы службы по умолчанию SCM не учитывает зависимости.</span><span class="sxs-lookup"><span data-stu-id="8572f-145">Note that during service shutdown, by default, the SCM does not take dependencies into consideration.</span></span> <span data-ttu-id="8572f-146">SCM перечисляет список выполняющихся служб и отправляет команду **\_ \_ завершения работы управления службой** .</span><span class="sxs-lookup"><span data-stu-id="8572f-146">The SCM enumerates the list of running services and sends the **SERVICE\_CONTROL\_SHUTDOWN** command.</span></span> <span data-ttu-id="8572f-147">Таким образом, может произойти сбой службы, так как другая служба, от которой она зависит, уже остановлена.</span><span class="sxs-lookup"><span data-stu-id="8572f-147">Therefore, a service may fail because another service it depends on has already stopped.</span></span>

<span data-ttu-id="8572f-148">Чтобы задать порядок завершения работы служб вручную, создайте значение реестра из множества строк, содержащее имена служб в том порядке, в котором они должны быть выключены, и назначьте их значению **прешутдовнордер** ключа управления следующим образом:</span><span class="sxs-lookup"><span data-stu-id="8572f-148">To set the shutdown order of services manually, create a multistring registry value that contains the service names in the order in which they should be shut down and assign it to the Control key's **PreshutdownOrder** value, as follows:</span></span>

<span data-ttu-id="8572f-149">**HKEY \_ локальный \_ компьютер \\ система \\ CurrentControlSet \\ элемент управления \\ прешутдовнордер = "порядок завершения работы"**</span><span class="sxs-lookup"><span data-stu-id="8572f-149">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\PreshutdownOrder="Shutdown Order"**</span></span>

<span data-ttu-id="8572f-150">Чтобы задать порядок завершения работы зависимых служб приложения, используйте функцию [**сетпроцессшутдовнпараметерс**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) .</span><span class="sxs-lookup"><span data-stu-id="8572f-150">To set the shutdown order of dependent services from your application, use the [**SetProcessShutdownParameters**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) function.</span></span> <span data-ttu-id="8572f-151">SCM использует эту функцию, чтобы дать обработчику 0x1E0 приоритет.</span><span class="sxs-lookup"><span data-stu-id="8572f-151">The SCM uses this function to give its handler 0x1E0 priority.</span></span> <span data-ttu-id="8572f-152">SCM отправляет уведомления **о \_ \_ завершении работы управления службой** при вызове обработчика управления и ожидает завершения работы служб перед возвратом из обработчика управления.</span><span class="sxs-lookup"><span data-stu-id="8572f-152">The SCM sends **SERVICE\_CONTROL\_SHUTDOWN** notifications when its control handler is called and waits for the services to exit before returning from its control handler.</span></span>

## <a name="related-topics"></a><span data-ttu-id="8572f-153">См. также</span><span class="sxs-lookup"><span data-stu-id="8572f-153">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="8572f-154">Написание функции обработчика элемента управления</span><span class="sxs-lookup"><span data-stu-id="8572f-154">Writing a Control Handler Function</span></span>](writing-a-control-handler-function.md)
</dt> </dl>

 

 
