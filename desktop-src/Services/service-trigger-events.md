---
description: Служба может зарегистрироваться для запуска или остановки при возникновении события триггера.
ms.assetid: ca02a3ae-b16a-4427-b6db-b935c9cf23b3
title: События триггера службы
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fdefd94b7896936f7ab4fc014647b08470611573
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "105664367"
---
# <a name="service-trigger-events"></a><span data-ttu-id="7488b-103">События триггера службы</span><span class="sxs-lookup"><span data-stu-id="7488b-103">Service Trigger Events</span></span>

<span data-ttu-id="7488b-104">Служба может зарегистрироваться для запуска или остановки при возникновении события триггера.</span><span class="sxs-lookup"><span data-stu-id="7488b-104">A service can register to be started or stopped when a trigger event occurs.</span></span> <span data-ttu-id="7488b-105">Это устраняет необходимость запуска служб при запуске системы или для опроса или активного ожидания события в службах. Служба может запускаться при необходимости, а не запускать автоматически независимо от того, есть ли у вас работа.</span><span class="sxs-lookup"><span data-stu-id="7488b-105">This eliminates the need for services to start when the system starts, or for services to poll or actively wait for an event; a service can start when it is needed, instead of starting automatically whether or not there is work to do.</span></span> <span data-ttu-id="7488b-106">Примеры предопределенных событий триггера включают поступление устройства указанного класса интерфейса устройства или доступность конкретного порта брандмауэра.</span><span class="sxs-lookup"><span data-stu-id="7488b-106">Examples of predefined trigger events include arrival of a device of a specified device interface class or availability of a particular firewall port.</span></span> <span data-ttu-id="7488b-107">Служба также может зарегистрироваться для создания пользовательского события триггера, созданного поставщиком [трассировки событий для Windows](../etw/event-tracing-portal.md) (ETW).</span><span class="sxs-lookup"><span data-stu-id="7488b-107">A service can also register for a custom trigger event generated by an [Event Tracing for Windows](../etw/event-tracing-portal.md) (ETW) provider.</span></span>

<span data-ttu-id="7488b-108">Windows **server 2008, Windows Vista, Windows server 2003 и Windows XP:** События триггера службы не поддерживаются до Windows Server 2008 R2 и Windows 7.</span><span class="sxs-lookup"><span data-stu-id="7488b-108">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** Service trigger events are not supported until Windows Server 2008 R2 and Windows 7.</span></span>

<span data-ttu-id="7488b-109">Триггер состоит из типа события триггера, подтипа события триггера, действия, выполняемого в ответ на событие триггера, и (для определенных типов событий триггера) одного или нескольких элементов данных, относящихся к триггеру.</span><span class="sxs-lookup"><span data-stu-id="7488b-109">A trigger consists of a trigger event type, a trigger event subtype, the action to be taken in response to the trigger event, and (for certain trigger event types) one or more trigger-specific data items.</span></span> <span data-ttu-id="7488b-110">Вместе с подтипами и элементами данных, зависящими от триггеров, указываются условия для уведомления службы о событии.</span><span class="sxs-lookup"><span data-stu-id="7488b-110">The subtype and the trigger-specific data items together specify the conditions for notifying the service of the event.</span></span> <span data-ttu-id="7488b-111">Формат элемента данных зависит от типа события триггера. элемент данных может быть двоичными данными, строкой или многострочной.</span><span class="sxs-lookup"><span data-stu-id="7488b-111">The format of a data item depends on the trigger event type; a data item can be binary data, a string, or a multistring.</span></span> <span data-ttu-id="7488b-112">Строки должны быть в Юникоде. Строки ANSI не поддерживаются.</span><span class="sxs-lookup"><span data-stu-id="7488b-112">Strings must be Unicode; ANSI strings are not supported.</span></span>

<span data-ttu-id="7488b-113">Для регистрации событий триггера служба вызывает [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) со **\_ \_ \_ сведениями о триггере конфигурации службы** и предоставляет [**\_ \_ информационную структуру триггера службы**](/windows/desktop/api/winsvc/ns-winsvc-service_trigger_info) .</span><span class="sxs-lookup"><span data-stu-id="7488b-113">To register for trigger events, the service calls [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) with **SERVICE\_CONFIG\_TRIGGER\_INFO** and supplies a [**SERVICE\_TRIGGER\_INFO**](/windows/desktop/api/winsvc/ns-winsvc-service_trigger_info) structure.</span></span> <span data-ttu-id="7488b-114">Структура **\_ \_ сведений о триггере службы** указывает на массив структур [**\_ триггеров служб**](/windows/desktop/api/winsvc/ns-winsvc-service_trigger) , каждый из которых указывает один триггер.</span><span class="sxs-lookup"><span data-stu-id="7488b-114">The **SERVICE\_TRIGGER\_INFO** structure points to an array of [**SERVICE\_TRIGGER**](/windows/desktop/api/winsvc/ns-winsvc-service_trigger) structures, each specifying one trigger.</span></span>

<span data-ttu-id="7488b-115">Заданное действие триггера принимается, если условие триггера имеет значение true при запуске системы или если условие триггера принимает значение true во время работы системы.</span><span class="sxs-lookup"><span data-stu-id="7488b-115">The specified trigger action is taken if the trigger condition is true when the system starts, or if the trigger condition becomes true while the system is running.</span></span> <span data-ttu-id="7488b-116">Например, если служба регистрируется для запуска при наличии определенного устройства, служба запускается при запуске системы, если устройство уже подключено к компьютеру. Служба запускается при появлении устройства, когда пользователь подключается к устройству во время работы системы.</span><span class="sxs-lookup"><span data-stu-id="7488b-116">For example, if a service registers to be started when a particular device is available, the service is started when the system starts if the device is already plugged in to the computer; the service is started when the device arrives if the user plugs in the device while the system is running.</span></span>

<span data-ttu-id="7488b-117">Если триггер содержит элементы данных, относящиеся к триггеру, действие триггера выполняется только в том случае, если элемент данных, сопровождающий событие Trigger, соответствует одному из элементов данных, указанных в службе с триггером.</span><span class="sxs-lookup"><span data-stu-id="7488b-117">If a trigger has trigger-specific data items, the trigger action is taken only if the data item that accompanies the trigger event matches one of the data items that the service specified with the trigger.</span></span> <span data-ttu-id="7488b-118">Сопоставление двоичных данных выполняется побитовым сравнением.</span><span class="sxs-lookup"><span data-stu-id="7488b-118">Binary data matching is done by bitwise comparison.</span></span> <span data-ttu-id="7488b-119">Сопоставление строк не учитывает регистр.</span><span class="sxs-lookup"><span data-stu-id="7488b-119">String matching is case-insensitive.</span></span> <span data-ttu-id="7488b-120">Если элемент данных является многострочным, все строки в многострочной строке должны совпадать.</span><span class="sxs-lookup"><span data-stu-id="7488b-120">If the data item is a multistring, all strings in the multistring must match.</span></span>

<span data-ttu-id="7488b-121">Когда служба запускается в ответ на событие триггера, служба получает в качестве аргумента *argv* в своей функции обратного вызова функцию " **\_ \_ Started \_ " триггера службы** \[ \] . [](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona)</span><span class="sxs-lookup"><span data-stu-id="7488b-121">When a service is started in response to a trigger event, the service receives **SERVICE\_TRIGGER\_STARTED\_ARGUMENT** as *argv*\[1\] in its [*ServiceMain*](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) callback function.</span></span> <span data-ttu-id="7488b-122">*Argv* \[ 0 \] всегда является коротким именем службы.</span><span class="sxs-lookup"><span data-stu-id="7488b-122">*Argv*\[0\] is always the short name of the service.</span></span>

<span data-ttu-id="7488b-123">Служба, которая регистрируется для запуска в ответ на событие триггера, может прекращать свою работу после истечения времени простоя, когда служба не работает.</span><span class="sxs-lookup"><span data-stu-id="7488b-123">A service that registers to be started in response to a trigger event might stop itself after an idle time-out when the service has no work to do.</span></span> <span data-ttu-id="7488b-124">Служба, которая останавливается, должна быть подготовлена к обработке запросов контроля **\_ \_ тригжеревент управления службами** , поступающих во время остановки службы.</span><span class="sxs-lookup"><span data-stu-id="7488b-124">A service that stops itself must be prepared to handle **SERVICE\_CONTROL\_TRIGGEREVENT** control requests that arrive while the service is stopping itself.</span></span> <span data-ttu-id="7488b-125">SCM отправляет запрос на **Управление \_ \_ тригжеревент управления службой** всякий раз, когда возникает новое событие триггера, когда служба находится в состоянии выполняется.</span><span class="sxs-lookup"><span data-stu-id="7488b-125">The SCM sends a **SERVICE\_CONTROL\_TRIGGEREVENT** control request whenever a new trigger event occurs while the service is in the running state.</span></span> <span data-ttu-id="7488b-126">Чтобы избежать потери событий триггера, служба должна возвращать **ошибку \_ завершения работы \_ \_** для любого управляющего запроса **\_ \_ тригжеревент управления службой** , который поступает во время перехода службы из состояния выполнения в остановленную.</span><span class="sxs-lookup"><span data-stu-id="7488b-126">To avoid losing trigger events, the service should return **ERROR\_SHUTDOWN\_IN\_PROGRESS** for any **SERVICE\_CONTROL\_TRIGGEREVENT** control request that arrives while the service is transitioning from running to stopped.</span></span> <span data-ttu-id="7488b-127">Это дает диспетчеру управления службами команду ставить в очередь события триггера и дожидаться перехода службы в остановленное состояние.</span><span class="sxs-lookup"><span data-stu-id="7488b-127">This instructs the SCM to queue trigger events and wait for the service to enter the stopped state.</span></span> <span data-ttu-id="7488b-128">Затем SCM выполняет действие, связанное с событием триггера в очереди, например запуск службы.</span><span class="sxs-lookup"><span data-stu-id="7488b-128">The SCM then takes the action associated with the queued trigger event, such as starting the service.</span></span>

<span data-ttu-id="7488b-129">Когда служба будет готова к обработке событий триггера, она задается в параметре **\_ Accept \_ тригжеревент** в элементах управления — принимает маску в вызове [**сбой SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span><span class="sxs-lookup"><span data-stu-id="7488b-129">When the service is ready to handle trigger events again, it sets **SERVICE\_ACCEPT\_TRIGGEREVENT** in its controls-accepted mask in a call to [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span></span> <span data-ttu-id="7488b-130">Обычно это делается, когда служба вызывает **сбой SetServiceStatus** с **\_ работающей службой**.</span><span class="sxs-lookup"><span data-stu-id="7488b-130">This is usually done when the service calls **SetServiceStatus** with **SERVICE\_RUNNING**.</span></span> <span data-ttu-id="7488b-131">После этого диспетчер SCM выдает запрос на **\_ \_ тригжеревент управления службой** для каждого события триггера, помещенного в очередь, пока очередь не будет пуста.</span><span class="sxs-lookup"><span data-stu-id="7488b-131">The SCM then issues a **SERVICE\_CONTROL\_TRIGGEREVENT** request for each queued trigger event until the queue is empty.</span></span>

<span data-ttu-id="7488b-132">Служба, в которой запущены зависимые службы, не может быть остановлена в ответ на событие триггера.</span><span class="sxs-lookup"><span data-stu-id="7488b-132">A service that has dependent services running cannot be stopped in response to a trigger event.</span></span>

<span data-ttu-id="7488b-133">В условиях нехватки памяти не гарантируется выполнение запросов триггера и триггера.</span><span class="sxs-lookup"><span data-stu-id="7488b-133">Trigger-start and trigger-stop requests are not guaranteed under low memory conditions.</span></span>

<span data-ttu-id="7488b-134">Используйте функцию [**QueryServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-queryserviceconfig2a) для получения конфигурации события триггера службы.</span><span class="sxs-lookup"><span data-stu-id="7488b-134">Use the [**QueryServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-queryserviceconfig2a) function to retrieve a service’s trigger event configuration.</span></span>

<span data-ttu-id="7488b-135">Средство SC (sc.exe) можно использовать для настройки или запроса событий триггера службы в командной строке.</span><span class="sxs-lookup"><span data-stu-id="7488b-135">The SC tool (sc.exe) can be used to configure or query a service’s trigger events at the command prompt.</span></span> <span data-ttu-id="7488b-136">Используйте параметр **тригжеринфо** , чтобы настроить службу для запуска или завершения в ответ на событие триггера.</span><span class="sxs-lookup"><span data-stu-id="7488b-136">Use the **triggerinfo** option to configure a service to start or stop in response to a trigger event.</span></span> <span data-ttu-id="7488b-137">Используйте параметр **ктригжеринфо** для запроса конфигурации триггера службы.</span><span class="sxs-lookup"><span data-stu-id="7488b-137">Use the **qtriggerinfo** option to query the trigger configuration of a service.</span></span>

<span data-ttu-id="7488b-138">В следующем примере выполняется запрос конфигурации триггера службы W32Time, которая настроена на запуск при присоединении компьютера к домену, и останавливается, когда компьютер покидает домен.</span><span class="sxs-lookup"><span data-stu-id="7488b-138">The following example queries the trigger configuration of the W32time service, which is configured to start when the computer is joined to a domain and stop when the computer leaves the domain.</span></span>

``` syntax
C:\>sc qtriggerinfo w32time
[SC] QueryServiceConfig2 SUCCESS

SERVICE_NAME: w32time

        START SERVICE
          DOMAIN JOINED STATUS         : 1ce20aba-9851-4421-9430-1ddeb766e809 [DOMAIN JOINED]
        STOP SERVICE
          DOMAIN JOINED STATUS         : ddaf516e-58c2-4866-9574-c3b615d42ea1 [NOT DOMAIN JOINED]
```

<span data-ttu-id="7488b-139">В следующем примере выполняется запрос конфигурации триггера для службы ввода планшета, которая настроена на запуск при появлении устройства HID с **идентификатором GUID** {4d1e55b2-f16f-11CF-88cb-001111000030} и любым из указанных идентификаторов устройств HID.</span><span class="sxs-lookup"><span data-stu-id="7488b-139">The following example queries the trigger configuration of the tablet input service, which is configured to start when a HID device with the **GUID** {4d1e55b2-f16f-11cf-88cb-001111000030} and any of the specified HID device IDs arrives.</span></span>

``` syntax
C:\>sc qtriggerinfo tabletinputservice
[SC] QueryServiceConfig2 SUCCESS

SERVICE_NAME: tabletinputservice

        START SERVICE
          DEVICE INTERFACE ARRIVAL     : 4d1e55b2-f16f-11cf-88cb-001111000030 [INTERFACE CLASS GUID]
            DATA                       : HID_DEVICE_UP:000D_U:0001
            DATA                       : HID_DEVICE_UP:000D_U:0002
            DATA                       : HID_DEVICE_UP:000D_U:0003
            DATA                       : HID_DEVICE_UP:000D_U:0004
```

 

 
