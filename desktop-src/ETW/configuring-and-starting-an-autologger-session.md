---
description: Сеанс трассировки событий авторегистратора записывает события, происходящие на ранних этапах процесса загрузки операционной системы.
ms.assetid: df5a79f4-abbf-4b83-afc3-cbd14b166067
title: Настройка и запуск сеанса авторегистратора
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6560aece87506b1d064981ee5f49a56bbf0da19e
ms.sourcegitcommit: 967ba3a2a618e6088cb607164a2a924530278645
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/30/2021
ms.locfileid: "113102043"
---
# <a name="configuring-and-starting-an-autologger-session"></a>Настройка и запуск сеанса авторегистратора

Сеанс трассировки событий авторегистратора записывает события, происходящие на ранних этапах процесса загрузки операционной системы. Приложения и драйверы устройств могут использовать сеанс авторегистратора для записи трассировок перед входом пользователя в систему. Обратите внимание, что некоторые драйверы устройств, например драйверы дисковых устройств, не загружаются во время начала сеанса авторегистратора.

Авторегистратор отличается от глобального средства ведения журнала следующими способами.

-   Можно указать один или несколько сеансов авторегистратора (глобальное средство ведения журнала было единственным сеансом, в котором регистрируются события).
-   Авторегистратор отправляет поставщикам уведомления о включении при запуске сеанса (глобальное средство ведения журнала не отправляло уведомления о включении поставщикам, поэтому поставщики должны были полагаться на другие средства, чтобы выяснить, был ли запущен глобальный сеанс ведения журнала для начала ведения журнала событий).
-   Авторегистратор не поддерживает ведение журнала событий системного журнала NT (см. элемент **енаблефлагс** в [**\_ \_ свойствах трассировки событий**](/windows/win32/api/evntrace/ns-evntrace-event_trace_properties)). Чтобы вести журнал событий журнала ядра NT, необходимо использовать [глобальное средство ведения журнала](configuring-and-starting-the-global-logger-session.md).

Дополнительные сведения о соотношении глобального средства ведения журнала см. в разделе [Настройка и запуск сеанса глобального журнала](configuring-and-starting-the-global-logger-session.md).

> [!Note]  
> ETW поддерживает авторегистратор в Windows Vista и более поздних версиях. Используйте [глобальное средство ведения журнала](configuring-and-starting-the-global-logger-session.md) в более ранних операционных системах.

 

Для настройки сеанса авторегистратора используется реестр. Добавьте следующий раздел реестра, если он еще не указан:

```
HKEY_LOCAL_MACHINE
   \SYSTEM
      \CurrentControlSet
         \Control
            \WMI
               \Autologger
```

В разделе **авторегистратор** создайте ключ для каждого сеанса авторегистратора, который необходимо настроить, как показано в следующем примере.

```
HKEY_LOCAL_MACHINE
   \SYSTEM
      \CurrentControlSet
         \Control
            \WMI
               \Autologger
                  \Logger Session A
                  \Logger Session B
                  \Logger Session C
```

Для каждого сеанса создайте ключ для каждого поставщика, который необходимо включить в сеанс. Используйте идентификатор GUID поставщика в качестве ключа.

```
HKEY_LOCAL_MACHINE
   \SYSTEM
      \CurrentControlSet
         \Control
            \WMI
               \Autologger
                  \Logger Session A
                     \{ProviderGuid1}
                     \{ProviderGuid2}
                  \Logger Session B
                  \Logger Session C
```

В следующей таблице описаны значения, которые можно определить для каждого сеанса авторегистратора. Для задания этих значений реестра необходимо иметь права администратора. Значения **Start** и **GUID** являются единственными значениями, необходимыми для запуска сеанса авторегистратора. все остальные значения имеют параметры по умолчанию, которые используются, если значение отсутствует в реестре. Как правило, следует использовать значения по умолчанию. Если указано значение, которое ETW не поддерживает, ETW переопределит это значение.



<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Значение</th>
<th>Type</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>BufferSize</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Размер каждого буфера в килобайтах. Должно быть меньше одного мегабайта. Для вычисления этого значения ETW использует размер физической памяти.<br/></td>
</tr>
<tr class="even">
<td><strong>клокктипе</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Таймер, используемый при записи отметки времени для каждого события.
<ul>
<li>1 = значение счетчика производительности (высокое разрешение)</li>
<li>2 = системный таймер</li>
<li>3 = счетчик циклов ЦП</li>
</ul>
Описание каждого типа часов см. в описании элемента <strong>ClientContext</strong> в <a href="wnode-header.md"><strong>WNODE_HEADER</strong></a>.<br/> Значение по умолчанию — 1 (значение счетчика производительности) в Windows Vista и более поздних версиях. До Windows Vista значение по умолчанию — 2 (системный таймер).<br/></td>
</tr>
<tr class="odd">
<td><strong>дисаблереалтимеперсистенце</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Чтобы отключить сохраняемость в режиме реального времени, задайте для этого параметра значение 1. Значение по умолчанию — 0 (включено) для сеансов реального времени.<br/> Если включено сохранение в реальном времени, события в реальном времени, которые не были доставлены на момент завершения работы компьютера, будут сохранены. Затем события будут доставлены потребителю при следующем подключении потребителя к сеансу. <br/></td>
</tr>
<tr class="even">
<td><strong>филекаунтер</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Не устанавливайте или не изменяйте это значение. Это серийный номер, используемый для увеличения имени файла журнала, если задано значение <strong>филемакс</strong> . Если значение недопустимо, то предполагается 1.<br/></td>
</tr>
<tr class="odd">
<td><strong>FileName</strong></td>
<td><strong>REG_SZ</strong></td>
<td>Полный путь к файлу журнала. Путь к этому файлу должен существовать. Файл журнала является последовательным файлом журнала. Длина пути ограничена 1024 символами.<br/> Если <strong>имя файла</strong> не указано, события записываются в%systemroot%\System32\LogFiles\WMI \& lt; sessionname &gt; . ETL. <br/></td>
</tr>
<tr class="even">
<td><strong>филемакс</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Максимальное число экземпляров файла журнала, создаваемых ETW. Если файл журнала, указанный в файле <strong>filename</strong> , существует, ETW добавляет значение <strong>филекаунтер</strong> к имени файла. Например, если используется имя файла журнала по умолчанию, то используется форма%SystemRoot%\System32\LogFiles\WMI \& lt; sessionname &gt; . ETL. NNNN. <br/> При первом запуске компьютера имя файла — &lt; sessionname &gt; . ETL. 0001, второй раз — имя файла &lt; sessionname &gt; . ETL. 0002 и т. д. Если <strong>филемакс</strong> имеет значение 3, то при четвертом перезапуске компьютера ТРАССИРОВКА событий Windows сбрасывает счетчик в значение 1 и перезаписывает. &lt; &gt; ETL. 0001, если он существует.<br/> Максимальное число поддерживаемых экземпляров файла журнала — 16.<br/> Не используйте эту функцию в режиме файла журнала <a href="logging-mode-constants.md">EVENT_TRACE_FILE_MODE_NEWFILE</a> .<br/></td>
</tr>
<tr class="odd">
<td><strong>флуштимер</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Частота принудительного сброса буферов трассировки в секундах. Минимальное время записи на диск — 1 секунда. Этот принудительный сброс находится в дополнение к автоматическому сбросу, который происходит при заполнении буфера и остановке сеанса трассировки. <br/> В случае средства ведения журнала в реальном времени значение 0 (значение по умолчанию) означает, что время очистки будет равно 1 секунде. Средство ведения журнала в режиме реального времени используется, когда <strong>логфилемоде</strong> имеет значение <strong>EVENT_TRACE_REAL_TIME_MODE</strong>.<br/> Значение по умолчанию — 0. По умолчанию буферы сбрасываются только в том случае, если они заполнены. <br/></td>
</tr>
<tr class="even">
<td><strong>Устройства</strong></td>
<td><strong>REG_SZ</strong></td>
<td>Строка, содержащая идентификатор GUID, однозначно определяющий сеанс. Это значение обязательно.</td>
</tr>
<tr class="odd">
<td><strong>логфилемоде</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Укажите один или несколько режимов ведения журнала. Возможные значения см. в разделе <a href="logging-mode-constants.md">константы режима ведения журнала</a>. Значение по умолчанию — <strong>EVENT_TRACE_FILE_MODE_SEQUENTIAL</strong>. Вместо записи в файл журнала можно указать либо <strong>EVENT_TRACE_BUFFERING_MODE</strong> , либо <strong>EVENT_TRACE_REAL_TIME_MODE</strong>.<br/> Указание <strong>EVENT_TRACE_BUFFERING_MODE</strong> позволяет избежать издержек на сброс содержимого сеанса на диск после того, как файловая система станет доступной. <br/> Обратите внимание, что использование <strong>EVENT_TRACE_BUFFERING_MODE</strong> приведет к тому, что система будет игнорировать значение <strong>максимумбуфферс</strong> , так как размер буфера будет таким же, как и произведение <strong>MinimumBuffers</strong> и <strong>bufferSize</strong>.<br/> Сеансы авторегистратора не поддерживают режим ведения журнала <strong>EVENT_TRACE_FILE_MODE_NEWFILE</strong> .<br/> Если указан параметр <strong>EVENT_TRACE_FILE_MODE_APPEND</strong> , то параметр <strong>bufferSize</strong> должен быть явно задан и должен быть одинаковым в средстве ведения журнала и в добавляемом файле.<br/></td>
</tr>
<tr class="even">
<td><strong>MaxFileSize</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Максимальный размер файла журнала в мегабайтах. Сеанс закрывается по достижении максимального размера, если не используется циклический режим файла журнала. Чтобы не задавать ограничение, задайте значение 0. Значение по умолчанию — 100 МБ, если не задано. Поведение, которое происходит при достижении максимального размера файла, зависит от значения <strong>логфилемоде</strong>.<br/></td>
</tr>
<tr class="odd">
<td><strong>MaximumBuffers</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Максимальное количество выделяемых буферов. Обычно это значение является минимальным числом буферов плюс двадцать. Для вычисления этого значения ETW использует размер буфера и размер физической памяти. Это значение должно быть больше или равно значению для <strong>MinimumBuffers</strong>.<br/></td>
</tr>
<tr class="even">
<td><strong>MinimumBuffers</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Минимальное число буферов, выделяемых при запуске. Минимальное число буферов, которые можно указать, — два буфера на процессор. Например, на компьютере с одним процессором минимальное число буферов равно двум.<br/></td>
</tr>
<tr class="odd">
<td><strong>Запуск</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Чтобы сеанс авторегистратора запускался при следующем перезапуске компьютера, присвойте этому параметру значение 1; в противном случае присвойте этому параметру значение 0.<br/></td>
</tr>
<tr class="even">
<td><strong>Состояние</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Состояние запуска авторегистратора. Если не удалось запустить авторегистратор, значение этого раздела соответствует коду ошибки Win32. Если авторегистратор успешно запущен, значение этого параметра — <strong>ERROR_SUCCESS</strong> (0).<br/></td>
</tr>
</tbody>
</table>



 

В следующей таблице описаны значения, которые можно определить для каждого поставщика, который необходимо включить в сеанс. Для задания этих значений реестра необходимо иметь права администратора. Если указано значение, которое ETW не поддерживает, ETW переопределит это значение.



<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Значение</th>
<th>Type</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Enabled</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Определяет, включен ли поставщик. Чтобы включить поставщик, присвойте этому параметру значение 1. Чтобы отключить поставщик, присвойте этому параметру значение 0. Значение по умолчанию равно 0.</td>
</tr>
<tr class="even">
<td><strong>енаблефлагс</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Определяемое поставщиком значение, указывающее класс событий, для которых поставщик создает события. Дополнительные сведения см. в описании параметра <em>енаблефлагс</em> функции <a href="/windows/win32/api/evntrace/nf-evntrace-enabletrace"><strong>енаблетраце</strong></a> . Укажите это имя значения, если поставщик не поддерживает <strong>матчаникэйворд</strong> или <strong>матчаллкэйворд</strong>.</td>
</tr>
<tr class="odd">
<td><strong>енаблелевел</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Определяемое поставщиком значение, указывающее уровень детализации, включаемый в событие. Например, это значение можно использовать для указания степени серьезности событий (информационное, предупреждение, ошибка), создаваемых поставщиком. Список предварительно определенных уровней см. в описании параметра <em>Level</em> функции <a href="/windows/win32/api/evntrace/nf-evntrace-enabletraceex"><strong>енаблетрацеекс</strong></a> .</td>
</tr>
<tr class="even">
<td><strong>енаблепроперти</strong></td>
<td><strong>REG_DWORD</strong></td>
<td>Используйте это значение, чтобы включить в файл журнала один или несколько следующих элементов:
<ul>
<li><strong>EVENT_ENABLE_PROPERTY_SID</strong> (0x00000001) = включить в Расширенные данные идентификатор безопасности (SID) пользователя.</li>
<li><strong>EVENT_ENABLE_PROPERTY_TS_ID</strong> (0x00000002) = включить в Расширенные данные идентификатор сеанса терминала.</li>
<li><strong>EVENT_ENABLE_PROPERTY_STACK_TRACE</strong> (0x00000004) = включить в Расширенные данные трассировку стека вызовов для событий, написанных с помощью <a href="/windows/desktop/api/Evntprov/nf-evntprov-eventwrite"><strong>EventWrite</strong></a>.</li>
<li><strong>EVENT_ENABLE_PROPERTY_IGNORE_KEYWORD_0</strong> (0x00000010) = отфильтровывает все события, для которых не указано ключевое слово, отличное от нуля.</li>
<li><strong>EVENT_ENABLE_PROPERTY_PROVIDER_GROUP</strong> (0x00000020) = указывает, что этот вызов <a href="/windows/win32/api/evntrace/nf-evntrace-enabletraceex2"><strong>EnableTraceEx2</strong></a> должен включать <a href="provider-traits.md">группу поставщиков</a> , а не отдельный поставщик событий.</li>
<li><strong>EVENT_ENABLE_PROPERTY_PROCESS_START_KEY</strong> (0x00000080) = включить стартовый ключ процесса в Расширенные данные.</li>
<li><strong>EVENT_ENABLE_PROPERTY_EVENT_KEY</strong> (0x00000100) = включить ключ события в Расширенные данные.</li>
<li><strong>EVENT_ENABLE_PROPERTY_EXCLUDE_INPRIVATE</strong> (0x00000200) = отфильтровывает все события, помеченные как события InPrivate или поступающие из процесса, помеченного как InPrivate.</li>
</ul>
Дополнительные сведения об этих элементах см. в разделе <strong>енаблепроперти</strong> структуры <a href="/windows/win32/api/evntrace/ns-evntrace-enable_trace_parameters"><strong>ENABLE_TRACE_PARAMETERS</strong></a> .<br/></td>
</tr>
<tr class="odd">
<td><strong>матчаникэйворд</strong></td>
<td><strong>REG_QWORD</strong></td>
<td>Битовая маска ключевых слов, определяющая категорию событий, которые должен записывать поставщик. Поставщик записывает событие, если любое из битов ключевых слов события соответствует любому из битов, заданных в этой маске. Чтобы указать, что поставщик записывает все события, присвойте этому параметру значение 0. Пример см. в разделе "Примечания" функции <a href="/windows/win32/api/evntrace/nf-evntrace-enabletraceex"><strong>енаблетрацеекс</strong></a> .</td>
</tr>
<tr class="even">
<td><strong>матчаллкэйворд</strong></td>
<td><strong>REG_QWORD</strong></td>
<td>Эта битовая маска является необязательной. Кроме того, эта маска позволяет ограничить категорию событий, которые должен записывать поставщик. Если ключевое слово события соответствует условию <em>матчаникэйворд</em> , поставщик будет записывать событие только в том случае, если все биты в этой маске существуют в ключевом слове события. Эта маска не используется, если <em>матчаникэйворд</em> имеет нулевое значение. Пример см. в разделе "Примечания" функции <a href="/windows/win32/api/evntrace/nf-evntrace-enabletraceex"><strong>енаблетрацеекс</strong></a> .</td>
</tr>
</tbody>
</table>



 

После изменения реестра сеанс авторегистратора запускается при следующем перезапуске компьютера. Сеанс авторегистратора вызывает функцию [**енаблетрацеекс**](/windows/win32/api/evntrace/nf-evntrace-enabletraceex) для включения поставщиков.

Сеансы авторегистратора увеличивают время загрузки системы и должны использоваться с осторожностью. Службы, которые хотят собирать информацию во время процесса загрузки, должны рассмотреть возможность добавления логики контроллера к самой себе вместо использования сеанса авторегистратора.

Чтобы прерывать сеанс авторегистратора, вызовите функцию [**контролтраце**](/windows/win32/api/evntrace/nf-evntrace-controltracea) . Имя сеанса, передаваемое в функцию, является именем раздела реестра, который использовался для определения сеанса в реестре.

В Windows 8.1, в Windows Server 2012 R2 и более поздних версиях фильтры анализа полезных данных события, области действия и стека могут использоваться функцией [**EnableTraceEx2**](/windows/win32/api/evntrace/nf-evntrace-enabletraceex2) , [**а \_ \_ параметры включения трассировки**](/windows/win32/api/evntrace/ns-evntrace-enable_trace_parameters) и [**\_ \_ дескриптора фильтра событий**](/windows/desktop/api/Evntprov/ns-evntprov-event_filter_descriptor) — для фильтрации по конкретным условиям сеанса ведения журнала. Дополнительные сведения о фильтрах полезных данных событий см. в статьях функции [**тдхкреатепайлоадфилтер**](/windows/desktop/api/Tdh/nf-tdh-tdhcreatepayloadfilter)и [**тдхаггрегатепайлоадфилтерс**](/windows/desktop/api/Tdh/nf-tdh-tdhaggregatepayloadfilters) , а также структуры [**\_ \_ предикатов**](/windows/desktop/api/Tdh/ns-tdh-payload_filter_predicate) **включения \_ трассировки \_**, **\_ \_ дескриптора фильтра событий** и фильтра полезных данных.

Дополнительные сведения о запуске сеанса трассировки событий см. в разделе [Настройка и запуск сеанса трассировки событий](configuring-and-starting-an-event-tracing-session.md).

Дополнительные сведения о запуске закрытого сеанса ведения журнала см. в разделе [Настройка и запуск закрытого сеанса ведения журнала](configuring-and-starting-a-private-logger-session.md).

Дополнительные сведения о запуске сеанса ведения журнала ядра NT см. в разделе [Настройка и запуск сеанса ведения журнала ядра NT](configuring-and-starting-the-nt-kernel-logger-session.md).

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Настройка и запуск закрытого сеанса ведения журнала](configuring-and-starting-a-private-logger-session.md)
</dt> <dt>

[Настройка и запуск сеанса Системтрацепровидер](configuring-and-starting-a-systemtraceprovider-session.md)
</dt> <dt>

[Настройка и запуск сеанса трассировки событий](configuring-and-starting-an-event-tracing-session.md)
</dt> <dt>

[Настройка и запуск сеанса ведения журнала ядра NT](configuring-and-starting-the-nt-kernel-logger-session.md)
</dt> <dt>

[**EnableTraceEx2**](/windows/win32/api/evntrace/nf-evntrace-enabletraceex2)
</dt> <dt>

[**ВКЛЮЧИТЬ \_ \_ Параметры трассировки**](/windows/win32/api/evntrace/ns-evntrace-enable_trace_parameters)
</dt> <dt>

[**\_дескриптор фильтра \_ событий**](/windows/desktop/api/Evntprov/ns-evntprov-event_filter_descriptor)
</dt> <dt>

[**\_предикат фильтра полезных данных \_**](/windows/desktop/api/Tdh/ns-tdh-payload_filter_predicate)
</dt> <dt>

[**тдхаггрегатепайлоадфилтерс**](/windows/desktop/api/Tdh/nf-tdh-tdhaggregatepayloadfilters)
</dt> <dt>

[**тдхкреатепайлоадфилтер**](/windows/desktop/api/Tdh/nf-tdh-tdhcreatepayloadfilter)
</dt> <dt>

[Обновление сеанса трассировки событий](updating-an-event-tracing-session.md)
</dt> </dl>
