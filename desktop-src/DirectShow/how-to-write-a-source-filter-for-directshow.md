---
description: В этом разделе описывается написание настраиваемого фильтра источника для DirectShow.
ms.assetid: 032f7624-2237-41cd-844a-18ed4a2e420d
title: Как записать фильтр источника для DirectShow
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 79ea6821dc7d56f2628ce68e7320e5e76b2c1643978e68287d434b7a111cbbd0
ms.sourcegitcommit: e6600f550f79bddfe58bd4696ac50dd52cb03d7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "120043244"
---
# <a name="how-to-write-a-source-filter-for-directshow"></a>Как записать фильтр источника для DirectShow

В этом разделе описывается написание настраиваемого фильтра источника для DirectShow.

> [!Note]  
> В этом разделе описываются только источники push-уведомлений. Он не описывает источники извлечения, такие как фильтр асинхронного чтения, или фильтры разделителя, которые подключаются к источникам извлечения. различие между источником *push-уведомлений* и источниками *извлечения* см. в разделе [Flow данных для разработчиков фильтров](data-flow-for-filter-developers.md).

 

## <a name="the-directshow-streaming-model"></a>модель потоковой передачи DirectShow

При написании исходного фильтра важно понимать, что источник push-уведомлений отличается от источника в реальном времени. Активный источник получает данные из какого-либо внешнего источника, например камеры или сетевого потока. Как правило, активный источник не может управлять входящей скоростью данных. Если нисходящие фильтры не потребляют данные достаточно быстро, источнику потребуется удалить образцы.

Но источник push-уведомлений не обязательно должен быть активным источником. Например, источник отправки может считывать данные из локального файла. В этом случае подчиненные фильтры визуализации определяют, насколько быстро они потребляют данные из источника, основываясь на эталонном времени и образцах меток времени. Фильтр источника доставляет образцы как можно быстрее, но фактический поток данных ограничен модулями подготовки отчетов. механизмы ограничения потока данных описаны в [Flow данных для разработчиков фильтров](data-flow-for-filter-developers.md).

Каждый выходной закрепление в фильтре источника создает поток, называемый *потоком потоковой передачи*. ПИН-код предоставляет примеры в потоке потоковой передачи. Как правило, все декодирование, обработка и подготовка к просмотру выполняются в этом потоке, хотя некоторые нисходящие фильтры могут создавать дополнительные потоки для постановки их выходных образцов.

Поток потоковой передачи выполняет цикл со следующей структурой:

``` syntax
until (stopped)
  1. Get a media sample from the allocator.
  2. Fill the sample with data.
  3. Time stamp the sample. 
  4. Deliver the sample downstream.
```

Если образцы недоступны, шаг 1 блокируется до тех пор, пока образец не станет доступным. Шаг 4 также можно заблокировать; Например, он может блокироваться во время приостановки графа.

Цикл выполняется как можно быстрее, но ограничивается тем, насколько быстро фильтр модуля подготовки отчетов визуализирует каждый пример. Если граф фильтра имеет ссылочный интервал времени, скорость определяется во время представления образцов. Если эталонные часы отсутствуют, модуль подготовки отчетов использует примеры как можно быстрее.

## <a name="using-csource-and-csourcestream"></a>Использование Ксаурце и Ксаурцестреам

DirectShow базовые классы включают два класса, которые поддерживают источники push-уведомлений: [**ксаурце**](csource.md) и [**ксаурцестреам**](csourcestream.md).

-   [**Ксаурце**](csource.md) является базовым классом для фильтра и реализует интерфейс [**ибасефилтер**](/windows/desktop/api/Strmif/nn-strmif-ibasefilter) .
-   [**Ксаурцестреам**](csourcestream.md) является базовым классом для закрепления вывода и реализует интерфейс [**Ипин**](/windows/desktop/api/Strmif/nn-strmif-ipin) .

### <a name="output-pins"></a>Выходные контакты

Фильтр источника может иметь более одного выходного ПИН-кода. В методе конструктора фильтра создайте один или несколько ПИН-кодов, производных от [**ксаурцестреам**](csourcestream.md) (один ПИН-код на поток вывода). Не нужно хранить указатели на ПИН-коды; ПИН-коды автоматически добавляются в фильтр при их создании.

### <a name="output-formats"></a>Форматы выходных данных

Выходной ПИН-код обрабатывает согласование формата со следующими методами [**ксаурцестреам**](csourcestream.md) :



| Метод                                                 | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|--------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**жетмедиатипе**](csourcestream-getmediatype.md)     | Возвращает тип носителя из выходного контакта. <br/> ПИН-код должен предложить по крайней мере один тип носителя, так как нисходящий фильтр может не предлагать типы. В большинстве случаев нисходящий фильтр будет декодером или модулем подготовки отчетов в зависимости от того, доставляет ли фильтр источника сжатые или несжатые данные. Фильтру модуля подготовки отчетов обычно требуется полный тип мультимедиа, содержащий все сведения о формате, необходимые для отрисовки потока. Для декодера объем информации, необходимый для типа носителя, зависит очень много от формата кодирования.<br/> |
| [**чеккмедиатипе**](csourcestream-checkmediatype.md) | Проверяет, принимает ли выходной ПИН-код данный тип носителя. Переопределение этого метода является необязательным, в зависимости от того, как реализуется [**жетмедиатипе**](csourcestream-getmediatype.md).                                                                                                                                                                                                                                                                                                                                                                                                         |



 

Метод [**жетмедиатипе**](csourcestream-getmediatype.md) перегружен:

-   [**Жетмедиатипе**](csourcestream-getmediatype.md) (1) принимает один параметр — указатель на объект [**кмедиатипе**](cmediatype.md) .
-   [**Жетмедиатипе**](csourcestream-getmediatype2.md) (2) принимает переменную индекса и указатель на объект [**кмедиатипе**](cmediatype.md) .

Если выходной ПИН-код фильтра источника поддерживает ровно один формат мультимедиа, следует переопределить (1), чтобы инициализировать объект [**кмедиатипе**](cmediatype.md) с этим форматом. Оставьте реализацию по умолчанию (2), а также оставьте реализацию [**чеккмедиатипе**](csourcestream-checkmediatype.md)по умолчанию.

Если ПИН-код поддерживает более одного формата, переопределите (2). Инициализируйте объект [**кмедиатипе**](cmediatype.md) в соответствии со значением переменной индекса. ПИН-код должен возвращать форматы в виде упорядоченного списка. В этом случае необходимо также переопределить [**чеккмедиатипе**](csourcestream-checkmediatype.md) , чтобы проверить тип мультимедиа по списку форматов.

Для несжатых видеоформатов Помните, что нисходящий фильтр может предлагать форматы с различными значениями STRIDE. Фильтр должен принимать любое допустимое значение шага. Дополнительные сведения см. в разделе [**битмапинфохеадер**](/windows/win32/api/wingdi/ns-wingdi-bitmapinfoheader).

Необходимо также переопределить метод чистого виртуального [**кбасеаутпутпин::D еЦидебуфферсизе**](cbaseoutputpin-decidebuffersize.md) . Используйте этот метод, чтобы задать размер буферов выборки.

### <a name="streaming"></a>Потоковая передача

Класс [**ксаурцестреам**](csourcestream.md) создает поток потоковой передачи для ПИН-кода. Процедура потока реализована в методе [**ксаурцестреам::D обуфферпроцессинглуп**](csourcestream-dobufferprocessingloop.md) . Этот метод вызывает метод чистого виртуального [**ксаурцестреам:: филлбуффер**](csourcestream-fillbuffer.md) , который должен переопределяться производным классом. Этот метод заключается в том, что закрепление заполняет буфер данными. Например, если фильтр доставляет видео в несжатом виде, здесь вы Нарисуйте кадры видео.

Базовый класс автоматически запускает и останавливает цикл потоков в нужное время, когда фильтр приостанавливается или останавливается. В этом случае класс [**ксаурцестреам**](csourcestream.md) вызывает некоторые методы для уведомления от производного класса:

-   [**Ксаурцестреам:: Онсреадкреате**](csourcestream-onthreadcreate.md)
-   [**Ксаурцестреам:: Онсреаддестрой**](csourcestream-onthreaddestroy.md)
-   [**Ксаурцестреам:: Онсреадстартплай**](csourcestream-onthreadstartplay.md)

Эти методы можно переопределить, если нужно добавить любую специальную обработку. В противном случае реализации по умолчанию просто возвращают значение **S \_ ОК**.

## <a name="seeking"></a>Нужна

Если у вас есть фильтр источников с одним выходным закреплением, можно использовать класс [**ксаурцесикинг**](csourceseeking.md) в качестве отправной точки для реализации поиска. Наследуйте класс ПИН-кода как в [**ксаурцестреам**](csourcestream.md) , так и в **ксаурцесикинг**.

> [!Note]  
> [**Ксаурцесикинг**](csourceseeking.md) не рекомендуется использовать для фильтра с более чем одним выходным закреплением. Основной проблемой является то, что только один ПИН-код должен отвечать на запросы на поиск. Обычно для этого требуется обмен данными между контактами и фильтром.

 

Класс [**ксаурцесикинг**](csourceseeking.md) управляет скоростью воспроизведения, временем начала, временем окончания и длительностью. Производный класс должен установить начальное время и длительность окончания. При каждом изменении одного из этих значений вызывается метод [**ксаурцесикинг:: чанжерате**](csourceseeking-changerate.md), [**Ксаурцесикинг:: чанжестарт**](csourceseeking-changestart.md)или [**ксаурцесикинг:: чанжестоп**](csourceseeking-changestop.md) . Методы — это все чистые виртуальные методы. Класс производного ПИН-кода переопределяет эти методы, чтобы сделать следующее:

1.  Вызовите [**Ипин:: бегинфлуш**](/windows/desktop/api/Strmif/nf-strmif-ipin-beginflush) в нисходящем ПИН-коде. Это приводит к тому, что нисходящие фильтры приводят к выпуску образцов, которые они записывают и отклоняют.
2.  Вызовите метод [**ксаурцестреам:: останавливаться**](csourcestream-stop.md) , чтобы прерывать поток потоковой передачи. Фильтр источников приостанавливает создание новых данных.
3.  Вызовите [**Ипин:: ендфлуш**](/windows/desktop/api/Strmif/nf-strmif-ipin-endflush) в нисходящем ПИН-коде. Это сигнализирует нисходящим фильтрам принять новые данные.
4.  Вызовите [**Ипин:: невсегмент**](/windows/desktop/api/Strmif/nf-strmif-ipin-newsegment) с новым временем начала и окончания и скоростью.
5.  Задайте свойство ненепрерывности в следующем примере.

Дополнительные сведения см. [в разделе Поддержка поиска в фильтре источника](supporting-seeking-in-a-source-filter.md).

Если фильтр поддерживает поиск, расположение потока теперь не зависит от времени презентации. После поиска метки времени сбрасываются в ноль. Общая формула для меток времени:

-   время начала выборки = прошедшее время или скорость воспроизведения
-   время окончания выборки = пример времени начала + (время на кадр/скорость воспроизведения)

*время истечения* времени — это время, истекшее с момента запуска фильтра или с момента последнего выполнения команды Seek.

### <a name="time-formats-for-seeking"></a>Форматы времени для поиска

По умолчанию команды поиска находятся в единицах 100-наносекундах. Фильтр источников может поддерживать дополнительные форматы времени, например поиск по номеру кадра. Каждый формат времени идентифицируется по идентификатору GUID; см. раздел [**идентификаторы GUID формата времени**](time-format-guids.md).

Для поддержки дополнительных форматов времени необходимо реализовать следующие методы для ПИН-кода вывода:

-   [**Имедиасикинг:: Конверттимеформат**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-converttimeformat)
-   [**Имедиасикинг:: Жеттимеформат**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-gettimeformat)
-   [**Имедиасикинг:: Исформатсуппортед**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-isformatsupported)
-   [**Имедиасикинг:: Исусингтимеформат**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-isusingtimeformat)
-   [**Имедиасикинг:: Куерипреферредформат**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-querypreferredformat)
-   [**Имедиасикинг:: Сеттимеформат**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-settimeformat)

Если приложение устанавливает новый формат времени, все параметры положения в методах [**имедиасикинг**](/windows/desktop/api/Strmif/nn-strmif-imediaseeking) будут интерпретированы с точки зрения нового формата времени. Например, если формат времени — Frames, метод [**имедиасикинг::**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-getduration) noreturn должен возвращать длительность в кадрах.

на практике некоторые фильтры DirectShow поддерживают дополнительные форматы времени, и в результате некоторые DirectShow приложения используют эту возможность.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Запись фильтров источника](writing-source-filters.md)
</dt> </dl>

 

 




