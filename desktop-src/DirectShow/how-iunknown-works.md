---
description: Принцип работы IUnknown
ms.assetid: 926778a5-e941-4424-8bc0-b50c925fd08b
title: Принцип работы IUnknown
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5a7549ce892e9c0dd3c82f1229a2440f1b930190
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "104139290"
---
# <a name="how-iunknown-works"></a>Принцип работы IUnknown

Методы в **IUnknown** позволяют приложению запрашивать интерфейсы в компоненте и управлять счетчиком ссылок компонента.

**Количество ссылок**

Счетчик ссылок — это внутренняя переменная, которая увеличивается в методе **AddRef** и уменьшается в методе **Release** . Базовые классы управляют счетчиком ссылок и синхронизируют доступ к счетчику ссылок между несколькими потоками.

**Запросы интерфейса**

Запросы к интерфейсу также просты. Вызывающий объект передает два параметра: идентификатор интерфейса (IID) и адрес указателя. Если компонент поддерживает запрошенный интерфейс, он устанавливает указатель на интерфейс, увеличивает значение счетчика ссылок и возвращает значение S \_ ОК. В противном случае он устанавливает указатель на **null** и ВОЗВРАЩАЕТ E \_ Interface. В следующем псевдокоде показана общая структура метода **QueryInterface** . Статистическая обработка компонентов, описанная в следующем разделе, содержит некоторую дополнительную сложность.


```C++
if (IID == IID_IUnknown)
    set pointer to (IUnknown *)this
    AddRef
    return S_OK

else if (IID == IID_ISomeInterface)
    set pointer to (ISomeInterface *)this
    AddRef
    return S_OK

else if ... 

else
    set pointer to NULL
    return E_NOINTERFACE
```



Единственным различием между методом **QueryInterface** одного компонента и методом **QueryInterface** другого является список идентификаторов IID, которые проверяет каждый компонент. Для каждого интерфейса, поддерживаемого компонентом, компонент должен проверить идентификатор IID этого интерфейса.

**Агрегирование и делегирование**

Агрегирование компонентов должно быть прозрачным для вызывающего. Таким образом, агрегатная функция должна предоставлять один интерфейс **IUnknown** , а агрегированный компонент отменяет реализацию внешнего компонента. В противном случае вызывающий объект будет видеть два разных интерфейса **IUnknown** в одной статистической функции. Если компонент не является агрегированным, он использует собственную реализацию.

Для поддержки такого поведения компонент должен добавить уровень косвенного обращения. *Делегированный IUnknown* делегирует работу в соответствующее место: внешнему компоненту, если таковой имеется, или к внутренней версии компонента. *Неделегированный IUnknown* выполняет работу, как описано в предыдущем разделе.

Делегированная версия является общедоступной и хранит имя **IUnknown**. Неделегированная версия переименовывается в [**инонделегатингункновн**](inondelegatingunknown.md). Это имя не является частью спецификации COM, поскольку оно не является общедоступным интерфейсом.

Когда клиент создает экземпляр компонента, он вызывает метод **IClassFactory:: CreateInstance** . Один параметр является указателем на интерфейс **IUnknown** компонента агрегирования или **null** , если новый экземпляр не является агрегатом. Компонент использует этот параметр для хранения переменной-члена, указывающей, какой интерфейс **IUnknown** следует использовать, как показано в следующем примере:


```C++
CMyComponent::CMyComponent(IUnknown *pOuterUnkown)
{
    if (pOuterUnknown == NULL)
        m_pUnknown = (IUnknown *)(INonDelegatingUnknown *)this;
    else
        m_pUnknown = pOuterUnknown;

    [ ... more constructor code ... ]
}
```



Каждый метод в делегированном **интерфейсе IUnknown** вызывает его неделегированный аналог, как показано в следующем примере:


```C++
HRESULT QueryInterface(REFIID iid, void **ppv) 
{
    return m_pUnknown->QueryInterface(iid, ppv);
}
```



По природе делегирования методы делегирования выглядят одинаково в каждом компоненте. Изменяются только неделегированные версии.

## <a name="related-topics"></a>См. также

<dl> <dt>

[Реализация IUnknown](how-to-implement-iunknown.md)
</dt> </dl>

 

 



