---
description: Обработка данных в DMO
ms.assetid: 715482d9-23f4-40d0-9c09-7a81e148c543
title: Обработка данных в DMO
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ea9f5d5d820dc1467c25f9d411d46a9c66935e8b
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "103894777"
---
# <a name="processing-data-in-a-dmo"></a><span data-ttu-id="f86ad-103">Обработка данных в DMO</span><span class="sxs-lookup"><span data-stu-id="f86ad-103">Processing Data in a DMO</span></span>

<span data-ttu-id="f86ad-104">В этом разделе объясняется, как обрабатывать поток данных с помощью DMO.</span><span class="sxs-lookup"><span data-stu-id="f86ad-104">This section explains how to process a stream of data using a DMO.</span></span> <span data-ttu-id="f86ad-105">Действия, описанные в этом разделе, являются поведением по умолчанию. все дмос должны поддерживать описанные здесь методы.</span><span class="sxs-lookup"><span data-stu-id="f86ad-105">The steps listed in this section are the default behavior; all DMOs must support the methods described here.</span></span> <span data-ttu-id="f86ad-106">Эти методы используют отдельные буферы для ввода и вывода.</span><span class="sxs-lookup"><span data-stu-id="f86ad-106">These methods use separate buffers for input and output.</span></span> <span data-ttu-id="f86ad-107">Некоторые дмос также поддерживают обработку на месте с помощью одного буфера.</span><span class="sxs-lookup"><span data-stu-id="f86ad-107">Some DMOs also support in-place processing, using a single buffer.</span></span> <span data-ttu-id="f86ad-108">Дополнительные сведения об обработке на месте см. в разделе [обработка на месте](in-place-processing.md).</span><span class="sxs-lookup"><span data-stu-id="f86ad-108">For more information about in-place processing, see [In-Place Processing](in-place-processing.md).</span></span>

<span data-ttu-id="f86ad-109">**Выделение буферов**</span><span class="sxs-lookup"><span data-stu-id="f86ad-109">**Allocating Buffers**</span></span>

<span data-ttu-id="f86ad-110">Клиент отвечает за выделение всех буферов.</span><span class="sxs-lookup"><span data-stu-id="f86ad-110">The client is responsible for all buffer allocation.</span></span> <span data-ttu-id="f86ad-111">После задания типов мультимедиа в DMO запросите требования к буферу DMO для каждого потока.</span><span class="sxs-lookup"><span data-stu-id="f86ad-111">After you set the media types on the DMO, query the DMO for each stream's buffer requirements.</span></span> <span data-ttu-id="f86ad-112">Они могут изменяться в зависимости от типа носителя.</span><span class="sxs-lookup"><span data-stu-id="f86ad-112">These can change depending on the media type.</span></span> <span data-ttu-id="f86ad-113">Для каждого потока вызовите метод [**имедиаобжект:: жетинпутсизеинфо**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getinputsizeinfo) или [**Имедиаобжект:: жетаутпутсизеинфо**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getoutputsizeinfo) .</span><span class="sxs-lookup"><span data-stu-id="f86ad-113">For each stream, call the [**IMediaObject::GetInputSizeInfo**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getinputsizeinfo) or [**IMediaObject::GetOutputSizeInfo**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getoutputsizeinfo) method.</span></span> <span data-ttu-id="f86ad-114">Эти методы возвращают следующие сведения:</span><span class="sxs-lookup"><span data-stu-id="f86ad-114">These methods return the following information:</span></span>

-   <span data-ttu-id="f86ad-115">Минимальный размер буфера в байтах.</span><span class="sxs-lookup"><span data-stu-id="f86ad-115">Minimum buffer size, in bytes.</span></span>
-   <span data-ttu-id="f86ad-116">Требования к выравниванию, если таковые имеются.</span><span class="sxs-lookup"><span data-stu-id="f86ad-116">Alignment requirements, if any.</span></span> <span data-ttu-id="f86ad-117">Если начальный адрес кратен определенному целому числу, буфер будет согласован.</span><span class="sxs-lookup"><span data-stu-id="f86ad-117">A buffer is aligned if the start address is a multiple of some specified integer.</span></span>
-   <span data-ttu-id="f86ad-118">Максимальный объем данных, которые DMO будет хранить для просмотра вперед.</span><span class="sxs-lookup"><span data-stu-id="f86ad-118">The maximum amount of data the DMO will hold for lookahead.</span></span> <span data-ttu-id="f86ad-119">Это число применяется только к входным потокам.</span><span class="sxs-lookup"><span data-stu-id="f86ad-119">This number applies only to input streams.</span></span> <span data-ttu-id="f86ad-120">Для некоторых типов данных (например, кодирования MPEG) может потребоваться выполнить в потоке Поиск объекта DMO.</span><span class="sxs-lookup"><span data-stu-id="f86ad-120">For some kinds of data (for example, MPEG encoding), a DMO might need to look forward in the stream.</span></span> <span data-ttu-id="f86ad-121">Значение просмотра вперед указывает, сколько входных данных будет требовать DMO, прежде чем он сможет создать выходные данные.</span><span class="sxs-lookup"><span data-stu-id="f86ad-121">The lookahead value indicates how much input data the DMO will require before it can produce output.</span></span>

<span data-ttu-id="f86ad-122">Клиент должен выделить буферы, соответствующие этим требованиям.</span><span class="sxs-lookup"><span data-stu-id="f86ad-122">The client must allocate buffers that match these requirements.</span></span> <span data-ttu-id="f86ad-123">Кроме того, DMO может иметь требования о том, как клиент упаковывает входные данные.</span><span class="sxs-lookup"><span data-stu-id="f86ad-123">In addition, the DMO might have requirements about how the client packages the input data.</span></span> <span data-ttu-id="f86ad-124">Например, для DMO может потребоваться, чтобы каждый буфер содержал только один образец (или видеокадр).</span><span class="sxs-lookup"><span data-stu-id="f86ad-124">For example, the DMO might require each buffer to contain exactly one sample (or video frame).</span></span> <span data-ttu-id="f86ad-125">Чтобы определить эти требования, вызовите метод [**имедиаобжект:: жетинпутстреаминфо**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getinputstreaminfo) .</span><span class="sxs-lookup"><span data-stu-id="f86ad-125">To determine these requirements, call the [**IMediaObject::GetInputStreamInfo**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getinputstreaminfo) method.</span></span> <span data-ttu-id="f86ad-126">Метод [**имедиаобжект:: жетаутпутстреаминфо**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getoutputstreaminfo) возвращает аналогичные сведения о потоке вывода.</span><span class="sxs-lookup"><span data-stu-id="f86ad-126">The [**IMediaObject::GetOutputStreamInfo**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getoutputstreaminfo) method returns similar information about an output stream.</span></span>

<span data-ttu-id="f86ad-127">В модели потоковой передачи по умолчанию клиент не передает необработанные указатели буфера в DMO.</span><span class="sxs-lookup"><span data-stu-id="f86ad-127">In the default streaming model, the client does not pass raw buffer pointers to the DMO.</span></span> <span data-ttu-id="f86ad-128">Вместо этого он использует упрощенный COM-объект, который предоставляет интерфейс [**имедиабуффер**](/previous-versions/windows/desktop/api/Mediaobj/nn-mediaobj-imediabuffer) .</span><span class="sxs-lookup"><span data-stu-id="f86ad-128">Instead, it uses a lightweight COM object that exposes the [**IMediaBuffer**](/previous-versions/windows/desktop/api/Mediaobj/nn-mediaobj-imediabuffer) interface.</span></span> <span data-ttu-id="f86ad-129">Интерфейс **имедиабуффер** выступает в качестве обертки COM для блока памяти.</span><span class="sxs-lookup"><span data-stu-id="f86ad-129">The **IMediaBuffer** interface acts as a COM wrapper for a block of memory.</span></span> <span data-ttu-id="f86ad-130">Так как это COM-объект, он поддерживает подсчет ссылок, что позволяет гарантировать, что буферы не освобождаются, пока все еще используются.</span><span class="sxs-lookup"><span data-stu-id="f86ad-130">Because it is a COM object, it supports reference counting, which helps to ensure that buffers are not released while still in use.</span></span>

> [!Note]  
> <span data-ttu-id="f86ad-131">Интерфейс **имедиабуффер** обслуживает функцию, аналогичную интерфейсу **имедиасампле** в DirectShow.</span><span class="sxs-lookup"><span data-stu-id="f86ad-131">The **IMediaBuffer** interface serves a function similar to the **IMediaSample** interface in DirectShow.</span></span>

 

<span data-ttu-id="f86ad-132">Клиент должен реализовать объект **имедиабуффер** .</span><span class="sxs-lookup"><span data-stu-id="f86ad-132">The client must implement the **IMediaBuffer** object.</span></span> <span data-ttu-id="f86ad-133">Дополнительные сведения см. в разделе [Реализация имедиабуффер](implementing-imediabuffer.md).</span><span class="sxs-lookup"><span data-stu-id="f86ad-133">For more information, see [Implementing IMediaBuffer](implementing-imediabuffer.md).</span></span>

<span data-ttu-id="f86ad-134">**Обработка данных**</span><span class="sxs-lookup"><span data-stu-id="f86ad-134">**Processing the Data**</span></span>

<span data-ttu-id="f86ad-135">Для обработки данных выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="f86ad-135">To process data, do the following:</span></span>

1.  <span data-ttu-id="f86ad-136">Для каждого входного потока заполните буфер входными данными.</span><span class="sxs-lookup"><span data-stu-id="f86ad-136">For each input stream, fill a buffer with input data.</span></span>
2.  <span data-ttu-id="f86ad-137">Вызовите [**имедиаобжект::P роцессинпут**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-processinput) для доставки каждого буфера.</span><span class="sxs-lookup"><span data-stu-id="f86ad-137">Call [**IMediaObject::ProcessInput**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-processinput) to deliver each buffer.</span></span>
3.  <span data-ttu-id="f86ad-138">Вызовите [**имедиаобжект::P роцессаутпут**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-processoutput) , чтобы обработать данные.</span><span class="sxs-lookup"><span data-stu-id="f86ad-138">Call [**IMediaObject::ProcessOutput**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-processoutput) to process the data.</span></span> <span data-ttu-id="f86ad-139">Этот метод принимает массив буферов, по одному для каждого потока вывода.</span><span class="sxs-lookup"><span data-stu-id="f86ad-139">This method takes an array of buffers, one for each output stream.</span></span>
4.  <span data-ttu-id="f86ad-140">Повторяйте до тех пор, пока не будет больше входных данных.</span><span class="sxs-lookup"><span data-stu-id="f86ad-140">Repeat until there is no more input data.</span></span>

<span data-ttu-id="f86ad-141">Метод **ProcessInput** принимает входные данные для одного потока за раз.</span><span class="sxs-lookup"><span data-stu-id="f86ad-141">The **ProcessInput** method accepts input for one stream at a time.</span></span> <span data-ttu-id="f86ad-142">Обычно метод возвращает значение немедленно, а DMO содержит счетчик ссылок на объект **имедиабуффер** .</span><span class="sxs-lookup"><span data-stu-id="f86ad-142">Typically the method returns immediately, and the DMO holds a reference count on the **IMediaBuffer** object.</span></span> <span data-ttu-id="f86ad-143">Он освобождает объект после обработки всех данных в буфере или когда приложение очищает DMO.</span><span class="sxs-lookup"><span data-stu-id="f86ad-143">It releases the object after it processes all of the data in the buffer, or when the application flushes the DMO.</span></span> <span data-ttu-id="f86ad-144">Не используйте буфер повторно, пока он не будет освобожден DMO.</span><span class="sxs-lookup"><span data-stu-id="f86ad-144">Do not re-use a buffer until the DMO has released it.</span></span> <span data-ttu-id="f86ad-145">Чтобы определить, может ли входной поток принимать больше данных, вызовите метод [**имедиаобжект:: жетинпутстатус**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getinputstatus) .</span><span class="sxs-lookup"><span data-stu-id="f86ad-145">To determine whether an input stream can accept more data, call the [**IMediaObject::GetInputStatus**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-getinputstatus) method.</span></span> <span data-ttu-id="f86ad-146">Этот метод возвращает \_ \_ флаг input статусф \_ Accept Data DMO, \_ Если поток может принимать больше входных данных.</span><span class="sxs-lookup"><span data-stu-id="f86ad-146">This method returns the DMO\_INPUT\_STATUSF\_ACCEPT\_DATA flag if the stream can accept more input.</span></span>

<span data-ttu-id="f86ad-147">Метод **ProcessOutput** создает выходные данные для всех потоков вывода за один раз.</span><span class="sxs-lookup"><span data-stu-id="f86ad-147">The **ProcessOutput** method generates output for all of the output streams at once.</span></span> <span data-ttu-id="f86ad-148">Приложение передает массив [**\_ выходных структур \_ \_ буфера данных DMO**](/previous-versions/windows/desktop/api/Mediaobj/ns-mediaobj-dmo_output_data_buffer) , по одному для каждого потока вывода.</span><span class="sxs-lookup"><span data-stu-id="f86ad-148">The application passes in an array of [**DMO\_OUTPUT\_DATA\_BUFFER**](/previous-versions/windows/desktop/api/Mediaobj/ns-mediaobj-dmo_output_data_buffer) structures, one for each output stream.</span></span> <span data-ttu-id="f86ad-149">Каждая структура в массиве имеет указатель на объект **имедиабуффер** .</span><span class="sxs-lookup"><span data-stu-id="f86ad-149">Each structure in the array has a pointer to an **IMediaBuffer** object.</span></span> <span data-ttu-id="f86ad-150">DMO записывает в буфер данные как можно больше выходных данных.</span><span class="sxs-lookup"><span data-stu-id="f86ad-150">The DMO writes as much output data as it can into the buffers.</span></span> <span data-ttu-id="f86ad-151">Он также устанавливает различные флаги для сообщения о состоянии операции.</span><span class="sxs-lookup"><span data-stu-id="f86ad-151">It also sets various flags to report the status of the operation.</span></span> <span data-ttu-id="f86ad-152">\_ \_ \_ \_ Флаг неполного вывода DMO БУФФЕРФ указывает, что DMO может создавать больше выходных данных из существующих входных данных.</span><span class="sxs-lookup"><span data-stu-id="f86ad-152">The DMO\_OUTPUT\_DATA\_BUFFERF\_INCOMPLETE flag indicates the DMO can produce more output from the existing input.</span></span> <span data-ttu-id="f86ad-153">В этом случае клиент может вызвать **ProcessOutput** еще раз.</span><span class="sxs-lookup"><span data-stu-id="f86ad-153">In that case, the client can call **ProcessOutput** again.</span></span> <span data-ttu-id="f86ad-154">В противном случае он должен вызывать **ProcessInput** с дополнительными входными данными.</span><span class="sxs-lookup"><span data-stu-id="f86ad-154">Otherwise, it should call **ProcessInput** with more input data.</span></span> <span data-ttu-id="f86ad-155">Объекты DMO никогда не изменяют данные во входных буферах. Он выполняет запись только в выходные буферы.</span><span class="sxs-lookup"><span data-stu-id="f86ad-155">The DMO never modifies the data in the input buffers; it writes only to the output buffers.</span></span>

<span data-ttu-id="f86ad-156">После доставки всех данных во входной поток вызовите метод [**имедиаобжект::D методом непрерывности**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-discontinuity) .</span><span class="sxs-lookup"><span data-stu-id="f86ad-156">After you have delivered all of the data to an input stream, call the [**IMediaObject::Discontinuity**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-discontinuity) method.</span></span> <span data-ttu-id="f86ad-157">DMO не принимает дальнейшие входные данные в этот поток до тех пор, пока не будет выполнена обработка оставшихся выходных данных (или очистка DMO).</span><span class="sxs-lookup"><span data-stu-id="f86ad-157">The DMO does not accept further input to that stream until you process the remaining output (or flush the DMO).</span></span>

<span data-ttu-id="f86ad-158">В любой момент после начала потоковой передачи DMO может получать входные или выдавать выходные данные или и то, и другое.</span><span class="sxs-lookup"><span data-stu-id="f86ad-158">At any point after streaming begins, the DMO is able to receive input or produce output, or both.</span></span> <span data-ttu-id="f86ad-159">Таким образом, либо **жетинпутстатус** возвращает DMO \_ input \_ статусф \_ Accept \_ Data, либо **ProcessOutput** возвращает \_ выходные \_ данные DMO \_ буфферф \_ неполны.</span><span class="sxs-lookup"><span data-stu-id="f86ad-159">Therefore, either **GetInputStatus** returns DMO\_INPUT\_STATUSF\_ACCEPT\_DATA, or **ProcessOutput** returns DMO\_OUTPUT\_DATA\_BUFFERF\_INCOMPLETE.</span></span> <span data-ttu-id="f86ad-160">Приложение хранит данные, проверяя эти флаги и вызывая метод **ProcessInput** или **ProcessOutput** соответственно.</span><span class="sxs-lookup"><span data-stu-id="f86ad-160">The application keeps data flowing by testing for these flags and calling **ProcessInput** or **ProcessOutput** accordingly.</span></span> <span data-ttu-id="f86ad-161">Чтобы прервать поток данных, вызовите метод [**имедиаобжект:: Flush**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-flush) .</span><span class="sxs-lookup"><span data-stu-id="f86ad-161">To interrupt the data flow, call the [**IMediaObject::Flush**](/previous-versions/windows/desktop/api/Mediaobj/nf-mediaobj-imediaobject-flush) method.</span></span> <span data-ttu-id="f86ad-162">Этот метод приводит к тому, что DMO удаляет все буферы, которые он удерживает внутренне.</span><span class="sxs-lookup"><span data-stu-id="f86ad-162">This method causes the DMO to discard any buffers it is holding internally.</span></span>

## <a name="related-topics"></a><span data-ttu-id="f86ad-163">См. также</span><span class="sxs-lookup"><span data-stu-id="f86ad-163">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="f86ad-164">Непосредственное размещение DMO</span><span class="sxs-lookup"><span data-stu-id="f86ad-164">Directly Hosting a DMO</span></span>](directly-hosting-a-dmo.md)
</dt> <dt>

[<span data-ttu-id="f86ad-165">Обработка на месте</span><span class="sxs-lookup"><span data-stu-id="f86ad-165">In-Place Processing</span></span>](in-place-processing.md)
</dt> </dl>

 

 



