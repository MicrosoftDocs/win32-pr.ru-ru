---
description: Обработка данных
ms.assetid: 823615df-ce50-4e20-957a-f83d3be66658
title: Обработка данных
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9bbece449df36c2de88414f313d477b8a16ba896
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "105673053"
---
# <a name="processing-data"></a><span data-ttu-id="22f76-103">Обработка данных</span><span class="sxs-lookup"><span data-stu-id="22f76-103">Processing Data</span></span>

<span data-ttu-id="22f76-104">**Анализ данных мультимедиа**</span><span class="sxs-lookup"><span data-stu-id="22f76-104">**Parsing Media Data**</span></span>

<span data-ttu-id="22f76-105">Если фильтр анализирует данные мультимедиа, не следует доверять заголовкам или другим самоопределяющим данным в содержимом.</span><span class="sxs-lookup"><span data-stu-id="22f76-105">If your filter parses media data, do not trust headers or other self-describing data in the content.</span></span> <span data-ttu-id="22f76-106">Например, не следует доверять значениям размера, которые отображаются в фрагментах AVI Metallica или в пакетах MPEG.</span><span class="sxs-lookup"><span data-stu-id="22f76-106">For example, do not trust size values that appear in AVI RIFF chunks or MPEG packets.</span></span> <span data-ttu-id="22f76-107">Ниже приведены распространенные примеры такого рода ошибок.</span><span class="sxs-lookup"><span data-stu-id="22f76-107">Common examples of this kind of error include:</span></span>

-   <span data-ttu-id="22f76-108">Считывание *n* байт данных, где значение *n* получено из содержимого, без проверки значения *n* относительно фактического размера буфера.</span><span class="sxs-lookup"><span data-stu-id="22f76-108">Reading *N* bytes of data, where the value of *N* came from the content, without checking *N* against the actual size of your buffer.</span></span>
-   <span data-ttu-id="22f76-109">Переход к байтовому смещению в пределах буфера без проверки того, что смещение попадает в буфер.</span><span class="sxs-lookup"><span data-stu-id="22f76-109">Jumping to a byte offset within a buffer, without verifying that the offset falls within the buffer.</span></span>

<span data-ttu-id="22f76-110">Другим распространенным классом ошибок не является проверка описаний форматов, найденных в содержимом.</span><span class="sxs-lookup"><span data-stu-id="22f76-110">Another common class of errors involves not validating format descriptions that are found in the content.</span></span> <span data-ttu-id="22f76-111">Пример:</span><span class="sxs-lookup"><span data-stu-id="22f76-111">For example:</span></span>

-   <span data-ttu-id="22f76-112">За структурой [**битмапинфохеадер**](/windows/win32/api/wingdi/ns-wingdi-bitmapinfoheader) может следовать таблица цветов.</span><span class="sxs-lookup"><span data-stu-id="22f76-112">A [**BITMAPINFOHEADER**](/windows/win32/api/wingdi/ns-wingdi-bitmapinfoheader) structure can be followed by a color table.</span></span> <span data-ttu-id="22f76-113">Структура **битмапинфо** определяется как структура **битмапинфохеадер** , за которой следует массив значений **ргбкуад** , образующих таблицу цветов.</span><span class="sxs-lookup"><span data-stu-id="22f76-113">The **BITMAPINFO** structure is defined as a **BITMAPINFOHEADER** structure followed by an array of **RGBQUAD** values that make up the color table.</span></span> <span data-ttu-id="22f76-114">Размер массива определяется значением **биклрусед**.</span><span class="sxs-lookup"><span data-stu-id="22f76-114">The size of the array is determined by the value of **biClrUsed**.</span></span> <span data-ttu-id="22f76-115">Никогда не копируйте таблицу цветов в **битмапинфо** без предварительной проверки размера буфера, выделенного для структуры **битмапинфо** .</span><span class="sxs-lookup"><span data-stu-id="22f76-115">Never copy a color table into a **BITMAPINFO** without first checking the size of the buffer that was allocated for the **BITMAPINFO** structure.</span></span>
-   <span data-ttu-id="22f76-116">К структуре [**вавеформатекс**](/previous-versions/dd757713(v=vs.85)) могут быть добавлены дополнительные сведения о форматировании.</span><span class="sxs-lookup"><span data-stu-id="22f76-116">A [**WAVEFORMATEX**](/previous-versions/dd757713(v=vs.85)) structure might have extra format information appended to the structure.</span></span> <span data-ttu-id="22f76-117">Элемент **кбсизе** указывает размер дополнительной информации.</span><span class="sxs-lookup"><span data-stu-id="22f76-117">The **cbSize** member specifies the size of the extra information.</span></span>

<span data-ttu-id="22f76-118">Во время подключения к закреплениям фильтр должен проверять правильность формата всех структур форматирования и иметь разумные значения.</span><span class="sxs-lookup"><span data-stu-id="22f76-118">During pin connection, a filter should verify that all format structures are well-formed and contain reasonable values.</span></span> <span data-ttu-id="22f76-119">В противном случае отклоните подключение.</span><span class="sxs-lookup"><span data-stu-id="22f76-119">If not, reject the connection.</span></span> <span data-ttu-id="22f76-120">В коде, который проверяет структуру формата, будьте особенно внимательны к арифметическому переполнению.</span><span class="sxs-lookup"><span data-stu-id="22f76-120">In the code that validates the format structure, be especially careful about arithmetic overflow.</span></span> <span data-ttu-id="22f76-121">Например, в **битмапинфохеадер** ширина и высота представляют собой 32-разрядные **длинные** значения, но размер изображения (который является функцией произведения двух) — это только значение **типа DWORD** .</span><span class="sxs-lookup"><span data-stu-id="22f76-121">For example, in a **BITMAPINFOHEADER**, the width and height are 32-bit **long** values but the image size (which is a function of the product of the two) is only a **DWORD** value.</span></span>

<span data-ttu-id="22f76-122">Если данные формата из источника больше выделенного буфера, не следует усекать исходные данные, чтобы скопировать их в буфер.</span><span class="sxs-lookup"><span data-stu-id="22f76-122">If format data from the source is larger than your allocated buffer, do not truncate the source data in order to copy it into your buffer.</span></span> <span data-ttu-id="22f76-123">Это может создать структуру, неявный размер которой больше, чем фактический размер.</span><span class="sxs-lookup"><span data-stu-id="22f76-123">Doing so can create a structure whose implicit size is larger than its actual size.</span></span> <span data-ttu-id="22f76-124">Например, в заголовке точечного рисунка может быть указана таблица палитры, которая больше не существует.</span><span class="sxs-lookup"><span data-stu-id="22f76-124">For example, a bitmap header might specify a palette table which no longer exists.</span></span> <span data-ttu-id="22f76-125">Вместо этого Перераспределите буфер или просто завершите соединение.</span><span class="sxs-lookup"><span data-stu-id="22f76-125">Instead, reallocate the buffer or simply fail the connection.</span></span>

<span data-ttu-id="22f76-126">**Ошибки во время потоковой передачи**</span><span class="sxs-lookup"><span data-stu-id="22f76-126">**Errors During Streaming**</span></span>

<span data-ttu-id="22f76-127">Если при выполнении графа фильтр получает неверно сформированное содержимое, он должен завершить потоковую передачу.</span><span class="sxs-lookup"><span data-stu-id="22f76-127">When the graph is running, if your filter receives malformed content, it should terminate streaming.</span></span> <span data-ttu-id="22f76-128">Выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="22f76-128">Do the following:</span></span>

-   <span data-ttu-id="22f76-129">Возврат кода ошибки из **Receive**.</span><span class="sxs-lookup"><span data-stu-id="22f76-129">Return an error code from **Receive**.</span></span>
-   <span data-ttu-id="22f76-130">Вызовите [**Ипин:: EndOfStream**](/windows/desktop/api/Strmif/nf-strmif-ipin-endofstream) в подчиненном фильтре.</span><span class="sxs-lookup"><span data-stu-id="22f76-130">Call [**IPin::EndOfStream**](/windows/desktop/api/Strmif/nf-strmif-ipin-endofstream) on the downstream filter.</span></span>
-   <span data-ttu-id="22f76-131">Вызовите [**кбасефилтер:: нотифевент**](cbasefilter-notifyevent.md) , чтобы опубликовать событие [**EC \_ еррораборт**](ec-errorabort.md) .</span><span class="sxs-lookup"><span data-stu-id="22f76-131">Call [**CBaseFilter::NotifyEvent**](cbasefilter-notifyevent.md) to post an [**EC\_ERRORABORT**](ec-errorabort.md) event.</span></span>

<span data-ttu-id="22f76-132">**Изменения формата**</span><span class="sxs-lookup"><span data-stu-id="22f76-132">**Format Changes**</span></span>

<span data-ttu-id="22f76-133">Существует несколько механизмов, которые можно выполнить для фильтров, чтобы изменить формат среднего потока.</span><span class="sxs-lookup"><span data-stu-id="22f76-133">Several mechanisms exist for filters to change formats mid-stream.</span></span> <span data-ttu-id="22f76-134">Каждая из них включает в себя несколько шагов, что создает потенциал для ложных приемов.</span><span class="sxs-lookup"><span data-stu-id="22f76-134">Each of them involves more than one step, which creates the potential for false acceptances.</span></span> <span data-ttu-id="22f76-135">Если фильтр получает запрос на изменение динамического формата, он должен либо отклонить запрос, либо при поступлении принять новый формат.</span><span class="sxs-lookup"><span data-stu-id="22f76-135">If your filter gets a request for a dynamic format change, then it must either reject the request, or else honor the new format when it arrives.</span></span> <span data-ttu-id="22f76-136">Аналогично, никогда не следует переключать форматы, если только другой фильтр не согласен.</span><span class="sxs-lookup"><span data-stu-id="22f76-136">Similarly, never switch formats unless the other filter agrees.</span></span> <span data-ttu-id="22f76-137">Дополнительные сведения см. в разделе [динамические изменения формата](dynamic-format-changes.md).</span><span class="sxs-lookup"><span data-stu-id="22f76-137">For more information, see [Dynamic Format Changes](dynamic-format-changes.md).</span></span>

 

 
