---
description: Согласование распределителя
ms.assetid: fe13477c-1a7b-4098-9d0f-c54783102bc9
title: Согласование распределителя
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 2faa393ba9fcd8585d68947cec172d4cfca6decf
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "105682185"
---
# <a name="negotiating-allocators"></a><span data-ttu-id="a42f5-103">Согласование распределителя</span><span class="sxs-lookup"><span data-stu-id="a42f5-103">Negotiating Allocators</span></span>

<span data-ttu-id="a42f5-104">Когда два контакта соединяются, им нужен механизм для обмена данными мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="a42f5-104">When two pins connect, they need a mechanism for exchanging media data.</span></span> <span data-ttu-id="a42f5-105">Этот механизм называется *транспортным*.</span><span class="sxs-lookup"><span data-stu-id="a42f5-105">This mechanism is called the *transport*.</span></span> <span data-ttu-id="a42f5-106">Как правило, архитектура DirectShow нейтральна к транспортам.</span><span class="sxs-lookup"><span data-stu-id="a42f5-106">In general, the DirectShow architecture is neutral about transports.</span></span> <span data-ttu-id="a42f5-107">Два фильтра могут согласиться на подключение с помощью любого транспортного транспорта, поддерживающего обе операции.</span><span class="sxs-lookup"><span data-stu-id="a42f5-107">Two filters can agree to connect using any transport that both support.</span></span>

<span data-ttu-id="a42f5-108">Наиболее распространенным транспортом является транспорт *локальной памяти* , в котором данные мультимедиа находятся в основной памяти.</span><span class="sxs-lookup"><span data-stu-id="a42f5-108">The most common transport is the *local memory* transport, in which the media data resides in main memory.</span></span> <span data-ttu-id="a42f5-109">Существует две разновидности транспорта локальной памяти, *модель push-уведомлений* и *модель извлечения*.</span><span class="sxs-lookup"><span data-stu-id="a42f5-109">Two flavors of local memory transport exist, the *push model* and the *pull model*.</span></span> <span data-ttu-id="a42f5-110">В модели отправки фильтр источника передает данные в нисходящий фильтр, используя интерфейс [**имеминпутпин**](/windows/desktop/api/Strmif/nn-strmif-imeminputpin) на входном закреплением подчиненного фильтра.</span><span class="sxs-lookup"><span data-stu-id="a42f5-110">In the push model, the source filter pushes data to the downstream filter, using the [**IMemInputPin**](/windows/desktop/api/Strmif/nn-strmif-imeminputpin) interface on the downstream filter's input pin.</span></span> <span data-ttu-id="a42f5-111">В модели извлечения нисходящий фильтр запрашивает данные из фильтра источника с помощью интерфейса [**иасинкреадер**](/windows/desktop/api/Strmif/nn-strmif-iasyncreader) в закреплениях вывода фильтра источника.</span><span class="sxs-lookup"><span data-stu-id="a42f5-111">In the pull model, the downstream filter requests data from the source filter, using the [**IAsyncReader**](/windows/desktop/api/Strmif/nn-strmif-iasyncreader) interface on the source filter's output pin.</span></span> <span data-ttu-id="a42f5-112">Дополнительные сведения об этих двух моделях потоков данных см. в разделе [поток данных в графе фильтра](data-flow-in-the-filter-graph.md).</span><span class="sxs-lookup"><span data-stu-id="a42f5-112">For more information on these two data-flow models, see [Data Flow in the Filter Graph](data-flow-in-the-filter-graph.md).</span></span>

<span data-ttu-id="a42f5-113">При транспортировке локальной памяти объект, отвечающий за выделение буферов памяти, называется *распределителем*.</span><span class="sxs-lookup"><span data-stu-id="a42f5-113">In local memory transport, the object responsible for allocating memory buffers is called the *allocator*.</span></span> <span data-ttu-id="a42f5-114">Распределитель поддерживает интерфейс [**имемаллокатор**](/windows/desktop/api/Strmif/nn-strmif-imemallocator) .</span><span class="sxs-lookup"><span data-stu-id="a42f5-114">An allocator supports the [**IMemAllocator**](/windows/desktop/api/Strmif/nn-strmif-imemallocator) interface.</span></span> <span data-ttu-id="a42f5-115">Оба ПИН-кода совместно используют один распределитель.</span><span class="sxs-lookup"><span data-stu-id="a42f5-115">Both pins share a single allocator.</span></span> <span data-ttu-id="a42f5-116">Любой ПИН-код может предоставлять распределитель, но закрепление вывода выбирает, какой распределитель следует использовать.</span><span class="sxs-lookup"><span data-stu-id="a42f5-116">Either pin can provide an allocator, but the output pin selects which allocator to use.</span></span>

<span data-ttu-id="a42f5-117">Закрепление вывода также задает свойства распределителя, которые определяют количество буферов, создаваемых распределителем, размер каждого буфера и выравнивание памяти.</span><span class="sxs-lookup"><span data-stu-id="a42f5-117">The output pin also sets the allocator properties, which determine how many buffers are created by the allocator, the size of each buffer, and the memory alignment.</span></span> <span data-ttu-id="a42f5-118">Закрепление вывода может откладываться на входной ПИН-код для требований к буферу.</span><span class="sxs-lookup"><span data-stu-id="a42f5-118">The output pin might defer to the input pin for the buffer requirements.</span></span>

<span data-ttu-id="a42f5-119">В подключении **имеминпутпин** согласование распределителя работает следующим образом:</span><span class="sxs-lookup"><span data-stu-id="a42f5-119">In an **IMemInputPin** connection, allocator negotiation works as follows:</span></span>

1.  <span data-ttu-id="a42f5-120">При необходимости выходной ПИН-код вызывает [**имеминпутпин:: жеталлокаторрекуирементс**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-getallocatorrequirements).</span><span class="sxs-lookup"><span data-stu-id="a42f5-120">Optionally, the output pin calls [**IMemInputPin::GetAllocatorRequirements**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-getallocatorrequirements).</span></span> <span data-ttu-id="a42f5-121">Этот метод получает требования к буферу входного ПИН-кода, например выравнивание памяти.</span><span class="sxs-lookup"><span data-stu-id="a42f5-121">This method retrieves the input pin's buffer requirements, such as memory alignment.</span></span> <span data-ttu-id="a42f5-122">В общем случае выходной ПИН-код должен соответствовать запросу входного ПИН-кода, если нет веской причины отсутствия.</span><span class="sxs-lookup"><span data-stu-id="a42f5-122">In general, the output pin should honor the input pin's request, unless there is a good reason not to.</span></span>
2.  <span data-ttu-id="a42f5-123">При необходимости выходной ПИН-код вызывает [**имеминпутпин::-распределителя**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-getallocator).</span><span class="sxs-lookup"><span data-stu-id="a42f5-123">Optionally, the output pin calls [**IMemInputPin::GetAllocator**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-getallocator).</span></span> <span data-ttu-id="a42f5-124">Этот метод запрашивает распределитель из входного ПИН-кода.</span><span class="sxs-lookup"><span data-stu-id="a42f5-124">This method requests an allocator from the input pin.</span></span> <span data-ttu-id="a42f5-125">Входной ПИН-код предоставляет один или возвращает код ошибки.</span><span class="sxs-lookup"><span data-stu-id="a42f5-125">The input pin provides one, or returns an error code.</span></span>
3.  <span data-ttu-id="a42f5-126">Закрепление вывода выбирает распределитель.</span><span class="sxs-lookup"><span data-stu-id="a42f5-126">The output pin selects an allocator.</span></span> <span data-ttu-id="a42f5-127">Он может использовать один из предоставленных ПИН-кодов ввода или создать собственный.</span><span class="sxs-lookup"><span data-stu-id="a42f5-127">It can use one provided by the input pin, or create its own.</span></span>
4.  <span data-ttu-id="a42f5-128">Закрепление вывода вызывает [**имемаллокатор:: SetProperties**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-setproperties) для задания свойств распределителя.</span><span class="sxs-lookup"><span data-stu-id="a42f5-128">The output pin calls [**IMemAllocator::SetProperties**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-setproperties) to set the allocator properties.</span></span> <span data-ttu-id="a42f5-129">Однако распределитель может не учитывать запрошенные свойства.</span><span class="sxs-lookup"><span data-stu-id="a42f5-129">However, the allocator might not honor the requested properties.</span></span> <span data-ttu-id="a42f5-130">(Например, это может произойти, если входной ПИН-код предоставляет распределитель). Распределитель возвращает фактические свойства в виде выходного параметра в методе **SetProperties** .</span><span class="sxs-lookup"><span data-stu-id="a42f5-130">(For example, this can happen if the input pin provides the allocator.) The allocator returns the actual properties as an output parameter in the **SetProperties** method.</span></span>
5.  <span data-ttu-id="a42f5-131">Аутпин вызывает [**имеминпутпин:: нотифяллокатор**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-notifyallocator) , чтобы уведомить входной ПИН-код выделения.</span><span class="sxs-lookup"><span data-stu-id="a42f5-131">The outpin calls [**IMemInputPin::NotifyAllocator**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-notifyallocator) to inform the input pin of the selection.</span></span>
6.  <span data-ttu-id="a42f5-132">Входной ПИН-код должен вызывать [**имемаллокатор::-Properties**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getproperties) , чтобы проверить, приемлемы ли свойства распределителя.</span><span class="sxs-lookup"><span data-stu-id="a42f5-132">The input pin should call [**IMemAllocator::GetProperties**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getproperties) to verify whether the allocator properties are acceptable.</span></span>
7.  <span data-ttu-id="a42f5-133">Закрепление вывода отвечает за фиксацию и отправку распределителя.</span><span class="sxs-lookup"><span data-stu-id="a42f5-133">The output pin is responsible for committing and decommitting the allocator.</span></span> <span data-ttu-id="a42f5-134">Это происходит при запуске и остановке потоковой передачи.</span><span class="sxs-lookup"><span data-stu-id="a42f5-134">This occurs when streaming starts and stops.</span></span>

<span data-ttu-id="a42f5-135">В подключении **иасинкреадер** согласование распределителя работает следующим образом:</span><span class="sxs-lookup"><span data-stu-id="a42f5-135">In an **IAsyncReader** connection, allocator negotiation works as follows:</span></span>

1.  <span data-ttu-id="a42f5-136">Входной ПИН-код вызывает [**иасинкреадер:: рекуесталлокатор**](/windows/desktop/api/Strmif/nf-strmif-iasyncreader-requestallocator) на выходном заводе.</span><span class="sxs-lookup"><span data-stu-id="a42f5-136">The input pin calls [**IAsyncReader::RequestAllocator**](/windows/desktop/api/Strmif/nf-strmif-iasyncreader-requestallocator) on the output pin.</span></span> <span data-ttu-id="a42f5-137">Входной ПИН-код определяет требования к буферу и, при необходимости, предоставляет распределитель.</span><span class="sxs-lookup"><span data-stu-id="a42f5-137">The input pin specifies its buffer requirements and, optionally, provides an allocator.</span></span>
2.  <span data-ttu-id="a42f5-138">Закрепление вывода выбирает распределитель.</span><span class="sxs-lookup"><span data-stu-id="a42f5-138">The output pin selects an allocator.</span></span> <span data-ttu-id="a42f5-139">Он может использовать тот, который предоставлен ПИН-кодом ввода, если таковой имеется, или создать собственный.</span><span class="sxs-lookup"><span data-stu-id="a42f5-139">It can use the one provided by the input pin, if any, or create its own.</span></span>
3.  <span data-ttu-id="a42f5-140">Закрепление вывода возвращает распределитель в качестве исходящего параметра в методе **рекуесталлокатор** .</span><span class="sxs-lookup"><span data-stu-id="a42f5-140">The output pin returns the allocator as an outgoing parameter in the **RequestAllocator** method.</span></span> <span data-ttu-id="a42f5-141">Входной ПИН-код должен проверять свойства распределителя.</span><span class="sxs-lookup"><span data-stu-id="a42f5-141">The input pin should check the allocator properties.</span></span>
4.  <span data-ttu-id="a42f5-142">Входной ПИН-код отвечает за фиксацию и отправку распределителя.</span><span class="sxs-lookup"><span data-stu-id="a42f5-142">The input pin is responsible for committing and decommitting the allocator.</span></span>
5.  <span data-ttu-id="a42f5-143">В любой момент во время процесса согласования распределителя любой из ПИН-кодов может привести к сбою подключения.</span><span class="sxs-lookup"><span data-stu-id="a42f5-143">At any time during the allocator negotiation process, either pin can fail the connection.</span></span>
6.  <span data-ttu-id="a42f5-144">Если закрепление вывода использует распределитель входного контакта, он может использовать этот распределитель только для доставки образцов на этот входной ПИН-код.</span><span class="sxs-lookup"><span data-stu-id="a42f5-144">If the output pin uses the input pin's allocator, it can use that allocator only to deliver samples to that input pin.</span></span> <span data-ttu-id="a42f5-145">Фильтр-владелец не должен использовать распределитель для доставки образцов на другие контакты.</span><span class="sxs-lookup"><span data-stu-id="a42f5-145">The owning filter must not use the allocator to deliver samples to other pins.</span></span>

## <a name="related-topics"></a><span data-ttu-id="a42f5-146">См. также</span><span class="sxs-lookup"><span data-stu-id="a42f5-146">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="a42f5-147">Предоставление пользовательского распределителя</span><span class="sxs-lookup"><span data-stu-id="a42f5-147">Providing a Custom Allocator</span></span>](providing-a-custom-allocator.md)
</dt> </dl>

 

 



