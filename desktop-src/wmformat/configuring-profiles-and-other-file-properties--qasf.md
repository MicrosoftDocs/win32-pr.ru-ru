---
title: Настройка профилей и других свойств файлов (КАСФ)
description: Настройка профилей и других свойств файлов (КАСФ)
ms.assetid: a462fc8b-5a2e-4c93-828d-177d1965b734
keywords:
- Windows Media Format SDK, Настройка профилей (КАСФ)
- Windows Media Format SDK, Настройка свойств файлов (КАСФ)
- Windows Media Format SDK, метаданные (КАСФ)
- Расширенный системный формат (ASF), Настройка профилей (КАСФ)
- ASF (Расширенный системный формат), Настройка профилей (КАСФ)
- Расширенный системный формат (ASF), Настройка свойств файлов (КАСФ)
- ASF (Расширенный системный формат), Настройка свойств файлов (КАСФ)
- Расширенный системный формат (ASF), метаданные (КАСФ)
- ASF (Расширенный системный формат), метаданные (КАСФ)
- Windows Media Format SDK, КАСФ
- Расширенный системный формат (ASF), КАСФ
- ASF (Расширенный системный формат), КАСФ
- метаданные, КАСФ
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9ebb6afedfa00813e7447e5bcaefe1f251c02575
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "104488032"
---
# <a name="configuring-profiles-and-other-file-properties-qasf"></a>Настройка профилей и других свойств файлов (КАСФ)

Следующие элементы описывают выполнение различных задач, связанных с созданием файлов ASF.

## <a name="creating-a-profile-qasf"></a>Создание профиля (КАСФ)

Чтобы создать настраиваемый профиль, используйте пакет SDK для формата Windows Media, чтобы создать объект диспетчера профилей с помощью функции [**вмкреатепрофилеманажер**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-wmcreateprofilemanager) . Затем создайте профиль и передайте его в [модуль записи WM ASF](wm-asf-writer-filter.md) с помощью метода [**Иконфигасфвритер:: конфигурефилтерусингпрофиле**](iconfigasfwriter-configurefilterusingprofile.md) . Это единственный способ настроить фильтр с помощью профиля, который использует кодеки Windows Media Audio и Video 9. Системные профили для более ранних версий этих кодеков можно добавить с помощью метода [**иконфигасфвритер:: конфигурефилтерусингпрофилегуид**](iconfigasfwriter-configurefilterusingprofileguid.md) .

## <a name="adding-metadata-qasf"></a>Добавление метаданных (КАСФ)

Чтобы добавить метаданные в файл, вызовите **QueryInterface** из интерфейса **Ибасефилтер** в [модуле записи WM ASF](wm-asf-writer-filter.md) , чтобы получить интерфейс [**ивмхеадеринфо**](/previous-versions/windows/desktop/api/wmsdkidl/nn-wmsdkidl-iwmheaderinfo) . После того как для фильтра был получен профиль, используйте методы интерфейса **ивмхеадеринфо** для записи метаданных.

## <a name="indexing-a-file-qasf"></a>Индексирование файла (КАСФ)

Модуль записи WM ASF по умолчанию создает временные индексированные файлы. Чтобы создать файл, индексируемый по фрейму, используйте метод [**иконфигасфвритер:: сетиндексмоде**](iconfigasfwriter-setindexmode.md) , чтобы отключить все индексирование, а затем создайте файл. По завершении используйте пакет SDK для формата Windows Media, чтобы создать для файла индекс на основе фрейма.

## <a name="performing-two-pass-encoding-qasf"></a>Выполнение Two-Pass кодирования (КАСФ)

Двусторонняя кодировка поддерживается только в кодеках Windows Media версии 8 и более поздних. Переведите модуль записи WM ASF в режим предварительной обработки, вызвав [**IConfigAsfWriter2:: сетпарам**](iconfigasfwriter2-setparam.md) и указав \_ конфигасфвритер \_ param \_ в параметре *двпарам* , и **значение true** в параметре *dwParam1* .

Затем запустите граф фильтра. Когда выполняются все этапы предварительной обработки (обычно выполняется только один этап предварительной обработки), приложение получит событие **\_ \_ завершения предварительной обработки** в фильтре. При получении этого события используйте **имедиасикинг:: сетпоситионс** , чтобы сбросить указатель потока обратно на начало и снова запустить граф фильтра. После последнего этапа (обычно второй проход) приложение получит событие **EC \_ Complete** , чтобы обозначить завершение процесса кодирования. Если этап предварительной обработки был отменен до получения события **\_ предварительной обработки \_** , вызовите [**IConfigAsfWriter2:: ресетмултипассстате**](iconfigasfwriter2-resetmultipassstate.md) , чтобы сбросить фильтр, прежде чем пытаться выполнить другой предварительный запуск.

Вызов **иконфигасфвритер:: сетпарам**(AM \_ Конфигасфвритер \_ param, false) требуется только в том \_ случае , если нужно полностью перевести фильтр из режима предварительной обработки.

> [!IMPORTANT]
> Ответственность за включение режима предварительной обработки в зависимости от профиля, который будет использоваться для кодирования, несет приложение. Для некоторых профилей требуется двусторонняя кодировка. Если вы попытаетесь закодировать файл с таким профилем и не установили \_ \_ параметр конфигасфвритер param of \_ Pass в **значение true**, \_ будет получено сообщение об ошибке EC усераборт. Дополнительные сведения о том, как определить, требуется ли в данном профиле кодирование с двумя проходами, см. в разделе [использование Two-Pass кодирования](using-two-pass-encoding.md) или [запись потоков переменной скорости](writing-variable-bit-rate-streams.md).

 

## <a name="getting-and-setting-buffer-properties-at-run-time-qasf"></a>Получение и установка свойств буфера во время выполнения (КАСФ)

В некоторых случаях, например, если требуется принудительно вставить ключевые кадры при записи файла, приложению может потребоваться получить или задать сведения о буфере Windows Media во время выполнения. Фильтры модуля записи [WM ASF](wm-asf-reader-filter.md) и [WM ASF](wm-asf-writer-filter.md) поддерживают механизм обратного вызова, который позволяет приложению получать доступ к интерфейсу [**INSSBuffer3**](/previous-versions/windows/desktop/api/wmsbuffer/nn-wmsbuffer-inssbuffer3) в каждом отдельном буфере мультимедиа во время чтения или записи файлов. Приложения могут использовать этот интерфейс для обозначения конкретных выборок в качестве ключевых кадров, или [*клеанпоинтс*](wmformat-glossary.md), для задания кодов времени SMPTE, для указания параметров чересстрочную развертки или добавления любых типов частных данных в поток.

Используйте интерфейс [**иамвмбуфферпасс**](/previous-versions/windows/desktop/api/dshowasf/nn-dshowasf-iamwmbufferpass) для регистрации обратных вызовов из ПИН-кода, обрабатывающего поток видео. Когда ПИН-код вызывает метод [**иамвмбуфферпасскаллбакк:: notify**](iamwmbufferpasscallback-notify.md) , проверьте отметки времени в буфере и при необходимости вызовите [**INSSBuffer3:: SetProperty**](/previous-versions/windows/desktop/api/Wmsbuffer/nf-wmsbuffer-inssbuffer3-setproperty) , чтобы задать для свойства **WM \_ Сампликстенсионгуид \_ аутпутклеанпоинт** в буфере **значение true**.

## <a name="non-square-pixel-support-qasf"></a>Поддержка неквадратных пикселей (КАСФ)

Модуль записи WM ASF подключается к вышестоящему фильтру, например к декодеру DV, который выводит сведения о соотношении пропорций в пикселях. Модуль записи WM ASF записывает эти сведения в виде расширений модулей данных для каждого образца в файле.

Когда модуль чтения WM ASF встречает сведения о соотношении пропорций в заголовке файла или в расширениях модулей данных для образцов, он будет предлагать тип носителя **VIDEOINFOHEADER2** в качестве первого варианта для своего выходного ПИН-кода. Элементы **двпиктаспектратиокс** и **двпиктаспектратиой** структуры, описывающие пропорции видео, будут правильно скорректированы с учетом пропорций в пикселях.

## <a name="maintaining-interlaced-format"></a>Поддержание формата с чередованием

При записи чередования видео с телевизора или с цифровой камеры может потребоваться сохранить исходное видео как независимые поля, если предполагается, что закодированный файл воспроизводится на телевизоре или другом с чередованием дисплее. (Мониторы компьютеров — это прогрессивные проверки устройств.) Если вы развернете видео, а затем переустановите его для воспроизведения на телевизоре, будет вызвана часть потери данных. В файле ASF сведения о чересстрочную развертке хранятся в виде модулей обработки данных, которые приложение применяет к каждому примеру с помощью метода **иамвмбуфферпасскаллбакк** , описанного выше. Чтобы закодировать файл, сохраняющий исходные параметры развертки, выполните следующие действия.

-   Реализуйте класс, который поддерживает **иамвмбуфферпасскаллбакк** , и напишите функцию Notify, которая задает флаги чересстрочную развертки для каждого образца. Эта функция будет вызываться модулем записи WM ASF до обработки каждого примера.


```C++
// Set to WM_CT_TOP_FIELD_FIRST if that is your format.
BYTE flag = WM_CT_INTERLACED | WM_CT_BOTTOM_FIELD_FIRST;
            HRESULT hr = pNSSBuffer3->SetProperty(WM_SampleExtensionGUID_ContentType, (void*) &flag, WM_SampleExtension_ContentType_Size);
           
```



-   Перед передачей профиля в фильтр задайте расширения единиц обработки данных в профиле.


```C++
hr = pWMStreamConfig2->AddDataUnitExtension( WM_SampleExtensionGUID_ContentType, WM_SampleExtension_ContentType_Size, NULL, 0 );
```



-   После настройки фильтра с помощью профиля получите интерфейс **IWMWriterAdvanced2** из модуля записи WM ASF и вызовите метод **сетинпутсеттингс** .

`// Must do this first.`

`hr = pConfigAsfWriter2->ConfigureFilterUsingProfile(pProfile);`


```C++
  
CComPtr<IServiceProvider> pProvider;
  CComPtr<IWMWriterAdvanced2> pWMWA2;
  hr = pConfigAsfWriter2->QueryInterface( __uuidof(IServiceProvider),
                                         (void**)&pProvider);
  if (SUCCEEDED(hr))
  {
      hr = pProvider->QueryService(IID_IWMWriterAdvanced2,
                    IID_IWMWriterAdvanced2,
                    (void**)&pWMWA2);
  }
  BOOL pValue = TRUE;
 // Set the first parameter to your actual input number.
 hr = pWMWA2->SetInputSetting(0, g_wszInterlacedCoding,
              WMT_TYPE_BOOL, (BYTE*) &pValue, sizeof(WMT_TYPE_BOOL));
            
```



 

 