---
title: Включение ускорения видео DirectX
description: Включение ускорения видео DirectX
ms.assetid: 5cb2f564-88e3-4b60-bde3-6ccf69c97c48
keywords:
- Windows Пакет SDK для формата мультимедиа, включение ДКСВА
- Windows Пакет SDK для формата мультимедиа, ускорение видео DirectX (ДКСВА)
- Windows Пакет SDK для формата мультимедиа, ускорение видео
- Расширенный системный формат (ASF), включение ДКСВА
- ASF (Расширенный системный формат), включение ДКСВА
- Расширенный формат систем (ASF), ускорение видео DirectX (ДКСВА)
- ASF (Расширенный системный формат), ускорение видео DirectX (ДКСВА)
- Расширенный системный формат (ASF), ускорение видео
- ASF (Расширенный системный формат), ускорение видео
- Ускорение видео DirectX (ДКСВА), включение
- ДКСВА (ускорение видео DirectX), включение
- Ускорение видео DirectX (ДКСВА), порядок операций
- ДКСВА (ускорение видео DirectX), порядок операций
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 840549c9a148fdfe8cc67daf46645ffb0925369057fe71f0c17217bfd36823ee
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "119930767"
---
# <a name="enabling-directx-video-acceleration"></a>Включение ускорения видео DirectX

В этом разделе описано, как включить ускорение видео Microsoft® DirectX® при воспроизведении потокового содержимого в пользовательском проигрывателе.

## <a name="background"></a>Историческая справка

DirectX-ускорение видео (DirectX ва) — это спецификация API для аппаратного ускорения операций декодирования. Он позволяет программным декодерам разгружать определенные ресурсоемкие операции на графическую карту для обработки. Для конечных пользователей это может быть высокоскоростным видео, например воспроизведением полноэкранных DVD-дисков на старых компьютерах, оснащенных графическими картами, совместимыми с DirectX.

начиная с пакета SDK для серии Windows Media Format 9, фильтр оболочки DMO поддерживает DirectX ва. это означает, что для локального воспроизведения приложения могут использовать фильтр чтения WM ASF для воспроизведения Windows содержимого на основе мультимедиа и аппаратное ускорение DirectX, которое будет вызываться автоматически, если видеоадаптер поддерживает ее. Однако фильтр чтения WM ASF не поддерживает воспроизведение потокового содержимого. поэтому, если требуется поддержка DirectX ва при воспроизведении потокового содержимого в пользовательском проигрывателе, необходимо использовать альтернативный механизм, который используется проигрыватель Windows Media, начиная с серии Windows Media 9.

поскольку проигрыватель Windows Media была разработана до разработки фильтров касф, проигрыватель Windows Media имеет собственный фильтр исходного кода на основе пакета SDK Windows media Format для воспроизведения Windows содержимого на основе мультимедиа. фильтр источника мультимедиа WMP Windows предоставляет распакованные данные непосредственно в модули подготовки аудио и видео. модуль чтения WM ASF, напротив, доставляет сжатое содержимое в Windows мультимедийных объектов DirectX media (дмос), которые размещаются в оболочке DMO. на следующих диаграммах показаны различия между модулем чтения WM ASF и фильтром источника мультимедиа WMP Windows.

![несжатые образцы вывода выходных данных фильтра источника](images/wmp-dxva-graph.png)

![результаты сжатых выборок фильтра источника касф](images/qasf-dxva-graph.png)

Чтобы включить DirectX для потокового содержимого, необходимо создать настраиваемый фильтр исходного кода, подобный показанному на верхней диаграмме. по сути, этот фильтр будет использовать пакет SDK для Windows Media Format, чтобы создать экземпляр объекта чтения WM, распаковать образцы и отправить их вверх по выходным креплениям. В этом обсуждении предполагается, что фильтр источника уже создан и теперь готов к реализации поддержки DirectX.

чтобы включить DirectX ва, основная задача фильтра источника заключается в предоставлении модуля подготовки отчетов и декодера WMV DMO с интерфейсами, необходимыми для согласования подключения DirectX. Фильтр источника не участвует в этих согласованиях. После запуска потоковой передачи единственной задачей, связанной с DirectX, которая может выполнять фильтр источника, является изменение меток времени в видеороликах до того, как декодер WMV доставляет их в модуль подготовки видео. основной причиной этого является предоставление настраиваемого элемента управления временной шкалой, помимо того, что включены стандартные интерфейсы® DirectShow.

для обеспечения необходимого взаимодействия между пакетом SDK Windowsного формата мультимедиа, фильтром источника проигрывателя, Windows видеодекодером мультимедиа DMO, а также модулем подготовки Mixer или видео с наложением определяются три интерфейса. Эти интерфейсы описаны в следующей таблице.



| Интерфейс                                                        | Описание                                                                                                                                                                                        |
|------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**ивмкодекамвидеоакцелератор**](/previous-versions/windows/desktop/api/wmdxva/nn-wmdxva-iwmcodecamvideoaccelerator) | предоставлено Windowsным декодером мультимедиа DMO и вызывается фильтром источника проигрывателя мультимедиа для настройки различных подключений, необходимых для включения DirectX-поддержки при декодировании видеоматериалов Windows мультимедиа. |
| [**ивмплайертиместамфук**](/previous-versions/windows/desktop/api/wmdxva/nn-wmdxva-iwmplayertimestamphook)         | Реализовано в исходном фильтре проигрывателя. Он позволяет фильтру изменять метки времени в видеороликах перед их доставкой.                                                 |
| [**ивмреадеракцелератор**](/previous-versions/windows/desktop/api/wmsdkidl/nn-wmsdkidl-iwmreaderaccelerator)             | Реализуется для объекта модуля чтения WM. Он вызывается фильтром источника проигрывателя для получения интерфейсов из DMO декодера.                                                                             |



 

## <a name="order-of-operations-in-directx-vaenabled-playback"></a>Порядок операций в DirectX с поддержкой воспроизведения

В этом разделе описывается общий порядок операций во время выполнения для проигрывателя с поддержкой DirectX и его фильтра источников. В этом разделе рассматриваются следующие компоненты:

-   Сторонний проигрыватель мультимедиа, называемый проигрывателем.
-   настраиваемый фильтр источника, созданный проигрывателем, который использует пакет SDK Windows Media Format для распаковки Windows содержимого на основе мультимедиа.
-   Закрепление вывода видео в исходном фильтре проигрывателя, называемое выходным закреплением.
-   граф фильтра воспроизведения видео DirectShow, называемый графом.
-   Модуль подготовки видео с микшированием, называемый VMR.
-   объект асинхронного модуля чтения пакета SDK для Windows Media Format, называемый модулем чтения.
-   объект мультимедиа декодера DirectX Windows media, называемый DMO декодера.

Порядок операций выглядит следующим образом:

1.  Проигрыватель создает экземпляры исходного фильтра и объекта Reader. средство чтения создает видеодекодер DMO и задает для него (сжатый) тип входных данных. это должно произойти до того, как проигрыватель попытается настроить граф воспроизведения видео, так как пакет SDK и декодер DMO должны участвовать в процессе согласования с графом, а DMO должен иметь формат входных данных на шаге 9.
2.  Проигрыватель вызывает **играфбуилдер:: Render**, предоставляя ему выходной ПИН-код фильтра источника видео. на этом этапе диспетчер графа фильтров DirectShow пытается подключить VMR к фильтру источника видео проигрывателя.
3.  диспетчер графов фильтров вызывает **ипин:: Подключение** на выходном контакте фильтра источника видео проигрывателя.

шаги с 4 по 10 происходят в **ипин:: Подключение**.

1.  Фильтр источника получает интерфейс **ивмкодекамвидеоакцелератор** из метода **Ивмреадеракцелератор:: жеткодеЦинтерфаце** средства чтения. Если кодек не поддерживает DirectX ва, вызов **жеткодеЦинтерфаце** может завершиться ошибкой. В этом случае согласование выполняется обычным образом без поддержки DirectX.
2.  фильтр источника передает указатель **иамвидеоакцелератор** из пин-кода, переданного в **Подключение** , в DMOю декодера через **ивмкодекамвидеоакцелератор:: сетакцелераторинтерфаце**.
3.  затем фильтр источника делегирует оставшуюся часть операции **ипин:: Подключение** методу **кбасеаутпутпин:: Подключение** . Перечисление форматов с помощью пакета SDK продолжается, как и сегодня. если кодек поддерживает DirectX ва для подключенного содержимого, кодек DMO предписывает подтипы directx ва первыми, до тех пор, пока поддерживаются типы YUV и RGB. Если доступна поддержка DirectX ва, то шаги с 7 по 11 попытаются выполнить в контексте подтипа DirectX ва. В следующем фрагменте кода показано, как можно опознать мультимедийный подтип носителя DirectX.
    ```C++
    bool IsDXVASubtype( AM_MEDIA_TYPE * pmt )
    {
        // All DXVA types have the same last 3 DWORDs.
        // guidDXVA is the base GUID for all DXVA subtypes.

        GUID guidDXVA = { 0x00000000, 0xa0c7, 0x11d3, { 0xb9,0x84,0x00,0xc0,0x4f,0x2e,0x73,0xc5 } };

        unsigned long const * plguid;
        unsigned long const * plguidDXVA;
        plguid = (unsigned long const *)&pmt->subtype;
        plguidDXVA = (unsigned long *)&guidDXVA;

        if( ( plguid[1] == plguidDXVA[1] ) &&
            ( plguid[2] == plguidDXVA[2] ) &&
            ( plguid[3] == plguidDXVA[3] ) )
        {
            return true;
        }

        return false;
    }
    
    ```

    

4.  реализация **кбасеаутпутпин:: Подключение** вызывает **ипин:: комплетеконнект** во время шага 3. Если подтипы DirectX ва рассматриваются, выполняется согласование DirectX. Выходной ПИН-код вызывает **ивмкодекамвидеоакцелератор:: неготиатеконнектион**, передавая ему текущий тип выходного носителя.
5.  декодер DMO выполняет необходимое согласование с VMR через интерфейс **иамвидеоакцелератор** и возвращает идентификатор GUID подтипа видео, для которого согласованы два. закрепление вывода делегирует все вызовы **иамвидеоакцелераторнотифи** , полученные в ходе этого процесса, к интерфейсу **иамвидеоакцелераторнотифи** декодера DMO, который также можно получить с помощью метода **ивмреадеракцелератор:: жеткодеЦинтерфаце** .
6.  Если **неготиатеконнектион** , то выходной ПИН-код вызывает **Ивмкодекамвидеоакцелератор:: сетплайернотифи** с интерфейсом **ивмплайертиместамфук** . Этот обработчик позволяет исходному фильтру обновлять отметки времени в примерах перед их передачей в модуль подготовки отчетов.
7.  Фильтр источника вызывает **ивмреадеракцелератор:: notify** с согласованным типом носителя. Это позволяет модулю чтения обновлять свои внутренние переменные и фиксировать в DirectX ва. Это Последнее место, в котором кодек или модуль чтения могут завершиться ошибкой. Если какой либо из указанных выше шагов завершится ошибкой, фильтр источника должен вернуться к шагу 3 и попробовать следующий тип, перечисленный модулем чтения.
8.  Начинается воспроизведение. модуль чтения пропускает выходные буферы из декодера DMO, если тип выходных данных подключения — DirectX ва.
9.  Когда происходит **Ипин::D** , фильтр источника вызывает **Ивмкодекамвидеоакцелератор:: Сетакцелераторинтерфаце** со **значением NULL**. Это нарушает подключение DirectX о связи между кодеком и модулем подготовки.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[**Чтение файлов ASF**](reading-asf-files.md)
</dt> </dl>

 

 




