---
title: Защита файлов с помощью DRM версии 7 или более поздней
description: Защита файлов с помощью DRM версии 7 или более поздней
ms.assetid: 906f16c1-6573-47e9-8228-58dc126f6357
keywords:
- Windows Media Format SDK, создание защищенных файлов
- Windows Media Format SDK, защищенные файлы
- Расширенный формат систем (ASF), создание защищенных файлов
- ASF (Расширенный системный формат), создание защищенных файлов
- Расширенный формат систем (ASF), защищенные файлы
- ASF (Расширенный системный формат), защищенные файлы
- Расширенный системный формат (ASF), Вмстубдрм. lib
- ASF (Расширенный системный формат), Вмстубдрм. lib
- Вмстубдрм. lib, создание защищенных файлов
- Вмстубдрм. lib, защищенные файлы
- Управление цифровыми правами (DRM), Вмстубдрм. lib
- DRM (Управление цифровыми правами), Вмстубдрм. lib
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7ee809ea73401f22e4554e74c2ecb8855a0384e0
ms.sourcegitcommit: ad672d3a10192c5ccac619ad2524407109266e93
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/25/2020
ms.locfileid: "105700821"
---
# <a name="protecting-files-with-drm-version-7-or-later"></a>Защита файлов с помощью DRM версии 7 или более поздней

Чтобы защитить файлы с помощью Windows Media DRM версии 7 или более поздней, используйте метод [**ивмдрмвритер:: сетдрматтрибуте**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmdrmwriter-setdrmattribute) объекта Writer для установки атрибутов DRM. Так как DRM версии 7 и более поздних версий включают уникальные лицензии для каждого защищенного файла или набора файлов, интерфейс **ивмдрмвритер** также имеет методы для создания ключей. Эти методы предоставляются только для удобства.

Чтобы защитить файлы ASF с помощью DRM версии 7 или более поздней, выполните следующие действия.

1.  Свяжите с Вмстубдрм. lib и при необходимости отменяйте связь вмвкоре. lib.
2.  Чтобы создать модуль записи DRM, вызовите функцию [**вмкреатевритер**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-wmcreatewriter) . Первый аргумент зарезервирован и должен иметь значение **null**.
3.  Задайте профиль для модуля записи, который следует использовать, вызвав [**ивмвритер:: сетпрофиле**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmwriter-setprofile) или [**Ивмвритер:: сетпрофилебид**](/previous-versions/windows/desktop/api/wmsdkidl/nf-wmsdkidl-iwmwriter-setprofilebyid). Перед установкой атрибутов DRM необходимо задать профиль в модуле записи. DRM поддерживается только для профилей, использующих видеокодеки Windows Media Audio или Windows Media.
4.  Получите интерфейс [**ивмдрмвритер**](/previous-versions/windows/desktop/api/wmsdkidl/nn-wmsdkidl-iwmdrmwriter) объекта записи.
5.  Вызовите метод [**ивмдрмвритер:: сетдрматтрибуте**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmdrmwriter-setdrmattribute) и задайте для параметра [**использовать \_ расширенную \_ DRM**](use-advanced-drm.md) значение **true**.
6.  Если необходимо создать новое начальное значение ключа, вызовите [**ивмдрмвритер:: женератекэйсид**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmdrmwriter-generatekeyseed). В большинстве случаев вы будете повторно использовать начальное значение ключа, которое было создано ранее. Это значение должно оставаться секретным; Он не записывается в файл.
7.  Вызовите метод [**ивмдрмвритер:: женератекэйид**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmdrmwriter-generatekeyid) , чтобы создать идентификатор ключа, который является вторым значением, используемым для создания фактического ключа. В отличие от начального значения ключа, идентификатор ключа является открытым и записывается в файл в заголовке DRM в открытом виде. Создайте новый идентификатор ключа для каждого создаваемого файла.
8.  При необходимости вызовите метод **ивмдрмвритер:: женератесигнингкэйпаир** , чтобы создать открытый и закрытый ключи, которые будут использоваться для подписания объекта заголовка Advanced DRM ASF. Дополнительные сведения об этих ключах см. в разделе [**ивмдрмвритер:: женератесигнингкэйпаир**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmdrmwriter-generatesigningkeypair).
9.  При необходимости получите значения для заполнения объекта цифровой подписи в заголовке DRM. Если в системе не установлена рабочая версия диспетчера прав Windows Media, необходимо настроить объект цифровой подписи в заголовке файла ASF, указав следующие четыре атрибута, которые должны быть получены от корпорации Майкрософт:

    -   [**\_ЛАСИГНАТУРЕРУТЦЕРТ DRM**](drm-lasignaturerootcert.md)
    -   [**\_ЛАСИГНАТУРЕЦЕРТ DRM**](drm-lasignaturecert.md)
    -   [**\_ЛАСИГНАТУРЕЛИКСРВЦЕРТ DRM**](drm-lasignaturelicsrvcert.md)
    -   [**\_ЛАСИГНАТУРЕПРИВКЭЙ DRM**](drm-lasignatureprivkey.md)

    Если у вас установлена система Windows Media Rights Manager, вам не нужно задавать эти атрибуты в приложении. Компонент DRM извлечет эти атрибуты и будет использовать их для автоматического подписания заголовка. Если у вас есть активированная версия диспетчера прав Windows Media на другом компьютере и вы хотите повторно использовать эти значения объектов цифровых подписей, их можно найти в реестре. Сертификат сервера лицензирования хранится в папке HKEY \_ локальный \_ компьютер \\ программное \\ обеспечение \\ Сертификаты сервера лицензирования Microsoft WM Rights Manager \\ \\ : cert1, а корневой сертификат хранится в папке hKey на \_ локальном \_ компьютере \\ Software \\ Microsoft \\ WM Rights Manager \\ Сертификаты сервера лицензий \\ : cert2. При защите файлов с помощью DRM версии 7 необходимо использовать значения из этих разделов реестра. Для **\_ Свойства ласигнатурепривкэй DRM** используйте либо **женератесигнингкэйсекс** (с помощью пакета SDK Windows Media Rights Manager), либо другое значение, установленное диспетчером прав Windows Media в разделе hKey \_ локальный \_ компьютер \\ программное обеспечение \\ Microsoft \\ WM Rights Manager \\ сервер лицензирования: info \_ Cert0. Для свойства **\_ ласигнатурецерт DRM** используйте либо **женератесигнингкэйсекс** (с помощью пакета SDK Windows Media Rights Manager), либо значение, установленное диспетчером прав Windows Media в разделе \_ hKey \_ Local Machine \\ Software \\ Microsoft \\ WM Rights Manager \\ Сертификаты сервера лицензирования \\ : cert0.

10. Вызовите метод [**ивмдрмвритер:: сетдрматтрибуте**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmdrmwriter-setdrmattribute) столько раз, сколько необходимо для настройки объекта модуля записи, который при необходимости установит необходимые АТРИБУТЫ заголовка DRM. Эти свойства сохраняются в течение времени существования объекта модуля записи или до тех пор, пока не будут сброшены новые значения. Их не нужно сбрасывать для каждого создаваемого файла.

    Объект модуля записи требует следующие свойства:

    -   [**\_ХЕАДЕРСИГНПРИВКЭЙ DRM**](drm-headersignprivkey.md)
    -   [**\_КЭЙСИД DRM**](drm-keyseed.md)
    -   [**\_V1LICENSEACQURL DRM**](drm-v1licenseacqurl.md)
    -   [**\_KEYID DRM**](drm-keyid.md)
    -   [**\_ЛИЦЕНСЕАККУРЛ DRM**](drm-licenseacqurl.md)

    Следующие свойства являются необязательными:

    -   [**Идентификатор \_ CONTENTID DRM**](drm-contentid.md)
    -   [**\_ИНДИВИДУАЛИЗЕДВЕРСИОН DRM**](drm-individualizedversion.md)

    Кроме того, вы можете указать определяемые пользователем атрибуты файла DRM непосредственно с помощью атрибута [**DRM \_ дрмхеадер**](drm-drmheader.md) Base. Можно добавить любой дополнительный атрибут, например "Дрмхеадер. Рекуиресап", например, способ передачи дополнительных сведений, которые будут использоваться сервером лицензирования при создании лицензии. Сервер лицензирования должен быть заранее осведомлен о дополнительных свойствах, которые вы добавляете. Обнаружить неизвестные свойства программным способом невозможно.

11. Запишите файл с помощью методов интерфейса [**ивмвритер**](/previous-versions/windows/desktop/api/wmsdkidl/nn-wmsdkidl-iwmwriter) , как описано в других разделах этой документации. Чтобы создать поток Live DRM, просто запишите его в сетевой приемник. Также можно выполнить запись в приемник push-уведомлений.
12. При необходимости создайте лицензию для файла с помощью Windows Media Rights Manager. Эта задача также может выполняться сервером лицензирования стороннего производителя. Для сценариев в режиме реального времени конечным пользователям необходимо получить лицензию либо перед началом потока, либо во время первой попытки подключения к ней.

**Примечание** . DRM не поддерживает версию этого пакета SDK на базе x64.

## <a name="related-topics"></a>См. также

<dl> <dt>

[**Атрибуты**](attributes.md)
</dt> <dt>

[**Список атрибутов DRM**](drm-attribute-list.md)
</dt> <dt>

[**Свойства DRM**](drm-properties.md)
</dt> <dt>

[**Интерфейс Ивмдрмвритер**](/previous-versions/windows/desktop/api/wmsdkidl/nn-wmsdkidl-iwmdrmwriter)
</dt> <dt>

[**Ивмхеадеринфо:: SetAttribute**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-iwmheaderinfo-setattribute)
</dt> <dt>

[**Интерфейс Ивмвритер**](/previous-versions/windows/desktop/api/wmsdkidl/nn-wmsdkidl-iwmwriter)
</dt> <dt>

[**Чтение защищенных файлов**](reading-protected-files.md)
</dt> <dt>

[**вмкреатевритер**](/previous-versions/windows/desktop/api/Wmsdkidl/nf-wmsdkidl-wmcreatewriter)
</dt> </dl>

 

 




