---
description: Описание использования наборов API в Windows 10 в операциях загрузчика.
title: Операция загрузчика набора API
ms.topic: article
ms.date: 10/14/2020
ms.openlocfilehash: 701409c0d8dac2c275add06d2502c8764d502aba
ms.sourcegitcommit: bf526e267d3991892733bdd229c66d5365cf244a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2021
ms.locfileid: "105719875"
---
# <a name="api-set-loader-operation"></a><span data-ttu-id="691d5-103">Операция загрузчика набора API</span><span class="sxs-lookup"><span data-stu-id="691d5-103">API set loader operation</span></span>

<span data-ttu-id="691d5-104">[Наборы API](windows-apisets.md) зависят от поддержки ОС в загрузчике библиотеки для эффективного представления перенаправления пространства имен модуля в процессе привязки библиотеки.</span><span class="sxs-lookup"><span data-stu-id="691d5-104">[API sets](windows-apisets.md) rely on OS support in the library loader to effectively introduce a module namespace redirection into the library binding process.</span></span> <span data-ttu-id="691d5-105">[Имя контракта набора API](windows-apisets.md#api-set-contract-names) используется загрузчиком библиотеки для выполнения перенаправления ссылки на двоичный файл целевого узла, который содержит соответствующую реализацию набора API.</span><span class="sxs-lookup"><span data-stu-id="691d5-105">The [API set contract name](windows-apisets.md#api-set-contract-names) is used by library loader to perform a runtime redirection of the reference to a target host binary that houses the appropriate implementation of the API set.</span></span>

<span data-ttu-id="691d5-106">Когда загрузчик встречает зависимость от набора API во время выполнения, загрузчик обращается к данным конфигурации в образе, чтобы определить двоичный файл узла для набора API.</span><span class="sxs-lookup"><span data-stu-id="691d5-106">When the loader encounters a dependency on an API set at run time, the loader consults configuration data in the image to identify the host binary for an API set.</span></span> <span data-ttu-id="691d5-107">Эти данные конфигурации называются **схемой набора API**.</span><span class="sxs-lookup"><span data-stu-id="691d5-107">This configuration data is called the **API set schema**.</span></span> <span data-ttu-id="691d5-108">Схема собирается как свойство операционной системы, а сопоставление наборов API и двоичных файлов может отличаться в зависимости от того, какие двоичные файлы включены в данное устройство.</span><span class="sxs-lookup"><span data-stu-id="691d5-108">The schema is assembled as a property of the OS, and the mapping between API sets and binaries may differ depending on which binaries are included in a given device.</span></span> <span data-ttu-id="691d5-109">Схема позволяет правильно маршрутизировать импортированную функцию в одном двоичном файле на разных устройствах, даже если имена модулей двоичного узла были переименованы или полностью переработаны на разных устройствах Windows.</span><span class="sxs-lookup"><span data-stu-id="691d5-109">The schema enables an imported function in a single binary to be routed correctly on different devices, even if the module names of the binary host have been renamed or completely refactored on different Windows devices.</span></span>

<span data-ttu-id="691d5-110">Windows 10 поддерживает два стандартных способа использования наборов API и взаимодействия с ними: **прямую переадресацию** и **обратную пересылку**.</span><span class="sxs-lookup"><span data-stu-id="691d5-110">Windows 10 supports two standard techniques to consume and interface with API sets: **direct forwarding** and **reverse forwarding**.</span></span>

### <a name="direct-forwarding"></a><span data-ttu-id="691d5-111">Прямая пересылка</span><span class="sxs-lookup"><span data-stu-id="691d5-111">Direct forwarding</span></span>

<span data-ttu-id="691d5-112">В этой конфигурации код, использующий непосредственный импорт, импортирует имя модуля набора API напрямую.</span><span class="sxs-lookup"><span data-stu-id="691d5-112">In this configuration, the consuming code imports an API set module name directly.</span></span> <span data-ttu-id="691d5-113">Этот импорт разрешается в одной операции и является наиболее эффективным методом с минимальными издержками.</span><span class="sxs-lookup"><span data-stu-id="691d5-113">This import is resolved in a single operation, and is the most efficient method with the least overhead.</span></span> <span data-ttu-id="691d5-114">По сути, это разрешение может указывать на различные двоичные файлы на разных устройствах Windows 10, как показано в следующем примере:</span><span class="sxs-lookup"><span data-stu-id="691d5-114">Conceptually, this resolution may point to different binaries on different Windows 10 devices, as is shown in the following example:</span></span>

<span data-ttu-id="691d5-115">Импортированный набор API: **api-feature1-l1-1-0.dll**</span><span class="sxs-lookup"><span data-stu-id="691d5-115">Imported API set: **api-feature1-l1-1-0.dll**</span></span>
-  <span data-ttu-id="691d5-116">КОМПЬЮТЕР с Windows — > **feature1.dll**</span><span class="sxs-lookup"><span data-stu-id="691d5-116">Windows PC -> **feature1.dll**</span></span>
-  <span data-ttu-id="691d5-117">HoloLens — > **feature1_holo.dll**</span><span class="sxs-lookup"><span data-stu-id="691d5-117">HoloLens -> **feature1_holo.dll**</span></span>
-  <span data-ttu-id="691d5-118">IoT — > **feature1_iot.dll**</span><span class="sxs-lookup"><span data-stu-id="691d5-118">IoT -> **feature1_iot.dll**</span></span>

<span data-ttu-id="691d5-119">Поскольку сопоставления хранятся в пользовательском хранилище данных схемы, это означает, что имя набора API, заканчивающееся на **. dll** , не ссылается непосредственно на файл на диске.</span><span class="sxs-lookup"><span data-stu-id="691d5-119">Because the mappings are kept in a custom schema data repository, it means that an API set name that ends with **.dll** does not directly refer to a file on disk.</span></span> <span data-ttu-id="691d5-120">Часть **. dll** имени набора API является только соглашением, необходимым загрузчику.</span><span class="sxs-lookup"><span data-stu-id="691d5-120">The **.dll** part of the API set name is only a convention required by the loader.</span></span> <span data-ttu-id="691d5-121">Имя набора API больше похоже на псевдоним или виртуальное имя для физического DLL-файла.</span><span class="sxs-lookup"><span data-stu-id="691d5-121">The API set name is more like an alias or a virtual name for a physical DLL file.</span></span> <span data-ttu-id="691d5-122">Это делает имя переносимым во всем диапазоне устройств Windows 10.</span><span class="sxs-lookup"><span data-stu-id="691d5-122">This makes the name portable across the entire range of Windows 10 devices.</span></span>

### <a name="reverse-forwarding"></a><span data-ttu-id="691d5-123">Обратная переадресация</span><span class="sxs-lookup"><span data-stu-id="691d5-123">Reverse forwarding</span></span>

<span data-ttu-id="691d5-124">Хотя имена наборов API предоставляют устойчивое пространство имен для модулей на разных устройствах, не всегда практично преобразовывать каждый двоичный файл в эту новую систему.</span><span class="sxs-lookup"><span data-stu-id="691d5-124">While API set names provide a stable namespace for modules across devices, it is not always practical to convert every binary to this new system.</span></span> <span data-ttu-id="691d5-125">Например, приложение может быть широко распространено в течение многих лет, а повторная компиляция двоичных файлов приложения может оказаться невыполнимой.</span><span class="sxs-lookup"><span data-stu-id="691d5-125">For example, an application may have been in common use for many years, and recompiling the application's binaries may not be feasible.</span></span> <span data-ttu-id="691d5-126">Кроме того, для некоторых приложений может потребоваться продолжить работу в системах, созданных до того, как были введены определенные наборы API.</span><span class="sxs-lookup"><span data-stu-id="691d5-126">Additionally, some applications may need to continue to run on systems built before specific API sets were introduced.</span></span>

<span data-ttu-id="691d5-127">Чтобы обеспечить этот уровень совместимости, система *серверов пересылки* предоставляется на всех устройствах Windows 10, охватывающих подмножество поверхности API Win32.</span><span class="sxs-lookup"><span data-stu-id="691d5-127">To accommodate this level of compatibility, a system of *forwarders* are provided on all Windows 10 devices that cover a subset of the Win32 API surface.</span></span> <span data-ttu-id="691d5-128">Эти серверы пересылки используют имена модулей, которые были введены на компьютерах с Windows, и используют систему набора API для обеспечения совместимости на всех устройствах Windows 10.</span><span class="sxs-lookup"><span data-stu-id="691d5-128">These forwarders use the module names that were introduced on Windows PCs, and leverage the API Set system to provide compatibility across all Windows 10 devices.</span></span>

<span data-ttu-id="691d5-129">Операция загрузчика ведет себя следующим образом:</span><span class="sxs-lookup"><span data-stu-id="691d5-129">The loader operation behaves like this:</span></span>

1.  <span data-ttu-id="691d5-130">На устройстве, отличном от компьютера Windows, загрузчик представляет собой неуправляемую зависимость имени модуля ПК Windows, которая отсутствует на устройстве.</span><span class="sxs-lookup"><span data-stu-id="691d5-130">On a device other than a Windows PC, the loader is presented a legacy Windows PC module name dependency that is not present on the device.</span></span>
2.  <span data-ttu-id="691d5-131">Загрузчик находит сервер пересылки набора API для этого модуля и загружает его в память.</span><span class="sxs-lookup"><span data-stu-id="691d5-131">The loader locates an API set forwarder for this module and loads it into memory.</span></span>
3.  <span data-ttu-id="691d5-132">Сервер пересылки имеет сопоставление для набора API с заданной вызываемой функцией.</span><span class="sxs-lookup"><span data-stu-id="691d5-132">The forwarder has a mapping for the API set for the given function being called.</span></span>
4.  <span data-ttu-id="691d5-133">Загрузчик находит правильный двоичный файл узла для данного устройства.</span><span class="sxs-lookup"><span data-stu-id="691d5-133">The loader finds the proper host binary for the given device.</span></span>

<span data-ttu-id="691d5-134">По сути, сопоставление выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="691d5-134">Conceptually, the mapping looks like:</span></span>

<span data-ttu-id="691d5-135">Импортированная библиотека DLL: **feature1.dll**</span><span class="sxs-lookup"><span data-stu-id="691d5-135">Imported DLL: **feature1.dll**</span></span>
- <span data-ttu-id="691d5-136">КОМПЬЮТЕР с Windows — > **feature1.dll**</span><span class="sxs-lookup"><span data-stu-id="691d5-136">Windows PC -> **feature1.dll**</span></span>
- <span data-ttu-id="691d5-137">> **api-feature1-l1-1-0.dll** сервера > HoloLens- **feature1.dll**  ->  **feature1_holo.dll**</span><span class="sxs-lookup"><span data-stu-id="691d5-137">HoloLens -> **feature1.dll** forwarder -> **api-feature1-l1-1-0.dll** -> **feature1_holo.dll**</span></span>
- <span data-ttu-id="691d5-138">Сервер пересылки IOT-> **feature1.dll** > **api-feature1-l1-1-0.dll**  ->  **feature1_iot.dll**</span><span class="sxs-lookup"><span data-stu-id="691d5-138">IoT -> **feature1.dll** forwarder -> **api-feature1-l1-1-0.dll** -> **feature1_iot.dll**</span></span>

<span data-ttu-id="691d5-139">Конечный результат функционально аналогичен [прямой пересылке](#direct-forwarding), но он выполняет эту задачу таким образом, чтобы максимально повысить уровень совместимости приложений.</span><span class="sxs-lookup"><span data-stu-id="691d5-139">The end result is functionally the same as [direct forwarding](#direct-forwarding), but it accomplishes it in a way that maximizes application compatibility.</span></span>

> [!NOTE]
> <span data-ttu-id="691d5-140">Обратная переадресация обеспечивает покрытие только для подмножества поверхности API Win32.</span><span class="sxs-lookup"><span data-stu-id="691d5-140">Reverse forwarding provides coverage only for a subset of the Win32 API surface.</span></span> <span data-ttu-id="691d5-141">Он не позволяет запускать приложения, предназначенные для настольных версий Windows 10, на всех устройствах с Windows 10.</span><span class="sxs-lookup"><span data-stu-id="691d5-141">It does not allow applications that target desktop versions of Windows 10 to run on all Windows 10 devices.</span></span>
