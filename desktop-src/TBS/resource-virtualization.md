---
title: Виртуализация ресурсов
description: Виртуализация ресурсов
ms.assetid: ead0e99a-94da-4e80-bb68-d8f4b199173d
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f340b1a1bddfb3fd591452e028c80403b9c7e02f
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2019
ms.locfileid: "103777354"
---
# <a name="resource-virtualization"></a><span data-ttu-id="5589d-103">Виртуализация ресурсов</span><span class="sxs-lookup"><span data-stu-id="5589d-103">Resource Virtualization</span></span>

<span data-ttu-id="5589d-104">Основной функцией TBS является эффективное совместное использование определенных ограниченных ресурсов TPM: ключей, авторизации и транспортных сеансов.</span><span class="sxs-lookup"><span data-stu-id="5589d-104">The primary function of the TBS is to efficiently share certain limited TPM resources: keys, authorization, and transport sessions.</span></span>

<span data-ttu-id="5589d-105">При создании экземпляра одного из этих ресурсов TBS создает виртуальный экземпляр ресурса и возвращает его в поток команд результата (вместо фактического экземпляра Handle, возвращенного доверенным платформенным модулем).</span><span class="sxs-lookup"><span data-stu-id="5589d-105">When an instance of one of these resources is created, the TBS creates a virtual instance of the resource, and returns a handle to this virtual instance in the result command stream (rather than the actual handle instance returned by the TPM).</span></span> <span data-ttu-id="5589d-106">TBS поддерживает сопоставление между виртуальным и фактическим внутренним обработчиком.</span><span class="sxs-lookup"><span data-stu-id="5589d-106">The TBS maintains a mapping between the virtual handle and the actual handle internally.</span></span> <span data-ttu-id="5589d-107">Если в доверенном платформенном модуле недостаточно свободного пространства для хранения большего количества ресурсов заданного типа, существующие экземпляры ресурса будут выборочно сохранены и исключены, пока доверенный платформенный модуль не сможет разместить новый ресурс.</span><span class="sxs-lookup"><span data-stu-id="5589d-107">If the TPM runs out of space to hold more resources of a given type, existing instances of the resource are selectively saved and evicted until the TPM can hold the new resource.</span></span> <span data-ttu-id="5589d-108">Когда старые ресурсы снова потребуются, TBS загружает сохраненные контексты (при необходимости сохраняет и удаляет другие ресурсы) перед отправкой команды.</span><span class="sxs-lookup"><span data-stu-id="5589d-108">When the old resources are required again, the TBS loads the saved contexts (saving and evicting other resources if necessary) before submitting the command.</span></span>

<span data-ttu-id="5589d-109">Вся виртуализация в TBS выполняется от имени определенного контекста.</span><span class="sxs-lookup"><span data-stu-id="5589d-109">All virtualization in the TBS is performed on behalf of a specific context.</span></span> <span data-ttu-id="5589d-110">Каждому контексту предоставляется доступ только к виртуальным ресурсам, созданным специально для его имени, а также к физическим ресурсам доверенного платформенного модуля, которые соответствуют этим виртуальным ресурсам.</span><span class="sxs-lookup"><span data-stu-id="5589d-110">Each context is only allowed to access virtual resources created specifically on its behalf, as well as the physical resources on the TPM that corresponds to those virtual resources.</span></span> <span data-ttu-id="5589d-111">По умолчанию общее число виртуальных ресурсов ограничено 500.</span><span class="sxs-lookup"><span data-stu-id="5589d-111">By default, the total number of all virtualized resources is limited to 500.</span></span> <span data-ttu-id="5589d-112">Это число можно изменить путем создания или изменения значения реестра **DWORD** с именем **максресаурцес** в разделе **hKey \_ Local \_ Machine** \\ **Software** \\ **Microsoft** \\ **TPM**.</span><span class="sxs-lookup"><span data-stu-id="5589d-112">This number can be altered by creating or modifying a **DWORD** registry value named **MaxResources** under **HKEY\_LOCAL\_MACHINE**\\**Software**\\**Microsoft**\\**Tpm**.</span></span> <span data-ttu-id="5589d-113">Использование ресурсов TBS в режиме реального времени можно наблюдать с помощью средства "системный монитор" для отслеживания количества ресурсов TBS.</span><span class="sxs-lookup"><span data-stu-id="5589d-113">Real-time TBS resource usage can be observed by using the Performance Monitor tool to track the number of TBS resources.</span></span> <span data-ttu-id="5589d-114">Это ограничение стало устаревшим в Windows 8 и Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="5589d-114">This restriction became obsolete with Windows 8 and Windows Server 2012.</span></span>

<span data-ttu-id="5589d-115">Ограниченные ресурсы TPM, которые не виртуализированы TBS (например, счетчики и хранилище NV), должны совместно использоваться программными стеками.</span><span class="sxs-lookup"><span data-stu-id="5589d-115">Limited TPM resources that are not virtualized by the TBS (such as counters and NV store) must be cooperatively shared among software stacks.</span></span>

> [!Note]  
> <span data-ttu-id="5589d-116">В результате виртуализации этого дескриптора происходит сбой команд, которые включают в себя дескрипторы ключей в вычислении параметров авторизации HMAC.</span><span class="sxs-lookup"><span data-stu-id="5589d-116">This handle virtualization causes commands that include key handles in the calculation of HMAC authorization parameters to fail.</span></span> <span data-ttu-id="5589d-117">В результате многие команды, устаревшие в TPM версии 1,2, не могут использоваться программным обеспечением приложения в среде TBS.</span><span class="sxs-lookup"><span data-stu-id="5589d-117">As a result, many commands deprecated in TPM version 1.2 cannot be used by application software in the TBS environment.</span></span>

 

## <a name="resource-limits"></a><span data-ttu-id="5589d-118">Ограничения ресурсов</span><span class="sxs-lookup"><span data-stu-id="5589d-118">Resource Limits</span></span>

<span data-ttu-id="5589d-119">TPM позволяет вызывающим объектам запрашивать свои возможности, чтобы определить, сколько места доступно для определенных типов ресурсов.</span><span class="sxs-lookup"><span data-stu-id="5589d-119">The TPM enables callers to query its capabilities to determine how much space is available for certain types of resources.</span></span> <span data-ttu-id="5589d-120">Некоторые из этих ограничений ресурсов, например объем пространства, доступного для ключей, сеансов авторизации и транспортных сеансов, эффективно расширяются службой TBS с помощью виртуализации.</span><span class="sxs-lookup"><span data-stu-id="5589d-120">Some of these resource limits, such as the amount of space available for keys, authorization sessions, and transport sessions, are effectively extended by the TBS through virtualization.</span></span> <span data-ttu-id="5589d-121">Ограничения TBS, которые управляются параметром реестра **максресаурцес** , обычно гораздо выше, чем фактические ограничения базового оборудования TPM.</span><span class="sxs-lookup"><span data-stu-id="5589d-121">TBS limitations, which are controlled by the **MaxResources** registry setting, are usually far larger than the actual limitations of the underlying TPM hardware.</span></span> <span data-ttu-id="5589d-122">Не предоставляется механизм для запроса ограничений TBS отдельно от ограничений оборудования TPM.</span><span class="sxs-lookup"><span data-stu-id="5589d-122">No mechanism is supplied for querying TBS limitations separately from the TPM hardware limits.</span></span> <span data-ttu-id="5589d-123">Это ограничение TBS стало устаревшим в Windows 8 и Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="5589d-123">This TBS limitation became obsolete with Windows 8 and Windows Server 2012.</span></span>

## <a name="keys"></a><span data-ttu-id="5589d-124">Ключи</span><span class="sxs-lookup"><span data-stu-id="5589d-124">Keys</span></span>

<span data-ttu-id="5589d-125">TBS соединяет дескрипторы ключей таким образом, чтобы ключи могли быть прозрачно выгружены из доверенного платформенного модуля, если они не используются и не загружаются обратно в доверенный платформенный модуль при необходимости.</span><span class="sxs-lookup"><span data-stu-id="5589d-125">The TBS virtualizes key handles so that keys can be transparently unloaded from the TPM when they are not being used and loaded back onto the TPM when they are needed.</span></span> <span data-ttu-id="5589d-126">При создании ключа TBS связывает виртуальный обработчик с загруженным ключом.</span><span class="sxs-lookup"><span data-stu-id="5589d-126">When a key is created, the TBS associates a virtual handle with the loaded key.</span></span> <span data-ttu-id="5589d-127">Один и тот же виртуальный маркер используется в течение времени существования ресурса.</span><span class="sxs-lookup"><span data-stu-id="5589d-127">The same virtual handle is used for the lifetime of the resource.</span></span> <span data-ttu-id="5589d-128">Дескрипторы виртуальных ключей допустимы только в контексте, в котором они были созданы, а связанные ресурсы не сохраняются за время существования контекста.</span><span class="sxs-lookup"><span data-stu-id="5589d-128">Virtual key handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the context.</span></span>

-   <span data-ttu-id="5589d-129">Создание ключей с помощью \_ LOADKEY2 TPM</span><span class="sxs-lookup"><span data-stu-id="5589d-129">Creating Keys with TPM\_LoadKey2</span></span>

    <span data-ttu-id="5589d-130">Если ключ создается с помощью \_ команды TPM LoadKey2, TPM2 \_ КРЕАТЕПРИМАРИ, TPM2 \_ Load или TPM2 \_ лоадекстернал, TBS заменяет маркер в потоке возвращаемого байта виртуальным ключом, который имеет свой выбор.</span><span class="sxs-lookup"><span data-stu-id="5589d-130">If a key is created by using the TPM\_LoadKey2, TPM2\_CreatePrimary, TPM2\_Load, or TPM2\_LoadExternal command, the TBS replaces the handle in the return byte stream with a virtual key handle of its choosing.</span></span> <span data-ttu-id="5589d-131">В результате TBS гарантирует уникальность каждого виртуального обработчика.</span><span class="sxs-lookup"><span data-stu-id="5589d-131">As a result, the TBS ensures that each virtual handle is unique.</span></span> <span data-ttu-id="5589d-132">Если TBS обнаруживает конфликт (очень маловероятное событие), TBS выгружает ключ из TPM и информирует вызывающее программное обеспечение.</span><span class="sxs-lookup"><span data-stu-id="5589d-132">If the TBS detects a collision (an extremely unlikely event), the TBS unloads the key from the TPM and informs the calling software.</span></span> <span data-ttu-id="5589d-133">Затем программное обеспечение может повторно отправить операцию.</span><span class="sxs-lookup"><span data-stu-id="5589d-133">The software can then resubmit the operation.</span></span> <span data-ttu-id="5589d-134">Этот процесс может повторяться до тех пор, пока TBS не получит уникальный маркер ключа.</span><span class="sxs-lookup"><span data-stu-id="5589d-134">This process can be repeated until the TBS gets a unique key handle.</span></span>

-   <span data-ttu-id="5589d-135">Очистка ключей</span><span class="sxs-lookup"><span data-stu-id="5589d-135">Clearing Keys</span></span>

    <span data-ttu-id="5589d-136">TBS делает недействительным обработку виртуального ключа при получении сообщения флушспеЦифик доверенного платформенного модуля \_ или TPM2 \_ флушконтекст для этого виртуального маркера из контекста клиента.</span><span class="sxs-lookup"><span data-stu-id="5589d-136">The TBS invalidates the virtual key handle when it receives a TPM\_FlushSpecific or TPM2\_FlushContext message for that virtual handle from the client context.</span></span> <span data-ttu-id="5589d-137">Если ключ физически находится в доверенном платформенном модуле при получении сообщения о сбросе, TBS удаляет ключ из TPM в это время.</span><span class="sxs-lookup"><span data-stu-id="5589d-137">If the key is physically present on the TPM when the flush message is received, the TBS flushes the key from the TPM at that time.</span></span>

-   <span data-ttu-id="5589d-138">Временное удаление ключей</span><span class="sxs-lookup"><span data-stu-id="5589d-138">Temporarily Removing Keys</span></span>

    <span data-ttu-id="5589d-139">При удалении ключа из доверенного платформенного модуля для освобождения места для нового элемента TBS выполняет команду савеконтекст доверенного платформенного модуля \_ или TPM2 \_ контекстсаве для ключа перед его исключением.</span><span class="sxs-lookup"><span data-stu-id="5589d-139">When evicting a key from the TPM to make room for a new item, the TBS executes a TPM\_SaveContext or TPM2\_ContextSave command on the key before evicting it.</span></span>

-   <span data-ttu-id="5589d-140">Восстановление ключей</span><span class="sxs-lookup"><span data-stu-id="5589d-140">Restoring Keys</span></span>

    <span data-ttu-id="5589d-141">Когда команда, ссылающаяся на загруженный ключ, отправляется в TBS, она обеспечивает физическое присутствие ключа в доверенном платформенном модуле.</span><span class="sxs-lookup"><span data-stu-id="5589d-141">When a command that references a loaded key is submitted to the TBS, it ensures that the key is physically present on the TPM.</span></span> <span data-ttu-id="5589d-142">Если ключ отсутствует, TBS восстанавливает его с вызовом TPM \_ лоадконтекст или TPM2 \_ контекстлоад.</span><span class="sxs-lookup"><span data-stu-id="5589d-142">If the key is not present, the TBS restores it with a call to TPM\_LoadContext or TPM2\_ContextLoad.</span></span> <span data-ttu-id="5589d-143">Если ключ не может быть восстановлен в доверенный платформенный модуль, то TBS возвращает TPM \_ E \_ Недопустимый \_ кэйхандле в качестве результата TPM.</span><span class="sxs-lookup"><span data-stu-id="5589d-143">If a key cannot be restored to the TPM, the TBS returns TPM\_E\_INVALID\_KEYHANDLE as the TPM result.</span></span>

<span data-ttu-id="5589d-144">TBS заменяет каждый виртуальный маркер, связанный с ключом в потоке команд, физическим маркером ключа, загруженного в доверенный платформенный модуль.</span><span class="sxs-lookup"><span data-stu-id="5589d-144">The TBS replaces each virtual handle associated with a key in a command stream with the physical handle of the key loaded on the TPM.</span></span> <span data-ttu-id="5589d-145">Если команда отправляется с виртуальным маркером, который не распознается TBS в контексте вызывающего, то TBS форматирует поток ошибок для вызывающего объекта с доверенным платформенным модулем (TPM \_ E) \_ Недопустимый \_ кэйхандле.</span><span class="sxs-lookup"><span data-stu-id="5589d-145">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller with TPM\_E\_INVALID\_KEYHANDLE.</span></span>

## <a name="authorization-sessions"></a><span data-ttu-id="5589d-146">Сеансы авторизации</span><span class="sxs-lookup"><span data-stu-id="5589d-146">Authorization Sessions</span></span>

<span data-ttu-id="5589d-147">Сеансы авторизации создаются путем вызова TPM \_ оиап, TPM \_ ОСАП или дсап TPM \_ .</span><span class="sxs-lookup"><span data-stu-id="5589d-147">Authorization sessions are created by calling TPM\_OIAP, TPM\_OSAP, or TPM\_DSAP.</span></span> <span data-ttu-id="5589d-148">В каждом случае поток возвращаемого байта содержит физический маркер доверенного платформенного модуля для вновь созданного сеанса авторизации.</span><span class="sxs-lookup"><span data-stu-id="5589d-148">In each case, the return byte stream contains the physical TPM handle of the newly created authorization session.</span></span> <span data-ttu-id="5589d-149">TBS заменяет это виртуальным маркером.</span><span class="sxs-lookup"><span data-stu-id="5589d-149">The TBS replaces this with a virtual handle.</span></span> <span data-ttu-id="5589d-150">При последующем обращении к сеансу авторизации TBS заменяет виртуальный обработчик в потоке команд физическим маркером сеанса авторизации.</span><span class="sxs-lookup"><span data-stu-id="5589d-150">When the authorization session is subsequently referenced, the TBS replaces the virtual handle in the command stream with the physical handle of the authorization session.</span></span> <span data-ttu-id="5589d-151">TBS гарантирует, что время существования виртуального сеанса авторизации будет совпадать с жизненным циклом физического сеанса авторизации.</span><span class="sxs-lookup"><span data-stu-id="5589d-151">The TBS ensures that the lifetime of the virtual authorization session matches that of the physical authorization session.</span></span> <span data-ttu-id="5589d-152">Если клиент пытается использовать виртуальный обработчик с истекшим сроком действия, TBS форматирует поток ошибок с ошибкой \_ ИНВАЛИДАУСХАНДЛЕ TPM.</span><span class="sxs-lookup"><span data-stu-id="5589d-152">If a client attempts to use an expired virtual handle, the TBS formats an error stream with error TPM\_INVALIDAUTHHANDLE.</span></span>

<span data-ttu-id="5589d-153">Слоты сеансов ограничены, и TBS может исключать внешние слоты, в которых будут сохраняться контексты сеансов авторизации.</span><span class="sxs-lookup"><span data-stu-id="5589d-153">Session slots are limited, and the TBS may run out of external slots in which to save authorization session contexts.</span></span> <span data-ttu-id="5589d-154">В этом случае TBS выбирает сеанс авторизации, чтобы сделать его недействительным, чтобы новый контекст мог быть успешно сохранен.</span><span class="sxs-lookup"><span data-stu-id="5589d-154">If this happens, the TBS chooses an authorization session to invalidate so that the new context can be successfully saved.</span></span> <span data-ttu-id="5589d-155">Приложение, которое пытается использовать старый контекст, потребует повторного создания сеанса авторизации.</span><span class="sxs-lookup"><span data-stu-id="5589d-155">An application that attempts to use the old context will need to re-create the authorization session.</span></span>

<span data-ttu-id="5589d-156">TBS делает виртуальный сеанс авторизации недействительным при возникновении любого из следующих случаев.</span><span class="sxs-lookup"><span data-stu-id="5589d-156">The TBS invalidates the virtual authorization session when any of the following cases occur:</span></span>

-   <span data-ttu-id="5589d-157">Флаг продолжения использования, связанный с сеансом авторизации в возвращенном потоке команд из доверенного платформенного модуля, имеет **значение false**.</span><span class="sxs-lookup"><span data-stu-id="5589d-157">The continue-use flag associated with the authorization session in the returned command stream from the TPM is **FALSE**.</span></span>
-   <span data-ttu-id="5589d-158">Команда, использующая сеанс авторизации, завершается ошибкой.</span><span class="sxs-lookup"><span data-stu-id="5589d-158">A command that uses an authorization session fails.</span></span>
-   <span data-ttu-id="5589d-159">Выполняется команда, которая делает сеанс авторизации, связанный с командой (например, TPM креатеврапкэй), недействительным \_ .</span><span class="sxs-lookup"><span data-stu-id="5589d-159">A command is executed that invalidates the authorization session associated with the command (such as TPM\_CreateWrapKey).</span></span>
-   <span data-ttu-id="5589d-160">Ключ, связанный с сеансом ОСАП или ДСАП, удаляется из доверенного платформенного модуля с помощью вызова TPM \_ флушспеЦифик или TPM2 \_ флушконтекст (вне зависимости от того, была ли эта команда создана с TBS или с программным обеспечением более высокого уровня).</span><span class="sxs-lookup"><span data-stu-id="5589d-160">A key associated with an OSAP or DSAP session is evicted from the TPM with a call to TPM\_FlushSpecific or TPM2\_FlushContext (without regard to whether this command originated with the TBS or with higher-level software).</span></span>

    <span data-ttu-id="5589d-161">TBS автоматически повторно синхронизирует сеансы авторизации после успешного выполнения определенных недетерминированных команд, чтобы убедиться в том, что состояние TBS остается соответствующим состоянию доверенного платформенного модуля.</span><span class="sxs-lookup"><span data-stu-id="5589d-161">The TBS will automatically resynchronize the authorization sessions after successful execution of certain nondeterministic commands to ensure that the TBS state remains consistent with the TPM state.</span></span> <span data-ttu-id="5589d-162">Затронутые команды:</span><span class="sxs-lookup"><span data-stu-id="5589d-162">The affected commands are:</span></span>

    -   <span data-ttu-id="5589d-163">\_ \_ Управление делегированием в модуле TPM \_</span><span class="sxs-lookup"><span data-stu-id="5589d-163">TPM\_ORD\_Delegate\_Manage</span></span>
    -   <span data-ttu-id="5589d-164">\_ \_ Креатеовнерделегатион делегата о доходе в TPM \_</span><span class="sxs-lookup"><span data-stu-id="5589d-164">TPM\_ORD\_Delegate\_CreateOwnerDelegation</span></span>
    -   <span data-ttu-id="5589d-165">\_ \_ Лоадовнерделегатион делегата о доходе в TPM \_</span><span class="sxs-lookup"><span data-stu-id="5589d-165">TPM\_ORD\_Delegate\_LoadOwnerDelegation</span></span>

<span data-ttu-id="5589d-166">В каждом из следующих случаев сеанс авторизации в доверенном платформенном модуле автоматически очищается модулем TPM:</span><span class="sxs-lookup"><span data-stu-id="5589d-166">In each of the following cases the authorization session on the TPM is flushed automatically by the TPM:</span></span>

-   <span data-ttu-id="5589d-167">Создание сеансов авторизации</span><span class="sxs-lookup"><span data-stu-id="5589d-167">Creating Authorization Sessions</span></span>

    <span data-ttu-id="5589d-168">Дескрипторы сеансов виртуальной авторизации допустимы только в контексте, в котором они были созданы, а связанные ресурсы не сохраняются за время существования соответствующего контекста.</span><span class="sxs-lookup"><span data-stu-id="5589d-168">Virtual authorization session handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the associated context.</span></span>

-   <span data-ttu-id="5589d-169">Очистка сеансов авторизации</span><span class="sxs-lookup"><span data-stu-id="5589d-169">Clearing Authorization Sessions</span></span>

    <span data-ttu-id="5589d-170">TBS делает виртуальный сеанс авторизации недействительным, если он получает \_ команду ФЛУШСПЕЦИФИК TPM или TPM2 \_ флушконтекст для виртуального маркера из контекста клиента.</span><span class="sxs-lookup"><span data-stu-id="5589d-170">The TBS invalidates the virtual authorization session if it receives a TPM\_FlushSpecific or TPM2\_FlushContext command for the virtual handle from the client context.</span></span> <span data-ttu-id="5589d-171">Если сеанс авторизации физически находится в доверенном платформенном модуле при получении команды Flush, TBS немедленно сбрасывает физический сеанс из доверенного платформенного модуля.</span><span class="sxs-lookup"><span data-stu-id="5589d-171">If the authorization session is physically present on the TPM when the flush command is received, the TBS flushes the physical session from the TPM immediately.</span></span>

-   <span data-ttu-id="5589d-172">Временное удаление сеансов авторизации</span><span class="sxs-lookup"><span data-stu-id="5589d-172">Temporarily Removing Authorization Sessions</span></span>

    <span data-ttu-id="5589d-173">При удалении сеанса авторизации из доверенного платформенного модуля для освобождения места для новой сущности TBS выполняет \_ САВЕКОНТЕКСТ TPM или TPM2 \_ контекстсаве в этом сеансе авторизации.</span><span class="sxs-lookup"><span data-stu-id="5589d-173">When evicting an authorization session from the TPM to make room for a new entity, the TBS executes TPM\_SaveContext or TPM2\_ContextSave on that authorization session.</span></span>

-   <span data-ttu-id="5589d-174">Восстановление сеансов авторизации</span><span class="sxs-lookup"><span data-stu-id="5589d-174">Restoring Authorization Sessions</span></span>

    <span data-ttu-id="5589d-175">Когда в TBS отправляется авторизованная команда доверенного платформенного модуля (TPM), TBS гарантирует, что все виртуальные сеансы авторизации, на которые ссылается команда, физически находятся в доверенном платформенном модуле.</span><span class="sxs-lookup"><span data-stu-id="5589d-175">When an authorized TPM command is submitted to the TBS, the TBS ensures that all virtual authorization sessions referred to in the command are physically present on the TPM.</span></span> <span data-ttu-id="5589d-176">Если какой-либо из сеансов авторизации отсутствует, TBS восстанавливает их с вызовом TPM \_ лоадконтекст или TPM2 \_ контекстлоад.</span><span class="sxs-lookup"><span data-stu-id="5589d-176">If any of the authorization sessions are not present, the TBS restores them with a call to TPM\_LoadContext or TPM2\_ContextLoad.</span></span> <span data-ttu-id="5589d-177">Если сеанс авторизации не удается восстановить в доверенный платформенный модуль, TBS возвращает TPM \_ E \_ Недопустимый \_ маркер в качестве результата TPM.</span><span class="sxs-lookup"><span data-stu-id="5589d-177">If an authorization session cannot be restored to the TPM, the TBS returns TPM\_E\_INVALID\_HANDLE as the TPM result.</span></span>

<span data-ttu-id="5589d-178">TBS заменяет каждый виртуальный обработчик, связанный с сеансом авторизации в потоке команд, физическим маркером сеанса авторизации, загруженного в доверенный платформенный модуль.</span><span class="sxs-lookup"><span data-stu-id="5589d-178">The TBS replaces each virtual handle associated with an authorization session in a command stream with the physical handle of the authorization session loaded on the TPM.</span></span>

<span data-ttu-id="5589d-179">Если команда отправляется с виртуальным маркером, который не распознается TBS в контексте вызывающего объекта, то TBS форматирует поток ошибок для вызывающего объекта с ошибкой \_ \_ Недопустимый маркер TPM E \_ .</span><span class="sxs-lookup"><span data-stu-id="5589d-179">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller with the error TPM\_E\_INVALID\_HANDLE.</span></span>

## <a name="transport-sessions"></a><span data-ttu-id="5589d-180">Транспортные сеансы</span><span class="sxs-lookup"><span data-stu-id="5589d-180">Transport Sessions</span></span>

> [!Note]  
> <span data-ttu-id="5589d-181">Обработка транспортных сеансов, описанных здесь, относится только к Windows Vista и Windows Server 2008.</span><span class="sxs-lookup"><span data-stu-id="5589d-181">The handling of transport sessions as described here is specific to Windows Vista and Windows Server 2008.</span></span>

 

<span data-ttu-id="5589d-182">Транспортные сеансы — это механизм, предоставляемый доверенным платформенным модулем, который позволяет стеку программного обеспечения шифровать данные в команде при их передаче между программным обеспечением и доверенным платформенным модулем.</span><span class="sxs-lookup"><span data-stu-id="5589d-182">Transport sessions are a mechanism provided by the TPM that enables a software stack to encrypt data in a command as it passes between the software and the TPM.</span></span> <span data-ttu-id="5589d-183">Это не дает злоумышленнику перехватывать данные по мере их прохождения через аппаратную шину.</span><span class="sxs-lookup"><span data-stu-id="5589d-183">This prevents an adversary from intercepting the data as it passes over the hardware bus.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="5589d-184">Шифруются только полезные данные.</span><span class="sxs-lookup"><span data-stu-id="5589d-184">Only the payload data is encrypted.</span></span> <span data-ttu-id="5589d-185">Выполняемые команды по-прежнему можно определить.</span><span class="sxs-lookup"><span data-stu-id="5589d-185">The commands being executed can still be identified.</span></span>

 

<span data-ttu-id="5589d-186">К сожалению, этот механизм также не позволяет TBS исследовать полезные данные.</span><span class="sxs-lookup"><span data-stu-id="5589d-186">Unfortunately, this mechanism also prevents the TBS from examining payload data.</span></span> <span data-ttu-id="5589d-187">В большинстве случаев это не является проблемой, поскольку TBS изменяет только дескрипторы, а не данные полезных данных.</span><span class="sxs-lookup"><span data-stu-id="5589d-187">In most cases this is not an issue because the TBS only modifies handles, not payload data.</span></span> <span data-ttu-id="5589d-188">Однако в случае \_ ЛОАДКОНТЕКСТ TPM для экземпляра возвращаемый маркер ресурса охватывается шифрованием.</span><span class="sxs-lookup"><span data-stu-id="5589d-188">However, in the case of TPM\_LoadContext for instance, the returned resource handle is covered by the encryption.</span></span> <span data-ttu-id="5589d-189">Таким образом, TBS не пытается выполнить \_ операцию ЛОАДКОНТЕКСТ TPM, охваченную транспортным сеансом.</span><span class="sxs-lookup"><span data-stu-id="5589d-189">Therefore, the TBS prevents attempts to perform a TPM\_LoadContext operation covered by a transport session.</span></span>

<span data-ttu-id="5589d-190">TBS блокирует следующие команды в сеансе транспорта:</span><span class="sxs-lookup"><span data-stu-id="5589d-190">The TBS blocks the following commands under transport session:</span></span>

-   <span data-ttu-id="5589d-191">\_ЕСТАБЛИШТРАНСПОРТ TPM</span><span class="sxs-lookup"><span data-stu-id="5589d-191">TPM\_EstablishTransport</span></span>
-   <span data-ttu-id="5589d-192">\_ЕКСЕКУТЕТРАНСПОРТ TPM</span><span class="sxs-lookup"><span data-stu-id="5589d-192">TPM\_ExecuteTransport</span></span>
-   <span data-ttu-id="5589d-193">\_Маркер завершения \_ TPM</span><span class="sxs-lookup"><span data-stu-id="5589d-193">TPM\_Terminate\_Handle</span></span>
-   <span data-ttu-id="5589d-194">\_ЛОАДКЭЙ TPM</span><span class="sxs-lookup"><span data-stu-id="5589d-194">TPM\_LoadKey</span></span>
-   <span data-ttu-id="5589d-195">\_ЕВИКТКЭЙ TPM</span><span class="sxs-lookup"><span data-stu-id="5589d-195">TPM\_EvictKey</span></span>
-   <span data-ttu-id="5589d-196">\_САВЕКЭЙКОНТЕКСТ TPM</span><span class="sxs-lookup"><span data-stu-id="5589d-196">TPM\_SaveKeyContext</span></span>
-   <span data-ttu-id="5589d-197">\_ЛОАДКЭЙКОНТЕКСТ TPM</span><span class="sxs-lookup"><span data-stu-id="5589d-197">TPM\_LoadKeyContext</span></span>
-   <span data-ttu-id="5589d-198">\_САВЕАУСКОНТЕКСТ TPM</span><span class="sxs-lookup"><span data-stu-id="5589d-198">TPM\_SaveAuthContext</span></span>
-   <span data-ttu-id="5589d-199">\_ЛОАДАУСКОНТЕКСТ TPM</span><span class="sxs-lookup"><span data-stu-id="5589d-199">TPM\_LoadAuthContext</span></span>
-   <span data-ttu-id="5589d-200">\_САВЕКОНТЕКСТ TPM</span><span class="sxs-lookup"><span data-stu-id="5589d-200">TPM\_SaveContext</span></span>
-   <span data-ttu-id="5589d-201">\_ЛОАДКОНТЕКСТ TPM</span><span class="sxs-lookup"><span data-stu-id="5589d-201">TPM\_LoadContext</span></span>
-   <span data-ttu-id="5589d-202">\_ФЛУШСПЕЦИФИК TPM</span><span class="sxs-lookup"><span data-stu-id="5589d-202">TPM\_FlushSpecific</span></span>

<span data-ttu-id="5589d-203">Если какая-либо из этих команд охватывается транспортным сеансом, TBS возвращает \_ команду TPM E \_ Embedded \_ \_ не поддерживается в качестве результата TPM.</span><span class="sxs-lookup"><span data-stu-id="5589d-203">When any one of these commands is covered by a transport session, the TBS returns TPM\_E\_EMBEDDED\_COMMAND\_UNSUPPORTED as the TPM result.</span></span>

<span data-ttu-id="5589d-204">Дескрипторы транспортного сеанса виртуализованы так же, как дескрипторы ключей и дескрипторы авторизации.</span><span class="sxs-lookup"><span data-stu-id="5589d-204">Transport session handles are virtualized in a manner similar to key handles and authorization handles.</span></span> <span data-ttu-id="5589d-205">Существует ограниченное число сохраненных слотов контекста сеанса транспорта, доступных в доверенном платформенном модуле.</span><span class="sxs-lookup"><span data-stu-id="5589d-205">There are a limited number of saved transport session context slots available on the TPM.</span></span>

<span data-ttu-id="5589d-206">TBS делает сеанс виртуального транспорта недействительным, если происходит одно из следующих условий:</span><span class="sxs-lookup"><span data-stu-id="5589d-206">The TBS invalidates the virtual transport session if any of the following cases occurs:</span></span>

-   <span data-ttu-id="5589d-207">Флаг продолжения использования, связанный с сеансом транспорта в потоке команд возврата из доверенного платформенного модуля, имеет **значение false**.</span><span class="sxs-lookup"><span data-stu-id="5589d-207">The continue-use flag associated with the transport session in the return command stream from the TPM is **FALSE**.</span></span>

    <span data-ttu-id="5589d-208">Как и в случае с сеансами авторизации, TBS автоматически повторно синхронизирует сеансы транспорта после успешного выполнения определенных недетерминированных команд, чтобы убедиться в том, что состояние TBS остается соответствующим состоянию доверенного платформенного модуля.</span><span class="sxs-lookup"><span data-stu-id="5589d-208">As with authorization sessions above, the TBS will automatically resynchronize transport sessions after successful execution of certain nondeterministic commands to ensure that the TBS state remains consistent with the TPM state.</span></span> <span data-ttu-id="5589d-209">Затронутые команды:</span><span class="sxs-lookup"><span data-stu-id="5589d-209">The affected commands are:</span></span>

    -   <span data-ttu-id="5589d-210">\_ \_ Управление делегированием в модуле TPM \_</span><span class="sxs-lookup"><span data-stu-id="5589d-210">TPM\_ORD\_Delegate\_Manage</span></span>
    -   <span data-ttu-id="5589d-211">\_ \_ Креатеовнерделегатион делегата о доходе в TPM \_</span><span class="sxs-lookup"><span data-stu-id="5589d-211">TPM\_ORD\_Delegate\_CreateOwnerDelegation</span></span>
    -   <span data-ttu-id="5589d-212">\_ \_ Лоадовнерделегатион делегата о доходе в TPM \_</span><span class="sxs-lookup"><span data-stu-id="5589d-212">TPM\_ORD\_Delegate\_LoadOwnerDelegation</span></span>

<span data-ttu-id="5589d-213">В каждом из этих случаев сеанс транспорта на доверенном платформенном модуле будет автоматически сброшен доверенным платформенным модулем:</span><span class="sxs-lookup"><span data-stu-id="5589d-213">In each of these cases, the transport session on the TPM will be flushed automatically by the TPM:</span></span>

-   <span data-ttu-id="5589d-214">Создание транспортных сеансов</span><span class="sxs-lookup"><span data-stu-id="5589d-214">Creating Transport Sessions</span></span>

    <span data-ttu-id="5589d-215">TBS создает виртуальный обработчик для каждого сеанса транспорта, созданного клиентом.</span><span class="sxs-lookup"><span data-stu-id="5589d-215">The TBS creates a virtual handle for each transport session created by a client.</span></span> <span data-ttu-id="5589d-216">Дескрипторы виртуального транспорта допустимы только в контексте, в котором они были созданы, а связанные ресурсы не сохраняются за время существования соответствующего контекста.</span><span class="sxs-lookup"><span data-stu-id="5589d-216">Virtual transport handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the associated context.</span></span>

-   <span data-ttu-id="5589d-217">Очистка сеансов транспорта</span><span class="sxs-lookup"><span data-stu-id="5589d-217">Clearing Transport Sessions</span></span>

    <span data-ttu-id="5589d-218">TBS делает сеанс виртуального транспорта недействительным, если он получает \_ команду ФЛУШСПЕЦИФИК TPM для виртуального маркера из контекста клиента.</span><span class="sxs-lookup"><span data-stu-id="5589d-218">The TBS invalidates the virtual transport session if it receives a TPM\_FlushSpecific command for the virtual handle from the client context.</span></span> <span data-ttu-id="5589d-219">Если во время получения команды FLUSH сеанс транспорта физически находится в доверенном платформенном модуле, TBS немедленно сбрасывает физический сеанс из доверенного платформенного модуля.</span><span class="sxs-lookup"><span data-stu-id="5589d-219">If the transport session is physically present on the TPM when the flush command is received, the TBS flushes the physical session from the TPM immediately.</span></span>

-   <span data-ttu-id="5589d-220">Временное удаление транспортных сеансов</span><span class="sxs-lookup"><span data-stu-id="5589d-220">Temporarily Removing Transport Sessions</span></span>

    <span data-ttu-id="5589d-221">При удалении сеанса транспорта из доверенного платформенного модуля для освобождения места для новой сущности TBS выполняет \_ САВЕКОНТЕКСТ TPM в этом сеансе транспорта.</span><span class="sxs-lookup"><span data-stu-id="5589d-221">When evicting a transport session from the TPM to make room for a new entity, the TBS executes TPM\_SaveContext on that transport session.</span></span>

-   <span data-ttu-id="5589d-222">Восстановление сеансов транспорта</span><span class="sxs-lookup"><span data-stu-id="5589d-222">Restoring Transport Sessions</span></span>

    <span data-ttu-id="5589d-223">Когда команда ексекутетранспорт доверенного платформенного модуля \_ отправляется в TBS, TBS гарантирует, что сеанс транспорта, на который ссылается команда, физически находится в доверенном платформенном модуле.</span><span class="sxs-lookup"><span data-stu-id="5589d-223">When a TPM\_ExecuteTransport command is submitted to the TBS, the TBS ensures that the transport session referred to in the command is physically present on the TPM.</span></span> <span data-ttu-id="5589d-224">Если сеанс транспорта отсутствует, TBS восстанавливает его с помощью вызова \_ ЛОАДКОНТЕКСТ TPM.</span><span class="sxs-lookup"><span data-stu-id="5589d-224">If the transport session is not present, the TBS restores it with a call to TPM\_LoadContext.</span></span>

<span data-ttu-id="5589d-225">TBS заменяет виртуальный обработчик, связанный с сеансом транспорта, в командном потоке физическим маркером сеанса транспорта, загруженного в доверенный платформенный модуль.</span><span class="sxs-lookup"><span data-stu-id="5589d-225">The TBS replaces the virtual handle associated with the transport session in a command stream with the physical handle of the transport session loaded on the TPM.</span></span> <span data-ttu-id="5589d-226">Если команда отправляется с виртуальным маркером, который не распознается TBS в контексте вызывающего объекта, то TBS форматирует поток ошибок для вызывающего объекта с помощью \_ \_ недействительного маркера "TPM E" \_ .</span><span class="sxs-lookup"><span data-stu-id="5589d-226">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller by using TPM\_E\_INVALID\_HANDLE.</span></span>

## <a name="exclusive-transport-sessions"></a><span data-ttu-id="5589d-227">Исключающие сеансы транспорта</span><span class="sxs-lookup"><span data-stu-id="5589d-227">Exclusive Transport Sessions</span></span>

<span data-ttu-id="5589d-228">Монопольные инкапсулированные сеансы передачи позволяют программному обеспечению верхнего уровня определить, обращалось ли какое-либо другое программное обеспечение к доверенному платформенному модулю во время цепочки команд.</span><span class="sxs-lookup"><span data-stu-id="5589d-228">Exclusive wrapped transport sessions are a way for top-level software to determine whether any other software has accessed the TPM during a chain of commands.</span></span> <span data-ttu-id="5589d-229">Они не предотвращают доступ к доверенному платформенному модулю другого программного обеспечения, они просто предоставляют создателю транспортного сеанса возможность определить, что какой-то другой доступ был выполнен.</span><span class="sxs-lookup"><span data-stu-id="5589d-229">They do not prevent other software from accessing the TPM, they just give the creator of the transport session a means of determining that some other access occurred.</span></span> <span data-ttu-id="5589d-230">TBS не выполняет никаких действий, чтобы мешать эксклюзивному транспортному сеансу, но он несколько не совместим с ними.</span><span class="sxs-lookup"><span data-stu-id="5589d-230">The TBS does not do anything specific to hinder exclusive transport sessions, but it is somewhat incompatible with them.</span></span> <span data-ttu-id="5589d-231">TBS пытается дублировать естественное поведение доверенного платформенного модуля, так как он является прозрачным, поэтому не дает предпочтений командам из контекстов, устанавливающих монопольный сеанс транспорта.</span><span class="sxs-lookup"><span data-stu-id="5589d-231">The TBS attempts to duplicate the natural behavior of the TPM by being transparent, so it does not favor commands from contexts that establish an exclusive transport session.</span></span> <span data-ttu-id="5589d-232">Например, если клиент б отправляет команду, когда клиент A находится в монопольном сеансе транспорта, он сделает недействительным монопольный сеанс транспорта клиента а.</span><span class="sxs-lookup"><span data-stu-id="5589d-232">For example, if client B submits a command when client A is in an exclusive transport session, then it will invalidate the exclusive transport session of client A.</span></span>

<span data-ttu-id="5589d-233">Команды, инициированные TBS, также могут прекратить монопольный сеанс транспорта.</span><span class="sxs-lookup"><span data-stu-id="5589d-233">Commands initiated by TBS can also terminate the exclusive transport session.</span></span> <span data-ttu-id="5589d-234">Это происходит, когда клиент а находится в монопольном сеансе транспорта, а команда, выполняемая клиентом, вызывает ресурс, который физически отсутствует в доверенном платформенном модуле.</span><span class="sxs-lookup"><span data-stu-id="5589d-234">This happens when client A is in an exclusive transport session, and a command executed by client A calls for a resource that is not physically present in the TPM.</span></span> <span data-ttu-id="5589d-235">Эта ситуация активирует диспетчер виртуализации TBS для выполнения \_ команды ЛОАДКОНТЕКСТ TPM для предоставления ресурса, который прерывает монопольный сеанс транспорта клиента a.</span><span class="sxs-lookup"><span data-stu-id="5589d-235">This situation triggers the TBS virtualization manager to execute a TPM\_LoadContext command to supply that resource, which terminates the exclusive transport session of client A.</span></span>

 

 




