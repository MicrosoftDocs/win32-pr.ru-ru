---
description: Восстановление после ошибки Invalid-Device
ms.assetid: 1f5c3458-70ca-45ba-ac33-5c7b9f092320
title: Восстановление после ошибки Invalid-Device
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ca20c32be46367f53a14ce26c39f980e3649b652
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104142409"
---
# <a name="recovering-from-an-invalid-device-error"></a><span data-ttu-id="e7de7-103">Восстановление после ошибки Invalid-Device</span><span class="sxs-lookup"><span data-stu-id="e7de7-103">Recovering from an Invalid-Device Error</span></span>

<span data-ttu-id="e7de7-104">Многие методы в ВАСАПИ возвращают ошибку с кодом АУДКЛНТ \_ E \_ \_ , если устройство конечной точки аудио, используемое клиентским приложением, становится недействительным.</span><span class="sxs-lookup"><span data-stu-id="e7de7-104">Many of the methods in WASAPI return error code AUDCLNT\_E\_DEVICE\_INVALIDATED if the audio endpoint device that the client application is using becomes invalid.</span></span> <span data-ttu-id="e7de7-105">Этот код ошибки указывает на то, что устройство конечной точки было отключено или перенастроено, отключено, удалено или иным образом недоступно для использования.</span><span class="sxs-lookup"><span data-stu-id="e7de7-105">This error code indicates that the endpoint device has been unplugged, or that the audio hardware or associated hardware resources have been reconfigured, disabled, removed, or otherwise made unavailable for use.</span></span> <span data-ttu-id="e7de7-106">Часто приложение может восстановиться после этой ошибки.</span><span class="sxs-lookup"><span data-stu-id="e7de7-106">Frequently, the application can recover from this error.</span></span>

>[!NOTE]
> <span data-ttu-id="e7de7-107">Сведения о восстановлении после недопустимых ошибок устройства при использовании пространственных аудио-API (Исак) см. в разделе [восстановление после ошибки Invalid-Device (пространственный звук)](recovering-from-an-invalid-device-error-spatial-sound.md) .</span><span class="sxs-lookup"><span data-stu-id="e7de7-107">For information on recovering from invalid device errors when using spatial audio APIs (ISAC), see [Recovering from an Invalid-Device Error (Spatial Sound)](recovering-from-an-invalid-device-error-spatial-sound.md)</span></span>

<span data-ttu-id="e7de7-108">Стратегия, которую приложение должно использовать для восстановления после \_ \_ недействительной ошибки устройства аудклнт E, зависит от того, \_ какие из следующих методов используются приложением для выбора устройства конечной точки аудио:</span><span class="sxs-lookup"><span data-stu-id="e7de7-108">The strategy that an application should use to recover from an AUDCLNT\_E\_DEVICE\_INVALIDATED error depends on which of the following techniques the application uses to select an audio endpoint device:</span></span>

-   <span data-ttu-id="e7de7-109">Всегда выбирайте устройство для подготовки аудио или записи звука по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="e7de7-109">Always select the default audio rendering or capture device.</span></span>
-   <span data-ttu-id="e7de7-110">Выберите конкретное устройство звуковой конечной точки.</span><span class="sxs-lookup"><span data-stu-id="e7de7-110">Select a specific audio endpoint device.</span></span>

<span data-ttu-id="e7de7-111">В последнем случае приложение автоматически выбирает определенное устройство в соответствии с внутренними требованиями или позволяет пользователю явно выбрать устройство из списка доступных устройств.</span><span class="sxs-lookup"><span data-stu-id="e7de7-111">In the latter case, either the application automatically selects a specific device based on internal requirements or it allows the user to explicitly select a device from a list of available devices.</span></span>

<span data-ttu-id="e7de7-112">Приложение, использующее устройство по умолчанию, может попытаться выполнить восстановление после \_ \_ \_ недействительной ошибки устройства аудклнт E, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="e7de7-112">An application that uses the default device can attempt to recover from an AUDCLNT\_E\_DEVICE\_INVALIDATED error as follows:</span></span>

1.  <span data-ttu-id="e7de7-113">Освободите интерфейс [**иаудиоклиент**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) и другие интерфейсы васапи, которые он получил на устройстве.</span><span class="sxs-lookup"><span data-stu-id="e7de7-113">Release the [**IAudioClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) interface and any other WASAPI interfaces that it has acquired on the device.</span></span>
2.  <span data-ttu-id="e7de7-114">Вызовите метод [**иммдевицеенумератор:: жетдефаултаудиоендпоинт**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) , чтобы получить текущее звуковое устройство по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="e7de7-114">Call the [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) method to get the current default audio device.</span></span>
3.  <span data-ttu-id="e7de7-115">Попытка активировать [**иаудиоклиент**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) на звуковом устройстве по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="e7de7-115">Attempt to activate [**IAudioClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) on the default audio device.</span></span>

<span data-ttu-id="e7de7-116">Выполнив описанные выше действия, приложение будет реагировать соответствующим образом, независимо от причины \_ \_ ошибки " \_ Ошибка недействительности устройства аудклнт".</span><span class="sxs-lookup"><span data-stu-id="e7de7-116">By following the preceding steps, the application tends to respond appropriately regardless of the cause of the AUDCLNT\_E\_DEVICE\_INVALIDATED error.</span></span> <span data-ttu-id="e7de7-117">Если перенастройка устройства по умолчанию привела к ошибке (например, если пользователь изменил формат потока, используемый устройством), то эти действия, если они были выполнены, позволят приложению продолжать использовать одно и то же устройство.</span><span class="sxs-lookup"><span data-stu-id="e7de7-117">If reconfiguration of the default device caused the error (for example, if the user changed the stream format used by the device), then these steps, if they succeed, enable the application to continue to use the same device.</span></span> <span data-ttu-id="e7de7-118">Если пользователь отключил или удалил устройство, которое использовалось приложением, и доступно другое устройство для использования роли устройства по умолчанию, приложение может продолжить работу с новым устройством по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="e7de7-118">If the user disabled or removed the device that the application was using and another device is available to assume the role of default device, then the application can continue by using the new default device.</span></span> <span data-ttu-id="e7de7-119">В любом случае приложение адаптируется автоматически, не требуя вмешательства пользователя.</span><span class="sxs-lookup"><span data-stu-id="e7de7-119">In either case, the application adapts automatically without requiring intervention by the user.</span></span>

<span data-ttu-id="e7de7-120">Приложение, которое выбирает конкретное устройство, может попытаться восстановиться \_ после \_ \_ ошибки недействительности устройства аудклнт E следующим образом:</span><span class="sxs-lookup"><span data-stu-id="e7de7-120">An application that selects a specific device can attempt to recover from the AUDCLNT\_E\_DEVICE\_INVALIDATED error as follows:</span></span>

1.  <span data-ttu-id="e7de7-121">Освободите интерфейс [**иаудиоклиент**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) и другие интерфейсы васапи, которые он получил на устройстве.</span><span class="sxs-lookup"><span data-stu-id="e7de7-121">Release the [**IAudioClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) interface and any other WASAPI interfaces that it has acquired on the device.</span></span>
2.  <span data-ttu-id="e7de7-122">Попытка активировать интерфейс [**иаудиоклиент**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) на том же устройстве.</span><span class="sxs-lookup"><span data-stu-id="e7de7-122">Attempt to activate an [**IAudioClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) interface on the same device.</span></span>
3.  <span data-ttu-id="e7de7-123">Если шаг 2 завершается неудачно, приложение может в качестве варианта предложить пользователю выбрать другое устройство.</span><span class="sxs-lookup"><span data-stu-id="e7de7-123">If step 2 fails, then the application can, as an option, prompt the user to select another device.</span></span>

<span data-ttu-id="e7de7-124">Шаг 2 может быть выполнен успешно, если устройство, используемое приложением, было перенастроено, но не отключено или удалено.</span><span class="sxs-lookup"><span data-stu-id="e7de7-124">Step 2 can succeed if the device being used by the application was reconfigured but not disabled or removed.</span></span> <span data-ttu-id="e7de7-125">В случае успеха шаг 2 позволяет приложению автоматически продолжать использовать то же устройство, не требуя вмешательства пользователя.</span><span class="sxs-lookup"><span data-stu-id="e7de7-125">If successful, step 2 enables the application to automatically continue to use the same device without requiring intervention by the user.</span></span> <span data-ttu-id="e7de7-126">Шаг 3 подходит, если приложение позволяет пользователю явно выбрать другое устройство после того, как пользователь отключил или удалил ранее использованное устройство.</span><span class="sxs-lookup"><span data-stu-id="e7de7-126">Step 3 is appropriate if the application allows the user to explicitly select another device after the user has disabled or removed the previously used device.</span></span>

<span data-ttu-id="e7de7-127">Приложение может определить более точную причину ошибки неправильного устройства путем регистрации для получения уведомления о том, что сеанс теряет подключение к устройству.</span><span class="sxs-lookup"><span data-stu-id="e7de7-127">An application can determine more precisely the cause of an invalid-device error by registering to receive a notification when a session loses its connection to a device.</span></span> <span data-ttu-id="e7de7-128">Чтобы включить это уведомление, приложение реализует интерфейс [**иаудиосессионевентс**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) и вызывает метод [**Иаудиосессионконтрол:: регистераудиосессионнотификатион**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessioncontrol-registeraudiosessionnotification) для регистрации интерфейса.</span><span class="sxs-lookup"><span data-stu-id="e7de7-128">To enable this notification, the application implements an [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) interface and calls the [**IAudioSessionControl::RegisterAudioSessionNotification**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessioncontrol-registeraudiosessionnotification) method to register the interface.</span></span> <span data-ttu-id="e7de7-129">Если ошибка неправильного устройства приводит к отключению сеанса, ВАСАПИ вызывает метод [**иаудиосессионевентс:: онсессиондисконнектед**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) в зарегистрированном интерфейсе.</span><span class="sxs-lookup"><span data-stu-id="e7de7-129">When an invalid-device error causes the session to be disconnected, WASAPI calls the [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) method in the registered interface.</span></span> <span data-ttu-id="e7de7-130">С помощью этого метода ВАСАПИ информирует приложение о причине отключения.</span><span class="sxs-lookup"><span data-stu-id="e7de7-130">Through this method, WASAPI informs the application of the reason for the disconnection.</span></span> <span data-ttu-id="e7de7-131">В Windows Vista вызов **онсессиондисконнектед** определяет следующие причины.</span><span class="sxs-lookup"><span data-stu-id="e7de7-131">In Windows Vista, the **OnSessionDisconnected** call identifies the following reasons:</span></span>

-   <span data-ttu-id="e7de7-132">Пользователь удалил устройство конечной точки аудио.</span><span class="sxs-lookup"><span data-stu-id="e7de7-132">The user removed the audio endpoint device.</span></span>
-   <span data-ttu-id="e7de7-133">Служба Windows Audio завершила работу.</span><span class="sxs-lookup"><span data-stu-id="e7de7-133">The Windows audio service has shut down.</span></span>
-   <span data-ttu-id="e7de7-134">Предпочтительный формат потока изменен для устройства, к которому подключен сеанс аудио.</span><span class="sxs-lookup"><span data-stu-id="e7de7-134">The preferred stream format changed for the device that the audio session is connected to.</span></span>
-   <span data-ttu-id="e7de7-135">Пользователь вышел из сеанса служб терминалов Windows (ВТС), в котором выполнялся сеанс звука.</span><span class="sxs-lookup"><span data-stu-id="e7de7-135">The user logged off the Windows Terminal Services (WTS) session that the audio session was running in.</span></span> <span data-ttu-id="e7de7-136">Дополнительные сведения о сеансах ВТС см. в документации по Windows SDK.</span><span class="sxs-lookup"><span data-stu-id="e7de7-136">For more information about WTS sessions, see the Windows SDK documentation.</span></span>
-   <span data-ttu-id="e7de7-137">Сеанс ВТС, в котором выполнялся сеанс аудио, был отключен.</span><span class="sxs-lookup"><span data-stu-id="e7de7-137">The WTS session that the audio session was running in was disconnected.</span></span>
-   <span data-ttu-id="e7de7-138">Сеанс звука (общего режима) был отключен, чтобы устройство конечной точки аудио было доступно для подключения в монопольном режиме.</span><span class="sxs-lookup"><span data-stu-id="e7de7-138">The (shared-mode) audio session was disconnected to make the audio endpoint device available for an exclusive-mode connection.</span></span>

<span data-ttu-id="e7de7-139">В ответ на событие отключения ВАСАПИ закрывает все потоки, принадлежащие сеансу.</span><span class="sxs-lookup"><span data-stu-id="e7de7-139">In response to the disconnection event, WASAPI closes all of the streams that belong to the session.</span></span> <span data-ttu-id="e7de7-140">Если приложение попытается получить доступ к закрытому потоку через метод ВАСАПИ, например [**иаудиоклиент:: жеткуррентпаддинг**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-getcurrentpadding), то метод завершается ошибкой и возвращает код ошибки аудклнт \_ E \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="e7de7-140">If an application subsequently attempts to access a closed stream through a WASAPI method such as [**IAudioClient::GetCurrentPadding**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-getcurrentpadding), then the method fails and returns error code AUDCLNT\_E\_DEVICE\_INVALIDATED.</span></span>

<span data-ttu-id="e7de7-141">Дополнительное преимущество получения уведомлений через интерфейс [**иаудиосессионевентс**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) заключается в том, что уведомления прибывают асинхронно.</span><span class="sxs-lookup"><span data-stu-id="e7de7-141">An additional benefit to receiving notifications through the [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) interface is that the notifications arrive asynchronously.</span></span> <span data-ttu-id="e7de7-142">Таким же, даже если поток не выполняется, приложение по-прежнему будет получать своевременные уведомления о недопустимых ошибках устройств, которые могут препятствовать выполнению потока.</span><span class="sxs-lookup"><span data-stu-id="e7de7-142">Thus, even when the stream is not running, the application will still receive timely notification of invalid-device errors that can prevent the stream from running.</span></span>

## <a name="related-topics"></a><span data-ttu-id="e7de7-143">См. также</span><span class="sxs-lookup"><span data-stu-id="e7de7-143">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="e7de7-144">Управление потоками</span><span class="sxs-lookup"><span data-stu-id="e7de7-144">Stream Management</span></span>](stream-management.md)
</dt> </dl>

 

 



