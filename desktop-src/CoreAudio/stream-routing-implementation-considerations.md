---
description: В Windows 7 API-интерфейсы высокоуровневой платформы, использующие основные API аудио, такие как Media Foundation, DirectSound и Wave API, реализуют функцию маршрутизации потоков путем обработки переключения потоков с существующего устройства на новую конечную точку звука по умолчанию.
ms.assetid: ecda0b5b-6583-43b4-a9b4-f12a95f09452
title: Рекомендации по реализации потоковой маршрутизации
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 27dc1f7e3fe56d6b421ca59f528ab1a65d2261a9
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103990610"
---
# <a name="stream-routing-implementation-considerations"></a><span data-ttu-id="5f3f5-103">Рекомендации по реализации потоковой маршрутизации</span><span class="sxs-lookup"><span data-stu-id="5f3f5-103">Stream Routing Implementation Considerations</span></span>

<span data-ttu-id="5f3f5-104">В Windows 7 API-интерфейсы высокоуровневой платформы, использующие основные API аудио, такие как Media Foundation, DirectSound и Wave API, реализуют функцию маршрутизации потоков путем обработки переключения потоков с существующего устройства на новую конечную точку звука по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-104">In Windows 7, high-level platform APIs that use Core Audio APIs, such as Media Foundation, DirectSound, and Wave APIs, implement the stream routing feature by handling stream switching from an existing device to a new default audio endpoint.</span></span> <span data-ttu-id="5f3f5-105">Приложения мультимедиа, использующие эти API, используют поведение маршрутизации потока без каких-либо изменений в источнике.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-105">Media applications that use these APIs use the stream routing behavior without any modifications to the source.</span></span> <span data-ttu-id="5f3f5-106">Клиенты Direct ВАСАПИ могут использовать уведомления, отправленные основными компонентами, и реализовать функцию маршрутизации потоков.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-106">Direct WASAPI clients can use the notifications sent by Core Audio components and implement the stream routing feature.</span></span>

<span data-ttu-id="5f3f5-107">Прямые ВАСАПИ клиенты (приложения мультимедиа, использующие ВАСАПИ напрямую) получают новые уведомления об устройствах и звуковых сеансах, отправляемые основными компонентами аудио.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-107">Direct WASAPI clients (media applications that use WASAPI directly) receive new device and audio session notifications sent by Core Audio components.</span></span> <span data-ttu-id="5f3f5-108">Поведение функции маршрутизации потоков определяется тем, как приложение обрабатывает эти уведомления.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-108">The behavior of the stream routing feature is defined by how the application handles these notifications.</span></span>

<span data-ttu-id="5f3f5-109">API Ммдевице и сеанс звука отправляют уведомления об изменениях состояния устройства и изменениях сеанса в клиентах ВАСАПИ в виде обратных вызовов.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-109">MMDevice API and the audio session send notifications about device state changes and session changes to WASAPI clients in the form of callbacks.</span></span> <span data-ttu-id="5f3f5-110">Чтобы получить эти уведомления, клиент должен зарегистрировать свою реализацию [**иммнотификатионклиент**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) и [**иаудиосессионевентс**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span><span class="sxs-lookup"><span data-stu-id="5f3f5-110">To get these notifications, the client must register its implementation of [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span></span> <span data-ttu-id="5f3f5-111">Дополнительные сведения см. в разделе [релевантные уведомления для потоковой маршрутизации](relevant-device-notifications-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="5f3f5-111">For more information, see [Relevant Notifications for Stream Routing](relevant-device-notifications-for-stream-routing.md).</span></span>

<span data-ttu-id="5f3f5-112">[В сценарии](stream-routing.md)использования гарнитуры USB приложение воспроизводит звуковой поток и использует ММДЕВИЦЕАПИ и васапи для отрисовки потока на устройстве отрисовки по умолчанию, **докладчика**.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-112">In the USB headset scenario described in [Stream Routing](stream-routing.md), an application is playing an audio stream and uses MMDeviceAPI and WASAPI to render the stream on the default rendering device, **Speaker**.</span></span> <span data-ttu-id="5f3f5-113">При изменении устройства по умолчанию приложение получает уведомление [**иммнотификатионклиент**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) .</span><span class="sxs-lookup"><span data-stu-id="5f3f5-113">When the default device is changed, the application receives an [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="5f3f5-114">Приложение также получает уведомления [**иаудиосессионевентс**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) , указывающие, что пользователь удалил устройство конечной точки аудио или что формат потока изменился для устройства, к которому подключен звуковой сеанс.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-114">The application also receives [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications indicating that the user removed the audio endpoint device or that the stream format changed for the device that the audio session is connected to.</span></span> <span data-ttu-id="5f3f5-115">После получения уведомлений приложение останавливает потоковую передачу в конечную точку динамика и повторно открывает поток для отрисовки на текущей конечной точке по умолчанию — гарнитуре.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-115">Upon receiving the notifications, the application stops streaming to the speaker endpoint and reopens the stream for rendering on the current default endpoint, the headset.</span></span>

![Схема потока данных для уведомлений устройства.](images/stream-routing.gif)

<span data-ttu-id="5f3f5-117">В ответ на такие уведомления клиент может повторно открыть поток на новом устройстве по умолчанию в новом формате, выбранном пользователем.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-117">In response to such notifications, the client might reopen the stream on the new default device in the new format selected by the user.</span></span>

## <a name="stream-managment"></a><span data-ttu-id="5f3f5-118">Управление потоком</span><span class="sxs-lookup"><span data-stu-id="5f3f5-118">Stream Managment</span></span>

<span data-ttu-id="5f3f5-119">В следующем списке перечислены шаги, которые должен выполнить клиент ВАСАПИ для предоставления функциональных возможностей переключения потоков.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-119">The following list summarizes the steps that a WASAPI client must perform to provide the stream switching functionality.</span></span>

1.  <span data-ttu-id="5f3f5-120">Дождитесь соответствующего уведомления [**иммнотификатионклиент**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) .</span><span class="sxs-lookup"><span data-stu-id="5f3f5-120">Wait for the relevant [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="5f3f5-121">Если устройство является устройством по умолчанию, будет получено уведомление [**иммнотификатионклиент:: ондефаултдевицечанжед**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) .</span><span class="sxs-lookup"><span data-stu-id="5f3f5-121">If the device is the default device, the [**IMMNotificationClient::OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) notification is received.</span></span>
2.  <span data-ttu-id="5f3f5-122">Если доступно новое устройство, получите ссылку на конечную точку нового устройства.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-122">If a new device is available, get a reference to the endpoint of the new device.</span></span> <span data-ttu-id="5f3f5-123">Вызовите [**иммдевицеенумератор:: жетдефаултаудиоендпоинт**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) для нового устройства по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-123">Call [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) for the new default device.</span></span> <span data-ttu-id="5f3f5-124">Если новое устройство не является устройством по умолчанию, вы можете получить его, вызвав [**иммдевицеенумератор::**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice)--Device.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-124">If the new device is not the default device, you can retrieve the device by calling [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span></span> <span data-ttu-id="5f3f5-125">Дополнительные сведения см. [в разделе Получение конечной точки устройства для маршрутизации потоков](getting-the-default-device-endpoint-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="5f3f5-125">For more information, see [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span></span>
3.  <span data-ttu-id="5f3f5-126">Дождитесь завершения [**иаудиосессионевентс:: онсессиондисконнектед**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) и значения причины.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-126">Wait for the [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) with the reason value.</span></span>
    > [!Note]  
    > <span data-ttu-id="5f3f5-127">Так как все эти операции являются асинхронного, порядок, в котором приложение получает уведомления об изменении устройства и отключении сеанса, не может быть прогнозируемым.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-127">Because all of these operations are asychronous, the order in which the application receives device-change and session-disconnect notifications cannnot be predicted.</span></span> <span data-ttu-id="5f3f5-128">Приложение должно реализовать обработку уведомлений для получения этих уведомлений в любом порядке.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-128">The application must implement notification handling to receive these notifications in any order.</span></span> <span data-ttu-id="5f3f5-129">Однако обычно приложение получает значение **аудиосессиондисконнект** перед уведомлением об изменении устройства по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-129">However, typically, the application receives **AudioSessionDisconnect** value before the default device change notification.</span></span>

     

4.  <span data-ttu-id="5f3f5-130">Оцените значение причины и определите, нужно ли передавать поток на другую звуковую конечную точку, или поток должен быть повторно инициализирован с новым форматом.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-130">Evaluate the reason value and determine whether the stream needs to be transferred to another audio endpoint or the stream needs to be reinitialized with a new format.</span></span>
5.  <span data-ttu-id="5f3f5-131">Останавливает потоковую передачу на старое устройство по умолчанию, если причина указывает на то, что поток должен быть перенаправлен на новое устройство по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-131">Stop streaming to the old default device if the reason indicates that the stream should be re-routed to the new default device.</span></span>
6.  <span data-ttu-id="5f3f5-132">Выполнение вычислений сопоставления позиций.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-132">Perform position mapping calculations.</span></span>
7.  <span data-ttu-id="5f3f5-133">Откройте поток на новом устройстве и перенесите все сведения о состоянии.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-133">Open the stream on the new device and transfer all state information.</span></span>
8.  <span data-ttu-id="5f3f5-134">Возобновить потоковую передачу на новом устройстве по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-134">Resume streaming on the new default device.</span></span>
9.  <span data-ttu-id="5f3f5-135">Обработайте Отъезд старого устройства по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-135">Handle the departure of the old default device.</span></span>

<span data-ttu-id="5f3f5-136">Чтобы операция переключения потоков стала простой, ее необходимо сделать как можно быстрее.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-136">To make the stream switching operation appear seamless, it must be done as quickly as possible.</span></span> <span data-ttu-id="5f3f5-137">Это зависит от производительности компонентов, участвующих в повторном инициации потока на новом устройстве.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-137">This depends on the performance of the components involved in re-initiation of the stream on the new device.</span></span>

## <a name="position-mapping-considerations"></a><span data-ttu-id="5f3f5-138">Рекомендации по сопоставлению позиций</span><span class="sxs-lookup"><span data-stu-id="5f3f5-138">Position Mapping Considerations</span></span>

<span data-ttu-id="5f3f5-139">Когда приложение получает уведомления [**иммнотификатионклиент**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) и [**иаудиосессионевентс**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) , оно может направить существующие потоки на новое устройство по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-139">When the application gets [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications, it can route the existing streams to the new default device.</span></span> <span data-ttu-id="5f3f5-140">Если существующий аудиопоток был прерван и открыт на новом устройстве, подготовка к просмотру на новом устройстве должна начинаться с позиции, в которой поток был остановлен на старом устройстве.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-140">When an existing audio stream is interrupted and opened on the new device, rendering on the new device must start at the position at which the stream was stopped on the old device.</span></span> <span data-ttu-id="5f3f5-141">Для этого приложение должно иметь последнюю известную точку устройства, чтобы рассчитать начальную точку на новом устройстве.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-141">To do this, the application must have the last known device position, to calculate the start position on the new device.</span></span> <span data-ttu-id="5f3f5-142">Например, эта позиция может использоваться в качестве разностного смещения для последующих сопоставлений позиции.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-142">For example, this position can be used as the delta offset for subsequent position mapping.</span></span> <span data-ttu-id="5f3f5-143">Когда поток начинает подготовку к просмотру, новое расположение устройства можно сопоставить с позицией кэшированного устройства.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-143">When the stream starts rendering, the new device position can be remapped to the cached device position.</span></span>

<span data-ttu-id="5f3f5-144">Следующие шаги обобщаются процесс создания плавного потокового перехода.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-144">The following steps summarize the process of making a seamless stream transition.</span></span>

1.  <span data-ttu-id="5f3f5-145">Кэшировать Последнее расположение устройства в потоке на старом устройстве.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-145">Cache the last device position of the stream on the old device.</span></span>
2.  <span data-ttu-id="5f3f5-146">Останавливает поток на старом устройстве.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-146">Stop the stream on the old device.</span></span>
3.  <span data-ttu-id="5f3f5-147">Выполните повторное сопоставление вычислений для получения новой должности.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-147">Perform remapping calculations to get the new position.</span></span>
4.  <span data-ttu-id="5f3f5-148">Начать отрисовку потока на новом устройстве.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-148">Start rendering the stream on the new device.</span></span>
5.  <span data-ttu-id="5f3f5-149">Освобождение старого потока.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-149">Release the old stream.</span></span>

<span data-ttu-id="5f3f5-150">Во время перехода приложение должно гарантировать, что часы не выходят из синхронизации, что приведет к несинхронизированным потокам аудио и видео.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-150">During the transition, the application must ensure that the clock does not get out of synchronization, resulting in out-of-sync audio and video streams.</span></span> <span data-ttu-id="5f3f5-151">Это может произойти, если образцы видео продолжают отображаться, пока поток аудио не направляется на новое устройство.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-151">This can occur if the video samples continue to render while the audio stream is routed to the new device.</span></span> <span data-ttu-id="5f3f5-152">Приложение должно кэшировать расположение часов для вычисления повторного сопоставления и убедиться, что видеоматериалы не подготавливаются к просмотру до тех пор, пока поток звука не будет открыт заново на новом устройстве, поэтому при возобновлении воспроизведения звука и потоков видео синхронизируется.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-152">The application must cache the clock position for the remapping calculation and make sure that the video samples are not rendered until the audio stream is reopened on the new device, so that when the clip resumes rendering, the audio and the video streams are synchronized.</span></span> <span data-ttu-id="5f3f5-153">В некоторых случаях, когда время презентации для отрисовки видеокадров основано на звуковых часах, достаточно будет прерывать поток аудио до завершения переключения потока, и никакая другая реализация сопоставления позиции для видеопотока не требуется для синхронизации аудио-видео.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-153">In some cases, where the presentation time for rendering the video frames is based on the audio clock, it is sufficient to stop the audio stream until stream switching is complete and no other position mapping implementation for the video stream is necessary for audio video synchronization.</span></span>

<span data-ttu-id="5f3f5-154">Если во время подготовки к просмотру, [**иаудиорендерклиент::-buffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) возвращает ошибку, так как старое устройство теряется, приложению не требуется остановить старый поток, так как потоковая операция уже завершена.</span><span class="sxs-lookup"><span data-stu-id="5f3f5-154">If while rendering, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) returns an error because the old device is lost, the application need not stop the old stream because the streaming operation has already terminated.</span></span> <span data-ttu-id="5f3f5-155">Сведения об обработке этой ошибки см. [в разделе Восстановление после ошибки Invalid-Device](recovering-from-an-invalid-device-error.md).</span><span class="sxs-lookup"><span data-stu-id="5f3f5-155">For information about handling this error, see [Recovering from an Invalid-Device Error](recovering-from-an-invalid-device-error.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="5f3f5-156">См. также</span><span class="sxs-lookup"><span data-stu-id="5f3f5-156">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5f3f5-157">Сведения об API Ммдевице</span><span class="sxs-lookup"><span data-stu-id="5f3f5-157">About MMDevice API</span></span>](mmdevice-api.md)
</dt> <dt>

[<span data-ttu-id="5f3f5-158">О ВАСАПИ</span><span class="sxs-lookup"><span data-stu-id="5f3f5-158">About WASAPI</span></span>](wasapi.md)
</dt> <dt>

[<span data-ttu-id="5f3f5-159">Потоковая маршрутизация</span><span class="sxs-lookup"><span data-stu-id="5f3f5-159">Stream Routing</span></span>](stream-routing.md)
</dt> </dl>

 

 



