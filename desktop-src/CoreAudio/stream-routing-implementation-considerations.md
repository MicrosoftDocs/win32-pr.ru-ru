---
description: Сведения о вопросах реализации потоковой маршрутизации. Интерфейсы API реализуют потоковую маршрутизацию, обрабатывая переключение потоков на новую конечную точку звука по умолчанию.
ms.assetid: ecda0b5b-6583-43b4-a9b4-f12a95f09452
title: Рекомендации по реализации потоковой маршрутизации
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 62bd753fe027c92ffac9f5a41cea589b600d7f26
ms.sourcegitcommit: 51ef825fb48f15e1aa30e8795988f10dc2b2155c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/14/2021
ms.locfileid: "112068040"
---
# <a name="stream-routing-implementation-considerations"></a>Рекомендации по реализации потоковой маршрутизации

В Windows 7 API-интерфейсы высокоуровневой платформы, использующие основные API аудио, такие как Media Foundation, DirectSound и Wave API, реализуют функцию маршрутизации потоков путем обработки переключения потоков с существующего устройства на новую конечную точку звука по умолчанию. Приложения мультимедиа, использующие эти API, используют поведение маршрутизации потока без каких-либо изменений в источнике. Клиенты Direct ВАСАПИ могут использовать уведомления, отправленные основными компонентами, и реализовать функцию маршрутизации потоков.

Прямые ВАСАПИ клиенты (приложения мультимедиа, использующие ВАСАПИ напрямую) получают новые уведомления об устройствах и звуковых сеансах, отправляемые основными компонентами аудио. Поведение функции маршрутизации потоков определяется тем, как приложение обрабатывает эти уведомления.

API Ммдевице и сеанс звука отправляют уведомления об изменениях состояния устройства и изменениях сеанса в клиентах ВАСАПИ в виде обратных вызовов. Чтобы получить эти уведомления, клиент должен зарегистрировать свою реализацию [**иммнотификатионклиент**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) и [**иаудиосессионевентс**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents). Дополнительные сведения см. в разделе [релевантные уведомления для потоковой маршрутизации](relevant-device-notifications-for-stream-routing.md).

[В сценарии](stream-routing.md)использования гарнитуры USB приложение воспроизводит звуковой поток и использует ММДЕВИЦЕАПИ и васапи для отрисовки потока на устройстве отрисовки по умолчанию, **докладчика**. При изменении устройства по умолчанию приложение получает уведомление [**иммнотификатионклиент**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) . Приложение также получает уведомления [**иаудиосессионевентс**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) , указывающие, что пользователь удалил устройство конечной точки аудио или что формат потока изменился для устройства, к которому подключен звуковой сеанс. После получения уведомлений приложение останавливает потоковую передачу в конечную точку динамика и повторно открывает поток для отрисовки на текущей конечной точке по умолчанию — гарнитуре.

![Схема потока данных для уведомлений устройства.](images/stream-routing.gif)

В ответ на такие уведомления клиент может повторно открыть поток на новом устройстве по умолчанию в новом формате, выбранном пользователем.

## <a name="stream-managment"></a>Управление потоком

В следующем списке перечислены шаги, которые должен выполнить клиент ВАСАПИ для предоставления функциональных возможностей переключения потоков.

1.  Дождитесь соответствующего уведомления [**иммнотификатионклиент**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) . Если устройство является устройством по умолчанию, будет получено уведомление [**иммнотификатионклиент:: ондефаултдевицечанжед**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) .
2.  Если доступно новое устройство, получите ссылку на конечную точку нового устройства. Вызовите [**иммдевицеенумератор:: жетдефаултаудиоендпоинт**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) для нового устройства по умолчанию. Если новое устройство не является устройством по умолчанию, вы можете получить его, вызвав [**иммдевицеенумератор::**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice)--Device. Дополнительные сведения см. [в разделе Получение конечной точки устройства для маршрутизации потоков](getting-the-default-device-endpoint-for-stream-routing.md).
3.  Дождитесь завершения [**иаудиосессионевентс:: онсессиондисконнектед**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) и значения причины.
    > [!Note]  
    > Так как все эти операции являются асинхронного, порядок, в котором приложение получает уведомления об изменении устройства и отключении сеанса, не может быть прогнозируемым. Приложение должно реализовать обработку уведомлений для получения этих уведомлений в любом порядке. Однако обычно приложение получает значение **аудиосессиондисконнект** перед уведомлением об изменении устройства по умолчанию.

     

4.  Оцените значение причины и определите, нужно ли передавать поток на другую звуковую конечную точку, или поток должен быть повторно инициализирован с новым форматом.
5.  Останавливает потоковую передачу на старое устройство по умолчанию, если причина указывает на то, что поток должен быть перенаправлен на новое устройство по умолчанию.
6.  Выполнение вычислений сопоставления позиций.
7.  Откройте поток на новом устройстве и перенесите все сведения о состоянии.
8.  Возобновить потоковую передачу на новом устройстве по умолчанию.
9.  Обработайте Отъезд старого устройства по умолчанию.

Чтобы операция переключения потоков стала простой, ее необходимо сделать как можно быстрее. Это зависит от производительности компонентов, участвующих в повторном инициации потока на новом устройстве.

## <a name="position-mapping-considerations"></a>Рекомендации по сопоставлению позиций

Когда приложение получает уведомления [**иммнотификатионклиент**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) и [**иаудиосессионевентс**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) , оно может направить существующие потоки на новое устройство по умолчанию. Если существующий аудиопоток был прерван и открыт на новом устройстве, подготовка к просмотру на новом устройстве должна начинаться с позиции, в которой поток был остановлен на старом устройстве. Для этого приложение должно иметь последнюю известную точку устройства, чтобы рассчитать начальную точку на новом устройстве. Например, эта позиция может использоваться в качестве разностного смещения для последующих сопоставлений позиции. Когда поток начинает подготовку к просмотру, новое расположение устройства можно сопоставить с позицией кэшированного устройства.

Следующие шаги обобщаются процесс создания плавного потокового перехода.

1.  Кэшировать Последнее расположение устройства в потоке на старом устройстве.
2.  Останавливает поток на старом устройстве.
3.  Выполните повторное сопоставление вычислений для получения новой должности.
4.  Начать отрисовку потока на новом устройстве.
5.  Освобождение старого потока.

Во время перехода приложение должно гарантировать, что часы не выходят из синхронизации, что приведет к несинхронизированным потокам аудио и видео. Это может произойти, если образцы видео продолжают отображаться, пока поток аудио не направляется на новое устройство. Приложение должно кэшировать расположение часов для вычисления повторного сопоставления и убедиться, что видеоматериалы не подготавливаются к просмотру до тех пор, пока поток звука не будет открыт заново на новом устройстве, поэтому при возобновлении воспроизведения звука и потоков видео синхронизируется. В некоторых случаях, когда время презентации для отрисовки видеокадров основано на звуковых часах, достаточно будет прерывать поток аудио до завершения переключения потока, и никакая другая реализация сопоставления позиции для видеопотока не требуется для синхронизации аудио-видео.

Если во время подготовки к просмотру, [**иаудиорендерклиент::-buffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) возвращает ошибку, так как старое устройство теряется, приложению не требуется остановить старый поток, так как потоковая операция уже завершена. Сведения об обработке этой ошибки см. [в разделе Восстановление после ошибки Invalid-Device](recovering-from-an-invalid-device-error.md).

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Сведения об API Ммдевице](mmdevice-api.md)
</dt> <dt>

[О ВАСАПИ](wasapi.md)
</dt> <dt>

[Потоковая маршрутизация](stream-routing.md)
</dt> </dl>

 

 



