---
description: User-Mode звуковых компонентов
ms.assetid: b240b629-5bb6-4b07-95be-8ca5a14a3567
title: User-Mode звуковых компонентов
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 18715db2d32be3c4a70182571028acbfca411539
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103896061"
---
# <a name="user-mode-audio-components"></a><span data-ttu-id="69362-103">User-Mode звуковых компонентов</span><span class="sxs-lookup"><span data-stu-id="69362-103">User-Mode Audio Components</span></span>

<span data-ttu-id="69362-104">В Windows Vista основные API-интерфейсы аудиоподсистемы служат основой звуковой подсистемы пользовательского режима.</span><span class="sxs-lookup"><span data-stu-id="69362-104">In Windows Vista, the core audio APIs serve as the foundation of the user-mode audio subsystem.</span></span> <span data-ttu-id="69362-105">Основные API аудио реализованы в виде тонкого слоя системных компонентов пользовательского режима, которые отделяют клиенты пользовательского режима от аудио драйверов и аудиоустройств в режиме ядра.</span><span class="sxs-lookup"><span data-stu-id="69362-105">The core audio APIs are implemented as a thin layer of user-mode system components that separate user-mode clients from kernel-mode audio drivers and audio hardware.</span></span> <span data-ttu-id="69362-106">Интерфейсы аудио API более высокого уровня, такие как DirectSound и функции мультимедиа Windows, обращаются к звуковым устройствам через основные API-интерфейсы аудио.</span><span class="sxs-lookup"><span data-stu-id="69362-106">Higher-level audio APIs, such as DirectSound and the Windows multimedia functions, access audio devices through the core audio APIs.</span></span> <span data-ttu-id="69362-107">Кроме того, некоторые звуковые приложения взаимодействуют напрямую с основными API-интерфейсами аудио.</span><span class="sxs-lookup"><span data-stu-id="69362-107">In addition, some audio applications communicate directly with the core audio APIs.</span></span>

<span data-ttu-id="69362-108">Основные интерфейсы аудио API поддерживают понятное для пользователя понятие устройства конечной точки аудио.</span><span class="sxs-lookup"><span data-stu-id="69362-108">The core audio APIs support the user-friendly notion of an audio endpoint device.</span></span> <span data-ttu-id="69362-109">Устройство конечной точки звука — это программная абстракция, представляющая физическое устройство, которое пользователь напрямую управляет.</span><span class="sxs-lookup"><span data-stu-id="69362-109">An audio endpoint device is a software abstraction that represents a physical device that the user manipulates directly.</span></span> <span data-ttu-id="69362-110">Примеры устройств конечных точек аудио — это динамики, наушники и микрофоны.</span><span class="sxs-lookup"><span data-stu-id="69362-110">Examples of audio endpoint devices are speakers, headphones, and microphones.</span></span> <span data-ttu-id="69362-111">Дополнительные сведения см. в статье [устройства конечных точек аудио](audio-endpoint-devices.md).</span><span class="sxs-lookup"><span data-stu-id="69362-111">For more information, see [Audio Endpoint Devices](audio-endpoint-devices.md).</span></span>

<span data-ttu-id="69362-112">На следующей схеме показаны основные API аудио и их связь с другими звуковыми компонентами пользовательского режима в Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="69362-112">The following diagram shows the core audio APIs and their relationship to the other user-mode audio components in Windows Vista.</span></span>

![Схема компонентов для отрисовки звука в пользовательском режиме](images/fig1.jpg)

<span data-ttu-id="69362-114">Для простоты на предыдущей схеме показан только путь к данным для отображения звука на устройстве конечной точки — схема не показывает путь к данным записи звука.</span><span class="sxs-lookup"><span data-stu-id="69362-114">For simplicity, the preceding diagram shows only an audio-rendering data path to the endpoint device—the diagram does not show an audio-capture data path.</span></span> <span data-ttu-id="69362-115">Основные API аудио включают в себя [API ммдевице](mmdevice-api.md), [Васапи](wasapi.md), [API девицетопологи](devicetopology-api.md)и [API ендпоинтволуме](endpointvolume-api.md), которые реализуются в Audioses.dll и Mmdevapi.dll системных модулей пользовательского режима.</span><span class="sxs-lookup"><span data-stu-id="69362-115">The core audio APIs include the [MMDevice API](mmdevice-api.md), [WASAPI](wasapi.md), the [DeviceTopology API](devicetopology-api.md), and the [EndpointVolume API](endpointvolume-api.md), which are implemented in the Audioses.dll and Mmdevapi.dll user-mode system modules.</span></span>

<span data-ttu-id="69362-116">Как показано на предыдущей схеме, основные интерфейсы API аудио предоставляют основу для следующих интерфейсов API более высокого уровня:</span><span class="sxs-lookup"><span data-stu-id="69362-116">As shown in the preceding diagram, the core audio APIs provide a foundation for the following higher-level APIs:</span></span>

-   <span data-ttu-id="69362-117">Media Foundation</span><span class="sxs-lookup"><span data-stu-id="69362-117">Media Foundation</span></span>
-   <span data-ttu-id="69362-118">Функции **вавекскскс** и **миксеркскскс** Windows мультимедиа</span><span class="sxs-lookup"><span data-stu-id="69362-118">Windows multimedia **waveXxx** and **mixerXxx** functions</span></span>
-   <span data-ttu-id="69362-119">Звука</span><span class="sxs-lookup"><span data-stu-id="69362-119">DirectSound</span></span>
-   <span data-ttu-id="69362-120">DirectMusic</span><span class="sxs-lookup"><span data-stu-id="69362-120">DirectMusic</span></span>

<span data-ttu-id="69362-121">DirectSound, функции аудио мультимедиа Windows и Media Foundation (с помощью потоковой прорисовки звука или САР) напрямую взаимодействуют с основными интерфейсами API аудио.</span><span class="sxs-lookup"><span data-stu-id="69362-121">DirectSound, the Windows multimedia audio functions, and Media Foundation (through its streaming audio renderer, or SAR, component) communicate directly with the core audio APIs.</span></span> <span data-ttu-id="69362-122">DirectMusic взаимодействует с основными API-интерфейсами аудио через DirectSound.</span><span class="sxs-lookup"><span data-stu-id="69362-122">DirectMusic communicates with the core audio APIs indirectly through DirectSound.</span></span>

<span data-ttu-id="69362-123">Клиент ВАСАПИ передает данные на устройство конечной точки через *буфер конечной точки*.</span><span class="sxs-lookup"><span data-stu-id="69362-123">A client of WASAPI passes data to an endpoint device through an *endpoint buffer*.</span></span> <span data-ttu-id="69362-124">Компоненты системного программного обеспечения и оборудования управляют перемещением данных из буфера конечной точки на устройство конечной точки способом, который в значительной степени прозрачен для клиента.</span><span class="sxs-lookup"><span data-stu-id="69362-124">System software and hardware components manage the movement of data from the endpoint buffer to the endpoint device in a manner that is largely transparent to the client.</span></span> <span data-ttu-id="69362-125">Кроме того, для устройства конечной точки, которое подключается к звуковому адаптеру с обнаружением присутствия, клиент может создать буфер конечной точки только для физически присутствующего оконечного устройства.</span><span class="sxs-lookup"><span data-stu-id="69362-125">Furthermore, for an endpoint device that plugs into an audio adapter with jack-presence detection, the client can create an endpoint buffer only for an endpoint device that is physically present.</span></span> <span data-ttu-id="69362-126">Дополнительные сведения об обнаружении устройств с разъемами см. в статье [устройства конечных точек аудио](audio-endpoint-devices.md).</span><span class="sxs-lookup"><span data-stu-id="69362-126">For more information about jack-presence detection, see [Audio Endpoint Devices](audio-endpoint-devices.md).</span></span>

<span data-ttu-id="69362-127">На предыдущей схеме показаны два типа буфера конечной точки.</span><span class="sxs-lookup"><span data-stu-id="69362-127">The preceding diagram shows two types of endpoint buffer.</span></span> <span data-ttu-id="69362-128">Если клиент ВАСАПИ открывает поток в *общем режиме*, клиент записывает звуковые данные в буфер конечной точки, а подсистема Windows Audio считывает данные из буфера.</span><span class="sxs-lookup"><span data-stu-id="69362-128">If a client of WASAPI opens a stream in *shared mode*, then the client writes audio data to the endpoint buffer and the Windows audio engine reads the data from the buffer.</span></span> <span data-ttu-id="69362-129">В этом режиме клиент использует звуковое оборудование совместно с другими приложениями, запущенными в других процессах.</span><span class="sxs-lookup"><span data-stu-id="69362-129">In this mode, the client shares the audio hardware with other applications running in other processes.</span></span> <span data-ttu-id="69362-130">Обработчик аудиозаписей применяет потоки из этих приложений и воспроизводит полученное сочетание с помощью оборудования.</span><span class="sxs-lookup"><span data-stu-id="69362-130">The audio engine mixes the streams from these applications and plays the resulting mix through the hardware.</span></span> <span data-ttu-id="69362-131">Обработчик звука — это системный компонент пользовательского режима (Audiodg.dll), выполняющий все операции потоковой обработки в программном обеспечении.</span><span class="sxs-lookup"><span data-stu-id="69362-131">The audio engine is a user-mode system component (Audiodg.dll) that performs all of its stream-processing operations in software.</span></span> <span data-ttu-id="69362-132">В противоположность этому, если клиент открывает поток в *монопольном режиме*, клиент имеет эксклюзивный доступ к звуковому оборудованию.</span><span class="sxs-lookup"><span data-stu-id="69362-132">In contrast, if a client opens a stream in *exclusive mode*, the client has exclusive access to the audio hardware.</span></span> <span data-ttu-id="69362-133">Обычно эксклюзивный режим требуется только для небольшого количества приложений "Pro Audio" или RTC.</span><span class="sxs-lookup"><span data-stu-id="69362-133">Typically, only a small number of "pro audio" or RTC applications require exclusive mode.</span></span> <span data-ttu-id="69362-134">Несмотря на то, что на схеме показаны потоки общего и монопольного режимов, существует только один из этих двух потоков (и соответствующий буфер конечной точки) в зависимости от того, открывает ли клиент поток в общем или в монопольном режиме.</span><span class="sxs-lookup"><span data-stu-id="69362-134">Although the diagram shows both the shared-mode and exclusive-mode streams, only one of these two streams (and its corresponding endpoint buffer) exists, depending on whether the client opens the stream in shared mode or in exclusive mode.</span></span>

<span data-ttu-id="69362-135">В монопольном режиме клиент может выбрать открытие потока в любом звуковом формате, поддерживаемом устройством конечной точки.</span><span class="sxs-lookup"><span data-stu-id="69362-135">In exclusive mode, the client can choose to open the stream in any audio format that the endpoint device supports.</span></span> <span data-ttu-id="69362-136">В общем режиме клиент должен открыть поток в формате Mix, который в данный момент используется обработчиком аудио (или форматом, аналогичным формату Mix).</span><span class="sxs-lookup"><span data-stu-id="69362-136">In shared mode, the client must open the stream in the mix format that is currently in use by the audio engine (or a format that is similar to the mix format).</span></span> <span data-ttu-id="69362-137">Входные потоки обработчика аудио и выходного потока из механизма имеют все данные в этом формате.</span><span class="sxs-lookup"><span data-stu-id="69362-137">The audio engine's input streams and the output mix from the engine are all in this format.</span></span>

<span data-ttu-id="69362-138">В Windows 7 для потоков в режиме общего доступа добавлен новый компонент, именуемый *Low-латенце Mode* .</span><span class="sxs-lookup"><span data-stu-id="69362-138">In Windows 7, a new feature called *low-latence mode* has been added for streams in share mode.</span></span> <span data-ttu-id="69362-139">В этом режиме обработчик звука работает в режиме опроса, в котором существенно уменьшается задержка.</span><span class="sxs-lookup"><span data-stu-id="69362-139">In this mode, the audio engine runs in pull mode, in which there a significant reduction in latency.</span></span> <span data-ttu-id="69362-140">Это очень полезно для коммуникационных приложений, требующих низкой задержки аудиопотока для ускорения потоковой передачи.</span><span class="sxs-lookup"><span data-stu-id="69362-140">This is very useful for communication applications that require low audio stream latency for faster streaming.</span></span>

<span data-ttu-id="69362-141">Приложения, управляющие потоками аудио с низкой задержкой, могут использовать службу планировщика классов мультимедиа (MMCSS) в Windows Vista для повышения приоритета потоков приложения, обращающихся к буферам конечной точки.</span><span class="sxs-lookup"><span data-stu-id="69362-141">Applications that manage low-latency audio streams can use the Multimedia Class Scheduler Service (MMCSS) in Windows Vista to increase the priority of application threads that access endpoint buffers.</span></span> <span data-ttu-id="69362-142">Служба MMCSS обеспечивает работу звуковых приложений с высоким приоритетом без блокировки ресурсов ЦП для приложений с более низким приоритетом.</span><span class="sxs-lookup"><span data-stu-id="69362-142">MMCSS enables audio applications to run at high priority without denying CPU resources to lower-priority applications.</span></span> <span data-ttu-id="69362-143">Служба MMCSS назначает приоритет потоку на основе его имени задачи.</span><span class="sxs-lookup"><span data-stu-id="69362-143">MMCSS assigns a priority to a thread based on its task name.</span></span> <span data-ttu-id="69362-144">Например, Windows Vista поддерживает имена задач «аудио» и «Pro Audio» для потоков, которые управляют звуковыми потоками.</span><span class="sxs-lookup"><span data-stu-id="69362-144">For example, Windows Vista supports the task names "Audio" and "Pro Audio" for threads that manage audio streams.</span></span> <span data-ttu-id="69362-145">По умолчанию приоритет потока "Pro Audio" выше, чем у "звукового" потока.</span><span class="sxs-lookup"><span data-stu-id="69362-145">By default, the priority of a "Pro Audio" thread is higher than that of an "Audio" thread.</span></span> <span data-ttu-id="69362-146">Дополнительные сведения о службе MMCSS см. в документации по Windows SDK.</span><span class="sxs-lookup"><span data-stu-id="69362-146">For more information about MMCSS, see the Windows SDK documentation.</span></span>

<span data-ttu-id="69362-147">Основные API аудио поддерживают как форматы потока PCM, так и потоки без PCM.</span><span class="sxs-lookup"><span data-stu-id="69362-147">The core audio APIs support both PCM and non-PCM stream formats.</span></span> <span data-ttu-id="69362-148">Однако обработчик звука может смешивать только потоки PCM.</span><span class="sxs-lookup"><span data-stu-id="69362-148">However, the audio engine can mix only PCM streams.</span></span> <span data-ttu-id="69362-149">Поэтому только потоки с монопольным режимом могут иметь форматы, отличные от форматов PCM.</span><span class="sxs-lookup"><span data-stu-id="69362-149">Thus, only exclusive-mode streams can have non-PCM formats.</span></span> <span data-ttu-id="69362-150">Дополнительные сведения см. в разделе [форматы устройств](device-formats.md).</span><span class="sxs-lookup"><span data-stu-id="69362-150">For more information, see [Device Formats](device-formats.md).</span></span>

<span data-ttu-id="69362-151">Обработчик аудио работает в собственном защищенном процессе, который отделен от процесса, в котором работает приложение.</span><span class="sxs-lookup"><span data-stu-id="69362-151">The audio engine runs in its own protected process, which is separate from the process that the application runs in.</span></span> <span data-ttu-id="69362-152">Для поддержки потока в общем режиме служба Windows Audio (под названием "служба аудио" на предыдущей схеме) выделяет буфер конечной точки между процессами, доступный как для приложения, так и для обработчика звука.</span><span class="sxs-lookup"><span data-stu-id="69362-152">To support a shared-mode stream, the Windows audio service (the box labeled "Audio Service" in the preceding diagram) allocates a cross-process endpoint buffer that is accessible to both the application and the audio engine.</span></span> <span data-ttu-id="69362-153">Для монопольного режима буфер конечной точки находится в памяти, доступной как для приложения, так и для звукового оборудования.</span><span class="sxs-lookup"><span data-stu-id="69362-153">For exclusive mode, the endpoint buffer resides in memory that is accessible to both the application and the audio hardware.</span></span>

<span data-ttu-id="69362-154">Служба Windows Audio — это модуль, который реализует политику Windows Audio.</span><span class="sxs-lookup"><span data-stu-id="69362-154">The Windows audio service is the module that implements Windows audio policy.</span></span> <span data-ttu-id="69362-155">Политика аудио — это набор внутренних правил, применяемых системой к взаимодействию между звуковыми потоками из нескольких приложений, которые совместно используют одно и то же звуковое оборудование.</span><span class="sxs-lookup"><span data-stu-id="69362-155">Audio policy is a set of internal rules that the system applies to the interactions between audio streams from multiple applications that share and compete for use of the same audio hardware.</span></span> <span data-ttu-id="69362-156">Служба Windows Audio реализует политику аудио, задавая параметры управления для обработчика звука.</span><span class="sxs-lookup"><span data-stu-id="69362-156">The Windows audio service implements audio policy by setting the control parameters for the audio engine.</span></span> <span data-ttu-id="69362-157">Ниже перечислены обязанности службы аудио.</span><span class="sxs-lookup"><span data-stu-id="69362-157">The duties of the audio service include:</span></span>

-   <span data-ttu-id="69362-158">Отслеживание звуковых устройств, которые пользователь добавляет или удаляет из системы.</span><span class="sxs-lookup"><span data-stu-id="69362-158">Keeping track of the audio devices that the user adds to or removes from the system.</span></span>
-   <span data-ttu-id="69362-159">Наблюдение за ролями, назначенными звуковым устройствам в системе.</span><span class="sxs-lookup"><span data-stu-id="69362-159">Monitoring the roles that are assigned to the audio devices in the system.</span></span>
-   <span data-ttu-id="69362-160">Управление потоками аудио из групп задач, создающих аналогичные классы для аудио содержимого (консоль, мультимедиа и связь).</span><span class="sxs-lookup"><span data-stu-id="69362-160">Managing the audio streams from groups of tasks that produce similar classes of audio content (console, multimedia, and communications).</span></span>
-   <span data-ttu-id="69362-161">Управление уровнем громкости Объединенного потока вывода ("субмикс") для каждого из различных типов аудио содержимого.</span><span class="sxs-lookup"><span data-stu-id="69362-161">Controlling the volume level of the combined output stream ("submix") for each of the various types of audio content.</span></span>
-   <span data-ttu-id="69362-162">Уведомление обработчика аудио о обрабатывающих элементах в путях данных для звуковых потоков.</span><span class="sxs-lookup"><span data-stu-id="69362-162">Informing the audio engine about the processing elements in the data paths for the audio streams.</span></span>

<span data-ttu-id="69362-163">В некоторых версиях Windows служба Windows Audio по умолчанию отключена и должна быть явно включена перед тем, как система сможет воспроизводить звук.</span><span class="sxs-lookup"><span data-stu-id="69362-163">In some versions of Windows, the Windows audio service is disabled by default and must be explicitly turned on before the system can play audio.</span></span>

<span data-ttu-id="69362-164">В примере, показанном на предыдущей схеме, устройство конечной точки — это набор динамиков, подключенных к звуковому адаптеру.</span><span class="sxs-lookup"><span data-stu-id="69362-164">In the example shown in the preceding diagram, the endpoint device is a set of speakers that are plugged into the audio adapter.</span></span> <span data-ttu-id="69362-165">Клиентское приложение записывает звуковые данные в буфер конечной точки, а обработчик звука обрабатывает сведения о переносе данных из буфера на устройство конечной точки.</span><span class="sxs-lookup"><span data-stu-id="69362-165">The client application writes audio data to the endpoint buffer, and the audio engine handles the details of transporting the data from the buffer to the endpoint device.</span></span>

<span data-ttu-id="69362-166">Поле, помеченное как «аудио драйвер» на предыдущей схеме, может быть сочетанием предоставляемых системой драйверов и компонентов драйвера поставщика.</span><span class="sxs-lookup"><span data-stu-id="69362-166">The box labeled "Audio Driver" in the preceding diagram might be a combination of system-supplied and vendor-supplied driver components.</span></span> <span data-ttu-id="69362-167">В случае использования звукового адаптера на шине PCI или PCI Express система предоставляет драйвер системы класса портов (Portcls.sys), который реализует набор драйверов портов для различных функций аудио в адаптере, и поставщик оборудования предоставляет драйвер адаптера, который реализует набор драйверов минипорта для выполнения операций, связанных с устройством, для драйверов портов.</span><span class="sxs-lookup"><span data-stu-id="69362-167">In the case of an audio adapter on a PCI or PCI Express bus, the system supplies the Port Class system driver (Portcls.sys), which implements a set of port drivers for the various audio functions in the adapter, and the hardware vendor supplies an adapter driver that implements a set of miniport drivers to handle device-specific operations for the port drivers.</span></span> <span data-ttu-id="69362-168">В случае использования высококачественного аудио-контроллера и кодека на шине PCI или PCI Express система предоставляет драйвер адаптера (Hdaudio.sys), и не требуется драйвер, предоставленный поставщиком.</span><span class="sxs-lookup"><span data-stu-id="69362-168">In the case of a High Definition Audio controller and codec on a PCI or PCI Express bus, the system supplies the adapter driver (Hdaudio.sys), and no vendor-supplied driver is needed.</span></span> <span data-ttu-id="69362-169">В случае использования звукового адаптера на шине USB система предоставляет системный драйвер класса Австреам (Ks.sys) и драйвер USB Audio (Usbaudio.sys); Опять же, драйвер, предоставленный поставщиком, не требуется.</span><span class="sxs-lookup"><span data-stu-id="69362-169">In the case of an audio adapter on a USB bus, the system supplies the AVStream class system driver (Ks.sys) plus the USB Audio driver (Usbaudio.sys); again, no vendor-supplied driver is needed.</span></span>

<span data-ttu-id="69362-170">Для простоты на предыдущей схеме показаны только потоки отрисовки.</span><span class="sxs-lookup"><span data-stu-id="69362-170">For simplicity, the preceding diagram shows only rendering streams.</span></span> <span data-ttu-id="69362-171">Однако основные API-интерфейсы аудиоподсистемы также поддерживают захват потоков.</span><span class="sxs-lookup"><span data-stu-id="69362-171">However, the core audio APIs support capture streams as well.</span></span> <span data-ttu-id="69362-172">В общем режиме несколько клиентов могут совместно использовать захваченный поток с устройства звукового оборудования.</span><span class="sxs-lookup"><span data-stu-id="69362-172">In shared mode, several clients can share the captured stream from an audio hardware device.</span></span> <span data-ttu-id="69362-173">В монопольном режиме один клиент имеет эксклюзивный доступ к захваченному потоку с устройства.</span><span class="sxs-lookup"><span data-stu-id="69362-173">In exclusive mode, one client has exclusive access to the captured stream from the device.</span></span>

## <a name="related-topics"></a><span data-ttu-id="69362-174">См. также</span><span class="sxs-lookup"><span data-stu-id="69362-174">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="69362-175">Руководство по программированию</span><span class="sxs-lookup"><span data-stu-id="69362-175">Programming Guide</span></span>](programming-guide.md)
</dt> </dl>

 

 



