---
description: Запись замыкания на себя
ms.assetid: 71c567f7-fffa-4b75-897a-63ed30c4c9b0
title: Запись замыкания на себя
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 374da7497096118905f5e4c79bbacda832a42a7b
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103990691"
---
# <a name="loopback-recording"></a><span data-ttu-id="430d1-103">Запись замыкания на себя</span><span class="sxs-lookup"><span data-stu-id="430d1-103">Loopback Recording</span></span>

<span data-ttu-id="430d1-104">В режиме замыкания на себя клиент ВАСАПИ может захватить аудиопоток, который воспроизводится устройством конечной точки отрисовки.</span><span class="sxs-lookup"><span data-stu-id="430d1-104">In loopback mode, a client of WASAPI can capture the audio stream that is being played by a rendering endpoint device.</span></span> <span data-ttu-id="430d1-105">Чтобы открыть поток в режиме замыкания на себя, клиент должен выполнить следующие действия:</span><span class="sxs-lookup"><span data-stu-id="430d1-105">To open a stream in loopback mode, the client must:</span></span>

-   <span data-ttu-id="430d1-106">Получите интерфейс [**иммдевице**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immdevice) для устройства конечной точки отрисовки.</span><span class="sxs-lookup"><span data-stu-id="430d1-106">Obtain an [**IMMDevice**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immdevice) interface for the rendering endpoint device.</span></span>
-   <span data-ttu-id="430d1-107">Инициализируйте поток отслеживания в режиме замыкания на себя на устройстве конечной точки отрисовки.</span><span class="sxs-lookup"><span data-stu-id="430d1-107">Initialize a capture stream in loopback mode on the rendering endpoint device.</span></span>

<span data-ttu-id="430d1-108">После выполнения этих действий клиент может вызвать метод [**иаудиоклиент:: Unservice**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-getservice) , чтобы получить интерфейс [**иаудиокаптуреклиент**](/windows/desktop/api/Audioclient/nn-audioclient-iaudiocaptureclient) на устройстве конечной точки отрисовки.</span><span class="sxs-lookup"><span data-stu-id="430d1-108">After following these steps, the client can call the [**IAudioClient::GetService**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-getservice) method to obtain an [**IAudioCaptureClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudiocaptureclient) interface on the rendering endpoint device.</span></span>

<span data-ttu-id="430d1-109">ВАСАПИ обеспечивает режим замыкания на себя в основном для поддержки отмены акустического эха (AEC).</span><span class="sxs-lookup"><span data-stu-id="430d1-109">WASAPI provides loopback mode primarily to support acoustic echo cancellation (AEC).</span></span> <span data-ttu-id="430d1-110">Однако другие типы звуковых приложений могут найти режим замыкания на себя, полезный для захвата системного набора, который воспроизводится аудио-подсистемой.</span><span class="sxs-lookup"><span data-stu-id="430d1-110">However, other types of audio applications might find loopback mode useful for capturing the system mix that is being played by the audio engine.</span></span>

<span data-ttu-id="430d1-111">В примере кода в [записи потока](capturing-a-stream.md)функция рекордаудиостреам может быть легко изменена для настройки потока записи в режиме замыкания на себя.</span><span class="sxs-lookup"><span data-stu-id="430d1-111">In the code example in [Capturing a Stream](capturing-a-stream.md), the RecordAudioStream function can be easily modified to configure a loopback-mode capture stream.</span></span> <span data-ttu-id="430d1-112">Необходимые изменения:</span><span class="sxs-lookup"><span data-stu-id="430d1-112">The required modifications are:</span></span>

-   <span data-ttu-id="430d1-113">В вызове метода [**иммдевицеенумератор:: жетдефаултаудиоендпоинт**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) измените первый параметр (*поток* данных) с екаптуре на ерендер.</span><span class="sxs-lookup"><span data-stu-id="430d1-113">In the call to the [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) method, change the first parameter (*dataFlow*) from eCapture to eRender.</span></span>
-   <span data-ttu-id="430d1-114">В вызове метода [**иаудиоклиент:: Initialize**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-initialize) измените значение второго параметра (*стреамфлагс*) с 0 на аудклнт \_ стреамфлагс \_ loopback.</span><span class="sxs-lookup"><span data-stu-id="430d1-114">In the call to the [**IAudioClient::Initialize**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-initialize) method, change the value of the second parameter (*StreamFlags*) from 0 to AUDCLNT\_STREAMFLAGS\_LOOPBACK.</span></span>

<span data-ttu-id="430d1-115">В версиях Windows, предшествовавших Windows 10 1703, клиент записи в режиме опроса не получает никаких событий при инициализации потока с помощью управляемой событиями буферизации и поддерживает замыкание на себя.</span><span class="sxs-lookup"><span data-stu-id="430d1-115">In versions of Windows prior to Windows 10 1703, pull-mode capture client does not receive any events when a stream is initialized with event-driven buffering and is loopback-enabled.</span></span> <span data-ttu-id="430d1-116">Чтобы обойти это, инициализируйте поток отрисовки в режиме, управляемом событиями.</span><span class="sxs-lookup"><span data-stu-id="430d1-116">To work around this, initialize a render stream in event-driven mode.</span></span> <span data-ttu-id="430d1-117">Каждый раз, когда клиент получает событие для потока отрисовки, он должен сообщить клиенту записи о необходимости запуска потока записи, считывающего следующий набор образцов из буфера конечной точки записи.</span><span class="sxs-lookup"><span data-stu-id="430d1-117">Each time the client receives an event for the render stream, it must signal the capture client to run the capture thread that reads the next set of samples from the capture endpoint buffer.</span></span> <span data-ttu-id="430d1-118">В Windows 10 версии 1703 и более поздних, управляемые событиями клиенты замыкания на себя поддерживаются, и больше не требуется обходной путь, использующий поток отрисовки.</span><span class="sxs-lookup"><span data-stu-id="430d1-118">In Windows 10 versions 1703 and higher, event-driven loopback clients are supported, and no longer need the workaround involving the render stream.</span></span>  

<span data-ttu-id="430d1-119">Клиент может включить режим замыкания на себя только для потока общего режима (АУДКЛНТ \_ шаремоде \_ Shared).</span><span class="sxs-lookup"><span data-stu-id="430d1-119">A client can enable loopback mode only for a shared-mode stream (AUDCLNT\_SHAREMODE\_SHARED).</span></span> <span data-ttu-id="430d1-120">Потоки с монопольным режимом не могут действовать в режиме замыкания на себя.</span><span class="sxs-lookup"><span data-stu-id="430d1-120">Exclusive-mode streams cannot operate in loopback mode.</span></span>

<span data-ttu-id="430d1-121">Реализация замыкания на себя ВАСАПИ зависит от возможностей оборудования.</span><span class="sxs-lookup"><span data-stu-id="430d1-121">The implementation of loopback by WASAPI depend on the capabilities of the hardware.</span></span> <span data-ttu-id="430d1-122">Если оборудование поддерживает ПИН-код замыкания на себя в конечной точке прорисовки, ВАСАПИ использует аудио, предоставленный на этом ПИН-коде, для потока замыкания на себя.</span><span class="sxs-lookup"><span data-stu-id="430d1-122">If the hardware supports a loopback pin on the render endpoint, WASAPI uses the audio provided on this pin for the loopback stream.</span></span> <span data-ttu-id="430d1-123">Если оборудование не поддерживает ПИН-код замыкания на себя, ВАСАПИ копирует выходной поток из обработчика аудио в буфер записи приложения замыкания на себя в дополнение к копированию звуковых данных в ПИН-код прорисовки оборудования.</span><span class="sxs-lookup"><span data-stu-id="430d1-123">When the hardware does not support a loopback pin, WASAPI copies the output stream from the audio engine into the loopback application's capture buffer, in addition to copying the audio data to the hardware's render pin.</span></span>

<span data-ttu-id="430d1-124">Некоторые поставщики оборудования реализуют устройства замыкания на себя (а не закреплять экземпляры на устройствах отрисовки) в своих звуковых адаптерах.</span><span class="sxs-lookup"><span data-stu-id="430d1-124">Some hardware vendors implement loopback devices (as opposed to pin instances on render devices) in their audio adapters.</span></span> <span data-ttu-id="430d1-125">Несмотря на то, что устройства замыкания на себя похожи на режим замыкания на себя, их использование может быть сложнее.</span><span class="sxs-lookup"><span data-stu-id="430d1-125">Although hardware loopback devices are similar in operation to the WASAPI loopback mode, they can be more difficult to use.</span></span>

<span data-ttu-id="430d1-126">Аппаратные устройства замыкания на себя имеют следующие недостатки для звуковых приложений:</span><span class="sxs-lookup"><span data-stu-id="430d1-126">Hardware loopback devices have the following disadvantages for audio applications:</span></span>

-   <span data-ttu-id="430d1-127">Не все звуковые адаптеры имеют устройства замыкания на себя.</span><span class="sxs-lookup"><span data-stu-id="430d1-127">Not all audio adapters have loopback devices.</span></span> <span data-ttu-id="430d1-128">Поэтому приложения, зависящие от них, не будут работать на всех системах.</span><span class="sxs-lookup"><span data-stu-id="430d1-128">Thus, applications that depend on them will not work on all systems.</span></span>
-   <span data-ttu-id="430d1-129">Прежде чем приложение сможет выполнить запись с устройства замыкания на себя, пользователь должен указать устройство замыкания на себя и включить его для использования.</span><span class="sxs-lookup"><span data-stu-id="430d1-129">Before an application can record from a loopback device, the user must identify the loopback device and enable it for use.</span></span>

<span data-ttu-id="430d1-130">Разные поставщики применяют разные имена аппаратных устройств замыкания.</span><span class="sxs-lookup"><span data-stu-id="430d1-130">Different vendors assign different names to their hardware loopback devices.</span></span> <span data-ttu-id="430d1-131">Ниже приведены примеры имен.</span><span class="sxs-lookup"><span data-stu-id="430d1-131">The following names are examples:</span></span>

-   <span data-ttu-id="430d1-132">Стерео микшер</span><span class="sxs-lookup"><span data-stu-id="430d1-132">Stereo Mix</span></span>
-   <span data-ttu-id="430d1-133">Набор для звука</span><span class="sxs-lookup"><span data-stu-id="430d1-133">Waveout Mix</span></span>
-   <span data-ttu-id="430d1-134">Смешанные выходные данные</span><span class="sxs-lookup"><span data-stu-id="430d1-134">Mixed Output</span></span>
-   <span data-ttu-id="430d1-135">Что вы слышите</span><span class="sxs-lookup"><span data-stu-id="430d1-135">What You Hear</span></span>

<span data-ttu-id="430d1-136">Отсутствие стандартизованных имен может привести к затруднениям при определении устройства обратной связи в списке имен устройств.</span><span class="sxs-lookup"><span data-stu-id="430d1-136">The lack of standardized names might cause users to have difficulty identifying a loopback device in a list of device names.</span></span>

<span data-ttu-id="430d1-137">Аппаратное устройство замыкания на себя — это устройство записи.</span><span class="sxs-lookup"><span data-stu-id="430d1-137">A hardware loopback device is a capture device.</span></span> <span data-ttu-id="430d1-138">Таким образом, если адаптер поддерживает устройство замыкания на себя, звуковые приложения могут записываться с устройства так же, как и при записи с любого другого устройства записи.</span><span class="sxs-lookup"><span data-stu-id="430d1-138">Thus, if an adapter supports a loopback device, an audio application can record from the device in the same way that it records from any other capture device.</span></span>

<span data-ttu-id="430d1-139">Например, если выбрать аппаратное устройство замыкания на себя как устройство для записи по умолчанию, можно использовать функцию Рекордаудиостреам (без изменения) в примере кода в [записи потока](capturing-a-stream.md) для записи потока с устройства.</span><span class="sxs-lookup"><span data-stu-id="430d1-139">For example, if you select a hardware loopback device to be the default capture device, you can use the RecordAudioStream function (without modification) in the code example in [Capturing a Stream](capturing-a-stream.md) to capture the stream from the device.</span></span> <span data-ttu-id="430d1-140">(Для записи потока с устройства можно также использовать старый API аудио, например функции **вавеинкскскс** мультимедиа Windows.)</span><span class="sxs-lookup"><span data-stu-id="430d1-140">(You can also use a legacy audio API, such as the Windows multimedia **waveInXxx** functions, to capture the stream from the device.)</span></span>

<span data-ttu-id="430d1-141">Если ваш звуковой адаптер содержит аппаратное устройство замыкания на себя, можно использовать панель управления Windows, Mmsys.cpl, чтобы назначить устройство устройством записи по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="430d1-141">If your audio adapter contains a hardware loopback device, you can use the Windows multimedia control panel, Mmsys.cpl, to designate the device as the default capture device.</span></span> <span data-ttu-id="430d1-142">Для этого необходимо выполнить следующие шаги:</span><span class="sxs-lookup"><span data-stu-id="430d1-142">The steps are as follows:</span></span>

1.  <span data-ttu-id="430d1-143">Чтобы запустить Mmsys.cpl, откройте окно командной строки и введите следующую команду:</span><span class="sxs-lookup"><span data-stu-id="430d1-143">To run Mmsys.cpl, open a Command Prompt window and enter the following command:</span></span>

    ```C++
    control mmsys.cpl,,1
    ```

    

    <span data-ttu-id="430d1-144">Кроме того, можно запустить Mmsys.cpl, щелкнув правой кнопкой мыши значок динамика в области уведомлений, расположенном в правой части панели задач, и выбрать пункт **запись устройств**.</span><span class="sxs-lookup"><span data-stu-id="430d1-144">Alternatively, you can run Mmsys.cpl by right-clicking the speaker icon in the notification area, which is located on the right side of the taskbar, and selecting **Recording Devices**.</span></span>

2.  <span data-ttu-id="430d1-145">После открытия окна Mmsys.cpl щелкните правой кнопкой мыши в любом месте списка устройств записи и убедитесь, что установлен флажок **Показывать Отключенные устройства** .</span><span class="sxs-lookup"><span data-stu-id="430d1-145">After the Mmsys.cpl window opens, right-click anywhere in the list of recording devices and verify that the **Show Disabled Devices** option is checked.</span></span> <span data-ttu-id="430d1-146">(В противном случае, если устройство замыкания на себя отключено, оно не будет отображаться в списке.)</span><span class="sxs-lookup"><span data-stu-id="430d1-146">(Otherwise, if the loopback device is disabled, it will not appear in the list.)</span></span>
3.  <span data-ttu-id="430d1-147">Просмотрите список устройств записи, чтобы найти устройство замыкания на себя (если оно существует).</span><span class="sxs-lookup"><span data-stu-id="430d1-147">Browse the list of recording devices to locate the loopback device (if it exists).</span></span> <span data-ttu-id="430d1-148">Если устройство замыкания на себя отключено, включите его, щелкнув правой кнопкой мыши устройство и выбрав **включить**.</span><span class="sxs-lookup"><span data-stu-id="430d1-148">If the loopback device is disabled, enable it by right-clicking the device and clicking **Enable**.</span></span>
4.  <span data-ttu-id="430d1-149">Наконец, чтобы выбрать устройство замыкания на себя в качестве устройства для записи по умолчанию, щелкните устройство правой кнопкой мыши и выберите пункт **установить как устройство по умолчанию**.</span><span class="sxs-lookup"><span data-stu-id="430d1-149">Finally, to select the loopback device to be the default capture device, right-click the device and click **Set as Default Device**.</span></span>

<span data-ttu-id="430d1-150">ВАСАПИ поддерживает запись замыкания на себя независимо от того, содержит ли звуковое оборудование устройство замыкания на себя или включено ли это устройство.</span><span class="sxs-lookup"><span data-stu-id="430d1-150">WASAPI supports loopback recording regardless of whether the audio hardware contains a loopback device, or whether the user has enabled the device.</span></span>

<span data-ttu-id="430d1-151">Windows Vista предоставляет управление цифровыми правами (DRM).</span><span class="sxs-lookup"><span data-stu-id="430d1-151">Windows Vista provides digital rights management (DRM).</span></span> <span data-ttu-id="430d1-152">Поставщики содержимого используют DRM для защиты собственной музыки или другого содержимого от несанкционированного копирования и других недопустимых применений.</span><span class="sxs-lookup"><span data-stu-id="430d1-152">Content providers rely on DRM to protect their proprietary music or other content from unauthorized copying and other illegal uses.</span></span> <span data-ttu-id="430d1-153">Аналогичным образом, доверенный звуковой драйвер не позволяет устройству замыкания на себя записывать цифровые потоки, содержащие защищенное содержимое.</span><span class="sxs-lookup"><span data-stu-id="430d1-153">Similarly, a trusted audio driver does not permit a loopback device to capture digital streams that contain protected content.</span></span> <span data-ttu-id="430d1-154">Windows Vista позволяет использовать только надежные драйверы для воспроизведения защищенного содержимого.</span><span class="sxs-lookup"><span data-stu-id="430d1-154">Windows Vista allows only trusted drivers to play protected content.</span></span> <span data-ttu-id="430d1-155">Дополнительные сведения о доверенных драйверах и DRM см. в документации по Windows DDK.</span><span class="sxs-lookup"><span data-stu-id="430d1-155">For more information about trusted drivers and DRM, see the Windows DDK documentation.</span></span>

<span data-ttu-id="430d1-156">ВАСАПИ loopback содержит сочетание всех воспроизводимых звуковых данных независимо от сеанса служб терминалов, из которого поступило звуковое сопровождение.</span><span class="sxs-lookup"><span data-stu-id="430d1-156">WASAPI loopback contains the mix of all audio being played, regardless of the Terminal Services session the audio originated from.</span></span> <span data-ttu-id="430d1-157">Например, можно запустить клиент с замыканием на себя в службе, работающей в сеансе 0, и записать звук из всех пользовательских сеансов, а также воспроизвести звук из сеанса 0.</span><span class="sxs-lookup"><span data-stu-id="430d1-157">For example, you can run a loopback client in a service running in session 0 and capture audio from all user sessions, as well as audio being played from session 0.</span></span>

<span data-ttu-id="430d1-158">Удаленный рабочий стол позволяет перенаправлять звук на клиент.</span><span class="sxs-lookup"><span data-stu-id="430d1-158">Remote Desktop allows redirecting audio to the client.</span></span> <span data-ttu-id="430d1-159">Это реализуется путем создания новых звуковых устройств, которые отображаются только для этого сеанса.</span><span class="sxs-lookup"><span data-stu-id="430d1-159">This is implemented by creating new audio devices that only appear for that session.</span></span>

## <a name="related-topics"></a><span data-ttu-id="430d1-160">См. также</span><span class="sxs-lookup"><span data-stu-id="430d1-160">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="430d1-161">Управление потоками</span><span class="sxs-lookup"><span data-stu-id="430d1-161">Stream Management</span></span>](stream-management.md)
</dt> </dl>

 

 



