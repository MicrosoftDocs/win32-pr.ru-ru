---
description: В COM+ каждый COM-объект создается с помощью связанного контекста.
ms.assetid: e5602af2-5852-4c34-a792-6742e90b7d41
title: Активация контекста
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a652615d6c1288887085c857817e32e3a3b4081c
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "104142001"
---
# <a name="context-activation"></a><span data-ttu-id="80e33-103">Активация контекста</span><span class="sxs-lookup"><span data-stu-id="80e33-103">Context Activation</span></span>

<span data-ttu-id="80e33-104">В COM+ каждый COM-объект создается с помощью связанного контекста.</span><span class="sxs-lookup"><span data-stu-id="80e33-104">In COM+, every COM object is created with an associated context.</span></span> <span data-ttu-id="80e33-105">Это означает, что необходимо создать и инициализировать новый контекст или использовать соответствующий существующий контекст.</span><span class="sxs-lookup"><span data-stu-id="80e33-105">This means that either a new context must be created and initialized or an appropriate existing context is used.</span></span> <span data-ttu-id="80e33-106">Этот процесс называется *активацией*.</span><span class="sxs-lookup"><span data-stu-id="80e33-106">This process is known as *activation*.</span></span> <span data-ttu-id="80e33-107">В COM+ объект активируется либо в собственном контексте, либо в его создателе (объект, запрашивающий активацию объекта, например путем вызова [**CoCreateInstance**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance)).</span><span class="sxs-lookup"><span data-stu-id="80e33-107">In COM+, an object is activated either in its own context or in that of its creator (an object that has requested that the object be activated—for example, by calling [**CoCreateInstance**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance)).</span></span>

<span data-ttu-id="80e33-108">В некоторых случаях, например при использовании [пула объектов](com--object-pooling.md), объект активируется без создания с нуля.</span><span class="sxs-lookup"><span data-stu-id="80e33-108">In some circumstances, such as with [object pooling](com--object-pooling.md), an object is activated without being created from scratch.</span></span> <span data-ttu-id="80e33-109">В этом случае запущенный экземпляр активируется в контексте.</span><span class="sxs-lookup"><span data-stu-id="80e33-109">In this case, a running instance is activated within a context.</span></span> <span data-ttu-id="80e33-110">Во время его существования оно может быть многократно активировано в разных контекстах.</span><span class="sxs-lookup"><span data-stu-id="80e33-110">Over its lifetime, it may be repeatedly activated in different contexts.</span></span>

<span data-ttu-id="80e33-111">В любом случае базовый механизм один и тот же — объект связан с контекстом, и этот контекст правильно инициализируется для представления потребностей объекта во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="80e33-111">The basic mechanism is the same in either case—an object is associated with a context and that context is properly initialized to represent the run-time needs of the object.</span></span>

## <a name="flowing-of-context-properties"></a><span data-ttu-id="80e33-112">Потоковая передача свойств контекста</span><span class="sxs-lookup"><span data-stu-id="80e33-112">Flowing of Context Properties</span></span>

<span data-ttu-id="80e33-113">Когда объект активируется в ответ на запрос на создание от другого объекта, COM+ должен подключаться между ними, чтобы правильно активировать нисходящий объект.</span><span class="sxs-lookup"><span data-stu-id="80e33-113">When an object is being activated in response to a creation request from another object, COM+ needs to mediate between them to properly activate the downstream object.</span></span> <span data-ttu-id="80e33-114">COM+ должен сравнить контекст вызывающего объекта с конфигурацией вызываемого компонента, а затем решить, где активировать нисходящий компонент и как инициализировать его свойства контекста.</span><span class="sxs-lookup"><span data-stu-id="80e33-114">COM+ has to compare the context of the caller with the configuration of the called component and then decide where to activate the downstream component and how to initialize its context properties.</span></span>

<span data-ttu-id="80e33-115">Для обнаружения конфигурации компонента COM+ ищет его в базе данных регистрации классов COM+, которая оптимизирована для чрезвычайно быстрых поисков во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="80e33-115">To discover the component's configuration, COM+ looks it up in the COM+ class registration database, which is optimized for extremely fast run-time lookups.</span></span> <span data-ttu-id="80e33-116">(Это определяется способом настройки компонента при его установке в приложение COM+.) Затем Конфигурация компонента проверяется по состоянию свойств контекста вызывающего объекта.</span><span class="sxs-lookup"><span data-stu-id="80e33-116">(This is determined by how you configured a component when installing it into a COM+ application.) The component's configuration is then examined against the state of the caller's context properties.</span></span>

<span data-ttu-id="80e33-117">В некоторых случаях конфигурация согласуется с контекстом вызывающего объекта, и компонент может быть активирован в контексте вызывающего.</span><span class="sxs-lookup"><span data-stu-id="80e33-117">In some cases, the configuration is consistent with the context of the caller and the component can be activated within the caller's context.</span></span> <span data-ttu-id="80e33-118">Это может произойти только в том случае, если контекст вызывающего объекта удовлетворяет всем требованиям среды выполнения, предъявляемым новым объектом.</span><span class="sxs-lookup"><span data-stu-id="80e33-118">This can happen only if the caller's context satisfies all the run-time requirements of the new object.</span></span>

<span data-ttu-id="80e33-119">Если нисходящий компонент не может быть активирован в контексте вызывающего, он активируется в собственном контексте в соответствующем апартаменте.</span><span class="sxs-lookup"><span data-stu-id="80e33-119">When the downstream component cannot be activated within the caller's context, it is activated in its own context in an appropriate apartment.</span></span> <span data-ttu-id="80e33-120">В этом случае некоторые свойства контекста могут передаваться от вызывающего к вызываемому.</span><span class="sxs-lookup"><span data-stu-id="80e33-120">When this occurs, certain context properties may flow from caller to callee.</span></span> <span data-ttu-id="80e33-121">Например, если вызывающий объект связан с транзакцией, а вызываемая транзакция поддерживает транзакции, то новый объект получает собственный контекст (чтобы проголосовать за транзакцию, он должен иметь собственный последовательный флаг) и наследует идентификатор транзакции вызывающего объекта и идентификатор действия (которые находятся в одной транзакции и домене синхронизации).</span><span class="sxs-lookup"><span data-stu-id="80e33-121">For example, if the caller is associated with a transaction and the callee supports transactions, the new object gets its own context (to vote in the transaction, it needs to have its own consistent flag) and inherits the caller's transaction ID and activity ID (which reside within the same transaction and synchronization domain).</span></span>

## <a name="ignored-context-properties"></a><span data-ttu-id="80e33-122">Игнорируемые свойства контекста</span><span class="sxs-lookup"><span data-stu-id="80e33-122">Ignored Context Properties</span></span>

<span data-ttu-id="80e33-123">В зависимости от настройки компонента некоторые свойства контекста могут не играть никаких ролей в определении того, активирован ли он в контексте создателя или в его собственном контексте.</span><span class="sxs-lookup"><span data-stu-id="80e33-123">Depending on how a component is configured, some context properties may play no role in determining whether it is activated in the creator's context or its own context.</span></span> <span data-ttu-id="80e33-124">Например, незаблокированные и отключенные параметры синхронизации, указывающие на присутствие транзакции или домена синхронизации, не играют никакой роли в активации компонента.</span><span class="sxs-lookup"><span data-stu-id="80e33-124">For example, the Transactions Disabled and Synchronization Disabled settings, indicating the presence of a transaction or a synchronization domain, will play no role whatsoever in the component's activation.</span></span> <span data-ttu-id="80e33-125">Эти свойства фундаментально игнорируются при потоковой передаче контекста.</span><span class="sxs-lookup"><span data-stu-id="80e33-125">These properties are fundamentally ignored when context is flowed.</span></span> <span data-ttu-id="80e33-126">Если компонент использует только проверку доступа на уровне процесса, свойство контекста безопасности игнорируется — конфигурация безопасности компонента никогда не будет играть роль при активации.</span><span class="sxs-lookup"><span data-stu-id="80e33-126">Or if a component uses only process-level access checking, its security context property is ignored—the component's security configuration will never play a role in its activation.</span></span>

## <a name="forcing-activation-in-the-callers-context"></a><span data-ttu-id="80e33-127">Принудительная активация в контексте вызывающего объекта</span><span class="sxs-lookup"><span data-stu-id="80e33-127">Forcing Activation in the Caller's Context</span></span>

<span data-ttu-id="80e33-128">В некоторых случаях может потребоваться активировать объект только в его контексте вызывающего объекта, т. е. он никогда не активируется в своем собственном контексте.</span><span class="sxs-lookup"><span data-stu-id="80e33-128">In some circumstances, you might want an object to be activated only in its caller's context—that is, never activated in its own context.</span></span> <span data-ttu-id="80e33-129">Например, может потребоваться управлять поведением объекта при его вызове через границу контекста.</span><span class="sxs-lookup"><span data-stu-id="80e33-129">For example, you might want to control the object's behavior when it's called across a context boundary.</span></span>

<span data-ttu-id="80e33-130">Можно гарантировать, что объект не может быть активирован в собственном контексте, выбрав параметр **требуется активировать в контексте вызывающих объектов** на вкладке **Активация** страницы **Свойства** компонента с помощью средства администрирования "службы компонентов".</span><span class="sxs-lookup"><span data-stu-id="80e33-130">You can ensure that an object cannot be activated in its own context by selecting the **Must be activated in callers context** option on the **Activation** tab of the component **Properties** page, using the Component Services administrative tool.</span></span> <span data-ttu-id="80e33-131">(Пошаговые инструкции см. [в разделе принудительная активация в контексте вызывающего объекта](enforcing-activation-in-the-caller-s-context.md) .) При выборе этого параметра, если объект не может быть активирован в контексте вызывающего объекта, функция [**CoCreateInstance**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance) завершается ошибкой, возвращая неудачную \_ \_ попытку \_ \_ создания \_ внешнего \_ \_ контекста клиента.</span><span class="sxs-lookup"><span data-stu-id="80e33-131">(See [Enforcing Activation in the Caller's Context](enforcing-activation-in-the-caller-s-context.md) for step-by-step instructions.) When you select this option, if the object cannot be activated in the caller's context, [**CoCreateInstance**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance) fails, returning CO\_E\_ATTEMPT\_TO\_CREATE\_OUTSIDE\_CLIENT\_CONTEXT.</span></span>

## <a name="default-context"></a><span data-ttu-id="80e33-132">Контекст по умолчанию</span><span class="sxs-lookup"><span data-stu-id="80e33-132">Default Context</span></span>

<span data-ttu-id="80e33-133">Существуют контексты по умолчанию для поддержки ненастроенных компонентов, т. е. COM-компонентов, не установленных в приложениях COM+ и не зарегистрированных в базе данных регистрации классов COM+.</span><span class="sxs-lookup"><span data-stu-id="80e33-133">Default contexts exist to support unconfigured components—that is, COM components not installed in COM+ applications and not registered in the COM+ class registration database.</span></span> <span data-ttu-id="80e33-134">Если ненастроенные компоненты имеют совместимую модель потоков, они активируются в контексте вызывающего.</span><span class="sxs-lookup"><span data-stu-id="80e33-134">If unconfigured components have a compatible threading model, they are activated in the caller's context.</span></span> <span data-ttu-id="80e33-135">В противном случае они активируются в контексте по умолчанию в соответствующем апартаменте.</span><span class="sxs-lookup"><span data-stu-id="80e33-135">Otherwise, they are activated in a default context in the appropriate apartment.</span></span> <span data-ttu-id="80e33-136">Каждый апартамент имеет контекст по умолчанию для поддержки COM-объектов, которые не используют службы COM+.</span><span class="sxs-lookup"><span data-stu-id="80e33-136">Each apartment has a default context to support COM objects that do not use COM+ services.</span></span>

## <a name="hooking-activation"></a><span data-ttu-id="80e33-137">Подключение активации</span><span class="sxs-lookup"><span data-stu-id="80e33-137">Hooking Activation</span></span>

<span data-ttu-id="80e33-138">Реализуя [**IObjectControl:: Activate**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontrol-activate) и [**IObjectControl::D еактивате**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontrol-deactivate), вы можете подключать активацию и деактивацию для выполнения специальной инициализации в новом контексте.</span><span class="sxs-lookup"><span data-stu-id="80e33-138">By implementing [**IObjectControl::Activate**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontrol-activate) and [**IObjectControl::Deactivate**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontrol-deactivate), you can hook activation and deactivation together to perform special initialization in the new context.</span></span> <span data-ttu-id="80e33-139">Эти методы вызываются COM+ в определенных точках жизненного цикла объекта, когда объект настроен для использования JIT-активации или объединения объектов в пул.</span><span class="sxs-lookup"><span data-stu-id="80e33-139">These methods are called by COM+ at certain points in an object's lifecycle, when the object is configured to use JIT-activation or object pooling.</span></span> <span data-ttu-id="80e33-140">Дополнительные сведения см. [в статье JIT-активация com+](com--just-in-time-activation.md) и [группирование объектов COM+](com--object-pooling.md) .</span><span class="sxs-lookup"><span data-stu-id="80e33-140">See [COM+ Just-in-Time Activation](com--just-in-time-activation.md) and [COM+ Object Pooling](com--object-pooling.md) for more detail.</span></span>

## <a name="related-topics"></a><span data-ttu-id="80e33-141">См. также</span><span class="sxs-lookup"><span data-stu-id="80e33-141">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="80e33-142">Перехват вызовов между контекстами</span><span class="sxs-lookup"><span data-stu-id="80e33-142">Interception of Cross-Context Calls</span></span>](interception-of-cross-context-calls.md)
</dt> </dl>

 

 
