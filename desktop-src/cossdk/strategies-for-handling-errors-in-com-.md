---
description: В этом разделе приведены несколько стратегий обработки ошибок, которые следует учитывать при разработке компонентов для COM+.
ms.assetid: 1ae5875b-8085-44f2-9071-c2a5d7543ac1
title: Стратегии обработки ошибок в COM+
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91ca64546683fa45ac8df3bcb47534d8de482798
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105692016"
---
# <a name="strategies-for-handling-errors-in-com"></a><span data-ttu-id="210ec-103">Стратегии обработки ошибок в COM+</span><span class="sxs-lookup"><span data-stu-id="210ec-103">Strategies for Handling Errors in COM+</span></span>

<span data-ttu-id="210ec-104">В этом разделе приведены несколько стратегий обработки ошибок, которые следует учитывать при разработке компонентов для COM+.</span><span class="sxs-lookup"><span data-stu-id="210ec-104">This topic identifies several error-handling strategies to keep in mind as you develop components for COM+.</span></span>

-   <span data-ttu-id="210ec-105">**Возвращает значение HRESULT для всех методов во всех интерфейсах компонента.**</span><span class="sxs-lookup"><span data-stu-id="210ec-105">**Return an HRESULT value for all methods in all component interfaces.**</span></span>  <span data-ttu-id="210ec-106">COM+ использует значения **HRESULT** для создания отчетов об ошибках, возникающих при вызове функций или вызовах методов интерфейса.</span><span class="sxs-lookup"><span data-stu-id="210ec-106">COM+ uses **HRESULT** values to report on any errors in making function calls or interface method calls.</span></span> <span data-ttu-id="210ec-107">**Значение HRESULT** указывает, завершился ли метод успешно или неудачно, и определяет связанное с ошибкой средство, например RPC, Win32 или ИТФ, для ошибок, связанных с интерфейсом.</span><span class="sxs-lookup"><span data-stu-id="210ec-107">An **HRESULT** indicates whether a method succeeded or failed and identifies the facility associated with the error, such as RPC, WIN32, or ITF for interface-specific errors.</span></span> <span data-ttu-id="210ec-108">Кроме того, системные API-интерфейсы предоставляют Поиск из **HRESULT** в строку, описывающую условие ошибки.</span><span class="sxs-lookup"><span data-stu-id="210ec-108">Also, system APIs provide a lookup from an **HRESULT** to a string that describes the error condition.</span></span> <span data-ttu-id="210ec-109">Использование методов, возвращающих значения **HRESULT** , является фундаментальным для хорошо написанных компонентов и является необходимым для процесса отладки.</span><span class="sxs-lookup"><span data-stu-id="210ec-109">Using methods that return **HRESULT** values are fundamental to well-written components and are essential to the debugging process.</span></span> <span data-ttu-id="210ec-110">Microsoft Visual Basic автоматически определяет каждый метод с помощью **HRESULT** в качестве возвращаемого значения.</span><span class="sxs-lookup"><span data-stu-id="210ec-110">Microsoft Visual Basic automatically defines each method with an **HRESULT** as a return.</span></span> <span data-ttu-id="210ec-111">В Microsoft Visual C++ необходимо явно вернуть **значение HRESULT**.</span><span class="sxs-lookup"><span data-stu-id="210ec-111">In Microsoft Visual C++, you must explicitly return an **HRESULT**.</span></span> <span data-ttu-id="210ec-112">Дополнительные сведения о HRESULT см. в разделе [структура кодов ошибок COM](/windows/desktop/com/structure-of-com-error-codes).</span><span class="sxs-lookup"><span data-stu-id="210ec-112">For additional information on HRESULTs, see [Structure of COM Error Codes](/windows/desktop/com/structure-of-com-error-codes).</span></span>
-   <span data-ttu-id="210ec-113">**Инициируйте объект коллекции ErrorInfo любым способом, предоставляемым вашим средством разработки.**</span><span class="sxs-lookup"><span data-stu-id="210ec-113">**Initiate the ErrorInfo collection object by whatever means your development tool provides.**</span></span> <span data-ttu-id="210ec-114">Объекты коллекции [**errorInfo**](errorinfo.md) часто называются исключениями com, так как они позволяют объекту передавать (или создавать) подробные сведения об ошибках вызывающему объекту, даже через границы апартамента.</span><span class="sxs-lookup"><span data-stu-id="210ec-114">[**ErrorInfo**](errorinfo.md) collection objects are often called COM exceptions because they allow an object to pass (or throw) rich error information to its caller, even across apartment boundaries.</span></span> <span data-ttu-id="210ec-115">Значение этого объекта общей ошибки заключается в том, что он дополняет значение HRESULT, расширяя тип сведений об ошибке, который можно вернуть вызывающему объекту.</span><span class="sxs-lookup"><span data-stu-id="210ec-115">The value of this generic error object is that it supplements an HRESULT, extending the type of error information that you can return to a caller.</span></span> <span data-ttu-id="210ec-116">Каждый объект коллекции **errorInfo** Возвращает контекстное описание, источник ошибки и идентификатор интерфейса метода, который поступил к ошибке.</span><span class="sxs-lookup"><span data-stu-id="210ec-116">Each **ErrorInfo** collection object returns a contextual description, the source of the error, and the interface identifier of the method that originated the error.</span></span> <span data-ttu-id="210ec-117">Также можно включить указатели в запись в файле справки.</span><span class="sxs-lookup"><span data-stu-id="210ec-117">You can also include pointers to an entry in a help file.</span></span> <span data-ttu-id="210ec-118">Автоматизация предоставляет три интерфейса для управления объектом Error.</span><span class="sxs-lookup"><span data-stu-id="210ec-118">Automation provides three interfaces to manage the error object.</span></span> <span data-ttu-id="210ec-119">Компонент должен реализовать интерфейс автоматизации **ISupportErrorInfo** , чтобы объявить его поддержку для коллекции **errorInfo** .</span><span class="sxs-lookup"><span data-stu-id="210ec-119">Your component must implement the **ISupportErrorInfo** Automation interface to advertise its support for the **ErrorInfo** collection.</span></span> <span data-ttu-id="210ec-120">При возникновении ошибки компонент использует интерфейс автоматизации **икреатирроринфо** для инициализации объекта ошибки.</span><span class="sxs-lookup"><span data-stu-id="210ec-120">When an error occurs, the component uses the **ICreateErrorInfo** Automation interface to initialize an error object.</span></span> <span data-ttu-id="210ec-121">После того как вызывающий объект проверит значение HRESULT и обнаружит, что вызов метода завершился неудачно, он запрашивает объект, чтобы узнать, поддерживает ли он коллекцию **errorInfo** .</span><span class="sxs-lookup"><span data-stu-id="210ec-121">After the caller inspects the HRESULT and finds that the method call failed, it queries the object to see whether it supports the **ErrorInfo** collection.</span></span> <span data-ttu-id="210ec-122">Если это так, вызывающий объект использует интерфейс автоматизации **IErrorInfo** для получения сведений об ошибке.</span><span class="sxs-lookup"><span data-stu-id="210ec-122">If it does, the caller uses the **IErrorInfo** Automation interface to retrieve the error information.</span></span> <span data-ttu-id="210ec-123">Visual Basic программисты имеют простой доступ к объекту коллекции **errorInfo** , который предоставляется через объект Err.</span><span class="sxs-lookup"><span data-stu-id="210ec-123">Visual Basic programmers have easy access to the **ErrorInfo** collection object, which is exposed through the Err object.</span></span> <span data-ttu-id="210ec-124">Вы можете вызывать ошибки с помощью функции Err raise и перехватывать ошибки с помощью оператора **On Error** .</span><span class="sxs-lookup"><span data-stu-id="210ec-124">You can raise errors with the Err Raise function and catch errors with the **On Error** statement.</span></span> <span data-ttu-id="210ec-125">Уровень времени выполнения Visual Basic отвечает за сопоставление.</span><span class="sxs-lookup"><span data-stu-id="210ec-125">The Visual Basic run-time layer takes care of the mapping for you.</span></span> <span data-ttu-id="210ec-126">Если вы используете Visual C++ поддержку COM-компилятора, можно использовать \_ \_ класс COM raise \_ Error для сообщения об ошибке и \_ \_ классе ошибок COM для получения сведений об ошибке.</span><span class="sxs-lookup"><span data-stu-id="210ec-126">If you are using the Visual C++ COM compiler support, you can use the \_com\_raise\_error class to report an error and the \_com\_error class to retrieve error information.</span></span> <span data-ttu-id="210ec-127">COM+ не распространяет традиционные исключения C++ как расширенные сведения о **IErrorInfo** .</span><span class="sxs-lookup"><span data-stu-id="210ec-127">COM+ will not propagate traditional C++ exceptions as extended **IErrorInfo** information.</span></span> <span data-ttu-id="210ec-128">Дополнительные сведения об объекте коллекции **errorInfo** см. в разделе "обработка ошибок" в инструкции по автоматизации.</span><span class="sxs-lookup"><span data-stu-id="210ec-128">For additional information on the **ErrorInfo** collection object, see "Error Handling" in the Automation guide.</span></span>
    > [!Note]  
    > <span data-ttu-id="210ec-129">COM требует, чтобы все объекты коллекции [**errorInfo**](errorinfo.md) маршалируются по значению, подразумевая, что компоненты, реализующие интерфейс автоматизации **IErrorInfo** , также должны реализовать и поддерживать интерфейс [**IMarshal**](/windows/desktop/api/objidl/nn-objidl-imarshal) .</span><span class="sxs-lookup"><span data-stu-id="210ec-129">COM requires that all [**ErrorInfo**](errorinfo.md) collection objects marshal by value, implying that components that implement the **IErrorInfo** Automation interface must also implement and support the [**IMarshal**](/windows/desktop/api/objidl/nn-objidl-imarshal) interface.</span></span> <span data-ttu-id="210ec-130">Реализация интерфейса **IMarshal** должна поддерживать маршалирование по значению для компонента.</span><span class="sxs-lookup"><span data-stu-id="210ec-130">The **IMarshal** interface implementation must support marshal by value for the component.</span></span>

     

-   <span data-ttu-id="210ec-131">**Используйте транзакции для управления сбоями общих ресурсов.**</span><span class="sxs-lookup"><span data-stu-id="210ec-131">**Use transactions to manage shared resource failures.**</span></span> <span data-ttu-id="210ec-132">Автоматические транзакции могут значительно сократить объем кода обработки ошибок, который необходимо написать при использовании диспетчеров ресурсов, управляемых состоянием.</span><span class="sxs-lookup"><span data-stu-id="210ec-132">Automatic transactions can significantly reduce the amount of error-handling code you must write when using state-managed resource managers.</span></span> <span data-ttu-id="210ec-133">Однако транзакции не устраняют необходимость в полной обработке ошибок.</span><span class="sxs-lookup"><span data-stu-id="210ec-133">However, transactions do not eliminate the need for error handling altogether.</span></span> <span data-ttu-id="210ec-134">Вам по-прежнему необходимо вернуть коды ошибок из методов интерфейса и проверить эти коды ошибок в вызывающем объекте, чтобы избежать ненужной работы для поэтому транзакция завершается транзакции.</span><span class="sxs-lookup"><span data-stu-id="210ec-134">You still need to return error codes from your interface methods and check those error codes within the caller to avoid doing unnecessary work for a doomed transaction.</span></span> <span data-ttu-id="210ec-135">Дополнительные сведения об объединении обработки ошибок с обработкой транзакций см. [в разделе ускорение транзакций путем уведомления корневого объекта](speeding-transactions-by-notifying-the-root-object.md).</span><span class="sxs-lookup"><span data-stu-id="210ec-135">For additional information about combining error handling with transaction processing, see [Speeding Transactions by Notifying the Root Object](speeding-transactions-by-notifying-the-root-object.md).</span></span>
-   <span data-ttu-id="210ec-136">**Явно вызывать ошибки.**</span><span class="sxs-lookup"><span data-stu-id="210ec-136">**Raise errors explicitly.**</span></span> <span data-ttu-id="210ec-137">Избегайте предоставления сведений об ошибках, если объект явно не вызывает ошибку.</span><span class="sxs-lookup"><span data-stu-id="210ec-137">Avoid letting error information leave an object unless the object explicitly raises the error.</span></span> <span data-ttu-id="210ec-138">Перехватите все ошибки, сформированные средством, и обработайте их в коде компонента.</span><span class="sxs-lookup"><span data-stu-id="210ec-138">Catch all tool-generated errors and handle them in your component code.</span></span> <span data-ttu-id="210ec-139">По крайней мере, включите стандартный обработчик для согласованного сообщения о непредвиденных ошибках.</span><span class="sxs-lookup"><span data-stu-id="210ec-139">At the very least, include a standard handler to report unexpected errors in a consistent manner.</span></span>
-   <span data-ttu-id="210ec-140">**\_Для сообщения об ошибках, связанных с интерфейсом, используйте диапазон ошибок ИТФ.**</span><span class="sxs-lookup"><span data-stu-id="210ec-140">**Use the FACILITY\_ITF range of errors to report interface-specific errors.**</span></span> <span data-ttu-id="210ec-141">Ошибки, связанные с интерфейсом, должны находиться в \_ диапазоне итфи ошибок между 0x0200 и 0xFFFF.</span><span class="sxs-lookup"><span data-stu-id="210ec-141">Interface-specific errors should be in the FACILITY\_ITF range of errors, between 0x0200 and 0xFFFF.</span></span> <span data-ttu-id="210ec-142">Вы можете определить пользовательский код ошибки в Visual Basic как смещение от Вбобжектеррор.</span><span class="sxs-lookup"><span data-stu-id="210ec-142">You can define a custom error code in Visual Basic as an offset from vbObjectError.</span></span> <span data-ttu-id="210ec-143">Используйте макрос MAKE \_ HRESULT в C++, чтобы ввести код ошибки, зависящий от интерфейса, как показано в следующем примере:</span><span class="sxs-lookup"><span data-stu-id="210ec-143">Use the MAKE\_HRESULT macro in C++ to introduce an interface-specific error code, as shown in the following example:</span></span>

    ``` syntax
    const HRESULT ERROR_NUMBER = MAKE_HRESULT (SEVERITY_ERROR, FACILITY_ITF, 10);
    ```

## <a name="related-topics"></a><span data-ttu-id="210ec-144">См. также</span><span class="sxs-lookup"><span data-stu-id="210ec-144">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="210ec-145">Изоляция сбоев и политика FailFast</span><span class="sxs-lookup"><span data-stu-id="210ec-145">Fault Isolation and Failfast Policy</span></span>](fault-isolation-and-failfast-policy.md)
</dt> <dt>

[<span data-ttu-id="210ec-146">Поиск источника ошибки</span><span class="sxs-lookup"><span data-stu-id="210ec-146">Finding the Source of an Error</span></span>](finding-the-source-of-an-error.md)
</dt> <dt>

[<span data-ttu-id="210ec-147">Изменение возвращаемых значений COM+</span><span class="sxs-lookup"><span data-stu-id="210ec-147">How COM+ Modifies Return Values</span></span>](how-com--modifies-return-values.md)
</dt> <dt>

[<span data-ttu-id="210ec-148">Анализ кодов ошибок</span><span class="sxs-lookup"><span data-stu-id="210ec-148">Interpreting Error Codes</span></span>](interpreting-error-codes.md)
</dt> <dt>

[<span data-ttu-id="210ec-149">Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="210ec-149">Troubleshooting</span></span>](troubleshooting.md)
</dt> </dl>

 

 
