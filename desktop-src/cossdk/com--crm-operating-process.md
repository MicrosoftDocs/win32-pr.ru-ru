---
description: Операционный процесс COM+ CRM
ms.assetid: be50912e-b9fd-4ef7-b81a-e37617a96955
title: Операционный процесс COM+ CRM
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d39dba3dedcbdefebe0f62144547ebb6985fa51f
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103896405"
---
# <a name="com-crm-operating-process"></a><span data-ttu-id="5aace-103">Операционный процесс COM+ CRM</span><span class="sxs-lookup"><span data-stu-id="5aace-103">COM+ CRM Operating Process</span></span>

<span data-ttu-id="5aace-104">При нормальной работе компонент приложения, выполняющийся в процессе серверного приложения, будет использовать COM+ CRM, создав рабочую роль CRM.</span><span class="sxs-lookup"><span data-stu-id="5aace-104">In normal operation, an application component running in a server application process would use a COM+ CRM by creating a CRM worker.</span></span> <span data-ttu-id="5aace-105">Рабочая роль CRM реализует COM-интерфейс, относящийся к задаче, которая предназначена для выполнения.</span><span class="sxs-lookup"><span data-stu-id="5aace-105">The CRM worker implements a COM interface specific to the task it is designed to perform.</span></span> <span data-ttu-id="5aace-106">Компонент приложения должен выполняться под транзакцией, чтобы Рабочая роль CRM наследовала транзакцию компонента приложения.</span><span class="sxs-lookup"><span data-stu-id="5aace-106">The application component must be running under a transaction so that the CRM worker inherits the transaction of the application component.</span></span> <span data-ttu-id="5aace-107">Работникам CRM всегда требуется транзакция.</span><span class="sxs-lookup"><span data-stu-id="5aace-107">CRM workers always require a transaction.</span></span>

<span data-ttu-id="5aace-108">Чтобы получить доступ к COM+ CRM, Рабочая роль CRM сначала получает интерфейс [**икрмлогконтрол**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) , позволяющий рабочему процессу CRM записывать записи в устойчивый журнал.</span><span class="sxs-lookup"><span data-stu-id="5aace-108">To access the COM+ CRM, the CRM worker first obtains the [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) interface, which allows the CRM worker to write records to the durable log.</span></span> <span data-ttu-id="5aace-109">Рабочий процесс CRM получает этот интерфейс, создавая компонент клерка CRM.</span><span class="sxs-lookup"><span data-stu-id="5aace-109">The CRM worker obtains this interface by creating a CRM clerk component.</span></span>

<span data-ttu-id="5aace-110">Далее Рабочая роль CRM должна сообщить Клерку CRM имя компенсатора CRM, который он хочет использовать.</span><span class="sxs-lookup"><span data-stu-id="5aace-110">Next the CRM worker must tell the CRM clerk the name of the CRM Compensator it wants to use.</span></span> <span data-ttu-id="5aace-111">Для этого вызывается метод [**икрмлогконтрол:: регистеркомпенсатор**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-registercompensator) .</span><span class="sxs-lookup"><span data-stu-id="5aace-111">It does this by calling the [**ICrmLogControl::RegisterCompensator**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-registercompensator) method.</span></span> <span data-ttu-id="5aace-112">После вызова этого метода компенсатор CRM создается инфраструктурой CRM по завершении транзакции.</span><span class="sxs-lookup"><span data-stu-id="5aace-112">After this method is called, the CRM Compensator is created by the CRM infrastructure when the transaction completes.</span></span>

<span data-ttu-id="5aace-113">После того как Рабочая роль CRM зарегистрировала свой компенсатор CRM, она может записывать записи в журнал CRM с помощью [**икрмлогконтрол**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span><span class="sxs-lookup"><span data-stu-id="5aace-113">After the CRM worker has registered its CRM Compensator, it can write records to the CRM log using [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span></span> <span data-ttu-id="5aace-114">Рабочая роль CRM должна *записаться заранее*; то есть он должен записать запись в журнал, описывающий действие до того, как оно действительно выполняет действие, в случае сбоя, возникающего сразу после завершения действия.</span><span class="sxs-lookup"><span data-stu-id="5aace-114">The CRM worker must *write ahead*; that is, it must write a record to the log describing an action before it actually performs the action, in case a crash occurs immediately after completing the action.</span></span> <span data-ttu-id="5aace-115">Без записей журнала с упреждающей записью невозможно исправить действие.</span><span class="sxs-lookup"><span data-stu-id="5aace-115">Without these write-ahead log records, there is no way to correct for the action.</span></span>

<span data-ttu-id="5aace-116">Кроме того, запись вперед означает, что компенсатор CRM, который является компонентом, получающим записи журнала при восстановлении, должен работать с тем случае, когда записи журнала были написаны, но действие не выполнялось.</span><span class="sxs-lookup"><span data-stu-id="5aace-116">Also, write ahead means that the CRM Compensator, which is the component that receives the log records on recovery, must deal with the case where the log records were written but the action did not in fact occur.</span></span> <span data-ttu-id="5aace-117">Действия, выполняемые компенсатором CRM, должны быть *идемпотентными*. то есть они должны быть способны выполняться несколько раз, но должны привести к тому же результату.</span><span class="sxs-lookup"><span data-stu-id="5aace-117">Actions by the CRM Compensator must be *idempotent*; that is, they should be capable of being performed more than once but should lead to the same outcome.</span></span> <span data-ttu-id="5aace-118">Например, установка значения баланса учетной записи равным $100 является действием идемпотентными. Добавление $100 в баланс учетной записи не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="5aace-118">For example, setting an account balance to the value of $100 is an idempotent action; adding $100 to the account balance is not.</span></span>

<span data-ttu-id="5aace-119">Интерфейс [**икрмлогконтрол**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) предоставляет два следующих метода для записи записей журнала:</span><span class="sxs-lookup"><span data-stu-id="5aace-119">The [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) interface provides the following two methods for writing log records:</span></span>

-   <span data-ttu-id="5aace-120">[**Врителогрекордвариантс**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecordvariants) используется для записи структурированной записи журнала, построенной как коллекция вариантов.</span><span class="sxs-lookup"><span data-stu-id="5aace-120">[**WriteLogRecordVariants**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecordvariants) is used for writing a structured log record that is built up as a collection of Variants.</span></span> <span data-ttu-id="5aace-121">В основном он используется при разработке Крмс в Microsoft Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="5aace-121">It is primarily for use when developing CRMs in Microsoft Visual Basic.</span></span>
-   <span data-ttu-id="5aace-122">[**Врителогрекорд**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecord) используется для записи неструктурированной записи журнала в виде больших двоичных объектов байтов.</span><span class="sxs-lookup"><span data-stu-id="5aace-122">[**WriteLogRecord**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecord) is used for writing an unstructured log record as BLOBs of bytes.</span></span> <span data-ttu-id="5aace-123">В основном он используется при разработке Крмс в Microsoft Visual C++.</span><span class="sxs-lookup"><span data-stu-id="5aace-123">It is primarily for use when developing CRMs in Microsoft Visual C++.</span></span> <span data-ttu-id="5aace-124">Поскольку структуры записей в языке C часто состоят из набора заголовков и полей, которые могут быть разбиты в памяти, метод **врителогрекорд** реализует функцию сбора, которая сокращает копирование данных.</span><span class="sxs-lookup"><span data-stu-id="5aace-124">Because record structures in C are often made up of a set of headers and fields that may be scattered in memory, the **WriteLogRecord** method implements a gather capability that reduces the copying of data.</span></span>

> [!Note]  
> <span data-ttu-id="5aace-125">Не следует наносить в записи журнала типы пользовательских указателей в структурах данных.</span><span class="sxs-lookup"><span data-stu-id="5aace-125">You should not user pointer types within data structures in a log record.</span></span> <span data-ttu-id="5aace-126">На этапе восстановления указатели больше не являются допустимыми, поскольку компенсатор CRM выполняется в процессе, отличном от процесса рабочей роли CRM, в которой записана запись журнала.</span><span class="sxs-lookup"><span data-stu-id="5aace-126">Pointers are no longer valid during recovery phase because the CRM Compensator runs in a different process than that of the CRM worker that wrote the log record.</span></span> <span data-ttu-id="5aace-127">Включение типов указателей в запись журнала может привести к сбою или повреждению приложения во время восстановления.</span><span class="sxs-lookup"><span data-stu-id="5aace-127">Including pointer types in a log record might cause an application to crash or corrupt itself during recovery.</span></span>

 

<span data-ttu-id="5aace-128">Оба этих метода записи записывают запись журнала на диск, но не гарантируют устойчивость записи.</span><span class="sxs-lookup"><span data-stu-id="5aace-128">Both of these write methods write a log record to disk but do not guarantee the record's durability.</span></span> <span data-ttu-id="5aace-129">Несмотря на то, что разрешение отложенных операций записи перед принудительным выполнением на диске может повысить производительность, можно использовать метод [**икрмлогконтрол:: форцелог**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-forcelog) , чтобы гарантировать, что все операции записи, выполненные CRM, будут устойчивыми на диске, что важно для восстановления после сбоя.</span><span class="sxs-lookup"><span data-stu-id="5aace-129">While allowing lazy writes to accumulate before forcing to disk can improve performance, you can use the [**ICrmLogControl::ForceLog**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-forcelog) method instead to guarantee that all writes done by the CRM are durable on disk, which is important for failure recovery.</span></span>

<span data-ttu-id="5aace-130">Когда Рабочая роль CRM выполняется с действиями и закончит запись и принудительно запишет записи в журнал, она должна освободить [**икрмлогконтрол**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span><span class="sxs-lookup"><span data-stu-id="5aace-130">When the CRM worker is done with its actions and has finished writing and forcing records to the log, it must release [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span></span> <span data-ttu-id="5aace-131">По завершении транзакции (обычно из-за компонента приложения, вызывающего [**сеткомплете**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setcomplete) или [**SETABORT**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setabort)) инфраструктура CRM создает компонент CRM Compensator, который реализует интерфейс [**икрмкомпенсатор**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensator) или интерфейс [**икрмкомпенсаторвариантс**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensatorvariants) .</span><span class="sxs-lookup"><span data-stu-id="5aace-131">When the transaction completes (typically due to the application component calling [**SetComplete**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setcomplete) or [**SetAbort**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setabort)), the CRM infrastructure creates the CRM Compensator component, which implements either the [**ICrmCompensator**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensator) interface or the [**ICrmCompensatorVariants**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensatorvariants) interface.</span></span> <span data-ttu-id="5aace-132">Эти интерфейсы используются для передачи неструктурированных (Visual C++) или структурированных (Visual Basic) записей в компенсатор CRM вместе с уведомлениями о результатах транзакции.</span><span class="sxs-lookup"><span data-stu-id="5aace-132">These interfaces are used to pass the unstructured (Visual C++) or structured (Visual Basic) records to the CRM Compensator along with the transaction outcome notifications.</span></span>

<span data-ttu-id="5aace-133">Компенсатор CRM сначала уведомляет этап подготовки к завершению транзакции и может проголосовать за него либо Да, либо нет для запроса на подготовку.</span><span class="sxs-lookup"><span data-stu-id="5aace-133">The CRM Compensator is first notified of the prepare phase of the transaction completion and can vote either yes or no to the prepare request.</span></span> <span data-ttu-id="5aace-134">Если у CRM Compensator нет, он не получит никаких дальнейших уведомлений об отмене.</span><span class="sxs-lookup"><span data-stu-id="5aace-134">If the CRM Compensator votes no, it does not receive any further abort notifications.</span></span> <span data-ttu-id="5aace-135">Если он передает ответ на запрос Prepare, он получает уведомления о фиксации или прерывании.</span><span class="sxs-lookup"><span data-stu-id="5aace-135">If it votes yes to the prepare request, it receives either the commit or abort notifications.</span></span> <span data-ttu-id="5aace-136">В случае прекращения использования клиента уведомления о подготовке не получаются, только прерываются уведомления.</span><span class="sxs-lookup"><span data-stu-id="5aace-136">In the case of a client abort, no prepare notifications are received, only abort notifications.</span></span> <span data-ttu-id="5aace-137">Компенсатор CRM должен быть готов к обработке всех этих вариантов, и он также должен обрабатывать случай, когда ни одна из записей журнала не была успешно записана работником CRM.</span><span class="sxs-lookup"><span data-stu-id="5aace-137">The CRM Compensator must be prepared to handle all these cases, and it also must handle the case where no log records were successfully written by the CRM worker.</span></span> <span data-ttu-id="5aace-138">Компенсатор CRM не должен рассчитывать на то, что один и тот же экземпляр CRM Compensator будет получать уведомления "этап 1" (подготовка) и "этап 2 (фиксация или прерывание)", так как они могут быть прерваны при восстановлении.</span><span class="sxs-lookup"><span data-stu-id="5aace-138">The CRM Compensator must not assume that the same CRM Compensator instance will receive both the phase 1 (prepare) and the phase 2 (commit or abort) notifications, as these could be interrupted by recovery.</span></span>

<span data-ttu-id="5aace-139">Как правило, компенсатор CRM использует уведомление об отмене для отмены действия, выполненного рабочим работником CRM.</span><span class="sxs-lookup"><span data-stu-id="5aace-139">Typically, a CRM Compensator uses the abort notification to reverse the action that was performed by the CRM worker.</span></span> <span data-ttu-id="5aace-140">Рабочая роль CRM может оставить некоторое состояние доступной, если потребуется отменить действие.</span><span class="sxs-lookup"><span data-stu-id="5aace-140">The CRM worker might leave some state available in case it needs to reverse its action.</span></span> <span data-ttu-id="5aace-141">Это состояние может быть полностью содержаться в записях журнала, а если нет, то компенсатор CRM должен очистить это состояние, если транзакция фиксируется.</span><span class="sxs-lookup"><span data-stu-id="5aace-141">That state might be fully contained in the log records, and if not, the CRM Compensator needs to clean up that state if the transaction commits.</span></span> <span data-ttu-id="5aace-142">Это причина, по которой компенсатор CRM получает уведомление о фиксации.</span><span class="sxs-lookup"><span data-stu-id="5aace-142">This is the reason why the CRM Compensator receives the commit notification.</span></span> <span data-ttu-id="5aace-143">Компенсатор CRM не выполняется в транзакции DTC.</span><span class="sxs-lookup"><span data-stu-id="5aace-143">The CRM Compensator does not run under a DTC transaction.</span></span>

<span data-ttu-id="5aace-144">Компенсатор CRM может регистрировать новые записи при необходимости с помощью [**икрмлогконтрол**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol), который получает при создании.</span><span class="sxs-lookup"><span data-stu-id="5aace-144">The CRM Compensator can log new records if required by using [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol), which it receives as it is created.</span></span> <span data-ttu-id="5aace-145">Как работник CRM, так и компенсатор CRM могут также запоминать последнюю записанную запись журнала, что может потребоваться, чтобы избежать ненужного восстановления.</span><span class="sxs-lookup"><span data-stu-id="5aace-145">Both the CRM worker and CRM Compensator can also forget the last log record they wrote, which might be required to avoid unnecessary recovery.</span></span>

## <a name="related-topics"></a><span data-ttu-id="5aace-146">См. также</span><span class="sxs-lookup"><span data-stu-id="5aace-146">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5aace-147">Основные понятия о компенсации диспетчер ресурсов COM+</span><span class="sxs-lookup"><span data-stu-id="5aace-147">COM+ Compensating Resource Manager Concepts</span></span>](com--compensating-resource-manager-concepts.md)
</dt> <dt>

[<span data-ttu-id="5aace-148">Запуск и восстановление COM+ CRM</span><span class="sxs-lookup"><span data-stu-id="5aace-148">COM+ CRM Startup and Recovery</span></span>](com--crm-startup-and-recovery.md)
</dt> </dl>

 

 



