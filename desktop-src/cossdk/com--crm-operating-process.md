---
description: Операционный процесс COM+ CRM
ms.assetid: be50912e-b9fd-4ef7-b81a-e37617a96955
title: Операционный процесс COM+ CRM
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c6d294d60429faeaad7a4d58808760ecd327bcaff252f2b71070c6605f5327ac
ms.sourcegitcommit: e858bbe701567d4583c50a11326e42d7ea51804b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "118308133"
---
# <a name="com-crm-operating-process"></a>Операционный процесс COM+ CRM

При нормальной работе компонент приложения, выполняющийся в процессе серверного приложения, будет использовать COM+ CRM, создав рабочую роль CRM. Рабочая роль CRM реализует COM-интерфейс, относящийся к задаче, которая предназначена для выполнения. Компонент приложения должен выполняться под транзакцией, чтобы Рабочая роль CRM наследовала транзакцию компонента приложения. Работникам CRM всегда требуется транзакция.

Чтобы получить доступ к COM+ CRM, Рабочая роль CRM сначала получает интерфейс [**икрмлогконтрол**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) , позволяющий рабочему процессу CRM записывать записи в устойчивый журнал. Рабочий процесс CRM получает этот интерфейс, создавая компонент клерка CRM.

Далее Рабочая роль CRM должна сообщить Клерку CRM имя компенсатора CRM, который он хочет использовать. Для этого вызывается метод [**икрмлогконтрол:: регистеркомпенсатор**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-registercompensator) . После вызова этого метода компенсатор CRM создается инфраструктурой CRM по завершении транзакции.

После того как Рабочая роль CRM зарегистрировала свой компенсатор CRM, она может записывать записи в журнал CRM с помощью [**икрмлогконтрол**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol). Рабочая роль CRM должна *записаться заранее*; то есть он должен записать запись в журнал, описывающий действие до того, как оно действительно выполняет действие, в случае сбоя, возникающего сразу после завершения действия. Без записей журнала с упреждающей записью невозможно исправить действие.

Кроме того, запись вперед означает, что компенсатор CRM, который является компонентом, получающим записи журнала при восстановлении, должен работать с тем случае, когда записи журнала были написаны, но действие не выполнялось. Действия, выполняемые компенсатором CRM, должны быть *идемпотентными*. то есть они должны быть способны выполняться несколько раз, но должны привести к тому же результату. Например, установка значения баланса учетной записи равным $100 является действием идемпотентными. Добавление $100 в баланс учетной записи не поддерживается.

Интерфейс [**икрмлогконтрол**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) предоставляет два следующих метода для записи записей журнала:

-   [**Врителогрекордвариантс**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecordvariants) используется для записи структурированной записи журнала, построенной как коллекция вариантов. В основном он используется при разработке Крмс в Microsoft Visual Basic.
-   [**Врителогрекорд**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecord) используется для записи неструктурированной записи журнала в виде больших двоичных объектов байтов. В основном он используется при разработке Крмс в Microsoft Visual C++. Поскольку структуры записей в языке C часто состоят из набора заголовков и полей, которые могут быть разбиты в памяти, метод **врителогрекорд** реализует функцию сбора, которая сокращает копирование данных.

> [!Note]  
> Не следует наносить в записи журнала типы пользовательских указателей в структурах данных. На этапе восстановления указатели больше не являются допустимыми, поскольку компенсатор CRM выполняется в процессе, отличном от процесса рабочей роли CRM, в которой записана запись журнала. Включение типов указателей в запись журнала может привести к сбою или повреждению приложения во время восстановления.

 

Оба этих метода записи записывают запись журнала на диск, но не гарантируют устойчивость записи. Несмотря на то, что разрешение отложенных операций записи перед принудительным выполнением на диске может повысить производительность, можно использовать метод [**икрмлогконтрол:: форцелог**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-forcelog) , чтобы гарантировать, что все операции записи, выполненные CRM, будут устойчивыми на диске, что важно для восстановления после сбоя.

Когда Рабочая роль CRM выполняется с действиями и закончит запись и принудительно запишет записи в журнал, она должна освободить [**икрмлогконтрол**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol). По завершении транзакции (обычно из-за компонента приложения, вызывающего [**сеткомплете**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setcomplete) или [**SETABORT**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setabort)) инфраструктура CRM создает компонент CRM Compensator, который реализует интерфейс [**икрмкомпенсатор**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensator) или интерфейс [**икрмкомпенсаторвариантс**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensatorvariants) . эти интерфейсы используются для передачи неструктурированных (Visual C++) или структурированных (Visual Basic) записей в компенсатор CRM вместе с уведомлениями о результатах транзакции.

Компенсатор CRM сначала уведомляет этап подготовки к завершению транзакции и может проголосовать за него либо Да, либо нет для запроса на подготовку. Если у CRM Compensator нет, он не получит никаких дальнейших уведомлений об отмене. Если он передает ответ на запрос Prepare, он получает уведомления о фиксации или прерывании. В случае прекращения использования клиента уведомления о подготовке не получаются, только прерываются уведомления. Компенсатор CRM должен быть готов к обработке всех этих вариантов, и он также должен обрабатывать случай, когда ни одна из записей журнала не была успешно записана работником CRM. Компенсатор CRM не должен рассчитывать на то, что один и тот же экземпляр CRM Compensator будет получать уведомления "этап 1" (подготовка) и "этап 2 (фиксация или прерывание)", так как они могут быть прерваны при восстановлении.

Как правило, компенсатор CRM использует уведомление об отмене для отмены действия, выполненного рабочим работником CRM. Рабочая роль CRM может оставить некоторое состояние доступной, если потребуется отменить действие. Это состояние может быть полностью содержаться в записях журнала, а если нет, то компенсатор CRM должен очистить это состояние, если транзакция фиксируется. Это причина, по которой компенсатор CRM получает уведомление о фиксации. Компенсатор CRM не выполняется в транзакции DTC.

Компенсатор CRM может регистрировать новые записи при необходимости с помощью [**икрмлогконтрол**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol), который получает при создании. Как работник CRM, так и компенсатор CRM могут также запоминать последнюю записанную запись журнала, что может потребоваться, чтобы избежать ненужного восстановления.

## <a name="related-topics"></a>Связанные темы

<dl> <dt>

[Основные понятия о компенсации диспетчер ресурсов COM+](com--compensating-resource-manager-concepts.md)
</dt> <dt>

[Запуск и восстановление COM+ CRM](com--crm-startup-and-recovery.md)
</dt> </dl>

 

 



