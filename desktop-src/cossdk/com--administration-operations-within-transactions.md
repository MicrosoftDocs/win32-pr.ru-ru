---
description: Операции администрирования COM+ в транзакциях
ms.assetid: 832f2e6d-26ff-416e-a92e-ebaa33d4e7e5
title: Операции администрирования COM+ в транзакциях
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 21612ffec1b9f082dc6a91861882a71f18fb07be
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "103807972"
---
# <a name="com-administration-operations-within-transactions"></a>Операции администрирования COM+ в транзакциях

База данных регистрации COM+ (Регдб) — это транзакционный диспетчер ресурсов, который может участвовать в транзакциях COM+. Это позволяет выполнять операции администрирования в рамках транзакции и зафиксировать или прерывать все изменения конфигурации как атомарную операцию даже на нескольких компьютерах. В некоторых обстоятельствах это может быть очень полезно, несмотря на то, что необходимо учитывать изоляцию и блокировку, а выполнение задач администрирования в рамках транзакций влечет за собой незначительные изменения в стандартной модели программирования администрирования.

## <a name="benefits-of-doing-administration-operations-within-transactions"></a>Преимущества выполнения административных операций в транзакциях

-   **Согласованность данных —** Операции администрирования, выполняемые внутри транзакции, фиксируются или прерываются в целом, хотя существуют некоторые нетранзакционные ресурсы каталога COM+, для которых это может быть не так. (См. раздел нетранзакционные ресурсы каталога COM+ ниже.)
-   **Согласованное развертывание на нескольких компьютерах —** При развертывании приложений COM+ на нескольких серверах можно гарантировать, что все серверы будут оставаться одинаковыми конфигурациями.
-   **Масштабирование и производительность —** При выполнении нескольких операций в рамках транзакции все операции записи в Регдб выполняются одновременно. Постоянные операции записи в Регдб являются относительно дорогостоящей операцией. Если вы вносите много операций записи в Регдб, вы можете добиться значительного выигрыша в производительности сразу, а не каждый раз, когда вызывается метод [**SaveChanges**](/windows/desktop/api/ComAdmin/nf-comadmin-icatalogcollection-savechanges).

## <a name="isolation-behavior-of-regdb"></a>Режим изоляции Регдб

Чтобы обеспечить правильную согласованность данных и сериализуемые транзакции, Регдб обеспечивает определенную блокировку и изоляцию при выполнении операций администрирования в рамках транзакций.

Всякий раз, когда компонент, выполняющий работу в рамках транзакции, вызывает любой метод, который вызовет запись в каталог COM+ (например, [**SaveChanges**](/windows/desktop/api/ComAdmin/nf-comadmin-icatalogcollection-savechanges), [**InstallApplication**](/windows/desktop/api/ComAdmin/nf-comadmin-icomadmincatalog-installapplication)или [**инсталлкомпонент**](/windows/desktop/api/ComAdmin/nf-comadmin-icomadmincatalog-installcomponent)), в коде сервера каталога COM+ выполняется блокировка записи, которая блокирует любые другие модули записи, пока текущая транзакция не зафиксируется или не завершится. То есть модули записи могут поступать только в том случае, если они имеют правильные сходство транзакций и участвуют в текущей транзакции.

Читатели не блокируются. Однако данные, которые видят читатели, не отображают промежуточные изменения, внесенные в транзакцию до фактической фиксации транзакции. Все компоненты, участвующие в этой транзакции, видят промежуточные состояния данных при чтении данных, но все компоненты за пределами транзакции видят эти изменения только после завершения транзакции.

## <a name="savechanges-behavior"></a>Поведение метода SaveChanges

Чтобы добиться описанного выше поведения изоляции, Регдб эффективно предоставляет кэш, обрабатываемый компонентами внутри транзакции. Это изменяет поведение метода [**SaveChanges**](/windows/desktop/api/ComAdmin/nf-comadmin-icatalogcollection-savechanges) .

Как правило, без транзакции все ожидающие изменения записываются в каталог при вызове метода [**SaveChanges**](/windows/desktop/api/ComAdmin/nf-comadmin-icatalogcollection-savechanges), а **SaveChanges** не возвращается до тех пор, пока не будут завершены все операции записи. Это гарантирует, что если вызов **SaveChanges** вернется успешно, можно вызвать [**стартаппликатион**](/windows/desktop/api/ComAdmin/nf-comadmin-icomadmincatalog-startapplication) и активировать приложение с новыми данными.

Однако в рамках транзакции функция [**SaveChanges**](/windows/desktop/api/ComAdmin/nf-comadmin-icatalogcollection-savechanges) влияет только на кэш, а не на сам регдб, а **SaveChanges** немедленно возвращает информацию о том, что все изменения были транзакционно зафиксированы в регдб. Нет никакой гарантии, что [**стартаппликатион**](/windows/desktop/api/ComAdmin/nf-comadmin-icomadmincatalog-startapplication) использует новые данные после возвращения метода **SaveChanges** . Если необходимо вызвать **стартаппликатион** в этом контексте, рекомендуется подождать некоторое время, прежде чем делать это.

## <a name="transaction-time-out-period"></a>Период Time-Out транзакции

Если вы выполняете множество административных операций в рамках транзакции, это может быть долго выполняющаяся транзакция. В этом случае значение времени ожидания транзакции может быть проблемой. Это определяется либо значением времени ожидания транзакции, заданным для компонента, запускающего транзакцию, либо параметром времени ожидания на уровне компьютера, на котором работает этот компонент. При выполнении множества операций в рамках транзакции рекомендуется установить для соответствующего времени ожидания транзакции достаточно длинное значение и при необходимости восстановить первоначальный параметр по завершении.

## <a name="non-transactional-com-catalog-resources"></a>Нетранзакционные ресурсы каталога COM+

Реестр, файловая система и установщик Windows (MSI) являются ресурсами каталога COM+, которые не являются транзакционными.

> [!Note]  
> Если возникает ошибка, которая прерывает транзакцию, изменения этих ресурсов могут быть не отменены.

 

Если при установке существующего приложения COM+ из MSI-файла возникла ошибка, приложение не отображается в оснастке "службы компонентов", но может появиться в окне "Установка и удаление программ". в этом случае его необходимо удалить вручную.

## <a name="recovering-in-the-event-of-system-hangs"></a>Восстановление в случае зависания системы

Если компонент, выполняющий операции администрирования в рамках транзакции, должен зависнуть в то время, когда он удерживает блокировку записи в коде сервера каталога, он блокирует внесение любых изменений в каталог всем остальным. В этом случае можно снять блокировку каталога, завершив и перезапустив Системное приложение.

## <a name="scripting-with-a-transactioncontext-object"></a>Создание сценариев с помощью объекта Трансактионконтекст

Простым способом администрирования операций в транзакциях является использование объекта [**трансактионконтекст**](transactioncontext.md) для управления транзакцией. Например, следующий сценарий Visual Basic демонстрирует, как добавить в приложение два новых приложения, чтобы одновременно не создавалось оба приложения или ни одно из них:


```VB
Dim txctx
Dim cat
Dim apps
Dim app1
Dim app2
  
WScript.Echo "Starting"
Set txctx = CreateObject("TxCtx.TransactionContext")
Set cat = txctx.CreateInstance("COMAdmin.COMAdminCatalog")
Set apps = cat.GetCollection("Applications")
Set app1 = apps.Add
app1.Value("Name") = "Test App #1"
apps.SaveChanges
Set app2 = apps.Add
app2.Value("Name") = "Test App #2"
apps.SaveChanges
  
WScript.Echo "Ending"
txctx.Commit

```



## <a name="related-topics"></a>См. также

<dl> <dt>

[Обработка ошибок администрирования COM+](handling-com--administration-errors.md)
</dt> <dt>

[Вводный пример с использованием каталога администрирования COM+](introductory-example-using-the-com--administration-catalog.md)
</dt> <dt>

[Общие сведения об объектах Комадмин](overview-of-the-comadmin-objects.md)
</dt> <dt>

[Получение коллекций в каталоге COM+](retrieving-collections-on-the-com--catalog.md)
</dt> <dt>

[Установка свойств и сохранение изменений в каталоге COM+](setting-properties-and-saving-changes-to-the-com--catalog.md)
</dt> </dl>

 

 



