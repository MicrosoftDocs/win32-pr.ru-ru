---
description: После сбоя любого типа, который нарушает нормальную обработку транзакций, KTM и каждый диспетчер ресурсов должны выполнять операции восстановления. Восстановление — это процесс, с помощью которого участники транзакции прибывают к единообразному представлению каждого состояния транзакций.
ms.assetid: 5bc9a155-6ba4-41f8-8e12-e87f48d83940
title: Обработка восстановления
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5a8e74d4f8bff3e56af03b017522212e7a02e232
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "105683301"
---
# <a name="recovery-processing"></a><span data-ttu-id="69112-104">Обработка восстановления</span><span class="sxs-lookup"><span data-stu-id="69112-104">Recovery Processing</span></span>

<span data-ttu-id="69112-105">После сбоя любого типа, который нарушает нормальную обработку транзакций, KTM и каждый диспетчер ресурсов должны выполнять операции *восстановления* .</span><span class="sxs-lookup"><span data-stu-id="69112-105">After any type of failure that disrupts normal transaction processing, KTM and each resource manager must perform *recovery* operations.</span></span> <span data-ttu-id="69112-106">Восстановление — это процесс, с помощью которого участники транзакции прибывают к единообразному представлению состояния каждой транзакции.</span><span class="sxs-lookup"><span data-stu-id="69112-106">Recovery is the process by which transaction participants arrive at a consistent view of each transaction's state.</span></span>

<span data-ttu-id="69112-107">Диспетчеры ресурсов могут быть *сомнительными* по отношению к результату транзакции. Это означает, что на момент сбоя они получали уведомление об уведомлении транзакции \_ \_ , было подготовлено к долговременному хранению, но не получило (или не получило, но не зарегистрировало) окончательный результат транзакции.</span><span class="sxs-lookup"><span data-stu-id="69112-107">Resource managers may be *in-doubt* about a transaction's outcome, meaning that at the time of failure, they had received a TRANSACTION\_NOTIFY\_PREPARE notification, had prepared to durable storage, but had not received (or received but not logged) a final outcome for the transaction.</span></span> <span data-ttu-id="69112-108">Аналогичным образом, KTM может быть сомнительным о транзакции, если она была подготовлена, но не получила (или не получила, но не зарегистрировалась) результат.</span><span class="sxs-lookup"><span data-stu-id="69112-108">Similarly, KTM can be in-doubt about a transaction if it had been prepared but had not received (or received but not logged) an outcome.</span></span> <span data-ttu-id="69112-109">Во время восстановления все результаты, которые были отправлены, но не подтверждены, должны быть отправлены повторно.</span><span class="sxs-lookup"><span data-stu-id="69112-109">At recovery time, all outcomes that have been sent but not acknowledged must be re-sent.</span></span> <span data-ttu-id="69112-110">Например, если диспетчер ресурсов получил \_ \_ уведомление о фиксации транзакции и вызвал функцию [**коммиткомплете**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete) , RM может по-прежнему получать \_ \_ уведомление о фиксации повторяющихся транзакций при восстановлении.</span><span class="sxs-lookup"><span data-stu-id="69112-110">For example, if a resource manager received a TRANSACTION\_NOTIFY\_COMMIT notification and called the [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete) function, the RM may still receive a duplicate TRANSACTION\_NOTIFY\_COMMIT notification at recovery time.</span></span>

<span data-ttu-id="69112-111">Чтобы транзакция была правильно восстановлена после сбоя диспетчера ресурсов или системы, каждый диспетчер ресурсов должен выполнить следующие действия при каждом запуске:</span><span class="sxs-lookup"><span data-stu-id="69112-111">For a transaction to properly recover after a resource manager or system failure, each resource manager must do the following each time it is started:</span></span>

1.  <span data-ttu-id="69112-112">Вызовите функцию [**опенресаурцеманажер**](/windows/desktop/api/Ktmw32/nf-ktmw32-openresourcemanager) , чтобы повторно открыть ее обработчик Resource Manager с помощью его уникального постоянного имени.</span><span class="sxs-lookup"><span data-stu-id="69112-112">Call the [**OpenResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-openresourcemanager) function to re-open its resource manager handle using its unique, persistent name.</span></span> <span data-ttu-id="69112-113">Это информирует KTM о том, что диспетчер ресурсов выполняется снова и доступен для выполнения восстановления.</span><span class="sxs-lookup"><span data-stu-id="69112-113">This informs KTM that the resource manager is running again and is available to perform recovery.</span></span> <span data-ttu-id="69112-114">Если для восстановления не существует зачислений, вызов **опенресаурцеманажер** может завершиться ошибкой.</span><span class="sxs-lookup"><span data-stu-id="69112-114">If no enlistments exist to be recovered, the call to **OpenResourceManager** can fail.</span></span> <span data-ttu-id="69112-115">Вызовите [**креатересаурцеманажер**](/windows/desktop/api/Ktmw32/nf-ktmw32-createresourcemanager) , чтобы повторно создать объект RM.</span><span class="sxs-lookup"><span data-stu-id="69112-115">Call [**CreateResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-createresourcemanager) to re-create the RM object.</span></span>
2.  <span data-ttu-id="69112-116">Вызовите [**рековерресаурцеманажер**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverresourcemanager).</span><span class="sxs-lookup"><span data-stu-id="69112-116">Call [**RecoverResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverresourcemanager).</span></span> <span data-ttu-id="69112-117">Диспетчер ресурсов получит событие уведомления [**о \_ \_ восстановлении транзакции notify**](notification-mask.md) для каждого прикрепления, для которого ему требуется выполнить операции восстановления, за которым следует \_ уведомление о \_ транзакции \_ .</span><span class="sxs-lookup"><span data-stu-id="69112-117">The resource manager will receive a [**TRANSACTION\_NOTIFY\_RECOVER**](notification-mask.md) notification event for each enlistment for which it needs to perform recovery operations, followed by a TRANSACTION\_NOTIFY\_LAST\_RECOVER.</span></span> <span data-ttu-id="69112-118">Событие уведомления содержит глобальный уникальный идентификатор как для транзакции, так и для прикрепления.</span><span class="sxs-lookup"><span data-stu-id="69112-118">The notification event includes a globally unique identifier for both the transaction and the enlistment.</span></span>
3.  <span data-ttu-id="69112-119">Вызовите функцию [**опененлистмент**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment) , чтобы повторно открыть каждый маркер прикрепления, для которого диспетчер ресурсов получил уведомление о \_ \_ восстановлении транзакции.</span><span class="sxs-lookup"><span data-stu-id="69112-119">Call the [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment) function to re-open each enlistment handle for which the resource manager received a TRANSACTION\_NOTIFY\_RECOVER notification.</span></span>
4.  <span data-ttu-id="69112-120">Для каждого прикрепления, открытого с помощью [**опененлистмент**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment), вызовите [**рековеренлистмент**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverenlistment).</span><span class="sxs-lookup"><span data-stu-id="69112-120">For each enlistment opened by [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment), call [**RecoverEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverenlistment).</span></span> <span data-ttu-id="69112-121">Это приводит к \_ \_ \_ повторной доставке уведомления о фиксации или уведомлении транзакции \_ .</span><span class="sxs-lookup"><span data-stu-id="69112-121">This causes the TRANSACTION\_NOTIFY\_COMMIT or TRANSACTION\_NOTIFY\_INDOUBT notification to be redelivered.</span></span>
5.  <span data-ttu-id="69112-122">Если диспетчер ресурсов получил \_ уведомление о \_ фиксации транзакции, RM может завершить транзакцию, вызвав [**коммиткомплете**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete).</span><span class="sxs-lookup"><span data-stu-id="69112-122">If the RM received TRANSACTION\_NOTIFY\_COMMIT, the RM can complete the transaction by calling [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete).</span></span>

    <span data-ttu-id="69112-123">Если диспетчер ресурсов получил уведомление о неопределенном \_ \_ состоянии транзакции, диспетчер ресурсов должен дождаться прибытия уведомления о результате.</span><span class="sxs-lookup"><span data-stu-id="69112-123">If the RM received TRANSACTION\_NOTIFY\_INDOUBT, the RM should wait for the outcome notification to arrive.</span></span>

6.  <span data-ttu-id="69112-124">Для всех транзакций, которые диспетчер ресурсов не получает уведомление о \_ \_ восстановлении транзакции, но ранее получил уведомление об \_ \_ отслеживании транзакции, диспетчер ресурсов должен обработать транзакцию так, как будто она была отменена.</span><span class="sxs-lookup"><span data-stu-id="69112-124">For any transactions that the RM does not receive a TRANSACTION\_NOTIFY\_RECOVER notification, but previously received a TRANSACTION\_NOTIFY\_PREPARE notification for, the RM should process the transaction as if it were rolled back.</span></span>

> [!Note]
>
> <span data-ttu-id="69112-125">Диспетчеры ресурсов могут прикрепляться к или создавать новые транзакции в процессе выполнения восстановления.</span><span class="sxs-lookup"><span data-stu-id="69112-125">Resource managers are allowed to enlist in or create new transactions while in the process of performing recovery.</span></span>

 

<span data-ttu-id="69112-126">KTM использует *предполагаемую модель аварийного завершения* транзакции.</span><span class="sxs-lookup"><span data-stu-id="69112-126">KTM uses a *presumed abort* transaction model.</span></span> <span data-ttu-id="69112-127">Это поведение показано в следующем сценарии.</span><span class="sxs-lookup"><span data-stu-id="69112-127">The following scenario illustrates this behavior.</span></span> <span data-ttu-id="69112-128">Предположим, что KTM и Resource Manager существуют на одном компьютере.</span><span class="sxs-lookup"><span data-stu-id="69112-128">Assume that KTM and an resource manager exist on the same computer.</span></span> <span data-ttu-id="69112-129">Предположим, что в KTM выдается уведомление о подготовке транзакции, но система завершается сбоем до того, как KTM зарегистрирует уведомление о подготовке.</span><span class="sxs-lookup"><span data-stu-id="69112-129">Suppose KTM issues a prepare notification for a transaction, but the system crashes before KTM logs the prepare notification.</span></span> <span data-ttu-id="69112-130">Далее предположим, что диспетчер ресурсов получает и записывает уведомление о подготовке непосредственно перед завершением работы системы.</span><span class="sxs-lookup"><span data-stu-id="69112-130">Further suppose that the resource manager receives and logs the prepare notification just before the system crashes.</span></span> <span data-ttu-id="69112-131">После восстановления системы KTM не имеет сведений о транзакции, так как она никогда не зарегистрировала этап подготовки.</span><span class="sxs-lookup"><span data-stu-id="69112-131">After the system is restored, KTM has no knowledge of the transaction, because it never logged the prepare phase.</span></span> <span data-ttu-id="69112-132">Диспетчер ресурсов имеет знания о транзакции, поскольку она получила, обрабатывает и зарегистрировала уведомление об подготовке.</span><span class="sxs-lookup"><span data-stu-id="69112-132">The resource manager has knowledge of the transaction, because it received, processed, and logged the prepare notification.</span></span> <span data-ttu-id="69112-133">Когда KTM выдает свои уведомления о восстановлении, диспетчер ресурсов не включает уведомление о восстановлении для рассматриваемой транзакции.</span><span class="sxs-lookup"><span data-stu-id="69112-133">When KTM issues its recovery notifications, the resource manager does not include a recovery notification for the transaction in question.</span></span> <span data-ttu-id="69112-134">В случае предполагаемой модели прерывания в этом случае диспетчер ресурсов будет обрабатывать подготовленную транзакцию как прерванную, когда она не получает уведомления для выполнения восстановления в этой транзакции.</span><span class="sxs-lookup"><span data-stu-id="69112-134">With the presumed abort model, the resource manager in this case will treat the prepared transaction as aborted when it does not receive notifications to perform recovery on that transaction.</span></span>

 

 



