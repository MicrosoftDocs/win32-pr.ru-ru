---
description: Windows предоставляет интерфейсы API, которые можно использовать для получения меток времени с высоким разрешением или для измерения временных интервалов.
ms.assetid: D66E0FC2-3AF2-489B-B4B5-78648905B77B
title: Получение высокоточных меток времени
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c9a1300967738b717ab8d8c822bf2af3f6a4a7ed
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "103999757"
---
# <a name="acquiring-high-resolution-time-stamps"></a><span data-ttu-id="09292-103">Получение высокоточных меток времени</span><span class="sxs-lookup"><span data-stu-id="09292-103">Acquiring high-resolution time stamps</span></span>

<span data-ttu-id="09292-104">Windows предоставляет интерфейсы API, которые можно использовать для получения меток времени с высоким разрешением или для измерения временных интервалов.</span><span class="sxs-lookup"><span data-stu-id="09292-104">Windows provides APIs that you can use to acquire high-resolution time stamps or measure time intervals.</span></span> <span data-ttu-id="09292-105">Основной API для машинного кода — [**QueryPerformanceCounter (QPC)**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span><span class="sxs-lookup"><span data-stu-id="09292-105">The primary API for native code is [**QueryPerformanceCounter (QPC)**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span></span> <span data-ttu-id="09292-106">Для драйверов устройств API режима ядра — [**кекуериперформанцекаунтер**](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-kequeryperformancecounter).</span><span class="sxs-lookup"><span data-stu-id="09292-106">For device drivers, the kernel-mode API is [**KeQueryPerformanceCounter**](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-kequeryperformancecounter).</span></span> <span data-ttu-id="09292-107">Для управляемого кода класс [**System. Diagnostics. Секундомер**](/previous-versions/windows/) использует **QPC** в качестве точного времени.</span><span class="sxs-lookup"><span data-stu-id="09292-107">For managed code, the [**System.Diagnostics.Stopwatch**](/previous-versions/windows/) class uses **QPC** as its precise time basis.</span></span>

<span data-ttu-id="09292-108">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) не зависит от и не синхронизируется со всеми внешними временными ссылками.</span><span class="sxs-lookup"><span data-stu-id="09292-108">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) is independent of and isn't synchronized to any external time reference.</span></span> <span data-ttu-id="09292-109">Чтобы получить метки времени, которые можно синхронизировать со внешней ссылкой времени (например, время в формате UTC) для использования в долгосрочных измерениях с высоким разрешением, используйте [**жетсистемтимепреЦисеасфилетиме**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimepreciseasfiletime).</span><span class="sxs-lookup"><span data-stu-id="09292-109">To retrieve time stamps that can be synchronized to an external time reference, such as, Coordinated Universal Time (UTC) for use in high-resolution time-of-day measurements, use [**GetSystemTimePreciseAsFileTime**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimepreciseasfiletime).</span></span>

<span data-ttu-id="09292-110">Метки времени и измерения интервала времени являются неотъемлемой частью измерений производительности компьютера и сети.</span><span class="sxs-lookup"><span data-stu-id="09292-110">Time stamps and time-interval measurements are an integral part of computer and network performance measurements.</span></span> <span data-ttu-id="09292-111">Эти операции измерения производительности включают вычисление времени отклика, пропускной способности и задержки, а также выполнение кода профилирования.</span><span class="sxs-lookup"><span data-stu-id="09292-111">These performance measurement operations include the computation of response time, throughput, and latency as well as profiling code execution.</span></span> <span data-ttu-id="09292-112">Каждая из этих операций включает в себя измерение действий, возникающих в течение интервала времени, определяемого начальным и завершающим событием, которое может быть независимым от любой внешней ссылки времени дня.</span><span class="sxs-lookup"><span data-stu-id="09292-112">Each of these operations involves a measurement of activities that occur during a time interval that is defined by a start and an end event that can be independent of any external time-of-day reference.</span></span>

<span data-ttu-id="09292-113">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) обычно является лучшим методом для использования в событиях отметки времени и измеряет небольшие интервалы времени, происходящие в одной системе или виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="09292-113">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) is typically the best method to use to time-stamp events and measure small time intervals that occur on the same system or virtual machine.</span></span> <span data-ttu-id="09292-114">Используйте [**жетсистемтимепреЦисеасфилетиме**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimepreciseasfiletime) , если вы хотите, чтобы события отметок времени набросаны на несколько компьютеров, при условии, что каждый компьютер участвует в схеме синхронизации времени, например в протоколе NTP.</span><span class="sxs-lookup"><span data-stu-id="09292-114">Consider using [**GetSystemTimePreciseAsFileTime**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimepreciseasfiletime) when you want to time-stamp events across multiple machines, provided that each machine is participating in a time synchronization scheme such as Network Time Protocol (NTP).</span></span> <span data-ttu-id="09292-115">**QPC** помогает избежать проблем, которые могут возникнуть при использовании других подходов к измерению времени, таких как чтение счетчика меток времени процессора (TSC) напрямую.</span><span class="sxs-lookup"><span data-stu-id="09292-115">**QPC** helps you avoid difficulties that can be encountered with other time measurement approaches, such as reading the processor’s time stamp counter (TSC) directly.</span></span>

-   [<span data-ttu-id="09292-116">Поддержка QPC в версиях Windows</span><span class="sxs-lookup"><span data-stu-id="09292-116">QPC support in Windows versions</span></span>](#qpc-support-in-windows-versions)
-   [<span data-ttu-id="09292-117">Руководство по приобретению меток времени</span><span class="sxs-lookup"><span data-stu-id="09292-117">Guidance for acquiring time stamps</span></span>](#guidance-for-acquiring-time-stamps)
    -   [<span data-ttu-id="09292-118">Виртуализация</span><span class="sxs-lookup"><span data-stu-id="09292-118">Virtualization</span></span>](#virtualization)
    -   [<span data-ttu-id="09292-119">Прямое использование TSC</span><span class="sxs-lookup"><span data-stu-id="09292-119">Direct TSC usage</span></span>](#direct-tsc-usage)
    -   [<span data-ttu-id="09292-120">Примеры получения меток времени</span><span class="sxs-lookup"><span data-stu-id="09292-120">Examples for acquiring time stamps</span></span>](#examples-for-acquiring-time-stamps)
-   [<span data-ttu-id="09292-121">Общие вопросы и ответы о QPC и TSC</span><span class="sxs-lookup"><span data-stu-id="09292-121">General FAQ about QPC and TSC</span></span>](#general-faq-about-qpc-and-tsc)
-   [<span data-ttu-id="09292-122">Часто задаваемые вопросы о программировании с помощью QPC и TSC</span><span class="sxs-lookup"><span data-stu-id="09292-122">FAQ about programming with QPC and TSC</span></span>](#faq-about-programming-with-qpc-and-tsc)
-   [<span data-ttu-id="09292-123">Характеристики часов низкого уровня оборудования</span><span class="sxs-lookup"><span data-stu-id="09292-123">Low-level hardware clock characteristics</span></span>](#low-level-hardware-clock-characteristics)
    -   [<span data-ttu-id="09292-124">Абсолютные часы и разницы</span><span class="sxs-lookup"><span data-stu-id="09292-124">Absolute Clocks and Difference Clocks</span></span>](#absolute-clocks-and-difference-clocks)
    -   [<span data-ttu-id="09292-125">Разрешение, точность, точность и стабильность</span><span class="sxs-lookup"><span data-stu-id="09292-125">Resolution, Precision, Accuracy, and Stability</span></span>](#resolution-precision-accuracy-and-stability)
-   [<span data-ttu-id="09292-126">Сведения о таймере оборудования</span><span class="sxs-lookup"><span data-stu-id="09292-126">Hardware timer info</span></span>](#hardware-timer-info)

## <a name="qpc-support-in-windows-versions"></a><span data-ttu-id="09292-127">Поддержка QPC в версиях Windows</span><span class="sxs-lookup"><span data-stu-id="09292-127">QPC support in Windows versions</span></span>

<span data-ttu-id="09292-128">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) был впервые появился в Windows 2000 и Windows XP и превратился в использование преимуществ улучшений в аппаратной платформе и процессорах.</span><span class="sxs-lookup"><span data-stu-id="09292-128">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) was introduced in Windows 2000 and Windows XP and has evolved to take advantage of improvements in the hardware platform and processors.</span></span> <span data-ttu-id="09292-129">Здесь описаны характеристики **QPC** в различных версиях Windows, помогающие поддерживать программное обеспечение, работающее в этих версиях Windows.</span><span class="sxs-lookup"><span data-stu-id="09292-129">Here we describe the characteristics of **QPC** on different Windows versions to help you maintain software that runs on those Windows versions.</span></span>

### <a name="windows-xp-and-windows-2000"></a><span data-ttu-id="09292-130">Windows XP и Windows 2000</span><span class="sxs-lookup"><span data-stu-id="09292-130">Windows XP and Windows 2000</span></span>

<span data-ttu-id="09292-131">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) доступен в Windows XP и Windows 2000 и хорошо работает в большинстве систем.</span><span class="sxs-lookup"><span data-stu-id="09292-131">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) is available on Windows XP and Windows 2000 and works well on most systems.</span></span> <span data-ttu-id="09292-132">Однако некоторые аппаратные системы BIOS не сообщают о характеристиках аппаратного процессора правильно (неразновидности TSC), а некоторые многоядерные или многопроцессорные системы используют процессоры с Тскс, которые не удалось синхронизировать между ядрами.</span><span class="sxs-lookup"><span data-stu-id="09292-132">However, some hardware systems' BIOS didn't indicate the hardware CPU characteristics correctly (a non-invariant TSC), and some multi-core or multi-processor systems used processors with TSCs that couldn't be synchronized across cores.</span></span> <span data-ttu-id="09292-133">Системы с уязвимым встроенным по, которые работают под управлением этих версий Windows, могут не предоставлять одинаковое **QPC** чтение на разных ядрах, если в качестве основы для **QPC** использовался таймер TSC.</span><span class="sxs-lookup"><span data-stu-id="09292-133">Systems with flawed firmware that run these versions of Windows might not provide the same **QPC** reading on different cores if they used the TSC as the basis for **QPC**.</span></span>

### <a name="windows-vista-and-windows-server-2008"></a><span data-ttu-id="09292-134">Windows Vista и Windows Server 2008</span><span class="sxs-lookup"><span data-stu-id="09292-134">Windows Vista and Windows Server 2008</span></span>

<span data-ttu-id="09292-135">Все компьютеры, входящие в состав Windows Vista и Windows Server 2008, использовали счетчик платформы (таймер событий высокой точности (ХПЕТ)) или таймер управления питанием ACPI (таймер PM) в качестве базиса для [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span><span class="sxs-lookup"><span data-stu-id="09292-135">All computers that shipped with Windows Vista and Windows Server 2008 used a platform counter (High Precision Event Timer (HPET)) or the ACPI Power Management Timer (PM timer) as the basis for [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span></span> <span data-ttu-id="09292-136">Такие таймеры платформы имеют более высокую задержку доступа, чем таймер TSC, и являются общими для нескольких процессоров.</span><span class="sxs-lookup"><span data-stu-id="09292-136">Such platform timers have higher access latency than the TSC and are shared between multiple processors.</span></span> <span data-ttu-id="09292-137">Это ограничивает масштабируемость **QPC** , если она вызывается параллельно из нескольких процессоров.</span><span class="sxs-lookup"><span data-stu-id="09292-137">This limits scalability of **QPC** if it is called concurrently from multiple processors.</span></span>

### <a name="windows-7-and-windows-server-2008-r2"></a><span data-ttu-id="09292-138">Windows 7 и Windows Server 2008 R2</span><span class="sxs-lookup"><span data-stu-id="09292-138">Windows 7 and Windows Server 2008 R2</span></span>

<span data-ttu-id="09292-139">Большинство компьютеров Windows 7 и Windows Server 2008 R2 имеют процессоры с постоянной ставкой Тскс и используют эти счетчики в качестве базиса для [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span><span class="sxs-lookup"><span data-stu-id="09292-139">The majority of Windows 7 and Windows Server 2008 R2 computers have processors with constant-rate TSCs and use these counters as the basis for [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span></span> <span data-ttu-id="09292-140">Тскс — это аппаратные счетчики высокого разрешения для каждого процессора, доступ к которым можно получить с очень низкой задержкой и нагрузкой (в порядке 10 или 100 циклов машин, в зависимости от типа процессора).</span><span class="sxs-lookup"><span data-stu-id="09292-140">TSCs are high-resolution per-processor hardware counters that can be accessed with very low latency and overhead (in the order of 10s or 100s of machine cycles, depending on the processor type).</span></span> <span data-ttu-id="09292-141">Windows 7 и Windows Server 2008 R2 используют Тскс в качестве основания для **QPC** в однопроцессорных системах, где операционная система (или низкоуровневая оболочка) может жестко синхронизировать отдельные тскс во всех процессорах во время инициализации системы.</span><span class="sxs-lookup"><span data-stu-id="09292-141">Windows 7 and Windows Server 2008 R2 use TSCs as the basis of **QPC** on single-clock domain systems where the operating system (or the hypervisor) is able to tightly synchronize the individual TSCs across all processors during system initialization.</span></span> <span data-ttu-id="09292-142">В таких системах стоимость чтения счетчика производительности значительно ниже по сравнению с системами, использующими счетчик платформы.</span><span class="sxs-lookup"><span data-stu-id="09292-142">On such systems, the cost of reading the performance counter is significantly lower compared to systems that use a platform counter.</span></span> <span data-ttu-id="09292-143">Кроме того, не существует дополнительных затрат на параллельные вызовы и запросы пользовательского режима, которые позволяют избежать системных вызовов, что еще больше сокращает издержки.</span><span class="sxs-lookup"><span data-stu-id="09292-143">Furthermore, there is no added overhead for concurrent calls and user-mode queries often bypass system calls, which further reduces overhead.</span></span> <span data-ttu-id="09292-144">В системах, где таймер TSC не подходит для тимекипинг, Windows автоматически выбирает счетчик платформы (таймер ХПЕТ или ACPI PM Timer) в качестве базиса для **QPC**.</span><span class="sxs-lookup"><span data-stu-id="09292-144">On systems where the TSC is not suitable for timekeeping, Windows automatically selects a platform counter (either the HPET timer or the ACPI PM timer) as the basis for **QPC**.</span></span>

### <a name="windows-8-windows-81-windows-server-2012-and-windows-server-2012-r2"></a><span data-ttu-id="09292-145">Windows 8, Windows 8.1, Windows Server 2012 и Windows Server 2012 R2</span><span class="sxs-lookup"><span data-stu-id="09292-145">Windows 8, Windows 8.1, Windows Server 2012, and Windows Server 2012 R2</span></span>

<span data-ttu-id="09292-146">Windows 8, Windows 8.1, Windows Server 2012 и Windows Server 2012 R2 используют Тскс в качестве основания для счетчика производительности.</span><span class="sxs-lookup"><span data-stu-id="09292-146">Windows 8, Windows 8.1, Windows Server 2012, and Windows Server 2012 R2 use TSCs as the basis for the performance counter.</span></span> <span data-ttu-id="09292-147">Алгоритм синхронизации TSC был значительно улучшен для лучшего размещения больших систем с большим количеством процессоров.</span><span class="sxs-lookup"><span data-stu-id="09292-147">The TSC synchronization algorithm was significantly improved to better accommodate large systems with many processors.</span></span> <span data-ttu-id="09292-148">Кроме того, добавлена поддержка нового точного API времени суток, что позволяет получать точные метки времени для часов стены с операционной системы.</span><span class="sxs-lookup"><span data-stu-id="09292-148">In addition, support for the new precise time-of-day API was added, which enables acquiring precise wall clock time stamps from the operating system.</span></span> <span data-ttu-id="09292-149">Дополнительные сведения см. в разделе [**жетсистемтимепреЦисеасфилетиме**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimepreciseasfiletime).</span><span class="sxs-lookup"><span data-stu-id="09292-149">For more info, see [**GetSystemTimePreciseAsFileTime**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimepreciseasfiletime).</span></span> <span data-ttu-id="09292-150">На платформах PC на базе Windows RT счетчик производительности основывается на счетчике собственной платформы или системного счетчика, предоставляемого универсальным таймером Windows RT PC, если платформа настолько оснащена.</span><span class="sxs-lookup"><span data-stu-id="09292-150">On Windows RT PC platforms, the performance counter is based on either a proprietary platform counter or the system counter provided by the Windows RT PC Generic Timer if the platform is so equipped.</span></span>

## <a name="guidance-for-acquiring-time-stamps"></a><span data-ttu-id="09292-151">Руководство по приобретению меток времени</span><span class="sxs-lookup"><span data-stu-id="09292-151">Guidance for acquiring time stamps</span></span>

<span data-ttu-id="09292-152">Windows имеет и будет продолжать вкладываться в предоставление надежного и эффективного счетчика производительности.</span><span class="sxs-lookup"><span data-stu-id="09292-152">Windows has and will continue to invest in providing a reliable and efficient performance counter.</span></span> <span data-ttu-id="09292-153">Если вам нужны отметки времени с разрешением 1 микросекунды или лучше, а метки времени не нужно синхронизировать со ссылкой на внешнее время, выберите [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter), [**кекуериперформанцекаунтер**](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-kequeryperformancecounter)или [**кекуеринтеррупттимепреЦисе**](/windows-hardware/drivers/ddi/content/wdm/nf-wdm-kequeryinterrupttimeprecise).</span><span class="sxs-lookup"><span data-stu-id="09292-153">When you need time stamps with a resolution of 1 microsecond or better and you don't need the time stamps to be synchronized to an external time reference, choose [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter), [**KeQueryPerformanceCounter**](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-kequeryperformancecounter), or [**KeQueryInterruptTimePrecise**](/windows-hardware/drivers/ddi/content/wdm/nf-wdm-kequeryinterrupttimeprecise).</span></span> <span data-ttu-id="09292-154">Если вам нужны отметки времени с синхронизированным временем в формате UTC с разрешением 1 микросекунды или выше, выберите [**жетсистемтимепреЦисеасфилетиме**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimepreciseasfiletime) или [**кекуерисистемтимепреЦисе**](/windows-hardware/drivers/ddi/content/wdm/nf-wdm-kequerysystemtimeprecise).</span><span class="sxs-lookup"><span data-stu-id="09292-154">When you need UTC-synchronized time stamps with a resolution of 1 microsecond or better, choose [**GetSystemTimePreciseAsFileTime**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimepreciseasfiletime) or [**KeQuerySystemTimePrecise**](/windows-hardware/drivers/ddi/content/wdm/nf-wdm-kequerysystemtimeprecise).</span></span>

<span data-ttu-id="09292-155">На относительно небольшом количестве платформ, которые не могут использовать регистр TSC как [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) , например, по причинам, описанным в [сведениях о аппаратном таймере](#hardware-timer-info), получение меток времени с высоким разрешением может значительно дороже, чем получение меток времени с низким разрешением.</span><span class="sxs-lookup"><span data-stu-id="09292-155">On a relatively small number of platforms that can't use the TSC register as the [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) basis, for example, for reasons explained in [Hardware timer info](#hardware-timer-info), acquiring high resolution time stamps can be significantly more expensive than acquiring time stamps with lower resolution.</span></span> <span data-ttu-id="09292-156">Если разрешение от 10 до 16 миллисекунд достаточно, можно использовать [**GetTickCount64**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount64), [**куеринтеррупттиме**](/windows/desktop/api/realtimeapiset/nf-realtimeapiset-queryinterrupttime), [**куерюнбиасединтеррупттиме**](/windows/win32/api/realtimeapiset/nf-realtimeapiset-queryunbiasedinterrupttime), [**кекуеринтеррупттиме**](/windows-hardware/drivers/ddi/content/wdm/nf-wdm-kequeryinterrupttime)или [**кекуерюнбиасединтеррупттиме**](/windows-hardware/drivers/ddi/content/wdm/nf-wdm-kequeryunbiasedinterrupttime) для получения меток времени, которые не синхронизируются со внешними временными ссылками.</span><span class="sxs-lookup"><span data-stu-id="09292-156">If resolution of 10 to 16 milliseconds is sufficient, you can use [**GetTickCount64**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount64), [**QueryInterruptTime**](/windows/desktop/api/realtimeapiset/nf-realtimeapiset-queryinterrupttime), [**QueryUnbiasedInterruptTime**](/windows/win32/api/realtimeapiset/nf-realtimeapiset-queryunbiasedinterrupttime), [**KeQueryInterruptTime**](/windows-hardware/drivers/ddi/content/wdm/nf-wdm-kequeryinterrupttime), or [**KeQueryUnbiasedInterruptTime**](/windows-hardware/drivers/ddi/content/wdm/nf-wdm-kequeryunbiasedinterrupttime) to obtain time stamps that aren't synchronized to an external time reference.</span></span> <span data-ttu-id="09292-157">Для штампов времени с синхронизированным временем в формате UTC используйте [**GetSystemTimeAsFileTime**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimeasfiletime) или [**кекуерисистемтиме**](/windows-hardware/drivers/ddi/wdm/nf-wdm-kequerysystemtime~r1).</span><span class="sxs-lookup"><span data-stu-id="09292-157">For UTC-synchronized time stamps, use [**GetSystemTimeAsFileTime**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimeasfiletime) or [**KeQuerySystemTime**](/windows-hardware/drivers/ddi/wdm/nf-wdm-kequerysystemtime~r1).</span></span> <span data-ttu-id="09292-158">Если требуется более высокое разрешение, можно использовать [**куеринтеррупттимепреЦисе**](/windows/desktop/api/realtimeapiset/nf-realtimeapiset-queryinterrupttimeprecise), [**куерюнбиасединтеррупттимепреЦисе**](/windows/desktop/api/realtimeapiset/nf-realtimeapiset-queryunbiasedinterrupttimeprecise)или [**кекуеринтеррупттимепреЦисе**](/windows-hardware/drivers/ddi/content/wdm/nf-wdm-kequeryinterrupttimeprecise) для получения меток времени.</span><span class="sxs-lookup"><span data-stu-id="09292-158">If higher resolution is needed, you can use [**QueryInterruptTimePrecise**](/windows/desktop/api/realtimeapiset/nf-realtimeapiset-queryinterrupttimeprecise), [**QueryUnbiasedInterruptTimePrecise**](/windows/desktop/api/realtimeapiset/nf-realtimeapiset-queryunbiasedinterrupttimeprecise), or [**KeQueryInterruptTimePrecise**](/windows-hardware/drivers/ddi/content/wdm/nf-wdm-kequeryinterrupttimeprecise) to obtain time stamps instead.</span></span>

<span data-ttu-id="09292-159">В общем случае результаты счетчика производительности будут согласованы во всех процессорах в многоядерных и многопроцессорных системах, даже если они измеряются в разных потоках или процессах.</span><span class="sxs-lookup"><span data-stu-id="09292-159">In general, the performance counter results are consistent across all processors in multi-core and multi-processor systems, even when measured on different threads or processes.</span></span> <span data-ttu-id="09292-160">Ниже приведены некоторые исключения из этого правила.</span><span class="sxs-lookup"><span data-stu-id="09292-160">Here are some exceptions to this rule:</span></span>

-   <span data-ttu-id="09292-161">Передовые операционные системы Windows Vista, работающие на определенных процессорах, могут нарушать эту согласованность по одной из следующих причин:</span><span class="sxs-lookup"><span data-stu-id="09292-161">Pre-Windows Vista operating systems that run on certain processors might violate this consistency because of one of these reasons:</span></span>

    -   <span data-ttu-id="09292-162">Аппаратные процессоры имеют неизменяемую TSC, а BIOS не указывает это состояние правильно.</span><span class="sxs-lookup"><span data-stu-id="09292-162">The hardware processors have a non-invariant TSC and the BIOS doesn't indicate this condition correctly.</span></span>
    -   <span data-ttu-id="09292-163">Используемый алгоритм синхронизации TSC не подходит для систем с большим количеством процессоров.</span><span class="sxs-lookup"><span data-stu-id="09292-163">The TSC synchronization algorithm that was used wasn't suitable for systems with large numbers of processors.</span></span>

-   <span data-ttu-id="09292-164">При сравнении результатов счетчика производительности, полученных из разных потоков, рассмотрите возможность неоднозначного упорядочения значений, отличающихся от ± 1 Tick.</span><span class="sxs-lookup"><span data-stu-id="09292-164">When you compare performance counter results that are acquired from different threads, consider values that differ by ± 1 tick to have an ambiguous ordering.</span></span> <span data-ttu-id="09292-165">Если отметки времени берутся из одного потока, неопределенность ± 1 тика не применяется.</span><span class="sxs-lookup"><span data-stu-id="09292-165">If the time stamps are taken from the same thread, this ± 1 tick uncertainty doesn't apply.</span></span> <span data-ttu-id="09292-166">В этом контексте термин Tick ссылается на период времени, равный 1 (частота счетчика производительности, полученного от [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency)).</span><span class="sxs-lookup"><span data-stu-id="09292-166">In this context, the term tick refers to a period of time equal to 1 ÷ (the frequency of the performance counter obtained from [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency)).</span></span>

<span data-ttu-id="09292-167">При использовании счетчика производительности в больших серверных системах с многовременными доменами, которые не синхронизированы в оборудовании, Windows определяет, что таймер TSC не может использоваться в целях обеспечения времени и выбирает счетчик платформы в качестве базиса для [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span><span class="sxs-lookup"><span data-stu-id="09292-167">When you use the performance counter on large server systems with multiple-clock domains that aren't synchronized in hardware, Windows determines that the TSC can't be used for timing purposes and selects a platform counter as the basis for [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span></span> <span data-ttu-id="09292-168">Хотя этот сценарий по-прежнему обеспечивает надежные отметки времени, задержка доступа и масштабируемость неблагоприятно затрагиваются.</span><span class="sxs-lookup"><span data-stu-id="09292-168">While this scenario still yields reliable time stamps, the access latency and scalability is adversely affected.</span></span> <span data-ttu-id="09292-169">Поэтому, как было сказано в предыдущем руководстве по использованию, используйте только API, которые обеспечивают 1 микросекунду или лучшее решение, если такое разрешение требуется.</span><span class="sxs-lookup"><span data-stu-id="09292-169">Therefore, as previously stated in the preceding usage guidance, only use the APIs that provide 1 microsecond or better resolution when such resolution is necessary.</span></span> <span data-ttu-id="09292-170">Таймер TSC используется в качестве базиса для **QPC** в многотактовых системах с несколькими часами, которые включают синхронизацию оборудования всех доменов процессоров, так как это эффективно делает их функциями единой системы домена часов.</span><span class="sxs-lookup"><span data-stu-id="09292-170">The TSC is used as the basis for **QPC** on multi-clock domain systems that include hardware synchronization of all processor clock domains, as this effectively makes them function as a single clock domain system.</span></span>

<span data-ttu-id="09292-171">Частота счетчика производительности зафиксирована при загрузке системы и согласована во всех процессорах, поэтому необходимо запросить частоту от [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) при инициализации приложения, а затем кэшировать результат.</span><span class="sxs-lookup"><span data-stu-id="09292-171">The frequency of the performance counter is fixed at system boot and is consistent across all processors so you only need to query the frequency from [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) as the application initializes, and then cache the result.</span></span>

### <a name="virtualization"></a><span data-ttu-id="09292-172">Виртуализация</span><span class="sxs-lookup"><span data-stu-id="09292-172">Virtualization</span></span>

<span data-ttu-id="09292-173">Предполагается, что счетчик производительности надежно работает на всех гостевых виртуальных машинах, работающих на правильных гипервизорах.</span><span class="sxs-lookup"><span data-stu-id="09292-173">The performance counter is expected to work reliably on all guest virtual machines running on correctly implemented hypervisors.</span></span> <span data-ttu-id="09292-174">Однако низкоуровневые оболочки, которые соответствуют интерфейсу гипервизора версии 1,0 и поверхности просвещение, могут существенно снизить издержки.</span><span class="sxs-lookup"><span data-stu-id="09292-174">However, hypervisors that comply with the hypervisor version 1.0 interface and surface the reference time enlightenment can offer substantially lower overhead.</span></span> <span data-ttu-id="09292-175">Дополнительные сведения о интерфейсах гипервизора и просветлений см. в статье [спецификации гипервизора](/virtualization/hyper-v-on-windows/reference/tlfs).</span><span class="sxs-lookup"><span data-stu-id="09292-175">For more information about hypervisor interfaces and enlightenments, see [Hypervisor Specifications](/virtualization/hyper-v-on-windows/reference/tlfs).</span></span>

### <a name="direct-tsc-usage"></a><span data-ttu-id="09292-176">Прямое использование TSC</span><span class="sxs-lookup"><span data-stu-id="09292-176">Direct TSC usage</span></span>

<span data-ttu-id="09292-177">Мы настоятельно не рекомендуем использовать инструкцию процессора **RDTSC** или **RDTSCP** для прямого запроса таймера TSC, так как вы не получаете надежные результаты в некоторых версиях Windows, в рамках динамической миграции виртуальных машин и в аппаратных системах без инвариантной или тесной синхронизации тскс.</span><span class="sxs-lookup"><span data-stu-id="09292-177">We strongly discourage using the **RDTSC** or **RDTSCP** processor instruction to directly query the TSC because you won't get reliable results on some versions of Windows, across live migrations of virtual machines, and on hardware systems without invariant or tightly synchronized TSCs.</span></span> <span data-ttu-id="09292-178">Вместо этого мы рекомендуем использовать [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) для использования абстракции, согласованности и переносимости, предоставляемой ИТ.</span><span class="sxs-lookup"><span data-stu-id="09292-178">Instead, we encourage you to use [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) to leverage the abstraction, consistency, and portability that it offers.</span></span>

### <a name="examples-for-acquiring-time-stamps"></a><span data-ttu-id="09292-179">Примеры получения меток времени</span><span class="sxs-lookup"><span data-stu-id="09292-179">Examples for acquiring time stamps</span></span>

<span data-ttu-id="09292-180">В различных примерах кода в этих разделах показано, как получить отметки времени.</span><span class="sxs-lookup"><span data-stu-id="09292-180">The various code examples in these sections show how to acquire time stamps.</span></span>

### <a name="using-qpc-in-native-code"></a><span data-ttu-id="09292-181">Использование QPC в машинном коде</span><span class="sxs-lookup"><span data-stu-id="09292-181">Using QPC in native code</span></span>

<span data-ttu-id="09292-182">В этом примере показано, как использовать [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) в машинном коде C и C++.</span><span class="sxs-lookup"><span data-stu-id="09292-182">This example shows how to use [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) in C and C++ native code.</span></span>


```C++
LARGE_INTEGER StartingTime, EndingTime, ElapsedMicroseconds;
LARGE_INTEGER Frequency;

QueryPerformanceFrequency(&Frequency); 
QueryPerformanceCounter(&StartingTime);

// Activity to be timed

QueryPerformanceCounter(&EndingTime);
ElapsedMicroseconds.QuadPart = EndingTime.QuadPart - StartingTime.QuadPart;


//
// We now have the elapsed number of ticks, along with the
// number of ticks-per-second. We use these values
// to convert to the number of elapsed microseconds.
// To guard against loss-of-precision, we convert
// to microseconds *before* dividing by ticks-per-second.
//

ElapsedMicroseconds.QuadPart *= 1000000;
ElapsedMicroseconds.QuadPart /= Frequency.QuadPart;
```



### <a name="acquiring-high-resolution-time-stamps-from-managed-code"></a><span data-ttu-id="09292-183">Получение меток времени с высоким разрешением из управляемого кода</span><span class="sxs-lookup"><span data-stu-id="09292-183">Acquiring high resolution time stamps from managed code</span></span>

<span data-ttu-id="09292-184">В этом примере показано, как использовать класс управляемого кода [**System. Diagnostics. Секундомер**](/previous-versions/windows/) .</span><span class="sxs-lookup"><span data-stu-id="09292-184">This example shows how to use the managed code [**System.Diagnostics.Stopwatch**](/previous-versions/windows/) class.</span></span>


```CSharp
using System.Diagnostics;

long StartingTime = Stopwatch.GetTimestamp();

// Activity to be timed

long EndingTime  = Stopwatch.GetTimestamp();
long ElapsedTime = EndingTime - StartingTime;

double ElapsedSeconds = ElapsedTime * (1.0 / Stopwatch.Frequency);
```



<span data-ttu-id="09292-185">Класс [**System. Diagnostics. Секундомер**](/previous-versions/windows/) также предоставляет несколько удобных методов для выполнения измерений интервала времени.</span><span class="sxs-lookup"><span data-stu-id="09292-185">The [**System.Diagnostics.Stopwatch**](/previous-versions/windows/) class also provides several convenient methods to perform time-interval measurements.</span></span>

### <a name="using-qpc-from-kernel-mode"></a><span data-ttu-id="09292-186">Использование QPC из режима ядра</span><span class="sxs-lookup"><span data-stu-id="09292-186">Using QPC from kernel mode</span></span>

<span data-ttu-id="09292-187">Ядро Windows предоставляет доступ к счетчику производительности в режиме ядра через [**кекуериперформанцекаунтер**](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-kequeryperformancecounter) , из которого можно получить как счетчик производительности, так и частоту производительности.</span><span class="sxs-lookup"><span data-stu-id="09292-187">The Windows kernel provides kernel-mode access to the performance counter through [**KeQueryPerformanceCounter**](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-kequeryperformancecounter) from which both the performance counter and performance frequency can be obtained.</span></span> <span data-ttu-id="09292-188">**Кекуериперформанцекаунтер** доступен только в режиме ядра и предоставляется для модулей записи драйверов устройств и других компонентов режима ядра.</span><span class="sxs-lookup"><span data-stu-id="09292-188">**KeQueryPerformanceCounter** is available from kernel mode only and is provided for writers of device drivers and other kernel-mode components.</span></span>

<span data-ttu-id="09292-189">В этом примере показано, как использовать [**кекуериперформанцекаунтер**](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-kequeryperformancecounter) в режиме ядра C и C++.</span><span class="sxs-lookup"><span data-stu-id="09292-189">This example shows how to use [**KeQueryPerformanceCounter**](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-kequeryperformancecounter) in C and C++ kernel mode.</span></span>


```C++
LARGE_INTEGER StartingTime, EndingTime, ElapsedMicroseconds;
LARGE_INTEGER Frequency;

StartingTime = KeQueryPerformanceCounter(&Frequency);

// Activity to be timed

EndingTime = KeQueryPerformanceCounter(NULL);
ElapsedMicroseconds.QuadPart = EndingTime.QuadPart - StartingTime.QuadPart;
ElapsedMicroseconds.QuadPart *= 1000000;
ElapsedMicroseconds.QuadPart /= Frequency.QuadPart;
```



## <a name="general-faq-about-qpc-and-tsc"></a><span data-ttu-id="09292-190">Общие вопросы и ответы о QPC и TSC</span><span class="sxs-lookup"><span data-stu-id="09292-190">General FAQ about QPC and TSC</span></span>

<span data-ttu-id="09292-191">Здесь приведены ответы на часто задаваемые вопросы о [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) и тскс в целом.</span><span class="sxs-lookup"><span data-stu-id="09292-191">Here are answers to frequently-asked questions about [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and TSCs in general.</span></span>

<dl> <dt>

<span data-ttu-id="09292-192"><span id="Is_QueryPerformanceCounter___the_same_as_the_Win32_GetTickCount___or_________GetTickCount64___function_"></span><span id="is_queryperformancecounter___the_same_as_the_win32_gettickcount___or_________gettickcount64___function_"></span><span id="IS_QUERYPERFORMANCECOUNTER___THE_SAME_AS_THE_WIN32_GETTICKCOUNT___OR_________GETTICKCOUNT64___FUNCTION_"></span>**Является QueryPerformanceCounter () аналогично функции Win32 Жеттикккаунт () или GetTickCount64 ()?**</span><span class="sxs-lookup"><span data-stu-id="09292-192"><span id="Is_QueryPerformanceCounter___the_same_as_the_Win32_GetTickCount___or_________GetTickCount64___function_"></span><span id="is_queryperformancecounter___the_same_as_the_win32_gettickcount___or_________gettickcount64___function_"></span><span id="IS_QUERYPERFORMANCECOUNTER___THE_SAME_AS_THE_WIN32_GETTICKCOUNT___OR_________GETTICKCOUNT64___FUNCTION_"></span>**Is QueryPerformanceCounter() the same as the Win32 GetTickCount() or GetTickCount64() function?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-193">Нет.</span><span class="sxs-lookup"><span data-stu-id="09292-193">No.</span></span> <span data-ttu-id="09292-194">[**Жеттикккаунт**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount) и [**GetTickCount64**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount64) не связаны с [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span><span class="sxs-lookup"><span data-stu-id="09292-194">[**GetTickCount**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount) and [**GetTickCount64**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount64) aren't related to [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span></span> <span data-ttu-id="09292-195">**Жеттикккаунт** и **GetTickCount64** возвращают количество миллисекунд с момента запуска системы.</span><span class="sxs-lookup"><span data-stu-id="09292-195">**GetTickCount** and **GetTickCount64** return the number of milliseconds since the system was started.</span></span>

</dd> <dt>

<span data-ttu-id="09292-196"><span id="Should_I_use_QPC_or_call_the_RDTSC__RDTSCP_instructions_directly_"></span><span id="should_i_use_qpc_or_call_the_rdtsc__rdtscp_instructions_directly_"></span><span id="SHOULD_I_USE_QPC_OR_CALL_THE_RDTSC__RDTSCP_INSTRUCTIONS_DIRECTLY_"></span>**Следует ли использовать QPC или вызывать инструкции RDTSC/РДТСКП напрямую?**</span><span class="sxs-lookup"><span data-stu-id="09292-196"><span id="Should_I_use_QPC_or_call_the_RDTSC__RDTSCP_instructions_directly_"></span><span id="should_i_use_qpc_or_call_the_rdtsc__rdtscp_instructions_directly_"></span><span id="SHOULD_I_USE_QPC_OR_CALL_THE_RDTSC__RDTSCP_INSTRUCTIONS_DIRECTLY_"></span>**Should I use QPC or call the RDTSC /RDTSCP instructions directly?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-197">Чтобы избежать проблем с неправильными и переносимостью, мы настоятельно рекомендуем использовать [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) вместо использования регистра TSC или инструкций **RDTSC** или **RDTSCP** процессора.</span><span class="sxs-lookup"><span data-stu-id="09292-197">To avoid incorrectness and portability issues, we strongly encourage you to use [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) instead of using the TSC register or the **RDTSC** or **RDTSCP** processor instructions.</span></span>

</dd> <dt>

<span data-ttu-id="09292-198"><span id="What_is_QPC_s_relation_to_an_external_time_epoch__Can_it_be_synchronized_to_an_________external_epoch_such_as_UTC_"></span><span id="what_is_qpc_s_relation_to_an_external_time_epoch__can_it_be_synchronized_to_an_________external_epoch_such_as_utc_"></span><span id="WHAT_IS_QPC_S_RELATION_TO_AN_EXTERNAL_TIME_EPOCH__CAN_IT_BE_SYNCHRONIZED_TO_AN_________EXTERNAL_EPOCH_SUCH_AS_UTC_"></span>**Что такое отношение QPC к внешнему эпохе времени? Можно ли синхронизировать его с внешним Эпохом, например в формате UTC?**</span><span class="sxs-lookup"><span data-stu-id="09292-198"><span id="What_is_QPC_s_relation_to_an_external_time_epoch__Can_it_be_synchronized_to_an_________external_epoch_such_as_UTC_"></span><span id="what_is_qpc_s_relation_to_an_external_time_epoch__can_it_be_synchronized_to_an_________external_epoch_such_as_utc_"></span><span id="WHAT_IS_QPC_S_RELATION_TO_AN_EXTERNAL_TIME_EPOCH__CAN_IT_BE_SYNCHRONIZED_TO_AN_________EXTERNAL_EPOCH_SUCH_AS_UTC_"></span>**What is QPC’s relation to an external time epoch? Can it be synchronized to an external epoch such as UTC?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-199">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) основан на счетчике оборудования, который не может быть синхронизирован со внешней ссылкой на время, например в формате UTC.</span><span class="sxs-lookup"><span data-stu-id="09292-199">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) is based on a hardware counter that can't be synchronized to an external time reference, such as UTC.</span></span> <span data-ttu-id="09292-200">Для точной отметки времени дня, которую можно синхронизировать с внешней ссылкой в формате UTC, используйте [**жетсистемтимепреЦисеасфилетиме**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimepreciseasfiletime).</span><span class="sxs-lookup"><span data-stu-id="09292-200">For precise time-of-day time stamps that can be synchronized to an external UTC reference, use [**GetSystemTimePreciseAsFileTime**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimepreciseasfiletime).</span></span>

</dd> <dt>

<span data-ttu-id="09292-201"><span id="Is_QPC_affected_by_daylight_savings_time__leap_seconds__time_zones__or_system_________time_changes_made_by_the_administrator_"></span><span id="is_qpc_affected_by_daylight_savings_time__leap_seconds__time_zones__or_system_________time_changes_made_by_the_administrator_"></span><span id="IS_QPC_AFFECTED_BY_DAYLIGHT_SAVINGS_TIME__LEAP_SECONDS__TIME_ZONES__OR_SYSTEM_________TIME_CHANGES_MADE_BY_THE_ADMINISTRATOR_"></span>**QPC ли воздействие на летнее время, високосные секунды, часовые пояса или изменения системного времени, внесенные администратором?**</span><span class="sxs-lookup"><span data-stu-id="09292-201"><span id="Is_QPC_affected_by_daylight_savings_time__leap_seconds__time_zones__or_system_________time_changes_made_by_the_administrator_"></span><span id="is_qpc_affected_by_daylight_savings_time__leap_seconds__time_zones__or_system_________time_changes_made_by_the_administrator_"></span><span id="IS_QPC_AFFECTED_BY_DAYLIGHT_SAVINGS_TIME__LEAP_SECONDS__TIME_ZONES__OR_SYSTEM_________TIME_CHANGES_MADE_BY_THE_ADMINISTRATOR_"></span>**Is QPC affected by daylight savings time, leap seconds, time zones, or system time changes made by the administrator?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-202">Нет.</span><span class="sxs-lookup"><span data-stu-id="09292-202">No.</span></span> <span data-ttu-id="09292-203">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) полностью независим от системного времени и UTC.</span><span class="sxs-lookup"><span data-stu-id="09292-203">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) is completely independent of the system time and UTC.</span></span>

</dd> <dt>

<span data-ttu-id="09292-204"><span id="Is_QPC_accuracy_affected_by_processor_frequency_changes_caused_by_power_________management_or_Turbo_Boost_technology_"></span><span id="is_qpc_accuracy_affected_by_processor_frequency_changes_caused_by_power_________management_or_turbo_boost_technology_"></span><span id="IS_QPC_ACCURACY_AFFECTED_BY_PROCESSOR_FREQUENCY_CHANGES_CAUSED_BY_POWER_________MANAGEMENT_OR_TURBO_BOOST_TECHNOLOGY_"></span>**QPC ли влияние изменений частоты процессора, вызванных технологией управления питанием или технологии Turbo Boost?**</span><span class="sxs-lookup"><span data-stu-id="09292-204"><span id="Is_QPC_accuracy_affected_by_processor_frequency_changes_caused_by_power_________management_or_Turbo_Boost_technology_"></span><span id="is_qpc_accuracy_affected_by_processor_frequency_changes_caused_by_power_________management_or_turbo_boost_technology_"></span><span id="IS_QPC_ACCURACY_AFFECTED_BY_PROCESSOR_FREQUENCY_CHANGES_CAUSED_BY_POWER_________MANAGEMENT_OR_TURBO_BOOST_TECHNOLOGY_"></span>**Is QPC accuracy affected by processor frequency changes caused by power management or Turbo Boost technology?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-205">Нет.</span><span class="sxs-lookup"><span data-stu-id="09292-205">No.</span></span> <span data-ttu-id="09292-206">Если процессор имеет инвариант TSC, эти изменения не затрагивают [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) .</span><span class="sxs-lookup"><span data-stu-id="09292-206">If the processor has an invariant TSC, the [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) is not affected by these sort of changes.</span></span> <span data-ttu-id="09292-207">Если процессор не имеет инвариантов TSC, **QPC** вернется к аппаратному таймеру платформы, который не будет зависеть от изменения частоты процессора или технологии Turbo Boost.</span><span class="sxs-lookup"><span data-stu-id="09292-207">If the processor doesn't have an invariant TSC, **QPC** will revert to a platform hardware timer that won't be affected by processor frequency changes or Turbo Boost technology.</span></span>

</dd> <dt>

<span data-ttu-id="09292-208"><span id="Does_QPC_reliably_work_on_multi-processor_systems__multi-core_system__and_________systems_with_hyper-threading_"></span><span id="does_qpc_reliably_work_on_multi-processor_systems__multi-core_system__and_________systems_with_hyper-threading_"></span><span id="DOES_QPC_RELIABLY_WORK_ON_MULTI-PROCESSOR_SYSTEMS__MULTI-CORE_SYSTEM__AND_________SYSTEMS_WITH_HYPER-THREADING_"></span>**QPCа ли надежная работа на многопроцессорных системах, многоядерной системе и системах с технологией Hyper-Threading?**</span><span class="sxs-lookup"><span data-stu-id="09292-208"><span id="Does_QPC_reliably_work_on_multi-processor_systems__multi-core_system__and_________systems_with_hyper-threading_"></span><span id="does_qpc_reliably_work_on_multi-processor_systems__multi-core_system__and_________systems_with_hyper-threading_"></span><span id="DOES_QPC_RELIABLY_WORK_ON_MULTI-PROCESSOR_SYSTEMS__MULTI-CORE_SYSTEM__AND_________SYSTEMS_WITH_HYPER-THREADING_"></span>**Does QPC reliably work on multi-processor systems, multi-core system, and systems with hyper-threading?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-209">Да</span><span class="sxs-lookup"><span data-stu-id="09292-209">Yes</span></span>

</dd> <dt>

<span data-ttu-id="09292-210"><span id="How_do_I_determine_and_validate_that_QPC_works_on_my_machine_"></span><span id="how_do_i_determine_and_validate_that_qpc_works_on_my_machine_"></span><span id="HOW_DO_I_DETERMINE_AND_VALIDATE_THAT_QPC_WORKS_ON_MY_MACHINE_"></span>**Разделы справки определить и проверить, работает ли QPC на моем компьютере?**</span><span class="sxs-lookup"><span data-stu-id="09292-210"><span id="How_do_I_determine_and_validate_that_QPC_works_on_my_machine_"></span><span id="how_do_i_determine_and_validate_that_qpc_works_on_my_machine_"></span><span id="HOW_DO_I_DETERMINE_AND_VALIDATE_THAT_QPC_WORKS_ON_MY_MACHINE_"></span>**How do I determine and validate that QPC works on my machine?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-211">Такие проверки выполнять не нужно.</span><span class="sxs-lookup"><span data-stu-id="09292-211">You don't need to perform such checks.</span></span>

</dd> <dt>

<span data-ttu-id="09292-212"><span id="Which_processors_have_non-invariant_TSCs__How_can_I_check_if_my_system_has_a_________non-invariant_TSC_"></span><span id="which_processors_have_non-invariant_tscs__how_can_i_check_if_my_system_has_a_________non-invariant_tsc_"></span><span id="WHICH_PROCESSORS_HAVE_NON-INVARIANT_TSCS__HOW_CAN_I_CHECK_IF_MY_SYSTEM_HAS_A_________NON-INVARIANT_TSC_"></span>**Какие процессоры имеют неинвариантный Тскс? Как проверить, не имеет ли моя система значение TSC?**</span><span class="sxs-lookup"><span data-stu-id="09292-212"><span id="Which_processors_have_non-invariant_TSCs__How_can_I_check_if_my_system_has_a_________non-invariant_TSC_"></span><span id="which_processors_have_non-invariant_tscs__how_can_i_check_if_my_system_has_a_________non-invariant_tsc_"></span><span id="WHICH_PROCESSORS_HAVE_NON-INVARIANT_TSCS__HOW_CAN_I_CHECK_IF_MY_SYSTEM_HAS_A_________NON-INVARIANT_TSC_"></span>**Which processors have non-invariant TSCs? How can I check if my system has a non-invariant TSC?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-213">Вам не нужно выполнять эту проверку самостоятельно.</span><span class="sxs-lookup"><span data-stu-id="09292-213">You don't need to perform this check yourself.</span></span> <span data-ttu-id="09292-214">Операционные системы Windows выполняют несколько проверок при инициализации системы, чтобы определить, подходит ли таймер TSC в качестве основания для [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span><span class="sxs-lookup"><span data-stu-id="09292-214">Windows operating systems perform several checks at system initialization to determine if the TSC is suitable as a basis for [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span></span> <span data-ttu-id="09292-215">Однако для справочных целей можно определить, имеет ли процессор инвариантный таймер TSC, используя один из следующих вариантов:</span><span class="sxs-lookup"><span data-stu-id="09292-215">However, for reference purposes, you can determine whether your processor has an invariant TSC by using one of these:</span></span>

-   <span data-ttu-id="09292-216">Служебная программа Coreinfo.exe из Windows Sysinternals</span><span class="sxs-lookup"><span data-stu-id="09292-216">the Coreinfo.exe utility from Windows Sysinternals</span></span>
-   <span data-ttu-id="09292-217">Проверка значений, возвращаемых инструкцией CPUID, относящейся к характеристикам TSC</span><span class="sxs-lookup"><span data-stu-id="09292-217">checking the values returned by the CPUID instruction pertaining to the TSC characteristics</span></span>
-   <span data-ttu-id="09292-218">документация производителя процессора</span><span class="sxs-lookup"><span data-stu-id="09292-218">the processor manufacturer’s documentation</span></span>

<span data-ttu-id="09292-219">Ниже показаны неизменяемые сведения TSC, предоставляемые служебной программой Windows Sysinternals Coreinfo.exe ([www.sysinternals.com](https://www.sysinternals.com)).</span><span class="sxs-lookup"><span data-stu-id="09292-219">The following shows the TSC-INVARIANT info that is provided by the Windows Sysinternals Coreinfo.exe utility ([www.sysinternals.com](https://www.sysinternals.com)).</span></span> <span data-ttu-id="09292-220">Звездочка означает «истина».</span><span class="sxs-lookup"><span data-stu-id="09292-220">An asterisk means "True".</span></span>

``` syntax
> Coreinfo.exe 

Coreinfo v3.2 - Dump information on system CPU and memory topology
Copyright (C) 2008-2012 Mark Russinovich
Sysinternals - www.sysinternals.com

 <unrelated text removed>

RDTSCP          * Supports RDTSCP instruction
TSC             * Supports RDTSC instruction
TSC-DEADLINE    - Local APIC supports one-shot deadline timer
TSC-INVARIANT   * TSC runs at constant rate
```

</dd> <dt>

<span data-ttu-id="09292-221"><span id="Does_QPC_work_reliably_on__hardware_platforms_"></span><span id="does_qpc_work_reliably_on__hardware_platforms_"></span><span id="DOES_QPC_WORK_RELIABLY_ON__HARDWARE_PLATFORMS_"></span>**Надежно ли QPC работает на компьютерных аппаратных платформах Windows RT?**</span><span class="sxs-lookup"><span data-stu-id="09292-221"><span id="Does_QPC_work_reliably_on__hardware_platforms_"></span><span id="does_qpc_work_reliably_on__hardware_platforms_"></span><span id="DOES_QPC_WORK_RELIABLY_ON__HARDWARE_PLATFORMS_"></span>**Does QPC work reliably on Windows RT PC hardware platforms?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-222">Да</span><span class="sxs-lookup"><span data-stu-id="09292-222">Yes</span></span>

</dd> <dt>

<span data-ttu-id="09292-223"><span id="How_often_does_QPC_roll_over_"></span><span id="how_often_does_qpc_roll_over_"></span><span id="HOW_OFTEN_DOES_QPC_ROLL_OVER_"></span>**Как часто QPC передвигаться?**</span><span class="sxs-lookup"><span data-stu-id="09292-223"><span id="How_often_does_QPC_roll_over_"></span><span id="how_often_does_qpc_roll_over_"></span><span id="HOW_OFTEN_DOES_QPC_ROLL_OVER_"></span>**How often does QPC roll over?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-224">Не менее 100 лет от самой последней загрузки системы и, возможно, дольше, основываясь на используемом базовом аппаратном таймере.</span><span class="sxs-lookup"><span data-stu-id="09292-224">Not less than 100 years from the most recent system boot, and potentially longer based on the underlying hardware timer used.</span></span> <span data-ttu-id="09292-225">Для большинства приложений смена не является проблемой.</span><span class="sxs-lookup"><span data-stu-id="09292-225">For most applications, rollover isn't a concern.</span></span>

</dd> <dt>

<span data-ttu-id="09292-226"><span id="What_is_the_computational_cost_of_calling_QPC_"></span><span id="what_is_the_computational_cost_of_calling_qpc_"></span><span id="WHAT_IS_THE_COMPUTATIONAL_COST_OF_CALLING_QPC_"></span>**Какова стоимость вычислительных ресурсов при вызове QPC?**</span><span class="sxs-lookup"><span data-stu-id="09292-226"><span id="What_is_the_computational_cost_of_calling_QPC_"></span><span id="what_is_the_computational_cost_of_calling_qpc_"></span><span id="WHAT_IS_THE_COMPUTATIONAL_COST_OF_CALLING_QPC_"></span>**What is the computational cost of calling QPC?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-227">Вычислительный вызов [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) определяется преимущественно базовой аппаратной платформой.</span><span class="sxs-lookup"><span data-stu-id="09292-227">The computational calling cost of [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) is determined primarily by the underlying hardware platform.</span></span> <span data-ttu-id="09292-228">Если регистр TSC используется в качестве основания для QPC, вычислительные затраты определяются в первую очередь на время, затрачиваемое процессором на обработку инструкции **RDTSC** .</span><span class="sxs-lookup"><span data-stu-id="09292-228">If the TSC register is used as the basis for QPC, the computational cost is determined primarily by how long the processor takes to process an **RDTSC** instruction.</span></span> <span data-ttu-id="09292-229">Это время в диапазоне от 10 циклов ЦП до нескольких сотен циклов ЦП в зависимости от используемого процессора.</span><span class="sxs-lookup"><span data-stu-id="09292-229">This time ranges from 10s of CPU cycles to several hundred CPU cycles depending upon the processor used.</span></span> <span data-ttu-id="09292-230">Если таймер TSC не может быть использован, система выбирает другое аппаратное время.</span><span class="sxs-lookup"><span data-stu-id="09292-230">If the TSC can't be used, the system will select a different hardware time basis.</span></span> <span data-ttu-id="09292-231">Так как эти базовые базы данных расположены на материнской плате (например, в Южной мост PCI или PCH), вычислительные затраты на вызов выше, чем таймер TSC, и часто встречаются в 0,8-1,0 микросекундах в зависимости от скорости процессора и других факторов оборудования.</span><span class="sxs-lookup"><span data-stu-id="09292-231">Because these time bases are located on the motherboard (for example, on the PCI South Bridge or PCH), the per-call computational cost is higher than the TSC, and is frequently in the vicinity of 0.8 - 1.0 microseconds depending on processor speed and other hardware factors.</span></span> <span data-ttu-id="09292-232">Эта стоимость определяется временем, необходимым для доступа к аппаратному устройству на материнской плате.</span><span class="sxs-lookup"><span data-stu-id="09292-232">This cost is dominated by the time required to access the hardware device on the motherboard.</span></span>

</dd> <dt>

<span data-ttu-id="09292-233"><span id="Does_QPC_require_a_kernel_transition__system_call__"></span><span id="does_qpc_require_a_kernel_transition__system_call__"></span><span id="DOES_QPC_REQUIRE_A_KERNEL_TRANSITION__SYSTEM_CALL__"></span>**Требуется ли для QPC переход ядра (системный вызов)?**</span><span class="sxs-lookup"><span data-stu-id="09292-233"><span id="Does_QPC_require_a_kernel_transition__system_call__"></span><span id="does_qpc_require_a_kernel_transition__system_call__"></span><span id="DOES_QPC_REQUIRE_A_KERNEL_TRANSITION__SYSTEM_CALL__"></span>**Does QPC require a kernel transition (system call)?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-234">Переход ядра не требуется, если система может использовать регистр TSC в качестве основания для [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span><span class="sxs-lookup"><span data-stu-id="09292-234">A kernel transition is not required if the system can use the TSC register as the basis for [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span></span> <span data-ttu-id="09292-235">Если система должна использовать другую базу времени, например таймер ХПЕТ или PM, требуется системный вызов.</span><span class="sxs-lookup"><span data-stu-id="09292-235">If the system must use a different time base, such as the HPET or PM timer, a system call is required.</span></span>

</dd> <dt>

<span data-ttu-id="09292-236"><span id="Is_the_performance_counter_monotonic__non-decreasing__"></span><span id="is_the_performance_counter_monotonic__non-decreasing__"></span><span id="IS_THE_PERFORMANCE_COUNTER_MONOTONIC__NON-DECREASING__"></span>**Является ли счетчик производительности монотонным (не уменьшающимся)?**</span><span class="sxs-lookup"><span data-stu-id="09292-236"><span id="Is_the_performance_counter_monotonic__non-decreasing__"></span><span id="is_the_performance_counter_monotonic__non-decreasing__"></span><span id="IS_THE_PERFORMANCE_COUNTER_MONOTONIC__NON-DECREASING__"></span>**Is the performance counter monotonic (non-decreasing)?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-237">Да</span><span class="sxs-lookup"><span data-stu-id="09292-237">Yes</span></span>

</dd> <dt>

<span data-ttu-id="09292-238"><span id="Can_the_performance_counter_be_used_to_order_events_in_time_"></span><span id="can_the_performance_counter_be_used_to_order_events_in_time_"></span><span id="CAN_THE_PERFORMANCE_COUNTER_BE_USED_TO_ORDER_EVENTS_IN_TIME_"></span>**Можно ли использовать счетчик производительности для упорядочивания событий в течение времени?**</span><span class="sxs-lookup"><span data-stu-id="09292-238"><span id="Can_the_performance_counter_be_used_to_order_events_in_time_"></span><span id="can_the_performance_counter_be_used_to_order_events_in_time_"></span><span id="CAN_THE_PERFORMANCE_COUNTER_BE_USED_TO_ORDER_EVENTS_IN_TIME_"></span>**Can the performance counter be used to order events in time?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-239">Да.</span><span class="sxs-lookup"><span data-stu-id="09292-239">Yes.</span></span> <span data-ttu-id="09292-240">Однако при сравнении результатов счетчика производительности, полученных из разных потоков, значения, отличающиеся ± 1 Tick, имеют неоднозначное упорядочение, как если бы они имели одинаковую отметку времени.</span><span class="sxs-lookup"><span data-stu-id="09292-240">However, when comparing performance counter results that are acquired from different threads, values that differ by ± 1 tick have an ambiguous ordering as if they had an identical time stamp.</span></span>

</dd> <dt>

<span data-ttu-id="09292-241"><span id="How_accurate_is_the_performance_counter_"></span><span id="how_accurate_is_the_performance_counter_"></span><span id="HOW_ACCURATE_IS_THE_PERFORMANCE_COUNTER_"></span>**Насколько точны счетчики производительности?**</span><span class="sxs-lookup"><span data-stu-id="09292-241"><span id="How_accurate_is_the_performance_counter_"></span><span id="how_accurate_is_the_performance_counter_"></span><span id="HOW_ACCURATE_IS_THE_PERFORMANCE_COUNTER_"></span>**How accurate is the performance counter?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-242">Ответ зависит от различных факторов.</span><span class="sxs-lookup"><span data-stu-id="09292-242">The answer depends on a variety of factors.</span></span> <span data-ttu-id="09292-243">Дополнительные сведения см. в разделе [характеристики аппаратных часов низкого уровня](#low-level-hardware-clock-characteristics).</span><span class="sxs-lookup"><span data-stu-id="09292-243">For more info, see [Low-level hardware clock characteristics](#low-level-hardware-clock-characteristics).</span></span>

</dd> </dl>

## <a name="faq-about-programming-with-qpc-and-tsc"></a><span data-ttu-id="09292-244">Часто задаваемые вопросы о программировании с помощью QPC и TSC</span><span class="sxs-lookup"><span data-stu-id="09292-244">FAQ about programming with QPC and TSC</span></span>

<span data-ttu-id="09292-245">Здесь приведены ответы на часто задаваемые вопросы о программировании с помощью [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) и тскс.</span><span class="sxs-lookup"><span data-stu-id="09292-245">Here are answers to frequently-asked questions about programming with [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and TSCs.</span></span>

<dl> <dt>

<span data-ttu-id="09292-246"><span id="I_need_to_convert_the_QPC_output_to_milliseconds._How_can_I_avoid_loss_of_________precision_with_converting_to_double_or_float_"></span><span id="i_need_to_convert_the_qpc_output_to_milliseconds._how_can_i_avoid_loss_of_________precision_with_converting_to_double_or_float_"></span><span id="I_NEED_TO_CONVERT_THE_QPC_OUTPUT_TO_MILLISECONDS._HOW_CAN_I_AVOID_LOSS_OF_________PRECISION_WITH_CONVERTING_TO_DOUBLE_OR_FLOAT_"></span>**Мне нужно преобразовать выходные данные QPC в миллисекунды. Как избежать потери точности при преобразовании в Double или float?**</span><span class="sxs-lookup"><span data-stu-id="09292-246"><span id="I_need_to_convert_the_QPC_output_to_milliseconds._How_can_I_avoid_loss_of_________precision_with_converting_to_double_or_float_"></span><span id="i_need_to_convert_the_qpc_output_to_milliseconds._how_can_i_avoid_loss_of_________precision_with_converting_to_double_or_float_"></span><span id="I_NEED_TO_CONVERT_THE_QPC_OUTPUT_TO_MILLISECONDS._HOW_CAN_I_AVOID_LOSS_OF_________PRECISION_WITH_CONVERTING_TO_DOUBLE_OR_FLOAT_"></span>**I need to convert the QPC output to milliseconds. How can I avoid loss of precision with converting to double or float?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-247">При выполнении вычислений с целочисленными счетчиками производительности необходимо учитывать следующие моменты.</span><span class="sxs-lookup"><span data-stu-id="09292-247">There are several things to keep in mind when performing calculations on integer performance counters:</span></span>

-   <span data-ttu-id="09292-248">Деление целых чисел приведет к потере остатка.</span><span class="sxs-lookup"><span data-stu-id="09292-248">Integer division will lose the remainder.</span></span> <span data-ttu-id="09292-249">В некоторых случаях это может привести к потере точности.</span><span class="sxs-lookup"><span data-stu-id="09292-249">This can cause loss of precision in some cases.</span></span>
-   <span data-ttu-id="09292-250">Преобразование между 64-разрядными целыми числами и плавающей запятой (Double) может привести к потере точности, поскольку мантисса с плавающей запятой не может представлять все возможные целочисленные значения.</span><span class="sxs-lookup"><span data-stu-id="09292-250">Conversion between 64 bit integers and floating point (double) can cause loss of precision because the floating point mantissa can't represent all possible integral values.</span></span>
-   <span data-ttu-id="09292-251">Умножение в 64 разрядов может привести к переполнению целого числа.</span><span class="sxs-lookup"><span data-stu-id="09292-251">Multiplication of 64 bit integers can result in integer overflow.</span></span>

<span data-ttu-id="09292-252">В качестве общего принципа отложите эти вычисления и преобразования максимально долго, чтобы избежать возникновения ошибок.</span><span class="sxs-lookup"><span data-stu-id="09292-252">As a general principle, delay these computations and conversions as long as possible to avoid compounding the errors introduced.</span></span>

</dd> <dt>

<span data-ttu-id="09292-253"><span id="How_can_I_convert_QPC_to_100_nanosecond_ticks_so_I_can_add_it_to_a_________FILETIME_"></span><span id="how_can_i_convert_qpc_to_100_nanosecond_ticks_so_i_can_add_it_to_a_________filetime_"></span><span id="HOW_CAN_I_CONVERT_QPC_TO_100_NANOSECOND_TICKS_SO_I_CAN_ADD_IT_TO_A_________FILETIME_"></span>**Как выполнить преобразование QPC в 100 наносекунд, чтобы добавить его в FILETIME?**</span><span class="sxs-lookup"><span data-stu-id="09292-253"><span id="How_can_I_convert_QPC_to_100_nanosecond_ticks_so_I_can_add_it_to_a_________FILETIME_"></span><span id="how_can_i_convert_qpc_to_100_nanosecond_ticks_so_i_can_add_it_to_a_________filetime_"></span><span id="HOW_CAN_I_CONVERT_QPC_TO_100_NANOSECOND_TICKS_SO_I_CAN_ADD_IT_TO_A_________FILETIME_"></span>**How can I convert QPC to 100 nanosecond ticks so I can add it to a FILETIME?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-254">Время файла — это 64-разрядное значение, представляющее число 100-наносекундных интервалов, прошедших с 12:00 утра.</span><span class="sxs-lookup"><span data-stu-id="09292-254">A file time is a 64-bit value that represents the number of 100-nanosecond intervals that have elapsed since 12:00 A.M.</span></span> <span data-ttu-id="09292-255">1 января 1601 скоординированного всемирного времени (UTC).</span><span class="sxs-lookup"><span data-stu-id="09292-255">January 1, 1601 Coordinated Universal Time (UTC).</span></span> <span data-ttu-id="09292-256">Время файла используется вызовами API Win32, которые возвращают время дня, например [**GetSystemTimeAsFileTime**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimeasfiletime) и [**жетсистемтимепреЦисеасфилетиме**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimepreciseasfiletime).</span><span class="sxs-lookup"><span data-stu-id="09292-256">File times are used by Win32 API calls that return time-of-day, such as [**GetSystemTimeAsFileTime**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimeasfiletime) and [**GetSystemTimePreciseAsFileTime**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimepreciseasfiletime).</span></span> <span data-ttu-id="09292-257">Напротив, [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) возвращает значения, представляющие время в единицах измерения 1/(частота счетчика производительности, полученного из [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency)).</span><span class="sxs-lookup"><span data-stu-id="09292-257">By contrast, [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) returns values that represent time in units of 1/(the frequency of the performance counter obtained from [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency)).</span></span> <span data-ttu-id="09292-258">Для преобразования между двумя необходимо рассчитать отношение интервала **QPC** и 100-наносекундах интервалов.</span><span class="sxs-lookup"><span data-stu-id="09292-258">Conversion between the two requires calculating the ratio of the **QPC** interval and 100-nanoseconds intervals.</span></span> <span data-ttu-id="09292-259">Будьте внимательны, чтобы избежать потери точности, поскольку значения могут быть небольшими (0,0000001/0,000000340).</span><span class="sxs-lookup"><span data-stu-id="09292-259">Be careful to avoid losing precision because the values might be small (0.0000001 / 0.000000340).</span></span>

</dd> <dt>

<span data-ttu-id="09292-260"><span id="Why_is_the_time_stamp_that_is_returned_from_QPC_a_signed_integer_"></span><span id="why_is_the_time_stamp_that_is_returned_from_qpc_a_signed_integer_"></span><span id="WHY_IS_THE_TIME_STAMP_THAT_IS_RETURNED_FROM_QPC_A_SIGNED_INTEGER_"></span>**Почему отметка времени, возвращаемая из QPC, возвращает целое число со знаком?**</span><span class="sxs-lookup"><span data-stu-id="09292-260"><span id="Why_is_the_time_stamp_that_is_returned_from_QPC_a_signed_integer_"></span><span id="why_is_the_time_stamp_that_is_returned_from_qpc_a_signed_integer_"></span><span id="WHY_IS_THE_TIME_STAMP_THAT_IS_RETURNED_FROM_QPC_A_SIGNED_INTEGER_"></span>**Why is the time stamp that is returned from QPC a signed integer?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-261">Вычисления, затрагивающие метки времени [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) , могут содержать вычитание.</span><span class="sxs-lookup"><span data-stu-id="09292-261">Calculations that involve [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) time stamps might involve subtraction.</span></span> <span data-ttu-id="09292-262">Используя значение со знаком, можно выполнять вычисления, которые могут привести к отрицательным значениям.</span><span class="sxs-lookup"><span data-stu-id="09292-262">By using a signed value, you can handle calculations that might yield negative values.</span></span>

</dd> <dt>

<span data-ttu-id="09292-263"><span id="How_can_I_obtain_high_resolution_time_stamps_from_managed_code_"></span><span id="how_can_i_obtain_high_resolution_time_stamps_from_managed_code_"></span><span id="HOW_CAN_I_OBTAIN_HIGH_RESOLUTION_TIME_STAMPS_FROM_MANAGED_CODE_"></span>**Как можно получить метки времени высокого разрешения из управляемого кода?**</span><span class="sxs-lookup"><span data-stu-id="09292-263"><span id="How_can_I_obtain_high_resolution_time_stamps_from_managed_code_"></span><span id="how_can_i_obtain_high_resolution_time_stamps_from_managed_code_"></span><span id="HOW_CAN_I_OBTAIN_HIGH_RESOLUTION_TIME_STAMPS_FROM_MANAGED_CODE_"></span>**How can I obtain high resolution time stamps from managed code?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-264">Вызовите метод [**секундомер.. timestamp**](/previous-versions/windows/) из класса [**System. Diagnostics. Секундомер**](/previous-versions/windows/) .</span><span class="sxs-lookup"><span data-stu-id="09292-264">Call the [**Stopwatch.GetTimeStamp**](/previous-versions/windows/) method from the [**System.Diagnostics.Stopwatch**](/previous-versions/windows/) class.</span></span> <span data-ttu-id="09292-265">Пример использования **секундомера. timestamp** см. в разделе [Получение меток времени с высоким разрешением из управляемого кода](#acquiring-high-resolution-time-stamps-from-managed-code).</span><span class="sxs-lookup"><span data-stu-id="09292-265">For an example about how to use **Stopwatch.GetTimeStamp**, see [Acquiring high resolution time stamps from managed code](#acquiring-high-resolution-time-stamps-from-managed-code).</span></span>

</dd> <dt>

<span data-ttu-id="09292-266"><span id="Under_what_circumstances_does_QueryPerformanceFrequency_return_FALSE__or_________QueryPerformanceCounter_return_zero_"></span><span id="under_what_circumstances_does_queryperformancefrequency_return_false__or_________queryperformancecounter_return_zero_"></span><span id="UNDER_WHAT_CIRCUMSTANCES_DOES_QUERYPERFORMANCEFREQUENCY_RETURN_FALSE__OR_________QUERYPERFORMANCECOUNTER_RETURN_ZERO_"></span>**При каких обстоятельствах Куериперформанцефрекуенци возвращает значение FALSE или QueryPerformanceCounter возвращает нуль?**</span><span class="sxs-lookup"><span data-stu-id="09292-266"><span id="Under_what_circumstances_does_QueryPerformanceFrequency_return_FALSE__or_________QueryPerformanceCounter_return_zero_"></span><span id="under_what_circumstances_does_queryperformancefrequency_return_false__or_________queryperformancecounter_return_zero_"></span><span id="UNDER_WHAT_CIRCUMSTANCES_DOES_QUERYPERFORMANCEFREQUENCY_RETURN_FALSE__OR_________QUERYPERFORMANCECOUNTER_RETURN_ZERO_"></span>**Under what circumstances does QueryPerformanceFrequency return FALSE, or QueryPerformanceCounter return zero?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-267">Это не произойдет в любой системе под управлением Windows XP или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="09292-267">This won't occur on any system that runs Windows XP or later.</span></span>

</dd> <dt>

<span data-ttu-id="09292-268"><span id="Do_I_need_to_set_the_thread_affinity_to_a_single_core_to_use_QPC_"></span><span id="do_i_need_to_set_the_thread_affinity_to_a_single_core_to_use_qpc_"></span><span id="DO_I_NEED_TO_SET_THE_THREAD_AFFINITY_TO_A_SINGLE_CORE_TO_USE_QPC_"></span>**Нужно ли устанавливать сходство потоков в одно ядро для использования QPC?**</span><span class="sxs-lookup"><span data-stu-id="09292-268"><span id="Do_I_need_to_set_the_thread_affinity_to_a_single_core_to_use_QPC_"></span><span id="do_i_need_to_set_the_thread_affinity_to_a_single_core_to_use_qpc_"></span><span id="DO_I_NEED_TO_SET_THE_THREAD_AFFINITY_TO_A_SINGLE_CORE_TO_USE_QPC_"></span>**Do I need to set the thread affinity to a single core to use QPC?**</span></span>
</dt> <dd>

<span data-ttu-id="09292-269">Нет.</span><span class="sxs-lookup"><span data-stu-id="09292-269">No.</span></span> <span data-ttu-id="09292-270">Дополнительные сведения см. в разделе [рекомендации по приобретению меток времени](#guidance-for-acquiring-time-stamps).</span><span class="sxs-lookup"><span data-stu-id="09292-270">For more info, see [Guidance for acquiring time stamps](#guidance-for-acquiring-time-stamps).</span></span> <span data-ttu-id="09292-271">Этот сценарий не является необходимым и нежелательным.</span><span class="sxs-lookup"><span data-stu-id="09292-271">This scenario is neither necessary nor desirable.</span></span> <span data-ttu-id="09292-272">Выполнение этого сценария может негативно сказаться на производительности приложения путем ограничения обработки одним ядром или созданием узкого места в одном ядре, если несколько потоков устанавливают свое сходство для одного ядра при вызове [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span><span class="sxs-lookup"><span data-stu-id="09292-272">Performing this scenario might adversely affect your application's performance by restricting processing to one core or by creating a bottleneck on a single core if multiple threads set their affinity to the same core when calling [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span></span>

</dd> </dl>

## <a name="low-level-hardware-clock-characteristics"></a><span data-ttu-id="09292-273">Характеристики часов низкого уровня оборудования</span><span class="sxs-lookup"><span data-stu-id="09292-273">Low-level hardware clock characteristics</span></span>

<span data-ttu-id="09292-274">В этих разделах показаны характеристики аппаратных часов низкого уровня.</span><span class="sxs-lookup"><span data-stu-id="09292-274">These sections show low-level hardware clock characteristics.</span></span>

### <a name="absolute-clocks-and-difference-clocks"></a><span data-ttu-id="09292-275">Абсолютные часы и разницы</span><span class="sxs-lookup"><span data-stu-id="09292-275">Absolute Clocks and Difference Clocks</span></span>

<span data-ttu-id="09292-276">Абсолютные часы обеспечивают точность считывания по времени суток.</span><span class="sxs-lookup"><span data-stu-id="09292-276">Absolute clocks provide accurate time-of-day readings.</span></span> <span data-ttu-id="09292-277">Обычно они основаны на всеобщем скоординированном времени (UTC), поэтому их точность зависит от того, насколько они синхронизированы со ссылкой на внешнее время.</span><span class="sxs-lookup"><span data-stu-id="09292-277">They are typically based on Coordinated Universal Time (UTC) and consequently their accuracy depends in part on how well they are synchronized to an external time reference.</span></span> <span data-ttu-id="09292-278">Разница измеряет временные интервалы и обычно не основывается на внешнем эпохе времени.</span><span class="sxs-lookup"><span data-stu-id="09292-278">Difference clocks measure time intervals and aren't typically based on an external time epoch.</span></span> <span data-ttu-id="09292-279">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) — это разница времени и не синхронизируется с внешним временным временем или ссылкой.</span><span class="sxs-lookup"><span data-stu-id="09292-279">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) is a difference clock and isn't synchronized to an external time epoch or reference.</span></span> <span data-ttu-id="09292-280">При использовании **QPC** для измерений интервалов времени обычно обеспечивается более высокая точность, чем при использовании меток времени, полученных из абсолютных часов.</span><span class="sxs-lookup"><span data-stu-id="09292-280">When you use **QPC** for time-interval measurements, you typically get better accuracy than you would get by using time stamps that are derived from an absolute clock.</span></span> <span data-ttu-id="09292-281">Это связано с тем, что процесс синхронизации времени с абсолютными часами может привести к появлению этапов и сдвигов частоты, которые увеличивают неопределенность краткосрочных интервалов времени.</span><span class="sxs-lookup"><span data-stu-id="09292-281">This is because the process of synchronizing the time of an absolute clock can introduce phase and frequency shifts that increase the uncertainty of short term time-interval measurements.</span></span>

### <a name="resolution-precision-accuracy-and-stability"></a><span data-ttu-id="09292-282">Разрешение, точность, точность и стабильность</span><span class="sxs-lookup"><span data-stu-id="09292-282">Resolution, Precision, Accuracy, and Stability</span></span>

<span data-ttu-id="09292-283">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) использует аппаратный счетчик в качестве базиса.</span><span class="sxs-lookup"><span data-stu-id="09292-283">[**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) uses a hardware counter as its basis.</span></span> <span data-ttu-id="09292-284">Аппаратные таймеры состоят из трех частей: генератор тактов, счетчик, который подсчитывает такты, и способ получения значения счетчика.</span><span class="sxs-lookup"><span data-stu-id="09292-284">Hardware timers consist of three parts: a tick generator, a counter that counts the ticks, and a means of retrieving the counter value.</span></span> <span data-ttu-id="09292-285">Характеристики этих трех компонентов определяют разрешение, точность, точность и стабильность **QPC**.</span><span class="sxs-lookup"><span data-stu-id="09292-285">The characteristics of these three components determine the resolution, precision, accuracy, and stability of **QPC**.</span></span>

<span data-ttu-id="09292-286">Если генератор оборудования обеспечивает такты с постоянной частотой, интервалы времени могут измеряться путем простого подсчета этих тактов.</span><span class="sxs-lookup"><span data-stu-id="09292-286">If a hardware generator provides ticks at a constant rate, time intervals can be measured by simply counting these ticks.</span></span> <span data-ttu-id="09292-287">Частота, с которой создаются такты, называется частотой и выражается в герцах (Гц).</span><span class="sxs-lookup"><span data-stu-id="09292-287">The rate at which the ticks are generated is called the frequency and expressed in Hertz (Hz).</span></span> <span data-ttu-id="09292-288">Обратная частота частоты называется периодом или интервалом тактов и выражается в соответствующей международной единице времени (например, секунды, миллисекунда, микросекунда или наносекундных).</span><span class="sxs-lookup"><span data-stu-id="09292-288">The reciprocal of the frequency is called the period or tick interval and is expressed in an appropriate International System of Units (SI) time unit (for example, second, millisecond, microsecond, or nanosecond).</span></span>

![временной интервал](images/tick-interval.png)

<span data-ttu-id="09292-290">Разрешение таймера равно точке.</span><span class="sxs-lookup"><span data-stu-id="09292-290">The resolution of the timer is equal to the period.</span></span> <span data-ttu-id="09292-291">Разрешение определяет возможность различать любые две отметки времени и размещает нижнюю границу наименьшего интервала времени, который может измеряться.</span><span class="sxs-lookup"><span data-stu-id="09292-291">Resolution determines the ability to distinguish between any two time stamps and places a lower bound on the smallest time intervals that can be measured.</span></span> <span data-ttu-id="09292-292">Иногда это называется разрешением Tick.</span><span class="sxs-lookup"><span data-stu-id="09292-292">This is sometimes called the tick resolution.</span></span>

<span data-ttu-id="09292-293">Цифровое измерение времени представляет неопределенное измерение, равное ± 1 тактов, так как цифровой счетчик увеличивается на отдельные шаги, а время постоянно увеличивается.</span><span class="sxs-lookup"><span data-stu-id="09292-293">Digital measurement of time introduces a measurements uncertainty of ± 1 tick because the digital counter advances in discrete steps, while time is continuously advancing.</span></span> <span data-ttu-id="09292-294">Это неопределенность называется ошибкой дискретизация.</span><span class="sxs-lookup"><span data-stu-id="09292-294">This uncertainty is called a quantization error.</span></span> <span data-ttu-id="09292-295">Для типичных измерений интервала времени этот результат часто можно игнорировать, так как ошибка куантизинг намного меньше, чем измеряется интервал времени.</span><span class="sxs-lookup"><span data-stu-id="09292-295">For typical time-interval measurements, this effect can often be ignored because the quantizing error is much smaller than the time interval being measured.</span></span>

![цифровое измерение времени](images/digital-time-measure.png)

<span data-ttu-id="09292-297">Однако если измеряемый период является небольшим и приближается к разрешению таймера, необходимо учитывать эту ошибку куантизинг.</span><span class="sxs-lookup"><span data-stu-id="09292-297">However, if the period being measured is small and approaches the resolution of the timer, you will need to consider this quantizing error.</span></span> <span data-ttu-id="09292-298">В сообщении об ошибке отображается один из периодов времени.</span><span class="sxs-lookup"><span data-stu-id="09292-298">The size of the error introduced is that of one clock period.</span></span>

<span data-ttu-id="09292-299">На следующих двух схемах показано влияние неопределенности ± 1 тика с помощью таймера с разрешением 1 единицы времени.</span><span class="sxs-lookup"><span data-stu-id="09292-299">The following two diagrams illustrate the impact of the ± 1 tick uncertainty by using a timer with a resolution of 1 time unit.</span></span>

![неопределенность Tick](images/tick-uncertainty.png)

<span data-ttu-id="09292-301">[**Куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) возвращает частоту [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter), а точка и разрешение равны обратному значению этого значения.</span><span class="sxs-lookup"><span data-stu-id="09292-301">[**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) returns the frequency of [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter), and the period and resolution are equal to the reciprocal of this value.</span></span> <span data-ttu-id="09292-302">Частота счетчика производительности, возвращаемая **куериперформанцефрекуенци** , определяется во время инициализации системы и не изменяется во время работы системы.</span><span class="sxs-lookup"><span data-stu-id="09292-302">The performance counter frequency that **QueryPerformanceFrequency** returns is determined during system initialization and doesn't change while the system is running.</span></span>

> [!Note]  
> <span data-ttu-id="09292-303">Возможны случаи, когда [**куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) не возвращает фактическую частоту генератора аппаратных тактов.</span><span class="sxs-lookup"><span data-stu-id="09292-303">Cases might exist where [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) doesn't return the actual frequency of the hardware tick generator.</span></span> <span data-ttu-id="09292-304">Например, во многих случаях **куериперформанцефрекуенци** возвращает ЧАСТОТу TSC, деленную на 1024; и в Hyper-V частота счетчика производительности всегда составляет 10 МГц, когда Гостевая виртуальная машина выполняется в [низкоуровневой оболочке](https://msdn.microsoft.com/library/Ff542584(v=VS.85).aspx) , которая реализует [интерфейс гипервизора версии 1,0](https://msdn.microsoft.com/library/Ff541458(v=VS.85).aspx).</span><span class="sxs-lookup"><span data-stu-id="09292-304">For example, in many cases, **QueryPerformanceFrequency** returns the TSC frequency divided by 1024; and on Hyper-V, the performance counter frequency is always 10 MHz when the guest virtual machine runs under a [hypervisor](https://msdn.microsoft.com/library/Ff542584(v=VS.85).aspx) that implements the [hypervisor version 1.0 interface](https://msdn.microsoft.com/library/Ff541458(v=VS.85).aspx).</span></span> <span data-ttu-id="09292-305">В результате не следует рассчитывать на то, что **куериперформанцефрекуенци** будет возвращать точную частоту TSC.</span><span class="sxs-lookup"><span data-stu-id="09292-305">As a result, don't assume that **QueryPerformanceFrequency** will return the precise TSC frequency.</span></span>

 

<span data-ttu-id="09292-306">[**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) считывает счетчик производительности и возвращает общее количество тактов, произошедших с момента запуска операционной системы Windows, включая время перехода компьютера в спящий режим, например ждущий, спящий или подключенный режим ожидания.</span><span class="sxs-lookup"><span data-stu-id="09292-306">[**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) reads the performance counter and returns the total number of ticks that have occurred since the Windows operating system was started, including the time when the machine was in a sleep state such as standby, hibernate, or connected standby.</span></span>

<span data-ttu-id="09292-307">В этих примерах показано, как вычислить интервал времени и разрешение, а также как преобразовать счетчик тактов в значение времени.</span><span class="sxs-lookup"><span data-stu-id="09292-307">These examples show how to calculate the tick interval and resolution and how to convert the tick count into a time value.</span></span>

<dl> <dt>

<span data-ttu-id="09292-308"><span id="Example_1"></span><span id="example_1"></span><span id="EXAMPLE_1"></span>**Пример 1**</span><span class="sxs-lookup"><span data-stu-id="09292-308"><span id="Example_1"></span><span id="example_1"></span><span id="EXAMPLE_1"></span>**Example 1**</span></span>
</dt> <dd>

<span data-ttu-id="09292-309">[**Куериперформанцефрекуенци**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) возвращает значение 3 125 000 на определенном компьютере.</span><span class="sxs-lookup"><span data-stu-id="09292-309">[**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) returns the value 3,125,000 on a particular machine.</span></span> <span data-ttu-id="09292-310">Каков интервал времени и разрешение [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) измерений на этом компьютере?</span><span class="sxs-lookup"><span data-stu-id="09292-310">What is the tick interval and resolution of [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) measurements on this machine?</span></span> <span data-ttu-id="09292-311">Интервал Tick (точка) — это обратная величина 3 125 000, которая равна 0,000000320 (320 наносекунд).</span><span class="sxs-lookup"><span data-stu-id="09292-311">The tick interval, or period, is the reciprocal of 3,125,000, which is 0.000000320 (320 nanoseconds).</span></span> <span data-ttu-id="09292-312">Таким образом, каждый такт представляет передачу 320 наносекунд.</span><span class="sxs-lookup"><span data-stu-id="09292-312">Therefore, each tick represents the passing of 320 nanoseconds.</span></span> <span data-ttu-id="09292-313">Интервалы времени, меньшие 320 наносекунд, не могут измеряться на этом компьютере.</span><span class="sxs-lookup"><span data-stu-id="09292-313">Time intervals smaller than 320 nanoseconds can't be measured on this machine.</span></span>

<span data-ttu-id="09292-314">Интервал времени = 1/(частота производительности)</span><span class="sxs-lookup"><span data-stu-id="09292-314">Tick Interval = 1/(Performance Frequency)</span></span>

<span data-ttu-id="09292-315">Интервал времени = 1/3125000 = 320 НС</span><span class="sxs-lookup"><span data-stu-id="09292-315">Tick Interval = 1/3,125,000 = 320 ns</span></span>

</dd> <dt>

<span data-ttu-id="09292-316"><span id="Example_2"></span><span id="example_2"></span><span id="EXAMPLE_2"></span>**Пример 2**</span><span class="sxs-lookup"><span data-stu-id="09292-316"><span id="Example_2"></span><span id="example_2"></span><span id="EXAMPLE_2"></span>**Example 2**</span></span>
</dt> <dd>

<span data-ttu-id="09292-317">На том же компьютере, что и в предыдущем примере, разница между значениями, возвращаемыми двумя последовательными вызовами [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) , равна 5.</span><span class="sxs-lookup"><span data-stu-id="09292-317">On the same machine as the preceding example, the difference of the values returned from two successive calls to [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) is 5.</span></span> <span data-ttu-id="09292-318">Сколько времени прошло между двумя вызовами?</span><span class="sxs-lookup"><span data-stu-id="09292-318">How much time has elapsed between the two calls?</span></span> <span data-ttu-id="09292-319">5 тактов, умноженные на 320 наносекунд, выдают 1,6 микросекунд.</span><span class="sxs-lookup"><span data-stu-id="09292-319">5 ticks multiplied by 320 nanoseconds yields 1.6 microseconds.</span></span>

<span data-ttu-id="09292-320">Елапседтиме = \* интервал делений</span><span class="sxs-lookup"><span data-stu-id="09292-320">ElapsedTime = Ticks \* Tick Interval</span></span>

<span data-ttu-id="09292-321">Елапседтиме = 5 \* 320 NS = 1,6 μс</span><span class="sxs-lookup"><span data-stu-id="09292-321">ElapsedTime = 5 \* 320 ns = 1.6 μs</span></span>

</dd> </dl>

<span data-ttu-id="09292-322">Для доступа (чтения) счетчика тактов от программного обеспечения требуется время, а это время доступа может уменьшить точность измерения времени.</span><span class="sxs-lookup"><span data-stu-id="09292-322">It takes time to access (read) the tick counter from software, and this access time can reduce the precision of the of the time measurement.</span></span> <span data-ttu-id="09292-323">Это связано с тем, что минимальный интервал времени (наименьший интервал времени, который можно измерять) — это большее из значений разрешения и времени доступа.</span><span class="sxs-lookup"><span data-stu-id="09292-323">This is because the minimum interval time (the smallest time interval that can be measured) is the larger of the resolution and the access time.</span></span>

<span data-ttu-id="09292-324">Точность = максимальное \[ разрешение, акцесстиме\]</span><span class="sxs-lookup"><span data-stu-id="09292-324">Precision = MAX \[ Resolution, AccessTime\]</span></span>

<span data-ttu-id="09292-325">Например, рассмотрим гипотетический аппаратный таймер с разрешением 100 НС и временем доступа 800 НС.</span><span class="sxs-lookup"><span data-stu-id="09292-325">For example, consider a hypothetical hardware timer with a 100 nanosecond resolution and an 800 nanosecond access time.</span></span> <span data-ttu-id="09292-326">Это может быть вызвано тем, что при использовании таймера платформы вместо регистра TSC в качестве основания для [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span><span class="sxs-lookup"><span data-stu-id="09292-326">This might be the case if the platform timer were used instead of the TSC register as the basis of [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter).</span></span> <span data-ttu-id="09292-327">Таким образом, точность будет 800 наносекунд не 100 наносекунд, как показано в этом вычислении.</span><span class="sxs-lookup"><span data-stu-id="09292-327">Thus, the precision would be 800 nanoseconds not 100 nanoseconds as shown in this calculation.</span></span>

<span data-ttu-id="09292-328">Precision = MAX \[ 800 НС, 100 НС \] = 800 NS</span><span class="sxs-lookup"><span data-stu-id="09292-328">Precision = MAX \[800 ns,100 ns\] = 800 ns</span></span>

<span data-ttu-id="09292-329">На этих двух рисунках показан этот результат.</span><span class="sxs-lookup"><span data-stu-id="09292-329">These two figures depict this effect.</span></span>

![время доступа qpc](images/qpc-access-time.png)

<span data-ttu-id="09292-331">Если время доступа больше разрешения, не пытайтесь улучшить точность, выполнив подбор.</span><span class="sxs-lookup"><span data-stu-id="09292-331">If the access time is greater than the resolution, don't try to improve the precision by guessing.</span></span> <span data-ttu-id="09292-332">Иными словами, следует предположить, что отметка времени выполняется точно в середине, в начале или в конце вызова.</span><span class="sxs-lookup"><span data-stu-id="09292-332">In other words, it's an error to assume that the time stamp is taken precisely in the middle, or at the beginning or the end of the call.</span></span>

<span data-ttu-id="09292-333">В отличие от этого, рассмотрим следующий пример, в котором время доступа к [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) составляет только 20 наносекунд, а аппаратное разрешение — 100 наносекунд.</span><span class="sxs-lookup"><span data-stu-id="09292-333">By contrast, consider the following example in which the [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) access time is only 20 nanoseconds and the hardware clock resolution is 100 nanoseconds.</span></span> <span data-ttu-id="09292-334">Это может быть вызвано тем, что регистр TSC используется в качестве основания для **QPC**.</span><span class="sxs-lookup"><span data-stu-id="09292-334">This might be the case if the TSC register was used as the basis for **QPC**.</span></span> <span data-ttu-id="09292-335">Здесь точность ограничена с помощью разрешения часов.</span><span class="sxs-lookup"><span data-stu-id="09292-335">Here the precision is limited by the clock resolution.</span></span>

![точность qpc](images/qpc-precision.png)

<span data-ttu-id="09292-337">На практике можно найти источники времени, для которых время, необходимое для чтения счетчика, больше или меньше, чем разрешение.</span><span class="sxs-lookup"><span data-stu-id="09292-337">In practice, you can find time sources for which the time required to read the counter is larger or smaller than the resolution.</span></span> <span data-ttu-id="09292-338">В любом случае точность будет равна большему из двух.</span><span class="sxs-lookup"><span data-stu-id="09292-338">In either case, the precision will be the larger of the two.</span></span>

<span data-ttu-id="09292-339">Эта таблица содержит сведения о приблизительном разрешении, времени доступа и точности различных часов.</span><span class="sxs-lookup"><span data-stu-id="09292-339">This table provides info on the approximate resolution, access time, and precision of a variety of clocks.</span></span> <span data-ttu-id="09292-340">Обратите внимание, что некоторые значения зависят от разных процессоров, аппаратных платформ и скорости процессора.</span><span class="sxs-lookup"><span data-stu-id="09292-340">Note that some of the values will vary with different processors, hardware platforms, and processor speeds.</span></span>



| <span data-ttu-id="09292-341">Источник часов</span><span class="sxs-lookup"><span data-stu-id="09292-341">Clock Source</span></span>                                                      | <span data-ttu-id="09292-342">Номинальная тактовая частота</span><span class="sxs-lookup"><span data-stu-id="09292-342">Nominal Clock Frequency</span></span> | <span data-ttu-id="09292-343">Разрешение часов</span><span class="sxs-lookup"><span data-stu-id="09292-343">Clock Resolution</span></span>    | <span data-ttu-id="09292-344">Время доступа (номинал)</span><span class="sxs-lookup"><span data-stu-id="09292-344">Access Time (Typical)</span></span> | <span data-ttu-id="09292-345">Точность</span><span class="sxs-lookup"><span data-stu-id="09292-345">Precision</span></span>       |
|-------------------------------------------------------------------|-------------------------|---------------------|-----------------------|-----------------|
| <span data-ttu-id="09292-346">PC RTC</span><span class="sxs-lookup"><span data-stu-id="09292-346">PC RTC</span></span>                                                            | <span data-ttu-id="09292-347">64 Гц</span><span class="sxs-lookup"><span data-stu-id="09292-347">64 Hz</span></span>                   | <span data-ttu-id="09292-348">15,625 МС</span><span class="sxs-lookup"><span data-stu-id="09292-348">15.625 milliseconds</span></span> | <span data-ttu-id="09292-349">Н/Д</span><span class="sxs-lookup"><span data-stu-id="09292-349">N/A</span></span>                   | <span data-ttu-id="09292-350">Н/Д</span><span class="sxs-lookup"><span data-stu-id="09292-350">N/A</span></span>             |
| <span data-ttu-id="09292-351">Счетчик производительности запросов, использующий таймер TSC с тактовой частотой процессора 3 ГГц</span><span class="sxs-lookup"><span data-stu-id="09292-351">Query performance counter using TSC with a 3 GHz processor clock</span></span>  | <span data-ttu-id="09292-352">3 МГц</span><span class="sxs-lookup"><span data-stu-id="09292-352">3 MHz</span></span>                   | <span data-ttu-id="09292-353">333 наносекунд</span><span class="sxs-lookup"><span data-stu-id="09292-353">333 nanoseconds</span></span>     | <span data-ttu-id="09292-354">30 наносекунд</span><span class="sxs-lookup"><span data-stu-id="09292-354">30 nanoseconds</span></span>        | <span data-ttu-id="09292-355">333 наносекунд</span><span class="sxs-lookup"><span data-stu-id="09292-355">333 nanoseconds</span></span> |
| <span data-ttu-id="09292-356">**RDTSC** машины в системе со временем цикла 3 ГГц</span><span class="sxs-lookup"><span data-stu-id="09292-356">**RDTSC** machine instruction on a system with a 3 GHz cycle time</span></span> | <span data-ttu-id="09292-357">3 ГГц</span><span class="sxs-lookup"><span data-stu-id="09292-357">3 GHz</span></span>                   | <span data-ttu-id="09292-358">333 пикосекондс</span><span class="sxs-lookup"><span data-stu-id="09292-358">333 picoseconds</span></span>     | <span data-ttu-id="09292-359">30 наносекунд</span><span class="sxs-lookup"><span data-stu-id="09292-359">30 nanoseconds</span></span>        | <span data-ttu-id="09292-360">30 наносекунд</span><span class="sxs-lookup"><span data-stu-id="09292-360">30 nanoseconds</span></span>  |



 

<span data-ttu-id="09292-361">Поскольку [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) использует счетчик оборудования, когда вы понимаете некоторые основные характеристики аппаратных счетчиков, вы получаете представление о возможностях и ограничениях **QPC**.</span><span class="sxs-lookup"><span data-stu-id="09292-361">Because [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) uses a hardware counter, when you understand some basic characteristics of hardware counters, you gain understanding about the capabilities and limitations of **QPC**.</span></span>

<span data-ttu-id="09292-362">Наиболее часто используемым генератором аппаратных тактов является Crystal осциллятор.</span><span class="sxs-lookup"><span data-stu-id="09292-362">The most commonly used hardware tick generator is a crystal oscillator.</span></span> <span data-ttu-id="09292-363">Crystal — это небольшая часть Quartz или другого церамик материала, которая представляет характеристики пиезоелектрик, которые предоставляют недорогую частотную ссылку с отличной стабильностью и точностью.</span><span class="sxs-lookup"><span data-stu-id="09292-363">The crystal is a small piece of quartz or other ceramic material that exhibits piezoelectric characteristics that provide an inexpensive frequency reference with excellent stability and accuracy.</span></span> <span data-ttu-id="09292-364">Эта частота используется для создания тактов, подсчитанных часами.</span><span class="sxs-lookup"><span data-stu-id="09292-364">This frequency is used to generate the ticks counted by the clock.</span></span>

<span data-ttu-id="09292-365">Точность таймера относится к степени соответствия значению true или Standard.</span><span class="sxs-lookup"><span data-stu-id="09292-365">The accuracy of a timer refers to the degree of conformity to a true or standard value.</span></span> <span data-ttu-id="09292-366">Это зависит главным образом от возможности Crystal осциллятор по заданной частоте.</span><span class="sxs-lookup"><span data-stu-id="09292-366">This depends primarily on the crystal oscillator’s ability to provide ticks at the specified frequency.</span></span> <span data-ttu-id="09292-367">Если частота колебаний слишком высока, часы будут работать быстро, а измеряемые интервалы будут отображаться дольше, чем на самом деле. Если частота слишком мала, часы будут работать медленнее, а измеряемые интервалы будут короче, чем на самом деле.</span><span class="sxs-lookup"><span data-stu-id="09292-367">If the frequency of oscillation is too high, the clock will 'run fast', and measured intervals will appear longer than they really are; and if the frequency is too low, the clock will 'run slow', and measured intervals will appear shorter than they really are.</span></span>

<span data-ttu-id="09292-368">Для типичных измерений интервала времени в течение короткой длительности (например, измерения времени отклика, измерения задержки сети и т. д.), как правило, достаточно осциллятор оборудования.</span><span class="sxs-lookup"><span data-stu-id="09292-368">For typical time-interval measurements for short duration (for example, response time measurements, network latency measurements, and so on), the accuracy of the hardware oscillator is usually sufficient.</span></span> <span data-ttu-id="09292-369">Однако для некоторых измерений точность осциллятор частоты играет важную роль, особенно для длинных интервалов времени или при необходимости сравнения измерений, полученных на разных компьютерах.</span><span class="sxs-lookup"><span data-stu-id="09292-369">However, for some measurements the oscillator frequency accuracy becomes important, particularly for long time intervals or when you want to compare measurements taken on different machines.</span></span> <span data-ttu-id="09292-370">Оставшаяся часть этого раздела посвящена влиянию точности осциллятор.</span><span class="sxs-lookup"><span data-stu-id="09292-370">The remainder of this section explores the effects of the oscillator accuracy.</span></span>

<span data-ttu-id="09292-371">Кристалс "частота колебаний" устанавливается во время производственного процесса и указывается производителем с точки зрения заданной частоты плюс или минус отклонения в производстве, выраженный в "штук в миллион" (стр/мин), которые называются максимальным смещением частоты.</span><span class="sxs-lookup"><span data-stu-id="09292-371">The crystals' frequency of oscillation is set during the manufacturing process and is specified by the manufacturer in terms of a specified frequency plus or minus a manufacturing tolerance expressed in 'parts per million' (ppm), called the maximum frequency offset.</span></span> <span data-ttu-id="09292-372">Кристалл с заданной частотой 1 000 000 Гц и максимальным смещением частоты в ± 10 стр/мин будет соответствовать ограничениям спецификации, если фактическая частота находилась в диапазоне от 999 990 Гц до 1 000 010 Гц.</span><span class="sxs-lookup"><span data-stu-id="09292-372">A crystal with a specified frequency of 1,000,000 Hz and a maximum frequency offset of ± 10 ppm would be within specification limits if its actual frequency were between 999,990 Hz and 1,000,010 Hz.</span></span>

<span data-ttu-id="09292-373">При замене частей фразы на миллионы в микросекундах в секунду можно применить эту ошибку смещения частоты к измерению интервалов времени.</span><span class="sxs-lookup"><span data-stu-id="09292-373">By substituting the phrase parts per million with microseconds per second, we can apply this frequency offset error to time-interval measurements.</span></span> <span data-ttu-id="09292-374">Осциллятор с смещением + 10 в минуту будет иметь ошибку 10 микросекунд в секунду.</span><span class="sxs-lookup"><span data-stu-id="09292-374">An oscillator with a + 10 ppm offset would have an error of 10 microseconds per second.</span></span> <span data-ttu-id="09292-375">Соответственно, при измерении интервала в 1 секунду он будет выполняться быстро и измерять интервал в 1 секунду как 0,999990 секунд.</span><span class="sxs-lookup"><span data-stu-id="09292-375">Accordingly, when measuring a 1 second interval, it would run fast and measure a 1 second interval as 0.999990 seconds.</span></span>

<span data-ttu-id="09292-376">Удобный справочник заключается в том, что ошибка частоты 100 стр/мин вызывает ошибку 8,64 секунд после 24 часов.</span><span class="sxs-lookup"><span data-stu-id="09292-376">A convenient reference is that a frequency error of 100 ppm causes an error of 8.64 seconds after 24 hours.</span></span> <span data-ttu-id="09292-377">Эта таблица представляет неопределенность измерения из-за более длинных интервалов времени в накопленной ошибке.</span><span class="sxs-lookup"><span data-stu-id="09292-377">This table presents the measurement uncertainty due to the accumulated error for longer time intervals.</span></span>



| <span data-ttu-id="09292-378">Длительность интервала времени</span><span class="sxs-lookup"><span data-stu-id="09292-378">Time interval duration</span></span> | <span data-ttu-id="09292-379">Неопределенность измерений из-за накопленной ошибки с отклонением +/-10 PPM</span><span class="sxs-lookup"><span data-stu-id="09292-379">Measurement uncertainty due to accumulated error with +/- 10 PPM frequency tolerance</span></span> |
|------------------------|--------------------------------------------------------------------------------------|
| <span data-ttu-id="09292-380">1 микросекунда</span><span class="sxs-lookup"><span data-stu-id="09292-380">1 microsecond</span></span>          | <span data-ttu-id="09292-381">± 10 пикосекондс (10-12)</span><span class="sxs-lookup"><span data-stu-id="09292-381">± 10 picoseconds (10-12)</span></span>                                                             |
| <span data-ttu-id="09292-382">1 мс</span><span class="sxs-lookup"><span data-stu-id="09292-382">1 millisecond</span></span>          | <span data-ttu-id="09292-383">± 10 наносекунд (10-9)</span><span class="sxs-lookup"><span data-stu-id="09292-383">± 10 nanoseconds (10-9)</span></span>                                                              |
| <span data-ttu-id="09292-384">1 с</span><span class="sxs-lookup"><span data-stu-id="09292-384">1 second</span></span>               | <span data-ttu-id="09292-385">± 10 микросекунд</span><span class="sxs-lookup"><span data-stu-id="09292-385">± 10 microseconds</span></span>                                                                    |
| <span data-ttu-id="09292-386">1 час</span><span class="sxs-lookup"><span data-stu-id="09292-386">1 hour</span></span>                 | <span data-ttu-id="09292-387">± 60 микросекунд</span><span class="sxs-lookup"><span data-stu-id="09292-387">± 60 microseconds</span></span>                                                                    |
| <span data-ttu-id="09292-388">1 день</span><span class="sxs-lookup"><span data-stu-id="09292-388">1 day</span></span>                  | <span data-ttu-id="09292-389">± 0,86 секунд</span><span class="sxs-lookup"><span data-stu-id="09292-389">± 0.86 seconds</span></span>                                                                       |
| <span data-ttu-id="09292-390">1 неделя</span><span class="sxs-lookup"><span data-stu-id="09292-390">1 week</span></span>                 | <span data-ttu-id="09292-391">± 6,08 секунд</span><span class="sxs-lookup"><span data-stu-id="09292-391">± 6.08 seconds</span></span>                                                                       |



 

<span data-ttu-id="09292-392">В приведенной выше таблице показано, что для небольших временных интервалов ошибку смещения частоты часто можно игнорировать.</span><span class="sxs-lookup"><span data-stu-id="09292-392">The preceding table shows that for small time intervals the frequency offset error can often be ignored.</span></span> <span data-ttu-id="09292-393">Однако для больших интервалов времени даже небольшое смещение частоты может привести к существенным незначительным измерениям.</span><span class="sxs-lookup"><span data-stu-id="09292-393">However for long time intervals, even a small frequency offset can result in a substantial measurement uncertainty.</span></span>

<span data-ttu-id="09292-394">Crystal осцилляторами, который используется в персональных компьютерах и серверах, обычно изготовлен с частотой, равной ± 30 – 50 штук в миллион, и редко Кристалс может быть отключен до 500 стр/с.</span><span class="sxs-lookup"><span data-stu-id="09292-394">Crystal oscillators that are used in personal computers and servers are typically manufactured with a frequency tolerance of ± 30 to 50 parts per million, and rarely, crystals can be off by as much as 500 ppm.</span></span> <span data-ttu-id="09292-395">Хотя Кристалс с гораздо более жесткими отклонениями смещения, они являются более ресурсоемкими и поэтому не используются на большинстве компьютеров.</span><span class="sxs-lookup"><span data-stu-id="09292-395">Although crystals with much tighter frequency offset tolerances are available, they are more expensive and thus are not used in most computers.</span></span>

<span data-ttu-id="09292-396">Чтобы снизить негативные последствия этой ошибки смещения частоты, последние версии Windows, в особенности Windows 8, используют несколько аппаратных таймеров для определения смещения частоты и ее компенсации в максимально возможной степени.</span><span class="sxs-lookup"><span data-stu-id="09292-396">To reduce the adverse effects of this frequency offset error, recent versions of Windows, particularly Windows 8, use multiple hardware timers to detect the frequency offset and compensate for it to the extent possible.</span></span> <span data-ttu-id="09292-397">Этот процесс калибровки выполняется при запуске Windows.</span><span class="sxs-lookup"><span data-stu-id="09292-397">This calibration process is performed when Windows is started.</span></span>

<span data-ttu-id="09292-398">Как показано в следующих примерах, ошибка смещения частоты аппаратных часов влияет на достижимую точность, а разрешение часов может быть менее важным.</span><span class="sxs-lookup"><span data-stu-id="09292-398">As the following examples show, the frequency offset error of a hardware clock influences the achievable accuracy, and the resolution of the clock can be less important.</span></span>

![Частота ошибок смещения влияет на достижимость](images/freq-offset-error.png)

<dl> <dt>

<span data-ttu-id="09292-400"><span id="Example_1"></span><span id="example_1"></span><span id="EXAMPLE_1"></span>**Пример 1**</span><span class="sxs-lookup"><span data-stu-id="09292-400"><span id="Example_1"></span><span id="example_1"></span><span id="EXAMPLE_1"></span>**Example 1**</span></span>
</dt> <dd>

<span data-ttu-id="09292-401">Предположим, что вы выполняете измерения интервала времени с помощью осциллятор с частотой 1 МГц, которая имеет разрешение 1 микросекунда, и значение максимальной частоты смещения в ± 50 стр/мин.</span><span class="sxs-lookup"><span data-stu-id="09292-401">Suppose you perform time-interval measurements by using a 1 MHz oscillator, which has a resolution of 1 microsecond, and a maximum frequency offset error of ±50 ppm.</span></span> <span data-ttu-id="09292-402">Теперь давайте предположим, что смещение имеет ровно + 50 стр/мин.</span><span class="sxs-lookup"><span data-stu-id="09292-402">Now, let us suppose the offset is exactly +50 ppm.</span></span> <span data-ttu-id="09292-403">Это означает, что фактическая частота будет составлять 1 000 050 Гц.</span><span class="sxs-lookup"><span data-stu-id="09292-403">This means that the actual frequency would be 1,000,050 Hz.</span></span> <span data-ttu-id="09292-404">Если мы измеряем интервал времени, равный 24 часам, то измерение будет 4,3 секунд слишком коротким (23:59:55.700000, измеренное по сравнению с 24:00:00.000000 фактическим).</span><span class="sxs-lookup"><span data-stu-id="09292-404">If we measured a time interval of 24 hours, our measurement would be 4.3 seconds too short (23:59:55.700000 measured versus 24:00:00.000000 actual).</span></span>

<span data-ttu-id="09292-405">Секунд в день = 86400</span><span class="sxs-lookup"><span data-stu-id="09292-405">Seconds in a day = 86400</span></span>

<span data-ttu-id="09292-406">Ошибка смещения частоты = 50 стр/мин = 0,00005</span><span class="sxs-lookup"><span data-stu-id="09292-406">Frequency offset error = 50 ppm = 0.00005</span></span>

<span data-ttu-id="09292-407">86 400 секунд \* 0,00005 = 4,3 секунд</span><span class="sxs-lookup"><span data-stu-id="09292-407">86,400 seconds \* 0.00005 = 4.3 seconds</span></span>

</dd> <dt>

<span data-ttu-id="09292-408"><span id="Example_2"></span><span id="example_2"></span><span id="EXAMPLE_2"></span>**Пример 2**</span><span class="sxs-lookup"><span data-stu-id="09292-408"><span id="Example_2"></span><span id="example_2"></span><span id="EXAMPLE_2"></span>**Example 2**</span></span>
</dt> <dd>

<span data-ttu-id="09292-409">Предположим, что тактовые частоты процессора контролируются Crystal осциллятор и заданной частотой 3 ГГц.</span><span class="sxs-lookup"><span data-stu-id="09292-409">Suppose the processor TSC clock is controlled by a crystal oscillator and has specified frequency of 3 GHz.</span></span> <span data-ttu-id="09292-410">Это означает, что разрешение будет равно 1 или 3000000000 или примерно 333 пикосекондс.</span><span class="sxs-lookup"><span data-stu-id="09292-410">This means that the resolution would be 1/3,000,000,000 or about 333 picoseconds.</span></span> <span data-ttu-id="09292-411">Предположим, что кристалл, используемый для управления тактами процессора, имеет частотный допуск ± 50 стр/мин и фактически + 50 стр/мин.</span><span class="sxs-lookup"><span data-stu-id="09292-411">Assume the crystal used to control the processor clock has a frequency tolerance of ±50 ppm and is actually +50 ppm.</span></span> <span data-ttu-id="09292-412">Несмотря на выразительное решение, измерение интервала времени, равное 24 часам, по-прежнему будет 4,3 секунд.</span><span class="sxs-lookup"><span data-stu-id="09292-412">In spite of the impressive resolution, a time-interval measurement of 24 hours will still be 4.3 seconds too short.</span></span> <span data-ttu-id="09292-413">(23:59:55.7000000000 измеряется в сравнении с 24:00:00.0000000000 фактическим).</span><span class="sxs-lookup"><span data-stu-id="09292-413">(23:59:55.7000000000 measured versus 24:00:00.0000000000 actual).</span></span>

<span data-ttu-id="09292-414">Секунд в день = 86400</span><span class="sxs-lookup"><span data-stu-id="09292-414">Seconds in a day = 86400</span></span>

<span data-ttu-id="09292-415">Ошибка смещения частоты = 50 стр/мин = 0,00005</span><span class="sxs-lookup"><span data-stu-id="09292-415">Frequency offset error = 50 ppm = 0.00005</span></span>

<span data-ttu-id="09292-416">86 400 секунд \* 0,00005 = 4,3 секунд</span><span class="sxs-lookup"><span data-stu-id="09292-416">86,400 seconds \* 0.00005 = 4.3 seconds</span></span>

<span data-ttu-id="09292-417">Это показывает, что таймеры TSC с высоким разрешением не обязательно обеспечивают более точные показатели, чем часы с низким разрешением.</span><span class="sxs-lookup"><span data-stu-id="09292-417">This shows that a high resolution TSC clock doesn't necessarily provide more accurate measurements than a lower resolution clock.</span></span>

</dd> <dt>

<span data-ttu-id="09292-418"><span id="Example_3"></span><span id="example_3"></span><span id="EXAMPLE_3"></span>**Пример 3**</span><span class="sxs-lookup"><span data-stu-id="09292-418"><span id="Example_3"></span><span id="example_3"></span><span id="EXAMPLE_3"></span>**Example 3**</span></span>
</dt> <dd>

<span data-ttu-id="09292-419">Рассмотрите возможность использования двух разных компьютеров для измерения одного и того же 24-часового интервала времени.</span><span class="sxs-lookup"><span data-stu-id="09292-419">Consider using two different computers to measure the same 24 hour time interval.</span></span> <span data-ttu-id="09292-420">Оба компьютера имеют осциллятор с максимальным смещением частоты ± 50 стр/мин.</span><span class="sxs-lookup"><span data-stu-id="09292-420">Both computers have an oscillator with a maximum frequency offset of ± 50 ppm.</span></span> <span data-ttu-id="09292-421">Насколько продвинуться измерение одного и того же интервала времени в этих двух системах?</span><span class="sxs-lookup"><span data-stu-id="09292-421">How far apart can the measurement of the same time interval on these two systems be?</span></span> <span data-ttu-id="09292-422">Как и в предыдущих примерах, ± 50 стр/мин выдает максимальную ошибку ± 4,3 секунд после 24 часов.</span><span class="sxs-lookup"><span data-stu-id="09292-422">As in the previous examples, ± 50 ppm yields a maximum error of ± 4.3 seconds after 24 hours.</span></span> <span data-ttu-id="09292-423">Если одна система работает в 4,3 секунд быстро, а другая 4,3 секунд работает медленнее, то максимальная ошибка может со8,6 ставлять не более 24 часов.</span><span class="sxs-lookup"><span data-stu-id="09292-423">If one system runs 4.3 seconds fast, and the other 4.3 seconds slow, the maximum error after 24 hours could be 8.6 seconds.</span></span>

<span data-ttu-id="09292-424">Секунд в день = 86400</span><span class="sxs-lookup"><span data-stu-id="09292-424">Seconds in a day = 86400</span></span>

<span data-ttu-id="09292-425">Ошибка смещения частоты = ± 50 стр/мин = ± 0,00005</span><span class="sxs-lookup"><span data-stu-id="09292-425">Frequency offset error = ±50 ppm = ±0.00005</span></span>

<span data-ttu-id="09292-426">± (86 400 секунд \* 0,00005) = ± 4,3 секунд</span><span class="sxs-lookup"><span data-stu-id="09292-426">±(86,400 seconds \* 0.00005) = ±4.3 seconds</span></span>

<span data-ttu-id="09292-427">Максимальное смещение между двумя системами = 8,6 секунд</span><span class="sxs-lookup"><span data-stu-id="09292-427">Maximum offset between the two systems = 8.6 seconds</span></span>

<span data-ttu-id="09292-428">В целом, ошибка смещения частоты становится все более важной при измерении длинных временных интервалов и при сравнении измерений между различными системами.</span><span class="sxs-lookup"><span data-stu-id="09292-428">In summary, the frequency offset error becomes increasingly important when measuring long time intervals and when comparing measurements between different systems.</span></span>

<span data-ttu-id="09292-429">Стабильность таймера описывает, изменяется ли частота тактов с течением времени, например в результате изменения температуры.</span><span class="sxs-lookup"><span data-stu-id="09292-429">The stability of a timer describes whether the tick frequency changes over time, for example as the result of temperatures changes.</span></span> <span data-ttu-id="09292-430">Функция Quartz Кристалс, используемая в качестве генераторов тактов на компьютерах, будет демонстрировать небольшие изменения частоты в качестве функции температуры.</span><span class="sxs-lookup"><span data-stu-id="09292-430">Quartz crystals used as the tick generators on computers will exhibit small changes in frequency as a function of temperature.</span></span> <span data-ttu-id="09292-431">Ошибка, вызванная смещением в температуре, обычно мала по сравнению с ошибкой смещения частоты для общих диапазонов температуры.</span><span class="sxs-lookup"><span data-stu-id="09292-431">The error caused by thermal drift is typically small compared to the frequency offset error for common temperature ranges.</span></span> <span data-ttu-id="09292-432">Однако разработчикам программного обеспечения для портативного оборудования или оборудования может потребоваться учитывать этот результат в больших колебаниях температуры.</span><span class="sxs-lookup"><span data-stu-id="09292-432">However, designers of software for portable equipment or equipment subject to large temperature fluctuations might need to consider this effect.</span></span>

</dd> </dl>

## <a name="hardware-timer-info"></a><span data-ttu-id="09292-433">Сведения о таймере оборудования</span><span class="sxs-lookup"><span data-stu-id="09292-433">Hardware timer info</span></span>

<dl> <dt>

<span data-ttu-id="09292-434"><span id="TSC_Register"></span><span id="tsc_register"></span><span id="TSC_REGISTER"></span>**Регистр TSC**</span><span class="sxs-lookup"><span data-stu-id="09292-434"><span id="TSC_Register"></span><span id="tsc_register"></span><span id="TSC_REGISTER"></span>**TSC Register**</span></span>
</dt> <dd>

<span data-ttu-id="09292-435">Некоторые процессоры Intel и AMD содержат регистр TSC, который является 64-битным регистром, который увеличивается с высокой частотой, обычно равной процессорным часам.</span><span class="sxs-lookup"><span data-stu-id="09292-435">Some Intel and AMD processors contain a TSC register that is a 64-bit register that increases at a high rate, typically equal to the processor clock.</span></span> <span data-ttu-id="09292-436">Значение этого счетчика можно прочитать с помощью инструкций на компьютере **RDTSC** или **RDTSCP** , предоставляя очень низкое время доступа и вычислительную стоимость в порядке десятков или сотен машинных циклов в зависимости от процессора.</span><span class="sxs-lookup"><span data-stu-id="09292-436">The value of this counter can be read through the **RDTSC** or **RDTSCP** machine instructions, providing very low access time and computational cost in the order of tens or hundreds of machine cycles, depending upon the processor.</span></span>

<span data-ttu-id="09292-437">Несмотря на то, что регистр TSC кажется идеальным механизмом отметки времени, в некоторых случаях он не может надежно работать в целях тимекипинг:</span><span class="sxs-lookup"><span data-stu-id="09292-437">Although the TSC register seems like an ideal time stamp mechanism, here are circumstances in which it can't function reliably for timekeeping purposes:</span></span>

-   <span data-ttu-id="09292-438">Не все процессоры имеют регистры TSC, поэтому использование регистра TSC в программном обеспечении напрямую создает проблему переносимости.</span><span class="sxs-lookup"><span data-stu-id="09292-438">Not all processors have TSC registers, so using the TSC register in software directly creates a portability problem.</span></span> <span data-ttu-id="09292-439">(В этом случае в Windows будет выбран альтернативный источник времени для [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) , что позволяет избежать проблемы переносимости.)</span><span class="sxs-lookup"><span data-stu-id="09292-439">(Windows will select an alternative time source for [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) in this case, which avoids the portability problem.)</span></span>
-   <span data-ttu-id="09292-440">Некоторые процессоры могут варьировать частоту таймера TSC или прерывать изменение регистра TSC, что делает таймер TSC неприемлемым для временных целей этих процессоров.</span><span class="sxs-lookup"><span data-stu-id="09292-440">Some processors can vary the frequency of the TSC clock or stop the advancement of the TSC register, which makes the TSC unsuitable for timing purposes on these processors.</span></span> <span data-ttu-id="09292-441">Эти процессоры говорят о том, что регистры TSC не являются инвариантными.</span><span class="sxs-lookup"><span data-stu-id="09292-441">These processors are said to have non-invariant TSC registers.</span></span> <span data-ttu-id="09292-442">(Windows автоматически обнаружит это и выберите альтернативный источник времени для [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter)).</span><span class="sxs-lookup"><span data-stu-id="09292-442">(Windows will automatically detect this, and select an alternative time source for [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter)).</span></span>
-   <span data-ttu-id="09292-443">В системах с несколькими процессорами или многоядерными системами некоторые процессоры и системы не могут синхронизировать часы каждого ядра с одним и тем же значением.</span><span class="sxs-lookup"><span data-stu-id="09292-443">On multi-processor or multi-core systems, some processors and systems are unable to synchronize the clocks on each core to the same value.</span></span> <span data-ttu-id="09292-444">(Windows автоматически обнаружит это и выберите альтернативный источник времени для [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter)).</span><span class="sxs-lookup"><span data-stu-id="09292-444">(Windows will automatically detect this, and select an alternative time source for [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter)).</span></span>
-   <span data-ttu-id="09292-445">В некоторых крупных многопроцессорных системах вы не сможете синхронизировать тактовые импульсы процессора с одним и тем же значением, даже если процессор имеет инвариантный таймер TSC.</span><span class="sxs-lookup"><span data-stu-id="09292-445">On some large multi-processor systems, you might not be able to synchronize the processor clocks to the same value even if the processor has an invariant TSC.</span></span> <span data-ttu-id="09292-446">(Windows автоматически обнаружит это и выберите альтернативный источник времени для [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter)).</span><span class="sxs-lookup"><span data-stu-id="09292-446">(Windows will automatically detect this, and select an alternative time source for [**QPC**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter)).</span></span>
-   <span data-ttu-id="09292-447">Некоторые процессоры будут выполнять инструкции в неопределенном порядке.</span><span class="sxs-lookup"><span data-stu-id="09292-447">Some processors will execute instructions out of order.</span></span> <span data-ttu-id="09292-448">Это может привести к неправильному счетчику циклов, если **RDTSC** используется для последовательностей инструкций времени, так как инструкция **RDTSC** может выполняться в другое время, чем указано в программе.</span><span class="sxs-lookup"><span data-stu-id="09292-448">This can result in incorrect cycle counts when **RDTSC** is used to time instruction sequences because the **RDTSC** instruction might be executed at a different time than specified in your program.</span></span> <span data-ttu-id="09292-449">Инструкция **RDTSCP** была введена на некоторых процессорах в ответ на эту проблему.</span><span class="sxs-lookup"><span data-stu-id="09292-449">The **RDTSCP** instruction has been introduced on some processors in response to this problem.</span></span>

<span data-ttu-id="09292-450">Как и другие таймеры, таймер TSC основан на Crystal осциллятор, Точная частота которого не известна заранее и имеет ошибку смещения частоты.</span><span class="sxs-lookup"><span data-stu-id="09292-450">Like other timers, the TSC is based on a crystal oscillator whose exact frequency is not known in advance and that has a frequency offset error.</span></span> <span data-ttu-id="09292-451">Поэтому, прежде чем его можно будет использовать, его необходимо откалибровать с помощью другой ссылки времени.</span><span class="sxs-lookup"><span data-stu-id="09292-451">Thus before it can be used, it must be calibrated using another timing reference.</span></span>

<span data-ttu-id="09292-452">Во время инициализации системы Windows проверяет, подходит ли таймер TSC для целей времени, и выполняет необходимую калибровку частоты и основную синхронизацию.</span><span class="sxs-lookup"><span data-stu-id="09292-452">During system initialization, Windows checks if the TSC is suitable for timing purposes and performs the necessary frequency calibration and core synchronization.</span></span>

</dd> <dt>

<span data-ttu-id="09292-453"><span id="PM_Clock"></span><span id="pm_clock"></span><span id="PM_CLOCK"></span>**Часы PM**</span><span class="sxs-lookup"><span data-stu-id="09292-453"><span id="PM_Clock"></span><span id="pm_clock"></span><span id="PM_CLOCK"></span>**PM Clock**</span></span>
</dt> <dd>

<span data-ttu-id="09292-454">Таймер ACPI, известный также как часы PM, был добавлен в системную архитектуру для обеспечения надежной отметки времени независимо от скорости процессора.</span><span class="sxs-lookup"><span data-stu-id="09292-454">The ACPI timer, also known as the PM clock, was added to the system architecture to provide reliable time stamps independently of the processors speed.</span></span> <span data-ttu-id="09292-455">Так как это была единственная цель этого таймера, она предоставляет отметку времени в одном цикле, но не предоставляет никаких других функциональных возможностей.</span><span class="sxs-lookup"><span data-stu-id="09292-455">Because this was the single goal of this timer, it provides a time stamp in a single clock cycle, but it doesn't provide any other functionality.</span></span>

</dd> <dt>

<span data-ttu-id="09292-456"><span id="HPET_Timer"></span><span id="hpet_timer"></span><span id="HPET_TIMER"></span>**Таймер ХПЕТ**</span><span class="sxs-lookup"><span data-stu-id="09292-456"><span id="HPET_Timer"></span><span id="hpet_timer"></span><span id="HPET_TIMER"></span>**HPET Timer**</span></span>
</dt> <dd>

<span data-ttu-id="09292-457">Высокоточный таймер событий (ХПЕТ) был разработан корпорацией Intel и корпорацией Майкрософт в соответствии с требованиями к синхронизации мультимедиа и других приложений, зависящих от времени.</span><span class="sxs-lookup"><span data-stu-id="09292-457">The High Precision Event Timer (HPET) was developed jointly by Intel and Microsoft to meet the timing requirements of multimedia and other time-sensitive applications.</span></span> <span data-ttu-id="09292-458">Поддержка ХПЕТ в Windows, начиная с Windows Vista, и сертификация Windows 7 и Windows 8 с логотипом оборудования требует поддержки ХПЕТ в аппаратной платформе.</span><span class="sxs-lookup"><span data-stu-id="09292-458">HPET support has been in Windows since Windows Vista, and Windows 7 and Windows 8 Hardware Logo certification requires HPET support in the hardware platform.</span></span>

</dd> </dl>

 

 
